(window.webpackJsonp=window.webpackJsonp||[]).push([[14],[,,function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.ClientReady="im.vector.ready",e.WidgetReady="io.element.widget_ready",e.JoinCall="io.element.join",e.HangupCall="im.vector.hangup",e.ForceHangupCall="io.element.force_hangup",e.CallParticipants="io.element.participants",e.MuteAudio="io.element.mute_audio",e.UnmuteAudio="io.element.unmute_audio",e.MuteVideo="io.element.mute_video",e.UnmuteVideo="io.element.unmute_video",e.StartLiveStream="im.vector.start_live_stream",e.OpenIntegrationManager="integration_manager_open",e.ViewRoom="io.element.view_room"}(i||(i={}))},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(5),s=n.n(i);async function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";""===e||e.endsWith("/")||(e+="/");const t=r(`${e}config.${document.domain}.json`),n=r(e+"config.json");try{const e=await t;if(0===Object.keys(e).length)throw new Error;return e}catch(e){return await n}}function r(e){return new Promise((function(t,n){s()({method:"GET",url:e,qs:{cachebuster:Date.now()}},(e,i,s)=>{try{if(e||i.status<200||i.status>=300)return i&&(404==i.status||0==i.status&&""==s)&&t({}),void n({err:e,response:i});t(JSON.parse(s))}catch(e){n({err:e})}})}))}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{constructor(e){this.obj=e}get(e,t){const n=this.obj[e];return void 0!==n?n:this.obj[null!=t?t:(i=e,i.replace(/._./g,e=>`${e[0]}${e[2].toUpperCase()}`))];var i}toJSON(){return this.obj}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.r(t),n.d(t,"rageshakePromise",(function(){return z})),n.d(t,"preparePlatform",(function(){return J})),n.d(t,"setupLogStorage",(function(){return Y})),n.d(t,"loadConfig",(function(){return Q})),n.d(t,"loadOlm",(function(){return X})),n.d(t,"loadLanguage",(function(){return Z})),n.d(t,"loadTheme",(function(){return ee})),n.d(t,"loadApp",(function(){return te})),n.d(t,"showError",(function(){return ne})),n.d(t,"showIncompatibleBrowser",(function(){return ie})),n.d(t,"_t",(function(){return se}));var i=n(859),s=n(860),o=n.n(s),r=n(150),a=n(87),c=n.n(a),l=n(89),d=n(93),u=n(126),h=n(98),m=n(270),p=n(0),g=n(351),f=n.n(g),v=n(307);var b=n(92),y=n(512),S=n(95),E=n(212),w=n(102),_=n(186),C=n(96),O=n(578),R=n(160),I=n(197),k=n(544);var x=e=>{let{description:t,acceptLabel:n,dismissLabel:i,onAccept:s,onDismiss:o,toastKey:r,numSeconds:a}=e;const l=()=>{o&&o(),R.a.sharedInstance().dismissToast(r)},d=Object(k.a)(l,1e3,a);let u=i;return d>0&&(u+=` (${d})`),c.a.createElement(I.a,{description:t,acceptLabel:n,onAccept:s,rejectLabel:u,onReject:l})},T=n(6),j=n(1380);class N extends v.e{constructor(){super(...arguments),f()(this,"_favicon",void 0)}async getConfig(){return Object(T.a)()}getHumanReadableName(){return"Vector Base Platform"}get favicon(){return this._favicon?this._favicon:this._favicon=new j.a}updateFavicon(){let e="#d00",t=this.notificationCount;this.errorDidOccur&&(t=t||"×",e="#f00"),this.favicon.badge(t,{bgColor:e})}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),this.updateFavicon())}setErrorStatus(e){this.errorDidOccur!==e&&(super.setErrorStatus(e),this.updateFavicon())}startUpdater(){}getDefaultDeviceDisplayName(){return Object(l.a)("Unknown device")}}function P(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const D=window.electron,A=navigator.platform.toUpperCase().includes("MAC");function M(e){["call_state"].includes(e.action)&&D.send("app_onAction",e)}class U extends class{async supportsEventIndexing(){return!0}async initEventIndex(e,t){throw new Error("Unimplemented")}async addEventToIndex(e,t){throw new Error("Unimplemented")}async deleteEvent(e){throw new Error("Unimplemented")}async isEventIndexEmpty(){throw new Error("Unimplemented")}indexIsEmpty(){throw new Error("Unimplemented")}isRoomIndexed(e){throw new Error("Unimplemented")}async getStats(){throw new Error("Unimplemented")}async getUserVersion(){throw new Error("Unimplemented")}async setUserVersion(e){throw new Error("Unimplemented")}async commitLiveEvents(){throw new Error("Unimplemented")}async searchEventIndex(e){throw new Error("Unimplemented")}async addHistoricEvents(e,t,n){throw new Error("Unimplemented")}async addCrawlerCheckpoint(e){throw new Error("Unimplemented")}async removeCrawlerCheckpoint(e){throw new Error("Unimplemented")}async loadCheckpoints(){throw new Error("Unimplemented")}async loadFileEvents(e){throw new Error("Unimplemented")}async closeEventIndex(){throw new Error("Unimplemented")}async deleteEventIndex(){throw new Error("Unimplemented")}}{constructor(){super(),f()(this,"pendingIpcCalls",{}),f()(this,"nextIpcCallId",0),f()(this,"onIpcReply",(e,t)=>{if(void 0===t.id)return void p.a.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void p.a.warn("Unknown IPC payload ID: "+t.id);const n=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?n.reject(t.error):n.resolve(t.reply)}),D.on("seshatReply",this.onIpcReply)}async ipcCall(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];const s=++this.nextIpcCallId;return new Promise((t,i)=>{this.pendingIpcCalls[s]={resolve:t,reject:i},window.electron.send("seshat",{id:s,name:e,args:n})})}async supportsEventIndexing(){return this.ipcCall("supportsEventIndexing")}async initEventIndex(e,t){return this.ipcCall("initEventIndex",e,t)}async addEventToIndex(e,t){return this.ipcCall("addEventToIndex",e,t)}async deleteEvent(e){return this.ipcCall("deleteEvent",e)}async isEventIndexEmpty(){return this.ipcCall("isEventIndexEmpty")}async isRoomIndexed(e){return this.ipcCall("isRoomIndexed",e)}async commitLiveEvents(){return this.ipcCall("commitLiveEvents")}async searchEventIndex(e){return this.ipcCall("searchEventIndex",e)}async addHistoricEvents(e,t,n){return this.ipcCall("addHistoricEvents",e,t,n)}async addCrawlerCheckpoint(e){return this.ipcCall("addCrawlerCheckpoint",e)}async removeCrawlerCheckpoint(e){return this.ipcCall("removeCrawlerCheckpoint",e)}async loadFileEvents(e){return this.ipcCall("loadFileEvents",e)}async loadCheckpoints(){return this.ipcCall("loadCheckpoints")}async closeEventIndex(){return this.ipcCall("closeEventIndex")}async getStats(){return this.ipcCall("getStats")}async getUserVersion(){return this.ipcCall("getUserVersion")}async setUserVersion(e){return this.ipcCall("setUserVersion",e)}async deleteEventIndex(){return this.ipcCall("deleteEventIndex")}}class L extends N{constructor(){super(),f()(this,"eventIndexManager",new U),f()(this,"pendingIpcCalls",{}),f()(this,"nextIpcCallId",0),f()(this,"ssoID",Object(_.b)(32)),f()(this,"onUpdateDownloaded",async(e,t)=>{let{releaseNotes:n,releaseName:i}=t;b.a.dispatch({action:C.a.CheckUpdates,status:v.d.Ready}),this.shouldShowUpdate(i)&&Object(O.b)(await this.getAppVersion(),i,n)}),f()(this,"onIpcReply",(e,t)=>{if(void 0===t.id)return void p.a.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void p.a.warn("Unknown IPC payload ID: "+t.id);const n=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?n.reject(t.error):n.resolve(t.reply)}),b.a.register(M),D.on("check_updates",(e,t)=>{b.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?P(Object(n),!0).forEach((function(t){f()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({action:C.a.CheckUpdates},function(e){return!0===e?{status:v.d.Downloading}:!1===e?{status:v.d.NotAvailable}:{status:v.d.Error,detail:e}}(t)))}),D.on("before-quit",(function(){p.a.log("element-desktop closing"),y.b()})),D.on("ipcReply",this.onIpcReply),D.on("update-downloaded",this.onUpdateDownloaded),D.on("preferences",()=>{b.a.fire(C.a.ViewUserSettings)}),D.on("userDownloadCompleted",(e,t)=>{let{id:n,name:i}=t;const s="DOWNLOAD_TOAST_"+n;R.a.sharedInstance().addOrReplaceToast({key:s,title:Object(l.a)("Download Completed"),props:{description:i,acceptLabel:Object(l.a)("Open"),onAccept:()=>{D.send("userDownloadAction",{id:n,open:!0}),R.a.sharedInstance().dismissToast(s)},dismissLabel:Object(l.a)("Dismiss"),onDismiss:()=>{D.send("userDownloadAction",{id:n})},numSeconds:10},component:x,priority:99})}),this.ipcCall("startSSOFlow",this.ssoID)}async getConfig(){return this.ipcCall("getConfig")}getHumanReadableName(){return"Electron Platform"}supportsMultiLanguageSpellCheck(){return!A}allowOverridingNativeContextMenus(){return!0}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),D.send("setBadgeCount",e))}supportsNotifications(){return!0}maySendNotifications(){return!0}displayNotification(e,t,n,i,s){navigator.userAgent.includes("Linux")&&(t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"));const o=super.displayNotification(e,t,n,i,s),r=o.onclick;return o.onclick=()=>{null==r||r(),this.ipcCall("focusWindow")},o}loudNotification(e,t){D.send("loudNotification")}async getAppVersion(){return this.ipcCall("getAppVersion")}supportsAutoLaunch(){return!0}async getAutoLaunchEnabled(){return this.ipcCall("getAutoLaunchEnabled")}async setAutoLaunchEnabled(e){return this.ipcCall("setAutoLaunchEnabled",e)}supportsWarnBeforeExit(){return!0}async shouldWarnBeforeExit(){return this.ipcCall("shouldWarnBeforeExit")}async setWarnBeforeExit(e){return this.ipcCall("setWarnBeforeExit",e)}supportsAutoHideMenuBar(){return!A}async getAutoHideMenuBarEnabled(){return this.ipcCall("getAutoHideMenuBarEnabled")}async setAutoHideMenuBarEnabled(e){return this.ipcCall("setAutoHideMenuBarEnabled",e)}supportsMinimizeToTray(){return!A}async getMinimizeToTrayEnabled(){return this.ipcCall("getMinimizeToTrayEnabled")}async setMinimizeToTrayEnabled(e){return this.ipcCall("setMinimizeToTrayEnabled",e)}supportsTogglingHardwareAcceleration(){return!0}async getHardwareAccelerationEnabled(){return this.ipcCall("getHardwareAccelerationEnabled")}async setHardwareAccelerationEnabled(e){return this.ipcCall("setHardwareAccelerationEnabled",e)}async canSelfUpdate(){const e=await this.ipcCall("getUpdateFeedUrl");return Boolean(e)}startUpdateCheck(){super.startUpdateCheck(),D.send("check_updates")}installUpdate(){D.send("install_update")}getDefaultDeviceDisplayName(){const e=h.b.get().brand;return Object(l.a)("%(brand)s Desktop (%(platformName)s)",{brand:e,platformName:navigator.userAgent.includes("Macintosh")?"macOS":navigator.userAgent.includes("FreeBSD")?"FreeBSD":navigator.userAgent.includes("OpenBSD")?"OpenBSD":navigator.userAgent.includes("SunOS")?"SunOS":navigator.userAgent.includes("Windows")?"Windows":navigator.userAgent.includes("Linux")?"Linux":"Unknown"})}screenCaptureErrorString(){return null}requestNotificationPermission(){return Promise.resolve("granted")}reload(){window.location.reload()}async ipcCall(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];const s=++this.nextIpcCallId;return new Promise((t,i)=>{this.pendingIpcCalls[s]={resolve:t,reject:i},window.electron.send("ipcCall",{id:s,name:e,args:n})})}getEventIndexingManager(){return this.eventIndexManager}async setLanguage(e){return this.ipcCall("setLanguage",e)}setSpellCheckLanguages(e){this.ipcCall("setSpellCheckLanguages",e).catch(e=>{p.a.log("Failed to send setSpellCheckLanguages IPC to Electron"),p.a.error(e)})}async getSpellCheckLanguages(){return this.ipcCall("getSpellCheckLanguages")}async getDesktopCapturerSources(e){return this.ipcCall("getDesktopCapturerSources",e)}supportsDesktopCapturer(){return!0}async getAvailableSpellCheckLanguages(){return this.ipcCall("getAvailableSpellCheckLanguages")}getSSOCallbackUrl(e){const t=super.getSSOCallbackUrl(e);return t.protocol="element",t.searchParams.set("element-desktop-ssoid",this.ssoID),t}startSingleSignOn(e,t,n,i){super.startSingleSignOn(e,t,n,i),S.a.createTrackedDialog("Electron","SSO",E.a,{title:Object(l.a)("Go to your browser to complete Sign In"),description:c.a.createElement(w.a,null)})}navigateForwardBack(e){this.ipcCall(e?"navigateBack":"navigateForward")}overrideBrowserShortcuts(){return!0}async getPickleKey(e,t){try{return await this.ipcCall("getPickleKey",e,t)}catch(e){return null}}async createPickleKey(e,t){try{return await this.ipcCall("createPickleKey",e,t)}catch(e){return null}}async destroyPickleKey(e,t){try{await this.ipcCall("destroyPickleKey",e,t)}catch(e){}}}var F=n(5),B=n.n(F),K=n(1381),V=n.n(K),W=n(19);function H(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class q extends N{constructor(){super(),f()(this,"pollForUpdate",(e,t)=>this.getMostRecentVersion().then(n=>{const i=this.getNormalizedAppVersion("!!UNSET!!");return i!==n?(this.shouldShowUpdate(n)?(console.log("Update available to "+n+", will notify user"),e(i,n)):console.log("Update available to "+n+" but won't be shown"),{status:v.d.Ready}):(console.log("No update available, already on "+n),null==t||t(),{status:v.d.NotAvailable})},e=>(p.a.error("Failed to poll for update",e),{status:v.d.Error,detail:e.message||e.status?e.status.toString():"Unknown Error"}))),"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js")}getHumanReadableName(){return"Web Platform"}supportsNotifications(){return Boolean(window.Notification)}maySendNotifications(){return"granted"===window.Notification.permission}requestNotificationPermission(){return new Promise((function(e,t){window.Notification.requestPermission(t=>{e(t)})}))}getMostRecentVersion(){return new Promise((e,t)=>{B()({method:"GET",url:"version",qs:{cachebuster:Date.now()}},(n,i,s)=>{if(n||i.status<200||i.status>=300)return null===n&&(n={status:i.status}),void t(n);e(this.getNormalizedAppVersion(s.trim()))})})}getNormalizedAppVersion(e){return/^v\d+.\d+.\d+(-.+)?$/.test(e)?e.substring(1):e}getAppVersion(){return Promise.resolve(this.getNormalizedAppVersion("!!UNSET!!"))}startUpdater(){console.log("startUpdater, current version is "+this.getNormalizedAppVersion("!!UNSET!!")),this.pollForUpdate((e,t)=>{if(Object(W.a)(location).updated)return console.log("Update reloaded but still on an old version, stopping"),void Object(O.b)(e,t);const n=new URL(window.location.href);n.searchParams.set("updated",t),console.log("Update reloading to "+n.toString()),window.location.href=n.toString()}),setInterval(()=>this.pollForUpdate(O.b,O.a),6e5)}async canSelfUpdate(){return!0}startUpdateCheck(){super.startUpdateCheck(),this.pollForUpdate(O.b,O.a).then(e=>{b.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?H(Object(n),!0).forEach((function(t){f()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):H(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({action:C.a.CheckUpdates},e))})}installUpdate(){window.location.reload()}getDefaultDeviceDisplayName(){const e=new URL(window.location.href),t=[e.host,e.pathname.replace(/\/$/,"")].join(""),n=new V.a,i=n.getBrowser().name||"unknown browser";let s=n.getOS().name||"unknown OS";return"Mac OS"===s&&(s="macOS"),Object(l.a)("%(appName)s (%(browserName)s, %(osName)s)",{appName:t,browserName:i,osName:s})}screenCaptureErrorString(){return"https:"!==window.location.protocol?Object(l.a)("You need to be using HTTPS to place a screen-sharing call."):null}reload(){window.location.reload()}}class $ extends q{setNotificationCount(e){if(!navigator.setAppBadge)return super.setNotificationCount(e);this.notificationCount!==e&&(this.notificationCount=e,navigator.setAppBadge(e).catch(e=>{p.a.error("Failed to update PWA app badge",e)}))}}var G=n(338);window.mxSendRageshake=function(e,t){const n=h.b.get().bug_report_endpoint_url;n?(void 0===t&&(t=!0),e&&e.trim()?Object(G.a)(n,{userText:e,sendLogs:t,progressCallback:p.a.log.bind(console)}).then(()=>{p.a.log("Bug report sent!")},e=>{p.a.error(e)}):p.a.error("Cannot send a rageshake without a message - please tell us what went wrong")):p.a.error("Cannot send a rageshake - no bug_report_endpoint_url configured")};const z=function(){const e=y.d(!1);return e.then(()=>{p.a.log("Initialised rageshake."),p.a.log("To fix line numbers in Chrome: Meatball menu → Settings → Ignore list → Add /rageshake\\.js$"),window.addEventListener("beforeunload",e=>{p.a.log("element-web closing"),y.b()}),y.a()},e=>{p.a.error("Failed to initialise rageshake: "+e)}),e}();function J(){window.electron?(p.a.log("Using Electron platform"),u.a.set(new L)):window.matchMedia("(display-mode: standalone)").matches?(p.a.log("Using PWA platform"),u.a.set(new $)):(p.a.log("Using Web platform"),u.a.set(new q))}function Y(){return h.b.get().bug_report_endpoint_url?y.e():(p.a.warn("No bug report endpoint set - logs will not be persisted"),Promise.resolve())}async function Q(){const e=await u.a.get().getConfig();e?h.b.put(e):h.b.unset()}function X(){return o.a.init({locateFile:()=>i.a}).then(()=>{p.a.log("Using WebAssembly Olm")}).catch(e=>(p.a.log("Failed to load Olm: trying legacy version",e),new Promise((e,t)=>{const n=document.createElement("script");n.src="olm_legacy.js",n.onload=e,n.onerror=t,document.body.appendChild(n)}).then(()=>window.Olm.init()).then(()=>{p.a.log("Using legacy Olm")}).catch(e=>{p.a.log("Both WebAssembly and asm.js Olm failed!",e)})))}async function Z(){const e=d.b.getValue("language",null,!0);let t=[];e?t=[e]:l.f().forEach(e=>{t.push(...l.g(e))});try{await l.l(t),document.documentElement.setAttribute("lang",l.e())}catch(e){p.a.error("Unable to set language",e)}}async function ee(){Object(m.h)()}async function te(e){const t=await Promise.all([n.e(17),n.e(26),n.e(12)]).then(n.bind(null,1504));window.matrixChat=r.render(await t.loadApp(e),document.getElementById("matrixchat"))}async function ne(e,t){const i=(await n.e(13).then(n.bind(null,1499))).default;window.matrixChat=r.render(a.createElement(i,{title:e,messages:t}),document.getElementById("matrixchat"))}async function ie(e){const t=(await n.e(11).then(n.bind(null,1500))).default;window.matrixChat=r.render(a.createElement(t,{onAccept:e}),document.getElementById("matrixchat"))}const se=l.a},,,function(e,t,n){"use strict";n.d(t,"i",(function(){return S})),n.d(t,"h",(function(){return E})),n.d(t,"c",(function(){return w})),n.d(t,"a",(function(){return O})),n.d(t,"b",(function(){return R})),n.d(t,"k",(function(){return I})),n.d(t,"l",(function(){return T})),n.d(t,"d",(function(){return j})),n.d(t,"f",(function(){return N})),n.d(t,"g",(function(){return P})),n.d(t,"e",(function(){return A})),n.d(t,"j",(function(){return M}));var i=n(88),s=n.n(i),o=n(361),r=n.n(o),a=n(865),c=n.n(a),l=n(87),d=n.n(l),u=n(0),h=n(93),m=n(126),p=n(104),g=n(325),f=n(98),v=n.p+"i18n/languages.911db4d.json";function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?b(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}c.a.setSeparator("|");function S(e,t){const n=new Error(e);return n.translatedMessage=O(e,t),n}function E(){const e=h.b.getValue("language",null,!0);return e||D(N()[0])}function w(e){return e}c.a.setFallbackLocale("en");function _(e,t){const n=y(y({},t),{},{interpolate:!1});return n&&"object"==typeof n&&Object.keys(n).forEach(e=>{void 0===n[e]&&(u.a.warn("safeCounterpartTranslate called with undefined interpolation name: "+e),n[e]="undefined"),null===n[e]&&(u.a.warn("safeCounterpartTranslate called with null interpolation name: "+e),n[e]="null")}),((e,t)=>{const n=c.a.translate(e,y(y({},t),{},{fallbackLocale:c.a.getLocale()}));if(!n||n.startsWith("missing translation:")){const n=c.a.translate(e,y(y({},t),{},{locale:"en"}));return!n||n.startsWith("missing translation:")?{translated:e,isFallback:!0}:{translated:n,isFallback:!0}}return{translated:n}})(e,n)}const C=(e,t)=>e;function O(e,t,n){const{translated:i}=_(e,t),s=k(i,t,n);return C(s)}function R(e,t,n){const{translated:i,isFallback:s}=_(e,t),o=k(i,t,n);return C(s?d.a.createElement("span",{lang:"en"},o):o)}function I(e){return e.replace(/%\(([^)]*)\)/g,"% ($1)")}function k(e,t,n){let i=e;if(void 0!==t){const e={};for(const n in t)e[`%\\(${n}\\)s`]=t[n];i=x(i,e)}if(void 0!==n){const e={};for(const t in n)e[`(<${t}>(.*?)<\\/${t}>|<${t}>|<${t}\\s*\\/>)`]=n[t];i=x(i,e)}return i}function x(e,t){const n=[e];let i=!1;for(const s in t){const o=new RegExp(s,"g");let r=!1;for(let e=0;e<n.length;e++){const a=n[e];if("string"!=typeof a)continue;let c=o.exec(a);if(!c)continue;r=!0;const l=a.slice(0,c.index),d=[];let u;for(;c;){u=c;const e=c.slice(2);let n,r;if(n=t[s]instanceof Function?t[s](...e):t[s],"object"==typeof n&&(i=!0),"string"==typeof n&&""===n||d.push(n),c=o.exec(a),c){const e=u.index+u[0].length;r=a.slice(e,c.index)}else r=a.slice(u.index+u[0].length);r&&d.push(r)}n.splice(e,1,...d),""!==l&&n.splice(e,0,l)}r||"%\\(count\\)s"!==s&&u.a.log(`Could not find ${o} in ${e}`)}return i?d.a.createElement("span",null,...n):n.join("")}function T(e){Array.isArray(e)||(e=[e]);const t=m.a.get();let n,i;return t&&t.setLanguage(e),U().then(t=>{i=t;for(let t=0;t<e.length;++t)if(i.hasOwnProperty(e[t])){n=e[t];break}return n||(n="en",u.a.error("Unable to find an appropriate language")),L("i18n/"+i[n].fileName)}).then(async e=>{if(c.a.registerTranslations(n,e),await W(),c.a.setLocale(n),await h.b.setValue("language",null,p.a.DEVICE,n),u.a.log("set language to "+n),"en"!==n)return L("i18n/"+i.en.fileName)}).then(async e=>{e&&c.a.registerTranslations("en",e),await W()})}function j(){return U().then(e=>{const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push({value:n,label:e[n].label});return t})}function N(){return navigator.languages&&navigator.languages.length?navigator.languages:navigator.language?[navigator.language]:[navigator.userLanguage||"en"]}function P(e){const t=[],n=D(e),i=n.split("-");return 2===i.length&&i[0]===i[1]?t.push(i[0]):(t.push(n),2===i.length&&t.push(i[0])),t}function D(e){return e.toLowerCase().replace("_","-")}function A(){return c.a.getLocale()}function M(e){const t=A(),n=e.map(D);{const i=n.indexOf(t);if(i>-1)return e[i]}{const i=n.findIndex(e=>e.slice(0,2)===t.slice(0,2));if(i>-1)return e[i]}{const t=n.findIndex(e=>e.startsWith("en"));if(t>-1)return e[t]}return e[0]}function U(){return new Promise((e,t)=>{let n;n="string"==typeof v?v:"i18n/languages.json",r()({method:"GET",url:n},(i,s,o)=>{i?t(i):s.status<200||s.status>=300?t(new Error(`Failed to load ${n}, got ${s.status}`)):e(JSON.parse(o))})})}async function L(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return Object(g.a)(()=>F(e),t,t=>(u.a.log("Failed to load i18n",e),u.a.error(t),!0))}function F(e){return new Promise((t,n)=>{r()({method:"GET",url:e},(i,s,o)=>{i?n(i):s.status<200||s.status>=300?n(new Error(`Failed to load ${e}, got ${s.status}`)):t(JSON.parse(o))})})}let B=null,K=0;class V{constructor(){}}async function W(){const e=f.b.get().custom_translations_url;if(e)try{let t;if(Date.now()>=K?(t=V.lookupFn?V.lookupFn(e):await(await fetch(e)).json(),B=t,K=Date.now()+3e5):t=B,!t)return;const n={};for(const[e,i]of Object.entries(t))for(const[t,s]of Object.entries(i))n[t]||(n[t]={}),n[t][e]=s;for(const[e,t]of Object.entries(n))c.a.registerTranslations(e,t)}catch(e){u.a.warn("Ignoring error while registering custom translations: ",e),K=Date.now()+3e5}}s()(V,"lookupFn",void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return J}));var i=n(88),s=n.n(i),o=n(120),r=n(311),a=n(7),c=n(144),l=n(314),d=n(145),u=n(369),h=n(0),m=n(605),p=n(93),g=n(119),f=n(108),v=n(113),b=n(116),y=n(92);function S(e,t,n){return{action:"MatrixActions.sync",state:t,prevState:n,matrixClient:e}}function E(e,t){return{action:"MatrixActions.accountData",event:t,event_type:t.getType(),event_content:t.getContent()}}function w(e,t,n){return{action:"MatrixActions.Room.accountData",event:t,event_type:t.getType(),event_content:t.getContent(),room:n}}function _(e,t){return{action:"MatrixActions.Room",room:t}}function C(e,t,n){return{action:"MatrixActions.Room.tags",room:n}}function O(e,t,n){return{action:"MatrixActions.Room.receipt",event:t,room:n,matrixClient:e}}function R(e,t,n,i,s,o){return{action:"MatrixActions.Room.timeline",event:t,isLiveEvent:o.liveEvent,isLiveUnfilteredRoomTimelineEvent:n&&o.timeline.getTimelineSet()===n.getUnfilteredTimelineSet(),room:n}}function I(e,t,n,i){return{action:"MatrixActions.RoomState.events",event:t,state:n,lastStateEvent:i}}function k(e,t,n,i){return{action:"MatrixActions.Room.myMembership",room:t,membership:n,oldMembership:i}}function x(e,t){return{action:"MatrixActions.Event.decrypted",event:t}}let T=[];function j(e,t,n){const i=function(){for(var t=arguments.length,i=new Array(t),s=0;s<t;s++)i[s]=arguments[s];const o=n(e,...i);o&&y.a.dispatch(o,!1)};e.on(t,i),T.push(()=>{e.removeListener(t,i)})}var N={start(e){j(e,g.b.Sync,S),j(e,g.b.AccountData,E),j(e,v.c.AccountData,w),j(e,g.b.Room,_),j(e,v.c.Tags,C),j(e,v.c.Receipt,O),j(e,v.c.Timeline,R),j(e,v.c.MyMembership,k),j(e,f.c.Decrypted,x),j(e,b.b.Events,I)},stop(){T.forEach(e=>e()),T=[]}},P=n(95),D=n(380),A=n(381),M=n(247),U=n(214),L=n(249),F=n(87),B=n.n(F),K=n(89),V=n(98),W=n(101),H=n(110),q=n(115);var $=e=>{const t=V.b.get().brand,n=Object(K.a)("You've previously used a newer version of %(brand)s with this session. To use this version again with end to end encryption, you will need to sign out and back in again.",{brand:t});return B.a.createElement(W.a,{className:"mx_CryptoStoreTooNewDialog",contentId:"mx_Dialog_content",title:Object(K.a)("Incompatible Database"),hasCancel:!1,onFinished:e.onFinished},B.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},n),B.a.createElement(H.a,{primaryButton:Object(K.a)("Continue With Encryption Disabled"),hasCancel:!1,onPrimaryButtonClick:e.onFinished},B.a.createElement("button",{onClick:()=>{P.a.createTrackedDialog("Logout e2e db too new","",q.a,{title:Object(K.a)("Sign out"),description:Object(K.a)("To avoid losing your chat history, you must export your room keys before logging out. You will need to go back to the newer version of %(brand)s to do this",{brand:t}),button:Object(K.a)("Sign out"),focus:!1,onFinished:t=>{t&&(y.a.dispatch({action:"logout"}),e.onFinished(!0))}})}},Object(K.a)("Sign out"))))};function G(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function z(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?G(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):G(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const J=new class{constructor(){s()(this,"opts",{initialSyncLimit:20}),s()(this,"matrixClient",null),s()(this,"justRegisteredUserId",null),s()(this,"currentClientCreds",void 0)}get(){return this.matrixClient}unset(){this.matrixClient=null,N.stop()}setJustRegisteredUserId(e){if(this.justRegisteredUserId=e,e){const e=Date.now().toString();window.localStorage.setItem("mx_registration_time",e)}}currentUserIsJustRegistered(){return this.matrixClient&&this.matrixClient.credentials.userId===this.justRegisteredUserId}userRegisteredWithinLastHours(e){if(e<=0)return!1;try{const t=parseInt(window.localStorage.getItem("mx_registration_time"),10);return(Date.now()-t)/36e5<=e}catch(e){return!1}}replaceUsingCreds(e){this.currentClientCreds=e,this.createClient(e)}async assign(){for(const e of["indexeddb","memory"])try{const e=this.matrixClient.store.startup();h.a.log("MatrixClientPeg: waiting for MatrixClient store to initialise"),await e;break}catch(t){if("indexeddb"!==e)throw h.a.error("Failed to start memory store!",t),t;h.a.error("Error starting matrixclient store - falling back to memory store",t),this.matrixClient.store=new r.a({localStorage:localStorage})}A.f(this.matrixClient);try{!p.b.getValue("lowBandwidth")&&this.matrixClient.initCrypto&&(await this.matrixClient.initCrypto(),this.matrixClient.setCryptoTrustCrossSignedDevices(!p.b.getValue("e2ee.manuallyVerifyAllSessions")),await Object(U.f)(this.matrixClient),A.e(!0))}catch(e){e&&"InvalidCryptoStoreError"===e.name&&P.a.createDialog($),h.a.warn("Unable to initialise e2e",e)}const e=a.j(this.opts);return e.pendingEventOrdering=o.PendingEventOrdering.Detached,e.lazyLoadMembers=!0,e.clientWellKnownPollPeriod=7200,e.experimentalThreadSupport=p.b.getValue("feature_thread"),N.start(this.matrixClient),D.a.matrixClient=this.matrixClient,e}async start(){const e=await this.assign();h.a.log("MatrixClientPeg: really starting MatrixClient"),await this.get().startClient(e),h.a.log("MatrixClientPeg: MatrixClient started")}getCredentials(){var e,t,n,i;let s=this.currentClientCreds;return(null===(e=this.currentClientCreds)||void 0===e?void 0:e.userId)!==(null===(t=this.matrixClient)||void 0===t||null===(n=t.credentials)||void 0===n?void 0:n.userId)&&(s=null),z(z({},null!==(i=s)&&void 0!==i?i:{}),{},{homeserverUrl:this.matrixClient.baseUrl,identityServerUrl:this.matrixClient.idBaseUrl,userId:this.matrixClient.credentials.userId,deviceId:this.matrixClient.getDeviceId(),accessToken:this.matrixClient.getAccessToken(),guest:this.matrixClient.isGuest()})}getHomeserverName(){const e=/^@[^:]+:(.+)$/.exec(this.matrixClient.credentials.userId);if(null===e||e.length<1)throw new Error("Failed to derive homeserver name from user ID!");return e[1]}createClient(e){const t={baseUrl:e.homeserverUrl,idBaseUrl:e.identityServerUrl,accessToken:e.accessToken,userId:e.userId,deviceId:e.deviceId,pickleKey:e.pickleKey,timelineSupport:!0,forceTURN:!p.b.getValue("webRtcAllowPeerToPeer"),fallbackICEServerAllowed:!!p.b.getValue("fallbackICEServerAllowed"),iceCandidatePoolSize:20,verificationMethods:[d.e.SAS,u.e,d.e.RECIPROCATE_QR_CODE],unstableClientRelationAggregation:!0,identityServer:new M.a,cryptoCallbacks:{}};Object.assign(t.cryptoCallbacks,U.c),L.a.getDehydrationKey&&(t.cryptoCallbacks.getDehydrationKey=L.a.getDehydrationKey),this.matrixClient=Object(m.a)(t),this.matrixClient.setMaxListeners(500),this.matrixClient.setGuest(Boolean(e.guest));const n=new l.b(null,{timelineSupport:!0,pendingEvents:!1});n.getLiveTimeline().setPaginationToken("",c.b.BACKWARDS),this.matrixClient.setNotifTimelineSet(n)}};window.mxMatrixClientPeg||(window.mxMatrixClientPeg=J)},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(103),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(114),d=n(109);const u=["element","onClick","children","kind","disabled","inputRef","className","onKeyDown","onKeyUp","triggerOnMouseDown"];function h(e){let{element:t,onClick:n,children:i,kind:o,disabled:a,inputRef:h,className:m,onKeyDown:p,onKeyUp:g,triggerOnMouseDown:f}=e;const v=s()(e,u);return a?(v["aria-disabled"]=!0,v.disabled=!0):(f?v.onMouseDown=n:v.onClick=n,v.onKeyDown=e=>{switch(Object(l.a)().getAccessibilityAction(e)){case d.h.Enter:return e.stopPropagation(),e.preventDefault(),n(e);case d.h.Space:e.stopPropagation(),e.preventDefault();break;default:null==p||p(e)}},v.onKeyUp=e=>{switch(Object(l.a)().getAccessibilityAction(e)){case d.h.Enter:e.stopPropagation(),e.preventDefault();break;case d.h.Space:return e.stopPropagation(),e.preventDefault(),n(e);default:null==g||g(e)}}),v.ref=h,v.className=c()("mx_AccessibleButton",m,{mx_AccessibleButton_hasKind:o,["mx_AccessibleButton_kind_"+o]:o,mx_AccessibleButton_disabled:a}),r.a.createElement(t,v,i)}h.defaultProps={element:"div",role:"button",tabIndex:0},h.displayName="AccessibleButton"},function(e,t,n){"use strict";var i=n(899),s=n(606);class o extends i.Dispatcher{dispatch(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e instanceof s.a?e.fn(e=>{this.dispatch(e,t)}):t?super.dispatch(e):setTimeout(super.dispatch.bind(this,e),0)}fire(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.dispatch({action:e},t)}}const r=new o;window.mxDispatcher||(window.mxDispatcher=r),t.a=r},function(e,t,n){"use strict";n.d(t,"a",(function(){return M})),n.d(t,"b",(function(){return U}));var i=n(88),s=n.n(i),o=n(0),r=n(90),a=n(104),c=n(452);class l extends c.a{constructor(e,t){super(),this.featureNames=e,this.watchers=t}getValue(e,t){if(this.featureNames.includes(e))return this.readFeature(e);if("notificationsEnabled"===e)return this.getBoolean("notifications_enabled");if("notificationBodyEnabled"===e)return this.getBoolean("notifications_body_enabled");if("audioNotificationsEnabled"===e)return this.getBoolean("audio_notifications_enabled");return(this.getSettings()||{})[e]}setValue(e,t,n){if(this.featureNames.includes(e))return this.writeFeature(e,n),Promise.resolve();if("notificationsEnabled"===e)return this.setBoolean("notifications_enabled",n),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve();if("notificationBodyEnabled"===e)return this.setBoolean("notifications_body_enabled",n),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve();if("audioNotificationsEnabled"===e)return this.setBoolean("audio_notifications_enabled",n),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve();if("layout"===e){const t=this.getSettings()||{};return delete t.useIRCLayout,t.layout=n,this.setObject("mx_local_settings",t),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve()}const i=this.getSettings()||{};return i[e]=n,this.setObject("mx_local_settings",i),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve()}canSetValue(e,t){return!0}watchSetting(e,t,n){this.watchers.watchSetting(e,t,n)}unwatchSetting(e){this.watchers.unwatchSetting(e)}getSettings(){return this.getObject("mx_local_settings")}readFeature(e){return(!r.a.get()||!r.a.get().isGuest())&&this.getBoolean("mx_labs_feature_"+e)}writeFeature(e,t){this.setBoolean("mx_labs_feature_"+e,t),this.watchers.notifyUpdate(e,null,a.a.DEVICE,t)}}class d extends c.a{constructor(e){super(),this.watchers=e}getValue(e,t){if("blacklistUnverifiedDevices"===e){const e=this.read("mx_local_settings");if(null!=e&&e.blacklistUnverifiedDevicesPerRoom)return e.blacklistUnverifiedDevicesPerRoom[t]}const n=this.read(this.getKey(e,t));return n?n.value:null}setValue(e,t,n){if("blacklistUnverifiedDevices"===e){let i=this.read("mx_local_settings");return i||(i={}),i.blacklistUnverifiedDevicesPerRoom||(i.blacklistUnverifiedDevicesPerRoom={}),i.blacklistUnverifiedDevicesPerRoom[t]=n,this.setObject("mx_local_settings",i),this.watchers.notifyUpdate(e,t,a.a.ROOM_DEVICE,n),Promise.resolve()}return null===n?this.removeItem(this.getKey(e,t)):this.setObject(this.getKey(e,t),{value:n}),this.watchers.notifyUpdate(e,t,a.a.ROOM_DEVICE,n),Promise.resolve()}canSetValue(e,t){return!0}read(e){return this.getObject(e)}getKey(e,t){return"mx_setting_"+e+"_"+t}}var u=n(321);class h extends u.a{constructor(e,t){super(),this.defaults=e,this.invertedDefaults=t}getValue(e,t){let n=this.defaults[e];return void 0===n&&(n=this.invertedDefaults[e]),n}async setValue(e,t,n){throw new Error("Cannot set values on the default level handler")}canSetValue(e,t){return!1}isSupported(){return!0}}var m=n(113),p=n(7),g=n(380),f=n(164);class v extends g.a{constructor(e){super(),this.watchers=e,s()(this,"onAccountData",(e,t,n)=>{const i=t.roomId;if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",i,a.a.ROOM_ACCOUNT,t)}else if("im.vector.web.settings"===e.getType()){const t=n?n.getContent():{},s=Object(f.d)(t,e.getContent());for(const t of s){const n=e.getContent()[t];this.watchers.notifyUpdate(t,i,a.a.ROOM_ACCOUNT,n)}}else"im.vector.setting.allowed_widgets"===e.getType()&&this.watchers.notifyUpdate("allowedWidgets",i,a.a.ROOM_ACCOUNT,e.getContent())})}initMatrixClient(e,t){e&&e.removeListener(m.c.AccountData,this.onAccountData),t.on(m.c.AccountData,this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("allowedWidgets"===e)return this.getSettings(t,"im.vector.setting.allowed_widgets");return(this.getSettings(t)||{})[e]}async setRoomAccountData(e,t,n,i){let s;null===n?s=i:(s=this.getSettings(e,t)||{},s[n]=i),await this.client.setRoomAccountData(e,t,s);const o=Object(p.l)(),r=(s,a)=>{a.roomId===e&&s.getType()===t&&(null!==n&&s.getContent()[n]!==i||(this.client.off(m.c.AccountData,r),o.resolve()))};this.client.on(m.c.AccountData,r),await o.promise}setValue(e,t,n){switch(e){case"urlPreviewsEnabled":return this.setRoomAccountData(t,"org.matrix.room.preview_urls","disable",!n);case"allowedWidgets":return this.setRoomAccountData(t,"im.vector.setting.allowed_widgets",null,n);default:return this.setRoomAccountData(t,"im.vector.web.settings",e,n)}}canSetValue(e,t){return!!this.client.getRoom(t)}isSupported(){return this.client&&!this.client.isGuest()}getSettings(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"im.vector.web.settings";const i=null===(t=this.client.getRoom(e))||void 0===t?void 0:t.getAccountData(n);return i&&i.getContent()?Object(f.a)(i.getContent()):null}}var b=n(119);const y=["im.vector.riot.breadcrumb_rooms","im.vector.setting.breadcrumbs"];class S extends g.a{constructor(e){super(),this.watchers=e,s()(this,"onAccountData",(e,t)=>{if("org.matrix.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",null,a.a.ACCOUNT,t)}else if("im.vector.web.settings"===e.getType()||"im.vector.analytics"===e.getType()){var n;const i=null!==(n=null==t?void 0:t.getContent())&&void 0!==n?n:{},s=Object(f.d)(i,e.getContent());for(const t of s){const n=e.getContent()[t];this.watchers.notifyUpdate(t,null,a.a.ACCOUNT,n)}}else if(y.includes(e.getType()))this.notifyBreadcrumbsUpdate(e);else if("im.vector.setting.integration_provisioning"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("integrationProvisioning",null,a.a.ACCOUNT,t)}else if("io.element.recent_emoji"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("recent_emoji",null,a.a.ACCOUNT,t)}})}get level(){return a.a.ACCOUNT}initMatrixClient(e,t){null==e||e.removeListener(b.b.AccountData,this.onAccountData),t.on(b.b.AccountData,this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("breadcrumb_rooms"===e){let e=this.getSettings("im.vector.setting.breadcrumbs");return e&&e.recent_rooms||(e=this.getSettings("im.vector.riot.breadcrumb_rooms"),e&&(e.recent_rooms=e.rooms)),e&&e.recent_rooms?e.recent_rooms:[]}if("recent_emoji"===e){const e=this.getSettings("io.element.recent_emoji");return e?e.recent_emoji:null}if("integrationProvisioning"===e){const e=this.getSettings("im.vector.setting.integration_provisioning");return e?e.enabled:null}if("pseudonymousAnalyticsOptIn"===e){const t=this.getSettings("im.vector.analytics")||{};return"boolean"!=typeof t[e]?null:t[e]}if("MessageComposerInput.insertTrailingColon"===e){const n=(this.getSettings()||{})[e];return null==n?(this.setValue(e,t,!0),!0):n}const n=this.getSettings()||{};let i=n[e];return null==i&&("hideAvatarChanges"!==e&&"hideDisplaynameChanges"!==e||(i=n.hideAvatarDisplaynameChanges)),i}async setAccountData(e,t,n,i){var s;let o=this.getSettings(e);!i||null!==(s=o)&&void 0!==s&&s[t]||(o=this.getSettings(i)),o||(o={}),o[t]=n,await this.client.setAccountData(e,o);const r=Object(p.l)(),a=i=>{i.getType()===e&&i.getContent()[t]===n&&(this.client.off(b.b.AccountData,a),r.resolve())};this.client.on(b.b.AccountData,a),await r.promise}setValue(e,t,n){switch(e){case"urlPreviewsEnabled":return this.setAccountData("org.matrix.preview_urls","disable",!n);case"breadcrumb_rooms":return this.setAccountData("im.vector.setting.breadcrumbs","recent_rooms",n,"im.vector.riot.breadcrumb_rooms");case"recent_emoji":return this.setAccountData("io.element.recent_emoji","recent_emoji",n);case"integrationProvisioning":return this.setAccountData("im.vector.setting.integration_provisioning","enabled",n);case"pseudonymousAnalyticsOptIn":return this.setAccountData("im.vector.analytics","pseudonymousAnalyticsOptIn",n);default:return this.setAccountData("im.vector.web.settings",e,n)}}canSetValue(e,t){return!0}isSupported(){return this.client&&!this.client.isGuest()}getSettings(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"im.vector.web.settings";if(!this.client)return null;const t=this.client.getAccountData(e);return t&&t.getContent()?Object(f.a)(t.getContent()):null}notifyBreadcrumbsUpdate(e){let t=[];if("im.vector.riot.breadcrumb_rooms"===e.getType()){const n=this.getSettings("im.vector.setting.breadcrumbs");t=n?n.recent_rooms:e.getContent().rooms}else{if("im.vector.setting.breadcrumbs"!==e.getType())return;t=e.getContent().recent_rooms}this.watchers.notifyUpdate("breadcrumb_rooms",null,a.a.ACCOUNT,t||[])}}var E=n(116);class w extends g.a{constructor(e){super(),this.watchers=e,s()(this,"onEvent",(e,t,n)=>{const i=e.getRoomId(),s=this.client.getRoom(i);if(s&&(!s||t===s.currentState))if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",i,a.a.ROOM,t)}else if("im.vector.web.settings"===e.getType()){const t=n?n.getContent():{},s=Object(f.d)(t,e.getContent());for(const t of s)this.watchers.notifyUpdate(t,i,a.a.ROOM,e.getContent()[t])}})}initMatrixClient(e,t){e&&e.removeListener(E.b.Events,this.onEvent),t.on(E.b.Events,this.onEvent)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}return(this.getSettings(t)||{})[e]}async sendStateEvent(e,t,n,i){const s=this.getSettings(e,t)||{};s[n]=i;const{event_id:o}=await this.client.sendStateEvent(e,t,s),r=Object(p.l)(),a=e=>{e.getId()===o&&(this.client.off(E.b.Events,a),r.resolve())};this.client.on(E.b.Events,a),await r.promise}setValue(e,t,n){switch(e){case"urlPreviewsEnabled":return this.sendStateEvent(t,"org.matrix.room.preview_urls","disable",!n);default:return this.sendStateEvent(t,"im.vector.web.settings",e,n)}}canSetValue(e,t){var n;const i=this.client.getRoom(t);let s="im.vector.web.settings";return"urlPreviewsEnabled"===e&&(s="org.matrix.room.preview_urls"),null!==(n=null==i?void 0:i.currentState.maySendStateEvent(s,this.client.getUserId()))&&void 0!==n&&n}isSupported(){return!!this.client}getSettings(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"im.vector.web.settings";const i=null===(t=this.client.getRoom(e))||void 0===t?void 0:t.currentState.getStateEvents(n,"");return null!=i&&i.getContent()?Object(f.a)(i.getContent()):null}}var _=n(98),C=n(9);class O extends u.a{constructor(e){super(),this.featureNames=e}getValue(e,t){const n=new C.a(_.b.get());if(this.featureNames.includes(e)){const t=(n.get("features")||{})[e];return Object(p.t)(t)?null:!0===t||!1===t?t:"enable"===t||"disable"!==t&&null}if("theme"===e)return n.get("default_theme");const i=n.get("setting_defaults");return!i||Object(p.t)(i[e])?null:i[e]}async setValue(e,t,n){throw new Error("Cannot change settings at the config level")}canSetValue(e,t){return!1}isSupported(){return!0}}var R=n(89),I=n(92),k=n(572);class x extends u.a{constructor(e,t){super(),this.handler=e,this.level=t,s()(this,"cache",{})}getValue(e,t){const n=null!=t?t:"UNDEFINED",i=this.cache[e];return null!=i&&i.hasOwnProperty(n)?i[n]:this.handler.getValue(e,t)}async setValue(e,t,n){var i;this.cache[e]||(this.cache[e]={});const s=this.cache[e],o=null!=t?t:"UNDEFINED";s[o]=n;const r=this.handler.getValue(e,t),a=this.handler.setValue(e,t,n);null===(i=this.handler.watchers)||void 0===i||i.notifyUpdate(e,t,this.level,n);try{await a}catch(n){var c;null===(c=this.handler.watchers)||void 0===c||c.notifyUpdate(e,t,this.level,r)}finally{s[o]===n&&delete s[o]}}canSetValue(e,t){return this.handler.canSetValue(e,t)}isSupported(){return this.handler.isSupported()}}var T=n(96);const j=new class{constructor(){s()(this,"watchers",new Map)}watchSetting(e,t,n){this.watchers.has(e)||this.watchers.set(e,new Map),this.watchers.get(e).has(t)||this.watchers.get(e).set(t,[]),this.watchers.get(e).get(t).push(n)}unwatchSetting(e){this.watchers.forEach(t=>{t.forEach(t=>{let n;for(;-1!==(n=t.indexOf(e));)t.splice(n,1)})})}notifyUpdate(e,t,n,i){if(!this.watchers.has(e))return;const s=this.watchers.get(e),o=[];null!==t&&s.has(t)&&o.push(...s.get(t)),t?s.has(null)&&o.push(...s.get(null)):o.push(...Array.from(s.values()).flat(1));for(const e of o)e(t,n,i)}},N={},P={},D=[];for(const e of Object.keys(k.b))N[e]=k.b[e].default,k.b[e].isFeature&&D.push(e),k.b[e].invertedSettingName&&(P[k.b[e].invertedSettingName]=!k.b[e].default);const A={[a.a.DEVICE]:new l(D,j),[a.a.ROOM_DEVICE]:new d(j),[a.a.ROOM_ACCOUNT]:new x(new v(j),a.a.ROOM_ACCOUNT),[a.a.ACCOUNT]:new x(new S(j),a.a.ACCOUNT),[a.a.ROOM]:new x(new w(j),a.a.ROOM),[a.a.CONFIG]:new O(D),[a.a.DEFAULT]:new h(N,P)},M=[a.a.DEVICE,a.a.ROOM_DEVICE,a.a.ROOM_ACCOUNT,a.a.ACCOUNT,a.a.ROOM,a.a.CONFIG,a.a.DEFAULT];class U{static getFeatureSettingNames(){return Object.keys(k.b).filter(e=>U.isFeature(e))}static watchSetting(e,t,n){const i=k.b[e],s=e;if(!i)throw new Error(e+" is not a setting");i.invertedSettingName&&(e=i.invertedSettingName);const o=`${(new Date).getTime()}_${U.watcherCount++}_${e}_${t}`,r=(e,t,i)=>{var o;const r=U.getValue(s),a=null!==(o=U.getValueAt(t,s))&&void 0!==o?o:i;n(s,e,t,a,r)};return U.watchers.set(o,r),j.watchSetting(e,t,r),o}static unwatchSetting(e){U.watchers.has(e)?(j.unwatchSetting(U.watchers.get(e)),U.watchers.delete(e)):o.a.warn("Ending non-existent watcher ID "+e)}static monitorSetting(e,t){t=t||null,this.monitors.has(e)||this.monitors.set(e,new Map);const n=()=>{this.monitors.get(e).set(t,U.watchSetting(e,t,(e,t,n,i,s)=>{I.a.dispatch({action:T.a.SettingUpdated,settingName:e,roomId:t,level:n,newValueAtLevel:i,newValue:s})}))},i=Array.from(this.monitors.get(e).keys());i.find(e=>e===t||null===e)?null===t&&(i.forEach(t=>{U.unwatchSetting(this.monitors.get(e).get(t))}),this.monitors.get(e).clear(),n()):n()}static getDisplayName(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.a.DEFAULT;if(!k.b[e]||!k.b[e].displayName)return null;let n=k.b[e].displayName;return n instanceof Object&&(n=n[t]?n[t]:n.default),Object(R.a)(n)}static getDescription(e){var t;const n=null===(t=k.b[e])||void 0===t?void 0:t.description;return n?"string"!=typeof n?n():Object(R.a)(n):null}static isFeature(e){return!!k.b[e]&&k.b[e].isFeature}static getBetaInfo(e){var t;if(U.isFeature(e)&&!1!==U.getValueAt(a.a.CONFIG,e,null,!0,!0))return null===(t=k.b[e])||void 0===t?void 0:t.betaInfo}static getLabGroup(e){if(U.isFeature(e))return k.b[e].labsGroup}static isEnabled(e){return!!k.b[e]&&(!k.b[e].controller||!k.b[e].controller.settingDisabled)}static getValue(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!k.b[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");const i=k.b[e],s=i.supportedLevelsAreOrdered?i.supportedLevels:M;return U.getValueAt(s[0],e,t,!1,n)}static getValueAt(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const o=k.b[t];if(!o)throw new Error("Setting '"+t+"' does not appear to be a setting.");const r=o.supportedLevelsAreOrdered?o.supportedLevels:M;r.includes(a.a.DEFAULT)||r.push(a.a.DEFAULT);const c=r.indexOf(e);if(-1===c)throw new Error("Level "+e+" is not prioritized");const l=U.getHandlers(t);if(o.invertedSettingName&&(t=o.invertedSettingName),i){const i=l[e];if(!i)return U.getFinalValue(o,e,n,null,null);const s=i.getValue(t,n);return U.getFinalValue(o,e,n,s,e)}for(let i=c;i<r.length;i++){const a=l[r[i]];if(!a)continue;if(s&&"default"===r[i])continue;const c=a.getValue(t,n);if(null!=c)return U.getFinalValue(o,e,n,c,r[i])}return U.getFinalValue(o,e,n,null,null)}static getDefaultValue(e){if(!k.b[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");return k.b[e].default}static getFinalValue(e,t,n,i,s){let o=i;if(e.controller){const r=e.controller.getValueOverride(t,n,i,s);null!=r&&(o=r)}return e.invertedSettingName&&(o=!o),o}static async setValue(e,t,n,i){var s;const o=k.b[e];if(!o)throw new Error("Setting '"+e+"' does not appear to be a setting.");const r=U.getHandler(e,n);if(!r)throw new Error("Setting "+e+" does not have a handler for "+n);if(o.invertedSettingName&&(e=o.invertedSettingName,i=!i),!r.canSetValue(e,t))throw new Error("User cannot set "+e+" at "+n+" in "+t);o.controller&&!await o.controller.beforeChange(n,t,i)||(await r.setValue(e,t,i),null===(s=o.controller)||void 0===s||s.onChange(n,t,i))}static canSetValue(e,t,n){var i;if(!k.b[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");if(!U.isEnabled(e))return!1;if(U.isFeature(e)&&(null===(i=k.b[e])||void 0===i||!i.betaInfo)){const n=U.getValueAt(a.a.CONFIG,e,t,!0,!0);if(!0===n||!1===n)return!1}const s=U.getHandler(e,n);return!!s&&s.canSetValue(e,t)}static isLevelSupported(e){return!!A[e]&&A[e].isSupported()}static firstSupportedLevel(e){const t=k.b[e];if(!t)throw new Error("Setting '"+e+"' does not appear to be a setting.");const n=t.supportedLevelsAreOrdered?t.supportedLevels:M;n.includes(a.a.DEFAULT)||n.push(a.a.DEFAULT);const i=U.getHandlers(e);for(const e of n){if(i[e])return e}return null}static debugSetting(e,t){o.a.log("--- DEBUG "+e);const n=k.b[e];o.a.log("--- definition: "+(n?JSON.stringify(n):"<NOT_FOUND>")),o.a.log("--- default level order: "+JSON.stringify(M)),o.a.log("--- registered handlers: "+JSON.stringify(Object.keys(A)));const i=e=>{for(const n of Object.keys(A)){const i=A[n];try{const s=i.getValue(e,t);o.a.log(`---     ${n}@${t||"<no_room>"} = ${JSON.stringify(s)}`)}catch(e){o.a.log(`---     ${i}@${t||"<no_room>"} THREW ERROR: ${e.message}`),o.a.error(e)}if(t)try{const t=i.getValue(e,null);o.a.log(`---     ${n}@<no_room> = ${JSON.stringify(t)}`)}catch(e){o.a.log(`---     ${i}@<no_room> THREW ERROR: ${e.message}`),o.a.error(e)}}o.a.log("--- calculating as returned by SettingsStore"),o.a.log("--- these might not match if the setting uses a controller - be warned!");try{const n=U.getValue(e,t);o.a.log(`---     SettingsStore#generic@${t||"<no_room>"}  = ${JSON.stringify(n)}`)}catch(e){o.a.log(`---     SettingsStore#generic@${t||"<no_room>"} THREW ERROR: ${e.message}`),o.a.error(e)}if(t)try{const t=U.getValue(e,null);o.a.log("---     SettingsStore#generic@<no_room>  = "+JSON.stringify(t))}catch(e){o.a.log("---     SettingsStore#generic@$<no_room> THREW ERROR: "+e.message),o.a.error(e)}for(const n of M){try{const i=U.getValueAt(n,e,t);o.a.log(`---     SettingsStore#${n}@${t||"<no_room>"} = ${JSON.stringify(i)}`)}catch(e){o.a.log(`---     SettingsStore#${n}@${t||"<no_room>"} THREW ERROR: ${e.message}`),o.a.error(e)}if(t)try{const t=U.getValueAt(n,e,null);o.a.log(`---     SettingsStore#${n}@<no_room> = ${JSON.stringify(t)}`)}catch(e){o.a.log(`---     SettingsStore#${n}@$<no_room> THREW ERROR: ${e.message}`),o.a.error(e)}}};i(e),n.invertedSettingName&&(o.a.log("--- TESTING INVERTED SETTING NAME"),o.a.log("--- inverted: "+n.invertedSettingName),i(n.invertedSettingName)),o.a.log("--- END DEBUG")}static getHandler(e,t){const n=U.getHandlers(e);return n[t]?n[t]:null}static getHandlers(e){if(!k.b[e])return{};const t={};for(const n of k.b[e].supportedLevels){if(!A[n])throw new Error("Unexpected level "+n);U.isLevelSupported(n)&&(t[n]=A[n])}return t.default||(t.default=A.default),t}}s()(U,"watchers",new Map),s()(U,"monitors",new Map),s()(U,"watcherCount",1),window.mxSettingsStore=U},,function(e,t,n){"use strict";(function(e){var i=n(99),s=n.n(i),o=n(88),r=n.n(o),a=n(87),c=n.n(a),l=n(150),d=n.n(l),u=n(94),h=n.n(u),m=n(7),p=n(162),g=n(92),f=n(946);class v{constructor(){r()(this,"counter",0),r()(this,"priorityModal",null),r()(this,"staticModal",null),r()(this,"modals",[]),r()(this,"onBackgroundClick",()=>{const e=this.getCurrentModal();e&&(e.closeReason="backgroundClick",e.close(),e.closeReason=null)})}static getOrCreateContainer(){let e=document.getElementById("mx_Dialog_Container");return e||(e=document.createElement("div"),e.id="mx_Dialog_Container",document.body.appendChild(e)),e}static getOrCreateStaticContainer(){let e=document.getElementById("mx_Dialog_StaticContainer");return e||(e=document.createElement("div"),e.id="mx_Dialog_StaticContainer",document.body.appendChild(e)),e}toggleCurrentDialogVisibility(){const e=this.getCurrentModal();e&&(e.hidden=!e.hidden)}hasDialogs(){return this.priorityModal||this.staticModal||this.modals.length>0}createTrackedDialog(e,t){p.a.trackEvent("Modal",e,t);for(var n=arguments.length,i=new Array(n>2?n-2:0),s=2;s<n;s++)i[s-2]=arguments[s];return this.createDialog(...i)}appendTrackedDialog(e,t){p.a.trackEvent("Modal",e,t);for(var n=arguments.length,i=new Array(n>2?n-2:0),s=2;s<n;s++)i[s-2]=arguments[s];return this.appendDialog(...i)}createDialog(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.createDialogAsync(Promise.resolve(e),...n)}appendDialog(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.appendDialogAsync(Promise.resolve(e),...n)}createTrackedDialogAsync(e,t){p.a.trackEvent("Modal",e,t);for(var n=arguments.length,i=new Array(n>2?n-2:0),s=2;s<n;s++)i[s-2]=arguments[s];return this.createDialogAsync(...i)}appendTrackedDialogAsync(e,t){p.a.trackEvent("Modal",e,t);for(var n=arguments.length,i=new Array(n>2?n-2:0),s=2;s<n;s++)i[s-2]=arguments[s];return this.appendDialogAsync(...i)}closeCurrentModal(e){const t=this.getCurrentModal();t&&(t.closeReason=e,t.close())}buildModal(e,t,n,i){const o={onFinished:t?t.onFinished:null,onBeforeClose:i.onBeforeClose,beforeClosePromise:null,closeReason:null,className:n,elem:null,close:null},[r,a]=this.getCloseFn(o,t),l=this.counter++;return o.elem=c.a.createElement(f.a,s()({key:l,prom:e},t,{onFinished:r})),o.close=r,{modal:o,closeDialog:r,onFinishedProm:a}}getCloseFn(e,t){var n=this;const i=Object(m.l)();return[async function(){if(e.beforeClosePromise)await e.beforeClosePromise;else if(e.onBeforeClose){e.beforeClosePromise=e.onBeforeClose(e.closeReason);const t=await e.beforeClosePromise;if(e.beforeClosePromise=null,!t)return}for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];i.resolve(o),t&&t.onFinished&&t.onFinished.apply(null,o);const a=n.modals.indexOf(e);a>=0&&n.modals.splice(a,1),n.priorityModal===e&&(n.priorityModal=null,n.modals=[]),n.staticModal===e&&(n.staticModal=null,n.modals=[]),n.reRender()},i.promise]}createDialogAsync(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const{modal:r,closeDialog:a,onFinishedProm:c}=this.buildModal(e,t,n,o);return i?this.priorityModal=r:s?this.staticModal=r:this.modals.unshift(r),this.reRender(),{close:a,finished:c}}appendDialogAsync(e,t,n){const{modal:i,closeDialog:s,onFinishedProm:o}=this.buildModal(e,t,n,{});return this.modals.push(i),this.reRender(),{close:s,finished:o}}getCurrentModal(){return this.priorityModal?this.priorityModal:this.modals[0]||this.staticModal}async reRender(){if(await Object(m.G)(0),0===this.modals.length&&!this.priorityModal&&!this.staticModal)return g.a.dispatch({action:"aria_unhide_main_app"}),d.a.unmountComponentAtNode(v.getOrCreateContainer()),void d.a.unmountComponentAtNode(v.getOrCreateStaticContainer());if(g.a.dispatch({action:"aria_hide_main_app"}),this.staticModal){const e=h()("mx_Dialog_wrapper mx_Dialog_staticWrapper",this.staticModal.className),t=c.a.createElement("div",{className:e},c.a.createElement("div",{className:"mx_Dialog"},this.staticModal.elem),c.a.createElement("div",{className:"mx_Dialog_background mx_Dialog_staticBackground",onClick:this.onBackgroundClick}));d.a.render(t,v.getOrCreateStaticContainer())}else d.a.unmountComponentAtNode(v.getOrCreateStaticContainer());const t=this.getCurrentModal();if(t===this.staticModal||t.hidden)d.a.unmountComponentAtNode(v.getOrCreateContainer());else{const n=h()("mx_Dialog_wrapper",t.className,{mx_Dialog_wrapperWithStaticUnder:this.staticModal}),i=c.a.createElement("div",{className:n},c.a.createElement("div",{className:"mx_Dialog"},t.elem),c.a.createElement("div",{className:"mx_Dialog_background",onClick:this.onBackgroundClick}));e(()=>d.a.render(i,v.getOrCreateContainer()))}}}window.singletonModalManager||(window.singletonModalManager=new v),t.a=window.singletonModalManager}).call(this,n(179).setImmediate)},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.ViewUser="view_user",e.ViewUserSettings="view_user_settings",e.ViewRoomDirectory="view_room_directory",e.ViewRoomError="view_room_error",e.ViewHomePage="view_home_page",e.RecheckTheme="recheck_theme",e.CheckUpdates="check_updates",e.FocusSendMessageComposer="focus_send_message_composer",e.FocusEditMessageComposer="focus_edit_message_composer",e.FocusAComposer="focus_a_composer",e.ToggleUserMenu="toggle_user_menu",e.ToggleSpacePanel="toggle_space_panel",e.UpdateFontSize="update_font_size",e.UpdateSystemFont="update_system_font",e.ViewRoom="view_room",e.ViewRoomDelta="view_room_delta",e.OpenDialPad="open_dial_pad",e.DialNumber="dial_number",e.PstnSupportUpdated="pstn_support_updated",e.VirtualRoomSupportUpdated="virtual_room_support_updated",e.UploadStarted="upload_started",e.UploadProgress="upload_progress",e.UploadFinished="upload_finished",e.UploadFailed="upload_failed",e.UploadCanceled="upload_canceled",e.JoinRoom="join_room",e.JoinRoomReady="join_room_ready",e.JoinRoomError="join_room_error",e.BulkRedactStart="bulk_redact_start",e.BulkRedactEnd="bulk_redact_end",e.ComposerInsert="composer_insert",e.SwitchSpace="switch_space",e.UpdateSpaceHierarchy="update_space_hierarchy",e.SettingUpdated="setting_updated",e.EditEvent="edit_event",e.PseudonymousAnalyticsAccept="pseudonymous_analytics_accept",e.PseudonymousAnalyticsReject="pseudonymous_analytics_reject",e.AnonymousAnalyticsAccept="anonymous_analytics_accept",e.AnonymousAnalyticsReject="anonymous_analytics_reject",e.ReportKeyBackupNotEnabled="report_key_backup_not_enabled",e.AfterLeaveRoom="after_leave_room",e.DoAfterSyncPrepared="do_after_sync_prepared",e.ViewStartChatOrReuse="view_start_chat_or_reuse",e.ActiveRoomChanged="active_room_changed",e.OpenForwardDialog="open_forward_dialog",e.OpenReportEventDialog="open_report_event_dialog",e.TriggerLogout="trigger_logout",e.OpenSpacePreferences="open_space_preferences",e.OpenSpaceSettings="open_space_settings",e.OpenInviteDialog="open_invite_dialog",e.OpenAddToExistingSpaceDialog="open_add_to_existing_space_dialog",e.DumpDebugLogs="dump_debug_logs",e.ShowRoomTopic="show_room_topic",e.OnLoggedOut="on_logged_out",e.OnLoggedIn="on_logged_in"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"d",(function(){return o})),n.d(t,"c",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"f",(function(){return c})),n.d(t,"i",(function(){return l})),n.d(t,"h",(function(){return d})),n.d(t,"l",(function(){return u})),n.d(t,"k",(function(){return h})),n.d(t,"j",(function(){return m})),n.d(t,"g",(function(){return p})),n.d(t,"a",(function(){return g}));var i=n(3);let s,o,r;!function(e){e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomAliases="m.room.aliases",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy"}(s||(s={})),function(e){e.Annotation="m.annotation",e.Replace="m.replace",e.Reference="m.reference",e.Thread="m.thread"}(o||(o={})),function(e){e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video",e.KeyVerificationRequest="m.key.verification.request"}(r||(r={}));const a="type";let c;!function(e){e.Space="m.space",e.UnstableCall="org.matrix.msc3417.call",e.ElementVideo="io.element.video"}(c||(c={}));const l=new i.b("m.room.purpose","org.matrix.msc3088.purpose"),d=new i.b("m.enabled","org.matrix.msc3088.enabled"),u=new i.b("m.data_tree","org.matrix.msc3089.data_tree"),h=new i.b("m.leaf","org.matrix.msc3089.leaf"),m=new i.b("m.branch","org.matrix.msc3089.branch"),p=new i.b("io.element.functional_members","io.element.functional_members"),g=new i.b("m.visibility","org.matrix.msc3531.visibility")},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return c}));var i=n(88),s=n.n(i),o=n(9);const r={brand:"Element",integrations_ui_url:"https://scalar.vector.im/",integrations_rest_url:"https://scalar.vector.im/api",bug_report_endpoint_url:null,jitsi:{preferred_domain:"meet.element.io"},desktopBuilds:{available:!0,logo:n(902).default,url:"https://element.io/get-started"},spaces_learn_more_url:"https://element.io/blog/spaces-blast-out-of-beta/"};class a{static setInstance(e){a.instance=e,a.fallback=new o.a(e),window.mxReactSdkConfig=e}static get(e,t){return void 0===e?a.instance||{}:a.fallback.get(e,t)}static getObject(e,t){const n=a.get(e,t);return null!=n?new o.a(n):void 0===n?void 0:null}static put(e){const t=Object.keys(r);for(let n=0;n<t.length;++n)void 0===e[t[n]]&&(e[t[n]]=r[t[n]]);a.setInstance(e)}static unset(){a.setInstance({})}static add(e){const t=a.get(),n=Object.assign({},t,e);a.put(n)}}function c(e){return e.sso_redirect_options?e.sso_redirect_options:e.sso_immediate_redirect?{immediate:!0}:{}}s()(a,"instance",void 0),s()(a,"fallback",void 0)},,function(e,t,n){"use strict";n.d(t,"b",(function(){return c}));var i=n(99),s=n.n(i),o=n(87),r=n.n(o);const a=Object(o.createContext)(void 0);a.displayName="MatrixClientContext",t.a=a;const c=e=>{const t=e;return Object(o.forwardRef)((e,n)=>{const i=Object(o.useContext)(a);return r.a.createElement(t,s()({ref:n},e,{mxClient:i}))})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(376),c=n.n(a),l=n(94),d=n.n(l),u=n(91),h=n(90),m=n(89),p=n(100),g=n(317),f=n(127),v=n(114),b=n(109);class y extends r.a.Component{constructor(e){super(e),s()(this,"matrixClient",void 0),s()(this,"onKeyDown",e=>{this.props.onKeyDown&&this.props.onKeyDown(e);switch(Object(v.a)().getAccessibilityAction(e)){case b.h.Escape:if(!this.props.hasCancel)break;e.stopPropagation(),e.preventDefault(),this.props.onFinished(!1)}}),s()(this,"onCancelClick",e=>{this.props.onFinished(!1)}),this.matrixClient=h.a.get()}render(){let e,t;this.props.hasCancel&&(e=r.a.createElement(u.a,{onClick:this.onCancelClick,className:"mx_Dialog_cancelButton","aria-label":Object(m.a)("Close dialog")})),this.props.headerImage&&(t=r.a.createElement("img",{className:"mx_Dialog_titleImage",src:this.props.headerImage,alt:""}));const n={onKeyDown:this.onKeyDown,role:"dialog","aria-describedby":this.props.contentId};return this.props["aria-label"]?n["aria-label"]=this.props["aria-label"]:n["aria-labelledby"]="mx_BaseDialog_title",r.a.createElement(p.a.Provider,{value:this.matrixClient},r.a.createElement(f.a,{screenName:this.props.screenName}),r.a.createElement(c.a,{returnFocus:!0,lockProps:n,className:d()({[this.props.className]:!0,mx_Dialog_fixedWidth:this.props.fixedWidth})},r.a.createElement("div",{className:d()("mx_Dialog_header",{mx_Dialog_headerWithButton:!!this.props.headerButton,mx_Dialog_headerWithCancel:!!e})},r.a.createElement(g.a,{size:"h2",className:d()("mx_Dialog_title",this.props.titleClass),id:"mx_BaseDialog_title"},t,this.props.title),this.props.headerButton,e),this.props.children))}}s()(y,"defaultProps",{hasCancel:!0,fixedWidth:!0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(89);class c extends r.a.PureComponent{render(){const{w:e,h:t,message:n}=this.props;return r.a.createElement("div",{className:"mx_Spinner"},n&&r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_Spinner_Msg"},n)," "),r.a.createElement("div",{className:"mx_Spinner_icon",style:{width:e,height:t},"aria-label":Object(a.a)("Loading...")}))}}s()(c,"defaultProps",{w:32,h:32})},,function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.DEVICE="device",e.ROOM_DEVICE="room-device",e.ROOM_ACCOUNT="room-account",e.ACCOUNT="account",e.ROOM="room",e.CONFIG="config",e.DEFAULT="default"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var i=n(103),s=n.n(i),o=n(88),r=n.n(o),a=n(87),c=n.n(a),l=n(94),d=n.n(l),u=n(111),h=n(140);const m=["element","inputRef","prefixComponent","postfixComponent","className","onValidate","children","tooltipContent","forceValidity","tooltipClassName","list","validateOnBlur","validateOnChange","validateOnFocus","usePlaceholderAsHint","forceTooltipVisible"];function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let f=1;class v extends c.a.PureComponent{constructor(e){super(e),r()(this,"id",void 0),r()(this,"inputRef",void 0),r()(this,"validateOnChange",Object(u.debounce)(()=>{this.validate({focused:!0})},200)),r()(this,"onFocus",e=>{this.setState({focused:!0}),this.props.validateOnFocus&&this.validate({focused:!0}),this.props.onFocus&&this.props.onFocus(e)}),r()(this,"onChange",e=>{this.props.validateOnChange&&this.validateOnChange(),this.props.onChange&&this.props.onChange(e)}),r()(this,"onBlur",e=>{this.setState({focused:!1}),this.props.validateOnBlur&&this.validate({focused:!1}),this.props.onBlur&&this.props.onBlur(e)}),this.state={valid:void 0,feedback:void 0,feedbackVisible:!1,focused:!1},this.id=this.props.id||"mx_Field_"+f++}focus(){var e;null===(e=this.inputRef.current)||void 0===e||e.focus(),this.setState({focused:!0})}async validate(e){var t,n;let{focused:i,allowEmpty:s=!0}=e;if(!this.props.onValidate)return;const o=null!==(t=null===(n=this.inputRef.current)||void 0===n?void 0:n.value)&&void 0!==t?t:null,{valid:r,feedback:a}=await this.props.onValidate({value:o,focused:i,allowEmpty:s});return this.state.focused&&a?this.setState({valid:r,feedback:a,feedbackVisible:!0}):this.setState({valid:r,feedbackVisible:!1}),r}render(){const e=this.props,{element:t,inputRef:n,prefixComponent:i,postfixComponent:o,className:r,onValidate:a,children:l,tooltipContent:u,forceValidity:p,tooltipClassName:f,list:v,validateOnBlur:b,validateOnChange:y,validateOnFocus:S,usePlaceholderAsHint:E,forceTooltipVisible:w}=e,_=s()(e,m);this.inputRef=n||c.a.createRef(),_.placeholder=_.placeholder||_.label,_.id=this.id,_.onFocus=this.onFocus,_.onChange=this.onChange,_.onBlur=this.onBlur;const C=g(g({},_),{},{ref:this.inputRef,list:v}),O=c.a.createElement(this.props.element,C,l);let R=null;i&&(R=c.a.createElement("span",{className:"mx_Field_prefix"},i));let I=null;o&&(I=c.a.createElement("span",{className:"mx_Field_postfix"},o));const k=null!=p,x=d()("mx_Field","mx_Field_"+this.props.element,r,{mx_Field_labelAlwaysTopLeft:i||E,mx_Field_placeholderIsHint:E,mx_Field_valid:k?p:a&&!0===this.state.valid,mx_Field_invalid:k?!p:a&&!1===this.state.valid});let T;return(u||this.state.feedback)&&(T=c.a.createElement(h.b,{tooltipClassName:d()("mx_Field_tooltip",f),visible:this.state.focused&&w||this.state.feedbackVisible,label:u||this.state.feedback,alignment:h.b.Alignment.Right})),c.a.createElement("div",{className:x},R,O,c.a.createElement("label",{htmlFor:this.id},this.props.label),I,T)}}r()(v,"defaultProps",{element:"input",type:"text",validateOnFocus:!0,validateOnBlur:!0,validateOnChange:!0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(87),s=n(157);let o;!function(e){e.Room="Room",e.Thread="Thread",e.ThreadsList="ThreadsList",e.File="File",e.Notification="Notification",e.Search="Search",e.Pinned="Pinned"}(o||(o={}));const r=Object(i.createContext)({roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!1,numUnreadMessages:0,canPeek:!1,showApps:!1,isPeeking:!1,showRightPanel:!0,joining:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canSendMessages:!1,resizing:!1,layout:s.a.Group,lowBandwidth:!1,alwaysShowTimestamps:!1,showTwelveHourTimestamps:!1,readMarkerInViewThresholdMs:3e3,readMarkerOutOfViewThresholdMs:3e4,showHiddenEvents:!1,showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:!1,showUrlPreview:!1,timelineRenderingType:o.Room,threadId:void 0,liveTimeline:void 0,narrow:!1});r.displayName="RoomContext",t.b=r},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(89),c=n(101);class l extends r.a.Component{constructor(){super(...arguments),s()(this,"onClick",()=>{this.props.onFinished(!0)})}render(){return r.a.createElement(c.a,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:this.props.title||Object(a.a)("Error"),headerImage:this.props.headerImage,contentId:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description||Object(a.a)("An error has occurred.")),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{className:"mx_Dialog_primary",onClick:this.onClick,autoFocus:this.props.focus},this.props.button||Object(a.a)("OK"))))}}s()(l,"defaultProps",{focus:!0,title:null,description:null,button:null})},function(e,t,n){"use strict";n.d(t,"c",(function(){return f})),n.d(t,"b",(function(){return v}));var i=n(17),s=n.n(i),o=n(434),r=n(0),a=n(97),c=n(7),l=n(137),d=n(281),u=n(143),h=n(363);n.d(t,"a",(function(){return h.a}));const m={};function p(e){return m[e]||(m[e]=e),m[e]}const g=Object.freeze({visible:!0});let f;!function(e){e.Decrypted="Event.decrypted",e.BeforeRedaction="Event.beforeRedaction",e.VisibilityChange="Event.visibilityChange",e.LocalEventIdReplaced="Event.localEventIdReplaced",e.Status="Event.status",e.Replaced="Event.replaced",e.RelationsCreated="Event.relationsCreated"}(f||(f={}));class v extends u.b{constructor(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.event=t,s()(this,"pushActions",null),s()(this,"_replacingEvent",null),s()(this,"_localRedactionEvent",null),s()(this,"_isCancelled",!1),s()(this,"clearEvent",void 0),s()(this,"visibility",g),s()(this,"_hasCachedExtEv",!1),s()(this,"_cachedExtEv",void 0),s()(this,"senderCurve25519Key",null),s()(this,"claimedEd25519Key",null),s()(this,"forwardingCurve25519KeyChain",[]),s()(this,"untrusted",null),s()(this,"_decryptionPromise",null),s()(this,"retryDecryption",!1),s()(this,"txnId",null),s()(this,"thread",null),s()(this,"threadId",void 0),s()(this,"localTimestamp",void 0),s()(this,"sender",null),s()(this,"target",null),s()(this,"status",null),s()(this,"error",null),s()(this,"forwardLooking",!0),s()(this,"verificationRequest",null),s()(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(e=>{"string"==typeof t[e]&&(t[e]=p(t[e]))}),["membership","avatar_url","displayname"].forEach(e=>{var n;"string"==typeof(null===(n=t.content)||void 0===n?void 0:n[e])&&(t.content[e]=p(t.content[e]))}),["rel_type"].forEach(e=>{var n,i;"string"==typeof(null===(n=t.content)||void 0===n||null===(i=n["m.relates_to"])||void 0===i?void 0:i[e])&&(t.content["m.relates_to"][e]=p(t.content["m.relates_to"][e]))}),this.txnId=t.txn_id||null,this.localTimestamp=Date.now()-(null!==(e=this.getAge())&&void 0!==e?e:0),this.reEmitter=new d.a(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=o.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){const e=Object.assign({},this.getContent());if(this.getWireType()===a.b.RoomMessageEncrypted)for(const[t,n]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=n);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;const t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];return(null==t?void 0:t.rel_type)===l.c.name?t.event_id:(null===(n=this.getThread())||void 0===n?void 0:n.id)||this.threadId;var n}get isThreadRelation(){return!!this.threadRootId&&this.threadId!==this.getId()}get isThreadRoot(){var e;return!!this.getServerAggregatedRelation(l.c.name)||(null===(e=this.getThread())||void 0===e?void 0:e.id)===this.getId()}get replyEventId(){var e;const t=this.getContent()["m.relates_to"]||this.getWireContent()["m.relates_to"];return null==t||null===(e=t["m.in_reply_to"])||void 0===e?void 0:e.event_id}get relationEventId(){var e,t;return null===(e=this.getWireContent())||void 0===e||null===(t=e["m.relates_to"])||void 0===t?void 0:t.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}makeEncrypted(e,t,n,i){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=n,this.claimedEd25519Key=i}isBeingDecrypted(){return null!=this._decryptionPromise}getDecryptionPromise(){return this._decryptionPromise}isDecryptionFailure(){var e,t;return"m.bad.encrypted"===(null===(e=this.clearEvent)||void 0===e||null===(t=e.content)||void 0===t?void 0:t.msgtype)}shouldAttemptDecryption(){return!this.isRedacted()&&(!this.isBeingDecrypted()&&(!this.clearEvent&&!!this.isEncrypted()))}async attemptDecryption(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("boolean"==typeof t&&(t={isRetry:t}),!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");if(this.clearEvent&&!this.isDecryptionFailure())throw new Error("Attempt to decrypt event which has already been decrypted");return this._decryptionPromise?(r.a.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this._decryptionPromise):(this._decryptionPromise=this.decryptionLoop(e,t),this._decryptionPromise)}cancelAndResendKeyRequest(e,t){const n=this.getWireContent();return e.requestRoomKey({algorithm:n.algorithm,room_id:this.getRoomId(),session_id:n.session_id,sender_key:n.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){const t=this.getWireContent(),n=[{userId:e,deviceId:"*"}],i=this.getSender();return i!==e&&n.push({userId:i,deviceId:t.device_id}),n}async decryptionLoop(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(await Promise.resolve();;){let n,i;this.retryDecryption=!1;try{e?(n=await e.decryptEvent(this),!0===t.isRetry&&r.a.info(`Decrypted event on retry (id=${this.getId()})`)):n=this.badEncryptedMessage("Encryption not enabled")}catch(e){if("DecryptionError"!==e.name){const n=t.isRetry?"re":"";return r.a.error(`Error ${n}decrypting event (id=${this.getId()}): ${e.stack||e}`),this._decryptionPromise=null,void(this.retryDecryption=!1)}if(i=e,this.retryDecryption){r.a.log(`Got error decrypting event (id=${this.getId()}: `+e+"), but retrying");continue}r.a.warn(`Error decrypting event (id=${this.getId()}): ${e.detailedString}`),n=this.badEncryptedMessage(e.message)}return this._decryptionPromise=null,this.retryDecryption=!1,this.setClearData(n),this.setPushActions(null),void(!1!==t.emit&&this.emit(f.Decrypted,this,i))}}badEncryptedMessage(e){return{clearEvent:{type:a.b.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}}setClearData(e){this.clearEvent=e.clearEvent,this.senderCurve25519Key=e.senderCurve25519Key||null,this.claimedEd25519Key=e.claimedEd25519Key||null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===a.b.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return{ed25519:this.claimedEd25519Key}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(f.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){const t=!e||e.visible,n=e?e.reason:null;let i=!1;this.visibility.visible!==e.visible?i=!0:this.visibility.visible||this.visibility.reason===n||(i=!0),i&&(this.visibility=t?g:Object.freeze({visible:!1,reason:n}),this.emit(f.VisibilityChange,this,t))}messageVisibility(){return this.visibility}makeRedacted(e){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(f.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(const e in this.event)this.event.hasOwnProperty(e)&&!b.has(e)&&delete this.event[e];this.isEncrypted()&&(this.clearEvent=null);const t=y[this.getType()]||{},n=this.getContent();for(const e in n)n.hasOwnProperty(e)&&!t[e]&&delete n[e];this.invalidateExtensibleEvent()}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return this.getType()===a.b.RoomRedaction}asVisibilityChange(){if(!a.a.matches(this.getType()))return null;const e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;const t=e.event_id;if(!t)return null;const n=this.getWireContent(),i=!!n.visible,s=n.reason;return s&&"string"!=typeof s?null:{visible:i,reason:s,eventId:t}}isVisibilityEvent(){return a.a.matches(this.getType())}getRedactionEvent(){var e,t;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null===(t=this.clearEvent)||void 0===t?void 0:t.unsigned.redacted_because:this.event.unsigned.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushActions}setPushActions(e){this.pushActions=e}handleRemoteEcho(e){const t=this.getUnsigned(),n=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit(f.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(f.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(f.LocalEventIdReplaced,this)}isRelation(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;const n=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];return(!this.isState()||(null==n?void 0:n.rel_type)!==a.d.Replace)&&((null==n?void 0:n.rel_type)&&n.event_id&&(!t||n.rel_type===t))}getRelation(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit(f.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null===(t=this.getUnsigned()["m.relations"])||void 0===t?void 0:t[e]}replacingEventId(){const e=this.getServerAggregatedRelation(a.d.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){const e=this.getServerAggregatedRelation(a.d.Replace);if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssocation(){return!!this.getAssociatedId()}updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){const e=new v(JSON.parse(JSON.stringify(this.event)));for(const[t,n]of Object.entries(this))"event"!==t&&(e[t]=n);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;const t=Object(c.k)(this.event),n=Object(c.k)(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){const e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.thread=e,this.setThreadId(e.id),this.reEmitter.reEmit(e,[l.e.Update])}getThread(){return this.thread}setThreadId(e){this.threadId=e}}const b=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),y={[a.b.RoomMember]:{membership:1},[a.b.RoomCreate]:{creator:1},[a.b.RoomJoinRules]:{join_rule:1},[a.b.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},[a.b.RoomAliases]:{aliases:1}}},function(e,t,n){"use strict";n.d(t,"h",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"e",(function(){return c})),n.d(t,"a",(function(){return l})),n.d(t,"g",(function(){return d})),n.d(t,"b",(function(){return u})),n.d(t,"d",(function(){return h})),n.d(t,"i",(function(){return m})),n.d(t,"f",(function(){return p}));var i=n(89),s=n(192),o=n(607);let r,a;!function(e){e.SendMessage="KeyBinding.sendMessageInComposer",e.SelectPrevSendHistory="KeyBinding.previousMessageInComposerHistory",e.SelectNextSendHistory="KeyBinding.nextMessageInComposerHistory",e.EditPrevMessage="KeyBinding.editPreviousMessage",e.EditNextMessage="KeyBinding.editNextMessage",e.CancelReplyOrEdit="KeyBinding.cancelReplyInComposer",e.ShowStickerPicker="KeyBinding.showStickerPicker",e.FormatBold="KeyBinding.toggleBoldInComposer",e.FormatItalics="KeyBinding.toggleItalicsInComposer",e.FormatLink="KeyBinding.FormatLink",e.FormatCode="KeyBinding.FormatCode",e.FormatQuote="KeyBinding.toggleQuoteInComposer",e.EditUndo="KeyBinding.editUndoInComposer",e.EditRedo="KeyBinding.editRedoInComposer",e.NewLine="KeyBinding.newLineInComposer",e.MoveCursorToStart="KeyBinding.jumpToStartInComposer",e.MoveCursorToEnd="KeyBinding.jumpToEndInComposer",e.CompleteAutocomplete="KeyBinding.completeAutocomplete",e.ForceCompleteAutocomplete="KeyBinding.forceCompleteAutocomplete",e.PrevSelectionInAutocomplete="KeyBinding.previousOptionInAutoComplete",e.NextSelectionInAutocomplete="KeyBinding.nextOptionInAutoComplete",e.CancelAutocomplete="KeyBinding.cancelAutoComplete",e.ClearRoomFilter="KeyBinding.clearRoomFilter",e.PrevRoom="KeyBinding.downerRoom",e.NextRoom="KeyBinding.upperRoom",e.SelectRoomInRoomList="KeyBinding.selectRoomInRoomList",e.CollapseRoomListSection="KeyBinding.collapseSectionInRoomList",e.ExpandRoomListSection="KeyBinding.expandSectionInRoomList",e.ScrollUp="KeyBinding.scrollUpInTimeline",e.ScrollDown="KeyBinding.scrollDownInTimeline",e.DismissReadMarker="KeyBinding.dismissReadMarkerAndJumpToBottom",e.JumpToOldestUnread="KeyBinding.jumpToOldestUnreadMessage",e.UploadFile="KeyBinding.uploadFileToRoom",e.SearchInRoom="KeyBinding.searchInRoom",e.JumpToFirstMessage="KeyBinding.jumpToFirstMessageInTimeline",e.JumpToLatestMessage="KeyBinding.jumpToLastMessageInTimeline",e.FilterRooms="KeyBinding.filterRooms",e.ToggleSpacePanel="KeyBinding.toggleSpacePanel",e.ToggleRoomSidePanel="KeyBinding.toggleRightPanel",e.ToggleUserMenu="KeyBinding.toggleTopLeftMenu",e.ShowKeyboardSettings="KeyBinding.showKeyBindingsSettings",e.GoToHome="KeyBinding.goToHomeView",e.SelectPrevRoom="KeyBinding.previousRoom",e.SelectNextRoom="KeyBinding.nextRoom",e.SelectPrevUnreadRoom="KeyBinding.previousUnreadRoom",e.SelectNextUnreadRoom="KeyBinding.nextUnreadRoom",e.SwitchToSpaceByNumber="KeyBinding.switchToSpaceByNumber",e.OpenUserSettings="KeyBinding.openUserSettings",e.PreviousVisitedRoomOrSpace="KeyBinding.PreviousVisitedRoomOrSpace",e.NextVisitedRoomOrSpace="KeyBinding.NextVisitedRoomOrSpace",e.ToggleMicInCall="KeyBinding.toggleMicInCall",e.ToggleWebcamInCall="KeyBinding.toggleWebcamInCall",e.Escape="KeyBinding.escape",e.Enter="KeyBinding.enter",e.Space="KeyBinding.space",e.Backspace="KeyBinding.backspace",e.Delete="KeyBinding.delete",e.Home="KeyBinding.home",e.End="KeyBinding.end",e.ArrowLeft="KeyBinding.arrowLeft",e.ArrowUp="KeyBinding.arrowUp",e.ArrowRight="KeyBinding.arrowRight",e.ArrowDown="KeyBinding.arrowDown",e.Tab="KeyBinding.tab",e.Comma="KeyBinding.comma",e.ToggleHiddenEventVisibility="KeyBinding.toggleHiddenEventVisibility"}(r||(r={})),function(e){e.NAVIGATION="Navigation",e.ACCESSIBILITY="Accessibility",e.CALLS="Calls",e.COMPOSER="Composer",e.ROOM_LIST="Room List",e.ROOM="Room",e.AUTOCOMPLETE="Autocomplete",e.LABS="Labs"}(a||(a={}));const c="digits",l={[s.b.PAGE_UP]:Object(i.c)("Page Up"),[s.b.PAGE_DOWN]:Object(i.c)("Page Down"),[s.b.ESCAPE]:Object(i.c)("Esc"),[s.b.ENTER]:Object(i.c)("Enter"),[s.b.SPACE]:Object(i.c)("Space"),[s.b.HOME]:Object(i.c)("Home"),[s.b.END]:Object(i.c)("End"),[s.b.ALT]:Object(i.c)("Alt"),[s.b.CONTROL]:Object(i.c)("Ctrl"),[s.b.SHIFT]:Object(i.c)("Shift"),[c]:Object(i.c)("[number]")},d={[s.b.ARROW_UP]:"↑",[s.b.ARROW_DOWN]:"↓",[s.b.ARROW_LEFT]:"←",[s.b.ARROW_RIGHT]:"→"};s.a&&(d[s.b.META]="⌘",d[s.b.ALT]="⌥");const u={[a.COMPOSER]:{categoryLabel:Object(i.c)("Composer"),settingNames:[r.SendMessage,r.NewLine,r.FormatBold,r.FormatItalics,r.FormatQuote,r.FormatLink,r.FormatCode,r.EditUndo,r.EditRedo,r.MoveCursorToStart,r.MoveCursorToEnd,r.CancelReplyOrEdit,r.EditNextMessage,r.EditPrevMessage,r.SelectNextSendHistory,r.SelectPrevSendHistory,r.ShowStickerPicker]},[a.CALLS]:{categoryLabel:Object(i.c)("Calls"),settingNames:[r.ToggleMicInCall,r.ToggleWebcamInCall]},[a.ROOM]:{categoryLabel:Object(i.c)("Room"),settingNames:[r.SearchInRoom,r.UploadFile,r.DismissReadMarker,r.JumpToOldestUnread,r.ScrollUp,r.ScrollDown,r.JumpToFirstMessage,r.JumpToLatestMessage]},[a.ROOM_LIST]:{categoryLabel:Object(i.c)("Room List"),settingNames:[r.SelectRoomInRoomList,r.ClearRoomFilter,r.CollapseRoomListSection,r.ExpandRoomListSection,r.NextRoom,r.PrevRoom]},[a.ACCESSIBILITY]:{categoryLabel:Object(i.c)("Accessibility"),settingNames:[r.Escape,r.Enter,r.Space,r.Backspace,r.Delete,r.Home,r.End,r.ArrowLeft,r.ArrowUp,r.ArrowRight,r.ArrowDown,r.Comma]},[a.NAVIGATION]:{categoryLabel:Object(i.c)("Navigation"),settingNames:[r.ToggleUserMenu,r.ToggleRoomSidePanel,r.ToggleSpacePanel,r.ShowKeyboardSettings,r.GoToHome,r.FilterRooms,r.SelectNextUnreadRoom,r.SelectPrevUnreadRoom,r.SelectNextRoom,r.SelectPrevRoom,r.OpenUserSettings,r.SwitchToSpaceByNumber,r.PreviousVisitedRoomOrSpace,r.NextVisitedRoomOrSpace]},[a.AUTOCOMPLETE]:{categoryLabel:Object(i.c)("Autocomplete"),settingNames:[r.CancelAutocomplete,r.NextSelectionInAutocomplete,r.PrevSelectionInAutocomplete,r.CompleteAutocomplete,r.ForceCompleteAutocomplete]},[a.LABS]:{categoryLabel:Object(i.c)("Labs"),settingNames:[r.ToggleHiddenEventVisibility]}},h=[r.OpenUserSettings,r.SwitchToSpaceByNumber,r.PreviousVisitedRoomOrSpace,r.NextVisitedRoomOrSpace],m=[r.OpenUserSettings],p={[r.FormatBold]:{default:{ctrlOrCmdKey:!0,key:s.b.B},displayName:Object(i.c)("Toggle Bold")},[r.FormatItalics]:{default:{ctrlOrCmdKey:!0,key:s.b.I},displayName:Object(i.c)("Toggle Italics")},[r.FormatQuote]:{default:{ctrlOrCmdKey:!0,key:s.b.GREATER_THAN},displayName:Object(i.c)("Toggle Quote")},[r.FormatCode]:{default:{ctrlOrCmdKey:!0,key:s.b.E},displayName:Object(i.c)("Toggle Code Block")},[r.FormatLink]:{default:{ctrlOrCmdKey:!0,shiftKey:!0,key:s.b.L},displayName:Object(i.c)("Toggle Link")},[r.CancelReplyOrEdit]:{default:{key:s.b.ESCAPE},displayName:Object(i.c)("Cancel replying to a message")},[r.EditNextMessage]:{default:{key:s.b.ARROW_DOWN},displayName:Object(i.c)("Navigate to next message to edit")},[r.EditPrevMessage]:{default:{key:s.b.ARROW_UP},displayName:Object(i.c)("Navigate to previous message to edit")},[r.MoveCursorToStart]:{default:{ctrlOrCmdKey:!0,key:s.b.HOME},displayName:Object(i.c)("Jump to start of the composer")},[r.MoveCursorToEnd]:{default:{ctrlOrCmdKey:!0,key:s.b.END},displayName:Object(i.c)("Jump to end of the composer")},[r.SelectNextSendHistory]:{default:{altKey:!0,ctrlKey:!0,key:s.b.ARROW_DOWN},displayName:Object(i.c)("Navigate to next message in composer history")},[r.SelectPrevSendHistory]:{default:{altKey:!0,ctrlKey:!0,key:s.b.ARROW_UP},displayName:Object(i.c)("Navigate to previous message in composer history")},[r.ShowStickerPicker]:{default:{ctrlOrCmdKey:!0,key:s.b.SEMICOLON},displayName:Object(i.c)("Send a sticker")},[r.ToggleMicInCall]:{default:{ctrlOrCmdKey:!0,key:s.b.D},displayName:Object(i.c)("Toggle microphone mute")},[r.ToggleWebcamInCall]:{default:{ctrlOrCmdKey:!0,key:s.b.E},displayName:Object(i.c)("Toggle webcam on/off")},[r.DismissReadMarker]:{default:{key:s.b.ESCAPE},displayName:Object(i.c)("Dismiss read marker and jump to bottom")},[r.JumpToOldestUnread]:{default:{shiftKey:!0,key:s.b.PAGE_UP},displayName:Object(i.c)("Jump to oldest unread message")},[r.UploadFile]:{default:{ctrlOrCmdKey:!0,shiftKey:!0,key:s.b.U},displayName:Object(i.c)("Upload a file")},[r.ScrollUp]:{default:{key:s.b.PAGE_UP},displayName:Object(i.c)("Scroll up in the timeline")},[r.ScrollDown]:{default:{key:s.b.PAGE_DOWN},displayName:Object(i.c)("Scroll down in the timeline")},[r.FilterRooms]:{default:{ctrlOrCmdKey:!0,key:s.b.K},displayName:Object(i.c)("Jump to room search")},[r.SelectRoomInRoomList]:{default:{key:s.b.ENTER},displayName:Object(i.c)("Select room from the room list")},[r.CollapseRoomListSection]:{default:{key:s.b.ARROW_LEFT},displayName:Object(i.c)("Collapse room list section")},[r.ExpandRoomListSection]:{default:{key:s.b.ARROW_RIGHT},displayName:Object(i.c)("Expand room list section")},[r.ClearRoomFilter]:{default:{key:s.b.ESCAPE},displayName:Object(i.c)("Clear room list filter field"),controller:new o.a("feature_spotlight",{key:null})},[r.NextRoom]:{default:{key:s.b.ARROW_DOWN},displayName:Object(i.c)("Navigate down in the room list")},[r.PrevRoom]:{default:{key:s.b.ARROW_UP},displayName:Object(i.c)("Navigate up in the room list")},[r.ToggleUserMenu]:{default:{ctrlOrCmdKey:!0,key:s.b.BACKTICK},displayName:Object(i.c)("Toggle the top left menu")},[r.ToggleRoomSidePanel]:{default:{ctrlOrCmdKey:!0,key:s.b.PERIOD},displayName:Object(i.c)("Toggle right panel")},[r.ShowKeyboardSettings]:{default:{ctrlOrCmdKey:!0,key:s.b.SLASH},displayName:Object(i.c)("Open this settings tab")},[r.GoToHome]:{default:{ctrlOrCmdKey:!0,altKey:!s.a,shiftKey:s.a,key:s.b.H},displayName:Object(i.c)("Go to Home View")},[r.SelectNextUnreadRoom]:{default:{shiftKey:!0,altKey:!0,key:s.b.ARROW_DOWN},displayName:Object(i.c)("Next unread room or DM")},[r.SelectPrevUnreadRoom]:{default:{shiftKey:!0,altKey:!0,key:s.b.ARROW_UP},displayName:Object(i.c)("Previous unread room or DM")},[r.SelectNextRoom]:{default:{altKey:!0,key:s.b.ARROW_DOWN},displayName:Object(i.c)("Next room or DM")},[r.SelectPrevRoom]:{default:{altKey:!0,key:s.b.ARROW_UP},displayName:Object(i.c)("Previous room or DM")},[r.CancelAutocomplete]:{default:{key:s.b.ESCAPE},displayName:Object(i.c)("Cancel autocomplete")},[r.NextSelectionInAutocomplete]:{default:{key:s.b.ARROW_DOWN},displayName:Object(i.c)("Next autocomplete suggestion")},[r.PrevSelectionInAutocomplete]:{default:{key:s.b.ARROW_UP},displayName:Object(i.c)("Previous autocomplete suggestion")},[r.ToggleSpacePanel]:{default:{ctrlOrCmdKey:!0,shiftKey:!0,key:s.b.D},displayName:Object(i.c)("Toggle space panel")},[r.ToggleHiddenEventVisibility]:{default:{ctrlOrCmdKey:!0,shiftKey:!0,key:s.b.H},displayName:Object(i.c)("Toggle hidden event visibility")},[r.JumpToFirstMessage]:{default:{key:s.b.HOME,ctrlKey:!0},displayName:Object(i.c)("Jump to first message")},[r.JumpToLatestMessage]:{default:{key:s.b.END,ctrlKey:!0},displayName:Object(i.c)("Jump to last message")},[r.EditUndo]:{default:{key:s.b.Z,ctrlOrCmdKey:!0},displayName:Object(i.c)("Undo edit")},[r.EditRedo]:{default:{key:s.a?s.b.Z:s.b.Y,ctrlOrCmdKey:!0,shiftKey:s.a},displayName:Object(i.c)("Redo edit")},[r.PreviousVisitedRoomOrSpace]:{default:{metaKey:s.a,altKey:!s.a,key:s.a?s.b.SQUARE_BRACKET_LEFT:s.b.ARROW_LEFT},displayName:Object(i.c)("Previous recently visited room or space")},[r.NextVisitedRoomOrSpace]:{default:{metaKey:s.a,altKey:!s.a,key:s.a?s.b.SQUARE_BRACKET_RIGHT:s.b.ARROW_RIGHT},displayName:Object(i.c)("Next recently visited room or space")},[r.SwitchToSpaceByNumber]:{default:{ctrlOrCmdKey:!0,key:c},displayName:Object(i.c)("Switch to space by number")},[r.OpenUserSettings]:{default:{metaKey:!0,key:s.b.COMMA},displayName:Object(i.c)("Open user settings")},[r.Escape]:{default:{key:s.b.ESCAPE},displayName:Object(i.c)("Close dialog or context menu")},[r.Enter]:{default:{key:s.b.ENTER},displayName:Object(i.c)("Activate selected button")},[r.Space]:{default:{key:s.b.SPACE}},[r.Backspace]:{default:{key:s.b.BACKSPACE}},[r.Delete]:{default:{key:s.b.DELETE}},[r.Home]:{default:{key:s.b.HOME}},[r.End]:{default:{key:s.b.END}},[r.ArrowLeft]:{default:{key:s.b.ARROW_LEFT}},[r.ArrowUp]:{default:{key:s.b.ARROW_UP}},[r.ArrowRight]:{default:{key:s.b.ARROW_RIGHT}},[r.ArrowDown]:{default:{key:s.b.ARROW_DOWN}},[r.Comma]:{default:{key:s.b.COMMA}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(89);class c extends r.a.Component{constructor(){super(...arguments),s()(this,"onCancelClick",e=>{this.props.onCancel(e)})}render(){let e,t="mx_Dialog_primary";this.props.primaryButtonClass&&(t+=" "+this.props.primaryButtonClass),(this.props.cancelButton||this.props.hasCancel)&&(e=r.a.createElement("button",{"data-test-id":"dialog-cancel-button",type:"button",onClick:this.onCancelClick,className:this.props.cancelButtonClass,disabled:this.props.disabled},this.props.cancelButton||Object(a.a)("Cancel")));let n=null;return this.props.additive&&(n=r.a.createElement("div",{className:"mx_Dialog_buttons_additive"},this.props.additive)),r.a.createElement("div",{className:"mx_Dialog_buttons"},n,r.a.createElement("span",{className:"mx_Dialog_buttons_row"},e,this.props.children,r.a.createElement("button",{type:this.props.primaryIsSubmit?"submit":"button","data-test-id":"dialog-primary-button",className:t,onClick:this.props.onPrimaryButtonClick,autoFocus:this.props.focus,disabled:this.props.disabled||this.props.primaryDisabled},this.props.primaryButton)))}}s()(c,"defaultProps",{hasCancel:!0,disabled:!1})},,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return T})),n.d(t,"o",(function(){return j})),n.d(t,"p",(function(){return N})),n.d(t,"j",(function(){return P})),n.d(t,"k",(function(){return D})),n.d(t,"l",(function(){return A})),n.d(t,"m",(function(){return M})),n.d(t,"q",(function(){return U})),n.d(t,"n",(function(){return L}));var i=n(99),s=n.n(i),o=n(88),r=n.n(o),a=n(87),c=n.n(a),l=n(150),d=n.n(l),u=n(94),h=n.n(u),m=n(376),p=n.n(m),g=n(147),f=n(134),v=n(109),b=n(114),y=n(488);n.d(t,"b",(function(){return y.a}));var S=n(334);n.d(t,"c",(function(){return S.a}));var E=n(692);n.d(t,"d",(function(){return E.a}));var w=n(693);n.d(t,"e",(function(){return w.a}));var _=n(694);n.d(t,"f",(function(){return _.a}));var C=n(695);n.d(t,"g",(function(){return C.a}));var O=n(696);n.d(t,"h",(function(){return O.a}));var R=n(697);function I(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?I(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}n.d(t,"i",(function(){return R.a}));function x(){let e=document.getElementById("mx_ContextualMenu_Container");return e||(e=document.createElement("div"),e.id="mx_ContextualMenu_Container",document.body.appendChild(e)),e}let T;!function(e){e.Top="top",e.Bottom="bottom",e.Left="left",e.Right="right",e.None="none"}(T||(T={}));class j extends c.a.PureComponent{constructor(t,n){super(t,n),r()(this,"initialFocus",void 0),r()(this,"collectContextMenuRect",e=>{if(!e)return;const t=e.querySelector('[role^="menuitem"]')||e.querySelector("[tab-index]");t&&t.focus(),this.setState({contextMenuElem:e})}),r()(this,"onContextMenu",t=>{if(this.props.onFinished){this.props.onFinished(),t.preventDefault(),t.stopPropagation();const n=t.clientX,i=t.clientY;e(()=>{const e=new MouseEvent("contextmenu",{clientX:n,clientY:i,screenX:0,screenY:0,button:0,relatedTarget:null});document.elementFromPoint(n,i).dispatchEvent(e)})}}),r()(this,"onContextMenuPreventBubbling",e=>{e.stopPropagation()}),r()(this,"onFinished",e=>{e.stopPropagation(),e.preventDefault(),this.props.onFinished&&this.props.onFinished()}),r()(this,"onClick",e=>{e.stopPropagation()}),r()(this,"onKeyDown",e=>{e.stopPropagation();const t=Object(b.a)().getAccessibilityAction(e);this.props.managed?Object(f.g)(e.target)&&t!==v.h.Escape||[v.h.Escape,v.h.Tab,v.h.ArrowLeft,v.h.ArrowRight].includes(t)&&this.props.onFinished():t===v.h.Escape&&this.props.onFinished()}),this.state={contextMenuElem:null},this.initialFocus=document.activeElement}componentWillUnmount(){this.initialFocus.focus()}renderMenu(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.props.hasBackground;const t={},n=this.props;let i;n.top?t.top=n.top:t.bottom=n.bottom,n.left?(t.left=n.left,i=T.Left):(t.right=n.right,i=T.Right);const s=this.state.contextMenuElem?this.state.contextMenuElem.getBoundingClientRect():null,o={};n.chevronFace&&(i=n.chevronFace);const r=i&&i!==T.None;i===T.Top||i===T.Bottom?o.left=n.chevronOffset:o.top=n.chevronOffset;const{windowWidth:a,windowHeight:l}=g.b.instance;if(s){if(void 0!==t.top){let e=l-10;this.props.bottomAligned||(e-=s.height),t.top=Math.min(t.top,e),void 0!==o.top&&(o.top=n.chevronOffset+n.top-t.top)}else void 0!==t.bottom&&(t.bottom=Math.min(t.bottom,l-s.height-10),void 0!==o.top&&(o.top=n.chevronOffset+t.bottom-n.bottom));if(void 0!==t.left){let e=a-10;this.props.rightAligned||(e-=s.width),t.left=Math.min(t.left,e),void 0!==o.left&&(o.left=n.chevronOffset+n.left-t.left)}else void 0!==t.right&&(t.right=Math.min(t.right,a-s.width-10),void 0!==o.left&&(o.left=n.chevronOffset+t.right-n.right))}let d;r&&(d=c.a.createElement("div",{style:o,className:"mx_ContextualMenu_chevron_"+i}));const u=h()({mx_ContextualMenu:!0,mx_ContextualMenu_left:!r&&void 0!==t.left&&!t.right,mx_ContextualMenu_right:!r&&void 0!==t.right&&!t.left,mx_ContextualMenu_top:!r&&void 0!==t.top&&!t.bottom,mx_ContextualMenu_bottom:!r&&void 0!==t.bottom&&!t.top,mx_ContextualMenu_withChevron_left:i===T.Left,mx_ContextualMenu_withChevron_right:i===T.Right,mx_ContextualMenu_withChevron_top:i===T.Top,mx_ContextualMenu_withChevron_bottom:i===T.Bottom,mx_ContextualMenu_rightAligned:!0===this.props.rightAligned,mx_ContextualMenu_bottomAligned:!0===this.props.bottomAligned},this.props.menuClassName),m={};n.menuWidth&&(m.width=n.menuWidth),n.menuHeight&&(m.height=n.menuHeight),isNaN(Number(n.menuPaddingTop))||(m.paddingTop=n.menuPaddingTop),isNaN(Number(n.menuPaddingLeft))||(m.paddingLeft=n.menuPaddingLeft),isNaN(Number(n.menuPaddingBottom))||(m.paddingBottom=n.menuPaddingBottom),isNaN(Number(n.menuPaddingRight))||(m.paddingRight=n.menuPaddingRight);const v={};let b;isNaN(Number(n.zIndex))||(m.zIndex=n.zIndex+1,v.zIndex=n.zIndex),e&&(b=c.a.createElement("div",{className:"mx_ContextualMenu_background",style:v,onClick:this.onFinished,onContextMenu:this.onContextMenu}));let y=c.a.createElement(c.a.Fragment,null,d,n.children);return n.focusLock&&(y=c.a.createElement(p.a,null,y)),c.a.createElement(f.d,{handleHomeEnd:!0,handleUpDown:!0,onKeyDown:this.onKeyDown},e=>{let{onKeyDownHandler:n}=e;return c.a.createElement("div",{className:h()("mx_ContextualMenu_wrapper",this.props.wrapperClassName),style:k(k({},t),v),onClick:this.onClick,onKeyDown:n,onContextMenu:this.onContextMenuPreventBubbling},b,c.a.createElement("div",{className:u,style:m,ref:this.collectContextMenuRect,role:this.props.managed?"menu":void 0},y))})}render(){return this.props.mountAsChild?this.renderMenu():d.a.createPortal(this.renderMenu(),x())}}r()(j,"defaultProps",{hasBackground:!0,managed:!0});const N=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12;const n=e.right+window.scrollX+3;let i=e.top+e.height/2+window.scrollY;return i-=t+8,{left:n,top:i,chevronOffset:t}},P=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:T.None,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i={chevronFace:t},s=e.right+window.scrollX,o=e.bottom+window.scrollY,r=e.top+window.scrollY;return i.right=g.b.instance.windowWidth-s,o<g.b.instance.windowHeight/2?i.top=o+n:i.bottom=g.b.instance.windowHeight-r+n,i},D=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:T.None,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i={chevronFace:t},s=e.left+window.scrollX,o=e.bottom+window.scrollY,r=e.top+window.scrollY;return i.left=s,o<g.b.instance.windowHeight/2?i.top=o+n:i.bottom=g.b.instance.windowHeight-r+n,i},A=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:T.None,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i={chevronFace:t},s=e.right+window.scrollX,o=e.bottom+window.scrollY,r=e.top+window.scrollY;return i.right=g.b.instance.windowWidth-s,o<g.b.instance.windowHeight/2?i.top=o+n:i.bottom=g.b.instance.windowHeight-r+n,i},M=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:T.None,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i={chevronFace:t},s=e.left+window.scrollX,o=e.top+window.scrollY;return i.left=s,i.bottom=g.b.instance.windowHeight-o+n,i},U=()=>{const e=Object(a.useRef)(null),[t,n]=Object(a.useState)(!1);return[t,e,e=>{null==e||e.preventDefault(),null==e||e.stopPropagation(),n(!0)},e=>{null==e||e.preventDefault(),null==e||e.stopPropagation(),n(!1)},n]};function L(e,t){const n=function(){var e;d.a.unmountComponentAtNode(x());for(var n=arguments.length,i=new Array(n),s=0;s<n;s++)i[s]=arguments[s];null==t||null===(e=t.onFinished)||void 0===e||e.apply(null,i)},i=c.a.createElement(j,s()({},t,{mountAsChild:!0,hasBackground:!1,onFinished:n,windowResize:n}),c.a.createElement(e,s()({},t,{onFinished:n})));return d.a.render(i,x()),{close:n}}}).call(this,n(179).setImmediate)},function(e,t,n){"use strict";n.d(t,"a",(function(){return O})),n.d(t,"c",(function(){return R})),n.d(t,"b",(function(){return I}));var i=n(17),s=n.n(i),o=n(314),r=n(144),a=n(312),c=n(7),l=n(108),d=n(363),u=n(151),h=n(438),m=n(0),p=n(281),g=n(97),f=n(119),v=n(273),b=n(137),y=n(143),S=n(285);function E(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function w(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?E(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):E(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const _=["1","2","3","4","5","6","7","8","9"];function C(e,t,n){return new l.b({content:{[t.getId()]:{[n]:{[e]:{ts:t.getTs()}}}},type:"m.receipt",room_id:t.getRoomId()})}let O,R;!function(e){e.Highlight="highlight",e.Total="total"}(O||(O={})),function(e){e.MyMembership="Room.myMembership",e.Tags="Room.tags",e.AccountData="Room.accountData",e.Receipt="Room.receipt",e.Name="Room.name",e.Redaction="Room.redaction",e.RedactionCancelled="Room.redactionCancelled",e.LocalEchoUpdated="Room.localEchoUpdated",e.Timeline="Room.timeline",e.TimelineReset="Room.timelineReset"}(R||(R={}));class I extends y.b{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(super(),this.roomId=e,this.client=t,this.myUserId=n,this.opts=i,s()(this,"reEmitter",void 0),s()(this,"txnToEvent",{}),s()(this,"receipts",{}),s()(this,"receiptCacheByEventId",{}),s()(this,"notificationCounts",{}),s()(this,"timelineSets",void 0),s()(this,"threadsTimelineSets",[]),s()(this,"filteredTimelineSets",{}),s()(this,"pendingEventList",void 0),s()(this,"blacklistUnverifiedDevices",null),s()(this,"selfMembership",null),s()(this,"summaryHeroes",null),s()(this,"getTypeWarning",!1),s()(this,"getVersionWarning",!1),s()(this,"membersPromise",void 0),s()(this,"name",void 0),s()(this,"normalizedName",void 0),s()(this,"tags",{}),s()(this,"accountData",{}),s()(this,"summary",null),s()(this,"storageToken",void 0),s()(this,"timeline",void 0),s()(this,"oldState",void 0),s()(this,"currentState",void 0),s()(this,"threads",new Map),s()(this,"lastThread",void 0),s()(this,"visibilityEvents",new Map),s()(this,"threadTimelineSetsPromise",null),s()(this,"threadsReady",!1),s()(this,"applyRedaction",e=>{if(e.isRedaction()){const t=e.event.redacts,n=this.findEventById(t);if(n){if(n.makeRedacted(e),n.isState()){this.currentState.getStateEvents(n.getType(),n.getStateKey()).getId()===n.getId()&&this.currentState.setStateEvents([n])}this.emit(R.Redaction,e,this),this.visibilityEvents.delete(t),n.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}}}),this.setMaxListeners(100),this.reEmitter=new p.a(this),i.pendingEventOrdering=i.pendingEventOrdering||f.d.Chronological,this.name=e,this.timelineSets=[new o.b(this,i)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[R.Timeline,R.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===f.d.Detached){this.pendingEventList=[];const e=t.sessionStore.store.getItem(k(this.roomId));e&&JSON.parse(e).forEach(async e=>{const t=new l.b(e);t.getType()===g.b.RoomMessageEncrypted&&await t.attemptDecryption(this.client.crypto),t.setStatus(d.a.NOT_SENT),this.addPendingEvent(t,t.getTxnId())})}this.opts.lazyLoadMembers?this.membersPromise=null:this.membersPromise=Promise.resolve(!1)}async createThreadsTimelineSets(){var e;if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if(null!==(e=this.client)&&void 0!==e&&e.supportsExperimentalThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(b.f.My)]);const e=await this.threadTimelineSetsPromise;this.threadsTimelineSets.push(...e)}catch(e){this.threadTimelineSetsPromise=null}}decryptCriticalEvents(){const e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),n=t.findIndex(t=>t.event.event_id===e),i=t.slice(n).filter(e=>e.shouldAttemptDecryption()).reverse().map(e=>e.attemptDecryption(this.client.crypto,{isRetry:!0}));return Promise.allSettled(i)}decryptAllEvents(){const e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().filter(e=>e.shouldAttemptDecryption()).reverse().map(e=>e.attemptDecryption(this.client.crypto,{isRetry:!0}));return Promise.allSettled(e)}getVersion(){const e=this.currentState.getStateEvents(g.b.RoomCreate,"");if(!e)return this.getVersionWarning||(m.a.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1";const t=e.getContent().room_version;return void 0===t?"1":t}shouldUpgradeToVersion(){return _.includes(this.getVersion())?null:"9"}async getRecommendedVersion(){let e=(await this.client.getCapabilities())["m.room_versions"];if(!e){e={default:"9",available:{}};for(const t of _)e.available[t]=f.e.Stable}let t=this.checkVersionAgainstCapability(e);if(t.urgent&&t.needsUpgrade){m.a.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");if(e=(await this.client.getCapabilities(!0))["m.room_versions"],!e)return m.a.warn("No room version capability - assuming upgrade required."),t;t=this.checkVersionAgainstCapability(e)}return t}checkVersionAgainstCapability(e){const t=this.getVersion();m.a.log(`[${this.roomId}] Current version: ${t}`),m.a.log(`[${this.roomId}] Version capability: `,e);const n={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return n;return Object.keys(e.available).filter(t=>"stable"===e.available[t]).includes(t)||(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?m.a.warn("URGENT upgrade required on "+this.roomId):m.a.warn("Non-urgent upgrade required on "+this.roomId)),n}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(g.b.RoomTombstone,e)}getPendingEvents(){if(this.opts.pendingEventOrdering!==f.d.Detached)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(this.opts.pendingEventOrdering!==f.d.Detached)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const t=c.D(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){return this.opts.pendingEventOrdering===f.d.Detached&&this.pendingEventList.some(t=>t.getId()===e)}getPendingEvent(e){return this.opts.pendingEventOrdering!==f.d.Detached?null:this.pendingEventList.find(t=>t.getId()===e)}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}getLastActiveTimestamp(){const e=this.getLiveTimeline().getEvents();if(e.length){return e[e.length-1].getTs()}return Number.MIN_SAFE_INTEGER}getMyMembership(){return this.selfMembership}getDMInviter(){if(this.myUserId){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this.selfMembership){if(2==this.getInvitedAndJoinedMemberCount()&&this.summaryHeroes.length)return this.summaryHeroes[0]}}guessDMUserId(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];const t=this.currentState.getMembers().find(e=>e.userId!==this.myUserId);return t?t.userId:this.myUserId}getAvatarFallbackMember(){if(this.getInvitedAndJoinedMemberCount()>2)return;const e=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(e){const e=this.summaryHeroes.map(e=>this.getMember(e)).find(e=>!!e);if(e)return e}const t=this.currentState.getMembers();if(t.length<=2){const e=t.find(e=>e.userId!==this.myUserId);if(e)return e}if(e){const e=this.summaryHeroes.map(e=>this.client.getUser(e)).find(e=>!!e);if(e){const t=new u.a(this.roomId,e.userId);return t.user=e,t}}}updateMyMembership(e){const t=this.selfMembership;this.selfMembership=e,t!==e&&("leave"===e&&this.cleanupAfterLeaving(),this.emit(R.MyMembership,this,e,t))}async loadMembersFromServer(){const e=this.client.store.getSyncToken();return(await this.client.members(this.roomId,void 0,"leave",e)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);(null===t||this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId))&&(e=!0,t=await this.loadMembersFromServer(),m.a.log(`LL: got ${t.length} members from server for room `+this.roomId));return{memberEvents:t.map(this.client.getEventMapper()),fromServer:e}}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this.loadMembers().then(e=>(this.currentState.setOutOfBandMembers(e.memberEvents),this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId)&&this.client.crypto.trackRoomDevices(this.roomId),e.fromServer)).catch(e=>{throw this.membersPromise=null,this.currentState.markOutOfBandMembersFailed(),e});return e.then(e=>{if(e){const e=this.currentState.getMembers().filter(e=>e.isOutOfBand()).map(e=>e.events.member.event);m.a.log("LL: telling store to write "+e.length+" members for room "+this.roomId);return this.client.store.setOutOfBandMembers(this.roomId,e).catch(e=>{m.a.log("LL: storing OOB room members failed, oh well",e)})}}).catch(e=>{m.a.error(e)}),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=null)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{m.a.error(`error after clearing loaded members from room ${this.roomId} after leaving`),m.a.log(e)})}resetLiveTimeline(e,t){for(let n=0;n<this.timelineSets.length;n++)this.timelineSets[n].resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(r.b.BACKWARDS),this.currentState=this.getLiveTimeline().getState(r.b.FORWARDS)}async hasUnverifiedDevices(){if(!this.client.isRoomEncrypted(this.roomId))return!1;const e=await this.getEncryptionTargetMembers();for(const t of e){if(this.client.getStoredDevicesForUser(t.userId).some(e=>e.isUnverified()))return!0}return!1}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){const t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getLiveTimeline():this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(!t){const n=this.getThreads();for(let i=0;i<n.length;i++){if(t=n[i].findEventById(e),t)return t}}return t}getUnreadNotificationCount(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:O.Total;return this.notificationCounts[e]}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t}setSummary(e){const t=e["m.heroes"],n=e["m.joined_member_count"],i=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(i)&&this.currentState.setInvitedMemberCount(i),Array.isArray(t)&&(this.summaryHeroes=t.filter(e=>e!==this.myUserId))}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices}getAvatarUrl(e,t,n,i){let s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];const o=this.currentState.getStateEvents(g.b.RoomAvatar,"");if(!o&&!s)return null;const r=o?o.getContent().url:null;return r?Object(a.a)(e,r,t,n,i):null}getMxcAvatarUrl(){var e,t;return(null===(e=this.currentState.getStateEvents(g.b.RoomAvatar,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.url)||null}getAliases(){const e=[],t=this.currentState.getStateEvents(g.b.RoomAliases);if(t)for(const n of t)if(Array.isArray(n.getContent().aliases)){const t=n.getContent().aliases.filter(e=>"string"==typeof e&&("#"===e[0]&&!!e.endsWith(":"+n.getStateKey())));e.push(...t)}return e}getCanonicalAlias(){const e=this.currentState.getStateEvents(g.b.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){const e=this.currentState.getStateEvents(g.b.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,n,i){n.getTimelineSet().addEventsToTimeline(e,t,n,i)}getThread(e){return this.threads.get(e)}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e}shouldEncryptForInvitedMembers(){var e;const t=this.currentState.getStateEvents(g.b.RoomHistoryVisibility,"");return"joined"!==(null==t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){const n=this.getMember(e);return!!n&&n.membership===t}getOrCreateFilteredTimelineSet(e){let{prepopulateTimeline:t=!0,useSyncEvents:n=!0,pendingEvents:i=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];const s=Object.assign({filter:e,pendingEvents:i},this.opts),a=new o.b(this,s);this.reEmitter.reEmit(a,[R.Timeline,R.TimelineReset]),n&&(this.filteredTimelineSets[e.filterId]=a,this.timelineSets.push(a));const c=this.getLiveTimeline();if(t){c.getEvents().forEach((function(e){a.addLiveEvent(e)}));let e=c;for(;e.getNeighbouringTimeline(r.b.BACKWARDS);)e=e.getNeighbouringTimeline(r.b.BACKWARDS);a.getLiveTimeline().setPaginationToken(e.getPaginationToken(r.b.BACKWARDS),r.b.BACKWARDS)}else if(n){const e=c.getPaginationToken(r.a.Forward);a.getLiveTimeline().setPaginationToken(e,r.a.Backward)}return a}async getThreadListFilter(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:b.f.All;const t=this.client.getUserId(),n=new v.a(t),i={room:{timeline:{[b.a.name]:[b.c.name]}}};e===b.f.My&&(i.room.timeline[b.b.name]=[t]),n.setDefinition(i);const s=await this.client.getOrCreateFilter(`THREAD_PANEL_${this.roomId}_${e}`,n);return n.filterId=s,n}async createThreadTimelineSet(e){let t;if(b.d.hasServerSideSupport){const n=await this.getThreadListFilter(e);t=this.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else t=new o.b(this,{pendingEvents:!1}),Array.from(this.threads).forEach(n=>{let[,i]=n;if(0===i.length)return;const s=i.events.some(e=>e.getSender()===this.client.getUserId());(e!==b.f.My||s)&&t.getLiveTimeline().addEvent(i.rootEvent,!1)});return t}async fetchRoomThreads(){if(this.threadsReady||!this.client.supportsExperimentalThreads())return;const e=await this.getThreadListFilter(),{chunk:t}=await this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,r.a.Backward,e);if(!t.length)return;const n=t.map(this.client.getEventMapper()).sort((e,t)=>{const n=e.getServerAggregatedRelation(g.d.Thread),i=t.getServerAggregatedRelation(g.d.Thread);return n.latest_event.origin_server_ts-i.latest_event.origin_server_ts});let i;const s=this.getLiveTimeline().getState(r.b.FORWARDS);for(const e of n){this.threadsTimelineSets[0].addLiveEvent(e,o.a.Ignore,!1,s);e.getServerAggregatedRelation(g.d.Thread).current_user_participated&&(this.threadsTimelineSets[1].addLiveEvent(e,o.a.Ignore,!1,s),i=e),this.getThread(e.getId())||this.createThread(e.getId(),e,[],!0)}this.client.decryptEventIfNeeded(n[n.length-1]),i&&this.client.decryptEventIfNeeded(i),this.threadsReady=!0,this.on(b.e.NewReply,this.onThreadNewReply)}onThreadNewReply(e){for(const t of this.threadsTimelineSets)t.removeEvent(e.id),t.addLiveEvent(e.rootEvent)}removeFilteredTimelineSet(e){const t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];const n=this.timelineSets.indexOf(t);n>-1&&this.timelineSets.splice(n,1)}eventShouldLiveIn(e,t,n){var i;if(!this.client.supportsExperimentalThreads())return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!=n&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};if(e.isThreadRelation)return{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:e.threadRootId};const s=e.getAssociatedId(),o=null!==(i=this.findEventById(s))&&void 0!==i?i:null==t?void 0:t.find(e=>e.getId()===s);return o&&(e.isRelation()||e.isRedaction())?this.eventShouldLiveIn(o,t,n):null!=n&&n.has(e.relationEventId)?{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.relationEventId}:{shouldLiveInRoom:!0,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;const{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.getThread(e);if(i)i.addEvents(t,n);else{var s;const o=null!==(s=this.findEventById(e))&&void 0!==s?s:t.find(t=>t.getId()===e);i=this.createThread(e,o,t,n),this.emit(b.e.Update,i)}}processThreadedEvents(e,t){e.forEach(this.applyRedaction);const n={};for(const t of e){var i;const{threadId:e,shouldLiveInThread:s}=this.eventShouldLiveIn(t);s&&!n[e]&&(n[e]=[]),null===(i=n[e])||void 0===i||i.push(t)}Object.entries(n).map(e=>{let[n,i]=e;return this.addThreadedEvents(n,i,t)})}createThread(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3?arguments[3]:void 0;if(t){const e=this.getTimelineForEvent(t.getId()),n=null==e?void 0:e.getTimelineSet().getAllRelationsEventForEvent(t.getId());null!=n&&n.length&&(i=i.concat(n.filter(e=>!e.isRelation(g.d.Replace))))}const o=new b.d(e,t,{initialEvents:i,room:this,client:this.client});return this.threads.set(o.id,o),this.reEmitter.reEmit(o,[b.e.Update,b.e.NewReply,R.Timeline,R.TimelineReset]),(!this.lastThread||(null===(n=this.lastThread.rootEvent)||void 0===n?void 0:n.localTimestamp)<(null==t?void 0:t.localTimestamp))&&(this.lastThread=o),this.emit(b.e.New,o,s),this.threadsReady&&this.threadsTimelineSets.forEach(e=>{o.rootEvent&&(b.d.hasServerSideSupport?e.addLiveEvent(o.rootEvent):e.addEventToTimeline(o.rootEvent,e.getLiveTimeline(),s))}),o}processLiveEvent(e){if(this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e),e.getUnsigned().transaction_id){const t=this.txnToEvent[e.getUnsigned().transaction_id];t&&this.handleRemoteEcho(e,t)}}addLiveEvent(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let i=0;i<this.timelineSets.length;i++)this.timelineSets[i].addLiveEvent(e,t,n);e.sender&&e.getType()!==g.b.RoomRedaction&&this.addReceipt(C(e.sender.userId,e,S.a.Read),!0)}addPendingEvent(e,t){if(e.status!==d.a.SENDING&&e.status!==d.a.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(r.b.setEventMetadata(e,this.getLiveTimeline().getState(r.b.FORWARDS),!1),this.txnToEvent[t]=e,this.opts.pendingEventOrdering===f.d.Detached){if(this.pendingEventList.some(e=>e.status===d.a.NOT_SENT)&&(m.a.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(d.a.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var n;const t=e.event.redacts;let i=null===(n=this.pendingEventList)||void 0===n?void 0:n.find(e=>e.getId()===t);i||(i=this.findEventById(t)),i&&(i.markLocallyRedacted(e),this.emit(R.Redaction,e,this))}}else for(let t=0;t<this.timelineSets.length;t++){const n=this.timelineSets[t];n.getFilter()?n.getFilter().filterRoomTimeline([e]).length&&n.addEventToTimeline(e,n.getLiveTimeline(),!1):n.addEventToTimeline(e,n.getLiveTimeline(),!1)}this.emit(R.LocalEchoUpdated,e,this,null,null)}savePendingEvents(){if(this.pendingEventList){const e=this.pendingEventList.map(e=>w(w({},e.event),{},{txn_id:e.getTxnId()})).filter(e=>{const t=e.type===g.b.RoomMessageEncrypted,n=this.client.isRoomEncrypted(this.roomId);return t||!n}),{store:t}=this.client.sessionStore;this.pendingEventList.length>0?t.setItem(k(this.roomId),JSON.stringify(e)):t.removeItem(k(this.roomId))}}aggregateNonLiveRelation(e){const{shouldLiveInRoom:t,threadId:n}=this.eventShouldLiveIn(e),i=this.getThread(n);if(null==i||i.timelineSet.aggregateRelations(e),t)for(let t=0;t<this.timelineSets.length;t++){const n=this.timelineSets[t];n.getFilter()?n.getFilter().filterRoomTimeline([e]).length&&n.aggregateRelations(e):n.aggregateRelations(e)}}getEventForTxnId(e){return this.txnToEvent[e]}handleRemoteEcho(e,t){const n=t.getId(),i=e.getId(),s=t.status;m.a.debug(`Got remote echo for event ${n} -> ${i} old status ${s}`),delete this.txnToEvent[e.getUnsigned().transaction_id],this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);const{shouldLiveInRoom:o,threadId:r}=this.eventShouldLiveIn(e),a=this.getThread(r);if(null==a||a.timelineSet.handleRemoteEcho(t,n,i),o)for(let e=0;e<this.timelineSets.length;e++){this.timelineSets[e].handleRemoteEcho(t,n,i)}this.emit(R.LocalEchoUpdated,t,this,n,s)}updatePendingEvent(e,t,n){if(m.a.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${n}`),t==d.a.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==d.a.SENT){if(this.getTimelineForEvent(n))return}const i=e.status,s=e.getId();if(!i)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const o=x[i];if(!o||o.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+i+"->"+t);if(e.setStatus(t),t==d.a.SENT){e.replaceLocalEventId(n);const{shouldLiveInRoom:t,threadId:i}=this.eventShouldLiveIn(e),o=this.getThread(i);if(null==o||o.timelineSet.replaceEventId(s,n),t)for(let e=0;e<this.timelineSets.length;e++)this.timelineSets[e].replaceEventId(s,n)}else if(t==d.a.CANCELLED){if(this.pendingEventList){const e=this.getPendingEvent(s);this.removePendingEvent(s),e.isRedaction()&&this.revertRedactionLocalEcho(e)}this.removeEvent(s)}this.savePendingEvents(),this.emit(R.LocalEchoUpdated,e,this,s,i)}revertRedactionLocalEcho(e){const t=e.event.redacts;if(!t)return;const n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit(R.RedactionCancelled,e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}addLiveEvents(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let e=0;e<this.timelineSets.length;e++){const t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(r.b.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(r.b.FORWARDS)+")");if(t.getNeighbouringTimeline(r.b.FORWARDS))throw new Error(`live timeline ${e} is no longer live - it has a neighbouring timeline`)}const i=this.findThreadRoots(e),s={};for(const r of e){var o;this.processLiveEvent(r);const{shouldLiveInRoom:a,shouldLiveInThread:c,threadId:l}=this.eventShouldLiveIn(r,e,i);c&&!s[l]&&(s[l]=[]),null===(o=s[l])||void 0===o||o.push(r),a&&this.addLiveEvent(r,t,n)}Object.entries(s).forEach(e=>{let[t,n]=e;this.addThreadedEvents(t,n,!1)})}partitionThreadedEvents(e){if(this.client.supportsExperimentalThreads()){const t=this.findThreadRoots(e);return e.reduce((n,i)=>{const{shouldLiveInRoom:s,shouldLiveInThread:o,threadId:r}=this.eventShouldLiveIn(i,e,t);return s&&n[0].push(i),o&&(i.setThreadId(r),n[1].push(i)),n},[[],[]])}return[e,[]]}findThreadRoots(e){const t=new Set;for(const n of e)n.isThreadRelation&&t.add(n.relationEventId);return t}addEphemeralEvents(e){for(const t of e)"m.typing"===t.getType()?this.currentState.setTypingEvent(t):"m.receipt"===t.getType()&&this.addReceipt(t)}removeEvents(e){for(let t=0;t<e.length;++t)this.removeEvent(e[t])}removeEvent(e){let t=!1;for(let n=0;n<this.timelineSets.length;n++){const i=this.timelineSets[n].removeEvent(e);i&&(i.isRedaction()&&this.revertRedactionLocalEcho(i),t=!0)}return t}recalculate(){const e=this.currentState.getStateEvents(g.b.RoomMember,this.myUserId);if(e){const t=e.getContent().membership;if(this.updateMyMembership(t),"invite"===t){(e.getUnsigned().invite_room_state||[]).forEach(e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new l.b({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])})}}const t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=Object(c.x)(this.name),this.summary=new h.a(this.roomId,{title:this.name}),t!==this.name&&this.emit(R.Name,this)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return[S.a.Read,S.a.ReadPrivate].includes(e.type)})).map((function(e){return e.userId}))}getReadReceiptForUserId(e){var t,n;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S.a.Read;const[o,r]=null!==(t=null===(n=this.receipts[s])||void 0===n?void 0:n[e])&&void 0!==t?t:[];return i?o:null!=r?r:o}getEventReadUpTo(e){var t,n,i,s;let o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=this.getUnfilteredTimelineSet(),a=this.getReadReceiptForUserId(e,o,S.a.Read),c=this.getReadReceiptForUserId(e,o,S.a.ReadPrivate);let l;return null!=a&&a.eventId&&null!=c&&c.eventId&&(l=r.compareEventOrdering(null==a?void 0:a.eventId,null==c?void 0:c.eventId)),l||(l=(null==a||null===(t=a.data)||void 0===t?void 0:t.ts)-(null==c||null===(n=c.data)||void 0===n?void 0:n.ts)),l?l<0?null==c?void 0:c.eventId:null==a?void 0:a.eventId:null!==(i=null!==(s=null==c?void 0:c.eventId)&&void 0!==s?s:null==a?void 0:a.eventId)&&void 0!==i?i:null}hasUserReadEvent(e,t){const n=this.getEventReadUpTo(e,!1);if(n===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(let e=this.timeline.length-1;e>=0;--e){const i=this.timeline[e];if(i.getId()===t)return!1;if(i.getId()===n)return!0}return!1}getReceiptsForEvent(e){return this.receiptCacheByEventId[e.getId()]||[]}addReceipt(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.addReceiptsToStructure(e,t),this.emit(R.Receipt,e,this)}addReceiptsToStructure(e,t){const n=e.getContent();Object.keys(n).forEach(e=>{Object.keys(n[e]).forEach(i=>{Object.keys(n[e][i]).forEach(s=>{var o,r;const a=n[e][i][s];this.receipts[i]||(this.receipts[i]={}),this.receipts[i][s]||(this.receipts[i][s]=[null,null]);const c=this.receipts[i][s];let l=c[0];var d;t&&(l=null!==(d=c[1])&&void 0!==d?d:c[0]);if(l){const t=this.getUnfilteredTimelineSet().compareEventOrdering(l.eventId,e);if(null!==t&&t>=0)return}const u={eventId:e,data:a},h=t?c[0]:u,m=t?u:c[1];let p=null;h&&m&&(p=this.getUnfilteredTimelineSet().compareEventOrdering(h.eventId,m.eventId));const g=null===p||p<0,f=null!==(o=c[1])&&void 0!==o?o:c[0];t&&g?c[1]=u:t||(c[0]=u,g||(c[1]=null));if(f!==(null!==(r=c[1])&&void 0!==r?r:c[0])){if(f&&this.receiptCacheByEventId[f.eventId]){const e=f.eventId;this.receiptCacheByEventId[e]=this.receiptCacheByEventId[e].filter(e=>e.type!==i||e.userId!==s),this.receiptCacheByEventId[e].length<1&&delete this.receiptCacheByEventId[e]}this.receiptCacheByEventId[e]||(this.receiptCacheByEventId[e]=[]),this.receiptCacheByEventId[e].push({userId:s,type:i,data:a})}})})})}addLocalEchoReceipt(e,t,n){this.addReceipt(C(e,t,n),!0)}addTags(e){this.tags=e.getContent().tags||{},this.emit(R.Tags,e,this)}addAccountData(e){for(let t=0;t<e.length;t++){const n=e[t];"m.tag"===n.getType()&&this.addTags(n);const i=this.accountData[n.getType()];this.accountData[n.getType()]=n,this.emit(R.AccountData,n,this,i)}}getAccountData(e){return this.accountData[e]}maySendMessage(){return"join"===this.getMyMembership()&&(this.client.isRoomEncrypted(this.roomId)?this.currentState.maySendEvent(g.b.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(g.b.RoomMessage,this.myUserId))}canInvite(e){let t="join"===this.getMyMembership();const n=this.currentState.getStateEvents(g.b.RoomPowerLevels,""),i=n&&n.getContent(),s=this.getMember(e);return i&&s&&i.invite>s.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){const e=this.currentState.getStateEvents(g.b.RoomCreate,"");if(e)return e.getContent()[g.e];this.getTypeWarning||(m.a.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===g.f.Space}isCallRoom(){return this.getType()===g.f.UnstableCall}isElementVideoRoom(){return this.getType()===g.f.ElementVideo}calculateRoomName(e){if(!(arguments.length>1&&void 0!==arguments[1]&&arguments[1])){const e=this.currentState.getStateEvents(g.b.RoomName,"");if(e&&e.getContent()&&e.getContent().name)return e.getContent().name}const t=this.getCanonicalAlias();if(t)return t;let n=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1,i=[];const s=this.currentState.getStateEvents(g.g.name,"");Array.isArray(null==s?void 0:s.getContent().service_members)&&(i=s.getContent().service_members);let o=null;if(this.summaryHeroes)o=[],this.summaryHeroes.forEach(e=>{if(i.includes(e))return void n--;const t=this.getMember(e);o.push(t?t.name:e)});else{let t=this.currentState.getMembers().filter(t=>t.userId!==e&&("invite"===t.membership||"join"===t.membership));t=t.filter(e=>{let{userId:t}=e;return!i.includes(t)||(n--,!1)}),t.sort((e,t)=>c.g(e.userId,t.userId)),t=t.slice(0,5),o=t.map(e=>e.name)}if(n)return T(o,n);if("join"==this.getMyMembership()){const e=this.currentState.getStateEvents(g.b.RoomThirdPartyInvite);if(e&&e.length){return"Inviting "+T(e.map(e=>e.getContent().display_name))}}let r=o;return r.length||(r=this.currentState.getMembers().filter(t=>t.userId!==e&&"invite"!==t.membership&&"join"!==t.membership).map(e=>e.name)),r.length?`Empty room (was ${T(r)})`:"Empty room"}applyNewVisibilityEvent(e){const t=e.asVisibilityChange();if(!t)return;const n=e.getSender();if(!n)return;if(!(g.a.name&&this.currentState.maySendStateEvent(g.a.name,n)||g.a.altName&&this.currentState.maySendStateEvent(g.a.altName,n)))return;const i=this.visibilityEvents.get(t.eventId);if(i){let t=i.length-1;const n=Math.max(0,i.length-30);for(;t>=n;--t){if(i[t].getTs()<e.getTs())break}-1===t?i.unshift(e):i.splice(t+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);const s=this.findEventById(t.eventId);s&&s.applyVisibilityEvent(t)}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");const t=e.getRelation().event_id,n=this.visibilityEvents.get(t);if(!n)return;const i=n.findIndex(t=>t.getId()===e.getId());if(-1!==i&&(n.splice(i,1),i===n.length)){const e=this.findEventById(t);if(!e)return;if(0===i)this.visibilityEvents.delete(t),e.applyVisibilityEvent();else{const t=n[n.length-1].asVisibilityChange();if(!t)throw new Error("at this stage, visibility changes should be well-formed");e.applyVisibilityEvent(t)}}}applyPendingVisibilityEvents(e){const t=this.visibilityEvents.get(e.getId());if(!t||0==t.length)return;const n=t[t.length-1],i=n.asVisibilityChange();i&&(i.visible,n.getTs()<e.getTs()||e.applyVisibilityEvent(i))}}function k(e){return"mx_pending_events_"+e}const x={[d.a.ENCRYPTING]:[d.a.SENDING,d.a.NOT_SENT,d.a.CANCELLED],[d.a.SENDING]:[d.a.ENCRYPTING,d.a.QUEUED,d.a.NOT_SENT,d.a.SENT],[d.a.QUEUED]:[d.a.SENDING,d.a.CANCELLED],[d.a.SENT]:[],[d.a.NOT_SENT]:[d.a.SENDING,d.a.QUEUED,d.a.CANCELLED],[d.a.CANCELLED]:[]};function T(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.length+1;const n=t-1;if(e.length){if(1===e.length&&n<=1)return e[0];if(2===e.length&&n<=2)return`${e[0]} and ${e[1]}`;return n>1?`${e[0]} and ${n} others`:e[0]+" and 1 other"}return"Empty room"}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(88),s=n.n(i),o=n(192),r=n(93),a=n(98),c=n(109),l=n(608);const d=e=>c.b[e].settingNames.reduce((e,t)=>{var n;const i=null===(n=Object(l.c)()[t])||void 0===n?void 0:n.default;return i&&e.push({action:t,keyCombo:i}),e},[]),u={getMessageComposerBindings:()=>{const e=d(c.c.COMPOSER);return r.b.getValue("MessageComposerInput.ctrlEnterToSend")?(e.push({action:c.h.SendMessage,keyCombo:{key:o.b.ENTER,ctrlOrCmdKey:!0}}),e.push({action:c.h.NewLine,keyCombo:{key:o.b.ENTER}}),e.push({action:c.h.NewLine,keyCombo:{key:o.b.ENTER,shiftKey:!0}})):(e.push({action:c.h.SendMessage,keyCombo:{key:o.b.ENTER}}),e.push({action:c.h.NewLine,keyCombo:{key:o.b.ENTER,shiftKey:!0}}),o.a&&e.push({action:c.h.NewLine,keyCombo:{key:o.b.ENTER,altKey:!0}})),e},getAutocompleteBindings:()=>{const e=d(c.c.AUTOCOMPLETE);return e.push({action:c.h.ForceCompleteAutocomplete,keyCombo:{key:o.b.TAB}}),e.push({action:c.h.ForceCompleteAutocomplete,keyCombo:{key:o.b.TAB,ctrlKey:!0}}),e.push({action:c.h.CompleteAutocomplete,keyCombo:{key:o.b.ENTER}}),e.push({action:c.h.CompleteAutocomplete,keyCombo:{key:o.b.ENTER,ctrlKey:!0}}),e},getRoomListBindings:()=>d(c.c.ROOM_LIST),getRoomBindings:()=>{const e=d(c.c.ROOM);return r.b.getValue("ctrlFForSearch")&&e.push({action:c.h.SearchInRoom,keyCombo:{key:o.b.F,ctrlOrCmdKey:!0}}),e},getNavigationBindings:()=>d(c.c.NAVIGATION),getAccessibilityBindings:()=>d(c.c.ACCESSIBILITY),getCallBindings:()=>d(c.c.CALLS),getLabsBindings:()=>a.b.get("show_labs_settings")?d(c.c.LABS):[]};function h(e,t,n){var i,s,o,r,a,c,l,d;if(void 0!==t.key)if(e.shiftKey){if(e.key.toLowerCase()!==t.key.toLowerCase())return!1}else if(e.key!==t.key)return!1;const u=null!==(i=t.ctrlKey)&&void 0!==i&&i,h=null!==(s=t.altKey)&&void 0!==s&&s,m=null!==(o=t.shiftKey)&&void 0!==o&&o,p=null!==(r=t.metaKey)&&void 0!==r&&r,g=null!==(a=e.ctrlKey)&&void 0!==a&&a,f=null!==(c=e.altKey)&&void 0!==c&&c,v=null!==(l=e.shiftKey)&&void 0!==l&&l,b=null!==(d=e.metaKey)&&void 0!==d&&d;if(t.ctrlOrCmdKey){if(n){if(!b||g!==u||f!==h||v!==m)return!1}else if(!g||b!==p||f!==h||v!==m)return!1;return!0}return b===p&&g===u&&f===h&&v===m}const m=new class{constructor(){s()(this,"bindingsProviders",[u])}getAction(e,t){for(const n of e){const e=n().find(e=>h(t,e.keyCombo,o.a));if(e)return e.action}}getMessageComposerAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getMessageComposerBindings),e)}getAutocompleteAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getAutocompleteBindings),e)}getRoomListAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getRoomListBindings),e)}getRoomAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getRoomBindings),e)}getNavigationAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getNavigationBindings),e)}getAccessibilityAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getAccessibilityBindings),e)}getCallAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getCallBindings),e)}getLabsAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getLabsBindings),e)}};function p(){return m}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(89),d=n(101),u=n(110);class h extends r.a.Component{constructor(){super(...arguments),s()(this,"onOk",()=>{this.props.onFinished(!0)}),s()(this,"onCancel",()=>{this.props.onFinished(!1)})}render(){let e="";return this.props.danger&&(e="danger"),r.a.createElement(d.a,{className:c()("mx_QuestionDialog",this.props.className),onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",headerImage:this.props.headerImage,hasCancel:this.props.hasCancelButton,fixedWidth:this.props.fixedWidth},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description),r.a.createElement(u.a,{primaryButton:this.props.button||Object(l.a)("OK"),primaryButtonClass:e,primaryDisabled:this.props.buttonDisabled,cancelButton:this.props.cancelButton,hasCancel:this.props.hasCancelButton&&!this.props.quitOnly,onPrimaryButtonClick:this.onOk,focus:this.props.focus,onCancel:this.onCancel},this.props.extraButtons))}}s()(h,"defaultProps",{title:"",description:"",extraButtons:null,focus:!0,hasCancelButton:!0,danger:!1,quitOnly:!1})},function(e,t,n){"use strict";n.d(t,"b",(function(){return b})),n.d(t,"a",(function(){return y}));var i,s=n(17),o=n.n(s),r=n(151),a=n(0),c=n(7),l=n(97),d=n(108),u=n(125),h=n(143),m=n(364),p=n(281),g=n(244);function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?f(Object(n),!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let b;!function(e){e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished"}(i||(i={})),function(e){e.Events="RoomState.events",e.Members="RoomState.members",e.NewMember="RoomState.newMember",e.Update="RoomState.update",e.BeaconLiveness="RoomState.BeaconLiveness"}(b||(b={}));class y extends h.b{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{status:i.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,o()(this,"reEmitter",new p.a(this)),o()(this,"sentinels",{}),o()(this,"displayNameToUserIds",{}),o()(this,"userIdsToDisplayNames",{}),o()(this,"tokenToInvite",{}),o()(this,"joinedMemberCount",null),o()(this,"summaryJoinedMemberCount",null),o()(this,"invitedMemberCount",null),o()(this,"summaryInvitedMemberCount",null),o()(this,"modified",void 0),o()(this,"members",{}),o()(this,"events",new Map),o()(this,"paginationToken",null),o()(this,"beacons",new Map),o()(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>"join"===t.membership?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>"invite"===t.membership?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new r.a(this.roomId,e);const n=this.members[e];n&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());const n=this.events.get(e).get(t);return n||null}get hasLiveBeacons(){var e;return!(null===(e=this.liveBeaconIds)||void 0===e||!e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){const e=new y(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=i.NotStarted,Array.from(this.events.values()).forEach(t=>{e.setStateEvents(Array.from(t.values()))}),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==i.Finished&&this.getMembers().forEach(t=>{if(t.isOutOfBand()){e.getMember(t.userId).markOutOfBand()}}),e}setUnknownStateEvents(e){const t=e.filter(e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey()));this.setStateEvents(t)}setStateEvents(e){this.updateModifiedTime(),e.forEach(e=>{if(e.getRoomId()!==this.roomId)return;if(!e.isState())return;g.b.matches(e.getType())&&this.setBeacon(e);const t=this.getStateEventMatching(e);this.setStateEvent(e),e.getType()===l.b.RoomMember&&(this.updateDisplayNameCache(e.getStateKey(),e.getContent().displayname),this.updateThirdPartyTokenCache(e)),this.emit(b.Events,e,this,t)}),this.onBeaconLivenessChange(),e.forEach(e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===l.b.RoomMember){const t=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),this.updateMember(n),this.emit(b.Members,e,this,n)}else if(e.getType()===l.b.RoomPowerLevels){if(""!==e.getStateKey())return;Object.values(this.members).forEach(t=>{const n=t.getLastModifiedTime();t.setPowerLevelEvent(e),n!==t.getLastModifiedTime()&&this.emit(b.Members,e,this,t)}),this.sentinels={}}}),this.emit(b.Update,this)}processBeaconEvents(e,t){if(!e.length||!this.beacons.size)return;const n=[...this.beacons.values()].reduce((e,t)=>v(v({},e),{},{[t.beaconInfoId]:t}),{}),i=(e,t)=>{if(!g.a.matches(t.getType()))return;const i=n[e];i&&i.addLocations([t])};e.forEach(e=>{var s;const o=null===(s=e.getRelation())||void 0===s?void 0:s.event_id;n[o]&&(t.decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure()?e.once(d.c.Decrypted,async()=>{i(o,e)}):i(o,e))})}getOrCreateMember(e,t){let n=this.members[e];return n||(n=new r.a(this.roomId,e),this.members[e]=n,this.emit(b.NewMember,t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){const t=Object(m.c)(e);if(this.beacons.has(t)){const i=this.beacons.get(t);var n;return e.isRedacted()?void(i.beaconInfoId===(null===(n=e.getRedactionEvent())||void 0===n?void 0:n.redacts)&&(i.destroy(),this.beacons.delete(t))):i.update(e)}if(e.isRedacted())return;const i=new m.a(e);this.reEmitter.reEmit(i,[m.b.New,m.b.Update,m.b.Destroy,m.b.LivenessChange]),this.emit(m.b.New,e,i),i.on(m.b.LivenessChange,this.onBeaconLivenessChange.bind(this)),i.on(m.b.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(i.identifier,i)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(b.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,n;return null!==(t=null===(n=this.events.get(e.getType()))||void 0===n?void 0:n.get(e.getStateKey()))&&void 0!==t?t:null}updateMember(e){const t=this.getStateEvents(l.b.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===i.NotStarted}markOutOfBandMembersStarted(){this.oobMemberFlags.status===i.NotStarted&&(this.oobMemberFlags.status=i.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===i.InProgress&&(this.oobMemberFlags.status=i.NotStarted)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),a.a.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=i.NotStarted}setOutOfBandMembers(e){a.a.log(`LL: RoomState about to set ${e.length} OOB members ...`),this.oobMemberFlags.status===i.InProgress&&(a.a.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=i.Finished,e.forEach(e=>this.setOutOfBandMember(e)),this.emit(b.Update,this))}setOutOfBandMember(e){if(e.getType()!==l.b.RoomMember)return;const t=e.getStateKey(),n=this.getMember(t);if(n&&!n.isOutOfBand())return;const i=this.getOrCreateMember(t,e);i.setMembershipEvent(e,this),i.markOutOfBand(),this.updateDisplayNameCache(i.userId,i.name),this.setStateEvent(e),this.updateMember(i),this.emit(b.Members,e,this,i)}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){return this.displayNameToUserIds[c.E(e)]||[]}maySendRedactionForEvent(e,t){const n=this.getMember(t);if(!n||"leave"===n.membership)return!1;if(e.status||e.isRedacted())return!1;const i=this.maySendEvent(l.b.RoomRedaction,t);return e.getSender()===t?i:this.hasSufficientPowerLevelFor("redact",n.powerLevel)}hasSufficientPowerLevelFor(e,t){const n=this.getStateEvents(l.b.RoomPowerLevels,"");let i={};n&&(i=n.getContent());let s=50;return c.u(i[e])&&(s=i[e]),t>=s}maySendMessage(e){return this.maySendEventOfType(l.b.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){const i=this.getStateEvents(l.b.RoomPowerLevels,"");let s,o={},r=0,a=0,c=0;if(i){s=i.getContent(),o=s.events||{},r=Number.isSafeInteger(s.state_default)?s.state_default:50;const e=s.users&&s.users[t];Number.isSafeInteger(e)?c=e:Number.isSafeInteger(s.users_default)&&(c=s.users_default),Number.isSafeInteger(s.events_default)&&(a=s.events_default)}let d=n?r:a;return Number.isSafeInteger(o[e])&&(d=o[e]),c>=d}mayTriggerNotifOfType(e,t){const n=this.getMember(t);if(!n)return!1;const i=this.getStateEvents(l.b.RoomPowerLevels,"");let s=50;return i&&i.getContent()&&i.getContent().notifications&&c.u(i.getContent().notifications[e])&&(s=i.getContent().notifications[e]),n.powerLevel>=s}getJoinRule(){var e;const t=this.getStateEvents(l.b.RoomJoinRules,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).join_rule||u.c.Invite}getHistoryVisibility(){var e;const t=this.getStateEvents(l.b.RoomHistoryVisibility,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).history_visibility||u.b.Shared}getGuestAccess(){var e;const t=this.getStateEvents(l.b.RoomGuestAccess,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).guest_access||u.a.Forbidden}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;const t=(e.getContent().third_party_invite.signed||{}).token;if(!t)return;this.getStateEvents(l.b.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){const n=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],n){const t=c.E(n),i=this.displayNameToUserIds[t];if(i){const n=i.filter(t=>t!==e);this.displayNameToUserIds[t]=n}}this.userIdsToDisplayNames[e]=t;const i=t&&c.E(t);i&&(this.displayNameToUserIds[i]||(this.displayNameToUserIds[i]=[]),this.displayNameToUserIds[i].push(e))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(88),c=n.n(a),l=n(87),d=n.n(l),u=n(91),h=n(140);const m=["title","tooltip","children","tooltipClassName","forceHide","alignment","onHideTooltip"];class p extends d.a.PureComponent{constructor(e){super(e),c()(this,"showTooltip",()=>{this.props.onHover&&this.props.onHover(!0),this.props.forceHide||this.setState({hover:!0})}),c()(this,"hideTooltip",e=>{var t,n;this.props.onHover&&this.props.onHover(!1),this.setState({hover:!1}),null===(t=(n=this.props).onHideTooltip)||void 0===t||t.call(n,e)}),c()(this,"onFocus",e=>{e.relatedTarget&&this.showTooltip()}),this.state={hover:!1}}componentDidUpdate(e){!e.forceHide&&this.props.forceHide&&this.state.hover&&this.setState({hover:!1})}render(){const e=this.props,{title:t,tooltip:n,children:i,tooltipClassName:o,forceHide:a,alignment:c,onHideTooltip:l}=e,p=r()(e,m),g=this.state.hover&&d.a.createElement(h.b,{tooltipClassName:o,label:n||t,alignment:c});return d.a.createElement(u.a,s()({},p,{onMouseOver:this.showTooltip,onMouseLeave:this.hideTooltip,onFocus:this.onFocus,onBlur:this.hideTooltip,"aria-label":t}),i,this.props.label,(n||t)&&g)}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return o})),n.d(t,"d",(function(){return r})),n.d(t,"b",(function(){return a}));var i=n(87);function s(e,t,n){o(e,t,n)}function o(e,t,n){const s=Object(i.useRef)(n);Object(i.useEffect)(()=>{s.current=n},[n]),Object(i.useEffect)(()=>{if(!e)return;const n=function(){return s.current(...arguments)};return e.on(t,n),()=>{e.removeListener(t,n)}},[t,e])}function r(e,t,n){return a(e,t,n)}function a(e,t,n){const[s,r]=Object(i.useState)(n()),a=Object(i.useCallback)((function(){r(n(...arguments))}),[n]);return Object(i.useEffect)(a,[e]),o(e,t,a),s}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return z})),n.d(t,"d",(function(){return J})),n.d(t,"e",(function(){return Y})),n.d(t,"b",(function(){return X})),n.d(t,"c",(function(){return Z}));var i=n(17),s=n.n(i),o=n(434),r=n(242),a=n(881),c=n(108),l=n(882),d=n(152),u=n(273),h=n(597),m=n(7),p=n(144),g=n(282),f=n(283),v=n(161),b=n(281),y=n(883),S=n(0),E=n(225),w=n(224),_=n(145),C=n(372),O=n(371),R=n(200),I=n(312),k=n(1497),x=n(602),T=n(120),j=n(895),N=n(237),P=n(97),D=n(125),A=n(896),M=n(186),U=n(603),L=n(1498),F=n(373),B=n(202),K=n(897),V=n(143),W=n(285),H=n(137),q=n(244);function $(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function G(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const z=Object(_.d)();let J,Y;var Q;!function(e){e.Chronological="chronological",e.Detached="detached"}(J||(J={})),function(e){e.Stable="stable",e.Unstable="unstable"}(Y||(Y={})),function(e){e.MasterKey="master_key",e.SelfSigningKey="self_signing_key",e.UserSigningKey="user_signing_key"}(Q||(Q={}));let X;!function(e){e.Sync="sync",e.Event="event",e.ToDeviceEvent="toDeviceEvent",e.AccountData="accountData",e.Room="Room",e.DeleteRoom="deleteRoom",e.SyncUnexpectedError="sync.unexpectedError",e.ClientWellKnown="WellKnown.client"}(X||(X={}));class Z extends V.b{constructor(e){super(),s()(this,"reEmitter",new b.a(this)),s()(this,"olmVersion",null),s()(this,"usingExternalCrypto",!1),s()(this,"store",void 0),s()(this,"deviceId",void 0),s()(this,"credentials",void 0),s()(this,"pickleKey",void 0),s()(this,"scheduler",void 0),s()(this,"clientRunning",!1),s()(this,"timelineSupport",!1),s()(this,"urlPreviewCache",{}),s()(this,"unstableClientRelationAggregation",!1),s()(this,"identityServer",void 0),s()(this,"useWebSockets",void 0),s()(this,"sessionStore",void 0),s()(this,"http",void 0),s()(this,"crypto",void 0),s()(this,"cryptoCallbacks",void 0),s()(this,"callEventHandler",void 0),s()(this,"supportsCallTransfer",!1),s()(this,"forceTURN",!1),s()(this,"iceCandidatePoolSize",0),s()(this,"idBaseUrl",void 0),s()(this,"baseUrl",void 0),s()(this,"canSupportVoip",!1),s()(this,"peekSync",null),s()(this,"isGuestAccount",!1),s()(this,"ongoingScrollbacks",{}),s()(this,"notifTimelineSet",null),s()(this,"cryptoStore",void 0),s()(this,"verificationMethods",void 0),s()(this,"fallbackICEServerAllowed",!1),s()(this,"roomList",void 0),s()(this,"syncApi",void 0),s()(this,"websocketApi",void 0),s()(this,"pushRules",void 0),s()(this,"syncLeftRoomsPromise",void 0),s()(this,"syncedLeftRooms",!1),s()(this,"clientOpts",void 0),s()(this,"clientWellKnownIntervalID",void 0),s()(this,"canResetTimelineCallback",void 0),s()(this,"pushProcessor",new g.a(this)),s()(this,"serverVersionsPromise",void 0),s()(this,"cachedCapabilities",void 0),s()(this,"clientWellKnown",void 0),s()(this,"clientWellKnownPromise",void 0),s()(this,"turnServers",[]),s()(this,"turnServersExpiry",0),s()(this,"checkTurnServersIntervalID",void 0),s()(this,"exportedOlmDeviceToImport",void 0),s()(this,"txnCtr",0),s()(this,"mediaHandler",new K.a(this)),s()(this,"pendingEventEncryption",new Map),s()(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(this.callEventHandler.start(),this.off(X.Sync,this.startCallEventHandler))}),void 0===e.useWebSockets&&(e.useWebSockets=!0),this.useWebSockets=Boolean(e.useWebSockets),e.baseUrl=m.o(e.baseUrl),e.idBaseUrl=m.o(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.usingExternalCrypto=e.usingExternalCrypto,this.store=e.store||new l.a,this.deviceId=e.deviceId||null;const t=e.userId||null;this.credentials={userId:t},this.http=new w.e(this,{baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:w.j,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader}),e.deviceToImport?this.deviceId?S.a.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?S.a.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):S.a.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(async e=>{const t=this.getRoom(e.getRoomId());e.status!==c.a.SENDING&&this.updatePendingEventStatus(t,e,c.a.SENDING);const n=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,c.a.SENT,n.event_id),n}),Object(d.h)()&&(this.callEventHandler=new h.a(this),this.canSupportVoip=!0,this.on(X.Sync,this.startCallEventHandler)),this.websocketApi=null,this.timelineSupport=Boolean(e.timelineSupport),this.unstableClientRelationAggregation=!!e.unstableClientRelationAggregation,this.cryptoStore=e.cryptoStore,this.sessionStore=e.sessionStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.roomList=new y.a(this.cryptoStore),this.on(c.c.Decrypted,e=>{var t,n;const i=e.getPushActions(),s=this.getPushActionsForEvent(e,!0),o=this.getRoom(e.getRoomId());if(!o)return;const r=o.getUnreadNotificationCount(T.NotificationCountType.Highlight),a=!(null==i||null===(t=i.tweaks)||void 0===t||!t.highlight),c=!(null==s||null===(n=s.tweaks)||void 0===n||!n.highlight);if((a!==c||r>0)&&!o.hasUserReadEvent(this.getUserId(),e.getId())){let e=r;c&&!a&&e++,!c&&a&&e--,o.setUnreadNotificationCount(T.NotificationCountType.Highlight,e);o.getUnreadNotificationCount(T.NotificationCountType.Total)<e&&o.setUnreadNotificationCount(T.NotificationCountType.Total,e)}}),this.on(T.RoomEvent.Receipt,(e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const n=e.getContent();if(!(Object.keys(n).filter(e=>{const t=n[e][W.a.Read];if(t&&Object.keys(t).includes(this.getUserId()))return!0;const i=n[e][W.a.ReadPrivate];return!(!i||!Object.keys(i).includes(this.getUserId()))}).length>0))return;const i=20,s=t.getLiveTimeline().getEvents();let o=0;for(let e=s.length-1;e>=0;e--){if(e===s.length-i)return;const n=s[e];if(t.hasUserReadEvent(this.getUserId(),n.getId()))break;const r=this.getPushActionsForEvent(n);o+=r.tweaks&&r.tweaks.highlight?1:0}t.setUnreadNotificationCount(T.NotificationCountType.Highlight,o)}})}async startClient(e){if(this.clientRunning)return;this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e});const t=this.getUserId();t&&this.store.storeUser(new R.a(t)),this.crypto&&(this.crypto.uploadDeviceKeys(),this.crypto.start()),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval(()=>{this.checkTurnServers()},6e5),this.checkTurnServers()),this.syncApi&&(S.a.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop()),this.websocketApi&&(S.a.error("Still have websocket object whilst not running: stopping old one"),this.websocketApi.stop(),this.websocketApi=null);try{const{serverSupport:e,stable:t}=await this.doesServerSupportThread();H.d.setServerSideSupport(e,t)}catch(e){H.d.setServerSideSupport(!1,!0)}if(this.clientOpts=Object.assign({},e),this.clientOpts.crypto=this.crypto,this.clientOpts.canResetEntireTimeline=e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e),this.syncApi=new r.a(this,this.clientOpts),this.useWebSockets){this.websocketApi=new a.a(this,e),this.websocketApi.start();const t=this;this.scheduler.setProcessFunction(e=>{const n=t.getRoom(e.getRoomId());return e.status!==c.a.SENDING&&this.updatePendingEventStatus(n,e,c.a.SENDING),this.websocketApi.sendEvent(e)})}else this.syncApi.sync();void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval(()=>{this.fetchClientWellKnown()},1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown())}stopClient(){var t,n,i;null===(t=this.crypto)||void 0===t||t.stop(),this.clientRunning&&(S.a.log("stopping MatrixClient"),this.clientRunning=!1,this.syncApi&&(this.syncApi.stop(),this.syncApi=null),this.websocketApi&&(this.websocketApi.stop(),this.websocketApi=null),null===(n=this.peekSync)||void 0===n||n.stopPeeking(),null===(i=this.callEventHandler)||void 0===i||i.stop(),this.callEventHandler=null,e.clearInterval(this.checkTurnServersIntervalID),void 0!==this.clientWellKnownIntervalID&&e.clearInterval(this.clientWellKnownIntervalID))}connectionFallback(t,n){this.useWebSockets=!1,console.log("Do Fallback to SyncAPI"),this.syncApi||(this.syncApi=new r.a(this,t));const i=this.syncApi;i.running=!0,e.document&&(i.onOnlineBound=i.onOnline.bind(i),e.document.addEventListener("online",i.onOnlineBound,!1)),i.opts=n,i.sync(),this.websocketApi.stop(),this.websocketApi=null;const s=this;this.scheduler.setProcessFunction((function(e){const t=s.getRoom(e.getRoomId());return e.status!==c.a.SENDING&&this.updatePendingEventStatus(t,e,c.a.SENDING),this.sendEventHttpRequest(s,e)}))}async rehydrateDevice(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const t=await this.getDehydratedDevice();if(!t)return;if(!t.device_data||!t.device_id)return void S.a.info("no dehydrated device found");const n=new e.Olm.Account;try{const e=t.device_data;if(e.algorithm!==x.a)return void S.a.warn("Wrong algorithm for dehydrated device");S.a.log("unpickling dehydrated device");const i=await this.cryptoCallbacks.getDehydrationKey(e,t=>{n.unpickle(new Uint8Array(t),e.account)});n.unpickle(i,e.account),S.a.log("unpickled device");if(!0===(await this.http.authedRequest(void 0,w.f.Post,"/dehydrated_device/claim",void 0,{device_id:t.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=t.device_id,S.a.info("using dehydrated device");const e=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:n.pickle(e),sessions:[],pickleKey:e},n.free(),this.deviceId}return n.free(),void S.a.info("not using dehydrated device")}catch(e){n.free(),S.a.warn("could not unpickle",e)}}async getDehydratedDevice(){try{return await this.http.authedRequest(void 0,w.f.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){return void S.a.info("could not get dehydrated device",e.toString())}}setDehydrationKey(e,t,n){if(this.crypto)return this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,n);S.a.warn("not dehydrating device if crypto is not enabled")}async createDehydratedDevice(e,t,n){if(this.crypto)return await this.crypto.dehydrationManager.setKey(e,t,n),this.crypto.dehydrationManager.dehydrateDevice();S.a.warn("not dehydrating device if crypto is not enabled")}async exportDevice(){if(this.crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()};S.a.warn("not exporting device if crypto is not enabled")}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];return e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}createCall(e){return Object(d.g)(this,e)}getSyncState(){return this.useWebSockets&&this.websocketApi?this.websocketApi.getSyncState():this.syncApi?this.syncApi.getSyncState():null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return!!e&&(e===r.b.Prepared||e===r.b.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){return this.websocketApi?this.websocketApi.reconnectNow():this.syncApi.retryImmediately()}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const n=(new Date).getTime();return this.cachedCapabilities&&!t&&n<this.cachedCapabilities.expiration?(S.a.log("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(void 0,w.f.Get,"/capabilities").catch(e=>{S.a.error(e)}).then((function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const i=t.capabilities||{},s=Object.keys(i).length?216e5:6e4+5e3*Math.random();return e.cachedCapabilities={capabilities:i,expiration:n+s},S.a.log("Caching capabilities: ",i),i}))}async initCrypto(){if(!Object(_.d)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.crypto)return void S.a.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this.sessionStore)throw new Error("Cannot enable encryption: no sessionStore provided");if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");S.a.log("Crypto: Starting up crypto store..."),await this.cryptoStore.startup(),S.a.log("Crypto: initialising roomlist..."),await this.roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new _.a(this,this.sessionStore,e,this.deviceId,this.store,this.cryptoStore,this.roomList,this.verificationMethods);this.reEmitter.reEmit(t,[_.b.KeyBackupFailed,_.b.KeyBackupSessionsRemaining,_.b.RoomKeyRequest,_.b.RoomKeyRequestCancellation,_.b.Warning,_.b.DevicesUpdated,_.b.WillUpdateDevices,_.b.DeviceVerificationChanged,_.b.UserTrustStatusChanged,_.b.KeysChanged]),S.a.log("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=_.a.getOlmVersion(),t.registerEventHandlers(this),this.crypto=t}isCryptoEnabled(){return!!this.crypto}getDeviceEd25519Key(){return this.crypto?this.crypto.getDeviceEd25519Key():null}getDeviceCurve25519Key(){return this.crypto?this.crypto.getDeviceCurve25519Key():null}async uploadKeys(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.uploadDeviceKeys()}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=this.setDeviceVerification(e,t,n,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),i}setDeviceBlocked(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.setDeviceVerification(e,t,null,n,null)}setDeviceKnown(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.setDeviceVerification(e,t,null,null,n)}async setDeviceVerification(e,t,n,i,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,n,i,s)}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,n)}checkSecretStorageKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStorageKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalBlacklistUnverifiedDevices(e)}getGlobalBlacklistUnverifiedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalBlacklistUnverifiedDevices()}setGlobalErrorOnUnknownDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalErrorOnUnknownDevices(e)}getGlobalErrorOnUnknownDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalErrorOnUnknownDevices()}getCrossSigningId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:j.a.Master;if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,n)}prepareToEncrypt(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.prepareToEncrypt(e)}isCrossSigningReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCryptoTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setCryptoTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.addSecretStorageKey(e,t,n)}hasSecretStorageKey(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.hasSecretStorageKey(e)}storeSecret(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.storeSecret(e,t,n)}getSecret(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getSecret(e)}isSecretStored(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getDefaultSecretStorageKeyId()}setDefaultSecretStorageKeyId(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setDefaultSecretStorageKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}cancelAndResendEventRoomKeyRequest(e){return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){const t=this.getRoom(e);if(!t)return!1;return!!t.currentState.getStateEvents(P.b.RoomEncryption,"")||this.roomList.isRoomEncrypted(e)}forceDiscardSession(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");this.crypto.forceDiscardSession(e)}exportRoomKeys(){return this.crypto?this.crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.importRoomKeys(e,t)}checkKeyBackup(){return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(void 0,w.f.Get,"/room_keys/version",void 0,void 0,{prefix:w.k})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}return U.a.checkBackupVersion(e),e}isKeyBackupTrusted(e){return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{secureSecretStorage:!1};if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:n,auth_data:i,recovery_key:s,privateKey:o}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.storeSecret("m.megolm_backup.v1",Object(v.encodeBase64)(o)),S.a.info("Key backup private key stored in secret storage")),{algorithm:n,auth_data:i,recovery_key:s}}isKeyBackupKeyStored(){return Promise.resolve(this.isSecretStored("m.megolm_backup.v1"))}async createKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");const n=await this.http.authedRequest(void 0,w.f.Post,"/room_keys/version",void 0,t,{prefix:w.k});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||S.a.error("Key backup not usable even though we just created it"),n}deleteKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.version&&this.crypto.backupManager.disableKeyBackup();const t=m.n("/room_keys/version/$version",{$version:e});return this.http.authedRequest(void 0,w.f.Delete,t,void 0,void 0,{prefix:w.k})}makeKeyBackupPath(e,t,n){let i;i=void 0!==t?m.n("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?m.n("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";return{path:i,queryData:void 0===n?void 0:{version:n}}}sendKeyBackup(e,t,n,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");const s=this.makeKeyBackupPath(e,t,n);return this.http.authedRequest(void 0,w.f.Put,s.path,s.queryData,i,{prefix:w.k})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return Object(C.a)(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return Object(O.b)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return Object(C.a)(e)}async restoreKeyBackupWithPassword(e,t,n,i,s){const o=await Object(O.b)(i.auth_data,e);return this.restoreKeyBackup(o,t,n,i,s)}async restoreKeyBackupWithSecretStorage(e,t,n,i){const s=await this.getSecret("m.megolm_backup.v1"),o=Object(_.c)(s);if(o){const[e]=await this.crypto.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",o,[e])}const r=Object(v.decodeBase64)(o||s);return this.restoreKeyBackup(r,t,n,e,i)}restoreKeyBackupWithRecoveryKey(e,t,n,i,s){const o=Object(C.a)(e);return this.restoreKeyBackup(o,t,n,i,s)}async restoreKeyBackupWithCache(e,t,n,i){const s=await this.crypto.getSessionBackupPrivateKey();if(!s)throw new Error("Couldn't get key");return this.restoreKeyBackup(s,e,t,n,i)}async restoreKeyBackup(e,t,n,i,s){const o=null==s?void 0:s.cacheCompleteCallback,r=null==s?void 0:s.progressCallback;if(!this.crypto)throw new Error("End-to-end encryption disabled");let a=0,c=[];const l=this.makeKeyBackupPath(t,n,i.version),d=await U.a.makeAlgorithm(i,async()=>e),u=d.untrusted;try{if(!await d.keyMatches(e))return Promise.reject(new w.d({errcode:Z.RESTORE_BACKUP_ERROR_BAD_KEY}));this.crypto.storeSessionBackupPrivateKey(e).catch(e=>{S.a.warn("Error caching session backup key:",e)}).then(o),r&&r({stage:"fetch"});const i=await this.http.authedRequest(void 0,w.f.Get,l.path,l.queryData,void 0,{prefix:w.k});if(i.rooms){const e=i.rooms;for(const[t,n]of Object.entries(e)){if(!n.sessions)continue;a+=Object.keys(n.sessions).length;const e=await d.decryptSessions(n.sessions);for(const n of e)n.room_id=t,c.push(n)}}else if(i.sessions){const e=i.sessions;a=Object.keys(e).length,c=await d.decryptSessions(e);for(const e of c)e.room_id=t}else{a=1;try{const[e]=await d.decryptSessions({[n]:i});e.room_id=t,e.session_id=n,c.push(e)}catch(e){S.a.log("Failed to decrypt megolm session from backup",e)}}}finally{d.free()}return await this.importRoomKeys(c,{progressCallback:r,untrusted:u,source:"backup"}),await this.checkKeyBackup(),{total:a,imported:c.length}}deleteKeysFromBackup(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");const i=this.makeKeyBackupPath(e,t,n);return this.http.authedRequest(void 0,w.f.Delete,i.path,i.queryData,void 0,{prefix:w.k})}async sendSharedHistoryKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.roomList.getRoomEncryption(e);if(!n)return void S.a.error("Unknown room.  Not sharing decryption keys");const i=await this.crypto.downloadKeys(t),s={};for(const[e,t]of Object.entries(i))s[e]=Object.values(t);const o=this.crypto.getRoomDecryptor(e,n.algorithm);o.sendSharedHistoryInboundSessions?await o.sendSharedHistoryInboundSessions(s):S.a.warn("Algorithm does not support sharing previous keys",n.algorithm)}getMediaConfig(e){return this.http.authedRequest(e,w.f.Get,"/config",void 0,void 0,{prefix:w.i})}getRoom(e){return this.store.getRoom(e)}getRooms(){return this.store.getRooms()}getVisibleRooms(){const e=this.store.getRooms(),t=new Set;for(const n of e){const e=n.currentState.getStateEvents(P.b.RoomCreate,"");if(e){const n=e.getContent().predecessor;n&&n.room_id&&t.add(n.room_id)}}return e.filter(e=>!e.currentState.getStateEvents(P.b.RoomTombstone,"")||!t.has(e.roomId))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t,n){const i=m.n("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e}),s=Object(w.n)(5,()=>this.http.authedRequest(void 0,w.f.Put,i,void 0,t));return n&&s.then(e=>n(null,e),n),s}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=m.n("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(void 0,w.f.Get,t)}catch(e){var n;if("M_NOT_FOUND"===(null===(n=e.data)||void 0===n?void 0:n.errcode))return null;throw e}}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e,t){const n={ignored_users:{}};return e.forEach(e=>{n.ignored_users[e]={}}),this.setAccountData("m.ignored_user_list",n,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e,t,n){if(m.s(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);const i=this.getRoom(e);if(i&&i.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(i);let s=Promise.resolve();t.inviteSignUrl&&(s=this.http.requestOtherUrl(void 0,w.f.Post,t.inviteSignUrl,{mxid:this.credentials.userId}));const o={};t.viaServers&&(o.server_name=t.viaServers);const a={qsStringifyOptions:{arrayFormat:"repeat"}};try{const i={},c=await s;c&&(i.third_party_signed=c);const l=m.n("/join/$roomid",{$roomid:e}),d=(await this.http.authedRequest(void 0,w.f.Post,l,o,i,a)).room_id,u=new r.a(this,this.clientOpts).createRoom(d);return t.syncRoom,null==n||n(null,u),u}catch(e){throw null==n||n(e),e}}resendEvent(e,t){return this.updatePendingEventStatus(t,e,c.a.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![c.a.QUEUED,c.a.NOT_SENT,c.a.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===c.a.ENCRYPTING?this.pendingEventEncryption.delete(e.getId()):this.scheduler&&e.status===c.a.QUEUED&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,c.a.CANCELLED)}setRoomName(e,t,n){return this.sendStateEvent(e,P.b.RoomName,{name:t},void 0,n)}setRoomTopic(e,t,n){const i="function"==typeof n,s=i?void 0:n,o=i?n:void 0,r=N.makeTopicContent(t,s);return this.sendStateEvent(e,P.b.RoomTopic,r,void 0,o)}getRoomTags(e,t){const n=m.n("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(t,w.f.Get,n)}setRoomTag(e,t,n,i){const s=m.n("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(i,w.f.Put,s,void 0,n)}deleteRoomTag(e,t,n){const i=m.n("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(n,w.f.Delete,i)}setRoomAccountData(e,t,n,i){const s=m.n("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(i,w.f.Put,s,void 0,n)}setPowerLevel(e,t,n,i,s){let o={users:{}};(null==i?void 0:i.getType())===P.b.RoomPowerLevels&&(o=m.j(i.getContent())),o.users[t]=n;const r=m.n("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this.http.authedRequest(s,w.f.Put,r,void 0,o)}async unstable_createLiveBeacon(e,t){return this.unstable_setLiveBeacon(e,t)}async unstable_setLiveBeacon(e,t){const n=this.getUserId();return this.sendStateEvent(e,q.b.name,t,n)}sendEvent(e,t,n,i,s,o){var r,a;if(null!==(r=t)&&void 0!==r&&r.startsWith("$")||null===t||(o=s,s=i,i=n,n=t,t=null),t&&(null===(a=i["m.relates_to"])||void 0===a||!a.rel_type)){var c;i["m.relates_to"]=G(G({},i["m.relates_to"]),{},{rel_type:H.c.name,event_id:t});const n=null===(c=this.getRoom(e))||void 0===c?void 0:c.getThread(t);var l;if(n)i["m.relates_to"]["m.in_reply_to"]={event_id:null===(l=n.lastReply(e=>e.isRelation(H.c.name)&&!e.status))||void 0===l?void 0:l.getId()}}return this.sendCompleteEvent(e,t,{type:n,content:i},s,o)}sendCompleteEvent(e,t,n,i,s){m.s(i)&&(s=i,i=void 0),i||(i=this.makeTxnId());const o=new c.b(Object.assign(n,{event_id:"~"+e+":"+i,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),r=this.getRoom(e),a=null==r?void 0:r.getThread(t);a&&o.setThread(a),this.reEmitter.reEmit(o,[c.c.Replaced,c.c.VisibilityChange]),null==r||r.reEmitter.reEmit(o,[c.c.BeforeRedaction]);const l=o.getAssociatedId();if(null!=l&&l.startsWith("~")){const e=r.getPendingEvents().find(e=>e.getId()===l);e.once(c.c.LocalEventIdReplaced,()=>{o.updateAssociatedId(e.getId())})}const d=o.getType();return S.a.log(`sendEvent of type ${d} in ${e} with txnId ${i}`),o.setTxnId(i),o.setStatus(c.a.SENDING),null==r||r.addPendingEvent(o,i),o.status===c.a.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(r,o,s)}encryptAndSendEvent(e,t,n){let i=!1;return Promise.resolve().then(()=>{const n=this.encryptEventIfNeeded(t,e);return n?(this.pendingEventEncryption.set(t.getId(),n),this.updatePendingEventStatus(e,t,c.a.ENCRYPTING),n.then(()=>{this.pendingEventEncryption.has(t.getId())?this.updatePendingEventStatus(e,t,c.a.SENDING):i=!0})):null}).then(()=>{if(i)return{};let n;return this.scheduler&&(n=this.scheduler.queueEvent(t),n&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,c.a.QUEUED)),n||(n=this.useWebSockets&&this.websocketApi?this.websocketApi.sendEvent(t):this.sendEventHttpRequest(t),e&&(n=n.then(n=>(e.updatePendingEvent(t,c.a.SENT,n.event_id),n)))),n}).then(e=>(null==n||n(null,e),e)).catch(i=>{S.a.error("Error sending event",i.stack||i);try{t.error=i,this.updatePendingEventStatus(e,t,c.a.NOT_SENT),i.event=t,null==n||n(i)}catch(e){S.a.error("Exception in error handler!",e.stack||i)}throw i})}encryptEventIfNeeded(e,t){if(e.isEncrypted())return null;if(e.isRedaction())return null;if(!this.isRoomEncrypted(e.getRoomId()))return null;if(!this.crypto&&this.usingExternalCrypto)return null;if(e.getType()===P.b.Reaction)return null;if(!this.crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return this.crypto.encryptEvent(e,t)}getEncryptedIfNeededEventType(e,t){return t===P.b.Reaction?t:this.isRoomEncrypted(e)?P.b.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));const n={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};let i;if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),i=m.n(t,n)}else if(e.isRedaction()){const t="/rooms/$roomId/redact/$redactsEventId/$txnId";i=m.n(t,Object.assign({$redactsEventId:e.event.redacts},n))}else i=m.n("/rooms/$roomId/send/$eventType/$txnId",n);return this.http.authedRequest(void 0,w.f.Put,i,void 0,e.getWireContent()).then(t=>(S.a.log(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t))}redactEvent(e,t,n,i,s){var o;null!==(o=n)&&void 0!==o&&o.startsWith("$")||(s=i,i=n,n=t,t=null);const r=("object"==typeof s?s:{}).reason,a="function"==typeof s?s:void 0;return this.sendCompleteEvent(e,t,{type:P.b.RoomRedaction,content:{reason:r},redacts:n},i,a)}sendMessage(e,t,n,i,s){"string"!=typeof t&&null!==t&&(s=i,i=n,n=t,t=null),m.s(i)&&(s=i,i=void 0);let r=P.b.RoomMessage,a=n;const c=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=null;if(e.msgtype===P.c.Text?n=o.MessageEvent.from(e.body,e.formatted_body).serialize():e.msgtype===P.c.Emote?n=o.EmoteEvent.from(e.body,e.formatted_body).serialize():e.msgtype===P.c.Notice&&(n=o.NoticeEvent.from(e.body,e.formatted_body).serialize()),n&&e["m.new_content"]&&t){const t=c(e["m.new_content"],!1);t&&(n.content["m.new_content"]=t.content)}if(n)for(const[t,i]of Object.entries(e))n.content.hasOwnProperty(t)||(n.content[t]=i);return n},l=c(a);return l&&(r=l.type,a=l.content),this.sendEvent(e,t,r,a,i,s)}sendTextMessage(e,t,n,i,s){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(s=i,i=n,n=t,t=null);const r=N.makeTextMessage(n);return this.sendMessage(e,t,r,i,s)}sendNotice(e,t,n,i,s){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(s=i,i=n,n=t,t=null);const r=N.makeNotice(n);return this.sendMessage(e,t,r,i,s)}sendEmoteMessage(e,t,n,i,s){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(s=i,i=n,n=t,t=null);const r=N.makeEmoteMessage(n);return this.sendMessage(e,t,r,i,s)}sendImageMessage(e,t,n,i){var s;let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Image",r=arguments.length>5?arguments[5]:void 0;null!==(s=t)&&void 0!==s&&s.startsWith("$")||null===t||(r=o,o=i||"Image",i=n,n=t,t=null),m.s(o)&&(r=o,o=void 0);const a={msgtype:P.c.Image,url:n,info:i,body:o};return this.sendMessage(e,t,a,void 0,r)}sendStickerMessage(e,t,n,i){var s;let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Sticker",r=arguments.length>5?arguments[5]:void 0;null!==(s=t)&&void 0!==s&&s.startsWith("$")||null===t||(r=o,o=i||"Sticker",i=n,n=t,t=null),m.s(o)&&(r=o,o=void 0);const a={url:n,info:i,body:o};return this.sendEvent(e,t,P.b.Sticker,a,void 0,r)}sendHtmlMessage(e,t,n,i,s){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(s=i,i=n,n=t,t=null);const r=N.makeHtmlMessage(n,i);return this.sendMessage(e,t,r,void 0,s)}sendHtmlNotice(e,t,n,i,s){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(s=i,i=n,n=t,t=null);const r=N.makeHtmlNotice(n,i);return this.sendMessage(e,t,r,void 0,s)}sendHtmlEmote(e,t,n,i,s){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(s=i,i=n,n=t,t=null);const r=N.makeHtmlEmote(n,i);return this.sendMessage(e,t,r,void 0,s)}sendReceipt(e,t,n,i){if("function"==typeof n&&(i=n,n={}),this.isGuest())return Promise.resolve({});const s=m.n("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),o=this.http.authedRequest(i,w.f.Post,s,void 0,n||{}),r=this.getRoom(e.getRoomId());return r&&r.addLocalEchoReceipt(this.credentials.userId,e,t),o}async sendReadReceipt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:W.a.Read,n=arguments.length>2?arguments[2]:void 0;const i=e.getId(),s=this.getRoom(e.getRoomId());if(s&&s.hasPendingEvent(i))throw new Error(`Cannot set read receipt to a pending event (${i})`);return this.sendReceipt(e,t,{},n)}async setRoomReadMarkers(e,t,n,i){const s=this.getRoom(e);if(s&&s.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let o,r;if(n){if(o=n.getId(),null!=s&&s.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);null==s||s.addLocalEchoReceipt(this.credentials.userId,n,W.a.Read)}if(i){if(r=i.getId(),null!=s&&s.hasPendingEvent(r))throw new Error(`Cannot set read receipt to a pending event (${r})`);null==s||s.addLocalEchoReceipt(this.credentials.userId,i,W.a.ReadPrivate)}return this.useWebSockets&&this.websocketApi?this.websocketApi.sendReadMarkers(e,t,o,r):this.setRoomReadMarkersHttpRequest(e,t,o,r)}getUrlPreview(e,t,n){t=6e4*Math.floor(t/6e4);const i=new URL(e);i.hash="";const s=t+"_"+(e=i.toString()),o=this.urlPreviewCache[s];if(o)return n&&o.then(n).catch(n),o;const r=this.http.authedRequest(n,w.f.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:w.i});return this.urlPreviewCache[s]=r,r}sendTyping(e,t,n,i){if(this.isGuest())return Promise.resolve({});if(this.useWebSockets&&this.websocketApi)return this.websocketApi.sendTyping(e,t,n,i);const s=m.n("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),o={typing:t};return t&&(o.timeout=n||2e4),this.http.authedRequest(i,w.f.Put,s,void 0,o)}getRoomUpgradeHistory(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.getRoom(e);if(!n)return[];const i=[n];let s=n.currentState.getStateEvents(P.b.RoomCreate,"");for(;s;){const e=s.getContent().predecessor;if(!e||!e.room_id)break;{const n=this.getRoom(e.room_id);if(!n)break;if(t){const e=n.currentState.getStateEvents(P.b.RoomTombstone,"");if(!e||e.getContent().replacement_room!==n.roomId)break}i.splice(0,0,n),s=n.currentState.getStateEvents(P.b.RoomCreate,"")}}let o=n.currentState.getStateEvents(P.b.RoomTombstone,"");for(;o;){const e=this.getRoom(o.getContent().replacement_room);if(!e)break;if(e.roomId===n.roomId)break;if(t){if(s=e.currentState.getStateEvents(P.b.RoomCreate,""),!s||!s.getContent().predecessor)break;if(s.getContent().predecessor.room_id!==n.roomId)break}i.push(e);if(new Set(i.map(e=>e.roomId)).size<i.length)return i.slice(0,i.length-1);n=e,o=n.currentState.getStateEvents(P.b.RoomTombstone,"")}return i}invite(e,t,n,i){return this.membershipChange(e,t,"invite",i,n)}inviteByEmail(e,t,n){return this.inviteByThreePid(e,"email",t,n)}async inviteByThreePid(e,t,n,i){const s=m.n("/rooms/$roomId/invite",{$roomId:e}),o=this.getIdentityServerUrl(!0);if(!o)return Promise.reject(new w.d({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const r={id_server:o,medium:t,address:n};if(this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(r.id_access_token=e)}return this.http.authedRequest(i,w.f.Post,s,void 0,r)}leave(e,t){return this.membershipChange(e,void 0,"leave",void 0,t)}leaveRoomChain(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=this.getRoomUpgradeHistory(e);let i=n;if(!t){i=[];for(const t of n)if(i.push(t),t.roomId===e)break}const s={},o=[],r=e=>this.leave(e).then(()=>{s[e]=null}).catch(t=>(s[e]=t,null));for(const e of i)o.push(r(e.roomId));return Promise.all(o).then(()=>s)}ban(e,t,n,i){return this.membershipChange(e,t,"ban",n,i)}forget(e,t,n){void 0===t&&(t=!0);const i=this.membershipChange(e,void 0,"forget",void 0,n);return t?i.then(t=>(this.store.removeRoom(e),this.emit(X.DeleteRoom,e),t)):i}unban(e,t,n){const i=m.n("/rooms/$roomId/unban",{$roomId:e}),s={user_id:t};return this.http.authedRequest(n,w.f.Post,i,void 0,s)}kick(e,t,n,i){const s=m.n("/rooms/$roomId/kick",{$roomId:e}),o={user_id:t,reason:n};return this.http.authedRequest(i,w.f.Post,s,void 0,o)}membershipChange(e,t,n,i,s){m.s(i)&&(s=i,i=void 0);const o=m.n("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest(s,w.f.Post,o,void 0,{user_id:t,reason:i})}getPushActionsForEvent(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e.getPushActions()&&!t||e.setPushActions(this.pushProcessor.actionsForEvent(e)),e.getPushActions()}setProfileInfo(e,t,n){const i=m.n("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(n,w.f.Put,i,void 0,t)}async setDisplayName(e,t){const n=await this.setProfileInfo("displayname",{displayname:e},t),i=this.getUser(this.getUserId());return i&&(i.displayName=e,i.emit(R.b.DisplayName,i.events.presence,i)),n}async setAvatarUrl(e,t){const n=await this.setProfileInfo("avatar_url",{avatar_url:e},t),i=this.getUser(this.getUserId());return i&&(i.avatarUrl=e,i.emit(R.b.AvatarUrl,i.events.presence,i)),n}mxcUrlToHttp(e,t,n,i,s){return Object(I.a)(this.baseUrl,e,t,n,i,s)}setPresence(e,t){const n=m.n("/presence/$userId/status",{$userId:this.credentials.userId});"string"==typeof e&&(e={presence:e});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this.useWebSockets&&this.websocketApi?this.websocketApi.sendPresence(e):this.http.authedRequest(t,w.f.Put,n,void 0,e)}getPresence(e,t){const n=m.n("/presence/$userId/status",{$userId:e});return this.http.authedRequest(t,w.f.Get,n)}scrollback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,n=arguments.length>2?arguments[2]:void 0;m.s(t)&&(n=t,t=void 0);let i=0,s=this.ongoingScrollbacks[e.roomId]||{};if(s.promise)return s.promise;if(s.errorTs){const e=Date.now()-s.errorTs;i=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t-=o;const r=new Promise((s,o)=>{Object(m.G)(i).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,p.a.Backward)).then(t=>{var i;const o=t.chunk.map(this.getEventMapper());if(t.state){const n=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(n)}const[r,a]=e.partitionThreadedEvents(o);this.processBeaconEvents(e,r),e.addEventsToTimeline(r,!0,e.getLiveTimeline()),this.processThreadEvents(e,a,!0),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,o,t.end,!0),this.ongoingScrollbacks[e.roomId]=null,null===(i=n)||void 0===i||i(null,e),s(e)}).catch(t=>{var i;this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},null===(i=n)||void 0===i||i(t),o(t)})});return s={promise:r,errorTs:null},this.ongoingScrollbacks[e.roomId]=s,r}getEventMapper(e){return Object(A.a)(this,e||{})}async getEventTimeline(e,t){var n,i,s;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const o=m.n("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let r=void 0;this.clientOpts.lazyLoadMembers&&(r={filter:JSON.stringify(u.a.LAZY_LOADING_MESSAGES_FILTER)});const a=await this.http.authedRequest(void 0,w.f.Get,o,r);if(!a.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const c=this.getEventMapper(),l=c(a.event),d=[...a.events_after.reverse().map(c),l,...a.events_before.map(c)];if(H.d.hasServerSideSupport&&this.supportsExperimentalThreads()&&l.isRelation(H.c.name)){const[,n]=e.room.partitionThreadedEvents(d);let i=e.room.getThread(l.threadRootId);i||(i=e.room.createThread(l.threadRootId,void 0,n,!0));const s={direction:p.a.Backward,limit:50};await i.fetchInitialEvents();let o=i.liveTimeline.getPaginationToken(p.a.Backward);for(;!i.findEventById(t)&&(o&&(s.from=o),({nextBatch:o}=await i.fetchEvents(s)),o););return i.liveTimeline}let h=e.getTimelineForEvent(d[0].getId());h?h.getState(p.b.BACKWARDS).setUnknownStateEvents(a.state.map(c)):(h=e.addTimeline(),h.initialiseState(a.state.map(c)),h.getState(p.b.FORWARDS).paginationToken=a.end);const[g,f]=e.room.partitionThreadedEvents(d);return e.addEventsToTimeline(g,!0,h,a.start),this.processThreadEvents(e.room,f,!0),this.processBeaconEvents(e.room,g),null!==(n=null!==(i=e.getTimelineForEvent(t))&&void 0!==i?i:null===(s=e.room.findThreadForEvent(l))||void 0===s?void 0:s.liveTimeline)&&void 0!==n?n:h}createMessagesRequest(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,i=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;const o=m.n("/rooms/$roomId/messages",{$roomId:e}),r={limit:n.toString(),dir:i};t&&(r.from=t);let a=null;var c;(this.clientOpts.lazyLoadMembers&&(a=Object.assign({},u.a.LAZY_LOADING_MESSAGES_FILTER)),s)&&(a=a||{},Object.assign(a,null===(c=s.getRoomTimelineFilterComponent())||void 0===c?void 0:c.toJSON()));return a&&(r.filter=JSON.stringify(a)),this.http.authedRequest(void 0,w.f.Get,o,r)}paginateEventTimeline(e,t){const n=e.getTimelineSet()===this.notifTimelineSet,i=(t=t||{}).backwards||!1;if(n&&!i)throw new Error("paginateNotifTimeline can only paginate backwards");const s=i?p.b.BACKWARDS:p.b.FORWARDS,o=e.getPaginationToken(s),r=e.paginationRequests[s];if(r)return r;let a,c,l;if(n){var d;a="/notifications",c={limit:(null!==(d=t.limit)&&void 0!==d?d:30).toString(),only:"highlight"},"end"!==o&&(c.from=o),l=this.http.authedRequest(void 0,w.f.Get,"/notifications",c).then(async t=>{const n=t.next_token,o=[];for(let e=0;e<t.notifications.length;e++){const n=t.notifications[e],i=this.getEventMapper()(n.event);i.setPushActions(g.a.actionListToActionsObject(n.actions)),i.event.room_id=n.room_id,o[e]=i}const r=e.getTimelineSet();return r.addEventsToTimeline(o,i,e,n),this.processBeaconEvents(r.room,o),i&&!t.next_token&&e.setPaginationToken(null,s),!!t.next_token}).finally(()=>{e.paginationRequests[s]=null}),e.paginationRequests[s]=l}else{const n=this.getRoom(e.getRoomId());if(!n)throw new Error("Unknown room "+e.getRoomId());l=this.createMessagesRequest(e.getRoomId(),o,t.limit,s,e.getFilter()).then(t=>{if(t.state){const n=e.getState(s),i=t.state.map(this.getEventMapper());n.setUnknownStateEvents(i)}const o=t.end,r=t.chunk.map(this.getEventMapper()),a=e.getTimelineSet(),[c,l]=a.room.partitionThreadedEvents(r);return a.addEventsToTimeline(c,i,e,o),this.processBeaconEvents(a.room,c),this.processThreadEvents(n,l,i),i&&t.end==t.start&&e.setPaginationToken(null,s),t.end!=t.start}).finally(()=>{e.paginationRequests[s]=null}),e.paginationRequests[s]=l}return l}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end",null)}peekInRoom(e){return this.peekSync&&this.peekSync.stopPeeking(),this.peekSync=new r.a(this,this.clientOpts),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const n=this.sendStateEvent(e,P.b.RoomGuestAccess,{guest_access:t.allowJoin?"can_join":"forbidden"},"");let i=Promise.resolve(void 0);return t.allowRead&&(i=this.sendStateEvent(e,P.b.RoomHistoryVisibility,{history_visibility:"world_readable"},"")),Promise.all([i,n]).then()}requestRegisterEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestRegisterMsisdnToken(e,t,n,i,s){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:s})}requestAdd3pidEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestAdd3pidMsisdnToken(e,t,n,i,s){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:s})}requestPasswordEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestPasswordMsisdnToken(e,t,n,i,s){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:s})}async requestTokenFromEndpoint(e,t){const n=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){var i;const e=new URL(this.idBaseUrl);if(n.id_server=e.host,null!==(i=this.identityServer)&&void 0!==i&&i.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(n.id_access_token=e)}}return this.http.request(void 0,w.f.Post,e,void 0,n)}getRoomPushRule(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(let n=0;n<this.pushRules[e].room.length;n++){const i=this.pushRules[e].room[n];if(i.rule_id===t)return i}}setRoomMutePushRule(e,t,n){let i,s=!1;const o=this.getRoomPushRule(e,t);if(null!=o&&o.actions.includes(T.PushRuleActionName.DontNotify)&&(s=!0),n)if(o){if(!s){const n=m.l();this.deletePushRule(e,B.e.RoomSpecific,o.rule_id).then(()=>{this.addPushRule(e,B.e.RoomSpecific,t,{actions:[T.PushRuleActionName.DontNotify]}).then(()=>{n.resolve()}).catch(e=>{n.reject(e)})}).catch(e=>{n.reject(e)}),i=n.promise}}else i=this.addPushRule(e,B.e.RoomSpecific,t,{actions:[T.PushRuleActionName.DontNotify]});else s&&(i=this.deletePushRule(e,B.e.RoomSpecific,o.rule_id));if(i)return new Promise((e,t)=>{i.then(()=>{this.getPushRules().then(t=>{this.pushRules=t,e()}).catch(e=>{t(e)})}).catch(e=>{this.getPushRules().then(n=>{this.pushRules=n,t(e)}).catch(n=>{t(e)})})})}searchMessageText(e,t){const n={search_term:e.query};return"keys"in e&&(n.keys=e.keys),this.search({body:{search_categories:{room_events:n}}},t)}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:F.a.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then(e=>this.processRoomEventsSearch(n,e))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},n=this.search(t).then(t=>this.processRoomEventsSearch(e,t)).finally(()=>{e.pendingRequest=null});return e.pendingRequest=n,n}processRoomEventsSearch(e,t){var n,i;const s=t.search_categories.room_events;e.count=s.count,e.next_batch=s.next_batch;const o=new Set(s.highlights);e.highlights.forEach(e=>{o.add(e)}),e.highlights=Array.from(o);const r=this.getEventMapper(),a=null!==(n=null===(i=s.results)||void 0===i?void 0:i.length)&&void 0!==n?n:0;for(let t=0;t<a;t++){const n=k.a.fromJson(s.results[t],r),i=this.getRoom(n.context.getEvent().getRoomId());if(i)for(const e of n.context.getTimeline()){const t=i.getMember(e.getSender());!e.sender&&t&&(e.sender=t)}e.results.push(n)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new r.a(this,this.clientOpts);return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{S.a.log("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=null}),this.syncLeftRoomsPromise}createFilter(e){const t=m.n("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,w.f.Post,t,void 0,e).then(t=>{const n=u.a.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(n),n})}getFilter(e,t,n){if(n){const n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}const i=m.n("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(void 0,w.f.Get,i).then(n=>{const i=u.a.fromJson(e,t,n);return this.store.storeFilter(i),i})}async getOrCreateFilter(e,t){const n=this.store.getFilterIdByName(e);let i=void 0;if(n){try{const e=await this.getFilter(this.credentials.userId,n,!0);if(e){const s=e.getDefinition(),o=t.getDefinition();m.i(s,o)&&(i=n)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}i||this.store.setFilterIdByName(e,void 0)}if(i)return i;const s=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,s.filterId),s.filterId}getOpenIdToken(){const e=m.n("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,w.f.Post,e,void 0,{})}turnServer(e){return this.http.authedRequest(e,w.f.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}async checkTurnServers(){if(!this.canSupportVoip)return;let t=!1;const n=this.turnServersExpiry-Date.now();if(n>6e5)S.a.debug("TURN creds are valid for another "+n+" ms: not fetching new ones."),t=!0;else{S.a.debug("Fetching new TURN credentials");try{const e=await this.turnServer();if(e.uris){S.a.log("Got TURN URIs: "+e.uris+" refresh in "+e.ttl+" secs");const n={urls:e.uris,username:e.username,credential:e.password};this.turnServers=[n],this.turnServersExpiry=Date.now()+1e3*e.ttl,t=!0}}catch(t){S.a.error("Failed to get TURN URIs",t),403===t.httpStatus&&(S.a.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&e.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=null)}}return t}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=m.n("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(void 0,w.f.Get,e,void 0,void 0,{prefix:""}).then(e=>e.admin)}whoisSynapseUser(e){const t=m.n("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(void 0,w.f.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=m.n("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(void 0,w.f.Post,t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){this.clientWellKnownPromise=f.a.getRawClientConfig(this.getDomain()),this.clientWellKnown=await this.clientWellKnownPromise,this.emit(X.ClientWellKnown,this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(t=>{let[n,i]=t;return e.includes(typeof i)}).reduce((e,t)=>{let[n,i]=t;return e[n]=i,e},{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){const t=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"),n=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.mutual_rooms");if(!t&&!n)throw Error("Server does not support mutual_rooms API");const i=m.n(`/uk.half-shot.msc2666/user/${n?"mutual_rooms":"shared_rooms"}/$userId`,{$userId:e});return(await this.http.authedRequest(void 0,w.f.Get,i,void 0,void 0,{prefix:w.k})).joined}getVersions(){return this.serverVersionsPromise||(this.serverVersionsPromise=this.http.request(void 0,w.f.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(e=>{throw this.serverVersionsPromise=null,e})),this.serverVersionsPromise}async isVersionSupported(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportLazyLoading(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,n=e.unstable_features;return t&&t.includes("r0.5.0")||n&&n["m.lazy_load_members"]}async doesServerRequireIdServerParam(){const e=await this.getVersions();if(!e)return!0;const t=e.versions;if(t&&t.includes("r0.6.0"))return!1;const n=e.unstable_features;return!n||(void 0===n["m.require_identity_server"]||n["m.require_identity_server"])}async doesServerAcceptIdentityAccessToken(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,n=e.unstable_features;return t&&t.includes("r0.6.0")||n&&n["m.id_access_token"]}async doesServerSupportSeparateAddAndBind(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,n=e.unstable_features;return(null==t?void 0:t.includes("r0.6.0"))||(null==n?void 0:n["m.separate_add_and_bind"])}async doesServerSupportUnstableFeature(e){const t=await this.getVersions();if(!t)return!1;const n=t.unstable_features;return n&&!!n[e]}async doesServerForceEncryptionForPreset(e){const t=await this.getVersions();if(!t)return!1;const n=t.unstable_features,i=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n["io.element.e2ee_forced."+i]}async doesServerSupportThread(){try{const e=await this.doesServerSupportUnstableFeature("org.matrix.msc3440"),t=await this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable");return{serverSupport:e||t,stable:t}}catch(e){return null}}doesServerSupportLogoutDevices(){return this.isVersionSupported("r0.6.1")}hasLazyLoadMembersEnabled(){return!!this.clientOpts.lazyLoadMembers}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,n,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{direction:p.a.Backward};const o=this.getEncryptedIfNeededEventType(e,i),r=await this.fetchRelations(e,t,n,o,s),a=this.getEventMapper(),c=r.original_event?a(r.original_event):void 0;let l=r.chunk.map(a);if(o===P.b.RoomMessageEncrypted){const e=c?l.concat(c):l;await Promise.all(e.map(e=>this.decryptEventIfNeeded(e))),null!==i&&(l=l.filter(e=>e.getType()===i))}return c&&n===P.d.Replace&&(l=l.filter(e=>e.getSender()===c.getSender())),{originalEvent:c,events:l,nextBatch:r.next_batch,prevBatch:r.prev_batch}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return Object(M.b)(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&e.attemptDecryption(this.crypto,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case E.a.IS:return t+w.h+"/terms";case E.a.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=m.o(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}setAccessToken(e){this.http.opts.accessToken=e}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(void 0,w.f.Get,"/register/available",{username:e}).then(e=>e.available).catch(e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e))}register(e,t,n,i,s,o,r,a){!0===s?s={email:!0}:null!=s&&!1!==s||(s={}),"function"==typeof r&&(a=r,r=void 0),n&&(i.session=n);const c={auth:i,refresh_token:!0};return null!=e&&(c.username=e),null!=t&&(c.password=t),s.email&&(c.bind_email=!0),s.msisdn&&(c.bind_msisdn=!0),null!=o&&(c.guest_access_token=o),null!=r&&(c.inhibit_login=r),null!=t&&(c.x_show_msisdn=!0),this.registerRequest(c,void 0,a)}registerGuest(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)}registerRequest(e,t,n){const i={};return t&&(i.kind=t),this.http.request(n,w.f.Post,"/register",i,e)}refreshToken(e){return this.http.authedRequest(void 0,w.f.Post,"/refresh",void 0,{refresh_token:e},{prefix:w.l,inhibitLogoutEmit:!0})}loginFlows(e){return this.http.request(e,w.f.Get,"/login")}login(e,t,n){const i={type:e};return Object.assign(i,t),this.http.authedRequest((e,t)=>{t&&t.access_token&&t.user_id&&(this.http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),n&&n(e,t)},w.f.Post,"/login",void 0,i)}loginWithPassword(e,t,n){return this.login("m.login.password",{user:e,password:t},n)}loginWithSAML2(e,t){return this.login("m.login.saml2",{relay_state:e},t)}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){let t=arguments.length>2?arguments[2]:void 0,n="/login/"+(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sso")+"/redirect";return t&&(n+="/"+t),this.http.getUrl(n,{redirectUrl:e},w.j)}loginWithToken(e,t){return this.login("m.login.token",{token:e},t)}async logout(e){var t,n;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(null!==(t=this.crypto)&&void 0!==t&&null!==(n=t.backupManager)&&void 0!==n&&n.getKeyBackupEnabled())try{for(;await this.crypto.backupManager.backupPendingKeys(200)>0;);}catch(e){S.a.error("Key backup request failed when logging out. Some keys may be missing from backup",e)}return i&&this.stopClient(),this.http.authedRequest(e,w.f.Post,"/logout")}deactivateAccount(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const n={};return e&&(n.auth=e),void 0!==t&&(n.erase=t),this.http.authedRequest(void 0,w.f.Post,"/account/deactivate",void 0,n)}getFallbackAuthUrl(e,t){const n=m.n("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(n,{session:t},w.j)}async createRoom(e,t){const n=(e.invite_3pid||[]).filter(e=>!e.id_access_token);if(n.length>0&&this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();if(e)for(const t of n)t.id_access_token=e}return this.http.authedRequest(t,w.f.Post,"/createRoom",void 0,e)}fetchRelations(e,t,n,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{direction:p.a.Backward};const o=m.m(s);let r="/rooms/$roomId/relations/$eventId";null!==n?(r+="/$relationType",null!==i&&(r+="/$eventType")):null!==i&&(S.a.warn(`eventType: ${i} ignored when fetching\n            relations as relationType is null`),i=null);const a=m.n(r+"?"+o,{$roomId:e,$eventId:t,$relationType:n,$eventType:i});return this.http.authedRequest(void 0,w.f.Get,a,null,null,{prefix:w.k})}roomState(e,t){const n=m.n("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(t,w.f.Get,n)}fetchRoomEvent(e,t,n){const i=m.n("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(n,w.f.Get,i)}members(e,t,n,i,s){const o={};t&&(o.membership=t),n&&(o.not_membership=n),i&&(o.at=i);const r=m.m(o),a=m.n("/rooms/$roomId/members?"+r,{$roomId:e});return this.http.authedRequest(s,w.f.Get,a)}upgradeRoom(e,t){const n=m.n("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(void 0,w.f.Post,n,void 0,{new_version:t})}getStateEvent(e,t,n,i){const s={$roomId:e,$eventType:t,$stateKey:n};let o=m.n("/rooms/$roomId/state/$eventType",s);return void 0!==n&&(o=m.n(o+"/$stateKey",s)),this.http.authedRequest(i,w.f.Get,o)}sendStateEvent(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",s=arguments.length>4?arguments[4]:void 0;const o={$roomId:e,$eventType:t,$stateKey:i};let r=m.n("/rooms/$roomId/state/$eventType",o);return void 0!==i&&(r=m.n(r+"/$stateKey",o)),this.http.authedRequest(s,w.f.Put,r,void 0,n)}roomInitialSync(e,t,n){var i,s;m.s(t)&&(n=t,t=void 0);const o=m.n("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(n,w.f.Get,o,{limit:null!==(i=null===(s=t)||void 0===s?void 0:s.toString())&&void 0!==i?i:"30"})}setRoomReadMarkersHttpRequest(e,t,n,i){const s=m.n("/rooms/$roomId/read_markers",{$roomId:e}),o={[W.a.FullyRead]:t,[W.a.Read]:n,[W.a.ReadPrivate]:i};return this.http.authedRequest(void 0,w.f.Post,s,void 0,o)}getJoinedRooms(){const e=m.n("/joined_rooms",{});return this.http.authedRequest(void 0,w.f.Get,e)}getJoinedRoomMembers(e){const t=m.n("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(void 0,w.f.Get,t)}publicRooms(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const n={};return e.server&&(n.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(n).length?this.http.authedRequest(t,w.f.Get,"/publicRooms"):this.http.authedRequest(t,w.f.Post,"/publicRooms",n,e)}createAlias(e,t,n){const i=m.n("/directory/room/$alias",{$alias:e}),s={room_id:t};return this.http.authedRequest(n,w.f.Put,i,void 0,s)}deleteAlias(e,t){const n=m.n("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,w.f.Delete,n)}getLocalAliases(e){const t=m.n("/rooms/$roomId/aliases",{$roomId:e}),n=w.m;return this.http.authedRequest(void 0,w.f.Get,t,null,null,{prefix:n})}getRoomIdForAlias(e,t){const n=m.n("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,w.f.Get,n)}resolveRoomAlias(e,t){const n=m.n("/directory/room/$alias",{$alias:e});return this.http.request(t,w.f.Get,n)}getRoomDirectoryVisibility(e,t){const n=m.n("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(t,w.f.Get,n)}setRoomDirectoryVisibility(e,t,n){const i=m.n("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(n,w.f.Put,i,void 0,{visibility:t})}setRoomDirectoryVisibilityAppService(e,t,n,i){const s=m.n("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this.http.authedRequest(i,w.f.Put,s,void 0,{visibility:n})}searchUserDirectory(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this.http.authedRequest(void 0,w.f.Post,"/user_directory/search",void 0,t)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t,n){m.s(t)&&(n=t,t=void 0);const i=t?m.n("/profile/$userId/$info",{$userId:e,$info:t}):m.n("/profile/$userId",{$userId:e});return this.http.authedRequest(n,w.f.Get,i)}getThreePids(e){return this.http.authedRequest(e,w.f.Get,"/account/3pid")}addThreePid(e,t,n){const i={threePidCreds:e,bind:t};return this.http.authedRequest(n,w.f.Post,"/account/3pid",null,i)}async addThreePidOnly(e){const t=await this.isVersionSupported("r0.6.0")?w.j:w.k;return this.http.authedRequest(void 0,w.f.Post,"/account/3pid/add",null,e,{prefix:t})}async bindThreePid(e){const t=await this.isVersionSupported("r0.6.0")?w.j:w.k;return this.http.authedRequest(void 0,w.f.Post,"/account/3pid/bind",null,e,{prefix:t})}async unbindThreePid(e,t){const n={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},i=await this.isVersionSupported("r0.6.0")?w.j:w.k;return this.http.authedRequest(void 0,w.f.Post,"/account/3pid/unbind",null,n,{prefix:i})}deleteThreePid(e,t){return this.http.authedRequest(void 0,w.f.Post,"/account/3pid/delete",null,{medium:e,address:t})}setPassword(e,t,n,i){"function"==typeof n&&(i=n),"boolean"!=typeof n&&(n=void 0);const s={auth:e,new_password:t,logout_devices:n};return this.http.authedRequest(i,w.f.Post,"/account/password",null,s)}getDevices(){return this.http.authedRequest(void 0,w.f.Get,"/devices")}getDevice(e){const t=m.n("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,w.f.Get,t)}setDeviceDetails(e,t){const n=m.n("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,w.f.Put,n,void 0,t)}deleteDevice(e,t){const n=m.n("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this.http.authedRequest(void 0,w.f.Delete,n,void 0,i)}deleteMultipleDevices(e,t){const n={devices:e};t&&(n.auth=t);return this.http.authedRequest(void 0,w.f.Post,"/delete_devices",void 0,n)}getPushers(e){return this.http.authedRequest(e,w.f.Get,"/pushers")}setPusher(e,t){return this.http.authedRequest(t,w.f.Post,"/pushers/set",null,e)}getPushRules(e){return this.http.authedRequest(e,w.f.Get,"/pushrules/").then(e=>g.a.rewriteDefaultRules(e))}addPushRule(e,t,n,i,s){const o=m.n("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(s,w.f.Put,o,void 0,i)}deletePushRule(e,t,n,i){const s=m.n("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(i,w.f.Delete,s)}setPushRuleEnabled(e,t,n,i,s){const o=m.n("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this.http.authedRequest(s,w.f.Put,o,void 0,{enabled:i})}setPushRuleActions(e,t,n,i,s){const o=m.n("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this.http.authedRequest(s,w.f.Put,o,void 0,{actions:i})}search(e,t){const n={};return e.next_batch&&(n.next_batch=e.next_batch),this.http.authedRequest(t,w.f.Post,"/search",n,e.body)}uploadKeysRequest(e,t,n){return this.http.authedRequest(n,w.f.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(void 0,w.f.Post,"/keys/signatures/upload",void 0,e,{prefix:w.k})}downloadKeysForUsers(e,t){if(m.s(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");const n={device_keys:{}};return"token"in(t=t||{})&&(n.token=t.token),e.forEach(e=>{n.device_keys[e]=[]}),this.http.authedRequest(void 0,w.f.Post,"/keys/query",void 0,n)}claimOneTimeKeys(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"signed_curve25519",n=arguments.length>2?arguments[2]:void 0;const i={};void 0===t&&(t="signed_curve25519");for(let n=0;n<e.length;++n){const s=e[n][0],o=e[n][1],r=i[s]||{};i[s]=r,r[o]=t}const s={one_time_keys:i};n&&(s.timeout=n);return this.http.authedRequest(void 0,w.f.Post,"/keys/claim",void 0,s)}getKeyChanges(e,t){const n={from:e,to:t};return this.http.authedRequest(void 0,w.f.Get,"/keys/changes",n)}uploadDeviceSigningKeys(e,t){const n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this.http.authedRequest(void 0,w.f.Post,"/keys/device_signing/upload",void 0,n,{prefix:w.k})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");const t=this.idBaseUrl+w.h+"/account/register";return this.http.requestOtherUrl(void 0,w.f.Post,t,null,e)}requestEmailToken(e,t,n,i,s,o){const r={client_secret:t,email:e,send_attempt:null==n?void 0:n.toString(),next_link:i};return this.http.idServerRequest(s,w.f.Post,"/validate/email/requestToken",r,w.h,o)}requestMsisdnToken(e,t,n,i,s,o,r){const a={client_secret:n,country:e,phone_number:t,send_attempt:null==i?void 0:i.toString(),next_link:s};return this.http.idServerRequest(o,w.f.Post,"/validate/msisdn/requestToken",a,w.h,r)}submitMsisdnToken(e,t,n,i){const s={sid:e,client_secret:t,token:n};return this.http.idServerRequest(void 0,w.f.Post,"/validate/msisdn/submitToken",s,w.h,i)}submitMsisdnTokenOtherUrl(e,t,n,i){const s={sid:t,client_secret:n,token:i};return this.http.requestOtherUrl(void 0,w.f.Post,e,void 0,s)}getIdentityHashDetails(e){return this.http.idServerRequest(void 0,w.f.Get,"/hash_details",null,w.h,e)}async identityHashedLookup(t,n){const i={},s=await this.getIdentityHashDetails(n);if(!s||!s.lookup_pepper||!s.algorithms)throw new Error("Unsupported identity server: bad response");i.pepper=s.lookup_pepper;const o={};if(s.algorithms.includes("sha256")){const n=new e.Olm.Utility;i.addresses=t.map(e=>{const t=e[0].toLowerCase(),s=e[1].toLowerCase(),r=n.sha256(`${t} ${s} ${i.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return o[r]=e[0],r}),i.algorithm="sha256"}else{if(!s.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");i.addresses=t.map(e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return o[t]=e[0],t}),i.algorithm="none"}const r=await this.http.idServerRequest(void 0,w.f.Post,"/lookup",i,w.h,n);if(!r||!r.mappings)return[];const a=[];for(const e of Object.keys(r.mappings)){const t=r.mappings[e],n=o[e];if(!n)throw new Error("Identity server returned more results than expected");a.push({address:n,mxid:t})}return a}async lookupThreePid(e,t,n,i){const s=(await this.identityHashedLookup([[t,e]],i)).find(e=>e.address===t);if(!s)return n&&n(null,{}),{};const o={address:t,medium:e,mxid:s.mxid};return n&&n(null,o),o}async bulkLookupThreePids(e,t){const n=await this.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),i=[];for(const t of n){const n=e.find(e=>e[1]===t.address);if(!n)throw new Error("Identity sever returned unexpected results");i.push([n[0],t.address,t.mxid])}return{threepids:i}}getIdentityAccount(e){return this.http.idServerRequest(void 0,w.f.Get,"/account",void 0,w.h,e)}sendToDevice(e,t,n){const i=m.n("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),s={messages:t},o=Object.keys(t).reduce((e,n)=>(e[n]=Object.keys(t[n]),e),{});return S.a.log("PUT "+i,o),this.http.authedRequest(void 0,w.f.Put,i,void 0,s)}getThirdpartyProtocols(){return this.http.authedRequest(void 0,w.f.Get,"/thirdparty/protocols").then(e=>{if(!e||"object"!=typeof e)throw new Error("/thirdparty/protocols did not return an object: "+e);return e})}getThirdpartyLocation(e,t){const n=m.n("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(void 0,w.f.Get,n,t)}getThirdpartyUser(e,t){const n=m.n("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(void 0,w.f.Get,n,t)}getTerms(e,t){const n=this.termsUrlForService(e,t);return this.http.requestOtherUrl(void 0,w.f.Get,n)}agreeToTerms(e,t,n,i){const s=this.termsUrlForService(e,t),o={Authorization:"Bearer "+n};return this.http.requestOtherUrl(void 0,w.f.Post,s,null,{user_accepts:i},{headers:o})}reportEvent(e,t,n,i){const s=m.n("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(void 0,w.f.Post,s,null,{score:n,reason:i})}getRoomHierarchy(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4?arguments[4]:void 0;const o=m.n("/rooms/$roomId/hierarchy",{$roomId:e}),r={suggested_only:String(i),max_depth:null==n?void 0:n.toString(),from:s,limit:null==t?void 0:t.toString()};return this.http.authedRequest(void 0,w.f.Get,o,r,void 0,{prefix:w.l}).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(void 0,w.f.Get,o,r,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e})}async unstableCreateFileTree(e){const{room_id:t}=await this.createRoom({name:e,preset:D.d.PrivateChat,power_level_content_override:G(G({},L.a),{},{users:{[this.getUserId()]:100}}),creation_content:{[P.e]:P.f.Space},initial_state:[{type:P.i.name,state_key:P.l.name,content:{[P.h.name]:!0}},{type:P.b.RoomEncryption,state_key:"",content:{algorithm:v.MEGOLM_ALGORITHM}}]});return new L.b(this,t)}unstableGetFileTreeSpace(e){var t,n;const i=this.getRoom(e);if("join"!==(null==i?void 0:i.getMyMembership()))return null;const s=i.currentState.getStateEvents(P.b.RoomCreate,""),o=i.currentState.getStateEvents(P.i.name,P.l.name);if(!s)throw new Error("Expected single room create event");return null!=o&&null!==(t=o.getContent())&&void 0!==t&&t[P.h.name]?(null===(n=s.getContent())||void 0===n?void 0:n[P.e])!==P.f.Space?null:new L.b(this,e):null}supportsExperimentalThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.experimentalThreadSupport)||!1}async getRoomSummary(e,t){const n=m.n("/rooms/$roomid/summary",{$roomid:e});return this.http.authedRequest(void 0,w.f.Get,n,{via:t},null,{qsStringifyOptions:{arrayFormat:"repeat"},prefix:"/_matrix/client/unstable/im.nheko.summary"})}processThreadEvents(e,t,n){e.processThreadedEvents(t,n)}processBeaconEvents(e,t){null!=t&&t.length&&e.currentState.processBeaconEvents(t,this)}async whoami(){return this.http.authedRequest(void 0,w.f.Get,"/account/whoami")}timestampToEvent(e,t,n){const i=m.n("/rooms/$roomId/timestamp_to_event",{$roomId:e});return this.http.authedRequest(void 0,w.f.Get,i,{ts:t.toString(),dir:n},void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"})}}s()(Z,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")}).call(this,n(30))},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"request",(function(){return A})),n.d(t,"getRequest",(function(){return M})),n.d(t,"wrapRequest",(function(){return U})),n.d(t,"setCryptoStoreFactory",(function(){return F})),n.d(t,"createClient",(function(){return B}));var i=n(310),s=n(311),o=n(442),r=n(119);n.d(t,"CRYPTO_ENABLED",(function(){return r.a})),n.d(t,"PendingEventOrdering",(function(){return r.d})),n.d(t,"RoomVersionStability",(function(){return r.e})),n.d(t,"ClientEvent",(function(){return r.b})),n.d(t,"MatrixClient",(function(){return r.c}));var a=n(224);n.d(t,"PREFIX_R0",(function(){return a.j})),n.d(t,"PREFIX_V1",(function(){return a.l})),n.d(t,"PREFIX_V3",(function(){return a.m})),n.d(t,"PREFIX_UNSTABLE",(function(){return a.k})),n.d(t,"PREFIX_IDENTITY_V1",(function(){return a.g})),n.d(t,"PREFIX_IDENTITY_V2",(function(){return a.h})),n.d(t,"PREFIX_MEDIA_R0",(function(){return a.i})),n.d(t,"Method",(function(){return a.f})),n.d(t,"HttpApiEvent",(function(){return a.c})),n.d(t,"MatrixHttpApi",(function(){return a.e})),n.d(t,"MatrixError",(function(){return a.d})),n.d(t,"ConnectionError",(function(){return a.b})),n.d(t,"AbortError",(function(){return a.a})),n.d(t,"retryNetworkOperation",(function(){return a.n}));var c=n(283);n.d(t,"AutoDiscoveryAction",(function(){return c.b})),n.d(t,"AutoDiscovery",(function(){return c.a}));var l=n(443);n.d(t,"Category",(function(){return l.a})),n.d(t,"SyncAccumulator",(function(){return l.b}));var d=n(243);n.d(t,"InvalidStoreError",(function(){return d.b})),n.d(t,"InvalidCryptoStoreError",(function(){return d.a})),n.d(t,"KeySignatureUploadError",(function(){return d.c}));var u=n(364);n.d(t,"BeaconEvent",(function(){return u.b})),n.d(t,"isTimestampInDuration",(function(){return u.d})),n.d(t,"getBeaconInfoIdentifier",(function(){return u.c})),n.d(t,"Beacon",(function(){return u.a}));var h=n(108);n.d(t,"EventStatus",(function(){return h.a})),n.d(t,"MatrixEventEvent",(function(){return h.c})),n.d(t,"MatrixEvent",(function(){return h.b}));var m=n(113);n.d(t,"NotificationCountType",(function(){return m.a})),n.d(t,"RoomEvent",(function(){return m.c})),n.d(t,"Room",(function(){return m.b}));var p=n(144);n.d(t,"Direction",(function(){return p.a})),n.d(t,"EventTimeline",(function(){return p.b}));var g=n(314);n.d(t,"DuplicateStrategy",(function(){return g.a})),n.d(t,"EventTimelineSet",(function(){return g.b}));var f=n(151);n.d(t,"RoomMemberEvent",(function(){return f.b})),n.d(t,"RoomMember",(function(){return f.a}));var v=n(116);n.d(t,"RoomStateEvent",(function(){return v.b})),n.d(t,"RoomState",(function(){return v.a}));var b=n(200);n.d(t,"UserEvent",(function(){return b.b})),n.d(t,"User",(function(){return b.a})),n.d(t,"MatrixScheduler",(function(){return o.a}));var y=n(273);n.d(t,"Filter",(function(){return y.a}));var S=n(444);n.d(t,"TimelineWindow",(function(){return S.b})),n.d(t,"TimelineIndex",(function(){return S.a}));var E=n(374);n.d(t,"AuthType",(function(){return E.a})),n.d(t,"InteractiveAuth",(function(){return E.b}));var w=n(225);n.d(t,"SERVICE_TYPES",(function(){return w.a})),n.d(t,"MemoryStore",(function(){return s.a}));var _=n(425);n.d(t,"IndexedDBStore",(function(){return _.a}));var C=n(445);n.d(t,"WebStorageSessionStore",(function(){return C.a})),n.d(t,"MemoryCryptoStore",(function(){return i.a}));var O=n(187);n.d(t,"IndexedDBCryptoStore",(function(){return O.a}));var R=n(312);n.d(t,"getHttpUriForMxc",(function(){return R.a}));var I=n(97);n.d(t,"EventType",(function(){return I.b})),n.d(t,"RelationType",(function(){return I.d})),n.d(t,"MsgType",(function(){return I.c})),n.d(t,"RoomCreateTypeField",(function(){return I.e})),n.d(t,"RoomType",(function(){return I.f})),n.d(t,"UNSTABLE_MSC3088_PURPOSE",(function(){return I.i})),n.d(t,"UNSTABLE_MSC3088_ENABLED",(function(){return I.h})),n.d(t,"UNSTABLE_MSC3089_TREE_SUBTYPE",(function(){return I.l})),n.d(t,"UNSTABLE_MSC3089_LEAF",(function(){return I.k})),n.d(t,"UNSTABLE_MSC3089_BRANCH",(function(){return I.j})),n.d(t,"UNSTABLE_ELEMENT_FUNCTIONAL_USERS",(function(){return I.g})),n.d(t,"EVENT_VISIBILITY_CHANGE_TYPE",(function(){return I.a}));var k=n(202);n.d(t,"PushRuleActionName",(function(){return k.d})),n.d(t,"TweakName",(function(){return k.g})),n.d(t,"ConditionOperator",(function(){return k.b})),n.d(t,"DMMemberCountCondition",(function(){return k.c})),n.d(t,"isDmMemberCountCondition",(function(){return k.h})),n.d(t,"ConditionKind",(function(){return k.a})),n.d(t,"PushRuleKind",(function(){return k.e})),n.d(t,"RuleId",(function(){return k.f}));var x=n(125);n.d(t,"Visibility",(function(){return x.f})),n.d(t,"Preset",(function(){return x.d})),n.d(t,"JoinRule",(function(){return x.c})),n.d(t,"RestrictedAllowType",(function(){return x.e})),n.d(t,"GuestAccess",(function(){return x.a})),n.d(t,"HistoryVisibility",(function(){return x.b}));n(604);var T=n(373);n.d(t,"SearchOrderBy",(function(){return T.a}));var j=n(438);n.d(t,"RoomSummary",(function(){return j.a}));var N=n(237);n.d(t,"ContentHelpers",(function(){return N}));var P=n(152);let D;function A(e){D=e}function M(){return D}function U(e){const t=D;D=function(n,i){return e(t,n,i)}}n.d(t,"createNewMatrixCall",(function(){return P.g}));let L=()=>new i.a;function F(e){L=e}function B(t){return"string"==typeof t&&(t={baseUrl:t}),t.request=t.request||D,t.store=t.store||new s.a({localStorage:e.localStorage}),t.scheduler=t.scheduler||new o.a,t.cryptoStore=t.cryptoStore||L(),new r.c(t)}}.call(this,n(30))},function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"i",(function(){return o})),n.d(t,"g",(function(){return r})),n.d(t,"h",(function(){return a})),n.d(t,"j",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"e",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"a",(function(){return h})),n.d(t,"f",(function(){return m})),n.d(t,"k",(function(){return p})),n.d(t,"l",(function(){return g}));var i=n(250);function s(e,t){if(e.length===t)return e;const n=[];if(e.length>t){const i=Math.round(e.length/t);for(let t=0;t<e.length;t+=i)n.push(e[t])}else{const i=Math.ceil(t/e.length);for(const t of e)n.push(...a(t,i))}return c(n,t,a(e[e.length-1],t))}function o(e,t){if(e.length===t)return e;let n=[];if(e.length>t){for(;n.length>2*t||0===n.length;){n=[];for(let t=1;t<e.length-1;t+=2){const i=(e[t-1]+e[t+1]+e[t])/3;n.push(i)}e=n}return s(n,t)}return s(e,t)}function r(e,t,n){const s=Math.min(...e),o=Math.max(...e);return e.map(e=>Object(i.d)(Object(i.c)(e,s,o),t,n))}function a(e,t){return new Array(t).fill(e)}function c(e,t,n){return e.length===t?e:e.length>t?e.slice(0,t):e.concat(n.slice(0,t-e.length))}function l(e){return e.slice(0,e.length)}function d(e,t){if(e.length===t.length){for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!0;return!1}return!0}function u(e,t){return e.length!==t.length||(!!t.some(t=>!e.includes(t))||!!e.some(e=>!t.includes(e)))}function h(e,t){return{added:t.filter(t=>!e.includes(t)),removed:e.filter(e=>!t.includes(e))}}function m(e,t){return e.filter(e=>t.includes(e))}function p(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Array.from(t.reduce((e,t)=>(t.forEach(t=>e.add(t)),e),new Set))}function g(e,t,n){const i=Array.from(e),[s]=i.splice(t,1);return i.splice(n,0,s),i}},function(e,t,n){"use strict";let i,s;n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),function(e){e.AdvancedEncryption="UIFeature.advancedEncryption",e.URLPreviews="UIFeature.urlPreviews",e.Widgets="UIFeature.widgets",e.Voip="UIFeature.voip",e.Feedback="UIFeature.feedback",e.Registration="UIFeature.registration",e.PasswordReset="UIFeature.passwordReset",e.Deactivate="UIFeature.deactivate",e.ShareQRCode="UIFeature.shareQrCode",e.ShareSocial="UIFeature.shareSocial",e.IdentityServer="UIFeature.identityServer",e.ThirdPartyID="UIFeature.thirdPartyId",e.AdvancedSettings="UIFeature.advancedSettings",e.RoomHistorySettings="UIFeature.roomHistorySettings",e.TimelineEnableRelativeDates="UIFeature.timelineEnableRelativeDates"}(i||(i={})),function(e){e.InviteUsers="UIComponent.sendInvites",e.CreateRooms="UIComponent.roomCreation",e.CreateSpaces="UIComponent.spaceCreation",e.ExploreRooms="UIComponent.exploreRooms",e.AddIntegrations="UIComponent.addIntegrations"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(8),r=n(971),a=n.n(r);const c="update";class l extends o.EventEmitter{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.dispatcher=e,s()(this,"storeState",void 0),s()(this,"lock",new a.a),s()(this,"dispatcherRef",void 0),this.dispatcherRef=e.register(this.onDispatch.bind(this)),this.storeState=t}get state(){return this.storeState}stop(){this.dispatcherRef&&this.dispatcher.unregister(this.dispatcherRef)}async updateState(e){await this.lock.acquireAsync();try{this.storeState=Object.freeze(Object.assign({},this.storeState,e)),this.emit(c,this)}finally{await this.lock.release()}}async reset(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];await this.lock.acquireAsync();try{this.storeState=Object.freeze(e||{}),t||this.emit(c,this)}finally{await this.lock.release()}}}},,function(e,t,n){"use strict";let i,s,o,r,a,c;n.d(t,"f",(function(){return i})),n.d(t,"d",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"e",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c})),function(e){e.Public="public",e.Private="private"}(i||(i={})),function(e){e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat"}(s||(s={})),function(e){e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted"}(o||(o={})),function(e){e.RoomMembership="m.room_membership"}(r||(r={})),function(e){e.CanJoin="can_join",e.Forbidden="forbidden"}(a||(a={})),function(e){e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable"}(c||(c={}))},function(e,t,n){"use strict";var i=n(88),s=n.n(i);class o{constructor(){s()(this,"platform",null)}get(){return this.platform}set(e){this.platform=e}}window.mxPlatformPeg||(window.mxPlatformPeg=new o),t.a=window.mxPlatformPeg},function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(87),r=n(446),a=n(318),c=n(173);const l={[a.a.LOADING]:"Loading",[a.a.WELCOME]:"Welcome",[a.a.LOGIN]:"Login",[a.a.REGISTER]:"Register",[a.a.FORGOT_PASSWORD]:"ForgotPassword",[a.a.COMPLETE_SECURITY]:"CompleteSecurity",[a.a.E2E_SETUP]:"E2ESetup",[a.a.SOFT_LOGOUT]:"SoftLogout"},d={[r.a.HomePage]:"Home",[r.a.RoomView]:"Room",[r.a.UserView]:"User",[r.a.LegacyGroupView]:"Group"};class u{constructor(){s()(this,"view",a.a.LOADING),s()(this,"pageType",null),s()(this,"override",null)}static get instance(){return u.internalInstance||(u.internalInstance=new u),u.internalInstance}trackPageChange(e,t,n){this.view=e,this.pageType=t,this.override||this.trackPage(n)}trackPage(e){const t=this.view===a.a.LOGGED_IN?d[this.pageType]:l[this.view];c.a.instance.trackEvent({eventName:"$pageview",$current_url:t,durationMs:e})}trackOverride(e){e&&(this.override=e,c.a.instance.trackEvent({eventName:"$pageview",$current_url:e}))}clearOverride(e){e===this.override&&(this.override=null,this.trackPage())}static trackInteraction(e,t,n){let i;"click"===(null==t?void 0:t.type)?i="Pointer":null!=t&&t.type.startsWith("key")&&(i="Keyboard"),c.a.instance.trackEvent({eventName:"Interaction",interactionType:i,index:n,name:e})}}s()(u,"internalInstance",void 0);class h extends o.PureComponent{componentDidMount(){u.instance.trackOverride(this.props.screenName)}componentDidUpdate(){u.instance.trackOverride(this.props.screenName)}componentWillUnmount(){u.instance.clearOverride(this.props.screenName)}render(){return null}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c}));var i=n(88),s=n.n(i),o=n(90);class r{constructor(e,t){if(this.prepared=e,s()(this,"client",void 0),this.client=null!=t?t:o.a.get(),!this.client)throw new Error("No possible MatrixClient for media resolution. Please provide one or log in.")}get isEncrypted(){return!!this.prepared.file}get srcMxc(){return this.prepared.mxc}get thumbnailMxc(){var e;return null===(e=this.prepared.thumbnail)||void 0===e?void 0:e.mxc}get hasThumbnail(){return!!this.thumbnailMxc}get srcHttp(){return this.client.mxcUrlToHttp(this.srcMxc)}get thumbnailHttp(){return this.hasThumbnail?this.client.mxcUrlToHttp(this.thumbnailMxc):null}getThumbnailHttp(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"scale";return this.hasThumbnail?(e=Math.floor(e*window.devicePixelRatio),t=Math.floor(t*window.devicePixelRatio),this.client.mxcUrlToHttp(this.thumbnailMxc,e,t,n)):null}getThumbnailOfSourceHttp(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"scale";return e=Math.floor(e*window.devicePixelRatio),t=Math.floor(t*window.devicePixelRatio),this.client.mxcUrlToHttp(this.srcMxc,e,t,n)}getSquareThumbnailHttp(e){return e=Math.floor(e*window.devicePixelRatio),this.hasThumbnail?this.getThumbnailHttp(e,e,"crop"):this.getThumbnailOfSourceHttp(e,e,"crop")}downloadSource(){return fetch(this.srcHttp)}}function a(e,t){return new r(function(e){var t,n,i,s;let o=null;if(null!=e&&null!==(t=e.info)&&void 0!==t&&t.thumbnail_url?o={mxc:e.info.thumbnail_url,file:e.info.thumbnail_file}:null!=e&&null!==(n=e.info)&&void 0!==n&&null!==(i=n.thumbnail_file)&&void 0!==i&&i.url&&(o={mxc:e.info.thumbnail_file.url,file:e.info.thumbnail_file}),null!=e&&e.url)return{thumbnail:o,mxc:e.url,file:e.file};if(null!=e&&null!==(s=e.file)&&void 0!==s&&s.url)return{thumbnail:o,mxc:e.file.url,file:e.file};throw new Error("Invalid file provided: cannot determine MXC URI. Has it been redacted?")}(e),t)}function c(e,t){return a({url:e},t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return I}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(635),c=n(0),l=n(125),d=n(119),u=n(92),h=n(90),m=n(95),p=n(89),g=n(387),f=n(96),v=n(325),b=n(106),y=n(173),S=n(135),E=n(131),w=n(171),_=n(107);function C(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function O(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?C(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const R={joining:!1,joinError:null,roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:!1,initialEventScrollIntoView:!0,roomAlias:null,roomLoading:!1,roomLoadError:null,replyingToEvent:null,shouldPeek:!1,viaServers:[],wasContextSwitch:!1};class I extends a.Store{constructor(){super(u.a),s()(this,"state",R),s()(this,"roomIdActivityListeners",{})}addRoomListener(e,t){this.roomIdActivityListeners[e]||(this.roomIdActivityListeners[e]=[]),this.roomIdActivityListeners[e].push(t)}removeRoomListener(e,t){if(this.roomIdActivityListeners[e]){const n=this.roomIdActivityListeners[e].indexOf(t);n>-1&&this.roomIdActivityListeners[e].splice(n,1)}else c.a.warn("Unregistering unrecognised listener (roomId="+e+")")}emitForRoom(e,t){if(this.roomIdActivityListeners[e])for(const n of this.roomIdActivityListeners[e])n.call(null,t)}setState(e){let t=!1;for(const n of Object.keys(e))if(this.state[n]!==e[n]){t=!0;break}if(!t)return;const n=this.state.roomId;this.state=Object.assign(this.state,e),n!==this.state.roomId&&(n&&this.emitForRoom(n,!1),this.state.roomId&&this.emitForRoom(this.state.roomId,!0),u.a.dispatch({action:f.a.ActiveRoomChanged,oldRoomId:n,newRoomId:this.state.roomId})),this.__emitChange()}__onDispatch(e){switch(e.action){case f.a.ViewRoom:this.viewRoom(e);break;case"view_welcome_page":case f.a.ViewHomePage:this.setState({roomId:null,roomAlias:null,viaServers:[],wasContextSwitch:!1});break;case f.a.ViewRoomError:this.viewRoomError(e);break;case"will_join":this.setState({joining:!0});break;case"cancel_join":this.setState({joining:!1});break;case f.a.JoinRoom:this.joinRoom(e);break;case f.a.JoinRoomError:this.joinRoomError(e);break;case f.a.JoinRoomReady:{this.state.roomId===e.roomId&&this.setState({shouldPeek:!1});const t=h.a.get(),n=()=>{const i=t.getRoom(e.roomId),s=i.getJoinedMemberCount(),o=s>1e3?"MoreThanAThousand":s>100?"OneHundredAndOneToAThousand":s>10?"ElevenToOneHundred":s>2?"ThreeToTen":s>1?"Two":"One";y.a.instance.trackEvent({eventName:"JoinedRoom",trigger:e.metricsTrigger,roomSize:o,isDM:!!S.a.shared().getUserIdForRoomId(i.roomId),isSpace:i.isSpaceRoom()}),t.off(d.b.Room,n)};t.getRoom(e.roomId)?n():t.on(d.b.Room,n);break}case"on_client_not_viable":case f.a.OnLoggedOut:this.reset();break;case"reply_to_event":[b.a.Room,b.a.Search].includes(e.context)&&(e.event&&e.event.getRoomId()!==this.state.roomId?u.a.dispatch({action:f.a.ViewRoom,room_id:e.event.getRoomId(),replyingToEvent:e.event,metricsTrigger:void 0}):this.setState({replyingToEvent:e.event}))}}async viewRoom(e){if(e.room_id){var t,n;if(null!==e.metricsTrigger&&e.room_id!==this.state.roomId){var i;let t;t=E.a.instance.activeSpace===w.a.Home?"Home":Object(w.h)(E.a.instance.activeSpace)?"Meta":E.a.instance.activeSpaceRoom.getJoinRule()===l.c.Public?"Public":"Private",y.a.instance.trackEvent({eventName:"ViewRoom",trigger:e.metricsTrigger,viaKeyboard:e.metricsViaKeyboard,isDM:!!S.a.shared().getUserIdForRoomId(e.room_id),isSpace:null===(i=h.a.get().getRoom(e.room_id))||void 0===i?void 0:i.isSpaceRoom(),activeSpace:t})}const s={roomId:e.room_id,roomAlias:e.room_alias,initialEventId:e.event_id,isInitialEventHighlighted:e.highlighted,initialEventScrollIntoView:null===(t=e.scroll_into_view)||void 0===t||t,roomLoading:!1,roomLoadError:null,shouldPeek:void 0===e.should_peek||e.should_peek,joining:e.joining||!1,replyingToEvent:null,viaServers:e.via_servers,wasContextSwitch:e.context_switch};(null===(n=e.replyingToEvent)||void 0===n?void 0:n.getRoomId())===e.room_id?s.replyingToEvent=e.replyingToEvent:this.state.roomId===e.room_id&&(s.replyingToEvent=this.state.replyingToEvent),this.setState(s),e.auto_join&&u.a.dispatch(O(O({},e),{},{action:f.a.JoinRoom,roomId:e.room_id,metricsTrigger:e.metricsTrigger}))}else if(e.room_alias){let t=Object(g.a)(e.room_alias);if(!t){this.setState({roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:null,initialEventScrollIntoView:!0,roomAlias:e.room_alias,roomLoading:!0,roomLoadError:null,viaServers:e.via_servers,wasContextSwitch:e.context_switch});try{const n=await h.a.get().getRoomIdForAlias(e.room_alias);Object(g.b)(e.room_alias,n.room_id),t=n.room_id}catch(t){return c.a.error("RVS failed to get room id for alias: ",t),void u.a.dispatch({action:f.a.ViewRoomError,room_id:null,room_alias:e.room_alias,err:t})}}u.a.dispatch(O(O({},e),{},{room_id:t}))}}viewRoomError(e){this.setState({roomId:e.room_id,roomAlias:e.room_alias,roomLoading:!1,roomLoadError:e.err})}async joinRoom(e){this.setState({joining:!0});const t=h.a.get(),{roomAlias:n,roomId:i}=this.state,s=n||i,o=this.state.viaServers||[];try{await Object(v.a)(()=>t.joinRoom(s,O({viaServers:o},e.opts||{})),5,e=>504===e.httpStatus),u.a.dispatch({action:f.a.JoinRoomReady,roomId:i,metricsTrigger:e.metricsTrigger})}catch(e){u.a.dispatch({action:f.a.JoinRoomError,roomId:i,err:e})}}getInvitingUserId(e){const t=h.a.get(),n=t.getRoom(e);if("invite"===(null==n?void 0:n.getMyMembership())){const e=n.getMember(t.getUserId()),i=e?e.events.member:null;return i&&i.getSender()}}showJoinRoomError(e,t){let n=e.message?e.message:JSON.stringify(e);if(c.a.log("Failed to join room:",n),"ConnectionError"===e.name)n=Object(p.a)("There was an error joining.");else if("M_INCOMPATIBLE_ROOM_VERSION"===e.errcode)n=r.a.createElement("div",null,Object(p.a)("Sorry, your homeserver is too old to participate here."),r.a.createElement("br",null),Object(p.a)("Please contact your homeserver administrator."));else if(404===e.httpStatus){const e=this.getInvitingUserId(t);e&&(n=e.endsWith(":"+h.a.get().getDomain())?Object(p.a)("The person who invited you has already left."):Object(p.a)("The person who invited you has already left, or their server is offline."))}m.a.createTrackedDialog("Failed to join room","",_.a,{title:Object(p.a)("Failed to join"),description:n})}joinRoomError(e){this.setState({joining:!1,joinError:e.err}),this.showJoinRoomError(e.err,e.roomId)}reset(){this.state=Object.assign({},R)}getRoomId(){return this.state.roomId}getInitialEventId(){return this.state.initialEventId}isInitialEventHighlighted(){return this.state.isInitialEventHighlighted}initialEventScrollIntoView(){return this.state.initialEventScrollIntoView}getRoomAlias(){return this.state.roomAlias}isRoomLoading(){return this.state.roomLoading}getRoomLoadError(){return this.state.roomLoadError}isJoining(){return this.state.joining}getJoinError(){return this.state.joinError}getQuotingEvent(){return this.state.replyingToEvent}shouldPeek(){return this.state.shouldPeek}getWasContextSwitch(){return this.state.wasContextSwitch}}s()(I,"instance",new I)},function(e,t,n){"use strict";n.d(t,"a",(function(){return _}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(88),c=n.n(a),l=n(87),d=n.n(l),u=n(116),h=n(94),m=n.n(h),p=n(97),g=n(148),f=n(359),v=n(90),b=n(95),y=n(221),S=n(135),E=n(128);const w=["room","oobData","viewAvatarOnClick","onClick","className"];class _ extends d.a.Component{constructor(e){super(e),c()(this,"onRoomStateEvents",e=>{var t;e.getRoomId()===(null===(t=this.props.room)||void 0===t?void 0:t.roomId)&&e.getType()===p.b.RoomAvatar&&this.setState({urls:_.getImageUrls(this.props)})}),c()(this,"onRoomAvatarClick",()=>{const e={src:y.b(this.props.room,null,null,null),name:this.props.room.name};b.a.createDialog(f.a,e,"mx_Dialog_lightbox",null,!0)}),this.state={urls:_.getImageUrls(this.props)}}componentDidMount(){v.a.get().on(u.b.Events,this.onRoomStateEvents)}componentWillUnmount(){const e=v.a.get();e&&e.removeListener(u.b.Events,this.onRoomStateEvents)}static getDerivedStateFromProps(e){return{urls:_.getImageUrls(e)}}static getImageUrls(e){let t=null;return e.oobData.avatarUrl&&(t=Object(E.b)(e.oobData.avatarUrl).getThumbnailOfSourceHttp(e.width,e.height,e.resizeMethod)),[t,_.getRoomAvatarUrl(e)].filter((function(e){return null!==e&&""!==e}))}static getRoomAvatarUrl(e){return e.room?y.b(e.room,e.width,e.height,e.resizeMethod):null}render(){var e;const t=this.props,{room:n,oobData:i,viewAvatarOnClick:o,onClick:a,className:c}=t,l=r()(t,w),u=n?n.name:i.name,h=n?null!==(e=S.a.shared().getUserIdForRoomId(n.roomId))&&void 0!==e?e:n.roomId:i.roomId;return d.a.createElement(g.a,s()({},l,{className:m()(c,{mx_RoomAvatar_isSpaceRoom:null==n?void 0:n.isSpaceRoom()}),name:u,idName:h,urls:this.state.urls,onClick:o&&this.state.urls[0]?this.onRoomAvatarClick:a}))}}c()(_,"defaultProps",{width:36,height:36,resizeMethod:"crop",oobData:{}})},function(e,t,n){"use strict";n.d(t,"b",(function(){return V})),n.d(t,"a",(function(){return q}));var i=n(88),s=n.n(i),o=n(111),r=n(97),a=n(113),c=n(119),l=n(0),d=n(116),u=n(167),h=n(92),m=n(189),p=n(93),g=n(135),f=n(168),v=n(121),b=n(190);class y extends b.a{constructor(e){super(),this.getRoomFn=e,s()(this,"rooms",[]),s()(this,"states",{}),s()(this,"onRoomNotificationStateUpdate",()=>{this.calculateTotalState()})}get symbol(){return this._color===f.a.Unsent?"!":null}setRooms(e){const t=this.rooms,n=Object(v.a)(t,e);this.rooms=e;for(const e of n.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(b.b.Update,this.onRoomNotificationStateUpdate))}for(const e of n.added){const t=this.getRoomFn(e);t.on(b.b.Update,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}getFirstRoomWithNotifications(){var e;return null===(e=Object.values(this.states).find(e=>e.color>=this.color))||void 0===e?void 0:e.room.roomId}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(b.b.Update,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();this._count=0,this._color=f.a.None;for(const e of Object.values(this.states))this._count+=e.count,this._color=Math.max(this.color,e.color);this.emitIfUpdated(e)}}var S=n(172),E=n(166),w=n(400),_=n(790),C=n(129),O=n(96),R=n(7);function I(e,t,n,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:R.a;const o=Math.min(Math.max(e.length,t.length),i),r=Object(R.b)(e,o,s),a=Object(R.b)(t,o,s),c=Object(R.I)(r,s),l=Object(R.I)(a,s);if(l-c-BigInt(1)<n)return o<i?I(Object(R.b)(r,o+1,s),Object(R.b)(a,o+1,s),n,o+1,s):[];const d=(l-c)/BigInt(n+1),u=BigInt(c+d);return Array(n).fill(void 0).map((e,t)=>Object(R.d)(u+BigInt(t)*d,s))}var k=n(852),x=n(171),T=n(387),j=n(217);const N=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;n.add(t);const i=e.get(t);return null==i||i.forEach(t=>{n.has(t)||N(e,t,n)}),n},P=(e,t,n)=>{const i=N(t,n),s=new Set;return i.forEach(t=>{const n=e.get(t);null==n||n.forEach(s.add,s)}),s},D=e=>function(t,n,i){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(s&&e.has(i))return e.get(i);const o=P(t,n,i);return e.set(i,o),o};var A=n(173);function M(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function U(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?M(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):M(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const L=[x.a.Home,x.a.Favourites,x.a.People,x.a.Orphans],F=e=>"mx_space_context_"+e,B=e=>e.reduce((e,t)=>(e[t.isSpaceRoom()?0:1].push(t),e),[[],[]]),K=e=>{if("string"==typeof e&&e.length<=50&&Array.from(e).every(e=>{const t=e.charCodeAt(0);return t>=32&&t<=126}))return e},V=(e,t,n)=>{var i;return[null!==(i=K(e))&&void 0!==i?i:NaN,t,n]},W=e=>S.a.instance.getRoomState(e);class H extends u.a{constructor(){var e;super(h.a,{}),e=this,s()(this,"rootSpaces",[]),s()(this,"parentMap",new w.a),s()(this,"notificationStateMap",new Map),s()(this,"roomIdsBySpace",new Map),s()(this,"childSpacesBySpace",new Map),s()(this,"userIdsBySpace",new Map),s()(this,"_aggregatedSpaceCache",{roomIdsBySpace:new Map,userIdsBySpace:new Map}),s()(this,"_activeSpace",x.a.Home),s()(this,"_suggestedRooms",[]),s()(this,"_invitedSpaces",new Set),s()(this,"spaceOrderLocalEchoMap",new Map),s()(this,"_restrictedJoinRuleSupport",void 0),s()(this,"_allRoomsInHome",!1),s()(this,"_enabledMetaSpaces",[]),s()(this,"fetchSuggestedRooms",(async function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;try{const{rooms:i}=await e.matrixClient.getRoomHierarchy(t.roomId,n,1,!0),s=new w.a;return i.forEach(e=>{e.children_state.forEach(e=>{var t;e.type===r.b.SpaceChild&&null!==(t=e.content.via)&&void 0!==t&&t.length&&e.content.via.forEach(t=>{s.getOrCreate(e.state_key,new Set).add(t)})})}),i.filter(t=>{var n;return t.room_type!==r.f.Space&&"join"!==(null===(n=e.matrixClient.getRoom(t.room_id))||void 0===n?void 0:n.getMyMembership())}).map(e=>U(U({},e),{},{viaServers:Array.from(s.get(e.room_id)||[])}))}catch(e){l.a.error(e)}return[]})),s()(this,"getSpaceFilteredRoomIds",(function(t){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return t===x.a.Home&&e.allRoomsInHome?new Set(e.matrixClient.getVisibleRooms().map(e=>e.roomId)):!n||Object(x.h)(t)?e.roomIdsBySpace.get(t)||new Set:e.getAggregatedRoomIdsBySpace(e.roomIdsBySpace,e.childSpacesBySpace,t,i)})),s()(this,"getSpaceFilteredUserIds",(function(t){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!(t===x.a.Home&&e.allRoomsInHome||Object(x.h)(t)))return!n||Object(x.h)(t)?e.userIdsBySpace.get(t)||new Set:e.getAggregatedUserIdsBySpace(e.userIdsBySpace,e.childSpacesBySpace,t,i)})),s()(this,"getAggregatedRoomIdsBySpace",D(this._aggregatedSpaceCache.roomIdsBySpace)),s()(this,"getAggregatedUserIdsBySpace",D(this._aggregatedSpaceCache.userIdsBySpace)),s()(this,"markTreeChildren",(e,t)=>{const n=[e];for(;n.length;){const e=n.pop();t.delete(e),this.getChildSpaces(e.roomId).forEach(e=>{t.has(e)&&n.push(e)})}}),s()(this,"findRootSpaces",e=>{const t=new Set(e);e.forEach(e=>{this.getChildSpaces(e.roomId).forEach(e=>{t.delete(e)})});const n=Array.from(t),i=new Set(Object(o.sortBy)(e,e=>e.roomId));return n.forEach(e=>{this.markTreeChildren(e,i)}),Array.from(i).forEach(e=>{i.has(e)&&(n.push(e),this.markTreeChildren(e,i))}),n}),s()(this,"rebuildSpaceHierarchy",()=>{const e=this.matrixClient.getVisibleRooms().filter(e=>e.isSpaceRoom()),[t,n]=e.reduce((e,t)=>{let[n,i]=e;switch(Object(j.b)(t.getMyMembership())){case j.a.Join:n.push(t);break;case j.a.Invite:i.push(t)}return[n,i]},[[],[]]),i=this.findRootSpaces(t),s=this.rootSpaces;this.rootSpaces=this.sortRootSpaces(i),this.onRoomsUpdate(),Object(v.e)(s,this.rootSpaces)&&this.emit(x.f,this.spacePanelSpaces,this.enabledMetaSpaces);const o=this._invitedSpaces;this._invitedSpaces=new Set(this.sortRootSpaces(n)),Object(_.b)(o,this._invitedSpaces)&&this.emit(x.c,this.invitedSpaces)}),s()(this,"rebuildParentMap",()=>{const e=this.matrixClient.getVisibleRooms().filter(e=>e.isSpaceRoom()&&"join"===e.getMyMembership());this.parentMap=new w.a,e.forEach(e=>{this.getChildren(e.roomId).forEach(t=>{this.parentMap.getOrCreate(t.roomId,new Set).add(e.roomId)})}),A.a.instance.setProperty("numSpaces",e.length)}),s()(this,"rebuildHomeSpace",()=>{if(this.allRoomsInHome)this.roomIdsBySpace.delete(x.a.Home);else{const e=new Set(this.matrixClient.getVisibleRooms().filter(this.showInHomeSpace).map(e=>e.roomId));this.roomIdsBySpace.set(x.a.Home,e)}this.activeSpace===x.a.Home&&this.switchSpaceIfNeeded()}),s()(this,"rebuildMetaSpaces",()=>{const e=new Set(this.enabledMetaSpaces),t=this.matrixClient.getVisibleRooms();if(e.has(x.a.Home)?this.rebuildHomeSpace():this.roomIdsBySpace.delete(x.a.Home),e.has(x.a.Favourites)){const e=t.filter(e=>e.tags[E.a.Favourite]);this.roomIdsBySpace.set(x.a.Favourites,new Set(e.map(e=>e.roomId)))}else this.roomIdsBySpace.delete(x.a.Favourites);if(e.has(x.a.Orphans)||e.has(x.a.Home)){const e=t.filter(e=>{var t;return!(null!==(t=this.parentMap.get(e.roomId))&&void 0!==t&&t.size||g.a.shared().getUserIdForRoomId(e.roomId))});this.roomIdsBySpace.set(x.a.Orphans,new Set(e.map(e=>e.roomId)))}Object(x.h)(this.activeSpace)&&this.switchSpaceIfNeeded()}),s()(this,"updateNotificationStates",e=>{const t=new Set(this.enabledMetaSpaces),n=this.matrixClient.getVisibleRooms();let i;t.has(x.a.People)?i=x.a.People:t.has(x.a.Home)&&(i=x.a.Home),e||(e=[...this.roomIdsBySpace.keys()],i===x.a.People&&e.push(x.a.People),t.has(x.a.Home)&&!this.allRoomsInHome&&e.push(x.a.Home)),e.forEach(e=>{if(this.allRoomsInHome&&e===x.a.Home)return;const t=this.getSpaceFilteredRoomIds(e,!0);this.getNotificationState(e).setRooms(n.filter(n=>e===x.a.People?this.isRoomInSpace(x.a.People,n.roomId):!(n.isSpaceRoom()||!t.has(n.roomId))&&(!i||!g.a.shared().getUserIdForRoomId(n.roomId)||e===i)))}),i!==x.a.People&&this.notificationStateMap.delete(x.a.People)}),s()(this,"showInHomeSpace",e=>{var t;return!!this.allRoomsInHome||!e.isSpaceRoom()&&!(null!==(t=this.parentMap.get(e.roomId))&&void 0!==t&&t.size&&!g.a.shared().getUserIdForRoomId(e.roomId)&&"invite"!==e.getMyMembership())}),s()(this,"onMemberUpdate",(e,t)=>{const n=H.isInSpace(e.getMember(t));var i,s;n?null===(i=this.userIdsBySpace.get(e.roomId))||void 0===i||i.add(t):null===(s=this.userIdsBySpace.get(e.roomId))||void 0===s||s.delete(t);this._aggregatedSpaceCache.userIdsBySpace.clear();const o=this.getKnownParents(e.roomId,!0);this.emit(e.roomId),o.forEach(e=>this.emit(e)),n||this.switchSpaceIfNeeded()}),s()(this,"onRoomsUpdate",()=>{const e=this.matrixClient.getVisibleRooms(),t=this.roomIdsBySpace,n=this.userIdsBySpace,i=this.childSpacesBySpace;this.roomIdsBySpace=new Map,this.userIdsBySpace=new Map,this.childSpacesBySpace=new Map,this.rebuildParentMap(),this.rebuildMetaSpaces();const s=new w.a;e.forEach(e=>{"join"===e.getMyMembership()&&this.getParents(e.roomId).forEach(t=>{s.getOrCreate(t.roomId,new Set).add(e.roomId)})}),this.rootSpaces.forEach(e=>{const t=(e,n)=>{var i,o;if(n.has(e))return;if(this.roomIdsBySpace.has(e)&&this.userIdsBySpace.has(e))return[this.roomIdsBySpace.get(e),this.userIdsBySpace.get(e)];const[r,a]=B(this.getChildren(e));this.childSpacesBySpace.set(e,new Set(r.map(e=>e.roomId)));const c=new Set(a.map(e=>e.roomId)),l=null===(i=this.matrixClient)||void 0===i?void 0:i.getRoom(e),d=new Set(null==l?void 0:l.getMembers().filter(e=>"join"===e.membership||"invite"===e.membership).map(e=>e.userId)),u=new Set(n).add(e);r.forEach(e=>{t(e.roomId,u)}),null===(o=s.get(e))||void 0===o||o.forEach(e=>{c.add(e)});const h=new Set(Array.from(c).flatMap(e=>this.matrixClient.getRoomUpgradeHistory(e,!0).map(e=>e.roomId)));return this.roomIdsBySpace.set(e,h),this.userIdsBySpace.set(e,d),[h,d]};t(e.roomId,new Set)});const o=Object(w.b)(t,this.roomIdsBySpace),r=Object(w.b)(n,this.userIdsBySpace),a=Object(w.b)(i,this.childSpacesBySpace),c=o.changed.filter(e=>Object(_.b)(t.get(e),this.roomIdsBySpace.get(e))),l=r.changed.filter(e=>Object(_.b)(n.get(e),this.userIdsBySpace.get(e))),d=a.changed.filter(e=>Object(_.b)(i.get(e),this.childSpacesBySpace.get(e))),u=new Set([...o.added,...r.added,...a.added,...o.removed,...r.removed,...a.removed,...c,...l,...d]);Array.from(u).flatMap(e=>[...this.getKnownParents(e,!0)]).forEach(e=>u.add(e)),this._aggregatedSpaceCache.roomIdsBySpace.clear(),this._aggregatedSpaceCache.userIdsBySpace.clear(),u.forEach(e=>{this.emit(e)}),u.has(this.activeSpace)&&this.switchSpaceIfNeeded();const h=[...u];this.enabledMetaSpaces.includes(x.a.People)&&r.added.length+r.removed.length+l.length>0&&h.push(x.a.People),this.updateNotificationStates(h)}),s()(this,"switchSpaceIfNeeded",(function(){var t;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:C.a.instance.getRoomId();e.isRoomInSpace(e.activeSpace,n)||null!==(t=e.matrixClient.getRoom(n))&&void 0!==t&&t.isSpaceRoom()||e.switchToRelatedSpace(n)})),s()(this,"switchToRelatedSpace",e=>{var t;if(this.suggestedRooms.find(t=>t.room_id===e))return;let n=null===(t=this.getCanonicalParent(e))||void 0===t?void 0:t.roomId;var i;n||(n=null===(i=this.rootSpaces.find(t=>this.isRoomInSpace(t.roomId,e)))||void 0===i?void 0:i.roomId);n||(n=[...this.enabledMetaSpaces].reverse().find(t=>this.isRoomInSpace(t,e))),n?this.setActiveSpace(n,!1):this.goToFirstSpace()}),s()(this,"onRoom",(e,t,n)=>{const i=e.getMyMembership();if(!i)return;const s=t||i;if(e.isSpaceRoom()){if("invite"===s){const t=this._invitedSpaces.size;this._invitedSpaces.add(e),t!==this._invitedSpaces.size&&this.emit(x.c,this.invitedSpaces)}else if("invite"===n&&"join"!==s)this._invitedSpaces.delete(e)&&this.emit(x.c,this.invitedSpaces);else{var o;this.rebuildSpaceHierarchy(),null===(o=this.parentMap.get(e.roomId))||void 0===o||o.forEach(e=>{this.emit(e)}),this.emit(e.roomId)}"join"===s&&e.roomId===C.a.instance.getRoomId()?this.setActiveSpace(e.roomId,!1):"leave"===s&&e.roomId===this.activeSpace&&this.goToFirstSpace(!0)}else if(this.onRoomsUpdate(),"join"===s){const n=this._suggestedRooms.length;this._suggestedRooms=this._suggestedRooms.filter(t=>t.room_id!==e.roomId),n!==this._suggestedRooms.length&&this.emit(x.e,this._suggestedRooms),"join"===t&&e.roomId===C.a.instance.getRoomId()&&this.switchSpaceIfNeeded(e.roomId)}}),s()(this,"onRoomState",e=>{const t=this.matrixClient.getRoom(e.getRoomId());if(t)switch(e.getType()){case r.b.SpaceChild:{const n=this.matrixClient.getRoom(e.getStateKey());t.isSpaceRoom()&&(null!=n&&n.isSpaceRoom()?(this.rebuildSpaceHierarchy(),this.emit(n.roomId)):this.onRoomsUpdate(),this.emit(t.roomId)),t.roomId===this.activeSpace&&"join"!==(null==n?void 0:n.getMyMembership())&&e.getPrevContent().suggested!==e.getContent().suggested&&this.loadSuggestedRooms(t);break}case r.b.SpaceParent:t.isSpaceRoom()?this.rebuildSpaceHierarchy():this.onRoomsUpdate(),this.emit(t.roomId);break;case r.b.RoomPowerLevels:t.isSpaceRoom()&&this.onRoomsUpdate()}}),s()(this,"onRoomStateMembers",e=>{const t=this.matrixClient.getRoom(e.getRoomId()),n=e.getStateKey();null!=t&&t.isSpaceRoom()&&g.a.shared().getDMRoomsForUserId(n).length>0&&e.getPrevContent().membership!==e.getContent().membership&&this.onMemberUpdate(t,n)}),s()(this,"onRoomAccountData",(e,t,n)=>{if(t.isSpaceRoom()&&e.getType()===r.b.SpaceOrder){var i,s;this.spaceOrderLocalEchoMap.delete(t.roomId);(null===(i=e.getContent())||void 0===i?void 0:i.order)!==(null==n||null===(s=n.getContent())||void 0===s?void 0:s.order)&&this.notifyIfOrderChanged()}else if(e.getType()===r.b.Tag){var o,a;const i=(null==n||null===(o=n.getContent())||void 0===o?void 0:o.tags)||{},s=(null===(a=e.getContent())||void 0===a?void 0:a.tags)||{};!!i[E.a.Favourite]!=!!s[E.a.Favourite]&&this.onRoomFavouriteChange(t)}}),s()(this,"onAccountData",(e,t)=>{if(e.getType()===r.b.Direct){var n;const i=new Set(Object.values(null!==(n=null==t?void 0:t.getContent())&&void 0!==n?n:{}).flat()),s=new Set(Object.values(e.getContent()).flat()),o=Object(_.a)(i,s);[...o.added,...o.removed].forEach(e=>{var t;const n=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e);n&&this.onRoomDmChange(n,s.has(e))}),o.removed.length>0&&this.switchSpaceIfNeeded()}}),s()(this,"getSpaceTagOrdering",e=>{var t,n;return this.spaceOrderLocalEchoMap.has(e.roomId)?this.spaceOrderLocalEchoMap.get(e.roomId):K(null===(t=e.getAccountData(r.b.SpaceOrder))||void 0===t||null===(n=t.getContent())||void 0===n?void 0:n.order)}),p.b.monitorSetting("Spaces.allRoomsInHome",null),p.b.monitorSetting("Spaces.enabledMetaSpaces",null),p.b.monitorSetting("Spaces.showPeopleInSpace",null)}get invitedSpaces(){return Array.from(this._invitedSpaces)}get enabledMetaSpaces(){return this._enabledMetaSpaces}get spacePanelSpaces(){return this.rootSpaces}get activeSpace(){return this._activeSpace}get activeSpaceRoom(){var e;return Object(x.h)(this._activeSpace)?null:null===(e=this.matrixClient)||void 0===e?void 0:e.getRoom(this._activeSpace)}get suggestedRooms(){return this._suggestedRooms}get allRoomsInHome(){return this._allRoomsInHome}setActiveRoomInSpace(e){var t,n;if(Object(x.h)(e)||null!==(t=this.matrixClient)&&void 0!==t&&null!==(n=t.getRoom(e))&&void 0!==n&&n.isSpaceRoom())if(e!==this.activeSpace&&this.setActiveSpace(e,!1),e){const t=this.getNotificationState(e).getFirstRoomWithNotifications();h.a.dispatch({action:O.a.ViewRoom,room_id:t,context_switch:!0,metricsTrigger:"WebSpacePanelNotificationBadge"})}else{const e=m.b.instance.unfilteredLists;for(let t=0;t<k.a.length;t++){const n=e[k.a[t]].find(e=>{if(this.showInHomeSpace(e)){return S.a.instance.getRoomState(e).isUnread}});if(n){h.a.dispatch({action:O.a.ViewRoom,room_id:n.roomId,context_switch:!0,metricsTrigger:"WebSpacePanelNotificationBadge"});break}}}}get restrictedJoinRuleSupport(){return this._restrictedJoinRuleSupport}setActiveSpace(e){let t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(e&&this.matrixClient&&e!==this.activeSpace){var i;if(Object(x.h)(e)){if(!this.enabledMetaSpaces.includes(e))return}else if(t=this.matrixClient.getRoom(e),null===(i=t)||void 0===i||!i.isSpaceRoom())return;if(window.localStorage.setItem("mx_active_space",this._activeSpace=e),n){var s,o;const n=window.localStorage.getItem(F(e));"invite"!==(null===(s=t)||void 0===s?void 0:s.getMyMembership())&&"join"===(null===(o=this.matrixClient.getRoom(n))||void 0===o?void 0:o.getMyMembership())&&this.isRoomInSpace(e,n)?h.a.dispatch({action:O.a.ViewRoom,room_id:n,context_switch:!0,metricsTrigger:"WebSpaceContextSwitch"}):t?h.a.dispatch({action:O.a.ViewRoom,room_id:e,context_switch:!0,metricsTrigger:"WebSpaceContextSwitch"}):h.a.dispatch({action:O.a.ViewHomePage,context_switch:!0})}this.emit(x.d,this.activeSpace),this.emit(x.e,this._suggestedRooms=[]),t&&(this.loadSuggestedRooms(t),q.instance.traverseSpace(e,e=>{var t;null===(t=this.matrixClient.getRoom(e))||void 0===t||t.loadMembersIfNeeded()},!1))}}async loadSuggestedRooms(e){const t=await this.fetchSuggestedRooms(e);this._activeSpace===e.roomId&&(this._suggestedRooms=t,this.emit(x.e,this._suggestedRooms))}addRoomToSpace(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return this.matrixClient.sendStateEvent(e.roomId,r.b.SpaceChild,{via:n,suggested:i,auto_join:s},t)}getChildren(e){var t;const n=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e),i=null==n?void 0:n.currentState.getStateEvents(r.b.SpaceChild).filter(e=>{var t;return null===(t=e.getContent())||void 0===t?void 0:t.via});return Object(o.sortBy)(i,e=>V(e.getContent().order,e.getTs(),e.getStateKey())).map(e=>{const t=this.matrixClient.getRoomUpgradeHistory(e.getStateKey(),!0);return t[t.length-1]}).filter(e=>"join"===(null==e?void 0:e.getMyMembership())||"invite"===(null==e?void 0:e.getMyMembership()))||[]}getChildRooms(e){return this.getChildren(e).filter(e=>!e.isSpaceRoom())}getChildSpaces(e){return this.getChildren(e).filter(e=>e.isSpaceRoom()&&"join"===e.getMyMembership())}getParents(e){var t,n;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const s=null===(t=this.matrixClient)||void 0===t?void 0:t.getUserId(),o=null===(n=this.matrixClient)||void 0===n?void 0:n.getRoom(e);return(null==o?void 0:o.currentState.getStateEvents(r.b.SpaceParent).map(t=>{const n=t.getContent();if(!Array.isArray(n.via)||i&&!n.canonical)return;const o=this.matrixClient.getRoom(t.getStateKey()),a=null==o?void 0:o.currentState.getStateEvents(r.b.SpaceChild,e);return null==o||!o.currentState.maySendStateEvent(r.b.SpaceChild,s)||a&&!Array.isArray(a.getContent().via)?void 0:o}).filter(Boolean))||[]}getCanonicalParent(e){var t;const n=this.getParents(e,!0);return(null===(t=Object(o.sortBy)(n,e=>e.roomId))||void 0===t?void 0:t[0])||null}getKnownParents(e,t){return t?P(this.parentMap,this.parentMap,e):this.parentMap.get(e)||new Set}isRoomInSpace(e,t){var n,i;let s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(e===x.a.Home&&this.allRoomsInHome)return!0;if(null!==(n=this.getSpaceFilteredRoomIds(e,s))&&void 0!==n&&n.has(t))return!0;const o=g.a.shared().getUserIdForRoomId(t);return!!o&&(e===x.a.Home||e===x.a.People||!(Object(x.h)(e)||null===(i=this.getSpaceFilteredUserIds(e,s))||void 0===i||!i.has(o)||!p.b.getValue("Spaces.showPeopleInSpace",e)))}static isInSpace(e){return"join"===e.membership||"invite"===e.membership}notifyIfOrderChanged(){const e=this.sortRootSpaces(this.rootSpaces);Object(v.e)(this.rootSpaces,e)&&(this.rootSpaces=e,this.emit(x.f,this.spacePanelSpaces,this.enabledMetaSpaces))}onRoomFavouriteChange(e){this.enabledMetaSpaces.includes(x.a.Favourites)&&(e.tags[E.a.Favourite]?this.roomIdsBySpace.get(x.a.Favourites).add(e.roomId):this.roomIdsBySpace.get(x.a.Favourites).delete(e.roomId),this.emit(x.a.Favourites))}onRoomDmChange(e,t){const n=new Set(this.enabledMetaSpaces);if(!this.allRoomsInHome&&n.has(x.a.Home)){const t=this.roomIdsBySpace.get(x.a.Home);if(this.showInHomeSpace(e))null==t||t.add(e.roomId);else if(!this.roomIdsBySpace.get(x.a.Orphans).has(e.roomId)){var i;null===(i=this.roomIdsBySpace.get(x.a.Home))||void 0===i||i.delete(e.roomId)}this.emit(x.a.Home)}n.has(x.a.People)&&this.emit(x.a.People),(n.has(x.a.Orphans)||n.has(x.a.Home))&&t&&this.roomIdsBySpace.get(x.a.Orphans).delete(e.roomId)&&(this.emit(x.a.Orphans),this.emit(x.a.Home))}async reset(){this.rootSpaces=[],this.parentMap=new w.a,this.notificationStateMap=new Map,this.roomIdsBySpace=new Map,this.userIdsBySpace=new Map,this._aggregatedSpaceCache.roomIdsBySpace.clear(),this._aggregatedSpaceCache.userIdsBySpace.clear(),this._activeSpace=x.a.Home,this._suggestedRooms=[],this._invitedSpaces=new Set,this._enabledMetaSpaces=[]}async onNotReady(){this.matrixClient&&(this.matrixClient.removeListener(c.b.Room,this.onRoom),this.matrixClient.removeListener(a.c.MyMembership,this.onRoom),this.matrixClient.removeListener(a.c.AccountData,this.onRoomAccountData),this.matrixClient.removeListener(d.b.Events,this.onRoomState),this.matrixClient.removeListener(d.b.Members,this.onRoomStateMembers),this.matrixClient.removeListener(c.b.AccountData,this.onAccountData)),await this.reset()}async onReady(){this.matrixClient.on(c.b.Room,this.onRoom),this.matrixClient.on(a.c.MyMembership,this.onRoom),this.matrixClient.on(a.c.AccountData,this.onRoomAccountData),this.matrixClient.on(d.b.Events,this.onRoomState),this.matrixClient.on(d.b.Members,this.onRoomStateMembers),this.matrixClient.on(c.b.AccountData,this.onAccountData),this.matrixClient.getCapabilities().then(e=>{var t,n;this._restrictedJoinRuleSupport=null==e||null===(t=e["m.room_versions"])||void 0===t||null===(n=t["org.matrix.msc3244.room_capabilities"])||void 0===n?void 0:n.restricted});const e=this._enabledMetaSpaces,t=p.b.getValue("Spaces.enabledMetaSpaces");this._enabledMetaSpaces=L.filter(e=>t[e]),this._allRoomsInHome=p.b.getValue("Spaces.allRoomsInHome"),this.sendUserProperties(),this.rebuildSpaceHierarchy(),Object(v.d)(e,this._enabledMetaSpaces)&&this.emit(x.f,this.spacePanelSpaces,this.enabledMetaSpaces);const n=window.localStorage.getItem("mx_active_space");(n&&!Object(x.h)(n)?this.matrixClient.getRoom(n):t[n])?this.setActiveSpace(n,!1):this.switchSpaceIfNeeded()}sendUserProperties(){const e=new Set(this.enabledMetaSpaces);A.a.instance.setProperty("WebMetaSpaceHomeEnabled",e.has(x.a.Home)),A.a.instance.setProperty("WebMetaSpaceHomeAllRooms",this.allRoomsInHome),A.a.instance.setProperty("WebMetaSpacePeopleEnabled",e.has(x.a.People)),A.a.instance.setProperty("WebMetaSpaceFavouritesEnabled",e.has(x.a.Favourites)),A.a.instance.setProperty("WebMetaSpaceOrphansEnabled",e.has(x.a.Orphans))}goToFirstSpace(){var e,t;let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.setActiveSpace(null!==(e=this.enabledMetaSpaces[0])&&void 0!==e?e:null===(t=this.spacePanelSpaces[0])||void 0===t?void 0:t.roomId,n)}async onAction(e){if(this.matrixClient)switch(e.action){case O.a.ViewRoom:{var t;const n=(null===(t=e.justCreatedOpts)||void 0===t?void 0:t.roomType)===r.f.Space;if(e.context_switch||e.justCreatedOpts&&!n)break;let i=e.room_id;if(e.room_alias&&!i&&(i=Object(T.a)(e.room_alias)),!i)return;const s=this.matrixClient.getRoom(i);null!=s&&s.isSpaceRoom()?this.setActiveSpace(s.roomId,!1):this.switchSpaceIfNeeded(i),window.localStorage.setItem(F(this.activeSpace),e.room_id);break}case O.a.ViewHomePage:!e.context_switch&&this.enabledMetaSpaces.includes(x.a.Home)&&(this.setActiveSpace(x.a.Home,!1),window.localStorage.setItem(F(this.activeSpace),""));break;case O.a.AfterLeaveRoom:Object(x.h)(this._activeSpace)||e.room_id!==this._activeSpace||this.goToFirstSpace(!0);break;case O.a.SwitchSpace:{if(e.num<1||e.num>9)break;const t=this.enabledMetaSpaces.length;e.num<=t?this.setActiveSpace(this.enabledMetaSpaces[e.num-1]):this.spacePanelSpaces.length>e.num-t-1&&this.setActiveSpace(this.spacePanelSpaces[e.num-t-1].roomId);break}case O.a.SettingUpdated:switch(e.settingName){case"Spaces.allRoomsInHome":{const e=p.b.getValue("Spaces.allRoomsInHome");this.allRoomsInHome!==e&&(this._allRoomsInHome=e,this.emit(x.b,this.allRoomsInHome),this.enabledMetaSpaces.includes(x.a.Home)&&this.rebuildHomeSpace(),this.sendUserProperties());break}case"Spaces.enabledMetaSpaces":{const e=p.b.getValue("Spaces.enabledMetaSpaces"),t=L.filter(t=>e[t]);if(Object(v.d)(this._enabledMetaSpaces,t)){const n=this.enabledMetaSpaces.some(e=>e===x.a.Home||e===x.a.People);this._enabledMetaSpaces=t;const i=this.enabledMetaSpaces.some(e=>e===x.a.Home||e===x.a.People);Object(x.h)(this.activeSpace)&&!e[this.activeSpace]&&this.switchSpaceIfNeeded(),this.rebuildMetaSpaces(),n!==i?this.updateNotificationStates():this.updateNotificationStates(t),this.emit(x.f,this.spacePanelSpaces,this.enabledMetaSpaces),this.sendUserProperties()}break}case"Spaces.showPeopleInSpace":this.emit(e.roomId),this.enabledMetaSpaces.some(e=>e===x.a.Home||e===x.a.People)||this.updateNotificationStates([e.roomId])}}}getNotificationState(e){if(this.notificationStateMap.has(e))return this.notificationStateMap.get(e);const t=new y(W);return this.notificationStateMap.set(e,t),t}traverseSpace(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;if(i&&i.has(e))return;t(e);const s=new Set(i).add(e),[o,r]=B(this.getChildren(e));n&&r.forEach(e=>t(e.roomId)),o.forEach(e=>this.traverseSpace(e.roomId,t,n,s))}sortRootSpaces(e){return Object(o.sortBy)(e,[this.getSpaceTagOrdering,"roomId"])}async setRootSpaceOrder(e,t){this.spaceOrderLocalEchoMap.set(e.roomId,t);try{await this.matrixClient.setRoomAccountData(e.roomId,r.b.SpaceOrder,{order:t})}catch(n){l.a.warn("Failed to set root space order",n),this.spaceOrderLocalEchoMap.get(e.roomId)===t&&this.spaceOrderLocalEchoMap.delete(e.roomId)}}moveRootSpace(e,t){(function(e,t,n){var i,s,o,r,a,c;let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:50;if(t<0||n<0||t>e.length||n>e.length||t===n)return[];const d=e.map((e,t)=>({index:t,order:e})),u=Object(v.l)(d,t,n),h=void 0===(null===(i=u[n-1])||void 0===i?void 0:i.order);let m=n,p=n,g=!0;const f=void 0!==(null===(s=u[n+1])||void 0===s?void 0:s.order)?Object(R.I)(u[n+1].order):BigInt(Number.MAX_VALUE);for(let e=n-1,t=1;e>=0;e--,t++){var b;if(void 0!==(null===(b=u[e])||void 0===b?void 0:b.order)&&f-Object(R.I)(u[e].order)>t)break;m=e}const y=void 0===u[0].order?void 0:Object(R.I)(u[0].order),S=BigInt(n);0===m&&void 0!==y&&f-y<=S&&y<=S&&(g=!1);const E=!h;let w=E;if(E){var _,C;const e=void 0!==(null===(_=u[n-1])||void 0===_?void 0:_.order)?Object(R.I)(null===(C=u[n-1])||void 0===C?void 0:C.order):BigInt(Number.MIN_VALUE);for(let t=n+1,i=1;t<u.length;t++,i++){var O;if(void 0===(null===(O=u[t])||void 0===O?void 0:O.order)||Object(R.I)(u[t].order)-e>i)break;p=t}p===u.length-1&&(u[p]?Object(R.I)(u[p].order):BigInt(Number.MAX_VALUE))-e<=p-n&&(w=!1)}const k=g?n-m:Number.MAX_SAFE_INTEGER,x=w?p-n:Number.MAX_SAFE_INTEGER;h||k<x?p=n:m=n;const T=null!==(o=null===(r=u[m-1])||void 0===r?void 0:r.order)&&void 0!==o?o:"",j=null!==(a=null===(c=u[p+1])||void 0===c?void 0:c.order)&&void 0!==a?a:R.a.charAt(R.a.length-1).repeat(T.length||1),N=I(T,j,1+p-m,l);return N.map((e,t)=>({index:u[m+t].index,order:e}))})(this.rootSpaces.map(this.getSpaceTagOrdering),e,t).forEach(e=>{let{index:t,order:n}=e;this.setRootSpaceOrder(this.rootSpaces[t],n)}),this.notifyIfOrderChanged()}}class q{static get instance(){return q.internalInstance}}s()(q,"internalInstance",new H),window.mxSpaceStore=q.instance},function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"e",(function(){return y})),n.d(t,"g",(function(){return S})),n.d(t,"f",(function(){return E})),n.d(t,"d",(function(){return w})),n.d(t,"i",(function(){return _})),n.d(t,"j",(function(){return C})),n.d(t,"c",(function(){return O})),n.d(t,"h",(function(){return I})),n.d(t,"b",(function(){return N}));var i=n(88),s=n.n(i),o=n(956),r=n.n(o),a=n(7),c=n(0),l=n(116),d=n(90),u=n(632),h=n(457);class m extends h.b{constructor(e){if(super(),s()(this,"elementUrl",void 0),this.elementUrl=e,!this.elementUrl.startsWith("http:")&&!this.elementUrl.startsWith("https:"))throw new Error("Element prefix URL does not appear to be an HTTP(S) URL")}forEvent(e,t,n){return`${this.elementUrl}/#/room/${e}/${t}${this.encodeServerCandidates(n)}`}forRoom(e,t){return`${this.elementUrl}/#/room/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${this.elementUrl}/#/user/${e}`}forGroup(e){return`${this.elementUrl}/#/group/${e}`}forEntity(e){if("!"===e[0]||"#"===e[0])return this.forRoom(e);if("@"===e[0])return this.forUser(e);if("+"===e[0])return this.forGroup(e);throw new Error("Unrecognized entity")}isPermalinkHost(e){const t=new URL(this.elementUrl);return e===(t.host||t.hostname)}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(this.elementUrl))throw new Error("Does not appear to be a permalink");const t=e.substring((this.elementUrl+"/#/").length);return m.parseAppRoute(t)}static parseAppRoute(e){const t=e.split("/");if(t.length<2)throw new Error("URL is missing parts");const[n]=t.splice(-1,1),[i,s=""]=n.split("?");t.push(i);const o=t[0],r=t[1];if("user"===o)return h.a.forUser(r);if("room"===o){const e=t.length>2?t.slice(2).join("/"):"",n=s.split(/&?via=/).filter(e=>!!e);return h.a.forEvent(r,e,n)}if("group"===o)return h.a.forGroup(r);throw new Error("Unknown entity type in permalink")}}var p=n(98),g=n(358);class f extends h.b{constructor(){super()}encodeEntity(e){if("!"===e[0])return"roomid/"+e.slice(1);if("#"===e[0])return"r/"+e.slice(1);if("@"===e[0])return"u/"+e.slice(1);if("$"===e[0])return"e/"+e.slice(1);throw new Error("Cannot encode entity: "+e)}forEvent(e,t,n){return"matrix:"+this.encodeEntity(e)+`/${this.encodeEntity(t)}${this.encodeServerCandidates(n)}`}forRoom(e,t){return`matrix:${this.encodeEntity(e)}${this.encodeServerCandidates(t)}`}forUser(e){return"matrix:"+this.encodeEntity(e)}forGroup(e){throw new Error("Deliberately not implemented")}forEntity(e){return"matrix:"+this.encodeEntity(e)}isPermalinkHost(e){return""===e}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith("matrix:"))throw new Error("Does not appear to be a permalink");const t=e.substring("matrix:".length).split("/"),n=t[0],i=t[1];if("u"===n)return h.a.forUser("@"+i);if("r"===n||"roomid"===n){const e="r"===n?"#":"!";if(2===t.length){const[t,n=""]=i.split("?"),s=n.split(/&?via=/g).filter(e=>!!e);return h.a.forRoom(`${e}${t}`,s)}if("e"===t[2]){const n=t.length>3?t.slice(3).join("/"):"",[s,o=""]=n.split("?"),r=o.split(/&?via=/g).filter(e=>!!e);return h.a.forEvent(`${e}${i}`,"$"+s,r)}throw new Error("Faulty room permalink")}throw new Error("Unknown entity type in permalink")}}const v=/.*/;class b{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(s()(this,"room",void 0),s()(this,"roomId",void 0),s()(this,"highestPlUserId",void 0),s()(this,"populationMap",void 0),s()(this,"bannedHostsRegexps",void 0),s()(this,"allowedHostsRegexps",void 0),s()(this,"_serverCandidates",void 0),s()(this,"started",void 0),s()(this,"onRoomStateUpdate",()=>{this.fullUpdate()}),s()(this,"updateServerCandidates",()=>{const e=new Set;this.highestPlUserId&&e.add(k(this.highestPlUserId));const t=Object.keys(this.populationMap).sort((e,t)=>this.populationMap[t]-this.populationMap[e]);for(let n=0;n<t.length&&e.size<3;n++){const i=t[n];e.has(i)||j(i)||T(i,this.bannedHostsRegexps)||!T(i,this.allowedHostsRegexps)||e.add(i)}this._serverCandidates=[...e]}),this.room=e,this.roomId=e?e.roomId:t,this.highestPlUserId=null,this.populationMap=null,this.bannedHostsRegexps=null,this.allowedHostsRegexps=null,this._serverCandidates=null,this.started=!1,!this.roomId)throw new Error("Failed to resolve a roomId for the permalink creator to use")}load(){this.room&&this.room.currentState?this.fullUpdate():c.a.warn("Tried to load a permalink creator with no room state")}start(){this.load(),this.room.currentState.on(l.b.Update,this.onRoomStateUpdate),this.started=!0}stop(){this.room.currentState.removeListener(l.b.Update,this.onRoomStateUpdate),this.started=!1}get serverCandidates(){return this._serverCandidates}isStarted(){return this.started}forEvent(e){return R().forEvent(this.roomId,e,this._serverCandidates)}forShareableRoom(){if(this.room){const e=this.room.getCanonicalAlias();if(e)return R().forRoom(e)}return R().forRoom(this.roomId,this._serverCandidates)}forRoom(){return R().forRoom(this.roomId,this._serverCandidates)}fullUpdate(){this.updateAllowedServers(),this.updateHighestPlUser(),this.updatePopulationMap(),this.updateServerCandidates()}updateHighestPlUser(){const e=this.room.currentState.getStateEvents("m.room.power_levels","");if(e){const t=e.getContent();if(t){const e=t.users;if(e){const t=Object.entries(e).filter(e=>{let[t]=e;const n=this.room.getMember(t);if(!n||"join"!==n.membership)return!1;const i=k(t);return!j(i)&&!T(i,this.bannedHostsRegexps)&&T(i,this.allowedHostsRegexps)}).reduce((e,t)=>t[1]>e[1]?t:e,[null,0]),[n,i]=t;if(null!==n&&i>=50)return void(this.highestPlUserId=n)}}}this.highestPlUserId=null}updateAllowedServers(){const e=[];let t=[v];if(this.room.currentState){const n=this.room.currentState.getStateEvents("m.room.server_acl","");if(n&&n.getContent()){const i=e=>new RegExp("^"+a.r(e,!1)+"$");(n.getContent().deny||[]).forEach(t=>e.push(i(t)));const s=n.getContent().allow||[];t=[],s.forEach(e=>t.push(i(e)))}}this.bannedHostsRegexps=e,this.allowedHostsRegexps=t}updatePopulationMap(){const e={};for(const t of this.room.getJoinedMembers()){const n=k(t.userId);e[n]||(e[n]=0),e[n]++}this.populationMap=e}}function y(e){return R().forEntity(e)}function S(e){return R().forUser(e)}function E(e){if(!e)throw new Error("can't permalink a falsy roomId");if("!"!==e[0])return R().forRoom(e,[]);const t=d.a.get().getRoom(e);if(!t)return R().forRoom(e,[]);const n=new b(t);return n.load(),n.forShareableRoom()}function w(e){return!!(new u.b).isPermalinkHost(e)||R().isPermalinkHost(e)}function _(e){if(!e)return null;if("#"===e[0]||"!"===e[0])return E(e);if("@"===e[0])return S(e);if("+"===e[0])return t=e,R().forGroup(t);var t;if("matrix:"===e.slice(0,7))try{const t=I(e);if(t){if(t.roomIdOrAlias){const e=t.eventId?"/"+t.eventId:"";let n=u.a+`/#/${t.roomIdOrAlias}${e}`;return t.viaServers.length>0&&(n+=(new u.b).encodeServerCandidates(t.viaServers)),n}if(t.groupId)return u.a+"/#/"+t.groupId;if(t.userId)return u.a+"/#/"+t.userId}}catch{}return e}function C(e){if(!(e.startsWith("http:")||e.startsWith("https:")||e.startsWith("matrix:")||e.startsWith("vector:")))return e;try{const t=decodeURIComponent(e).match(g.a);if(t)return t[1]}catch(t){return e}try{const t=I(e);if(t)if(t.roomIdOrAlias){const n=t.eventId?"/"+t.eventId:"";e=`#/room/${t.roomIdOrAlias}${n}`,t.viaServers.length>0&&(e+=(new u.b).encodeServerCandidates(t.viaServers))}else t.userId?e="#/user/"+t.userId:t.groupId&&(e="#/group/"+t.groupId)}catch(e){}return e}function O(e){try{let t=I(e);if(!t){const n=e.match(g.a);if(n){const e=new m("http://localhost"),i=n[1].split("#").slice(1).join("#");t=e.parsePermalink("http://localhost/#"+i)}}if(!t)return null;if(t.userId)return t.userId;if(t.roomIdOrAlias)return t.roomIdOrAlias;if(t.groupId)return t.groupId}catch(e){}return null}function R(){const e=p.b.get("permalink_prefix");return e&&e!==u.a?new m(e):new u.b}function I(e){try{const t=p.b.get("permalink_prefix");if(decodeURIComponent(e).startsWith(u.a))return(new u.b).parsePermalink(decodeURIComponent(e));if(e.startsWith("matrix:"))return(new f).parsePermalink(e);if(t&&e.startsWith(t))return new m(t).parsePermalink(e)}catch(e){c.a.error("Failed to parse permalink",e)}return null}function k(e){return e.split(":").splice(1).join(":")}function x(e){return e?new URL("https://"+e).hostname:null}function T(e,t){if(!(e=x(e)))return!0;if(t.length>0&&!t[0].test)throw new Error(t[0].toString());return t.some(t=>t.test(e))}function j(e){return!!(e=x(e))&&(e.startsWith("[")&&e.endsWith("]")&&(e=e.substring(1,e.length-1)),r()(e))}const N=e=>{const t=new b(e);return t.load(),t.serverCandidates}},function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"g",(function(){return l})),n.d(t,"d",(function(){return d})),n.d(t,"h",(function(){return u})),n.d(t,"k",(function(){return h})),n.d(t,"a",(function(){return m})),n.d(t,"j",(function(){return p})),n.d(t,"l",(function(){return v})),n.d(t,"e",(function(){return b})),n.d(t,"f",(function(){return y})),n.d(t,"i",(function(){return S})),n.d(t,"c",(function(){return E}));var i=n(89);function s(){return[Object(i.a)("Sun"),Object(i.a)("Mon"),Object(i.a)("Tue"),Object(i.a)("Wed"),Object(i.a)("Thu"),Object(i.a)("Fri"),Object(i.a)("Sat")]}function o(){return[Object(i.a)("Jan"),Object(i.a)("Feb"),Object(i.a)("Mar"),Object(i.a)("Apr"),Object(i.a)("May"),Object(i.a)("Jun"),Object(i.a)("Jul"),Object(i.a)("Aug"),Object(i.a)("Sep"),Object(i.a)("Oct"),Object(i.a)("Nov"),Object(i.a)("Dec")]}function r(e){return(e<10?"0":"")+e}function a(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e.getHours()%12;const s=r(e.getMinutes()),o=e.getHours()>=12?Object(i.a)("PM"):Object(i.a)("AM");if(n=n||12,t){return`${n}:${s}:${r(e.getSeconds())}${o}`}return`${n}:${s}${o}`}function c(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=new Date,r=s(),a=o();return e.toDateString()===n.toDateString()?h(e,t):n.getTime()-e.getTime()<5184e5?Object(i.a)("%(weekDayName)s %(time)s",{weekDayName:r[e.getDay()],time:h(e,t)}):n.getFullYear()===e.getFullYear()?Object(i.a)("%(weekDayName)s, %(monthName)s %(day)s %(time)s",{weekDayName:r[e.getDay()],monthName:a[e.getMonth()],day:e.getDate(),time:h(e,t)}):d(e,t)}function l(e){const t=s(),n=o();return Object(i.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s",{weekDayName:t[e.getDay()],monthName:n[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear()})}function d(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const r=s(),a=o();return Object(i.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s %(time)s",{weekDayName:r[e.getDay()],monthName:a[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear(),time:n?u(e,t):h(e,t)})}function u(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t?a(e,!0):r(e.getHours())+":"+r(e.getMinutes())+":"+r(e.getSeconds())}function h(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t?a(e):r(e.getHours())+":"+r(e.getMinutes())}function m(e){const t=e.getUTCHours(),n=e.getUTCMinutes(),i=e.getUTCSeconds();let s="";return t&&(s+=t+"h "),(n||s)&&(s+=n+"m "),(i||s)&&(s+=i+"s"),s}function p(e){const t=Math.floor(e/3600).toFixed(0).padStart(2,"0");let n="";return"00"!==t&&(n+=t+":"),n+=`${Math.floor(e%3600/60).toFixed(0).padStart(2,"0")}:${Math.floor(e%3600%60).toFixed(0).padStart(2,"0")}`,n}function g(e,t){return Math.abs(e.getTime()-t.getTime())<=864e5}function f(e,t){return e.getFullYear()===t.getFullYear()}function v(e,t){return!(!t||!e)&&(!g(e,t)||e.getDay()!==t.getDay())}function b(e){return Object(i.a)("%(date)s at %(time)s",{date:e.toLocaleDateString().replace(/\//g,"-"),time:e.toLocaleTimeString().replace(/:/g,"-")})}function y(e){return e.getFullYear()+"/"+r(e.getMonth()+1)+"/"+r(e.getDate())}function S(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=new Date(Date.now());if(g(e,n))return h(e,t);{let t=`${o()[e.getMonth()]} ${e.getDate()}`;return f(e,n)||(t+=", "+e.getFullYear()),t}}function E(e){return e>=864e5?Object(i.a)("%(value)sd",{value:Math.round(e/864e5)}):e>=36e5?Object(i.a)("%(value)sh",{value:Math.round(e/36e5)}):e>=6e4?Object(i.a)("%(value)sm",{value:Math.round(e/6e4)}):Object(i.a)("%(value)ss",{value:Math.round(e/1e3)})}},function(e,t,n){"use strict";n.d(t,"g",(function(){return S})),n.d(t,"c",(function(){return E})),n.d(t,"f",(function(){return w})),n.d(t,"h",(function(){return C})),n.d(t,"d",(function(){return O})),n.d(t,"i",(function(){return R})),n.d(t,"e",(function(){return l})),n.d(t,"a",(function(){return f})),n.d(t,"b",(function(){return v.a}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(114),c=n(109);const l=e=>{let{children:t,inputRef:n}=e;const[i,s,o]=R(n);return t({onFocus:i,isActive:s,ref:o})};var d=n(99),u=n.n(d),h=n(103),m=n.n(h),p=n(91);const g=["inputRef","onFocus"],f=e=>{let{inputRef:t,onFocus:n}=e,i=m()(e,g);const[s,o,a]=R(t);return r.a.createElement(p.a,u()({},i,{onFocus:e=>{s(),null==n||n(e)},inputRef:a,tabIndex:o?0:-1}))};var v=n(487);function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?b(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function S(e){return e.matches('input:not([type="radio"]):not([type="checkbox"]), textarea, select, [contenteditable=true]')}const E=Object(o.createContext)({state:{activeRef:null,refs:[]},dispatch:()=>{}});let w;E.displayName="RovingTabIndexContext",function(e){e.Register="REGISTER",e.Unregister="UNREGISTER",e.SetFocus="SET_FOCUS"}(w||(w={}));const _=(e,t)=>{switch(t.type){case w.Register:return e.activeRef||(e.activeRef=t.payload.ref),e.refs.push(t.payload.ref),e.refs.sort((e,t)=>{if(e===t)return 0;const n=e.current.compareDocumentPosition(t.current);return n&Node.DOCUMENT_POSITION_FOLLOWING||n&Node.DOCUMENT_POSITION_CONTAINED_BY?-1:n&Node.DOCUMENT_POSITION_PRECEDING||n&Node.DOCUMENT_POSITION_CONTAINS?1:0}),y({},e);case w.Unregister:{const s=e.refs.findIndex(e=>e===t.payload.ref);if(-1===s)return e;var n,i;if(e.refs.splice(s,1)[0]===e.activeRef)if(s>=e.refs.length?e.activeRef=C(e.refs,e.refs.length-1,!0):e.activeRef=C(e.refs,s)||C(e.refs,s,!0),document.activeElement===document.body)null===(n=e.activeRef)||void 0===n||null===(i=n.current)||void 0===i||i.focus();return y({},e)}case w.SetFocus:return e.activeRef===t.payload.ref?e:(e.activeRef=t.payload.ref,y({},e));default:return e}},C=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(n)for(let n=t;n<e.length&&n>=0;n--){var i;if(null!==(null===(i=e[n].current)||void 0===i?void 0:i.offsetParent))return e[n]}else for(let n=t;n<e.length&&n>=0;n++){var s;if(null!==(null===(s=e[n].current)||void 0===s?void 0:s.offsetParent))return e[n]}},O=e=>{let{children:t,handleHomeEnd:n,handleUpDown:i,handleLeftRight:s,onKeyDown:l}=e;const[d,u]=Object(o.useReducer)(_,{activeRef:null,refs:[]}),h=Object(o.useMemo)(()=>({state:d,dispatch:u}),[d]),m=Object(o.useCallback)(e=>{if(l&&(l(e,h.state),e.defaultPrevented))return;let t=!1;const o=Object(a.a)().getAccessibilityAction(e);let r;if(S(e.target))switch(o){case c.h.Tab:if(t=!0,h.state.refs.length>0){const t=h.state.refs.indexOf(h.state.activeRef);r=C(h.state.refs,t+(e.shiftKey?-1:1),e.shiftKey)}}else switch(o){case c.h.Home:n&&(t=!0,r=C(h.state.refs,0));break;case c.h.End:n&&(t=!0,r=C(h.state.refs,h.state.refs.length-1,!0));break;case c.h.ArrowDown:case c.h.ArrowRight:if((o===c.h.ArrowDown&&i||o===c.h.ArrowRight&&s)&&(t=!0,h.state.refs.length>0)){const e=h.state.refs.indexOf(h.state.activeRef);r=C(h.state.refs,e+1)}break;case c.h.ArrowUp:case c.h.ArrowLeft:if((o===c.h.ArrowUp&&i||o===c.h.ArrowLeft&&s)&&(t=!0,h.state.refs.length>0)){const e=h.state.refs.indexOf(h.state.activeRef);r=C(h.state.refs,e-1,!0)}}var d;(t&&(e.preventDefault(),e.stopPropagation()),r)&&(null===(d=r.current)||void 0===d||d.focus(),u({type:w.SetFocus,payload:{ref:r}}))},[h,l,n,i,s]);return r.a.createElement(E.Provider,{value:h},t({onKeyDownHandler:m}))},R=e=>{const t=Object(o.useContext)(E);let n=Object(o.useRef)(null);e&&(n=e),Object(o.useLayoutEffect)(()=>(t.dispatch({type:w.Register,payload:{ref:n}}),()=>{t.dispatch({type:w.Unregister,payload:{ref:n}})}),[]);return[Object(o.useCallback)(()=>{t.dispatch({type:w.SetFocus,payload:{ref:n}})},[]),t.state.activeRef===n,n]}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(111),r=n(119),a=n(0),c=n(97),l=n(90);function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class h{constructor(e){var t,n;this.matrixClient=e,s()(this,"roomToUser",null),s()(this,"userToRooms",null),s()(this,"hasSentOutPatchDirectAccountDataPatch",void 0),s()(this,"mDirectEvent",void 0),s()(this,"onAccountData",e=>{e.getType()==c.b.Direct&&(this.mDirectEvent=u({},e.getContent()),this.userToRooms=null,this.roomToUser=null)}),this.hasSentOutPatchDirectAccountDataPatch=!1;const i=null!==(t=null===(n=e.getAccountData(c.b.Direct))||void 0===n?void 0:n.getContent())&&void 0!==t?t:{};this.mDirectEvent=u({},i)}static makeShared(){return h.sharedInstance=new h(l.a.get()),h.sharedInstance}static setShared(e){h.sharedInstance=e}static shared(){return h.sharedInstance}start(){this.populateRoomToUser(),this.matrixClient.on(r.b.AccountData,this.onAccountData)}stop(){this.matrixClient.removeListener(r.b.AccountData,this.onAccountData)}patchUpSelfDMs(e){const t=this.matrixClient.getUserId(),n=e[t];if(n){const i=n.map(e=>{const n=this.matrixClient.getRoom(e);if(n){const i=n.guessDMUserId();if(i&&i!==t)return{userId:i,roomId:e}}}).filter(e=>!!e);return!!i.length&&(e[t]=n.filter(e=>!i.some(t=>t.roomId===e)),i.forEach(t=>{let{userId:n,roomId:i}=t;const s=e[n];s?(s.push(i),e[n]=Object(o.uniq)(s)):e[n]=[i]}),!0)}}getDMRoomsForUserId(e){return this.getUserToRooms()[e]||[]}getDMRoomForIdentifiers(e){let t=this.getDMRoomsForUserId(e[0]);for(let n=1;n<e.length;n++){const i=this.getDMRoomsForUserId(e[n]);t=t.filter(e=>i.includes(e))}return t.map(e=>l.a.get().getRoom(e)).filter(e=>e&&"join"===e.getMyMembership())[0]}getUserIdForRoomId(e){if(null==this.roomToUser&&this.populateRoomToUser(),void 0===this.roomToUser[e]){const t=this.matrixClient.getRoom(e);if(t)return t.getDMInviter()}return this.roomToUser[e]}getUniqueRoomsWithIndividuals(){return this.roomToUser?Object.keys(this.roomToUser).map(e=>({userId:this.getUserIdForRoomId(e),room:this.matrixClient.getRoom(e)})).filter(e=>e.userId&&e.room&&2===e.room.getInvitedAndJoinedMemberCount()).reduce((e,t)=>(e[t.userId]=t.room)&&e,{}):{}}getUserToRooms(){if(!this.userToRooms){const e=this.mDirectEvent,t=e[this.matrixClient.getUserId()];if(null!=t&&t.length){const t=this.patchUpSelfDMs(e);a.a.warn("Invalid m.direct account data detected (self-chats that shouldn't be), patching it up."),t&&!this.hasSentOutPatchDirectAccountDataPatch&&(this.hasSentOutPatchDirectAccountDataPatch=!0,this.matrixClient.setAccountData(c.b.Direct,e))}this.userToRooms=e}return this.userToRooms}populateRoomToUser(){this.roomToUser={};for(const e of Object.keys(this.getUserToRooms()))for(const t of this.userToRooms[e])this.roomToUser[t]=e}}s()(h,"sharedInstance",void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return E}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(88),c=n.n(a),l=n(87),d=n.n(l),u=n(0),h=n(92),m=n(96),p=n(148),g=n(128),f=n(395),v=n(207),b=n(93),y=n(90);const S=["member","fallbackUserId","onClick","viewUserOnClick","forceHistorical","hideTitle"];class E extends d.a.PureComponent{constructor(e){super(e),this.state=E.getState(e)}static getDerivedStateFromProps(e){return E.getState(e)}static getState(e){var t;let n=e.member;if(n&&!e.forceHistorical&&b.b.getValue("feature_use_only_current_profiles")){const e=y.a.get().getRoom(n.roomId);e&&(n=e.getMember(n.userId))}if(null!==(t=n)&&void 0!==t&&t.name){var i;let t=null;const s=v.a.getDisplayUserIdentifier(n.userId,{roomId:null===(i=n)||void 0===i?void 0:i.roomId});return n.getMxcAvatarUrl()&&(t=Object(g.b)(n.getMxcAvatarUrl()).getThumbnailOfSourceHttp(e.width,e.height,e.resizeMethod)),{name:n.name,title:e.title||s,imageUrl:t}}return e.fallbackUserId?{name:e.fallbackUserId,title:e.fallbackUserId}:(u.a.error("MemberAvatar called somehow with null member or fallbackUserId"),{})}render(){let e=this.props,{member:t,fallbackUserId:n,onClick:i,viewUserOnClick:o,forceHistorical:a,hideTitle:c}=e,l=r()(e,S);const u=t?t.userId:n;return o&&(i=()=>{h.a.dispatch({action:m.a.ViewUser,member:this.props.member,push:this.context.isCard})}),d.a.createElement(p.a,s()({},l,{name:this.state.name,title:c?void 0:this.state.title,idName:u,url:this.state.imageUrl,onClick:i}))}}c()(E,"defaultProps",{width:40,height:40,resizeMethod:"crop",viewUserOnClick:!1}),E.contextType=f.a},function(e,t,n){"use strict";n.d(t,"e",(function(){return m})),n.d(t,"d",(function(){return p})),n.d(t,"b",(function(){return g})),n.d(t,"a",(function(){return f})),n.d(t,"c",(function(){return v})),n.d(t,"f",(function(){return b}));var i=n(17),s=n.n(i),o=n(120),r=n(281),a=n(108),c=n(144),l=n(314),d=n(143),u=n(3),h=n(0);let m;!function(e){e.New="Thread.new",e.Update="Thread.update",e.NewReply="Thread.newReply",e.ViewThread="Thread.viewThread"}(m||(m={}));class p extends d.b{constructor(e,t,n){var i;if(super(),this.id=e,this.rootEvent=t,s()(this,"timelineSet",void 0),s()(this,"_currentUserParticipated",!1),s()(this,"reEmitter",void 0),s()(this,"lastEvent",void 0),s()(this,"replyCount",0),s()(this,"room",void 0),s()(this,"client",void 0),s()(this,"initialEventsFetched",!p.hasServerSideSupport),s()(this,"onBeforeRedaction",(e,t)=>{null!=e&&e.isRelation(v.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.emit(m.Update,this))}),s()(this,"onRedaction",e=>{var t;if(e.threadRootId!==this.id)return;const n=[...this.timelineSet.getLiveTimeline().getEvents()].reverse();this.lastEvent=null!==(t=n.find(e=>!e.isRedacted()&&e.isRelation(v.name)))&&void 0!==t?t:this.rootEvent,this.emit(m.Update,this)}),s()(this,"onEcho",e=>{if(e.threadRootId!==this.id)return;if(this.lastEvent===e)return;const t=e.isRelation(v.name);(!this.lastEvent||this.lastEvent.isRedacted()||t&&e.getId()!==this.lastEvent.getId()&&e.localTimestamp>this.lastEvent.localTimestamp)&&(this.lastEvent=e,this.lastEvent.getId()!==this.id&&(p.hasServerSideSupport&&this.replyCount++,this.emit(m.NewReply,this,e))),this.emit(m.Update,this)}),null==n||!n.room)throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.timelineSet=new l.b(this.room,{unstableClientRelationAggregation:!0,timelineSupport:!0,pendingEvents:!0}),this.reEmitter=new r.a(this),this.reEmitter.reEmit(this.timelineSet,[o.RoomEvent.Timeline,o.RoomEvent.TimelineReset]),this.room.on(o.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.room.on(o.RoomEvent.Redaction,this.onRedaction),this.room.on(o.RoomEvent.LocalEchoUpdated,this.onEcho),this.timelineSet.on(o.RoomEvent.Timeline,this.onEcho),n.initialEvents&&this.addEvents(n.initialEvents,!1),this.initialiseThread(),null===(i=this.rootEvent)||void 0===i||i.setThread(this)}async fetchRootEvent(){var e;this.rootEvent=this.room.findEventById(this.id);try{const e=await this.client.fetchRoomEvent(this.roomId,this.id),t=this.client.getEventMapper();this.rootEvent=t(e)}catch(e){h.a.error("Failed to fetch thread root to construct thread with",e)}null===(e=this.rootEvent)||void 0===e||e.setThread(this),this.emit(m.Update,this)}static setServerSideSupport(e,t){p.hasServerSideSupport=e,t||(g.setPreferUnstable(!0),f.setPreferUnstable(!0),v.setPreferUnstable(!0))}get roomState(){return this.room.getLiveTimeline().getState(c.b.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,t,!1,this.roomState)}addEvents(e,t){e.forEach(e=>this.addEvent(e,t,!1)),this.emit(m.Update,this)}addEvent(e,t){var n,i;let s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(e.setThread(this),this._currentUserParticipated||e.getSender()!==this.client.getUserId()||(this._currentUserParticipated=!0),[o.RelationType.Annotation,o.RelationType.Replace].includes(null===(n=e.getRelation())||void 0===n?void 0:n.rel_type))return this.timelineSet.setRelationsTarget(e),void this.timelineSet.aggregateRelations(e);p.hasServerSideSupport?!t&&this.initialEventsFetched&&e.localTimestamp>(null===(i=this.lastReply())||void 0===i?void 0:i.localTimestamp)&&(this.fetchEditsWhereNeeded(e),this.addEventToTimeline(e,!1)):(this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e,{})),p.hasServerSideSupport&&this.rootEvent||!e.isRelation(v.name)||this.replyCount++,s&&this.emit(m.Update,this)}getRootEventBundledRelationship(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.rootEvent;return null==e?void 0:e.getServerAggregatedRelation(v.name)}async initialiseThread(){let e=this.getRootEventBundledRelationship();if(p.hasServerSideSupport&&!e&&(await this.fetchRootEvent(),e=this.getRootEventBundledRelationship()),p.hasServerSideSupport&&e){this.replyCount=e.count,this._currentUserParticipated=e.current_user_participated;const t=new a.b(e.latest_event);this.setEventMetadata(t),t.setThread(this),this.lastEvent=t,this.fetchEditsWhereNeeded(t)}this.emit(m.Update,this)}async fetchEditsWhereNeeded(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Promise.all(t.filter(e=>e.isEncrypted()).map(e=>this.client.relations(this.roomId,e.getId(),o.RelationType.Replace,e.getType(),{limit:1}).then(t=>{t.events.length&&e.makeReplaced(t.events[0])}).catch(e=>{h.a.error("Failed to load edits for encrypted thread event",e)})))}async fetchInitialEvents(){this.initialEventsFetched||(await this.fetchEvents(),this.initialEventsFetched=!0)}setEventMetadata(e){c.b.setEventMetadata(e,this.roomState,!1),e.setThread(this)}findEventById(e){var t;return(null===(t=this.lastEvent)||void 0===t?void 0:t.getId())===e?this.lastEvent:this.timelineSet.findEventById(e)}lastReply(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:()=>!0;for(let t=this.events.length-1;t>=0;t--){const n=this.events[t];if(e(n))return n}}get roomId(){return this.room.roomId}get length(){return this.replyCount}get replyToEvent(){var e;return null!==(e=this.lastEvent)&&void 0!==e?e:this.lastReply()}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof a.b}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}async fetchEvents(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{limit:20,direction:c.a.Backward},{originalEvent:n,events:i,prevBatch:s,nextBatch:o}=await this.client.relations(this.room.roomId,this.id,v.name,null,t);t.to||o||(i=[...i,n]),await this.fetchEditsWhereNeeded(...i),await Promise.all(i.map(e=>(this.setEventMetadata(e),this.client.decryptEventIfNeeded(e))));const r=(null!==(e=t.direction)&&void 0!==e?e:c.a.Backward)===c.a.Backward;return this.timelineSet.addEventsToTimeline(i,r,this.liveTimeline,r?o:s),{originalEvent:n,events:i,prevBatch:s,nextBatch:o}}}s()(p,"hasServerSideSupport",void 0);const g=new u.a("related_by_senders","io.element.relation_senders"),f=new u.a("related_by_rel_types","io.element.relation_types"),v=new u.a("m.thread","io.element.thread");let b;!function(e){e[e.My=0]="My",e[e.All=1]="All"}(b||(b={}))},,function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(88),s=n.n(i),o=n(0),r=n(145),a=n(92),c=n(849),l=n(93),d=n(146),u=n(104),h=n(123),m=n(458);function p(e){if(!e)return e;const t=[...e.history].map(e=>function(e){var t,n,i,s,o;const r=null!==(t=e.state)&&void 0!==t?t:{};return{state:{widgetId:r.widgetId,spaceId:r.spaceId,isInitialEventHighlighted:r.isInitialEventHighlighted,initialEventScrollIntoView:r.initialEventScrollIntoView,threadHeadEventId:null!=r&&null!==(n=r.threadHeadEvent)&&void 0!==n&&n.getId()?e.state.threadHeadEvent.getId():void 0,memberInfoEventId:null!=r&&null!==(i=r.memberInfoEvent)&&void 0!==i&&i.getId()?e.state.memberInfoEvent.getId():void 0,initialEventId:null!=r&&null!==(s=r.initialEvent)&&void 0!==s&&s.getId()?e.state.initialEvent.getId():void 0,memberId:null!=r&&null!==(o=r.member)&&void 0!==o&&o.userId?e.state.member.userId:void 0},phase:e.phase}}(e));return{isOpen:e.isOpen,history:t}}function g(e,t){if(!e)return e;return{history:[...e.history].map(e=>function(e,t){var n;const i=null!==(n=e.state)&&void 0!==n?n:{};return{state:{widgetId:i.widgetId,spaceId:i.spaceId,isInitialEventHighlighted:i.isInitialEventHighlighted,initialEventScrollIntoView:i.initialEventScrollIntoView,threadHeadEvent:null!=i&&i.threadHeadEventId?t.findEventById(i.threadHeadEventId):void 0,memberInfoEvent:null!=i&&i.memberInfoEventId?t.findEventById(i.memberInfoEventId):void 0,initialEvent:null!=i&&i.initialEventId?t.findEventById(i.initialEventId):void 0,member:null!=i&&i.memberId?t.getMember(i.memberId):void 0},phase:e.phase}}(e,t)),isOpen:e.isOpen}}var f=n(96),v=n(129);class b extends m.a{constructor(){super(a.a),s()(this,"global",null),s()(this,"byRoom",{}),s()(this,"viewedRoomId",void 0),s()(this,"onVerificationRequestUpdate",()=>{var e;if(null===(e=this.currentCard)||void 0===e||!e.state)return;const{member:t}=this.currentCard.state;if(!t)return;const n=Object(c.b)(t);n&&(this.currentCard.state.verificationRequest=n,this.emitAndUpdateSettings())})}async onReady(){this.viewedRoomId=v.a.instance.getRoomId(),this.matrixClient.on(r.b.VerificationRequest,this.onVerificationRequestUpdate),this.loadCacheFromSettings(),this.emitAndUpdateSettings()}async onNotReady(){this.matrixClient.off(r.b.VerificationRequest,this.onVerificationRequestUpdate)}onDispatcherAction(e){if(e.action!==f.a.ActiveRoomChanged)return;const t=e;this.handleViewedRoomChange(t.oldRoomId,t.newRoomId)}get isOpen(){var e,t;return null!==(e=null===(t=this.byRoom[this.viewedRoomId])||void 0===t?void 0:t.isOpen)&&void 0!==e&&e}isOpenForRoom(e){var t,n;return null!==(t=null===(n=this.byRoom[e])||void 0===n?void 0:n.isOpen)&&void 0!==t&&t}get roomPhaseHistory(){var e,t;return null!==(e=null===(t=this.byRoom[this.viewedRoomId])||void 0===t?void 0:t.history)&&void 0!==e?e:[]}get currentCard(){const e=this.roomPhaseHistory;return e.length>=1?e[e.length-1]:{state:{},phase:null}}currentCardForRoom(e){var t,n;const i=null!==(t=null===(n=this.byRoom[e])||void 0===n?void 0:n.history)&&void 0!==t?t:[];return i.length>0?i[i.length-1]:{state:{},phase:null}}get previousCard(){const e=this.roomPhaseHistory;return(null==e?void 0:e.length)>=2?e[e.length-2]:{state:{},phase:null}}setCard(e){var t,n,i,s,o;let r=arguments.length>2?arguments[2]:void 0;const a=null!=r?r:this.viewedRoomId,c=this.getVerificationRedirect(e),l=null!==(t=null==c?void 0:c.phase)&&void 0!==t?t:e.phase,d=null!==(n=null==c?void 0:c.state)&&void 0!==n?n:0===Object.keys(null!==(i=e.state)&&void 0!==i?i:{}).length?null:e.state;if(this.isPhaseValid(l))if(l===(null===(s=this.currentCardForRoom(a))||void 0===s?void 0:s.phase)&&d){var u,h;const e=null!==(u=null===(h=this.byRoom[a])||void 0===h?void 0:h.history)&&void 0!==u?u:[];e[e.length-1].state=d,this.emitAndUpdateSettings()}else l!==(null===(o=this.currentCard)||void 0===o?void 0:o.phase)?(this.show(),this.setRightPanelCache({phase:l,state:null!=d?d:{}},a)):(this.show(),this.emitAndUpdateSettings())}setCards(e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const n=null!=t?t:this.viewedRoomId,i=e.map(e=>{var t;return{phase:e.phase,state:null!==(t=e.state)&&void 0!==t?t:{}}});this.byRoom[n]={history:i,isOpen:!0},this.show(),this.emitAndUpdateSettings()}pushCard(e){var t,n,i;let s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=null!=o?o:this.viewedRoomId,a=this.getVerificationRedirect(e),c=null!==(t=null==a?void 0:a.phase)&&void 0!==t?t:e.phase,l=null!==(n=null==a?void 0:a.state)&&void 0!==n?n:0===Object.keys(null!==(i=e.state)&&void 0!==i?i:{}).length?null:e.state;if(!this.isPhaseValid(c))return;const d=this.byRoom[r];d?(d.history.push({state:l,phase:c}),d.isOpen=!s||d.isOpen):this.byRoom[r]={history:[{phase:c,state:null!=l?l:{}}],isOpen:!s},this.show(),this.emitAndUpdateSettings()}popCard(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const t=null!=e?e:this.viewedRoomId;if(!this.byRoom[t])return;const n=this.byRoom[t].history.pop();return this.emitAndUpdateSettings(),n}togglePanel(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const t=null!=e?e:this.viewedRoomId;this.byRoom[t]&&(this.byRoom[t].isOpen=!this.byRoom[t].isOpen,this.emitAndUpdateSettings())}show(){this.isOpen||this.togglePanel()}hide(){this.isOpen&&this.togglePanel()}loadCacheFromSettings(){var e;const t=this.viewedRoomId&&(null===(e=this.mxClient)||void 0===e?void 0:e.getRoom(this.viewedRoomId));var n,i;t?(this.global=null!==(n=this.global)&&void 0!==n?n:g(l.b.getValue("RightPanel.phasesGlobal"),t),this.byRoom[this.viewedRoomId]=null!==(i=this.byRoom[this.viewedRoomId])&&void 0!==i?i:g(l.b.getValue("RightPanel.phases",this.viewedRoomId),t)):console.warn("Could not restore the right panel after load because there was no associated room object.")}emitAndUpdateSettings(){this.filterValidCards(this.global);const e=p(this.global);if(l.b.setValue("RightPanel.phasesGlobal",null,u.a.DEVICE,e),this.viewedRoomId){const e=this.byRoom[this.viewedRoomId];this.filterValidCards(e);const t=p(e);l.b.setValue("RightPanel.phases",this.viewedRoomId,u.a.ROOM_DEVICE,t)}this.emit(h.b,null)}filterValidCards(e){null!=e&&e.history&&(e.history=e.history.filter(e=>this.isCardStateValid(e)),e.history.length||(e.isOpen=!1))}isCardStateValid(e){switch(e.phase){case d.a.ThreadPanel:if(!l.b.getValue("feature_thread"))return!1;break;case d.a.ThreadView:return!!l.b.getValue("feature_thread")&&(e.state.threadHeadEvent||console.warn("removed card from right panel because of missing threadHeadEvent in card state"),!!e.state.threadHeadEvent);case d.a.RoomMemberInfo:case d.a.SpaceMemberInfo:case d.a.EncryptionPanel:return e.state.member||console.warn("removed card from right panel because of missing member in card state"),!!e.state.member;case d.a.Room3pidMemberInfo:case d.a.Space3pidMemberInfo:return e.state.memberInfoEvent||console.warn("removed card from right panel because of missing memberInfoEvent in card state"),!!e.state.memberInfoEvent;case d.a.Widget:return e.state.widgetId||console.warn("removed card from right panel because of missing widgetId in card state"),!!e.state.widgetId}return!0}setRightPanelCache(e,t){var n;const i=[{phase:e.phase,state:null!==(n=e.state)&&void 0!==n?n:{}}];this.byRoom[null!=t?t:this.viewedRoomId]={history:i,isOpen:!0},this.emitAndUpdateSettings()}getVerificationRedirect(e){if(e.phase===d.a.RoomMemberInfo&&e.state){const{member:t}=e.state,n=Object(c.b)(t);if(n)return{phase:d.a.EncryptionPanel,state:{verificationRequest:n,member:t}}}return null}isPhaseValid(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.isViewingRoom;return d.a[e]?!!t||(o.a.warn(`Tried to switch right panel to a room phase: ${e}, but we are currently not viewing a room`),!1):(o.a.warn("Tried to switch right panel to unknown phase: "+e),!1)}handleViewedRoomChange(e,t){var n,i;if(this.mxClient){if(this.viewedRoomId=t,this.loadCacheFromSettings(),(null===(n=this.currentCard)||void 0===n?void 0:n.phase)!==d.a.EncryptionPanel){const e=this.byRoom[this.viewedRoomId];null!=e&&e.history&&(e.history=e.history.filter(e=>e.phase!=d.a.RoomMemberInfo&&e.phase!=d.a.Room3pidMemberInfo))}if(l.b.getValue("feature_right_panel_default_open")&&(null===(i=this.byRoom[this.viewedRoomId])||void 0===i||!i.isOpen)){var s;const e=[{phase:d.a.RoomMemberList}],t=this.viewedRoomId&&(null===(s=this.mxClient)||void 0===s?void 0:s.getRoom(this.viewedRoomId));null!=t&&t.isSpaceRoom()||e.unshift({phase:d.a.RoomSummary}),this.byRoom[this.viewedRoomId]={isOpen:!0,history:e}}this.emitAndUpdateSettings()}}get isViewingRoom(){return!!this.viewedRoomId}static get instance(){return b.internalInstance||(b.internalInstance=new b),b.internalInstance}}s()(b,"internalInstance",void 0),window.mxRightPanelStore=b.instance},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return m}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(150),c=n.n(a),l=n(94),d=n.n(l),u=n(147);let h;!function(e){e[e.Natural=0]="Natural",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.Top=3]="Top",e[e.Bottom=4]="Bottom",e[e.InnerBottom=5]="InnerBottom",e[e.TopRight=6]="TopRight"}(h||(h={}));class m extends r.a.Component{constructor(){super(...arguments),s()(this,"tooltipContainer",void 0),s()(this,"parent",void 0),s()(this,"renderTooltip",()=>{let e={};this.props.visible&&(e=this.updatePosition({})),e.display=this.props.visible?"block":"none";const t=d()("mx_Tooltip",this.props.tooltipClassName,{mx_Tooltip_visible:this.props.visible,mx_Tooltip_invisible:!this.props.visible}),n=r.a.createElement("div",{className:t,style:e},r.a.createElement("div",{className:"mx_Tooltip_chevron"}),this.props.label);c.a.render(n,this.tooltipContainer)})}componentDidMount(){this.tooltipContainer=document.createElement("div"),this.tooltipContainer.className="mx_Tooltip_wrapper",document.body.appendChild(this.tooltipContainer),window.addEventListener("scroll",this.renderTooltip,{passive:!0,capture:!0}),this.parent=c.a.findDOMNode(this).parentNode,this.renderTooltip()}componentDidUpdate(){this.renderTooltip()}componentWillUnmount(){c.a.unmountComponentAtNode(this.tooltipContainer),document.body.removeChild(this.tooltipContainer),window.removeEventListener("scroll",this.renderTooltip,{capture:!0})}updatePosition(e){const t=this.parent.getBoundingClientRect(),n=u.b.instance.windowWidth,i=this.props.maxParentWidth?Math.min(t.width,this.props.maxParentWidth):t.width,s=t.top+window.scrollY,o=t.top+window.scrollY+t.height/2,r=n-t.left-window.scrollX,a=t.right+window.scrollX,c=t.left-window.scrollX+i/2;switch(this.props.alignment){case h.Natural:if(t.right>n/2){e.right=r+6,e.top=o,e.transform="translateY(-50%)";break}case h.Right:e.left=a+6,e.top=o,e.transform="translateY(-50%)";break;case h.Left:e.right=r+6,e.top=o,e.transform="translateY(-50%)";break;case h.Top:e.top=s-6,e.left=c,e.transform="translate(-50%, -100%)";break;case h.Bottom:e.top=s+t.height+6,e.left=c,e.transform="translate(-50%)";break;case h.InnerBottom:e.top=s+t.height-50,e.left=c,e.transform="translate(-50%)";break;case h.TopRight:e.top=s-6,e.right=n-t.right-window.scrollX,e.transform="translateY(-100%)"}return e}render(){return r.a.createElement("div",{className:this.props.className})}}s()(m,"Alignment",h),s()(m,"defaultProps",{visible:!0,alignment:h.Natural})},function(e,t,n){"use strict";n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return f}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(88),c=n.n(a),l=n(87),d=n.n(l),u=n(186),h=n(94),m=n.n(h);const p=["children","className","kind","inputRef"];let g;!function(e){e.Solid="solid",e.Outline="outline"}(g||(g={}));class f extends d.a.PureComponent{constructor(e){super(e),c()(this,"id",void 0),this.id=this.props.id||"checkbox_"+Object(u.b)(10)}render(){const e=this.props,{children:t,className:n,kind:i=g.Solid,inputRef:o}=e,a=r()(e,p),c=m()("mx_Checkbox",n,{mx_Checkbox_hasKind:i,["mx_Checkbox_kind_"+i]:i});return d.a.createElement("span",{className:c},d.a.createElement("input",s()({ref:o,id:this.id},a,{type:"checkbox"})),d.a.createElement("label",{htmlFor:this.id},d.a.createElement("div",{className:"mx_Checkbox_background"},d.a.createElement("div",{className:"mx_Checkbox_checkmark"})),d.a.createElement("div",null,this.props.children)))}}c()(f,"defaultProps",{className:""})},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return y}));var i=n(216),s=n(710),o=n(0),r=n(120),a=n(152),c=n(186),l=n(90),d=n(98),u=n(92),h=n(336),m=n(235),p=n(181),g=n(505),f=n(164),v=n(89),b=n(257);class y{static canUserModifyWidgets(e){if(!e)return o.a.warn("No room ID specified"),!1;const t=l.a.get();if(!t)return o.a.warn("User must be be logged in"),!1;const n=t.getRoom(e);if(!n)return o.a.warn(`Room ID ${e} is not recognised`),!1;const i=t.credentials.userId;return i?"join"!==n.getMyMembership()?(o.a.warn(`User ${i} is not in room ${e}`),!1):n.currentState.maySendStateEvent("im.vector.modular.widgets",i):(o.a.warn("Failed to get user ID"),!1)}static isScalarUrl(e){if(!e)return o.a.error("Scalar URL check failed. No URL specified"),!1;const t=i.parse(e);let n=d.b.get().integrations_widgets_urls;if(!n||0===n.length){const e=m.a.sharedInstance().getPrimaryManager();n=e?[e.apiUrl]:[]}for(let e=0;e<n.length;e++){const s=i.parse(n[e]);if(t&&s&&t.protocol===s.protocol&&t.host===s.host&&t.pathname.startsWith(s.pathname))return!0}return!1}static waitForUserWidget(e,t){return new Promise((n,i)=>{function s(n){return!(!n||!n.getContent())&&(t?void 0!==n.getContent()[e]:void 0===n.getContent()[e])}if(s(l.a.get().getAccountData("m.widgets")))return void n();function o(e){s(l.a.get().getAccountData("m.widgets"))&&(l.a.get().removeListener(r.ClientEvent.AccountData,o),clearTimeout(a),n())}const a=setTimeout(()=>{l.a.get().removeListener(r.ClientEvent.AccountData,o),i(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);l.a.get().on(r.ClientEvent.AccountData,o)})}static waitForRoomWidget(e,t,n){return new Promise((i,s)=>{function o(t){const i=t.some(t=>t.getContent()&&t.getContent().id===e);return n?i:!i}const a=l.a.get().getRoom(t);if(o(a.currentState.getStateEvents("im.vector.modular.widgets")))return void i();function c(e){if(e.getRoomId()!==t||"im.vector.modular.widgets"!==e.getType())return;o(a.currentState.getStateEvents("im.vector.modular.widgets"))&&(l.a.get().removeListener(r.RoomStateEvent.Events,c),clearTimeout(d),i())}const d=setTimeout(()=>{l.a.get().removeListener(r.RoomStateEvent.Events,c),s(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);l.a.get().on(r.RoomStateEvent.Events,c)})}static setUserWidget(e,t,n,i,s){const r={type:t.preferred,url:n,name:i,data:s},a=l.a.get(),c=Object(f.a)(y.getUserWidgets());try{delete c[e]}catch(e){o.a.error("$widgetId is non-configurable")}const d=Boolean(n);return d&&(c[e]={content:r,sender:a.getUserId(),state_key:e,type:"m.widget",id:e}),a.setAccountData("m.widgets",c).then(()=>y.waitForUserWidget(e,d)).then(()=>{u.a.dispatch({action:"user_widget_updated"})})}static setRoomWidget(e,t,n,i,s,o,r){let a;return a=Boolean(i)?{type:n.legacy,url:i,name:s,data:o,avatar_url:r}:{},y.setRoomWidgetContent(e,t,a)}static setRoomWidgetContent(e,t,n){const i=!!n.url;h.a.setRoomWidgetEcho(e,t,n);return l.a.get().sendStateEvent(e,"im.vector.modular.widgets",n,t).then(()=>y.waitForRoomWidget(t,e,i)).finally(()=>{h.a.removeRoomWidgetEcho(e,t)})}static getRoomWidgets(e){const t=e.currentState.getStateEvents("im.vector.modular.widgets");return t?t.filter(e=>e.getContent().type&&e.getContent().url):[]}static getUserWidgets(){const e=l.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");return t&&t.getContent()?t.getContent():{}}static getUserWidgetsArray(){return Object.values(y.getUserWidgets())}static getStickerpickerWidgets(){return y.getUserWidgetsArray().filter(e=>e.content&&"m.stickerpicker"===e.content.type)}static getIntegrationManagerWidgets(){return y.getUserWidgetsArray().filter(e=>e.content&&"m.integration_manager"===e.content.type)}static getRoomWidgetsOfType(e,t){return(y.getRoomWidgets(e)||[]).filter(e=>{const n=e.getContent();return n.url&&t.matches(n.type)})}static async removeIntegrationManagerWidgets(){const e=l.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const n=t.getContent()||{};Object.entries(n).forEach(e=>{let[t,i]=e;i.content&&"m.integration_manager"===i.content.type&&delete n[t]}),await e.setAccountData("m.widgets",n)}static addIntegrationManagerWidget(e,t,n){return y.setUserWidget("integration_manager_"+(new Date).getTime(),p.a.INTEGRATION_MANAGER,t,"Integration manager: "+e,{api_url:n})}static async removeStickerpickerWidgets(){const e=l.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const n=t.getContent()||{};Object.entries(n).forEach(e=>{let[t,i]=e;i.content&&"m.stickerpicker"===i.content.type&&delete n[t]}),await e.setAccountData("m.widgets",n)}static async addJitsiWidget(t,n,i,o,r){var d;const u=g.a.getInstance().preferredDomain,h=await g.a.getInstance().getJitsiAuth();let m;m="openidtoken-jwt"===h?s.base32.stringify(e.from(t),{pad:!1}):`Jitsi${Object(c.c)(1)}${Object(c.a)(23)}`;const f=new URL(y.getLocalJitsiWrapperUrl({auth:h}));f.search="",f.searchParams.set("confId",m),await y.setRoomWidget(t,o,p.a.JITSI,f.toString(),i,{conferenceId:m,roomName:null!=r?r:null===(d=l.a.get().getRoom(t))||void 0===d?void 0:d.name,isAudioOnly:n===a.f.Voice,isVideoChannel:o===b.a,domain:u,auth:h})}static makeAppConfig(e,t,n,i,s){if(!n)throw new Error("Widgets must be created by someone - provide a senderUserId");return t.creatorUserId=n,t.id=e,t.roomId=i,t.eventId=s,t.name=t.name||t.type,t}static getLocalJitsiWrapperUrl(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=["conferenceDomain=$domain","conferenceId=$conferenceId","isAudioOnly=$isAudioOnly","isVideoChannel=$isVideoChannel","displayName=$matrix_display_name","avatarUrl=$matrix_avatar_url","userId=$matrix_user_id","roomId=$matrix_room_id","theme=$theme","roomName=$roomName"];e.auth&&t.push("auth="+e.auth);const n=t.join("&");let i=window.location.href;"https:"===window.location.protocol||e.forLocalRender||(i="https://app.element.io/");return new URL("jitsi.html#"+n,i).href}static getWidgetName(e){var t;return(null==e||null===(t=e.name)||void 0===t?void 0:t.trim())||Object(v.a)("Unknown App")}static getWidgetDataTitle(e){var t,n;return(null==e||null===(t=e.data)||void 0===t||null===(n=t.title)||void 0===n?void 0:n.trim())||""}static getWidgetUid(e){return e?y.calcWidgetUid(e.id,e.roomId):""}static calcWidgetUid(e,t){return t?`room_${t}_${e}`:"user_"+e}static editWidget(e,t){m.a.sharedInstance().getPrimaryManager().open(e,"type_"+t.type,t.id)}static isManagedByManager(e){if(y.isScalarUrl(e.url)){const e=m.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();return y.isScalarUrl(t.apiUrl)}}return!1}}}).call(this,n(31).Buffer)},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(8);let s;!function(e){e.NewListener="newListener",e.RemoveListener="removeListener",e.Error="error"}(s||(s={}));class o extends i.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}eventNames(){return super.eventNames()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c}));var i=n(17),s=n.n(i),o=n(116),r=n(97);let a;!function(e){e.Backward="b",e.Forward="f"}(a||(a={}));class c{static setEventMetadata(e,t,n){var i,s,o,a;null!==(i=e.sender)&&void 0!==i&&null!==(s=i.events)&&void 0!==s&&s.member||(e.sender=t.getSentinelMember(e.getSender())),null!==(o=e.target)&&void 0!==o&&null!==(a=o.events)&&void 0!==a&&a.member||e.getType()!==r.b.RoomMember||(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&n&&(e.forwardLooking=!1)}constructor(e){var t,n;this.eventTimelineSet=e,s()(this,"roomId",void 0),s()(this,"name",void 0),s()(this,"events",[]),s()(this,"baseIndex",0),s()(this,"startState",void 0),s()(this,"endState",void 0),s()(this,"prevTimeline",void 0),s()(this,"nextTimeline",void 0),s()(this,"paginationRequests",{[a.Backward]:null,[a.Forward]:null}),this.roomId=null!==(t=null===(n=e.room)||void 0===n?void 0:n.roomId)&&void 0!==t?t:null,this.startState=new o.a(this.roomId),this.startState.paginationToken=null,this.endState=new o.a(this.roomId),this.endState.paginationToken=null,this.prevTimeline=null,this.nextTimeline=null,this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}initialiseState(e){if(this.events.length>0)throw new Error("Cannot initialise state after events are added");for(const t of e)Object.freeze(t);this.startState.setStateEvents(e),this.endState.setStateEvents(e)}forkLive(e){const t=this.getState(e),n=new c(this.eventTimelineSet);return n.startState=t.clone(),n.endState=t,this.endState=t.clone(),n}fork(e){const t=this.getState(e),n=new c(this.eventTimelineSet);return n.startState=t.clone(),n.endState=t.clone(),n}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==c.BACKWARDS)return this.startState;if(e==c.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.getState(e).paginationToken}setPaginationToken(e,t){this.getState(t).paginationToken=e}getNeighbouringTimeline(e){if(e==c.BACKWARDS)return this.prevTimeline;if(e==c.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==c.BACKWARDS)this.prevTimeline=e;else{if(t!=c.FORWARDS)throw new Error("Invalid direction '"+t+"'");this.nextTimeline=e}this.setPaginationToken(null,t)}addEvent(e,t,n){n||(n=t?this.startState:this.endState);const i=this.getTimelineSet();let s;i.room&&(c.setEventMetadata(e,n,t),e.isState()&&i.room.getUnfilteredTimelineSet()===i&&(n.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||c.setEventMetadata(e,n,t))),s=t?0:this.events.length,this.events.splice(s,0,e),t&&this.baseIndex++}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){const n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}toString(){return this.name}}s()(c,"BACKWARDS",a.Backward),s()(c,"FORWARDS",a.Forward)},function(e,t,n){"use strict";(function(e,i){n.d(t,"e",(function(){return F})),n.d(t,"d",(function(){return B})),n.d(t,"b",(function(){return K})),n.d(t,"a",(function(){return V})),n.d(t,"c",(function(){return W}));var s=n(17),o=n.n(s),r=n(365),a=n.n(r),c=n(281),l=n(0),d=n(600),u=n(161),h=n(885),m=n(366),p=n(850),g=n(368),f=n(886),v=n(887),b=n(888),y=n(187),S=n(369),E=n(441),w=n(371),_=n(372),C=n(203),O=n(892),R=n(893),I=n(894),k=n(243),x=n(284),T=n(602),j=n(603),N=n(113),P=n(151),D=n(108),A=n(119),M=n(143);const U=m.a.DeviceVerification,L={[S.c.NAME]:S.c,[E.a.NAME]:E.a,[S.e]:I.a,[S.d]:I.a},F={RECIPROCATE_QR_CODE:S.c.NAME,SAS:E.a.NAME};function B(){return Boolean(e.Olm)}let K;!function(e){e.DeviceVerificationChanged="deviceVerificationChanged",e.UserTrustStatusChanged="userTrustStatusChanged",e.UserCrossSigningUpdated="userCrossSigningUpdated",e.RoomKeyRequest="crypto.roomKeyRequest",e.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",e.KeyBackupStatus="crypto.keyBackupStatus",e.KeyBackupFailed="crypto.keyBackupFailed",e.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",e.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",e.VerificationRequest="crypto.verification.request",e.Warning="crypto.warning",e.WillUpdateDevices="crypto.willUpdateDevices",e.DevicesUpdated="crypto.devicesUpdated",e.KeysChanged="crossSigning.keysChanged"}(K||(K={}));class V extends M.b{static getOlmVersion(){return d.a.getOlmVersion()}constructor(e,t,n,i,s,r,a,m){var f;if(super(),f=this,this.baseApis=e,this.sessionStore=t,this.userId=n,this.deviceId=i,this.clientStore=s,this.cryptoStore=r,this.roomList=a,o()(this,"backupManager",void 0),o()(this,"crossSigningInfo",void 0),o()(this,"olmDevice",void 0),o()(this,"deviceList",void 0),o()(this,"dehydrationManager",void 0),o()(this,"secretStorage",void 0),o()(this,"reEmitter",void 0),o()(this,"verificationMethods",void 0),o()(this,"supportedAlgorithms",void 0),o()(this,"outgoingRoomKeyRequestManager",void 0),o()(this,"toDeviceVerificationRequests",void 0),o()(this,"inRoomVerificationRequests",void 0),o()(this,"trustCrossSignedDevices",!0),o()(this,"lastOneTimeKeyCheck",null),o()(this,"oneTimeKeyCheckInProgress",!1),o()(this,"roomEncryptors",{}),o()(this,"roomDecryptors",{}),o()(this,"deviceKeys",{}),o()(this,"globalBlacklistUnverifiedDevices",!1),o()(this,"globalErrorOnUnknownDevices",!0),o()(this,"receivedRoomKeyRequests",[]),o()(this,"receivedRoomKeyRequestCancellations",[]),o()(this,"processingRoomKeyRequests",!1),o()(this,"lazyLoadMembers",!1),o()(this,"roomDeviceTrackingState",{}),o()(this,"lastNewSessionForced",{}),o()(this,"sendKeyRequestsImmediately",!1),o()(this,"oneTimeKeyCount",void 0),o()(this,"needsNewFallback",void 0),o()(this,"fallbackCleanup",void 0),o()(this,"onDeviceListUserCrossSigningUpdated",async e=>{if(e===this.userId){const t=this.deviceList.getStoredCrossSigningForUser(e),n=t?t.getId():null,i=this.crossSigningInfo.getId(),s=i!==n;i&&n&&!s?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit(K.KeysChanged,{}),this.emit(K.UserTrustStatusChanged,this.userId,this.checkUserTrust(e)))}else{await this.checkDeviceVerifications(e);const t=this.deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit(K.UserTrustStatusChanged,e,this.checkUserTrust(e))}}),o()(this,"onMembership",(e,t,n)=>{try{this.onRoomMembership(e,t,n)}catch(e){l.a.error("Error handling membership change:",e)}}),o()(this,"onToDeviceEvent",e=>{try{l.a.log(`received to_device ${e.getType()} from: ${e.getSender()} id: ${e.getId()}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this.onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this.onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this.secretStorage.onRequestReceived(e):"m.secret.send"===e.getType()?this.secretStorage.onSecretReceived(e):"m.room_key.withheld"===e.getType()||"org.matrix.room_key.withheld"===e.getType()?this.onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this.onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this.onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once(D.c.Decrypted,e=>{this.onToDeviceEvent(e)}))}catch(e){l.a.error("Error handling toDeviceEvent:",e)}}),o()(this,"onTimelineEvent",(function(e,t,n,i){let{liveEvent:s=!0}=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(!O.a.validateEvent(e,f.baseApis))return;const o=e=>{const t=new O.a(f.baseApis,e.getRoomId());return new C.l(t,f.verificationMethods,f.baseApis)};f.handleVerificationEvent(e,f.inRoomVerificationRequests,o,s)})),this.reEmitter=new c.a(this),m){this.verificationMethods=new Map;for(const e of m)"string"==typeof e?L[e]&&this.verificationMethods.set(e,L[e]):e.NAME?this.verificationMethods.set(e.NAME,e):l.a.warn("Excluding unknown verification method "+e)}else this.verificationMethods=new Map(Object.entries(L));this.backupManager=new j.a(e,async()=>{const e=await this.getSessionBackupPrivateKey();if(e)return e;const t=await this.getSecret("m.megolm_backup.v1");if(t){const e=W(t);if(e){const[t]=await this.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",e,[t])}return u.decodeBase64(e||t)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")}),this.olmDevice=new d.a(r),this.deviceList=new h.a(e,r,this.olmDevice),this.deviceList.on(K.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[K.DevicesUpdated,K.WillUpdateDevices]),this.supportedAlgorithms=Object.keys(p.a),this.outgoingRoomKeyRequestManager=new b.a(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new R.b,this.inRoomVerificationRequests=new O.b;const y=this.baseApis.cryptoCallbacks||{},S=Object(g.d)(r,this.olmDevice);this.crossSigningInfo=new g.a(n,y,S),this.secretStorage=new v.b(e,y,e),this.dehydrationManager=new T.b(this),!y.getCrossSigningKey&&y.getSecretStorageKey&&(y.getCrossSigningKey=async e=>g.a.getFromSecretStorage(e,this.secretStorage))}async init(){let{exportedOlmDevice:t,pickleKey:n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};l.a.log("Crypto: initialising Olm..."),await e.Olm.init(),l.a.log(t?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:t,pickleKey:n}),l.a.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,l.a.log("Crypto: fetching own devices...");let i=this.deviceList.getRawStoredDevicesForUser(this.userId);if(i||(i={}),!i[this.deviceId]){l.a.log("Crypto: adding this device to the store...");const e={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:U.VERIFIED,known:!0};i[this.deviceId]=e,this.deviceList.storeDevicesForUser(this.userId,i),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[y.a.STORE_ACCOUNT],e=>{this.cryptoStore.getCrossSigningKeys(e,e=>{e&&0!==Object.keys(e).length&&(l.a.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(e))})}),this.deviceList.startTrackingDeviceList(this.userId),l.a.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setCryptoTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(const e of this.deviceList.getKnownUserIds()){const t=this.deviceList.getRawStoredDevicesForUser(e);for(const n of Object.keys(t)){const t=this.checkDeviceTrust(e,n);if(!t.isLocallyVerified()&&t.isCrossSigningVerified()){const t=this.deviceList.getStoredDevice(e,n);this.emit(K.DeviceVerificationChanged,e,n,t)}}}}async createRecoveryKeyFromPassphrase(t){const n=new e.Olm.PkDecryption;try{const e={};if(t){const i=await Object(w.c)(t);e.passphrase={algorithm:"m.pbkdf2",iterations:i.iterations,salt:i.salt},e.pubkey=n.init_with_private_key(i.key)}else e.pubkey=n.generate_key();const i=n.get_private_key();return{keyInfo:e,encodedPrivateKey:Object(_.b)(i),privateKey:i}}finally{n&&n.free()}}async isCrossSigningReady(){const e=this.crossSigningInfo.getId(),t=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!(!e||!t)}async isSecretStorageReady(){const e=await this.secretStorage.hasKey(),t=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),n=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(e&&t&&n)}async bootstrapCrossSigning(){let{authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};l.a.log("Bootstrapping cross-signing");const n=this.baseApis.cryptoCallbacks,i=new f.a(this.baseApis.store.accountData,n),s=new g.a(this.userId,i.crossSigningCallbacks,i.crossSigningCallbacks),o=async()=>{s.resetKeys(),await this.signObject(s.keys.master),i.addCrossSigningKeys(e,s.keys);const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),n=await s.signDevice(this.userId,t);i.addKeySignature(this.userId,this.deviceId,n),this.backupManager.backupInfo&&(await s.signObject(this.backupManager.backupInfo.auth_data,"master"),i.addSessionBackup(this.backupManager.backupInfo))},r=this.crossSigningInfo.getId(),a=await this.crossSigningInfo.isStoredInKeyCache(),c=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),d=a||c;l.a.log({setupNewCrossSigning:t,publicKeysOnDevice:r,privateKeysInCache:a,privateKeysInStorage:c,privateKeysExistSomewhere:d}),!d||t?(l.a.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await o()):r&&a?l.a.log("Cross-signing public keys trusted and private keys found locally"):c&&(l.a.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const u=i.crossSigningCallbacks.privateKeys;if(u.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const e=new v.b(i.accountDataClientAdapter,i.ssssCryptoCallbacks);await e.hasKey()&&(l.a.log("Storing new cross-signing private keys in secret storage"),await g.a.storeInSecretStorage(u,e))}const h=i.buildOperation();await h.apply(this),await i.persist(this),l.a.log("Cross-signing ready")}async bootstrapSecretStorage(){let{createSecretStorageKey:e=(async()=>({})),keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:i,getKeyBackupPassphrase:s}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};l.a.log("Bootstrapping Secure Secret Storage");const o=this.baseApis.cryptoCallbacks,r=new f.a(this.baseApis.store.accountData,o),a=new v.b(r.accountDataClientAdapter,r.ssssCryptoCallbacks);let c=null;const d=async(e,t)=>{t&&(e.key=t);const{keyId:n,keyInfo:i}=await a.addKey(v.a,e);return t&&r.ssssCryptoCallbacks.addPrivateKey(n,i,t),await a.setDefaultKeyId(n),n},h=async(e,t)=>{if(!t.mac){const n=await this.baseApis.cryptoCallbacks.getSecretStorageKey({keys:{[e]:t}},"");if(n){const i=n[1];r.ssssCryptoCallbacks.addPrivateKey(e,t,i);const{iv:s,mac:o}=await Object(x.a)(i);t.iv=s,t.mac=o,await r.setAccountData("m.secret_storage.key."+e,t)}}},m=async e=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{l.a.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(e,"master")}catch(e){l.a.error("Signing key backup with cross-signing keys failed",e)}else l.a.warn("Cross-signing keys not available, skipping signature on key backup")},p=await this.getSecretStorageKey(),[b,y]=p||[null,null],S=!i&&y&&y.algorithm===v.a;if(l.a.log({keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:i,storageExists:S,oldKeyInfo:y}),S||t)if(!S&&t){l.a.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await s(),n={};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(n.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),c=await d(n,e),await a.store("m.megolm_backup.v1",u.encodeBase64(e),[c]),await m(t.auth_data),r.addSessionBackup(t)}else l.a.log("Secret storage exists"),y&&y.algorithm===v.a&&await h(b,y);else{l.a.log("Secret storage does not exist, creating new storage key");const{keyInfo:t={},privateKey:n}=await e();c=await d(t,n)}if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(c||!await this.crossSigningInfo.isStoredInSecretStorage(a))){l.a.log("Copying cross-signing private keys from cache to secret storage");const e=await this.crossSigningInfo.getCrossSigningKeysFromCache();await g.a.storeInSecretStorage(e,a)}if(n&&!t){l.a.log("Creating new message key backup version");const e=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=Object(_.a)(e.recovery_key);await a.store("m.megolm_backup.v1",u.encodeBase64(t));const n={algorithm:e.algorithm,auth_data:e.auth_data};await m(n.auth_data),await this.signObject(n.auth_data),r.addSessionBackup(n)}const E=await a.get("m.megolm_backup.v1");if(E){l.a.info("Got session backup key from secret storage: caching");const e=W(E);e&&await a.store("m.megolm_backup.v1",e,[c||b]);const t=new Uint8Array(u.decodeBase64(e||E));r.addSessionBackupPrivateKeyToCache(t)}else if(this.backupManager.getKeyBackupEnabled()){const e=await this.getSessionBackupPrivateKey()||await s();if(!e)return void l.a.error("Key backup is enabled but couldn't get key backup key!");l.a.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),await a.store("m.megolm_backup.v1",u.encodeBase64(e))}const w=r.buildOperation();await w.apply(this),await r.persist(this),l.a.log("Secure Secret Storage ready")}addSecretStorageKey(e,t,n){return this.secretStorage.addKey(e,t,n)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,n){return this.secretStorage.store(e,t,n)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(t,n){let i=null;try{i=new e.Olm.PkDecryption;return i.init_with_private_key(t)===n}finally{i&&i.free()}}async getSessionBackupPrivateKey(){let e=await new Promise(e=>{this.cryptoStore.doTxn("readonly",[y.a.STORE_ACCOUNT],t=>{this.cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")})});if(e&&"string"==typeof e&&(e=new Uint8Array(u.decodeBase64(W(e)||e)),await this.storeSessionBackupPrivateKey(e)),e&&e.ciphertext){const t=i.from(this.olmDevice.pickleKey),n=await Object(x.b)(e,t,"m.megolm_backup.v1");e=u.decodeBase64(n)}return e}async storeSessionBackupPrivateKey(e){if(!(e instanceof Uint8Array))throw new Error("storeSessionBackupPrivateKey expects Uint8Array, got "+e);const t=i.from(this.olmDevice.pickleKey),n=await Object(x.c)(u.encodeBase64(e),t,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[y.a.STORE_ACCOUNT],e=>{this.cryptoStore.storeSecretStorePrivateKey(e,"m.megolm_backup.v1",n)})}checkCrossSigningPrivateKey(t,n){let i=null;try{i=new e.Olm.PkSigning;return i.init_with_seed(t)===n}finally{i&&i.free()}}async afterCrossSigningLocalKeyChange(){l.a.info("Starting cross-signing key change post-processing");const e=this.deviceList.getStoredDevice(this.userId,this.deviceId),t=await this.crossSigningInfo.signDevice(this.userId,e);l.a.info("Starting background key sig upload for "+this.deviceId);const n=e=>{let{shouldEmit:i=!1}=e;return this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:t}}).then(e=>{const{failures:t}=e||{};if(Object.keys(t||[]).length>0)throw i&&this.baseApis.emit(K.KeySignatureUploadFailure,t,"afterCrossSigningLocalKeyChange",n),new k.c("Key upload failed",{failures:t});l.a.info("Finished background key sig upload for "+this.deviceId)}).catch(e=>{l.a.error("Error during background key sig upload for "+this.deviceId,e)})};n({shouldEmit:!0});const i=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(i){l.a.info("Starting device verification upgrade");const e={};for(const[t,n]of Object.entries(this.deviceList.crossSigningInfo)){const i=await this.checkForDeviceVerificationUpgrade(t,g.a.fromStorage(n,t));i&&(e[t]=i)}if(Object.keys(e).length>0){l.a.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await i({users:e});if(t)for(const n of t)n in e&&await this.baseApis.setDeviceVerified(n,e[n].crossSigningInfo.getId())}catch(e){l.a.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}}l.a.info("Finished device verification upgrade")}l.a.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(e,t){const n=this.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!n.isVerified()){const n=this.deviceList.getRawStoredDevicesForUser(e),i=await this.checkForValidDeviceSignature(e,t.keys.master,n);if(i.length)return{devices:i.map(e=>m.a.fromStorage(n[e],e)),crossSigningInfo:t}}}async checkForValidDeviceSignature(e,t,n){const i=[];if(n&&t.signatures&&t.signatures[e])for(const s of Object.keys(t.signatures[e])){const[,o]=s.split(":",2);if(o in n&&n[o].verified===U.VERIFIED)try{await u.verifySignature(this.olmDevice,t,e,o,n[o].keys[s]),i.push(o)}catch(e){}}return i}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){const t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new g.c(!1,!1,!1)}checkDeviceTrust(e,t){const n=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,n)}checkDeviceInfoTrust(e,t){const n=!(!t||!t.isVerified()),i=this.deviceList.getStoredCrossSigningForUser(e);if(t&&i){const s=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(i,t,n,s)}return new g.b(!1,!1,n,!1)}checkIfOwnDeviceCrossSigned(e){const t=this.deviceList.getStoredDevice(this.userId,e),n=this.deviceList.getStoredCrossSigningForUser(this.userId);return n.checkDeviceTrust(n,t,!1,!0).isCrossSigningVerified()}async checkOwnCrossSigningTrust(){let{allowPrivateKeyRequests:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this.userId;await this.downloadKeys([this.userId]);const n=await this.crossSigningInfo.getCrossSigningKeysFromCache(),i=this.deviceList.getStoredCrossSigningForUser(t);if(!i)return void l.a.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");const s=i.getId(),o=this.crossSigningInfo.getId()!==s,r=i.getId()&&!n.has("master");if(o&&l.a.info("Got new master public key",s),e&&(o||r)){l.a.info("Attempting to retrieve cross-signing master private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("master",s))[1],l.a.info("Got cross-signing master private key")}finally{e&&e.free()}}const a=this.crossSigningInfo.getId("self_signing"),c=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(i.keys);const d=a!==i.getId("self_signing"),u=c!==i.getId("user_signing"),h=i.getId("self_signing")&&!n.has("self_signing"),m=i.getId("user_signing")&&!n.has("user_signing"),p={};if(d&&l.a.info("Got new self-signing key",i.getId("self_signing")),e&&(d||h)){l.a.info("Attempting to retrieve cross-signing self-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("self_signing",i.getId("self_signing")))[1],l.a.info("Got cross-signing self-signing private key")}finally{e&&e.free()}const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),n=await this.crossSigningInfo.signDevice(this.userId,t);p[this.deviceId]=n}if(u&&l.a.info("Got new user-signing key",i.getId("user_signing")),e&&(u||m)){l.a.info("Attempting to retrieve cross-signing user-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("user_signing",i.getId("user_signing")))[1],l.a.info("Got cross-signing user-signing private key")}finally{e&&e.free()}}if(o){const e=this.crossSigningInfo.keys.master;await this.signObject(e);const t=e.signatures[this.userId]["ed25519:"+this.deviceId];p[this.crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:t}}})}const g=Object.keys(p);if(g.length){const e=t=>{let{shouldEmit:n=!1}=t;return l.a.info("Starting background key sig upload for "+g),this.baseApis.uploadKeySignatures({[this.userId]:p}).then(t=>{const{failures:i}=t||{};if(l.a.info("Finished background key sig upload for "+g),Object.keys(i||[]).length>0)throw n&&this.baseApis.emit(K.KeySignatureUploadFailure,i,"checkOwnCrossSigningTrust",e),new k.c("Key upload failed",{failures:i})}).catch(e=>{l.a.error("Error during background key sig upload for "+g,e)})};e({shouldEmit:!0})}this.emit(K.UserTrustStatusChanged,t,this.checkUserTrust(t)),o&&(this.emit(K.KeysChanged,{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async storeTrustedSelfKeys(e){e?this.crossSigningInfo.setKeys(e):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[y.a.STORE_ACCOUNT],e=>{this.cryptoStore.storeCrossSigningKeys(e,this.crossSigningInfo.keys)})}async checkDeviceVerifications(e){const t=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(l.a.info("Starting device verification upgrade for "+e),this.crossSigningInfo.keys.user_signing){const n=this.deviceList.getStoredCrossSigningForUser(e);if(n){const i=await this.checkForDeviceVerificationUpgrade(e,n);if(i){(await t({users:{[e]:i}})).includes(e)&&await this.baseApis.setDeviceVerified(e,n.getId())}}}l.a.info("Finished device verification upgrade for "+e)}}async setTrustedBackupPubKey(e){this.sessionStore.setLocalTrustedBackupPubKey(e),await this.backupManager.checkKeyBackup()}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(P.b.Membership,this.onMembership),e.on(A.b.ToDeviceEvent,this.onToDeviceEvent),e.on(N.c.Timeline,this.onTimelineEvent),e.on(D.c.Decrypted,this.onTimelineEvent)}start(){this.outgoingRoomKeyRequestManager.start()}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){this.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){return this.globalErrorOnUnknownDevices}uploadDeviceKeys(){const e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then(()=>this.baseApis.uploadKeysRequest({device_keys:e}))}updateOneTimeKeyCount(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this.oneTimeKeyCount=e}setNeedsNewFallback(e){this.needsNewFallback=!!e}getNeedsNewFallback(){return this.needsNewFallback}maybeUploadOneTimeKeys(){if(this.oneTimeKeyCheckInProgress)return;const e=Date.now();if(null!==this.lastOneTimeKeyCheck&&e-this.lastOneTimeKeyCheck<6e4)return;this.lastOneTimeKeyCheck=e;const t=this.olmDevice.maxNumberOfOneTimeKeys(),n=Math.floor(t/2),i=async e=>{for(;n>e||this.getNeedsNewFallback();){if(n>e){l.a.info("generating oneTimeKeys");const t=Math.min(n-e,5);await this.olmDevice.generateOneTimeKeys(t)}if(this.getNeedsNewFallback()){const e=await this.olmDevice.getFallbackKey();e.curve25519&&0!=Object.keys(e.curve25519).length||(l.a.info("generating fallback key"),this.fallbackCleanup&&(clearTimeout(this.fallbackCleanup),delete this.fallbackCleanup),await this.olmDevice.generateFallbackKey())}l.a.info("calling uploadOneTimeKeys");const t=await this.uploadOneTimeKeys();if(!t.one_time_key_counts||!t.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");e=t.one_time_key_counts.signed_curve25519}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then(e=>e.one_time_key_counts.signed_curve25519||0)).then(e=>i(e)).catch(e=>{l.a.error("Error uploading one-time keys",e.stack||e)}).finally(()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1})}async uploadOneTimeKeys(){const e=[];let t;if(this.getNeedsNewFallback()){t={};const n=await this.olmDevice.getFallbackKey();for(const[i,s]of Object.entries(n.curve25519)){const n={key:s,fallback:!0};t["signed_curve25519:"+i]=n,e.push(this.signObject(n))}this.setNeedsNewFallback(!1)}const n=await this.olmDevice.getOneTimeKeys(),i={};for(const t in n.curve25519)if(n.curve25519.hasOwnProperty(t)){const s={key:n.curve25519[t]};i["signed_curve25519:"+t]=s,e.push(this.signObject(s))}await Promise.all(e);const s={one_time_keys:i};t&&(s["org.matrix.msc2732.fallback_keys"]=t,s.fallback_keys=t);const o=await this.baseApis.uploadKeysRequest(s);return t&&(this.fallbackCleanup=setTimeout(()=>{delete this.fallbackCleanup,this.olmDevice.forgetOldFallbackKey()},36e5)),await this.olmDevice.markKeysAsPublished(),o}downloadKeys(e,t){return this.deviceList.downloadKeys(e,t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}async setDeviceVerification(e,t,n,i,s){void 0===n&&(n=null),void 0===i&&(i=null),void 0===s&&(s=null);const o=this.deviceList.getStoredCrossSigningForUser(e);if(o&&o.getId()===t){if(null!==i||null!==s)throw new Error("Cannot set blocked or known for a cross-signing key");if(!n)throw new Error("Cannot set a cross-signing key as unverified");if(this.crossSigningInfo.getId()||e!==this.crossSigningInfo.userId||(this.storeTrustedSelfKeys(o.keys),this.emit(K.UserTrustStatusChanged,this.userId,this.checkUserTrust(e))),e!==this.userId){l.a.info("Master key "+o.getId()+" for "+e+" marked verified. Signing...");const n=await this.crossSigningInfo.signUser(o);if(n){const i=async s=>{let{shouldEmit:o=!1}=s;l.a.info("Uploading signature for "+e+"...");const r=await this.baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:a}=r||{};if(Object.keys(a||[]).length>0)throw o&&this.baseApis.emit(K.KeySignatureUploadFailure,a,"setDeviceVerification",i),new k.c("Key upload failed",{failures:a})};await i({shouldEmit:!0})}return n}return o}const r=this.deviceList.getRawStoredDevicesForUser(e);if(!r||!r[t])throw new Error("Unknown device "+e+":"+t);const a=r[t];let c=a.verified;n?c=U.VERIFIED:null!==n&&c==U.VERIFIED&&(c=U.UNVERIFIED),i?c=U.BLOCKED:null!==i&&c==U.BLOCKED&&(c=U.UNVERIFIED);let d=a.known;if(null!==s&&(d=s),a.verified===c&&a.known===d||(a.verified=c,a.known=d,this.deviceList.storeDevicesForUser(e,r),this.deviceList.saveIfDirty()),n&&e===this.userId){let n;l.a.info("Own device "+t+" marked verified: signing");if(this.checkDeviceTrust(e,t).isCrossSigningVerified()?l.a.log(`Own device ${t} already cross-signing verified`):n=await this.crossSigningInfo.signDevice(e,m.a.fromStorage(a,t)),n){const i=async s=>{let{shouldEmit:o=!1}=s;l.a.info("Uploading signature for "+t);const r=await this.baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:a}=r||{};if(Object.keys(a||[]).length>0)throw o&&this.baseApis.emit(K.KeySignatureUploadFailure,a,"setDeviceVerification",i),new k.c("Key upload failed",{failures:a})};await i({shouldEmit:!0})}}const u=m.a.fromStorage(a,t);return this.emit(K.DeviceVerificationChanged,e,t,u),u}findVerificationRequestDMInProgress(e){return this.inRoomVerificationRequests.findRequestInProgress(e)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){const n=this.inRoomVerificationRequests.findRequestInProgress(t);if(n)return Promise.resolve(n);const i=new O.a(this.baseApis,t,e);return this.requestVerificationWithChannel(e,i,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));const n=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(n)return Promise.resolve(n);const i=new R.a(this.baseApis,e,t,R.a.makeTransactionId());return this.requestVerificationWithChannel(e,i,this.toDeviceVerificationRequests)}async requestVerificationWithChannel(e,t,n){let i=new C.l(t,this.verificationMethods,this.baseApis);t.transactionId&&n.setRequestByChannel(t,i),await i.sendRequest();const s=n.getRequestByChannel(t);return s?i=s:(l.a.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),n.setRequestByChannel(t,i)),i}beginKeyVerification(e,t,n){let i,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(s){if(i=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,s),!i)throw new Error(`No request found for user ${t} with transactionId `+s)}else{s=R.a.makeTransactionId();const e=new R.a(this.baseApis,t,[n],s,n);i=new C.l(e,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,s,i)}return i.beginKeyVerification(e,{userId:t,deviceId:n})}async legacyDeviceVerification(e,t,n){const i=R.a.makeTransactionId(),s=new R.a(this.baseApis,e,[t],i,t),o=new C.l(s,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,i,o);const r=o.beginKeyVerification(n,{userId:e,deviceId:t});return await Promise.race([r.verify(),o.waitFor(e=>e.started)]),o}async getOlmSessionsForUser(e){const t=this.getStoredDevicesForUser(e)||[],n={};for(let e=0;e<t.length;++e){const i=t[e],s=i.getIdentityKey(),o=await this.olmDevice.getSessionInfoForDevice(s);n[i.deviceId]={deviceIdKey:s,sessions:o}}return n}getEventSenderDeviceInfo(e){const t=e.getSenderKey(),n=e.getWireContent().algorithm;if(!t||!n)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;if(e.isKeySourceUntrusted())return null;const i=this.deviceList.getDeviceByIdentityKey(n,t);if(null===i)return null;const s=e.getClaimedEd25519Key();return s?s!==i.getFingerprint()?(l.a.warn("Event "+e.getId()+" claims ed25519 key "+s+" but sender device has key "+i.getFingerprint()),null):i:(l.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){const t={};if(t.senderKey=e.getSenderKey(),t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0;e.getForwardingCurve25519KeyChain().length>0||e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this.deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey);const n=e.getClaimedEd25519Key();return n||(l.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&n!==t.sender.getFingerprint()&&(l.a.warn("Event "+e.getId()+" claims ed25519 key "+n+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t}forceDiscardSession(e){const t=this.roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()}async setRoomEncryption(e,t,n){if(!t.algorithm)return void l.a.log("Ignoring setRoomEncryption with no algorithm");const i=this.roomList.getRoomEncryption(e);if(i&&JSON.stringify(i)!=JSON.stringify(t))return void l.a.error("Ignoring m.room.encryption event which requests a change of config in "+e);if(this.roomEncryptors[e])return;let s=null;i||(s=this.roomList.setRoomEncryption(e,t));const o=p.c[t.algorithm];if(!o)throw new Error("Unable to encrypt with "+t.algorithm);const r=new o({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e,config:t});this.roomEncryptors[e]=r,s&&await s,this.lazyLoadMembers?l.a.log("Enabling encryption in "+e):(l.a.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),await this.trackRoomDevices(e),n||this.deviceList.refreshOutdatedDeviceLists())}trackRoomDevices(e){const t=async()=>{if(!this.roomEncryptors[e])return;const t=this.clientStore.getRoom(e);if(!t)throw new Error("Unable to start tracking devices in unknown room "+e);l.a.log(`Starting to track devices for room ${e} ...`);(await t.getEncryptionTargetMembers()).forEach(e=>{this.deviceList.startTrackingDeviceList(e.userId)})};let n=this.roomDeviceTrackingState[e];return n||(n=t(),this.roomDeviceTrackingState[e]=n.catch(t=>{throw this.roomDeviceTrackingState[e]=null,t})),n}ensureOlmSessionsForUsers(e,t){const n={};for(let t=0;t<e.length;++t){const i=e[t];n[i]=[];const s=this.getStoredDevicesForUser(i)||[];for(let e=0;e<s.length;++e){const t=s[e];t.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(t.verified!=U.BLOCKED&&n[i].push(t))}}return u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,n,t)}async exportRoomKeys(){const e=[];return await this.cryptoStore.doTxn("readonly",[y.a.STORE_INBOUND_GROUP_SESSIONS],t=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(t,t=>{if(null===t)return;const n=this.olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete n.first_known_index,n.algorithm=u.MEGOLM_ALGORITHM,e.push(n)})}),e}importRoomKeys(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=0,i=0;const s=e.length;function o(){t.progressCallback({stage:"load_keys",successes:n,failures:i,total:s})}return Promise.all(e.map(e=>{if(!e.room_id||!e.algorithm)return l.a.warn("ignoring room key entry with missing fields",e),i++,t.progressCallback&&o(),null;return this.getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally(()=>{n++,t.progressCallback&&o()})})).then()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){const t=this.roomEncryptors[e.roomId];t&&t.prepareToEncrypt(e)}async encryptEvent(e,t){if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");const n=e.getRoomId(),i=this.roomEncryptors[n];if(!i)throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");this.roomDeviceTrackingState[n]||this.trackRoomDevices(n),await this.roomDeviceTrackingState[n];let s=e.getContent();const o=s["m.relates_to"];o&&(s=Object.assign({},s),delete s["m.relates_to"]);const r=s["io.element.performance_metrics"];r&&(s=Object.assign({},s),delete s["io.element.performance_metrics"]);const a=await i.encryptMessage(t,e.getType(),s);o&&(a["m.relates_to"]=o),r&&(a["io.element.performance_metrics"]=r),e.makeEncrypted("m.room.encrypted",a,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(e){if(e.isRedacted()){const t=new D.b(e.getUnsigned().redacted_because),n=await this.decryptEvent(t);return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:n.clearEvent}}}}{const t=e.getWireContent();return this.getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)}}async handleDeviceListChanges(e,t){e.oldSyncToken&&await this.evalDeviceListChanges(t)}requestRoomKey(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,n).then(()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(e=>{l.a.error("Error requesting key for event",e)})}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch(e=>{l.a.warn("Error clearing pending room key requests",e)})}async cancelAndResendAllOutgoingKeyRequests(){await this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(e){const t=e.getRoomId(),n=e.getContent();try{await this.setRoomEncryption(t,n,!0)}catch(e){l.a.error("Error configuring encryption in room "+t+":",e)}}async onSyncWillProcess(e){e.oldSyncToken||(l.a.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(e){this.deviceList.setSyncToken(e.nextSyncToken),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(e){if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach(e=>{this.deviceList.invalidateUserDeviceList(e)}),e.left&&Array.isArray(e.left)&&e.left.length){const t=new Set(await this.getTrackedE2eUsers());e.left.forEach(e=>{t.has(e)||this.deviceList.stopTrackingDeviceList(e)})}}async getTrackedE2eUsers(){const e=[];for(const t of this.getTrackedE2eRooms()){const n=await t.getEncryptionTargetMembers();for(const t of n)e.push(t.userId)}return e}getTrackedE2eRooms(){return this.clientStore.getRooms().filter(e=>{if(!this.roomEncryptors[e.roomId])return!1;if(!this.roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return"join"===t||"invite"===t})}onRoomKeyEvent(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void l.a.error("key event is missing fields");this.backupManager.checkedForBackup||this.backupManager.checkAndStart();this.getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void l.a.error("key withheld event is missing fields");l.a.info(`Got room key withheld event from ${e.getSender()} (${t.sender_key}) for ${t.algorithm}/${t.room_id}/${t.session_id} with reason ${t.code} (${t.reason})`);const n=this.getRoomDecryptor(t.room_id,t.algorithm);if(n.onRoomKeyWithheldEvent&&n.onRoomKeyWithheldEvent(e),!t.room_id){const e=this.getRoomDecryptors(t.algorithm);for(const n of e)n.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(!R.a.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.toDeviceVerificationRequests,e=>{if(!R.a.canCreateRequest(R.a.getEventType(e)))return;const t=e.getContent(),n=t&&t.from_device;if(!n)return;const i=e.getSender(),s=new R.a(this.baseApis,i,[n]);return new C.l(s,this.verificationMethods,this.baseApis)})}async handleVerificationEvent(e,t,n){let i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(e.isSending()&&e.status!=D.a.SENT){let t,n;try{await new Promise((i,s)=>{t=i,n=()=>{e.status==D.a.CANCELLED&&s(new Error("Event status set to CANCELLED."))},e.once(D.c.LocalEventIdReplaced,t),e.on(D.c.Status,n)})}catch(e){return void l.a.error("error while waiting for the verification event to be sent: "+e.message)}finally{e.removeListener(D.c.LocalEventIdReplaced,t),e.removeListener(D.c.Status,n)}}let s=t.getRequest(e),o=!1;if(!s){if(s=n(e),!s)return void l.a.log("Crypto: could not find VerificationRequest for "+e.getType()+", and could not create one, so ignoring.");o=!0,t.setRequest(e,s)}e.setVerificationRequest(s);try{await s.channel.handleEvent(e,s,i)}catch(e){l.a.error("error while handling verification event: "+e.message)}o&&!s.initiatedByMe&&!s.invalid&&!s.observeOnly&&this.baseApis.emit(K.VerificationRequest,s)}async onToDeviceBadEncrypted(e){const t=e.getWireContent(),n=e.getSender(),i=t.algorithm,s=t.sender_key,o=()=>{const e=this.getRoomDecryptors(u.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(s)};if(void 0===n||void 0===s||void 0===s)return;this.lastNewSessionForced[n]=this.lastNewSessionForced[n]||{};const r=this.lastNewSessionForced[n][s]||0;if(r+36e5>Date.now())return l.a.debug("New session already forced with device "+n+":"+s+" at "+r+": not forcing another"),await this.olmDevice.recordSessionProblem(s,"wedged",!0),void o();let a=this.deviceList.getDeviceByIdentityKey(i,s);if(!a&&(await this.downloadKeys([n],!1),a=this.deviceList.getDeviceByIdentityKey(i,s),!a))return l.a.info("Couldn't find device for identity key "+s+": not re-establishing session"),await this.olmDevice.recordSessionProblem(s,"wedged",!1),void o();const c={};c[n]=[a],await u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,c,!0),this.lastNewSessionForced[n][s]=Date.now();const d={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await u.encryptMessageForDevice(d.ciphertext,this.userId,this.deviceId,this.olmDevice,n,a,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(s,"wedged",!0),o(),await this.baseApis.sendToDevice("m.room.encrypted",{[n]:{[a.deviceId]:d}});const h=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,a.deviceId);for(const e of h)this.requestRoomKey(e.requestBody,e.recipients,!0)}onRoomMembership(e,t,n){const i=t.roomId,s=this.roomEncryptors[i];s&&(this.roomDeviceTrackingState[i]&&("join"==t.membership?(l.a.log("Join event for "+t.userId+" in "+i),this.deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this.clientStore.getRoom(i).shouldEncryptForInvitedMembers()&&(l.a.log("Invite event for "+t.userId+" in "+i),this.deviceList.startTrackingDeviceList(t.userId))),s.onRoomMembership(e,t,n))}onRoomKeyRequestEvent(e){const t=e.getContent();if("request"===t.action){const t=new H(e);this.receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new q(e);this.receivedRoomKeyRequestCancellations.push(t)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const e=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const t=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(e.map(e=>this.processReceivedRoomKeyRequest(e))),await Promise.all(t.map(e=>this.processReceivedRoomKeyRequestCancellation(e)))}catch(e){l.a.error("Error processing room key requsts: "+e)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(e){const t=e.userId,n=e.deviceId,i=e.requestBody,s=i.room_id,o=i.algorithm;if(l.a.log(`m.room_key_request from ${t}:${n} for ${s} / ${i.session_id} (id ${e.requestId})`),t!==this.userId){if(!this.roomEncryptors[s])return void l.a.debug("room key request for unencrypted room "+s);const e=this.roomEncryptors[s],o=this.deviceList.getStoredDevice(t,n);if(!o)return void l.a.debug(`Ignoring keyshare for unknown device ${t}:${n}`);try{await e.reshareKeyWithDevice(i.sender_key,i.session_id,t,o)}catch(e){l.a.warn("Failed to re-share keys for session "+i.session_id+" with device "+t+":"+o.deviceId,e)}return}if(n===this.deviceId)return void l.a.log("Ignoring room key request from ourselves");if(!this.roomDecryptors[s])return void l.a.log("room key request for unencrypted room "+s);const r=this.roomDecryptors[s][o];if(r)if(await r.hasKeysForKeyRequest(e)){if(e.share=()=>{r.shareKeysWithDevice(e)},this.checkDeviceTrust(t,n).isVerified())return l.a.log("device is already verified: sharing keys"),void e.share();this.emit(K.RoomKeyRequest,e)}else l.a.log(`room key request for unknown session ${s} / `+i.session_id);else l.a.log(`room key request for unknown alg ${o} in room ${s}`)}async processReceivedRoomKeyRequestCancellation(e){l.a.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit(K.RoomKeyRequestCancellation,e)}getRoomDecryptor(e,t){let n,i;if((e=e||null)&&(n=this.roomDecryptors[e],n||(this.roomDecryptors[e]=n={}),i=n[t],i))return i;const s=p.a[t];if(!s)throw new p.b("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return i=new s({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e}),n&&(n[t]=i),i}getRoomDecryptors(e){const t=[];for(const n of Object.values(this.roomDecryptors))e in n&&t.push(n[e]);return t}async signObject(e){const t=e.signatures||{},n=e.unsigned;delete e.signatures,delete e.unsigned,t[this.userId]=t[this.userId]||{},t[this.userId]["ed25519:"+this.deviceId]=await this.olmDevice.sign(a.a.stringify(e)),e.signatures=t,void 0!==n&&(e.unsigned=n)}}function W(e){if("string"!=typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),e=>parseInt(e));return u.encodeBase64(t)}class H{constructor(e){o()(this,"userId",void 0),o()(this,"deviceId",void 0),o()(this,"requestId",void 0),o()(this,"requestBody",void 0),o()(this,"share",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class q{constructor(e){o()(this,"userId",void 0),o()(this,"deviceId",void 0),o()(this,"requestId",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}}).call(this,n(30),n(31).Buffer)},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(89);let s;function o(e){switch(e){case s.ThreadPanel:return Object(i.a)("Threads");case s.Timeline:return Object(i.a)("Back to chat");case s.RoomSummary:return Object(i.a)("Room information");case s.RoomMemberList:return Object(i.a)("Room members");case s.ThreadView:return Object(i.a)("Back to thread")}return null}!function(e){e.RoomMemberList="RoomMemberList",e.FilePanel="FilePanel",e.NotificationPanel="NotificationPanel",e.RoomMemberInfo="RoomMemberInfo",e.EncryptionPanel="EncryptionPanel",e.RoomSummary="RoomSummary",e.Widget="Widget",e.PinnedMessages="PinnedMessages",e.Timeline="Timeline",e.Room3pidMemberInfo="Room3pidMemberInfo",e.SpaceMemberList="SpaceMemberList",e.SpaceMemberInfo="SpaceMemberInfo",e.Space3pidMemberInfo="Space3pidMemberInfo",e.ThreadView="ThreadView",e.ThreadPanel="ThreadPanel"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c}));var i=n(88),s=n.n(i),o=n(8),r=n.n(o);let a;!function(e){e.Resize="resize"}(a||(a={}));class c extends r.a{constructor(){super(),s()(this,"resizeObserver",void 0),s()(this,"uiElementDimensions",new Map),s()(this,"trackedUiElements",new Map),s()(this,"windowWidth",void 0),s()(this,"windowHeight",void 0),s()(this,"resizeObserverCallback",e=>{const t=e.find(e=>e.target===document.body);t&&(this.windowWidth=t.contentRect.width,this.windowHeight=t.contentRect.height),e.forEach(e=>{const t=this.trackedUiElements.get(e.target);t&&(this.uiElementDimensions.set(t,e.contentRect),this.emit(t,a.Resize,e))}),this.emit(a.Resize,e)}),this.windowWidth=window.innerWidth,this.windowHeight=window.innerHeight,this.resizeObserver=new ResizeObserver(this.resizeObserverCallback),this.resizeObserver.observe(document.body)}static get instance(){return c._instance||(c._instance=new c),c._instance}static destroy(){c._instance&&(c._instance.resizeObserver.disconnect(),c._instance.removeAllListeners(),c._instance=null)}getElementDimensions(e){return this.uiElementDimensions.get(e)}trackElementDimensions(e,t){this.trackedUiElements.set(t,e),this.resizeObserver.observe(t)}stopTrackingElementDimensions(e){let t;this.trackedUiElements.forEach((n,i)=>{n===e&&(t=i)}),t&&(this.resizeObserver.unobserve(t),this.uiElementDimensions.delete(e),this.trackedUiElements.delete(t))}isTrackingElementDimensions(e){return this.uiElementDimensions.has(e)}}s()(c,"_instance",null),window.mxUIStore=c.instance},function(e,t,n){"use strict";var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(94),d=n.n(l),u=n(119),h=n(221),m=n(93),p=n(91),g=n(106),f=n(100),v=n(118),b=n(490),y=n(89);const S=["name","idName","title","url","urls","width","height","resizeMethod","defaultToInitialLetter","onClick","inputRef","className"],E=(e,t,n)=>{let i=[];return n||(i=t||[],e&&(i=[e,...i])),Array.from(new Set(i))};t.a=e=>{const{name:t,idName:n,title:i,url:o,urls:l,width:w=40,height:_=40,resizeMethod:C="crop",defaultToInitialLetter:O=!0,onClick:R,inputRef:I,className:k}=e,x=r()(e,S),[T,j]=(e=>{let{url:t,urls:n}=e;const i=Object(a.useContext)(g.b),s=i?i.lowBandwidth:m.b.getValue("lowBandwidth"),[o,r]=Object(a.useState)(E(t,n,s)),[c,l]=Object(a.useState)(0),d=Object(a.useCallback)(()=>{l(e=>e+1)},[]);Object(a.useEffect)(()=>{r(E(t,n,s)),l(0)},[t,JSON.stringify(n)]);const h=Object(a.useContext)(f.a),p=Object(a.useCallback)((e,t)=>{"ERROR"!==e&&t!==e&&l(0)},[]);Object(v.c)(h,u.b.Sync,p);return[o[c],d]})({url:o,urls:l});if(!T&&O){const e=h.e(t),o=c.a.createElement("span",{className:"mx_BaseAvatar_initial","aria-hidden":"true",style:{fontSize:Object(b.a)(.65*w),width:Object(b.a)(w),lineHeight:Object(b.a)(_)}},e),r=c.a.createElement("img",{className:"mx_BaseAvatar_image",src:h.d(n||t),alt:"",title:i,onError:j,style:{width:Object(b.a)(w),height:Object(b.a)(_)},"aria-hidden":"true"});return R?c.a.createElement(p.a,s()({"aria-label":Object(y.a)("Avatar"),"aria-live":"off"},x,{element:"span",className:d()("mx_BaseAvatar",k),onClick:R,inputRef:I}),o,r):c.a.createElement("span",s()({className:d()("mx_BaseAvatar",k),ref:I},x,{role:"presentation"}),o,r)}return R?c.a.createElement(p.a,s()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",k),element:"img",src:T,onClick:R,onError:j,style:{width:Object(b.a)(w),height:Object(b.a)(_)},title:i,alt:Object(y.a)("Avatar"),inputRef:I},x)):c.a.createElement("img",s()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",k),src:T,onError:j,style:{width:Object(b.a)(w),height:Object(b.a)(_)},title:i,alt:"",ref:I},x))}},function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"e",(function(){return o})),n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return c})),n.d(t,"d",(function(){return l}));var i=n(0);async function s(e){try{var t,n;if(null!==(t=navigator)&&void 0!==t&&null!==(n=t.clipboard)&&void 0!==n&&n.writeText)return await navigator.clipboard.writeText(e),!0;{const t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t);const n=document.getSelection(),i=document.createRange();i.selectNode(t),n.removeAllRanges(),n.addRange(i);const s=document.execCommand("copy");return n.removeAllRanges(),document.body.removeChild(t),s}}catch(e){i.a.error("copyPlaintext failed",e)}return!1}function o(e){const t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t)}function r(e){return o(e),document.execCommand("copy")}const a=new Intl.Collator;function c(e,t){return a.compare(e,t)}function l(){return window.getSelection().toString()}},,function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return u}));var i=n(17),s=n.n(i),o=n(312),r=n(7),a=n(0),c=n(143),l=n(97);let d;!function(e){e.Membership="RoomMember.membership",e.Name="RoomMember.name",e.PowerLevel="RoomMember.powerLevel",e.Typing="RoomMember.typing"}(d||(d={}));class u extends c.b{constructor(e,t){super(),this.roomId=e,this.userId=t,s()(this,"_isOutOfBand",!1),s()(this,"_modified",void 0),s()(this,"_requestedProfileInfo",void 0),s()(this,"typing",!1),s()(this,"name",void 0),s()(this,"rawDisplayName",void 0),s()(this,"powerLevel",0),s()(this,"powerLevelNorm",0),s()(this,"user",null),s()(this,"membership",null),s()(this,"disambiguate",!1),s()(this,"events",{member:null}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){const n=e.getDirectionalContent().displayname;if(e.getType()!==l.b.RoomMember)return;this._isOutOfBand=!1,this.events.member=e;const i=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&a.a.trace(`membership event with membership undefined (forwardLooking: ${e.forwardLooking})!`,e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=function(e,t,n){if(!t||t===e)return!1;if(!r.E(t))return!1;if(!n)return!1;if(h.test(t))return!0;if(m.test(t))return!0;return!!n.getUserIdsWithDisplayName(t).some(t=>t!==e)}(this.userId,n,t);const s=this.name;this.name=function(e,t,n,i){return i?r.C(t)+" ("+e+")":t&&t!==e&&r.E(t)?r.C(t):e}(this.userId,n,0,this.disambiguate),this.rawDisplayName=r.C(e.getDirectionalContent().displayname),this.rawDisplayName&&r.E(this.rawDisplayName)||(this.rawDisplayName=this.userId),i!==this.membership&&(this.updateModifiedTime(),this.emit(d.Membership,e,this,i)),s!==this.name&&(this.updateModifiedTime(),this.emit(d.Name,e,this,s))}setPowerLevelEvent(e){if("m.room.power_levels"!==e.getType())return;const t=e.getDirectionalContent();let n=t.users_default||0;const i=t.users||{};Object.values(i).forEach((function(e){n=Math.max(n,e)}));const s=this.powerLevel,o=this.powerLevelNorm;void 0!==i[this.userId]&&Number.isInteger(i[this.userId])?this.powerLevel=i[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,n>0&&(this.powerLevelNorm=100*this.powerLevel/n),s===this.powerLevel&&o===this.powerLevelNorm||(this.updateModifiedTime(),this.emit(d.PowerLevel,e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const n=e.getContent().user_ids;Array.isArray(n)&&(-1!==n.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(d.Typing,e,this)))}updateModifiedTime(){this._modified=Date.now()}getLastModifiedTime(){return this._modified}isKicked(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const e=this.events.member;let t=e.getContent(),n=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return n}}getAvatarUrl(e,t,n,i){let s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],r=arguments.length>5?arguments[5]:void 0;const a=this.getMxcAvatarUrl();if(!a&&!s)return null;const c=Object(o.a)(e,a,t,n,i,r);return c||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null}}const h=/@.+:.+/,m=/[\u200E\u200F\u202A-\u202F]/},function(e,t,n){"use strict";n.d(t,"e",(function(){return h})),n.d(t,"f",(function(){return m})),n.d(t,"a",(function(){return p})),n.d(t,"d",(function(){return g})),n.d(t,"c",(function(){return f})),n.d(t,"b",(function(){return v})),n.d(t,"h",(function(){return w})),n.d(t,"g",(function(){return _}));var i=n(17),s=n.n(i),o=n(0),r=n(7),a=n(97),c=n(186),l=n(439),d=n(440),u=n(143);let h,m,p,g,f,v;!function(e){e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended"}(h||(h={})),function(e){e.Voice="voice",e.Video="video"}(m||(m={})),function(e){e.Inbound="inbound",e.Outbound="outbound"}(p||(p={})),function(e){e.Local="local",e.Remote="remote"}(g||(g={})),function(e){e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed",e.LengthChanged="length_changed",e.DataChannel="datachannel"}(f||(f={})),function(e){e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transfered="transferred"}(v||(v={}));class b extends Error{constructor(e,t,n){super(t+": "+n),s()(this,"code",void 0),this.code=e}}function y(){return Date.now().toString()+Object(c.b)(16)}class S extends u.b{constructor(e){super(),s()(this,"roomId",void 0),s()(this,"callId",void 0),s()(this,"state",h.Fledgling),s()(this,"hangupParty",void 0),s()(this,"hangupReason",void 0),s()(this,"direction",void 0),s()(this,"ourPartyId",void 0),s()(this,"client",void 0),s()(this,"forceTURN",void 0),s()(this,"turnServers",void 0),s()(this,"candidateSendQueue",[]),s()(this,"candidateSendTries",0),s()(this,"sentEndOfCandidates",!1),s()(this,"peerConn",void 0),s()(this,"feeds",[]),s()(this,"usermediaSenders",[]),s()(this,"screensharingSenders",[]),s()(this,"inviteOrAnswerSent",!1),s()(this,"waitForLocalAVStream",void 0),s()(this,"successor",void 0),s()(this,"opponentMember",void 0),s()(this,"opponentVersion",void 0),s()(this,"opponentPartyId",void 0),s()(this,"opponentCaps",void 0),s()(this,"inviteTimeout",void 0),s()(this,"remoteOnHold",!1),s()(this,"callStatsAtEnd",void 0),s()(this,"makingOffer",!1),s()(this,"ignoreOffer",void 0),s()(this,"remoteCandidateBuffer",new Map),s()(this,"remoteAssertedIdentity",void 0),s()(this,"remoteSDPStreamMetadata",void 0),s()(this,"callLengthInterval",void 0),s()(this,"callLength",0),s()(this,"gotLocalIceCandidate",e=>{if(e.candidate){if(o.a.debug("Call "+this.callId+" got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),this.callHasEnded())return;""===e.candidate.candidate&&this.sentEndOfCandidates||(this.queueCandidate(e.candidate),""===e.candidate.candidate&&(this.sentEndOfCandidates=!0))}}),s()(this,"onIceGatheringStateChange",e=>{if(o.a.debug("ice gathering state changed to "+this.peerConn.iceGatheringState),"complete"===this.peerConn.iceGatheringState&&!this.sentEndOfCandidates){const e={candidate:""};this.queueCandidate(e),this.sentEndOfCandidates=!0}}),s()(this,"gotLocalOffer",async e=>{if(o.a.debug("Created offer: ",e),this.callHasEnded())return void o.a.debug("Ignoring newly created offer on call ID "+this.callId+" because the call has ended");try{await this.peerConn.setLocalDescription(e)}catch(e){return o.a.debug("Error setting local description!",e),void this.terminate(g.Local,v.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&await new Promise(e=>{setTimeout(e,200)}),this.callHasEnded())return;const t=this.state===h.CreateOffer?a.b.CallInvite:a.b.CallNegotiate,n={lifetime:6e4};this.state===h.CreateOffer?n.offer=this.peerConn.localDescription:n.description=this.peerConn.localDescription,n.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},n[l.a]=this.getLocalSDPStreamMetadata(),o.a.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in offer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(t,n)}catch(e){o.a.error("Failed to send invite",e),e.event&&this.client.cancelPendingEvent(e.event);let t=v.SignallingFailed,n="Signalling failed";return this.state===h.CreateOffer&&(t=v.SendInvite,n="Failed to send invite"),"UnknownDeviceError"==e.name&&(t=v.UnknownDevices,n="Unknown devices present in the room"),this.emit(f.Error,new b(t,n,e)),void this.terminate(g.Local,t,!1)}this.sendCandidateQueue(),this.state===h.CreateOffer&&(this.inviteOrAnswerSent=!0,this.setState(h.InviteSent),this.inviteTimeout=setTimeout(()=>{this.inviteTimeout=null,this.state===h.InviteSent&&this.hangup(v.InviteTimeout,!1)},6e4))}),s()(this,"getLocalOfferFailed",e=>{o.a.error("Failed to get local offer",e),this.emit(f.Error,new b(v.LocalOfferFailed,"Failed to get local offer!",e)),this.terminate(g.Local,v.LocalOfferFailed,!1)}),s()(this,"getUserMediaFailed",e=>{this.successor?this.successor.getUserMediaFailed(e):(o.a.warn("Failed to get user media - ending call",e),this.emit(f.Error,new b(v.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e)),this.terminate(g.Local,v.NoUserMedia,!1))}),s()(this,"onIceConnectionStateChanged",()=>{this.callHasEnded()||(o.a.debug("Call ID "+this.callId+": ICE connection state changed to: "+this.peerConn.iceConnectionState),"connected"==this.peerConn.iceConnectionState?(this.setState(h.Connected),this.callLengthInterval||(this.callLengthInterval=setInterval(()=>{this.callLength++,this.emit(f.LengthChanged,this.callLength)},1e3))):"failed"==this.peerConn.iceConnectionState&&this.hangup(v.IceFailed,!1))}),s()(this,"onSignallingStateChanged",()=>{o.a.debug("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)}),s()(this,"onTrack",e=>{if(0===e.streams.length)return void o.a.warn(`Streamless ${e.track.kind} found: ignoring.`);const t=e.streams[0];this.pushRemoteFeed(t),t.addEventListener("removetrack",()=>{0===t.getTracks().length&&(o.a.info(`Stream ID ${t.id} has no tracks remaining - removing`),this.deleteFeedByStream(t))})}),s()(this,"onDataChannel",e=>{this.emit(f.DataChannel,e.channel)}),s()(this,"onNegotiationNeeded",async()=>{if(o.a.info("Negotiation is needed!"),this.state===h.CreateOffer||0!==this.opponentVersion){this.makingOffer=!0;try{this.getRidOfRTXCodecs();const e=await this.peerConn.createOffer();await this.gotLocalOffer(e)}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}else o.a.info("Opponent does not support renegotiation: ignoring negotiationneeded event")}),s()(this,"onHangupReceived",e=>{o.a.debug("Hangup received for call ID "+this.callId),this.partyIdMatches(e)||this.state===h.Ringing?this.terminate(g.Remote,e.reason||v.UserHangup,!0):o.a.info(`Ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)}),s()(this,"onRejectReceived",e=>{o.a.debug("Reject received for call ID "+this.callId);[h.InviteSent,h.Ringing].includes(this.state)||this.state===h.Fledgling&&this.direction===p.Inbound?this.terminate(g.Remote,e.reason||v.UserHangup,!0):o.a.debug(`Call is in state: ${this.state}: ignoring reject`)}),s()(this,"onAnsweredElsewhere",e=>{o.a.debug("Call ID "+this.callId+" answered elsewhere"),this.terminate(g.Remote,v.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.client=e.client,this.forceTURN=e.forceTURN,this.ourPartyId=this.client.deviceId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]});for(const e of this.turnServers)r.e(e,["urls"]);this.callId=y()}async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(e,t){const n=this.peerConn.createDataChannel(e,t);return this.emit(f.DataChannel,n),o.a.debug("created data channel"),n}getOpponentMember(){return this.opponentMember}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get type(){return this.hasLocalUserMediaVideoTrack||this.hasRemoteUserMediaVideoTrack?m.Video:m.Voice}get hasLocalUserMediaVideoTrack(){var e;return(null===(e=this.localUsermediaStream)||void 0===e?void 0:e.getVideoTracks().length)>0}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>e.purpose===l.b.Usermedia&&e.stream.getVideoTracks().length>0)}get hasLocalUserMediaAudioTrack(){var e;return(null===(e=this.localUsermediaStream)||void 0===e?void 0:e.getAudioTracks().length)>0}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>e.purpose===l.b.Usermedia&&e.stream.getAudioTracks().length>0)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===l.b.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===l.b.Screenshare)}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===l.b.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===l.b.Screenshare)}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}getLocalSDPStreamMetadata(){const e={};for(const t of this.getLocalFeeds())e[t.stream.id]={purpose:t.purpose,audio_muted:t.isAudioMuted(),video_muted:t.isVideoMuted()};return o.a.debug("Got local SDPStreamMetadata",e),e}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata())return void this.pushRemoteFeedWithoutMetadata(e);const t=this.getOpponentMember().userId,n=this.remoteSDPStreamMetadata[e.id].purpose,i=this.remoteSDPStreamMetadata[e.id].audio_muted,s=this.remoteSDPStreamMetadata[e.id].video_muted;if(!n)return void o.a.warn(`Ignoring stream with id ${e.id} because we didn't get any metadata about it`);const r=this.getRemoteFeeds().find(e=>e.purpose===n);r?r.setNewStream(e):(this.feeds.push(new d.a({client:this.client,roomId:this.roomId,userId:t,stream:e,purpose:n,audioMuted:i,videoMuted:s})),this.emit(f.FeedsChanged,this.feeds)),o.a.info(`Pushed remote stream (id="${e.id}", active="${e.active}", purpose=${n})`)}pushRemoteFeedWithoutMetadata(e){var t;const n=this.getOpponentMember().userId,i=l.b.Usermedia,s=null===(t=this.feeds.find(e=>!e.isLocal()))||void 0===t?void 0:t.stream;if(s&&e.id!==s.id)return void o.a.warn(`Ignoring new stream ID ${e.id}: we already have stream ID ${s.id}`);const r=this.getFeedByStreamId(e.id);r?r.setNewStream(e):(this.feeds.push(new d.a({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,stream:e,purpose:i})),this.emit(f.FeedsChanged,this.feeds)),o.a.info(`Pushed remote stream (id="${e.id}", active="${e.active}")`)}pushNewLocalFeed(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=this.client.getUserId();E(e.getAudioTracks(),!0),E(e.getVideoTracks(),!0);const s=this.getLocalFeeds().find(e=>e.purpose===t);s?s.setNewStream(e):(this.pushLocalFeed(new d.a({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:i,stream:e,purpose:t}),n),this.emit(f.FeedsChanged,this.feeds))}pushLocalFeed(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.feeds.push(e),t){const t=e.purpose===l.b.Usermedia?this.usermediaSenders:this.screensharingSenders;t.splice(0,t.length);for(const n of e.stream.getTracks())o.a.info(`Adding track (id="${n.id}", kind="${n.kind}", streamId="${e.stream.id}", streamPurpose="${e.purpose}", enabled=`+n.enabled+") to peer connection"),t.push(this.peerConn.addTrack(n,e.stream))}o.a.info(`Pushed local stream (id="${e.stream.id}", active="${e.stream.active}", purpose="${e.purpose}")`),this.emit(f.FeedsChanged,this.feeds)}removeLocalFeed(e){const t=e.purpose===l.b.Usermedia?this.usermediaSenders:this.screensharingSenders;for(const e of t)this.peerConn.removeTrack(e);t.splice(0,t.length),this.deleteFeedByStream(e.stream)}deleteAllFeeds(){for(const e of this.feeds)e.dispose();this.feeds=[],this.emit(f.FeedsChanged,this.feeds)}deleteFeedByStream(e){o.a.debug("Removing feed with stream id "+e.id);const t=this.getFeedByStreamId(e.id);t?(t.dispose(),this.feeds.splice(this.feeds.indexOf(t),1),this.emit(f.FeedsChanged,this.feeds)):o.a.warn(`Didn't find the feed with stream id ${e.id} to delete`)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];return e.forEach(e=>{t.push(e[1])}),t}async initWithInvite(e){var t;const n=e.getContent();this.direction=p.Inbound;await this.client.checkTurnServers()||o.a.warn("Failed to get TURN credentials! Proceeding with call anyway...");const i=n[l.a];i?this.updateRemoteSDPStreamMetadata(i):o.a.debug("Did not get any SDPStreamMetadata! Can not send/receive multiple streams"),this.peerConn=this.createPeerConnection(),this.chooseOpponent(e);try{await this.peerConn.setRemoteDescription(n.offer),await this.addBufferedIceCandidates()}catch(e){return o.a.debug("Failed to set remote description",e),void this.terminate(g.Local,v.SetRemoteDescription,!1)}const s=null===(t=this.feeds.find(e=>!e.isLocal()))||void 0===t?void 0:t.stream;if(!s||0===s.getTracks().length)return o.a.error("No remote stream or no tracks after setting remote description!"),void this.terminate(g.Local,v.SetRemoteDescription,!1);this.setState(h.Ringing),e.getLocalAge()&&setTimeout(()=>{this.state==h.Ringing&&(o.a.debug("Call invite has expired. Hanging up."),this.hangupParty=g.Remote,this.setState(h.Ended),this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit(f.Hangup))},n.lifetime-e.getLocalAge())}initWithHangup(e){this.setState(h.Ended)}shouldAnswerWithMediaType(e,t,n){return e&&!t?(o.a.warn(`Unable to answer with ${n} because the other side isn't sending it either.`),!1):r.t(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!=e?e:t:(o.a.warn(`Unable to answer with ${n}=${e} because the other side doesn't support it. Answering with ${n}=${t}.`),t)}async answer(e,t){if(!this.inviteOrAnswerSent){if(!1===e&&!1===t)throw new Error("You CANNOT answer a call without media");if(o.a.debug("Answering call "+this.callId),this.localUsermediaStream||this.waitForLocalAVStream)this.waitForLocalAVStream&&this.setState(h.WaitLocalMedia);else{const n=this.state,i=this.shouldAnswerWithMediaType(e,this.hasRemoteUserMediaAudioTrack,"audio"),s=this.shouldAnswerWithMediaType(t,this.hasRemoteUserMediaVideoTrack,"video");this.setState(h.WaitLocalMedia),this.waitForLocalAVStream=!0;try{const e=await this.client.getMediaHandler().getUserMediaStream(i,s);this.waitForLocalAVStream=!1;const t=[new d.a({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),stream:e,purpose:l.b.Usermedia,audioMuted:!1,videoMuted:!1})];this.localScreensharingFeed&&t.push(this.localScreensharingFeed),this.answerWithCallFeeds(t)}catch(e){if(!s)return void this.getUserMediaFailed(e);o.a.warn("Failed to getUserMedia(), trying to getUserMedia() without video"),this.setState(n),this.waitForLocalAVStream=!1,await this.answer(i,!1)}}}}answerWithCallFeeds(e){this.inviteOrAnswerSent||(o.a.debug("Answering call "+this.callId),this.gotCallFeedsForAnswer(e))}replacedBy(e){this.state===h.WaitLocalMedia?(o.a.debug("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):[h.CreateOffer,h.InviteSent].includes(this.state)&&(o.a.debug("Handing local stream to new call"),e.gotCallFeedsForAnswer(this.getLocalFeeds())),this.successor=e,this.emit(f.Replaced,e),this.hangup(v.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(o.a.debug("Ending call "+this.callId),this.terminate(g.Local,e,!t),this.state===h.WaitLocalMedia)return;const n={};(this.opponentVersion&&this.opponentVersion>=1||e!==v.UserHangup)&&(n.reason=e),this.sendVoipEvent(a.b.CallHangup,n)}reject(){if(this.state!==h.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion<1)return o.a.info(`Opponent version is less than 1 (${this.opponentVersion}): sending hangup instead of reject`),void this.hangup(v.UserHangup,!0);o.a.debug("Rejecting call: "+this.callId),this.terminate(g.Local,v.UserHangup,!0),this.sendVoipEvent(a.b.CallReject,{})}async upgradeCall(e,t){if((e||t)&&this.opponentSupportsSDPStreamMetadata())try{const n=e||this.hasLocalUserMediaAudioTrack,i=t||this.hasLocalUserMediaVideoTrack,s=await this.client.getMediaHandler().getUserMediaStream(n,i,!1);await this.updateLocalUsermediaStream(s,e,t)}catch(e){o.a.error("Failed to upgrade the call",e),this.emit(f.Error,new b(v.NoUserMedia,"Failed to get camera access: ",e))}}opponentSupportsSDPStreamMetadata(){return Boolean(this.remoteSDPStreamMetadata)}isScreensharing(){return Boolean(this.localScreensharingStream)}async setScreensharingEnabled(e,t){if(e&&this.isScreensharing())return o.a.warn("There is already a screensharing stream - there is nothing to do!"),!0;if(!e&&!this.isScreensharing())return o.a.warn("There already isn't a screensharing stream - there is nothing to do!"),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(e,t);if(o.a.debug("Set screensharing enabled? "+e),!e){for(const e of this.screensharingSenders)this.peerConn.removeTrack(e);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);return!!e&&(this.pushNewLocalFeed(e,l.b.Screenshare),!0)}catch(e){return o.a.error("Failed to get screen-sharing stream:",e),!1}}async setScreensharingEnabledWithoutMetadataSupport(e,t){if(o.a.debug(`Set screensharing enabled? ${e} using replaceTrack()`),!e){const e=this.localUsermediaStream.getTracks().find(e=>"video"===e.kind);return this.usermediaSenders.find(e=>{var t;return"video"===(null===(t=e.track)||void 0===t?void 0:t.kind)}).replaceTrack(e),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);if(!e)return!1;const n=e.getTracks().find(e=>"video"===e.kind);return this.usermediaSenders.find(e=>{var t;return"video"===(null===(t=e.track)||void 0===t?void 0:t.kind)}).replaceTrack(n),this.pushNewLocalFeed(e,l.b.Screenshare,!1),!0}catch(e){return o.a.error("Failed to get screen-sharing stream:",e),!1}}async updateLocalUsermediaStream(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=this.localUsermediaFeed,s=t||!i.isAudioMuted()&&!this.remoteOnHold,r=n||!i.isVideoMuted()&&!this.remoteOnHold;E(e.getAudioTracks(),s),E(e.getVideoTracks(),r);for(const e of this.localUsermediaStream.getTracks())this.localUsermediaStream.removeTrack(e),e.stop();for(const t of e.getTracks())this.localUsermediaStream.addTrack(t);const a=[];for(const t of e.getTracks()){const n=this.usermediaSenders.find(e=>{var n;return(null===(n=e.track)||void 0===n?void 0:n.kind)===t.kind});let s;n?(o.a.info(`Replacing track (id="${t.id}", kind="${t.kind}", streamId="${e.id}", streamPurpose="${i.purpose}") to peer connection`),await n.replaceTrack(t),s=n):(o.a.info(`Adding track (id="${t.id}", kind="${t.kind}", streamId="${e.id}", streamPurpose="${i.purpose}") to peer connection`),s=this.peerConn.addTrack(t,this.localUsermediaStream)),a.push(s)}this.usermediaSenders=a}async setLocalVideoMuted(e){var t;return await this.client.getMediaHandler().hasVideoDevice()?this.hasLocalUserMediaVideoTrack||e?(null===(t=this.localUsermediaFeed)||void 0===t||t.setVideoMuted(e),this.updateMuteStatus(),this.isLocalVideoMuted()):(await this.upgradeCall(!1,!0),this.isLocalVideoMuted()):this.isLocalVideoMuted()}isLocalVideoMuted(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.isVideoMuted()}async setMicrophoneMuted(e){var t;return await this.client.getMediaHandler().hasAudioDevice()?this.hasLocalUserMediaAudioTrack||e?(null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioMuted(e),this.updateMuteStatus(),this.isMicrophoneMuted()):(await this.upgradeCall(!0,!1),this.isMicrophoneMuted()):this.isMicrophoneMuted()}isMicrophoneMuted(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.isAudioMuted()}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.emit(f.RemoteHoldUnhold,this.remoteOnHold)}}isLocalOnHold(){if(this.state!==h.Connected)return!1;let e=!0;for(const t of this.peerConn.getTransceivers()){["inactive","recvonly"].includes(t.currentDirection)||(e=!1)}return e}sendDtmfDigit(e){for(const t of this.peerConn.getSenders())if("audio"===t.track.kind&&t.dtmf)return void t.dtmf.insertDTMF(e);throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){this.sendVoipEvent(a.b.CallSDPStreamMetadataChangedPrefix,{[l.a]:this.getLocalSDPStreamMetadata()});const e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;E(this.localUsermediaStream.getAudioTracks(),!e),E(this.localUsermediaStream.getVideoTracks(),!t)}gotCallFeedsForInvite(e){if(this.successor)this.successor.gotCallFeedsForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{for(const t of e)this.pushLocalFeed(t);this.setState(h.CreateOffer),o.a.debug("gotUserMediaForInvite")}}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[l.a]:this.getLocalSDPStreamMetadata()};e.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},o.a.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(a.b.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(e){this.setState(h.Ringing),this.client.cancelPendingEvent(e.event);let t=v.SendAnswer,n="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=v.UnknownDevices,n="Unknown devices present in the room"),this.emit(f.Error,new b(t,n,e)),e}this.sendCandidateQueue()}async gotCallFeedsForAnswer(e){if(this.callHasEnded())return;this.waitForLocalAVStream=!1;for(const t of e)this.pushLocalFeed(t);let t;this.setState(h.CreateAnswer);try{this.getRidOfRTXCodecs(),t=await this.peerConn.createAnswer()}catch(e){return o.a.debug("Failed to create answer: ",e),void this.terminate(g.Local,v.CreateAnswer,!0)}try{await this.peerConn.setLocalDescription(t),this.setState(h.Connecting),await new Promise(e=>{setTimeout(e,200)}),this.sendAnswer()}catch(e){return o.a.debug("Error setting local description!",e),void this.terminate(g.Local,v.SetLocalDescription,!0)}}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent(),n=t.candidates;if(!n)return void o.a.info("Ignoring candidates event with no candidates!");const i=0===t.version?null:t.party_id||null;if(void 0===this.opponentPartyId){o.a.info(`Buffering ${n.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(i)||[];return e.push(...n),void this.remoteCandidateBuffer.set(i,e)}this.partyIdMatches(t)?await this.addIceCandidates(n):o.a.info(`Ignoring candidates from party ID ${t.party_id}: we have chosen party ID `+this.opponentPartyId)}async onAnswerReceived(e){const t=e.getContent();if(o.a.debug(`Got answer for call ID ${this.callId} from party ID ${t.party_id}`),this.callHasEnded())return void o.a.debug(`Ignoring answer because call ID ${this.callId} has ended`);if(void 0!==this.opponentPartyId)return void o.a.info(`Ignoring answer from party ID ${t.party_id}: we already have an answer/reject from `+this.opponentPartyId);this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.setState(h.Connecting);const n=t[l.a];n?this.updateRemoteSDPStreamMetadata(n):o.a.warn("Did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConn.setRemoteDescription(t.answer)}catch(e){return o.a.debug("Failed to set remote description",e),void this.terminate(g.Local,v.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(a.b.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(e){o.a.warn("Failed to send select_answer event",e)}}async onSelectAnswerReceived(e){if(this.direction!==p.Inbound)return void o.a.warn("Got select_answer for an outbound call: ignoring");const t=e.getContent().selected_party_id;null!=t?t!==this.ourPartyId&&(o.a.info(`Got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),this.terminate(g.Remote,v.AnsweredElsewhere,!0)):o.a.warn("Got nonsensical select_answer with null/undefined selected_party_id: ignoring")}async onNegotiateReceived(e){const t=e.getContent(),n=t.description;if(!n||!n.sdp||!n.type)return void o.a.info("Ignoring invalid m.call.negotiate event");const i=this.direction===p.Inbound,s="offer"===n.type&&(this.makingOffer||"stable"!==this.peerConn.signalingState);if(this.ignoreOffer=!i&&s,this.ignoreOffer)return void o.a.info("Ignoring colliding negotiate event because we're impolite");const r=this.isLocalOnHold(),c=t[l.a];c?this.updateRemoteSDPStreamMetadata(c):o.a.warn("Received negotiation event without SDPStreamMetadata!");try{if(await this.peerConn.setRemoteDescription(n),"offer"===n.type){this.getRidOfRTXCodecs();const e=await this.peerConn.createAnswer();await this.peerConn.setLocalDescription(e),this.sendVoipEvent(a.b.CallNegotiate,{description:this.peerConn.localDescription,[l.a]:this.getLocalSDPStreamMetadata()})}}catch(e){o.a.warn("Failed to complete negotiation",e)}const d=this.isLocalOnHold();r!==d&&(this.emit(f.LocalHoldUnhold,d),this.emit(f.HoldUnhold,d))}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=r.B(this.remoteSDPStreamMetadata||{},e,!0);for(const e of this.getRemoteFeeds()){var t,n,i;const s=e.stream.id;e.setAudioMuted(null===(t=this.remoteSDPStreamMetadata[s])||void 0===t?void 0:t.audio_muted),e.setVideoMuted(null===(n=this.remoteSDPStreamMetadata[s])||void 0===n?void 0:n.video_muted),e.purpose=null===(i=this.remoteSDPStreamMetadata[s])||void 0===i?void 0:i.purpose}}onSDPStreamMetadataChangedReceived(e){const t=e.getContent()[l.a];this.updateRemoteSDPStreamMetadata(t)}async onAssertedIdentityReceived(e){const t=e.getContent();t.asserted_identity&&(this.remoteAssertedIdentity={id:t.asserted_identity.id,displayName:t.asserted_identity.display_name},this.emit(f.AssertedIdentityChanged))}callHasEnded(){return this.state===h.Ended}getRidOfRTXCodecs(){if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const e=RTCRtpReceiver.getCapabilities("video").codecs,t=[...RTCRtpSender.getCapabilities("video").codecs,...e];for(const e of t)if("video/rtx"===e.mimeType){const n=t.indexOf(e);t.splice(n,1)}for(const e of this.peerConn.getTransceivers()){var n,i;!this.screensharingSenders.includes(e.sender)||"video"!==(null===(n=e.sender.track)||void 0===n?void 0:n.kind)&&"video"!==(null===(i=e.receiver.track)||void 0===i?void 0:i.kind)||e.setCodecPreferences(t)}}setState(e){const t=this.state;this.state=e,this.emit(f.State,e,t)}sendVoipEvent(e,t){return this.client.sendEvent(this.roomId,e,Object.assign({},t,{version:1,call_id:this.callId,party_id:this.ourPartyId}))}queueCandidate(e){if(this.candidateSendQueue.push(e),this.state===h.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===p.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout(()=>{this.sendCandidateQueue()},t)}async transfer(e){const t=await this.client.getProfileInfo(e),n=y(),i={replacement_id:y(),target_user:{id:e,display_name:t.displayname,avatar_url:t.avatar_url},create_call:n};await this.sendVoipEvent(a.b.CallReplaces,i),await this.terminate(g.Local,v.Transfered,!0)}async transferToCall(e){const t=await this.client.getProfileInfo(e.getOpponentMember().userId),n=await this.client.getProfileInfo(this.getOpponentMember().userId),i=y(),s={replacement_id:y(),target_user:{id:this.getOpponentMember().userId,display_name:n.displayname,avatar_url:n.avatar_url},await_call:i};await e.sendVoipEvent(a.b.CallReplaces,s);const o={replacement_id:y(),target_user:{id:e.getOpponentMember().userId,display_name:t.displayname,avatar_url:t.avatar_url},create_call:i};await this.sendVoipEvent(a.b.CallReplaces,o),await this.terminate(g.Local,v.Transfered,!0),await e.terminate(g.Local,v.Transfered,!0)}async terminate(e,t,n){this.callHasEnded()||(this.callStatsAtEnd=await this.collectCallStats(),this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=null),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=null),t!==v.Replaced&&this.stopAllMedia(),this.deleteAllFeeds(),this.hangupParty=e,this.hangupReason=t,this.setState(h.Ended),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),n&&this.emit(f.Hangup))}stopAllMedia(){o.a.debug("Stopping all media for call",this.callId);for(const e of this.feeds)if(e.isLocal()&&e.purpose===l.b.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===l.b.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else{o.a.debug("Stopping remote stream",e.stream.id);for(const t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(0===this.listeners(u.a.Error).length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length)return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e};o.a.debug("Attempting to send "+e.length+" candidates");try{await this.sendVoipEvent(a.b.CallCandidates,t),this.candidateSendTries=0}catch(t){if(t.event&&this.client.cancelPendingEvent(t.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){o.a.debug("Failed to send candidates on attempt "+this.candidateSendTries+". Giving up on this call.",t);const e=v.SignallingFailed,n="Signalling failed";return this.emit(f.Error,new b(e,n,t)),void this.hangup(e,!1)}const n=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,o.a.debug("Failed to send candidates. Retrying in "+n+"ms",t),setTimeout(()=>{this.sendCandidateQueue()},n)}}async placeCall(e,t){if(!e)throw new Error("You CANNOT start a call without audio");this.setState(h.WaitLocalMedia);try{const n=await this.client.getMediaHandler().getUserMediaStream(e,t);E(n.getAudioTracks(),!0),E(n.getVideoTracks(),!0);const i=new d.a({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),stream:n,purpose:l.b.Usermedia,audioMuted:!1,videoMuted:!1});await this.placeCallWithCallFeeds([i])}catch(e){return void this.getUserMediaFailed(e)}}async placeCallWithCallFeeds(e){this.checkForErrorListener(),this.direction=p.Outbound,this.client.callEventHandler.calls.set(this.callId,this);await this.client.checkTurnServers()||o.a.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection(),this.gotCallFeedsForInvite(e)}createPeerConnection(){const e=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client.iceCandidatePoolSize});return e.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),e.addEventListener("signalingstatechange",this.onSignallingStateChanged),e.addEventListener("icecandidate",this.gotLocalIceCandidate),e.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.addEventListener("track",this.onTrack),e.addEventListener("negotiationneeded",this.onNegotiationNeeded),e.addEventListener("datachannel",this.onDataChannel),e}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){const t=e.getContent();o.a.debug(`Choosing party ID ${t.party_id} for call ID ${this.callId}`),this.opponentVersion=t.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=t.party_id||null,this.opponentCaps=t.capabilities||{},this.opponentMember=e.sender}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(o.a.info(`Adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer=null}async addIceCandidates(e){for(const t of e)if(null!==t.sdpMid&&void 0!==t.sdpMid||null!==t.sdpMLineIndex&&void 0!==t.sdpMLineIndex){o.a.debug("Call "+this.callId+" got remote ICE "+t.sdpMid+" candidate: "+t.candidate);try{await this.peerConn.addIceCandidate(t)}catch(e){this.ignoreOffer||o.a.info("Failed to add remote ICE candidate",e)}}else o.a.debug("Ignoring remote ICE candidate with no sdpMid or sdpMLineIndex")}get hasPeerConnection(){return Boolean(this.peerConn)}}function E(e,t){for(let n=0;n<e.length;n++)e[n].enabled=t}function w(){if("undefined"==typeof window||"undefined"==typeof document)return!1;try{if(!Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return o.a.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return o.a.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function _(e,t,n){if(!w())return null;const i=!!n&&n.forceTURN,s={client:e,roomId:t,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||i},o=new S(s);return e.reEmitter.reEmit(o,Object.values(f)),o}},function(e,t,n){"use strict";n.d(t,"j",(function(){return p})),n.d(t,"c",(function(){return g})),n.d(t,"g",(function(){return f})),n.d(t,"a",(function(){return v})),n.d(t,"h",(function(){return y})),n.d(t,"l",(function(){return S})),n.d(t,"f",(function(){return E})),n.d(t,"e",(function(){return w})),n.d(t,"b",(function(){return _})),n.d(t,"k",(function(){return C})),n.d(t,"d",(function(){return O})),n.d(t,"i",(function(){return R}));var i=n(108),s=n(97),o=n(0),r=n(165),a=n(18),c=n(90),l=n(327),d=n(93),u=n(92),h=n(430),m=n(96);function p(e){const{status:t}=e;if((!t||t===i.a.SENT)&&!e.isRedacted())if("m.room.message"===e.getType()){const t=e.getContent();if(t.msgtype&&"m.bad.encrypted"!==t.msgtype&&t.hasOwnProperty("body"))return!0}else if("m.sticker"===e.getType()||r.M_POLL_START.matches(e.getType()))return!0;return!1}function g(e){if(!(e.getType()===s.b.RoomMessage||r.M_POLL_START.matches(e.getType()))||e.status===i.a.CANCELLED||e.isRedacted()||e.isRelation(s.d.Replace)||e.getSender()!==c.a.get().getUserId())return!1;const{msgtype:t,body:n}=e.getOriginalContent();return r.M_POLL_START.matches(e.getType())||(t===s.c.Text||t===s.c.Emote)&&!!n&&"string"==typeof n}function f(e){let{events:t,isForward:n,fromEventId:i}=e;const s=t.length-1,o=n?1:-1,r=n?0:s;let a=n?s:0;i||(a=Math.min(Math.max(0,r+100*o),s));let c=!i;for(let e=r;e!==a+o;e+=o){const n=t[e];if(c||n.getId()!==i){if(c&&!Object(l.a)(n)&&g(n))return n}else c=!0,a=Math.min(Math.max(0,e+100*o),s)}}let v;!function(e){e.VISIBLE_FOR_ALL="VISIBLE_FOR_ALL",e.HIDDEN_TO_CURRENT_USER="HIDDEN_TO_CURRENT_USER",e.SEE_THROUGH_FOR_CURRENT_USER="SEE_THROUGH_FOR_CURRENT_USER"}(v||(v={}));let b=null;function y(e,t){var n,i;if(t=null!==(n=t)&&void 0!==n?n:c.a.get(),null===b&&(b=d.b.getValue("feature_msc3531_hide_messages_pending_moderation")),!b)return v.VISIBLE_FOR_ALL;if(e.messageVisibility().visible)return v.VISIBLE_FOR_ALL;if((null===(i=e.sender)||void 0===i?void 0:i.userId)===t.getUserId())return v.SEE_THROUGH_FOR_CURRENT_USER;const o=t.getRoom(e.getRoomId());return s.a.name&&o.currentState.maySendStateEvent(s.a.name,t.getUserId())||s.a.altName&&o.currentState.maySendStateEvent(s.a.altName,t.getUserId())?v.SEE_THROUGH_FOR_CURRENT_USER:v.HIDDEN_TO_CURRENT_USER}function S(e){const t=e.getContent();return!!t["org.matrix.msc2516.voice"]||!!t["org.matrix.msc3245.voice"]}async function E(e,t,n){var s;let r;try{const s=await e.fetchRoomEvent(t,n);r=new i.b(s)}catch(e){o.a.warn("Could not find initial event: "+n),r=null}if(null!==(s=r)&&void 0!==s&&s.isThreadRelation&&e.supportsExperimentalThreads()&&!r.getThread()){const n=r.threadRootId,i=e.getRoom(t);try{i.createThread(n,i.findEventById(n),[r],!0)}catch(e){o.a.warn("Could not find root event: "+n)}}return r}function w(e,t,n){g(e)&&(r.M_POLL_START.matches(e.getType())?Object(h.d)(e,n):u.a.dispatch({action:m.a.EditEvent,event:e,timelineRenderingType:t}))}function _(e){return e===i.a.QUEUED||e===i.a.NOT_SENT||e===i.a.ENCRYPTING}const C=e=>{const t=e.getType();return a.c.matches(t)||t===s.b.RoomMessage&&a.c.matches(e.getContent().msgtype)};function O(e){return!r.M_POLL_START.matches(e.getType())}function R(e){var t;return e.isThreadRoot&&(null===(t=e.getThread())||void 0===t?void 0:t.length)&&!!e.getThread().replyToEvent}},function(e,t,n){"use strict";n.d(t,"d",(function(){return v})),n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return y})),n.d(t,"c",(function(){return S}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(94),d=n.n(l),u=n(112),h=n(89);const m=["label","iconClassName","active","className"],p=["label","iconClassName","active","className","words"],g=["label","className","iconClassName","children"],f=["className","children","compact"],v=e=>{let{label:t,iconClassName:n,active:i,className:o}=e,a=r()(e,m);return c.a.createElement(u.g,s()({},a,{className:d()(o,{mx_IconizedContextMenu_item:!0,mx_IconizedContextMenu_active:i}),active:i,label:t}),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",n)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),i&&c.a.createElement("span",{className:"mx_IconizedContextMenu_icon mx_IconizedContextMenu_checked"}))},b=e=>{let t,{label:n,iconClassName:i,active:o,className:a,words:l}=e,m=r()(e,p);return t=l?c.a.createElement("span",{className:"mx_IconizedContextMenu_activeText"},o?Object(h.a)("On"):Object(h.a)("Off")):c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",{mx_IconizedContextMenu_checked:o,mx_IconizedContextMenu_unchecked:!o})}),c.a.createElement(u.f,s()({},m,{className:d()(a,{mx_IconizedContextMenu_item:!0,mx_IconizedContextMenu_active:o}),active:o,label:n}),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",i)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},n),t)},y=e=>{let{label:t,className:n,iconClassName:i,children:o}=e,a=r()(e,g);return c.a.createElement(u.e,s()({},a,{className:d()(n,{mx_IconizedContextMenu_item:!0}),label:t}),i&&c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",i)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),o)},S=e=>{let{first:t,red:n,className:i,label:s,children:o}=e;const r=d()("mx_IconizedContextMenu_optionList",i,{mx_IconizedContextMenu_optionList_notFirst:!t,mx_IconizedContextMenu_optionList_red:n});return c.a.createElement("div",{className:r},s&&c.a.createElement("div",null,c.a.createElement("span",{className:"mx_IconizedContextMenu_optionList_label"},s)),o)};t.e=e=>{let{className:t,children:n,compact:i}=e,o=r()(e,f);const a=d()("mx_IconizedContextMenu",t,{mx_IconizedContextMenu_compact:i});return c.a.createElement(u.o,s()({chevronFace:u.a.None},o),c.a.createElement("div",{className:a},n))}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.General="USER_GENERAL_TAB",e.Appearance="USER_APPEARANCE_TAB",e.Notifications="USER_NOTIFICATIONS_TAB",e.Preferences="USER_PREFERENCES_TAB",e.Keyboard="USER_KEYBOARD_TAB",e.Sidebar="USER_SIDEBAR_TAB",e.Voice="USER_VOICE_TAB",e.Security="USER_SECURITY_TAB",e.Labs="USER_LABS_TAB",e.Mjolnir="USER_MJOLNIR_TAB",e.Help="USER_HELP_TAB"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return J})),n.d(t,"b",(function(){return Y}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(152),c=n(0),l=n(8),d=n.n(l),u=n(202),h=n(282),m=n(242),p=n(597),g=n(90),f=n(95),v=n(89),b=n(92),y=n(142),S=n(93),E=n(181),w=n(104),_=n(115),C=n(107),O=n(209),R=n(258),I=n(2),k=n(162),x=n(122),T=n(96),j=n(406),N=n(205),P=n(184),D=n(336),A=n(98);function M(){var e;return A.b.get().widget_build_url?A.b.get().widget_build_url:null===(e=Object(N.b)())||void 0===e?void 0:e.widget_build_url}var U=n(183),L=n(94),F=n.n(L),B=n(130),K=n(117),V=n(91);class W extends r.a.Component{constructor(e){super(e),s()(this,"componentDidMount",()=>{Y.instance.addListener(J.SilencedCallsChanged,this.onSilencedCallsChanged)}),s()(this,"onSilencedCallsChanged",()=>{this.setState({silenced:Y.instance.isCallSilenced(this.props.call.callId)})}),s()(this,"onAnswerClick",e=>{e.stopPropagation(),Y.instance.answerCall(Y.instance.roomIdForCall(this.props.call))}),s()(this,"onRejectClick",e=>{e.stopPropagation(),Y.instance.hangupOrReject(Y.instance.roomIdForCall(this.props.call),!0)}),s()(this,"onSilenceClick",e=>{e.stopPropagation();const t=this.props.call.callId;this.state.silenced?Y.instance.unSilenceCall(t):Y.instance.silenceCall(t)}),this.state={silenced:Y.instance.isCallSilenced(this.props.call.callId)}}componentWillUnmount(){Y.instance.removeListener(J.SilencedCallsChanged,this.onSilencedCallsChanged)}render(){const e=this.props.call,t=g.a.get().getRoom(Y.instance.roomIdForCall(e)),n=e.type===a.f.Voice,i=F()("mx_IncomingCallToast_content",{mx_IncomingCallToast_content_voice:n,mx_IncomingCallToast_content_video:!n}),s=F()("mx_IncomingCallToast_iconButton",{mx_IncomingCallToast_unSilence:this.state.silenced,mx_IncomingCallToast_silence:!this.state.silenced});return r.a.createElement(r.a.Fragment,null,r.a.createElement(B.a,{room:t,height:32,width:32}),r.a.createElement("div",{className:i},r.a.createElement("span",{className:"mx_CallEvent_caller"},t?t.name:Object(v.a)("Unknown caller")),r.a.createElement("div",{className:"mx_CallEvent_type"},r.a.createElement("div",{className:"mx_CallEvent_type_icon"}),n?Object(v.a)("Voice call"):Object(v.a)("Video call")),r.a.createElement("div",{className:"mx_IncomingCallToast_buttons"},r.a.createElement(V.a,{className:"mx_IncomingCallToast_button mx_IncomingCallToast_button_decline",onClick:this.onRejectClick,kind:"danger"},r.a.createElement("span",null," ",Object(v.a)("Decline")," ")),r.a.createElement(V.a,{className:"mx_IncomingCallToast_button mx_IncomingCallToast_button_accept",onClick:this.onAnswerClick,kind:"primary"},r.a.createElement("span",null," ",Object(v.a)("Accept")," ")))),r.a.createElement(K.a,{className:s,onClick:this.onSilenceClick,title:this.state.silenced?Object(v.a)("Sound on"):Object(v.a)("Silence call")}))}}var H=n(160),q=n(396),$=n(301),G=n(531);var z;let J;!function(e){e.Ring="ringAudio",e.Ringback="ringbackAudio",e.CallEnd="callendAudio",e.Busy="busyAudio"}(z||(z={})),function(e){e.CallsChanged="calls_changed",e.CallChangeRoom="call_change_room",e.SilencedCallsChanged="silenced_calls_changed",e.CallState="call_state"}(J||(J={}));class Y extends d.a{constructor(){super(...arguments),s()(this,"calls",new Map),s()(this,"transferees",new Map),s()(this,"audioPromises",new Map),s()(this,"supportsPstnProtocol",null),s()(this,"pstnSupportPrefixed",null),s()(this,"supportsSipNativeVirtual",null),s()(this,"assertedIdentityNativeUsers",new Map),s()(this,"silencedCalls",new Set),s()(this,"onCallIncoming",e=>{if(!g.a.get().supportsVoip())return;const t=Y.instance.roomIdForCall(e);if(this.getCallForRoom(t))return void c.a.log("Got incoming call for room "+t+" but there's already a call for this room: ignoring");k.a.trackEvent("voip","receiveCall","type",e.type),this.addCallForRoom(t,e),this.setCallListeners(e),this.onCallStateChanged(e.state,null,e);const n=g.a.get();n.prepareToEncrypt(n.getRoom(e.roomId))}),s()(this,"onCallStateChanged",(e,t,n)=>{if(!this.matchesCallForThisRoom(n))return;const i=this.roomIdForCall(n);switch(this.setCallState(n,e),b.a.dispatch({action:"call_state",room_id:i,state:e}),t){case a.e.Ringing:this.pause(z.Ring);break;case a.e.InviteSent:this.pause(z.Ringback)}switch(e!==a.e.Ringing&&this.silencedCalls.delete(n.callId),e){case a.e.Ringing:{const e=new h.a(g.a.get()).getPushRuleById(u.f.IncomingCall),t=null==e?void 0:e.enabled,i=null==e?void 0:e.actions.some(e=>e.set_tweak===u.g.Sound&&"ring"===e.value);t&&i?this.play(z.Ring):this.silenceCall(n.callId);break}case a.e.InviteSent:this.play(z.Ringback);break;case a.e.Ended:{const e=n.hangupReason;if(k.a.trackEvent("voip","callEnded","hangupReason",e),this.removeCallForRoom(i),t===a.e.InviteSent&&n.hangupParty===a.d.Remote){if(this.play(z.Busy),!e||[a.b.UserHangup,"user hangup"].includes(e))break;let t,i;n.hangupReason===a.b.UserBusy?(t=Object(v.a)("User Busy"),i=Object(v.a)("The user you called is busy.")):(t=Object(v.a)("Call Failed"),i=Object(v.a)("The call could not be established")),f.a.createTrackedDialog("Call Handler","Call Failed",C.a,{title:t,description:i})}else e===a.b.AnsweredElsewhere&&t===a.e.Connecting?f.a.createTrackedDialog("Call Handler","Call Failed",C.a,{title:Object(v.a)("Answered Elsewhere"),description:Object(v.a)("The call was answered on another device.")}):t!==a.e.Fledgling&&t!==a.e.Ringing&&this.play(z.CallEnd);this.logCallStats(n,i);break}}})}static get instance(){return window.mxCallHandler||(window.mxCallHandler=new Y),window.mxCallHandler}roomIdForCall(e){if(!e)return null;if(this.shouldObeyAssertedfIdentity()){const t=this.assertedIdentityNativeUsers[e.callId];if(t){const e=Object($.c)(g.a.get(),t);if(e)return e.roomId}}return j.a.sharedInstance().nativeRoomForVirtualRoom(e.roomId)||e.roomId}start(){navigator.mediaSession&&(navigator.mediaSession.setActionHandler("play",(function(){})),navigator.mediaSession.setActionHandler("pause",(function(){})),navigator.mediaSession.setActionHandler("seekbackward",(function(){})),navigator.mediaSession.setActionHandler("seekforward",(function(){})),navigator.mediaSession.setActionHandler("previoustrack",(function(){})),navigator.mediaSession.setActionHandler("nexttrack",(function(){}))),S.b.getValue(x.b.Voip)&&g.a.get().on(p.b.Incoming,this.onCallIncoming),this.checkProtocols(3)}stop(){const e=g.a.get();e&&e.removeListener(p.b.Incoming,this.onCallIncoming)}silenceCall(e){this.silencedCalls.add(e),this.emit(J.SilencedCallsChanged,this.silencedCalls),this.areAnyCallsUnsilenced()||this.pause(z.Ring)}unSilenceCall(e){this.silencedCalls.delete(e),this.emit(J.SilencedCallsChanged,this.silencedCalls),this.play(z.Ring)}isCallSilenced(e){return this.silencedCalls.has(e)}areAnyCallsUnsilenced(){for(const e of this.calls.values())if(e.state===a.e.Ringing&&!this.isCallSilenced(e.callId))return!0;return!1}async checkProtocols(e){try{const e=await g.a.get().getThirdpartyProtocols();void 0!==e["m.protocol.pstn"]?(this.supportsPstnProtocol=Boolean(e["m.protocol.pstn"]),this.supportsPstnProtocol&&(this.pstnSupportPrefixed=!1)):void 0!==e["im.vector.protocol.pstn"]?(this.supportsPstnProtocol=Boolean(e["im.vector.protocol.pstn"]),this.supportsPstnProtocol&&(this.pstnSupportPrefixed=!0)):this.supportsPstnProtocol=null,b.a.dispatch({action:T.a.PstnSupportUpdated}),void 0!==e["im.vector.protocol.sip_native"]&&void 0!==e["im.vector.protocol.sip_virtual"]&&(this.supportsSipNativeVirtual=Boolean(e["im.vector.protocol.sip_native"]&&e["im.vector.protocol.sip_virtual"])),b.a.dispatch({action:T.a.VirtualRoomSupportUpdated})}catch(t){1===e?c.a.log("Failed to check for protocol support and no retries remain: assuming no support",t):(c.a.log("Failed to check for protocol support: will retry",t),setTimeout(()=>{this.checkProtocols(e-1)},1e4))}}shouldObeyAssertedfIdentity(){var e;return null===(e=A.b.getObject("voip"))||void 0===e?void 0:e.get("obey_asserted_identity")}getSupportsPstnProtocol(){return this.supportsPstnProtocol}getSupportsVirtualRooms(){return this.supportsSipNativeVirtual}pstnLookup(e){return g.a.get().getThirdpartyUser(this.pstnSupportPrefixed?"im.vector.protocol.pstn":"m.protocol.pstn",{"m.id.phone":e})}sipVirtualLookup(e){return g.a.get().getThirdpartyUser("im.vector.protocol.sip_virtual",{native_mxid:e})}sipNativeLookup(e){return g.a.get().getThirdpartyUser("im.vector.protocol.sip_native",{virtual_mxid:e})}getCallById(e){for(const t of this.calls.values())if(t.callId===e)return t;return null}getCallForRoom(e){return this.calls.get(e)||null}getAnyActiveCall(){for(const e of this.calls.values())if(e.state!==a.e.Ended)return e;return null}getAllActiveCalls(){const e=[];for(const t of this.calls.values())t.state!==a.e.Ended&&t.state!==a.e.Ringing&&e.push(t);return e}getAllActiveCallsNotInRoom(e){const t=[];for(const[n,i]of this.calls.entries())n!==e&&i.state!==a.e.Ended&&t.push(i);return t}getAllActiveCallsForPip(e){const t=g.a.get().getRoom(e);return P.d.instance.hasMaximisedWidget(t)?this.getAllActiveCalls():this.getAllActiveCallsNotInRoom(e)}getTransfereeForCallId(e){return this.transferees[e]}play(e){const t=document.getElementById(e);if(t){const n=async()=>{try{await t.play()}catch(e){c.a.log("Unable to play audio clip",e)}};this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then(()=>(t.load(),n()))):this.audioPromises.set(e,n())}}pause(e){const t=document.getElementById(e);t&&(this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then(()=>t.pause())):t.pause())}matchesCallForThisRoom(e){const t=this.roomIdForCall(e),n=this.getCallForRoom(t);return n&&e.callId===n.callId}setCallListeners(e){let t=this.roomIdForCall(e);e.on(a.c.Error,t=>{this.matchesCallForThisRoom(e)&&(k.a.trackEvent("voip","callError","error",t.toString()),c.a.error("Call error:",t),t.code!==a.b.NoUserMedia?0!==g.a.get().getTurnServers().length||null!==S.b.getValue("fallbackICEServerAllowed")?f.a.createTrackedDialog("Call Failed","",C.a,{title:Object(v.a)("Call Failed"),description:t.message}):this.showICEFallbackPrompt():this.showMediaCaptureError(e))}),e.on(a.c.Hangup,()=>{this.matchesCallForThisRoom(e)&&(k.a.trackEvent("voip","callHangup"),this.removeCallForRoom(t))}),e.on(a.c.State,(t,n)=>{this.onCallStateChanged(t,n,e)}),e.on(a.c.Replaced,n=>{this.matchesCallForThisRoom(e)&&(c.a.log(`Call ID ${e.callId} is being replaced by call ID ${n.callId}`),e.state===a.e.Ringing?this.pause(z.Ring):e.state===a.e.InviteSent&&this.pause(z.Ringback),this.removeCallForRoom(t),this.addCallForRoom(t,n),this.setCallListeners(n),this.setCallState(n,n.state))}),e.on(a.c.AssertedIdentityChanged,async()=>{if(!this.matchesCallForThisRoom(e))return;if(c.a.log(`Call ID ${e.callId} got new asserted identity:`,e.getRemoteAssertedIdentity()),!this.shouldObeyAssertedfIdentity())return void c.a.log("asserted identity not enabled in config: ignoring");const n=e.getRemoteAssertedIdentity().id;let i=n;if(n){const e=await this.sipNativeLookup(n);e.length&&e[0].fields.lookup_success&&(i=e[0].userid)}if(c.a.log(`Asserted identity ${n} mapped to ${i}`),i){this.assertedIdentityNativeUsers[e.callId]=i,await Object(U.c)(g.a.get(),i);const n=this.roomIdForCall(e);c.a.log(`Old room ID: ${t}, new room ID: ${n}`),n!==t&&(this.removeCallForRoom(t),t=n,c.a.log("Moving call to room "+t),this.addCallForRoom(t,e,!0))}})}async logCallStats(e,t){const n=await e.getCurrentCallStats();if(c.a.debug(`Call completed. Call ID: ${e.callId}, virtual room ID: ${e.roomId}, user-facing room ID: ${t}, direction: ${e.direction}, our Party ID: ${e.ourPartyId}, hangup party: ${e.hangupParty}, hangup reason: `+e.hangupReason),n){c.a.debug("Local candidates:");for(const e of n.filter(e=>"local-candidate"===e.type)){const t=e.address||e.ip;c.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: ${e.protocol}, relay protocol: ${e.relayProtocol}, network type: ${e.networkType}`)}c.a.debug("Remote candidates:");for(const e of n.filter(e=>"remote-candidate"===e.type)){const t=e.address||e.ip;c.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: `+e.protocol)}c.a.debug("Candidate pairs:");for(const e of n.filter(e=>"candidate-pair"===e.type))c.a.debug(`${e.localCandidateId} / ${e.remoteCandidateId} - state: ${e.state}, nominated: ${e.nominated}, requests sent ${e.requestsSent}, requests received  ${e.requestsReceived},  responses received: ${e.responsesReceived}, responses sent: ${e.responsesSent}, bytes received: ${e.bytesReceived}, bytes sent: ${e.bytesSent}, `);c.a.debug("Outbound RTP:");for(const e of n.filter(e=>"outbound-rtp"===e.type))c.a.debug(e);c.a.debug("Inbound RTP:");for(const e of n.filter(e=>"inbound-rtp"===e.type))c.a.debug(e)}else c.a.debug("Call statistics are undefined. The call has probably failed before a peerConn was established")}setCallState(e,t){const n=Y.instance.roomIdForCall(e);c.a.log(`Call state in ${n} changed to ${t}`);const i="call_"+e.callId;t===a.e.Ringing?H.a.sharedInstance().addOrReplaceToast({key:i,priority:100,component:W,bodyClassName:"mx_IncomingCallToast",props:{call:e}}):H.a.sharedInstance().dismissToast(i),this.emit(J.CallState,n,t)}removeCallForRoom(e){c.a.log("Removing call for room ",e),this.calls.delete(e),this.emit(J.CallsChanged,this.calls)}showICEFallbackPrompt(){const e=g.a.get(),t=e=>r.a.createElement("code",null,e);f.a.createTrackedDialog("No TURN servers","",_.a,{title:Object(v.a)("Call failed due to misconfigured server"),description:r.a.createElement("div",null,r.a.createElement("p",null,Object(v.a)("Please ask the administrator of your homeserver (<code>%(homeserverDomain)s</code>) to configure a TURN server in order for calls to work reliably.",{homeserverDomain:e.getDomain()},{code:t})),r.a.createElement("p",null,Object(v.a)("Alternatively, you can try to use the public server at <code>turn.matrix.org</code>, but this will not be as reliable, and it will share your IP address with that server. You can also manage this in Settings.",null,{code:t}))),button:Object(v.a)("Try using turn.matrix.org"),cancelButton:Object(v.a)("OK"),onFinished:t=>{S.b.setValue("fallbackICEServerAllowed",null,w.a.DEVICE,t),e.setFallbackICEServerAllowed(t)}},null,!0)}showMediaCaptureError(e){let t,n;e.type===a.f.Voice?(t=Object(v.a)("Unable to access microphone"),n=r.a.createElement("div",null,Object(v.a)("Call failed because microphone could not be accessed. Check that a microphone is plugged in and set up correctly."))):e.type===a.f.Video&&(t=Object(v.a)("Unable to access webcam / microphone"),n=r.a.createElement("div",null,Object(v.a)("Call failed because webcam or microphone could not be accessed. Check that:"),r.a.createElement("ul",null,r.a.createElement("li",null,Object(v.a)("A microphone and webcam are plugged in and set up correctly")),r.a.createElement("li",null,Object(v.a)("Permission is granted to use the webcam")),r.a.createElement("li",null,Object(v.a)("No other application is using the webcam"))))),f.a.createTrackedDialog("Media capture failed","",C.a,{title:t,description:n},null,!0)}async placeMatrixCall(e,t,n){k.a.trackEvent("voip","placeCall","type",t);const i=await j.a.sharedInstance().getOrCreateVirtualRoomForRoom(e)||e;if(c.a.debug("Mapped real room "+e+" to room ID "+i),i!==e){const e=g.a.get().getRoom(i);e.getPendingEvents().length>0&&q.a.cancelUnsentEvents(e)}const s=g.a.get().getTurnServersExpiry()-Date.now();c.a.log("Current turn creds expire in "+s+" ms");const o=g.a.get().createCall(i);try{this.addCallForRoom(e,o)}catch(e){return void f.a.createTrackedDialog("Call Handler","Existing Call with user",C.a,{title:Object(v.a)("Already in call"),description:Object(v.a)("You're already in a call with this person.")})}n&&(this.transferees[o.callId]=n),this.setCallListeners(o),this.setActiveCallRoomId(e),t===a.f.Voice?o.placeVoiceCall():"video"===t?o.placeVideoCall():c.a.error("Unknown conf call type: "+t)}placeCall(e,t,n){if(M())return void async function(e){const t=g.a.get().getRoom(e);if(!t)return;if(!y.a.canUserModifyWidgets(e))return void c.a.error("User not allowed to modify widgets in "+e);const n=M();if(!n)return;let i;try{const t=await fetch(`${n}?roomId=${e}`);i=await t.json()}catch(t){return void c.a.error("Managed hybrid widget builder failed for room "+e,t)}if(!i)return;const{widget_id:s,widget:o,layout:r}=i;let a=O.a.instance.getApps(e);if(a.some(e=>e.id===s)||D.a.roomHasPendingWidgets(e,[]))return void c.a.error("Managed hybrid widget already present in room "+e);try{await y.a.setRoomWidgetContent(e,s,o)}catch(t){return void c.a.error("Unable to add managed hybrid widget in room "+e,t)}if(!P.d.instance.canCopyLayoutToRoom(t))return;a=O.a.instance.getApps(e);const l=a.find(e=>e.id===s);l&&(P.d.instance.moveToContainer(t,l,r.container),P.d.instance.setContainerHeight(t,r.container,r.height),P.d.instance.copyLayoutToRoom(t))}(e);if(!g.a.get().supportsVoip())return void f.a.createTrackedDialog("Call Handler","VoIP is unsupported",C.a,{title:Object(v.a)("Calls are unsupported"),description:Object(v.a)("You cannot place calls in this browser.")});if(g.a.get().getSyncState()===m.b.Error)return void f.a.createTrackedDialog("Call Handler","Sync error",C.a,{title:Object(v.a)("Connectivity to the server has been lost"),description:Object(v.a)("You cannot place calls without a connection to the server.")});if(this.getAllActiveCalls().length>1)return void f.a.createTrackedDialog("Call Handler","Existing Call",C.a,{title:Object(v.a)("Too Many Calls"),description:Object(v.a)("You've reached the maximum number of simultaneous calls.")});const i=g.a.get().getRoom(e);if(!i)return void c.a.error(`Room ${e} does not exist.`);const s=i.getJoinedMembers();s.length<=1?f.a.createTrackedDialog("Call Handler","Cannot place call with self",C.a,{description:Object(v.a)("You cannot place a call with yourself.")}):2===s.length?(c.a.info(`Place ${t} call in ${e}`),this.placeMatrixCall(e,t,n)):this.placeJitsiCall(e,t)}hangupAllCalls(){for(const e of this.calls.values())this.stopRingingIfPossible(e.callId),e.hangup(a.b.UserHangup,!1)}hangupOrReject(e,t){const n=this.calls.get(e);n&&(this.stopRingingIfPossible(n.callId),t?n.reject():n.hangup(a.b.UserHangup,!1))}answerCall(e){const t=this.calls.get(e);this.stopRingingIfPossible(t.callId),this.calls.has(e)&&(this.getAllActiveCalls().length>1?f.a.createTrackedDialog("Call Handler","Existing Call",C.a,{title:Object(v.a)("Too Many Calls"),description:Object(v.a)("You've reached the maximum number of simultaneous calls.")}):(t.answer(),this.setActiveCallRoomId(e),b.a.dispatch({action:T.a.ViewRoom,room_id:e,metricsTrigger:"WebAcceptCall"})))}stopRingingIfPossible(e){this.silencedCalls.delete(e),this.areAnyCallsUnsilenced()||this.pause(z.Ring)}async dialNumber(e,t){const n=await this.pstnLookup(e);if(!n||0===n.length||!n[0].userid)return void f.a.createTrackedDialog("","",C.a,{title:Object(v.a)("Unable to look up phone number"),description:Object(v.a)("There was an error looking up the phone number")});const i=n[0].userid;let s;if(this.getSupportsVirtualRooms()){const t=await this.sipNativeLookup(i);s=t.length>0&&t[0].fields.lookup_success?t[0].userid:i,c.a.log("Looked up "+e+" to "+i+" and mapped to native user "+s)}else s=i;const o=await Object(U.c)(g.a.get(),s);b.a.dispatch({action:T.a.ViewRoom,room_id:o,metricsTrigger:"WebDialPad"}),await this.placeMatrixCall(o,a.f.Voice,t)}async startTransferToPhoneNumber(e,t,n){if(n)return void this.dialNumber(t,e);const i=await this.pstnLookup(t);i&&0!==i.length&&i[0].userid?await this.startTransferToMatrixID(e,i[0].userid,n):f.a.createTrackedDialog("","",C.a,{title:Object(v.a)("Unable to transfer call"),description:Object(v.a)("There was an error looking up the phone number")})}async startTransferToMatrixID(e,t,n){if(n){const n=await Object(U.c)(g.a.get(),t);this.placeCall(n,e.type,e),b.a.dispatch({action:T.a.ViewRoom,room_id:n,should_peek:!1,joining:!1,metricsTrigger:void 0})}else try{await e.transfer(t)}catch(e){c.a.log("Failed to transfer call",e),f.a.createTrackedDialog("Failed to transfer call","",C.a,{title:Object(v.a)("Transfer Failed"),description:Object(v.a)("Failed to transfer call")})}}setActiveCallRoomId(e){c.a.info("Setting call in room "+e+" active");for(const[t,n]of this.calls.entries())n.state!==a.e.Ended&&(t===e?n.setRemoteOnHold(!1):(c.a.info("Holding call in room "+t+" because another call is being set active"),n.setRemoteOnHold(!0)))}hasAnyUnheldCall(){for(const e of this.calls.values())if(e.state!==a.e.Ended&&!e.isRemoteOnHold())return!0;return!1}async placeJitsiCall(e,t){const n=g.a.get();c.a.info("Place conference call in "+e),k.a.trackEvent("voip","placeConferenceCall"),b.a.dispatch({action:"appsDrawer",show:!0});const i=O.a.instance.getApps(e).find(e=>E.a.JITSI.matches(e.type));if(i)P.d.instance.moveToContainer(n.getRoom(e),i,P.a.Top);else try{const i=n.credentials.userId;await y.a.addJitsiWidget(e,t,"Jitsi",`jitsi_${i}_${Date.now()}`),c.a.log("Jitsi widget added")}catch(e){"M_FORBIDDEN"===e.errcode&&f.a.createTrackedDialog("Call Failed","",C.a,{title:Object(v.a)("Permission Required"),description:Object(v.a)("You do not have permission to start a conference call in this room")}),c.a.error(e)}}terminateCallApp(e){c.a.info("Terminating conference call in "+e),f.a.createTrackedDialog("Confirm Jitsi Terminate","",_.a,{hasCancelButton:!0,title:Object(v.a)("End conference"),description:Object(v.a)("This will end the conference for everyone. Continue?"),button:Object(v.a)("End conference"),onFinished:t=>{if(!t)return;O.a.instance.getRoom(e).widgets.filter(e=>E.a.JITSI.matches(e.type)).forEach(t=>{y.a.setRoomWidget(e,t.id)})}})}hangupCallApp(e){c.a.info("Leaving conference call in "+e);const t=O.a.instance.getRoom(e);if(!t)return;t.widgets.filter(e=>E.a.JITSI.matches(e.type)).forEach(e=>{const t=R.a.instance.getMessagingForUid(y.a.getWidgetUid(e));t&&t.transport.send(I.a.HangupCall,{})})}showTransferDialog(e){e.setRemoteOnHold(!0),b.a.dispatch({action:T.a.OpenInviteDialog,kind:G.a,call:e,analyticsName:"Transfer Call",className:"mx_InviteDialog_transferWrapper",onFinishedCallback:t=>{0!==t.length&&!1!==t[0]||e.setRemoteOnHold(!1)}})}addCallForRoom(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.calls.has(e))throw c.a.log(`Couldn't add call to room ${e}: already have a call for this room`),new Error("Already have a call for room "+e);c.a.log("setting call for room "+e),this.calls.set(e,t),n?this.emit(J.CallChangeRoom,t):this.emit(J.CallsChanged,this.calls)}}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.IRC="irc",e.Group="group",e.Bubble="bubble"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return P})),n.d(t,"i",(function(){return M})),n.d(t,"h",(function(){return U})),n.d(t,"d",(function(){return L})),n.d(t,"e",(function(){return F})),n.d(t,"b",(function(){return G})),n.d(t,"g",(function(){return J})),n.d(t,"f",(function(){return Y})),n.d(t,"c",(function(){return Q}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(474),c=n.n(a),l=n(645),d=n.n(l),u=n(94),h=n.n(u),m=n(486),p=n.n(m),g=n(111),f=n(1014),v=n.n(f),b=n(472),y=n(358),S=n(93),E=n(132),w=n(331),_=n(128),C=n(219);function O(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function R(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?O(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):O(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const I=/([\ud800-\udbff])([\udc00-\udfff])/,k=/([\u2100-\u2bff])/,x=/[\u200D\u2003]/g,T=/\s/g,j=new RegExp(`^(${p.a.source})+$`,"i"),N=/^#[0-9a-fA-F]{6}$/,P=["bitcoin","ftp","geo","http","https","im","irc","ircs","magnet","mailto","matrix","mms","news","nntp","openpgp4fpr","sip","sftp","sms","smsto","ssh","tel","urn","webcal","wtai","xmpp"],D=/\/_matrix\/media\/r0\/(?:download|thumbnail)\/(.+?)\/(.+?)(?:[?/]|$)/;function A(e){return I.test(e)||k.test(e)}function M(e){var t;const n=null===(t=Object(w.d)(e))||void 0===t?void 0:t.shortcodes;return null!=n&&n.length?`:${n[0]}:`:""}function U(e){const t=c()(e,K);return r.a.createElement("div",{dangerouslySetInnerHTML:{__html:t},dir:"auto"})}function L(e){return c()(e,{allowedTags:[],allowedAttributes:{},selfClosing:[],allowedSchemes:[],disallowedTagsMode:"discard"})}function F(e){try{return P.includes(new URL(e).protocol.slice(0,-1))}catch(e){return!1}}const B={a:function(e,t){if(t.href){t.target="_blank";(Object(E.j)(t.href)!==t.href||t.href.match(y.a))&&delete t.target}else delete t.href;return t.rel="noreferrer noopener",{tagName:e,attribs:t}},img:function(e,t){let n=t.src;if(!n||!S.b.getValue("showImages"))return{tagName:e,attribs:{}};if(!n.startsWith("mxc://")){const e=D.exec(n);e&&(n=`mxc://${e[1]}/${e[2]}`)}if(!n.startsWith("mxc://"))return{tagName:e,attribs:{}};const i=Number(t.width),s=Number(t.height),o=Math.min(i||800,800),r=Math.min(s||600,600);return t.style=`max-width: ${o}px; max-height: ${r}px;`,i&&(t.style+="width: 100%;"),s&&(t.style+="height: 100%;"),t.src=Object(_.b)(n).getThumbnailOfSourceHttp(o,r),{tagName:e,attribs:t}},code:function(e,t){if(void 0!==t.class){const e=t.class.split(/\s/).filter((function(e){return e.startsWith("language-")&&!e.startsWith("language-_")}));t.class=e.join(" ")}return{tagName:e,attribs:t}},"*":function(e,t){"img"!==e&&delete t.style;const n={"data-mx-color":"color","data-mx-bg-color":"background-color"};let i="";return Object.keys(n).forEach(e=>{const s=n[e],o=t[e];o&&"string"==typeof o&&N.test(o)&&(i+=s+":"+o+";",delete t[e])}),i&&(t.style=i+(t.style||"")),{tagName:e,attribs:t}}},K={allowedTags:["font","del","h1","h2","h3","h4","h5","h6","blockquote","p","a","ul","ol","sup","sub","nl","li","b","i","u","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","span","img","details","summary"],allowedAttributes:{font:["color","data-mx-bg-color","data-mx-color","style"],span:["data-mx-maths","data-mx-bg-color","data-mx-color","data-mx-spoiler","style"],div:["data-mx-maths"],a:["href","name","target","rel"],img:["src","alt","title","style"],ol:["start"],code:["class"]},selfClosing:["img","br","hr","area","base","basefont","input","link","meta"],allowedSchemes:P,allowProtocolRelative:!1,transformTags:B,nestingLimit:50},V=R(R({},K),{},{transformTags:{code:B.code,"*":B["*"]}});class W extends class{constructor(e,t){this.highlightClass=e,this.highlightLink=t}applyHighlights(e,t){let n,i=0,s=[];const o=t[0];for(;(n=e.toLowerCase().indexOf(o.toLowerCase(),i))>=0;){if(n>i){const o=e.substring(i,n);s=s.concat(this.applySubHighlights(o,t))}const r=n+o.length;s.push(this.processSnippet(e.substring(n,r),!0)),i=r}if(i!==e.length){const n=e.substring(i,void 0);s=s.concat(this.applySubHighlights(n,t))}return s}applySubHighlights(e,t){return t[1]?this.applyHighlights(e,t.slice(1)):[this.processSnippet(e,!1)]}}{processSnippet(e,t){if(!t)return e;let n=`<span class="${this.highlightClass}">${e}</span>`;return this.highlightLink&&(n=`<a href="${encodeURI(this.highlightLink)}">${n}</a>`),n}}const H=e=>`<span class='mx_Emoji' title='${M(e)}'>${e}</span>`,q=(e,t)=>r.a.createElement("span",{key:t,className:"mx_Emoji",title:M(e)},e);function $(e,t){const n=t?H:q,i=[];let s="",o=0;for(const t of Object(g.split)(e,""))p.a.test(t)?(s&&(i.push(s),s=""),i.push(n(t,o)),o++):s+=t;return s&&i.push(s),i}function G(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i="org.matrix.custom.html"===e.format&&e.formatted_body;let s,o,a,l=!1,u=!1,m=K;n.forComposerQuote&&(m=V);try{if(t&&t.length>0){const e=new W("mx_EventTile_searchHighlight",n.highlightLink),i=t.filter(e=>!e.includes("<")).map(e=>c()(e,m));m.textFilter=function(t){return e.applyHighlights(t,i).join("")}}let r="string"==typeof e.formatted_body?e.formatted_body:null;const h="string"==typeof e.body?e.body:"";if(n.stripReplyFallback&&r&&(r=Object(C.d)(r)),s=n.stripReplyFallback?Object(C.e)(h):h,l=A(i?r:h),i){a=!0,o=c()(r,m);const e=d.a.load(o,{_useHtmlParser2:!0,decodeEntities:!1}),t=e.html()===e.root().text();u=i&&!t,u&&S.b.getValue("feature_latex_maths")&&(e('div, span[data-mx-maths!=""]').replaceWith((function(t,n){return v.a.renderToString(b.AllHtmlEntities.decode(e(n).attr("data-mx-maths")),{throwOnError:!1,displayMode:"div"==n.name,output:"htmlAndMathml"})})),o=e.html()),l&&(o=$(o,!0).join(""))}}finally{delete m.textFilter}const p=a?o:s;if(n.returnString)return p;let g=!1;if(!n.disableBigEmoji&&l){let t=void 0!==p?p.trim():"";t=t.replace(T,""),t=t.replace(x,"");const n=j.exec(t);g=n&&n[0]&&n[0].length===t.length&&(s===o||void 0===e.formatted_body||!e.formatted_body.includes("http:")&&!e.formatted_body.includes("https:"))}const f=h()({mx_EventTile_body:!0,mx_EventTile_bigEmoji:g,"markdown-body":u&&!g});let y;return!a&&l&&(y=$(s,!1)),a?r.a.createElement("span",{key:"body",ref:n.ref,className:f,dangerouslySetInnerHTML:{__html:o},dir:"auto"}):r.a.createElement("span",{key:"body",ref:n.ref,className:f,dir:"auto"},y||s)}function z(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y.e;return Object(y.c)(e,t)}function J(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y.e;return Object(y.b)(e,t)}function Y(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y.e;return c()(z(e,t),K)}function Q(e){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"PRE":case"BLOCKQUOTE":case"P":case"UL":case"OL":case"LI":case"HR":case"TABLE":case"THEAD":case"TBODY":case"TR":case"TH":case"TD":return!0;case"DIV":return!e.hasAttribute("data-mx-maths");default:return!1}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(8),r=n.n(o);class a extends r.a{constructor(){super(...arguments),s()(this,"toasts",[]),s()(this,"countSeen",0)}static sharedInstance(){return window.mxToastStore||(window.mxToastStore=new a),window.mxToastStore}reset(){this.toasts=[],this.countSeen=0}addOrReplaceToast(e){const t=this.toasts.findIndex(t=>t.key===e.key);if(-1===t){let t=this.toasts.length;for(;t>0&&this.toasts[t-1].priority<e.priority;)--t;this.toasts.splice(t,0,e)}else this.toasts[t]=e;this.emit("update")}dismissToast(e){this.toasts[0]&&this.toasts[0].key===e&&this.countSeen++;const t=this.toasts.length;this.toasts=this.toasts.filter(t=>t.key!==e),t!==this.toasts.length&&(0===this.toasts.length&&(this.countSeen=0),this.emit("update"))}getToasts(){return this.toasts}getCountSeen(){return this.countSeen}}},function(e,t,n){"use strict";n.r(t),function(e,i){n.d(t,"OLM_ALGORITHM",(function(){return c})),n.d(t,"MEGOLM_ALGORITHM",(function(){return l})),n.d(t,"MEGOLM_BACKUP_ALGORITHM",(function(){return d})),n.d(t,"encryptMessageForDevice",(function(){return u})),n.d(t,"getExistingOlmSessions",(function(){return h})),n.d(t,"ensureOlmSessionsForDevices",(function(){return m})),n.d(t,"verifySignature",(function(){return g})),n.d(t,"pkSign",(function(){return f})),n.d(t,"pkVerify",(function(){return v})),n.d(t,"encodeBase64",(function(){return b})),n.d(t,"encodeUnpaddedBase64",(function(){return y})),n.d(t,"decodeBase64",(function(){return S}));var s,o=n(365),r=n.n(o),a=n(0);!function(e){e.Olm="m.olm.v1.curve25519-aes-sha2",e.Megolm="m.megolm.v1.aes-sha2",e.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2"}(s||(s={}));const c=s.Olm,l=s.Megolm,d=s.MegolmBackup;async function u(e,t,n,i,s,o,r){const c=o.getIdentityKey(),l=await i.getSessionIdForDevice(c);if(null===l)return;a.a.log("Using sessionid "+l+" for device "+s+":"+o.deviceId);const d={sender:t,sender_device:n,keys:{ed25519:i.deviceEd25519Key},recipient:s,recipient_keys:{ed25519:o.getFingerprint()}};Object.assign(d,r),e[c]=await i.encryptMessage(c,l,JSON.stringify(d))}async function h(e,t,n){const i={},s={},o=[];for(const[t,r]of Object.entries(n))for(const n of r){const r=n.deviceId,a=n.getIdentityKey();o.push((async()=>{const o=await e.getSessionIdForDevice(a,!0);null===o?(i[t]=i[t]||[],i[t].push(n)):(s[t]=s[t]||{},s[t][r]={device:n,sessionId:o})})())}return await Promise.all(o),[i,s]}async function m(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:a.a;"number"==typeof i&&(r=o,o=s,s=i,i=!1);const c=[],l={},d={};for(const[,t]of Object.entries(n))for(const n of t){const t=n.getIdentityKey();t!==e.deviceCurve25519Key&&(e.sessionsInProgress[t]||(e.sessionsInProgress[t]=new Promise(n=>{d[t]=i=>{delete e.sessionsInProgress[t],n(i)}})))}for(const[t,s]of Object.entries(n)){l[t]={};for(const n of s){const s=n.deviceId,o=n.getIdentityKey();if(o===e.deviceCurve25519Key){r.info("Attempted to start session with ourself! Ignoring"),l[t][s]={device:n,sessionId:null};continue}const a=`for ${o} (${t}:${s})`,u=await e.getSessionIdForDevice(o,!!d[o],r);null!==u&&d[o]&&d[o](),(null===u||i)&&(i?r.info("Forcing new Olm session "+a):r.info("Making new Olm session "+a),c.push([t,s])),l[t][s]={device:n,sessionId:u}}}if(0===c.length)return l;const u="signed_curve25519";let h,m=`one-time keys for ${c.length} devices`;try{r.debug("Claiming "+m),h=await t.claimOneTimeKeys(c,u,s),r.debug("Claimed "+m)}catch(e){for(const e of Object.values(d))e();throw r.log("Failed to claim "+m,e,c),e}o&&"failures"in h&&o.push(...Object.keys(h.failures));const g=h.one_time_keys||{},f=[];for(const[t,s]of Object.entries(n)){const n=g[t]||{};for(let o=0;o<s.length;o++){const a=s[o],c=a.deviceId,h=a.getIdentityKey();if(h===e.deviceCurve25519Key)continue;if(l[t][c].sessionId&&!i)continue;const m=n[c]||{};let g=null;for(const e in m)0===e.indexOf(u+":")&&(g=m[e]);g?f.push(p(e,g,t,a).then(e=>{d[h]&&d[h](e),l[t][c].sessionId=e},e=>{throw d[h]&&d[h](),e})):(r.warn(`No one-time keys (alg=${u}) for device ${t}:${c}`),d[h]&&d[h]())}}return m=`Olm sessions for ${f.length} devices`,r.debug("Starting "+m),await Promise.all(f),r.debug("Started "+m),l}async function p(e,t,n,i){const s=i.deviceId;try{await g(e,t,n,s,i.getFingerprint())}catch(e){return a.a.error("Unable to verify signature on one-time key for device "+n+":"+s+":",e),null}let o;try{o=await e.createOutboundSession(i.getIdentityKey(),t.key)}catch(e){return a.a.error("Error starting olm session with device "+n+":"+s+": "+e),null}return a.a.log("Started new olm sessionid "+o+" for device "+n+":"+s),o}async function g(e,t,n,i,s){const o="ed25519:"+i,a=((t.signatures||{})[n]||{})[o];if(!a)throw Error("No signature");const c=Object.assign({},t);"unsigned"in c&&delete c.unsigned,delete c.signatures;const l=r.a.stringify(c);e.verifySignature(s,l,a)}function f(t,n,i,s){let o=!1;if(n instanceof Uint8Array){const t=new e.Olm.PkSigning;s=t.init_with_seed(n),n=t,o=!0}const a=t.signatures||{};delete t.signatures;const c=t.unsigned;t.unsigned&&delete t.unsigned;try{const e=a[i]||{};return a[i]=e,e["ed25519:"+s]=n.sign(r.a.stringify(t))}finally{t.signatures=a,c&&(t.unsigned=c),o&&n.free()}}function v(t,n,i){const s="ed25519:"+n;if(!(t.signatures&&t.signatures[i]&&t.signatures[i][s]))throw new Error("No signature");const o=t.signatures[i][s],a=new e.Olm.Utility,c=t.signatures;delete t.signatures;const l=t.unsigned;t.unsigned&&delete t.unsigned;try{a.ed25519_verify(n,r.a.stringify(t),o)}finally{t.signatures=c,l&&(t.unsigned=l),a.free()}}function b(e){return i.from(e).toString("base64")}function y(e){return b(e).replace(/=+$/g,"")}function S(e){return i.from(e,"base64")}}.call(this,n(30),n(31).Buffer)},function(e,t,n){"use strict";var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(0),c=n(186),l=n(89),d=n(126),u=n(98),h=n(95),m=n(107),p=n(9);function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const v=/#\/(groups?|room|user|settings|register|login|forgot_password|home|directory)/,b=/#\/(group|room|user)\/.*$/;function y(){const{origin:e,hash:t}=window.location;let{pathname:n}=window.location;return e.startsWith("file://")&&(n="/<redacted>/"),e+n+function(e){return v.exec(e)?b.test(e)?e.replace(b,"#/$1/<redacted>"):e.replace(v,"#/$1"):(a.a.warn(`Unexpected hash location "${e}"`),"#/<unexpected hash location>")}(t)}const S={"App Platform":{id:1,expl:Object(l.c)("The platform you're on"),example:"Electron Platform"},"App Version":{id:2,expl:Object(l.c)("The version of %(brand)s"),getTextVariables:()=>({brand:u.b.get().brand}),example:"15.0.0"},"User Type":{id:3,expl:Object(l.c)("Whether or not you're logged in (we don't record your username)"),example:"Logged In"},"Chosen Language":{id:4,expl:Object(l.c)("Your language of choice"),example:"en"},Instance:{id:5,expl:Object(l.c)("Which officially provided instance you are using, if any"),example:"app"},"RTE: Uses Richtext Mode":{id:6,expl:Object(l.c)("Whether or not you're using the Richtext mode of the Rich Text Editor"),example:"off"},"Homeserver URL":{id:7,expl:Object(l.c)("Your homeserver's URL"),example:"https://matrix.org"},"Touch Input":{id:8,expl:Object(l.c)("Whether you're using %(brand)s on a device where touch is the primary input mechanism"),getTextVariables:()=>({brand:u.b.get().brand}),example:"false"},Breadcrumbs:{id:9,expl:Object(l.c)("Whether or not you're using the 'breadcrumbs' feature (avatars above the room list)"),example:"disabled"},"Installed PWA":{id:10,expl:Object(l.c)("Whether you're using %(brand)s as an installed Progressive Web App"),getTextVariables:()=>({brand:u.b.get().brand}),example:"false"}};const E="mx_Riot_Analytics_uid";class w{constructor(){s()(this,"baseUrl",null),s()(this,"visitVariables",{}),s()(this,"firstPage",!0),s()(this,"heartbeatIntervalID",null),s()(this,"creationTs",void 0),s()(this,"lastVisitTs",void 0),s()(this,"visitCount",void 0),s()(this,"showDetailsModal",()=>{var e;let t=[];t=this.disabled?Object.keys(S).map(e=>[e,Object(l.a)("e.g. %(exampleValue)s",{exampleValue:S[e].example})]):Object.values(this.visitVariables);const n=`${window.screen.width}x${window.screen.height}`,i=[{expl:Object(l.c)("Every page you use in the app"),value:Object(l.a)("e.g. <CurrentPageURL>",{},{CurrentPageURL:y})},{expl:Object(l.c)("Your user agent"),value:navigator.userAgent},{expl:Object(l.c)("Your device resolution"),value:n}],s=u.b.get("piwik");let o;"object"==typeof s&&(o=new p.a(s));const a=null===(e=o)||void 0===e?void 0:e.get("policy_url"),c=Object(l.a)("Our complete cookie policy can be found <CookiePolicyLink>here</CookiePolicyLink>.",{},{CookiePolicyLink:e=>r.a.createElement("a",{href:a,target:"_blank",rel:"noreferrer noopener"},e)});h.a.createTrackedDialog("Analytics Details","",m.a,{title:Object(l.a)("Analytics"),description:r.a.createElement("div",{className:"mx_AnalyticsModal"},a&&r.a.createElement("p",null,c),r.a.createElement("div",null,Object(l.a)("Some examples of the information being sent to us to help make %(brand)s better includes:",{brand:u.b.get().brand})),r.a.createElement("table",null,t.map(e=>r.a.createElement("tr",{key:e[0]},r.a.createElement("td",{className:"mx_AnalyticsModal_label"},Object(l.a)(S[e[0]].expl,S[e[0]].getTextVariables?S[e[0]].getTextVariables():null)),void 0!==e[1]&&r.a.createElement("td",null,r.a.createElement("code",null,e[1])))),i.map((e,t)=>r.a.createElement("tr",{key:t},r.a.createElement("td",null,Object(l.a)(e.expl)),r.a.createElement("td",null,r.a.createElement("code",null,e.value))))),r.a.createElement("div",null,Object(l.a)("Where this page includes identifiable information, such as a room, user ID, that data is removed before being sent to the server.")))})}),this.creationTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_cts"),!this.creationTs&&localStorage&&localStorage.setItem("mx_Riot_Analytics_cts",this.creationTs=String((new Date).getTime())),this.lastVisitTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_lvts"),this.visitCount=localStorage&&localStorage.getItem("mx_Riot_Analytics_vc")||"0",this.visitCount=String(parseInt(this.visitCount,10)+1),localStorage&&localStorage.setItem("mx_Riot_Analytics_vc",this.visitCount)}get disabled(){return!this.baseUrl}canEnable(){var e;const t=u.b.get("piwik");let n;return"object"==typeof t&&(n=new p.a(t)),"1"!==navigator.doNotTrack&&(null===(e=n)||void 0===e?void 0:e.get("site_id"))}async enable(){if(!this.disabled)return;if(!this.canEnable())return;const e=u.b.get("piwik");let t;"object"==typeof e&&(t=new p.a(e)),this.baseUrl=new URL("piwik.php",t.get("url")),this.baseUrl.searchParams.set("rec","1"),this.baseUrl.searchParams.set("idsite",t.get("site_id")),this.baseUrl.searchParams.set("apiv","1"),this.baseUrl.searchParams.set("send_image","0"),this.baseUrl.searchParams.set("_id",function(){try{var e;let t=null===(e=localStorage)||void 0===e?void 0:e.getItem(E);return!t&&localStorage&&localStorage.setItem(E,t=Object(c.b)(16)),t}catch(e){return a.a.error("Analytics error: ",e),""}}()),this.baseUrl.searchParams.set("_idts",this.creationTs),this.baseUrl.searchParams.set("_idvc",this.visitCount),this.lastVisitTs&&this.baseUrl.searchParams.set("_viewts",this.lastVisitTs);const n=d.a.get();this.setVisitVariable("App Platform",n.getHumanReadableName());try{this.setVisitVariable("App Version",await n.getAppVersion())}catch(e){this.setVisitVariable("App Version","unknown")}this.setVisitVariable("Chosen Language",Object(l.e)());const i=window.location.hostname;"riot.im"===i?this.setVisitVariable("Instance",window.location.pathname):i.endsWith(".element.io")&&this.setVisitVariable("Instance",i.replace(".element.io",""));let s="unknown";try{s=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}this.setVisitVariable("Installed PWA",s);let o="unknown";try{o=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}this.setVisitVariable("Touch Input",o),this.heartbeatIntervalID=window.setInterval(this.ping.bind(this),3e4)}disable(){this.disabled||(this.trackEvent("Analytics","opt-out"),window.clearInterval(this.heartbeatIntervalID),this.baseUrl=null,this.visitVariables={},localStorage.removeItem(E),localStorage.removeItem("mx_Riot_Analytics_cts"),localStorage.removeItem("mx_Riot_Analytics_vc"),localStorage.removeItem("mx_Riot_Analytics_lvts"))}async track(e){if(this.disabled)return;const t=new Date,n=f(f({},e),{},{url:y(),_cvar:JSON.stringify(this.visitVariables),res:`${window.screen.width}x${window.screen.height}`,rand:String(Math.random()).slice(2,8),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds()}),i=new URL(this.baseUrl.toString());for(const e in n)i.searchParams.set(e,n[e]);try{await window.fetch(i.toString(),{method:"GET",mode:"no-cors",cache:"no-cache",redirect:"follow"})}catch(e){a.a.error("Analytics error: ",e)}}ping(){this.track({ping:"1"}),localStorage.setItem("mx_Riot_Analytics_lvts",String((new Date).getTime()))}trackPageChange(e){this.disabled||(this.firstPage?this.firstPage=!1:("number"!=typeof e&&a.a.warn("Analytics.trackPageChange: expected generationTimeMs to be a number"),this.track({gt_ms:String(e)})))}trackEvent(e,t,n,i){this.disabled||this.track({e_c:e,e_a:t,e_n:n,e_v:i})}setVisitVariable(e,t){this.disabled||(this.visitVariables[S[e].id]=[e,t])}setLoggedIn(e,t){if(this.disabled)return;const n=u.b.get("piwik");let i;if("object"==typeof n&&(i=new p.a(n)),!i)return;const s=i.get("whitelisted_hs_urls","whitelistedHSUrls")||[];var o;this.setVisitVariable("User Type",e?"Guest":"Logged In"),this.setVisitVariable("Homeserver URL",(o=t,s.includes(o)?o:"<redacted>"))}setBreadcrumbs(e){this.disabled||this.setVisitVariable("Breadcrumbs",e?"enabled":"disabled")}}window.mxAnalytics||(window.mxAnalytics=new w),t.a=window.mxAnalytics},,function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"f",(function(){return o})),n.d(t,"e",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"d",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n(121);function s(e,t){const n=new Map(Object.entries(e));for(const e of t)n.delete(e);return Array.from(n.entries()).reduce((e,t)=>{let[n,i]=t;return e[n]=i,e},{})}function o(e,t){const n=Object.keys(e),o=Object(i.a)(n,t);return 0===o.removed.length?r(e):s(e,o.removed)}function r(e,t){const n={};for(const[i,s]of Object.entries(e))n[i]=s,t&&(n[i]=t(i,s));return n}function a(e,t){if(e===t)return!1;const n=Object.keys(e),s=Object.keys(t);if(n.length!==s.length)return!0;const o=Object(i.f)(n,s);return o.length!==n.length||o.some(n=>e[n]!==t[n])}function c(e,t){const n=function(e,t){const n=Object.keys(e),s=Object.keys(t),o=Object(i.a)(n,s);return{changed:Object(i.f)(n,s).filter(n=>e[n]!==t[n]),added:o.added,removed:o.removed}}(e,t);return Object(i.k)(n.removed,n.added,n.changed)}function l(e){return JSON.parse(JSON.stringify(e))}},,function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return o})),function(e){e.Invite="im.vector.fake.invite",e.Untagged="im.vector.fake.recent",e.Archived="im.vector.fake.archived",e.LowPriority="m.lowpriority",e.Favourite="m.favourite",e.DM="im.vector.fake.direct",e.ServerNotice="m.server_notice",e.Suggested="im.vector.fake.suggested"}(i||(i={}));const s=[i.Invite,i.Favourite,i.DM,i.Untagged,i.LowPriority,i.ServerNotice,i.Suggested,i.Archived];let o;!function(e){e.Timeline="TIMELINE",e.PossibleTagChange="POSSIBLE_TAG_CHANGE",e.ReadReceipt="READ_RECEIPT",e.NewRoom="NEW_ROOM",e.RoomRemoved="ROOM_REMOVED"}(o||(o={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(123),r=n(458);class a extends o.a{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}),s()(this,"readyStore",void 0);const t=this;this.readyStore=new class extends r.a{get mxClient(){return this.matrixClient}async onReady(){return t.onReady()}async onNotReady(){return t.onNotReady()}}(e)}get matrixClient(){return this.readyStore.mxClient}async onReady(){}async onNotReady(){}async onDispatch(e){await this.onAction(e)}}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e[e.None=0]="None",e[e.Bold=1]="Bold",e[e.Grey=2]="Grey",e[e.Red=3]="Red",e[e.Unsent=4]="Unsent"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(87),s=n.n(i),o=n(94),r=n.n(o);function a(e){let{description:t,hideDescriptionIfValid:n,deriveData:i,rules:o}=e;return async function(e){let{value:a,focused:c,allowEmpty:l=!0}=e;if(!a&&l)return{valid:null,feedback:null};const d={value:a,allowEmpty:l},u=i?await i.call(this,d):void 0,h=[];let m,p,g,f=!0;if(o&&o.length)for(const e of o){var v;if(!e.key||!e.test)continue;if(!f&&e.final)continue;if(null!==(v=e.skip)&&void 0!==v&&v.call(this,d,u))continue;const t=await e.test.call(this,d,u);if(f=f&&t,t&&e.valid){const t=e.valid.call(this,u);if(!t)continue;h.push({key:e.key,valid:!0,text:t})}else if(!t&&e.invalid){const t=e.invalid.call(this,u);if(!t)continue;h.push({key:e.key,valid:!1,text:t})}}if(!c)return{valid:f,feedback:null};if(h&&h.length&&(m=s.a.createElement("ul",{className:"mx_Validation_details"},h.map(e=>{const t=r()({mx_Validation_detail:!0,mx_Validation_valid:e.valid,mx_Validation_invalid:!e.valid});return s.a.createElement("li",{key:e.key,className:t},e.text)}))),t&&(m||!n)){const e=t.call(this,u,h);p=e?s.a.createElement("div",{className:"mx_Validation_description"},e):void 0}return(p||m)&&(g=s.a.createElement("div",{className:"mx_Validation"},p,m)),{valid:f,feedback:g}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(89);class c extends r.a.PureComponent{render(){return r.a.createElement("div",{className:"mx_InlineSpinner"},r.a.createElement("div",{className:"mx_InlineSpinner_icon mx_Spinner_icon",style:{width:this.props.w,height:this.props.h},"aria-label":Object(a.a)("Loading...")},this.props.children))}}s()(c,"defaultProps",{w:16,h:16})},function(e,t,n){"use strict";n.d(t,"f",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"d",(function(){return r})),n.d(t,"b",(function(){return a})),n.d(t,"e",(function(){return c})),n.d(t,"a",(function(){return l})),n.d(t,"g",(function(){return d})),n.d(t,"h",(function(){return u}));var i=n(89);const s=Symbol("top-level-spaces"),o=Symbol("invited-spaces"),r=Symbol("selected-space"),a=Symbol("home-behaviour"),c=Symbol("suggested-rooms");let l;!function(e){e.Home="home-space",e.Favourites="favourites-space",e.People="people-space",e.Orphans="orphans-space"}(l||(l={}));const d=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];switch(e){case l.Home:return t?Object(i.a)("All rooms"):Object(i.a)("Home");case l.Favourites:return Object(i.a)("Favourites");case l.People:return Object(i.a)("People");case l.Orphans:return Object(i.a)("Other rooms")}};function u(e){return e===l.Home||e===l.Favourites||e===l.People||e===l.Orphans}},function(e,t,n){"use strict";n.d(t,"b",(function(){return k})),n.d(t,"a",(function(){return x}));var i=n(88),s=n.n(i),o=n(119),r=n(167),a=n(92),c=n(166),l=n(168),d=n(121),u=n(190);class h extends u.a{constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0;super(),this.byTileCount=e,this.getRoomFn=t,s()(this,"rooms",[]),s()(this,"states",{}),s()(this,"onRoomNotificationStateUpdate",()=>{this.calculateTotalState()})}get symbol(){return this._color===l.a.Unsent?"!":null}setRooms(e){if(this.byTileCount)return this.rooms=e,void this.calculateTotalState();const t=this.rooms,n=Object(d.a)(t,e);this.rooms=e;for(const e of n.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(u.b.Update,this.onRoomNotificationStateUpdate))}for(const e of n.added){const t=this.getRoomFn(e);t.on(u.b.Update,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}getForRoom(e){const t=this.states[e.roomId];if(!t)throw new Error("Unknown room for notification state");return t}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(u.b.Update,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();if(this.byTileCount)this._color=l.a.Red,this._count=this.rooms.length;else{this._count=0,this._color=l.a.None;for(const e of Object.values(this.states))this._count+=e.count,this._color=Math.max(this.color,e.color)}this.emitIfUpdated(e)}}var m=n(108),p=n(113),g=n(90),f=n(217),v=n(634),b=n(326),y=n(641),S=n(788);class E extends u.a{constructor(e,t){super(),this.room=e,this.threadsState=t,s()(this,"handleThreadsUpdate",()=>{this.updateNotificationState()}),s()(this,"handleLocalEchoUpdated",()=>{this.updateNotificationState()}),s()(this,"handleReadReceipt",(e,t)=>{Object(v.a)(e,g.a.get())&&t.roomId===this.room.roomId&&this.updateNotificationState()}),s()(this,"handleMembershipUpdate",()=>{this.updateNotificationState()}),s()(this,"onEventDecrypted",e=>{e.getRoomId()===this.room.roomId&&this.updateNotificationState()}),s()(this,"handleRoomEventUpdate",(e,t)=>{(null==t?void 0:t.roomId)===this.room.roomId&&this.updateNotificationState()}),s()(this,"handleAccountDataUpdate",e=>{"m.push_rules"===e.getType()&&this.updateNotificationState()}),this.room.on(p.c.Receipt,this.handleReadReceipt),this.room.on(p.c.Timeline,this.handleRoomEventUpdate),this.room.on(p.c.Redaction,this.handleRoomEventUpdate),this.room.on(p.c.MyMembership,this.handleMembershipUpdate),this.room.on(p.c.LocalEchoUpdated,this.handleLocalEchoUpdated),t&&t.on(u.b.Update,this.handleThreadsUpdate),g.a.get().on(m.c.Decrypted,this.onEventDecrypted),g.a.get().on(o.b.AccountData,this.handleAccountDataUpdate),this.updateNotificationState()}get roomIsInvite(){return Object(f.b)(this.room.getMyMembership())===f.a.Invite}destroy(){super.destroy(),this.room.removeListener(p.c.Receipt,this.handleReadReceipt),this.room.removeListener(p.c.Timeline,this.handleRoomEventUpdate),this.room.removeListener(p.c.Redaction,this.handleRoomEventUpdate),this.room.removeListener(p.c.MyMembership,this.handleMembershipUpdate),this.room.removeListener(p.c.LocalEchoUpdated,this.handleLocalEchoUpdated),this.threadsState&&this.threadsState.removeListener(u.b.Update,this.handleThreadsUpdate),g.a.get()&&(g.a.get().removeListener(m.c.Decrypted,this.onEventDecrypted),g.a.get().removeListener(o.b.AccountData,this.handleAccountDataUpdate))}updateNotificationState(){const e=this.snapshot();if(Object(S.b)(this.room).length>0)this._color=l.a.Unsent,this._symbol="!",this._count=1;else if(b.b(this.room.roomId)===b.a.Mute)this._color=l.a.None,this._symbol=null,this._count=0;else if(this.roomIsInvite)this._color=l.a.Red,this._symbol="!",this._count=1;else{const e=b.c(this.room,p.a.Highlight),t=b.c(this.room,p.a.Total),n=t||(e||0);if(e>0)this._color=l.a.Red,this._count=n,this._symbol=null;else if(t>0)this._color=l.a.Grey,this._count=n,this._symbol=null;else{const e=y.a(this.room);this._color=e?l.a.Bold:l.a.None,this._count=0,this._symbol=null}}this.emitIfUpdated(e)}}class w extends u.a{constructor(){super(),s()(this,"totalStatesWithUnread",0),this._symbol=null,this._count=0,this._color=l.a.None}get numUnreadStates(){return this.totalStatesWithUnread}add(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.symbol&&t&&(this._symbol=e.symbol),e.count&&(this._count+=e.count),e.color>this.color&&(this._color=e.color),e.hasUnreadCount&&this.totalStatesWithUnread++}}var _=n(137);class C extends u.a{constructor(e){super(),this.thread=e,s()(this,"_symbol",null),s()(this,"_count",0),s()(this,"_color",l.a.None),s()(this,"handleNewThreadReply",(e,t)=>{const n=g.a.get(),i=n.getUserId(),s=i===t.getSender(),o=this.thread.room.getReadReceiptForUserId(i);if(!s&&!o||o&&t.getTs()>=o.data.ts){const e=n.getPushActionsForEvent(t,!0);if(null!=e&&e.tweaks){const t=e.tweaks.highlight?l.a.Red:l.a.Grey;this.updateNotificationState(t)}}}),s()(this,"resetThreadNotification",()=>{this.updateNotificationState(l.a.None)}),this.thread.on(_.e.NewReply,this.handleNewThreadReply),this.thread.on(_.e.ViewThread,this.resetThreadNotification),this.thread.replyToEvent&&this.handleNewThreadReply(this.thread,this.thread.replyToEvent)}destroy(){super.destroy(),this.thread.off(_.e.NewReply,this.handleNewThreadReply),this.thread.off(_.e.ViewThread,this.resetThreadNotification)}updateNotificationState(e){const t=this.snapshot();this._color=e,this.emitIfUpdated(t)}}class O extends u.a{constructor(e){super(),this.room=e,s()(this,"threadsState",new Map),s()(this,"_symbol",null),s()(this,"_count",0),s()(this,"_color",l.a.None),s()(this,"onNewThread",e=>{const t=new C(e);this.threadsState.set(e,t),t.on(u.b.Update,this.onThreadUpdate)}),s()(this,"onThreadUpdate",()=>{let e=l.a.None;for(const[,t]of this.threadsState){if(t.color===l.a.Red){e=l.a.Red;break}t.color===l.a.Grey&&(e=l.a.Grey)}this.updateNotificationState(e)});for(const e of this.room.getThreads())this.onNewThread(e);this.room.on(_.e.New,this.onNewThread)}destroy(){super.destroy(),this.room.off(_.e.New,this.onNewThread);for(const[,e]of this.threadsState)e.off(u.b.Update,this.onThreadUpdate)}getThreadRoomState(e){return this.threadsState.has(e)||this.threadsState.set(e,new C(e)),this.threadsState.get(e)}updateNotificationState(e){const t=this.snapshot();this._color=e,this.emitIfUpdated(t)}}var R=n(580),I=n(173);const k=Symbol("update-status-indicator");class x extends r.a{constructor(){super(a.a,{}),s()(this,"roomMap",new Map),s()(this,"roomThreadsMap",new Map),s()(this,"listMap",new Map),s()(this,"_globalState",new w),s()(this,"onSync",(e,t,n)=>{const i=new w,s=this.matrixClient.getVisibleRooms();let o=0;for(const e of s)R.a.instance.isRoomVisible(e)&&(i.add(this.getRoomState(e)),e.tags[c.a.Favourite]&&!e.getType()&&o++);I.a.instance.setProperty("numFavouriteRooms",o),this.globalState.symbol===i.symbol&&this.globalState.count===i.count&&this.globalState.color===i.color&&this.globalState.numUnreadStates===i.numUnreadStates&&e===t||(this._globalState=i,this.emit(k,i,e,t,n))})}get globalState(){return this._globalState}getListState(e){if(this.listMap.has(e))return this.listMap.get(e);const t=e===c.a.Invite,n=new h(t,e=>this.getRoomState(e));return this.listMap.set(e,n),n}getRoomState(e){if(!this.roomMap.has(e)){const t=new O(e);this.roomThreadsMap.set(e,t),this.roomMap.set(e,new E(e,t))}return this.roomMap.get(e)}getThreadsRoomState(e){return this.roomThreadsMap.has(e)||this.roomThreadsMap.set(e,new O(e)),this.roomThreadsMap.get(e)}static get instance(){return x.internalInstance}async onReady(){this.matrixClient.on(o.b.Sync,this.onSync)}async onNotReady(){var e;null===(e=this.matrixClient)||void 0===e||e.off(o.b.Sync,this.onSync);for(const e of this.roomMap.values())e.destroy()}async onAction(e){}}s()(x,"internalInstance",new x)},function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var i=n(103),s=n.n(i),o=n(88),r=n.n(o),a=n(903),c=n.n(a),l=n(0),d=n(126),u=n(98),h=n(90),m=n(93);const p=["eventName"];function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let v;!function(e){e[e.Disabled=0]="Disabled",e[e.Anonymous=1]="Anonymous",e[e.Pseudonymous=2]="Pseudonymous"}(v||(v={}));const b=new Set(["register","login","forgot_password","soft_logout","new","settings","welcome","home","start","directory","start_sso","start_cas","complete_security","post_registration","room","user"]);class y{static get instance(){return this._instance||(this._instance=new y(c.a)),this._instance}constructor(e){this.posthog=e,r()(this,"anonymity",v.Disabled),r()(this,"enabled",!1),r()(this,"platformSuperProperties",{}),r()(this,"propertiesForNextEvent",{}),r()(this,"userPropertyCache",{}),r()(this,"authenticationType","Other"),r()(this,"lastScreen","Loading"),r()(this,"sanitizeProperties",(e,t)=>("$pageview"===t&&(this.lastScreen=e.$current_url),e.$current_url=this.lastScreen,this.anonymity==v.Anonymous&&(e.$referrer=null,e.$referring_domain=null,e.$initial_referrer=null,e.$initial_referring_domain=null,e.$device_id=null),e));const t=u.b.getObject("posthog");t?(this.posthog.init(t.get("project_api_key"),{api_host:t.get("api_host"),autocapture:!1,mask_all_text:!0,mask_all_element_attributes:!0,capture_pageview:!1,sanitize_properties:this.sanitizeProperties,respect_dnt:!0,advanced_disable_decide:!0}),this.enabled=!0):this.enabled=!1}registerSuperProperties(e){this.enabled&&this.posthog.register(e)}static async getPlatformProperties(){const e=d.a.get();let t;try{t=await e.getAppVersion()}catch(e){t="unknown"}return{appVersion:t,appPlatform:e.getHumanReadableName()}}capture(e,t,n){if(!this.enabled)return;const{origin:i,hash:s,pathname:o}=window.location;t.redactedCurrentUrl=function(e,t,n){let i;if(e.startsWith("file://")&&(n="/<redacted_file_scheme_url>/"),""==t)i="";else{let[e,n]=t.split("/");b.has(n)||(n="<redacted_screen_name>"),i=`${e}/${n}/<redacted>`}return e+n+i}(i,s,o),this.posthog.capture(e,f(f({},this.propertiesForNextEvent),t)),this.propertiesForNextEvent={}}isEnabled(){return this.enabled}setAnonymity(e){!this.enabled||e!=v.Disabled&&e!=v.Anonymous||(this.posthog.reset(),this.registerSuperProperties(this.platformSuperProperties)),this.anonymity=e}static getRandomAnalyticsId(){return[...crypto.getRandomValues(new Uint8Array(16))].map(e=>e.toString(16)).join("")}async identifyUser(e,t){if(this.anonymity==v.Pseudonymous)try{const n=await e.getAccountDataFromServer(y.ANALYTICS_EVENT_TYPE);let i=null==n?void 0:n.id;i||(i=t(),await e.setAccountData(y.ANALYTICS_EVENT_TYPE,Object.assign({id:i},n))),this.posthog.identify(i)}catch(e){l.a.log("Unable to identify user for tracking"+e.toString())}}getAnonymity(){return this.anonymity}logout(){this.enabled&&this.posthog.reset(),this.setAnonymity(v.Disabled)}trackEvent(e,t){let{eventName:n}=e,i=s()(e,p);this.anonymity!=v.Disabled&&this.anonymity!=v.Anonymous&&this.capture(n,i,t)}setProperty(e,t){this.userPropertyCache[e]!==t&&(this.userPropertyCache[e]=t,this.propertiesForNextEvent.$set||(this.propertiesForNextEvent.$set={}),this.propertiesForNextEvent.$set[e]=t)}setPropertyOnce(e,t){this.userPropertyCache[e]||(this.userPropertyCache[e]=t,this.propertiesForNextEvent.$set_once||(this.propertiesForNextEvent.$set_once={}),this.propertiesForNextEvent.$set_once[e]=t)}async updatePlatformSuperProperties(){this.platformSuperProperties=await y.getPlatformProperties(),this.registerSuperProperties(this.platformSuperProperties)}async updateAnonymityFromSettings(e){const t=e?v.Pseudonymous:v.Disabled;this.setAnonymity(t),t===v.Pseudonymous&&(await this.identifyUser(h.a.get(),y.getRandomAnalyticsId),h.a.currentUserIsJustRegistered()&&this.trackNewUserEvent()),t!==v.Disabled&&await y.instance.updatePlatformSuperProperties()}startListeningToSettingsChanges(){m.b.watchSetting("pseudonymousAnalyticsOptIn",null,(e,t,n,i,s)=>{this.updateAnonymityFromSettings(!!s)})}setAuthenticationType(e){this.authenticationType=e}trackNewUserEvent(){const e={},t=parseInt(window.localStorage.getItem("mx_registration_time"),10);return isNaN(t)||(e.timestamp=new Date(t)),this.trackEvent({eventName:"Signup",authenticationType:this.authenticationType},e)}}r()(y,"_instance",null),r()(y,"ANALYTICS_EVENT_TYPE","im.vector.analytics")},,function(e,t,n){"use strict";n.d(t,"c",(function(){return o})),n.d(t,"d",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"e",(function(){return c})),n.d(t,"f",(function(){return l})),n.d(t,"b",(function(){return d}));var i=n(89),s=n(699);function o(e){return e<1e3?e.toString():e<1e4?(e/1e3).toFixed(1)+"K":e<1e5?(e/1e3).toFixed(0)+"K":e<1e7?(e/1e6).toFixed(1)+"M":e<1e8?(e/1e6).toFixed(0)+"M":(e/1e9).toFixed(1)+"B"}function r(e){return(new Intl.NumberFormat).format(e)}function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(0===e)return"0 Bytes";const n=1024,i=t<0?0:t,s=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],o=Math.floor(Math.log(e)/Math.log(n));return parseFloat((e/Math.pow(n,o)).toFixed(i))+" "+s[o]}function c(e){return e.match(/.{1,4}/g).join(" ")}function l(e){return"mx_Username_color"+(function(e){let t,n,i=0;if(0===e.length)return i;for(t=0;t<e.length;t++)n=e.charCodeAt(t),i=(i<<5)-i+n,i|=0;return Math.abs(i)}(e)%8+1)}function d(e,t){const n=void 0===t?0:Math.max(e.length-t,0);if(0===e.length)return"";if(1===e.length)return e[0];{let o,r;return n>0?e=e.slice(0,t):o=e.pop(),r=e.every(e=>"string"==typeof e)?e.join(", "):Object(s.a)(e,", "),n>0?Object(i.a)("%(items)s and %(count)s others",{items:r,count:n}):Object(i.a)("%(items)s and %(lastItem)s",{items:r,lastItem:o})}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(88),c=n.n(a),l=n(87),d=n.n(l);const u=["className","onScroll","onWheel","style","tabIndex","wrappedRef","children"];class h extends d.a.Component{constructor(){super(...arguments),c()(this,"containerRef",d.a.createRef())}componentDidMount(){this.containerRef.current&&this.props.onScroll&&this.containerRef.current.addEventListener("scroll",this.props.onScroll,{passive:!0}),this.props.wrappedRef&&this.props.wrappedRef(this.containerRef.current)}componentWillUnmount(){this.containerRef.current&&this.props.onScroll&&this.containerRef.current.removeEventListener("scroll",this.props.onScroll)}render(){const e=this.props,{className:t,onScroll:n,onWheel:i,style:o,tabIndex:a,wrappedRef:c,children:l}=e,h=r()(e,u);return d.a.createElement("div",s()({},h,{ref:this.containerRef,style:o,className:["mx_AutoHideScrollbar",t].join(" "),onWheel:i,tabIndex:null!=a?a:-1}),l)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return r}));var i=n(87),s=n(93);const o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const[o,r]=Object(i.useState)(s.b.getValue(e,t,n));return Object(i.useEffect)(()=>{const i=s.b.watchSetting(e,t,()=>{r(s.b.getValue(e,t,n))});return()=>{s.b.unwatchSetting(i)}},[e,t,n]),o},r=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const[n,o]=Object(i.useState)(s.b.getValue(e,t));return Object(i.useEffect)(()=>{const n=s.b.watchSetting(e,t,()=>{o(s.b.getValue(e,t))});return()=>{s.b.unwatchSetting(n)}},[e,t]),n}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(88),s=n.n(i);class o{constructor(e,t){this.preferred=e,this.legacy=t}matches(e){return e===this.preferred||e===this.legacy}static fromString(e){const t=Object.values(o).filter(e=>e instanceof o).find(t=>t.matches(e));return t||new o(e,e)}}s()(o,"JITSI",new o("m.jitsi","jitsi")),s()(o,"STICKERPICKER",new o("m.stickerpicker","m.stickerpicker")),s()(o,"INTEGRATION_MANAGER",new o("m.integration_manager","m.integration_manager")),s()(o,"CUSTOM",new o("m.custom","m.custom"))},,function(e,t,n){"use strict";n.d(t,"b",(function(){return R})),n.d(t,"a",(function(){return I})),n.d(t,"d",(function(){return k})),n.d(t,"c",(function(){return x}));var i=n(88),s=n.n(i),o=n(97),r=n(125),a=n(0),c=n(90),l=n(95),d=n(89),u=n(92),h=n(238),m=n(384),p=n(745),g=n(131),f=n(213),v=n(257),b=n(96),y=n(107),S=n(102),E=n(301),w=n(264),_=n(217);function C(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function O(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?C(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}async function R(e){void 0===(e=e||{}).spinner&&(e.spinner=!0),void 0===e.guestAccess&&(e.guestAccess=!0),void 0===e.encryption&&(e.encryption=!1);const t=c.a.get();if(t.isGuest())return u.a.dispatch({action:"require_registration"}),null;const n=e.dmUserId?r.d.TrustedPrivateChat:r.d.PrivateChat,i=e.createOpts||{};if(i.preset=i.preset||n,i.visibility=i.visibility||r.f.Private,e.dmUserId&&void 0===i.invite)switch(Object(m.b)(e.dmUserId)){case"mx-user-id":i.invite=[e.dmUserId];break;case"email":i.invite_3pid=[{id_server:c.a.get().getIdentityServerUrl(!0),medium:"email",address:e.dmUserId}]}var s;(e.dmUserId&&void 0===i.is_direct&&(i.is_direct=!0),e.roomType&&(i.creation_content=O(O({},i.creation_content),{},{[o.e]:e.roomType}),e.roomType===o.f.ElementVideo&&(i.power_level_content_override={events:{[v.b]:0,[o.b.RoomName]:50,[o.b.RoomAvatar]:50,[o.b.RoomPowerLevels]:100,[o.b.RoomHistoryVisibility]:100,[o.b.RoomCanonicalAlias]:50,[o.b.RoomTombstone]:100,[o.b.RoomServerAcl]:100,[o.b.RoomEncryption]:100}})),void 0===e.andView&&(e.andView=!0),i.initial_state=i.initial_state||[],e.guestAccess&&i.initial_state.push({type:"m.room.guest_access",state_key:"",content:{guest_access:"can_join"}}),e.encryption&&i.initial_state.push({type:"m.room.encryption",state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}),e.parentSpace)&&(i.initial_state.push(Object(f.b)(e.parentSpace,!0)),e.historyVisibility||(e.historyVisibility=i.preset===r.d.PublicChat?r.b.WorldReadable:r.b.Invited),e.joinRule===r.c.Restricted&&null!==(s=g.a.instance.restrictedJoinRuleSupport)&&void 0!==s&&s.preferred&&(i.room_version=g.a.instance.restrictedJoinRuleSupport.preferred,i.initial_state.push({type:o.b.RoomJoinRules,content:{join_rule:r.c.Restricted,allow:[{type:r.e.RoomMembership,room_id:e.parentSpace.roomId}]}})));if(e.joinRule&&e.joinRule!==r.c.Restricted&&i.initial_state.push({type:o.b.RoomJoinRules,content:{join_rule:e.joinRule}}),e.avatar){let n=e.avatar;e.avatar instanceof File&&(n=await t.uploadContent(e.avatar)),i.initial_state.push({type:o.b.RoomAvatar,content:{url:n}})}let p,E;return e.historyVisibility&&i.initial_state.push({type:o.b.RoomHistoryVisibility,content:{history_visibility:e.historyVisibility}}),e.spinner&&(p=l.a.createDialog(S.a,null,"mx_Dialog_spinner")),t.createRoom(i).catch((function(e){return 403===e.httpStatus&&"M_UNKNOWN"===e.errcode&&"Not allowed to publish room"===e.data.error?(a.a.warn("Failed to publish room, try again without publishing it"),i.visibility=r.f.Private,t.createRoom(i)):Promise.reject(e)})).finally((function(){p&&p.close()})).then((function(t){return E=t.room_id,e.dmUserId?h.d(E,e.dmUserId):Promise.resolve()})).then(()=>{if(e.parentSpace)return g.a.instance.addRoomToSpace(e.parentSpace,E,[t.getDomain()],e.suggested)}).then(async()=>{e.roomType===o.f.ElementVideo&&await Object(v.d)(E,i.name)}).then((function(){return e.andView&&u.a.dispatch({action:b.a.ViewRoom,room_id:E,should_peek:!1,joining:!0,justCreatedOpts:e,metricsTrigger:"Created"}),E}),(function(t){if(e.inlineErrors)throw t;u.a.dispatch({action:b.a.JoinRoomError,roomId:E}),a.a.error("Failed to create room "+E+" "+t);let n=Object(d.a)("Server may be unavailable, overloaded, or you hit a bug.");return"M_UNSUPPORTED_ROOM_VERSION"===t.errcode&&(n=Object(d.a)("The server does not support the room version specified.")),l.a.createTrackedDialog("Failure to create room","",y.a,{title:Object(d.a)("Failure to create room"),description:n}),null}))}async function I(e,t){try{const n=await e.downloadKeys(t);return Object.values(n).every(e=>Object.keys(e).length>0)}catch(e){return a.a.error("Error determining if it's possible to encrypt to all users: ",e),!1}}async function k(e,t,n){const i=Object(E.c)(e,t);let s;return s=i?i.roomId:await R({dmUserId:t,spinner:!1,andView:!1,createOpts:{creation_content:{[p.a]:n}}}),s}async function x(e,t){const n=Object(E.c)(e,t);let i;if(n)i=n.roomId;else{let n=void 0;Object(w.c)()&&(n=await I(e,[t])),i=await R({encryption:n,dmUserId:t,spinner:!1,andView:!1}),await Object(_.e)(e,i,t)}return i}},function(e,t,n){"use strict";n.d(t,"c",(function(){return b})),n.d(t,"a",(function(){return y})),n.d(t,"b",(function(){return S})),n.d(t,"d",(function(){return E}));var i=n(88),s=n.n(i),o=n(116),r=n(93),a=n(209),c=n(181),l=n(250),d=n(92),u=n(458),h=n(104),m=n(121),p=n(123),g=n(149);function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?f(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const b="io.element.widgets.layout";let y;!function(e){e.Top="top",e.Right="right",e.Center="center"}(y||(y={}));const S=3;class E extends u.a{constructor(){super(d.a),s()(this,"byRoom",{}),s()(this,"pinnedRef",void 0),s()(this,"layoutRef",void 0),s()(this,"updateAllRooms",()=>{this.byRoom={};for(const e of this.matrixClient.getVisibleRooms())this.recalculateRoom(e)}),s()(this,"updateFromWidgetStore",e=>{if(e){const t=this.matrixClient.getRoom(e);t&&this.recalculateRoom(t)}else this.updateAllRooms()}),s()(this,"updateRoomFromState",e=>{if(e.getType()!==b)return;const t=this.matrixClient.getRoom(e.getRoomId());t&&this.recalculateRoom(t)}),s()(this,"updateFromSettings",(e,t)=>{if(t){const e=this.matrixClient.getRoom(t);e&&this.recalculateRoom(e)}else this.updateAllRooms()})}static get instance(){return E.internalInstance||(E.internalInstance=new E),E.internalInstance}static emissionForRoom(e){return"update_"+e.roomId}emitFor(e){this.emit(E.emissionForRoom(e))}async onReady(){this.updateAllRooms(),this.matrixClient.on(o.b.Events,this.updateRoomFromState),this.pinnedRef=r.b.watchSetting("Widgets.pinned",null,this.updateFromSettings),this.layoutRef=r.b.watchSetting("Widgets.layout",null,this.updateFromSettings),a.a.instance.on(p.b,this.updateFromWidgetStore)}async onNotReady(){var e;this.byRoom={},null===(e=this.matrixClient)||void 0===e||e.off(o.b.Events,this.updateRoomFromState),r.b.unwatchSetting(this.pinnedRef),r.b.unwatchSetting(this.layoutRef),a.a.instance.off(p.b,this.updateFromWidgetStore)}recalculateRoom(e){const t=a.a.instance.getApps(e.roomId);if(null==t||!t.length)return this.byRoom[e.roomId]={},void this.emitFor(e);const n=JSON.stringify(this.byRoom[e.roomId]),i=e.currentState.getStateEvents(b,""),s=r.b.getValue("Widgets.pinned",e.roomId);let o=r.b.getValue("Widgets.layout",e.roomId);i&&o&&o.overrides!==i.getId()&&(o=null);const d=i?i.getContent():null,u=[],h=[],m=[];for(const e of t){var p,f,v,E,w;const t=null==d||null===(p=d.widgets)||void 0===p||null===(f=p[e.id])||void 0===f?void 0:f.container,n=null===(v=o)||void 0===v||null===(E=v.widgets)||void 0===E||null===(w=E[e.id])||void 0===w?void 0:w.container,i=!(null==s||!s[e.id]),r=c.a.JITSI.matches(e.type)?y.Top:y.Right;if(n?n===y.Center:t===y.Center){m.length?console.error("Tried to push a second widget into the center container"):m.push(e);continue}let a=r;n||t?a=n||t:i&&!t&&(a=y.Top),(a===y.Top?u:h).push(e)}const _=u.slice(S);h.push(..._),u.sort((e,t)=>{var n,i,s,r,a,u;const h=null==d||null===(n=d.widgets)||void 0===n?void 0:n[e.id],m=null==d||null===(i=d.widgets)||void 0===i?void 0:i[t.id],p=null===(s=o)||void 0===s||null===(r=s.widgets)||void 0===r?void 0:r[e.id],f=null===(a=o)||void 0===a||null===(u=a.widgets)||void 0===u?void 0:u[t.id],v=c.a.JITSI.matches(e.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,b=c.a.JITSI.matches(t.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,y=Object(l.b)(null==p?void 0:p.index,Object(l.b)(null==h?void 0:h.index,v)),S=Object(l.b)(null==f?void 0:f.index,Object(l.b)(null==m?void 0:m.index,b));return y===S?Object(g.a)(e.id,t.id):y-S});const C=[];let O=null,R=!0;for(let e=0;e<u.length;e++){var I,k,x;const t=u[e],n=null==d||null===(I=d.widgets)||void 0===I?void 0:I[t.id],i=null===(k=o)||void 0===k||null===(x=k.widgets)||void 0===x?void 0:x[t.id];if(Number.isFinite(null==i?void 0:i.width)||Number.isFinite(null==n?void 0:n.width)){const e=(null==i?void 0:i.width)||(null==n?void 0:n.width),t=Object(l.a)(e,10,100);C.push(t),R=!1}else C.push(100);if(null!=n&&n.height||null!=i&&i.height){const e=Object(l.b)(null==n?void 0:n.height,2),t=Object(l.b)(null==i?void 0:i.height,e);O=Math.max(O,Object(l.a)(t,2,100))}}if(R)for(let e=0;e<C.length;e++)C[e]=100/C.length;else{const e=Object(l.e)(...C)-100;if(e<0)for(let t=0;t<C.length;t++)C[t]+=Math.abs(e)/C.length;else if(e>0){for(let t=0;t<C.length;t++)C[t]=Object(l.a)(C[t]-e/C.length,10,100);const t=Object(l.e)(...C)-100;if(t>0){const e=C.map((e,t)=>[t,e]).filter(e=>e[1]>10).map(e=>e[0]);for(const n of e)C[n]-=t/e.length}}}this.byRoom[e.roomId]={},u.length&&(this.byRoom[e.roomId][y.Top]={ordered:u,distributions:C,height:O}),h.length&&(this.byRoom[e.roomId][y.Right]={ordered:h}),m.length&&(this.byRoom[e.roomId][y.Center]={ordered:m});JSON.stringify(this.byRoom[e.roomId])!==n&&this.emitFor(e)}getContainerWidgets(e,t){var n,i;return(null===(n=this.byRoom[null==e?void 0:e.roomId])||void 0===n||null===(i=n[t])||void 0===i?void 0:i.ordered)||[]}isInContainer(e,t,n){return this.getContainerWidgets(e,n).some(e=>e.id===t.id)}canAddToContainer(e,t){switch(t){case y.Top:case y.Right:return this.getContainerWidgets(e,t).length<S;case y.Center:return this.getContainerWidgets(e,t).length<1}}getResizerDistributions(e,t){var n,i;let s=null===(n=this.byRoom[e.roomId])||void 0===n||null===(i=n[t])||void 0===i?void 0:i.distributions;return!s||s.length<2?[]:(2===s.length&&(s=[s[0]]),3===s.length&&(s=[s[0],s[2]]),s.map(e=>e.toFixed(1)+"%"))}setResizerDistributions(e,t,n){if(t!==y.Top)return;const i=n.map(e=>Number(Number(e.substring(0,e.length-1)).toFixed(1))),s=this.getContainerWidgets(e,t),o=100-Object(l.e)(...i);2===i.length&&i.splice(1,0,o),1===i.length&&i.push(o);const r={};s.forEach((n,s)=>{var o,a;r[n.id]={container:t,width:i[s],index:s,height:(null===(o=this.byRoom[e.roomId])||void 0===o||null===(a=o[t])||void 0===a?void 0:a.height)||2}}),this.updateUserLayout(e,r)}getContainerHeight(e,t){var n,i;return null===(n=this.byRoom[e.roomId])||void 0===n||null===(i=n[t])||void 0===i?void 0:i.height}setContainerHeight(e,t,n){var i,s;const o=this.getContainerWidgets(e,t),r=null===(i=this.byRoom[e.roomId])||void 0===i||null===(s=i[t])||void 0===s?void 0:s.distributions,a={};o.forEach((e,i)=>{a[e.id]={container:t,width:r[i],index:i,height:n}}),this.updateUserLayout(e,a)}moveWithinContainer(e,t,n,i){var s,o,r,a;const c=Object(m.b)(this.getContainerWidgets(e,t)),d=c.findIndex(e=>e.id===n.id);if(d<0)return;c.splice(d,1);const u=Object(l.a)(d+i,0,c.length);c.splice(u,0,n);const h=null===(s=this.byRoom[e.roomId])||void 0===s||null===(o=s[t])||void 0===o?void 0:o.distributions,p=null===(r=this.byRoom[e.roomId])||void 0===r||null===(a=r[t])||void 0===a?void 0:a.height,g={};c.forEach((e,n)=>{g[e.id]={container:t,width:h[n],index:n,height:p}}),this.updateUserLayout(e,g)}moveToContainer(e,t,n){if(!this.getAllWidgets(e).some(e=>{let[n]=e;return n.id===t.id}))return;const i={};switch(n){case y.Right:break;case y.Center:for(const t of this.getContainerWidgets(e,y.Top))i[t.id]={container:y.Right};for(const t of this.getContainerWidgets(e,y.Center))i[t.id]={container:y.Right};break;case y.Top:if(this.hasMaximisedWidget(e)){i[this.getContainerWidgets(e,y.Center)[0].id]={container:y.Right}}}i[t.id]={container:n},this.updateUserLayout(e,i)}hasMaximisedWidget(e){return this.getContainerWidgets(e,y.Center).length>0}hasPinnedWidgets(e){return this.getContainerWidgets(e,y.Top).length>0}canCopyLayoutToRoom(e){return!!this.matrixClient&&e.currentState.maySendStateEvent(b,this.matrixClient.getUserId())}copyLayoutToRoom(e){const t=this.getAllWidgets(e),n={widgets:{}};for(const[a,c]of t)if(n.widgets[a.id]={container:c},c===y.Top){var i,s,o,r;const t=this.getContainerWidgets(e,c).findIndex(e=>e.id===a.id),l=null===(i=this.byRoom[e.roomId])||void 0===i||null===(s=i[c])||void 0===s?void 0:s.distributions,d=null===(o=this.byRoom[e.roomId])||void 0===o||null===(r=o[c])||void 0===r?void 0:r.height;n.widgets[a.id]=v(v({},n.widgets[a.id]),{},{height:d?Math.round(d):null,width:l[t]?Math.round(l[t]):null,index:t})}this.matrixClient.sendStateEvent(e.roomId,b,n,"")}getAllWidgets(e){const t=this.byRoom[e.roomId];if(!t)return[];const n=[];for(const e of Object.keys(t)){const i=t[e].ordered;for(const t of i)n.push([t,e])}return n}updateUserLayout(e,t){const n=this.getAllWidgets(e);for(const[r,c]of n){var i,s;const n=this.getContainerWidgets(e,c).findIndex(e=>e.id===r.id),l=null===(i=this.byRoom[e.roomId])||void 0===i||null===(s=i[c])||void 0===s?void 0:s.distributions;var o,a;if(!t[r.id])t[r.id]={container:c,index:n,height:null===(o=this.byRoom[e.roomId])||void 0===o||null===(a=o[c])||void 0===a?void 0:a.height,width:null==l?void 0:l[n]}}const c=e.currentState.getStateEvents(b,"");r.b.setValue("Widgets.layout",e.roomId,h.a.ROOM_ACCOUNT,{overrides:null==c?void 0:c.getId(),widgets:t}).catch(()=>this.recalculateRoom(e)),this.recalculateRoom(e)}}s()(E,"internalInstance",void 0),window.mxWidgetLayoutStore=E.instance},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const i={};function s(e){var t,n;return null===(t=null===(n=i.shouldShowComponent)||void 0===n?void 0:n.call(i,e))||void 0===t||t}},function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return o}));function i(e){return r(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789")}function s(e){return r(e,"abcdefghijklmnopqrstuvwxyz")}function o(e){return r(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZ")}function r(e,t){let n="";for(let i=0;i<e;++i)n+=t.charAt(Math.floor(Math.random()*t.length));return n}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return u}));var i=n(17),s=n.n(i),o=n(0),r=n(598),a=n(310),c=n(884),l=n(243),d=n(599);class u{static exists(e,t){return d.a(e,t)}constructor(e,t){this.indexedDB=e,this.dbName=t,s()(this,"backendPromise",null),s()(this,"backend",null)}startup(){return this.backendPromise||(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));o.a.log("connecting to indexeddb "+this.dbName);const n=this.indexedDB.open(this.dbName,c.b);n.onupgradeneeded=e=>{const t=n.result,i=e.oldVersion;c.c(t,i)},n.onblocked=()=>{o.a.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{o.a.log("Error connecting to indexeddb",e),t(n.error)},n.onsuccess=()=>{const t=n.result;o.a.log("connected to indexeddb "+this.dbName),e(new c.a(t))}}).then(e=>e.doTxn("readonly",[u.STORE_INBOUND_GROUP_SESSIONS,u.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(t=>{if("VersionError"===t.name)throw o.a.warn("Crypto DB is too new for us to use!",t),new l.a(l.a.TOO_NEW);o.a.warn("unable to connect to indexeddb "+this.dbName+": falling back to localStorage store: "+t);try{return new r.a(e.localStorage)}catch(t){return o.a.warn("unable to open localStorage: falling back to in-memory store: "+t),new a.a}}).then(e=>(this.backend=e,e))),this.backendPromise}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));o.a.log("Removing indexeddb instance: "+this.dbName);const n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{o.a.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{o.a.log("Error deleting data from indexeddb",e),t(n.error)},n.onsuccess=()=>{o.a.log("Removed indexeddb instance: "+this.dbName),e()}}).catch(e=>{o.a.warn("unable to delete IndexedDBCryptoStore: "+e)})}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,n){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,n)}updateOutgoingRoomKeyRequest(e,t,n){return this.backend.updateOutgoingRoomKeyRequest(e,t,n)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this.backend.getSecretStorePrivateKey(e,t,n)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,n){this.backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,i){this.backend.getEndToEndSession(e,t,n,i)}getEndToEndSessions(e,t,n){this.backend.getEndToEndSessions(e,t,n)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,n,i){this.backend.storeEndToEndSession(e,t,n,i)}storeEndToEndSessionProblem(e,t,n){return this.backend.storeEndToEndSessionProblem(e,t,n)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}getEndToEndInboundGroupSession(e,t,n,i){this.backend.getEndToEndInboundGroupSession(e,t,n,i)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,n,i){this.backend.addEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){this.backend.storeEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,n,i)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,n){this.backend.storeEndToEndRoom(e,t,n)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,n,i){this.backend.addSharedHistoryInboundGroupSession(e,t,n,i)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}doTxn(e,t,n,i){return this.backend.doTxn(e,t,n,i)}}s()(u,"STORE_ACCOUNT","account"),s()(u,"STORE_SESSIONS","sessions"),s()(u,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),s()(u,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),s()(u,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),s()(u,"STORE_DEVICE_DATA","device_data"),s()(u,"STORE_ROOMS","rooms"),s()(u,"STORE_BACKUP","sessions_needing_backup")}).call(this,n(30))},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{getValueOverride(e,t,n,i){return null}async beforeChange(e,t,n){return!0}onChange(e,t,n){}get settingDisabled(){return!1}}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return C})),n.d(t,"b",(function(){return R}));var i=n(88),s=n.n(i),o=n(7),r=n(0),a=n(97),c=n(93),l=n(166),d=n(292),u=n(92),h=n(634),m=n(386),p=n(129),g=n(1485),f=n(217),v=n(851),b=n(346),y=n(167),S=n(792),E=n(172),w=n(580),_=n(1374);const C="lists_update";class O extends y.a{constructor(){super(u.a),s()(this,"initialListsGenerated",!1),s()(this,"algorithm",new g.a),s()(this,"filterConditions",[]),s()(this,"prefilterConditions",[]),s()(this,"updateFn",new b.a(()=>{for(const e of Object.keys(this.orderedLists))E.a.instance.getListState(e).setRooms(this.orderedLists[e]);this.emit(C)})),s()(this,"onAlgorithmListUpdated",e=>{this.updateFn.mark(),e&&this.updateFn.trigger()}),s()(this,"onAlgorithmFilterUpdated",()=>{this.updateFn.trigger()}),s()(this,"onPrefilterUpdated",async()=>{await this.recalculatePrefiltering(),this.updateFn.trigger()}),this.setMaxListeners(20),this.algorithm.start()}setupWatchers(){new _.a(this)}get unfilteredLists(){return this.algorithm?this.algorithm.getUnfilteredRooms():{}}get orderedLists(){return this.algorithm?this.algorithm.getOrderedRooms():{}}async resetStore(){await this.reset(),this.filterConditions=[],this.prefilterConditions=[],this.initialListsGenerated=!1,this.algorithm.off(g.b,this.onAlgorithmListUpdated),this.algorithm.off(m.a,this.onAlgorithmListUpdated),this.algorithm.stop(),this.algorithm=new g.a,this.algorithm.on(g.b,this.onAlgorithmListUpdated),this.algorithm.on(m.a,this.onAlgorithmListUpdated),await this.reset(null,!0)}async makeReady(e){e&&this.readyStore.useUnitTestClient(e),p.a.instance.addListener(()=>this.handleRVSUpdate({})),this.algorithm.on(g.b,this.onAlgorithmListUpdated),this.algorithm.on(m.a,this.onAlgorithmFilterUpdated),this.setupWatchers(),r.a.log("Regenerating room lists: Startup"),this.updateAlgorithmInstances(),this.regenerateAllLists({trigger:!1}),this.handleRVSUpdate({trigger:!1}),this.updateFn.mark(),this.updateFn.trigger()}handleRVSUpdate(e){let{trigger:t=!0}=e;if(!this.matrixClient)return;const n=p.a.instance.getRoomId();if(!n&&this.algorithm.stickyRoom)this.algorithm.setStickyRoom(null);else if(n){const e=this.matrixClient.getRoom(n);e?e!==this.algorithm.stickyRoom&&this.algorithm.setStickyRoom(e):(r.a.warn(n+" is current in RVS but missing from client - clearing sticky room"),this.algorithm.setStickyRoom(null))}t&&this.updateFn.trigger()}async onReady(){await this.makeReady()}async onNotReady(){await this.resetStore()}async onAction(t){this.matrixClient&&this.initialListsGenerated&&(O.TEST_MODE?await this.onDispatchAsync(t):e(()=>this.onDispatchAsync(t)))}async onDispatchAsync(e){if(this.matrixClient&&this.initialListsGenerated){if(!this.algorithm)throw new Error("Room list store has no algorithm to process dispatcher update with");if("MatrixActions.Room.receipt"===e.action){if(Object(h.a)(e.event,this.matrixClient)){const t=e.room;return t?(await this.handleRoomUpdate(t,l.c.ReadReceipt),void this.updateFn.trigger()):void r.a.warn("Own read receipt was in unknown room "+t.roomId)}}else if("MatrixActions.Room.tags"===e.action){const t=e;await this.handleRoomUpdate(t.room,l.c.PossibleTagChange),this.updateFn.trigger()}else if("MatrixActions.Room.timeline"===e.action){const t=e;if(!t.isLiveEvent||!t.isLiveUnfilteredRoomTimelineEvent||!t.room)return;const n=t.event.getRoomId(),i=this.matrixClient.getRoom(n),s=async e=>{if(t.event.getType()===a.b.RoomTombstone&&""===t.event.getStateKey()){if(this.matrixClient.getRoom(t.event.getContent().replacement_room))return}await this.handleRoomUpdate(e,l.c.Timeline),this.updateFn.trigger()};if(!i)return r.a.warn(`Live timeline event ${t.event.getId()} received without associated room`),r.a.warn("Queuing failed room update for retry as a result."),void setTimeout(async()=>{const e=this.matrixClient.getRoom(n);await s(e)},100);await s(i)}else if("MatrixActions.Event.decrypted"===e.action){const t=e,n=t.event.getRoomId();if(!n)return;const i=this.matrixClient.getRoom(n);if(!i)return void r.a.warn(`Event ${t.event.getId()} was decrypted in an unknown room ${n}`);await this.handleRoomUpdate(i,l.c.Timeline),this.updateFn.trigger()}else if("MatrixActions.accountData"===e.action&&e.event_type===a.b.Direct){const t=e.event.getContent();for(const e of Object.keys(t)){const n=t[e];for(const e of n){const t=this.matrixClient.getRoom(e);t?await this.handleRoomUpdate(t,l.c.PossibleTagChange):r.a.warn(e+" was found in DMs but the room is not in the store")}}this.updateFn.trigger()}else if("MatrixActions.Room.myMembership"===e.action){const t=e,n=Object(f.b)(t.oldMembership),i=Object(f.b)(t.membership);if(n!==f.a.Join&&i===f.a.Join){const e=t.room.currentState.getStateEvents(a.b.RoomCreate,"");if(e&&e.getContent().predecessor){const t=this.matrixClient.getRoom(e.getContent().predecessor.room_id);if(t){this.algorithm.stickyRoom===t&&this.algorithm.setStickyRoom(null),this.algorithm.handleRoomUpdate(t,l.c.RoomRemoved)}}return await this.handleRoomUpdate(t.room,l.c.NewRoom),void this.updateFn.trigger()}if(n!==f.a.Invite&&i===f.a.Invite)return await this.handleRoomUpdate(t.room,l.c.NewRoom),void this.updateFn.trigger();if(n!==i)return await this.handleRoomUpdate(t.room,l.c.PossibleTagChange),void this.updateFn.trigger()}}}async handleRoomUpdate(e,t){if(t===l.c.NewRoom&&"invite"===e.getMyMembership()&&await w.a.instance.onNewInvitedRoom(e),!w.a.instance.isRoomVisible(e))return;if((t===l.c.NewRoom||t===l.c.PossibleTagChange)&&!this.prefilterConditions.every(t=>t.isVisible(e)))return;this.algorithm.handleRoomUpdate(e,t)&&this.updateFn.mark()}async recalculatePrefiltering(){if(!this.algorithm)return;if(!this.algorithm.hasTagSortingMap)return;this.algorithm.updatesInhibited=!0;const e=this.getPlausibleRooms(),t=this.algorithm.stickyRoom,n=t&&e.includes(t);this.algorithm.setStickyRoom(null),this.algorithm.setKnownRooms(e),n&&this.algorithm.setStickyRoom(t),this.updateFn.mark(),this.algorithm.updatesInhibited=!1}async setTagSorting(e,t){this.setAndPersistTagSorting(e,t),this.updateFn.trigger()}setAndPersistTagSorting(e,t){this.algorithm.setTagSorting(e,t),localStorage.setItem("mx_tagSort_"+e,t)}getTagSorting(e){return this.algorithm.getTagSorting(e)}getStoredTagSorting(e){return localStorage.getItem("mx_tagSort_"+e)}calculateTagSorting(e){const t=e===l.a.Invite||e===l.a.DM?d.b.Recent:d.b.Alphabetic,n=c.b.getValue("RoomList.orderAlphabetically",null,!0),i=this.getTagSorting(e),s=this.getStoredTagSorting(e);let r=t;return s?r=s:Object(o.t)(n)?i&&(r=i):r=n?d.b.Alphabetic:d.b.Recent,r}setListOrder(e,t){this.setAndPersistListOrder(e,t),this.updateFn.trigger()}setAndPersistListOrder(e,t){this.algorithm.setListOrdering(e,t),localStorage.setItem("mx_listOrder_"+e,t)}getListOrder(e){return this.algorithm.getListOrdering(e)}getStoredListOrder(e){return localStorage.getItem("mx_listOrder_"+e)}calculateListOrder(e){const t=d.a.Natural,n=c.b.getValue("RoomList.orderByImportance",null,!0),i=this.getListOrder(e),s=this.getStoredListOrder(e);let r=t;return s?r=s:Object(o.t)(n)?i&&(r=i):r=n?d.a.Importance:d.a.Natural,r}updateAlgorithmInstances(){this.updateFn.mark();for(const e of Object.keys(this.orderedLists)){const t=this.getTagSorting(e),n=this.getListOrder(e),i=this.calculateTagSorting(e),s=this.calculateListOrder(e);i!==t&&this.setAndPersistTagSorting(e,i),s!==n&&this.setAndPersistListOrder(e,s)}}getPlausibleRooms(){if(!this.matrixClient)return[];let e=this.matrixClient.getVisibleRooms().filter(e=>w.a.instance.isRoomVisible(e));return this.prefilterConditions.length>0&&!this.filterConditions.length&&(e=e.filter(e=>{for(const t of this.prefilterConditions)if(!t.isVisible(e))return!1;return!0})),e}regenerateAllLists(e){let{trigger:t=!0}=e;r.a.warn("Regenerating all room lists");const n=this.getPlausibleRooms(),i={},s={},o=[...l.b];for(const e of o)i[e]=this.calculateTagSorting(e),s[e]=this.calculateListOrder(e),v.a.instance.ensureLayoutExists(e);this.algorithm.populateTags(i,s),this.algorithm.setKnownRooms(n),this.initialListsGenerated=!0,t&&this.updateFn.trigger()}async addFilter(e){let t=Promise.resolve();e.kind===m.b.Prefilter?(e.on(m.a,this.onPrefilterUpdated),this.prefilterConditions.push(e),t=this.recalculatePrefiltering()):(this.filterConditions.push(e),await this.recalculatePrefiltering(),this.algorithm&&this.algorithm.addFilterCondition(e)),t.then(()=>this.updateFn.trigger())}removeFilter(e){let t=Promise.resolve(),n=this.filterConditions.indexOf(e),i=!1;n>=0&&(this.filterConditions.splice(n,1),this.algorithm&&this.algorithm.removeFilterCondition(e),t=this.recalculatePrefiltering(),i=!0),n=this.prefilterConditions.indexOf(e),n>=0&&(e.off(m.a,this.onPrefilterUpdated),this.prefilterConditions.splice(n,1),t=this.recalculatePrefiltering(),i=!0),i&&t.then(()=>this.updateFn.trigger())}getFirstNameFilterCondition(){for(const e of this.filterConditions)if(e instanceof S.a)return e;return null}getTagsForRoom(e){const t=this.algorithm.getTagsForRoom(e);return t||[l.a.Untagged]}async manualRoomUpdate(e,t){await this.handleRoomUpdate(e,t),this.updateFn.trigger()}}s()(O,"TEST_MODE",!1);class R{static get instance(){return R.internalInstance||(R.internalInstance=new O),R.internalInstance}}s()(R,"internalInstance",void 0),window.mxRoomListStore=R.instance}).call(this,n(179).setImmediate)},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(143),r=n(168);let a;!function(e){e.Update="update"}(a||(a={}));class c extends o.b{constructor(){super(...arguments),s()(this,"_symbol",void 0),s()(this,"_count",void 0),s()(this,"_color",void 0)}get symbol(){return this._symbol}get count(){return this._count}get color(){return this._color}get isIdle(){return this.color<=r.a.None}get isUnread(){return this.color>=r.a.Bold}get hasUnreadCount(){return this.color>=r.a.Grey&&(!!this.count||!!this.symbol)}get hasMentions(){return this.color>=r.a.Red}emitIfUpdated(e){e.isDifferentFrom(this)&&this.emit(a.Update)}snapshot(){return new l(this)}destroy(){this.removeAllListeners(a.Update)}}class l{constructor(e){s()(this,"symbol",void 0),s()(this,"count",void 0),s()(this,"color",void 0),this.symbol=e.symbol,this.count=e.count,this.color=e.color}isDifferentFrom(e){const t={count:this.count,symbol:this.symbol,color:this.color},n={count:e.count,symbol:e.symbol,color:e.color};return JSON.stringify(t)!==JSON.stringify(n)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(93),c=n(89),l=n(525),d=n(141);class u extends r.a.Component{constructor(e){super(e),s()(this,"onChange",async e=>{await this.save(e),this.setState({value:e}),this.props.onChange&&this.props.onChange(e)}),s()(this,"checkBoxOnChange",e=>{this.onChange(e.target.checked)}),s()(this,"save",async e=>{await a.b.setValue(this.props.name,this.props.roomId,this.props.level,void 0!==e?e:this.state.value)}),this.state={value:a.b.getValueAt(this.props.level,this.props.name,this.props.roomId,this.props.isExplicit)}}render(){const e=a.b.canSetValue(this.props.name,this.props.roomId,this.props.level),t=this.props.label?Object(c.a)(this.props.label):a.b.getDisplayName(this.props.name,this.props.level),n=a.b.getDescription(this.props.name);return this.props.useCheckbox?r.a.createElement(d.b,{checked:this.state.value,onChange:this.checkBoxOnChange,disabled:this.props.disabled||!e},t):r.a.createElement("div",{className:"mx_SettingsFlag"},r.a.createElement("label",{className:"mx_SettingsFlag_label"},r.a.createElement("span",{className:"mx_SettingsFlag_labelText"},t),n&&r.a.createElement("div",{className:"mx_SettingsFlag_microcopy"},n)),r.a.createElement(l.a,{checked:this.state.value,onChange:this.onChange,disabled:this.props.disabled||!e,"aria-label":t}))}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return o}));const i={HOME:"Home",END:"End",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",BACKSPACE:"Backspace",DELETE:"Delete",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight",TAB:"Tab",ESCAPE:"Escape",ENTER:"Enter",ALT:"Alt",CONTROL:"Control",META:"Meta",SHIFT:"Shift",CONTEXT_MENU:"ContextMenu",COMMA:",",PERIOD:".",LESS_THAN:"<",GREATER_THAN:">",BACKTICK:"`",SPACE:" ",SLASH:"/",SQUARE_BRACKET_LEFT:"[",SQUARE_BRACKET_RIGHT:"]",SEMICOLON:";",A:"a",B:"b",C:"c",D:"d",E:"e",F:"f",G:"g",H:"h",I:"i",J:"j",K:"k",L:"l",M:"m",N:"n",O:"o",P:"p",Q:"q",R:"r",S:"s",T:"t",U:"u",V:"v",W:"w",X:"x",Y:"y",Z:"z"},s=navigator.platform.toUpperCase().includes("MAC");function o(e){return s?e.metaKey&&!e.altKey&&!e.ctrlKey&&!e.shiftKey:e.ctrlKey&&!e.altKey&&!e.metaKey&&!e.shiftKey}},function(e,t,n){"use strict";n.d(t,"a",(function(){return f})),n.d(t,"f",(function(){return v})),n.d(t,"e",(function(){return b})),n.d(t,"c",(function(){return y})),n.d(t,"b",(function(){return S})),n.d(t,"d",(function(){return E}));var i=n(87),s=n.n(i),o=n(0),r=n(97),a=n(90),c=n(579),l=n(95),d=n(89),u=n(631),h=n(148),m=n(128),p=n(107),g=n(531);function f(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;const s=new c.a(e,i);return s.invite(t,void 0,n).then(e=>Promise.resolve({states:e,inviter:s}))}function v(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";l.a.createTrackedDialog("Start DM","",u.a,{kind:g.b,initialText:e},null,!1,!0)}function b(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";l.a.createTrackedDialog("Invite Users","",u.a,{kind:g.c,initialText:t,roomId:e},null,!1,!0)}function y(e){if(!e||e.getType()!==r.b.RoomThirdPartyInvite)return!1;return!["key_validity_url","public_key","display_name"].some(t=>!e.getContent()[t])}function S(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;return f(e,t,n,i).then(t=>{const n=a.a.get().getRoom(e);E(t.states,n,t.inviter)}).catch(e=>{o.a.error(e.stack),l.a.createTrackedDialog("Failed to invite","",p.a,{title:Object(d.a)("Failed to invite"),description:e&&e.message?e.message:Object(d.a)("Operation failed")})})}function E(e,t,n,i){const o=Object.keys(e).filter(t=>"error"===e[t]);if(1===o.length&&n.fatal)return l.a.createTrackedDialog("Failed to invite users to the room","",p.a,{title:Object(d.a)("Failed to invite users to %(roomName)s",{roomName:t.name}),description:n.getErrorText(o[0])}),!1;{const r=[];for(const t of o)if("error"===e[t]){const e=n.getErrorText(t);r.push(t+": "+e)}const c=a.a.get();if(r.length>0){const e=s.a.createElement("div",{className:"mx_InviteDialog_multiInviterError"},s.a.createElement("h4",null,Object(d.a)("We sent the others, but the below people couldn't be invited to <RoomName/>",{},{RoomName:()=>s.a.createElement("b",null,t.name)})),s.a.createElement("div",null,o.map(e=>{var t,o;const r=(null==i?void 0:i.get(e))||c.getUser(e),a=r.name||r.rawDisplayName,l=(null===(t=(o=r).getMxcAvatarUrl)||void 0===t?void 0:t.call(o))||r.avatarUrl;return s.a.createElement("div",{key:e,className:"mx_InviteDialog_multiInviterError_entry"},s.a.createElement("div",{className:"mx_InviteDialog_multiInviterError_entry_userProfile"},s.a.createElement(h.a,{url:l?Object(m.b)(l).getSquareThumbnailHttp(24):null,name:a,idName:r.userId,width:24,height:24}),s.a.createElement("span",{className:"mx_InviteDialog_multiInviterError_entry_name"},a),s.a.createElement("span",{className:"mx_InviteDialog_multiInviterError_entry_userId"},r.userId)),s.a.createElement("div",{className:"mx_InviteDialog_multiInviterError_entry_error"},n.getErrorText(e)))})));return l.a.createTrackedDialog("Some invites could not be sent","",p.a,{title:Object(d.a)("Some invites couldn't be sent"),description:e}),!1}}return!0}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(87),s=n.n(i),o=n(94),r=n.n(o),a=n(525);class c extends s.a.PureComponent{render(){let e=s.a.createElement("span",{className:"mx_SettingsFlag_label"},this.props.label),t=s.a.createElement(a.a,{checked:this.props.value,disabled:this.props.disabled,onChange:this.props.onChange,"aria-label":this.props.label});if(this.props.toggleInFront){const n=e;e=t,t=n}const n=r()("mx_SettingsFlag",this.props.className,{mx_SettingsFlag_toggleInFront:this.props.toggleInFront});return s.a.createElement("div",{className:n},e,t)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(88),s=n.n(i),o=n(200),r=n(116),a=n(111),c=n(97),l=n(167),d=n(92),u=n(90),h=n(89),m=n(128);class p extends l.a{constructor(){super(d.a,{displayName:window.localStorage.getItem("mx_profile_displayname"),avatarUrl:window.localStorage.getItem("mx_profile_avatar_url")}),s()(this,"monitoredUser",void 0),s()(this,"onProfileUpdate",Object(a.throttle)(async()=>{const e=await this.matrixClient.getProfileInfo(this.matrixClient.getUserId());e.displayname?window.localStorage.setItem("mx_profile_displayname",e.displayname):window.localStorage.removeItem("mx_profile_displayname"),e.avatar_url?window.localStorage.setItem("mx_profile_avatar_url",e.avatar_url):window.localStorage.removeItem("mx_profile_avatar_url"),await this.updateState({displayName:e.displayname,avatarUrl:e.avatar_url,fetchedAt:Date.now()})},200,{trailing:!0,leading:!0})),s()(this,"onStateEvents",async e=>{const t=u.a.get().getUserId();e.getType()===c.b.RoomMember&&e.getSender()===t&&e.getStateKey()===t&&await this.onProfileUpdate()})}static get instance(){return p.internalInstance}get displayName(){return this.matrixClient?this.matrixClient.isGuest()?Object(h.a)("Guest"):this.state.displayName?this.state.displayName:this.matrixClient.getUserId():this.state.displayName||null}get isProfileInfoFetched(){return!!this.state.fetchedAt}get avatarMxc(){return this.state.avatarUrl||null}getHttpAvatarUrl(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!this.avatarMxc)return null;const t=Object(m.b)(this.avatarMxc);return!e||e<=0?t.srcHttp:t.getSquareThumbnailHttp(e)}async onNotReady(){var e;this.monitoredUser&&(this.monitoredUser.removeListener(o.b.DisplayName,this.onProfileUpdate),this.monitoredUser.removeListener(o.b.AvatarUrl,this.onProfileUpdate)),null===(e=this.matrixClient)||void 0===e||e.removeListener(r.b.Events,this.onStateEvents),await this.reset({})}async onReady(){const e=this.matrixClient.getUserId();this.monitoredUser=this.matrixClient.getUser(e),this.monitoredUser&&(this.monitoredUser.on(o.b.DisplayName,this.onProfileUpdate),this.monitoredUser.on(o.b.AvatarUrl,this.onProfileUpdate)),this.matrixClient.on(r.b.Events,this.onStateEvents),await this.onProfileUpdate()}async onAction(e){}}s()(p,"internalInstance",new p)},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(91);t.a=e=>{let{description:t,detail:n,acceptLabel:i,rejectLabel:r,onAccept:a,onReject:c}=e;const l=n?s.a.createElement("div",{className:"mx_Toast_detail"},n):null;return s.a.createElement("div",null,s.a.createElement("div",{className:"mx_Toast_description"},t,l),s.a.createElement("div",{className:"mx_Toast_buttons","aria-live":"off"},c&&r&&s.a.createElement(o.a,{kind:"danger_outline",onClick:c},r),s.a.createElement(o.a,{onClick:a,kind:"primary"},i)))}},function(e,t,n){"use strict";n.d(t,"b",(function(){return ue})),n.d(t,"a",(function(){return he})),n.d(t,"e",(function(){return fe})),n.d(t,"g",(function(){return ve})),n.d(t,"f",(function(){return be})),n.d(t,"d",(function(){return Se})),n.d(t,"c",(function(){return Ee}));var i=n(99),s=n.n(i),o=n(87),r=n.n(o),a=n(97),c=n(165),l=n(106),d=n(843),u=n(88),h=n.n(u),m=n(94),p=n.n(m),g=n(203),f=n(145),v=n(90),b=n(89),y=n(545),S=n(268);class E extends r.a.Component{constructor(e){super(e),h()(this,"onRequestChanged",()=>{this.forceUpdate()}),h()(this,"onTrustChanged",e=>{const{mxEvent:t}=this.props,n=t.verificationRequest;n&&n.otherUserId===e&&this.forceUpdate()})}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on(g.m.Change,this.onRequestChanged),v.a.get().on(f.b.UserTrustStatusChanged,this.onTrustChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off(g.m.Change,this.onRequestChanged);const t=v.a.get();t&&t.removeListener(f.b.UserTrustStatusChanged,this.onTrustChanged)}static shouldRender(e,t){return!!t&&(!(e.getType()===a.b.KeyVerificationCancel&&!t.cancelled)&&(!(e.getType()===a.b.KeyVerificationDone&&!t.done)&&(!t.pending&&!!v.a.get().checkUserTrust(t.otherUserId).isCrossSigningVerified())))}render(){const{mxEvent:e}=this.props,t=e.verificationRequest;if(!E.shouldRender(e,t))return null;const n=v.a.get().getUserId();let i;if(t.done)i=Object(b.a)("You verified %(name)s",{name:Object(y.a)(t.otherUserId,e.getRoomId())});else if(t.cancelled){const s=t.cancellingUserId;i=s===n?Object(b.a)("You cancelled verifying %(name)s",{name:Object(y.a)(t.otherUserId,e.getRoomId())}):Object(b.a)("%(name)s cancelled verifying",{name:Object(y.a)(s,e.getRoomId())})}if(i){const n=p()("mx_cryptoEvent mx_cryptoEvent_icon",{mx_cryptoEvent_icon_verified:t.done});return r.a.createElement(S.a,{className:n,title:i,subtitle:Object(y.b)(t.otherUserId,e.getRoomId()),timestamp:this.props.timestamp})}return null}}var w=n(152),_=n(136),C=n(546),O=n(91),R=n(787),I=n(117),k=n(133),x=n(410);class T extends r.a.PureComponent{constructor(e){super(e),h()(this,"wrapperElement",Object(o.createRef)()),h()(this,"resizeObserver",void 0),h()(this,"onLengthChanged",e=>{this.setState({length:e})}),h()(this,"resizeObserverCallback",e=>{const t=e.find(e=>e.target===this.wrapperElement.current);t&&this.setState({narrow:t.contentRect.width<450/70*100})}),h()(this,"onSilencedChanged",e=>{this.setState({silenced:e})}),h()(this,"onStateChanged",e=>{this.setState({callState:e})}),this.state={callState:this.props.callEventGrouper.state,silenced:!1,narrow:!1,length:0}}componentDidMount(){this.props.callEventGrouper.addListener(C.a.StateChanged,this.onStateChanged),this.props.callEventGrouper.addListener(C.a.SilencedChanged,this.onSilencedChanged),this.props.callEventGrouper.addListener(C.a.LengthChanged,this.onLengthChanged),this.resizeObserver=new ResizeObserver(this.resizeObserverCallback),this.wrapperElement.current&&this.resizeObserver.observe(this.wrapperElement.current)}componentWillUnmount(){this.props.callEventGrouper.removeListener(C.a.StateChanged,this.onStateChanged),this.props.callEventGrouper.removeListener(C.a.SilencedChanged,this.onSilencedChanged),this.props.callEventGrouper.removeListener(C.a.LengthChanged,this.onLengthChanged),this.resizeObserver.disconnect()}renderCallBackButton(e){return r.a.createElement(O.a,{className:"mx_CallEvent_content_button mx_CallEvent_content_button_callBack",onClick:this.props.callEventGrouper.callBack,kind:"primary"},r.a.createElement("span",null," ",e," "))}renderSilenceIcon(){const e=p()({mx_CallEvent_iconButton:!0,mx_CallEvent_unSilence:this.state.silenced,mx_CallEvent_silence:!this.state.silenced});return r.a.createElement(I.a,{className:e,onClick:this.props.callEventGrouper.toggleSilenced,title:this.state.silenced?Object(b.a)("Sound on"):Object(b.a)("Silence call")})}renderContent(e){if(e===w.e.Ringing){let e;return this.state.narrow||(e=this.renderSilenceIcon()),r.a.createElement("div",{className:"mx_CallEvent_content"},e,r.a.createElement(O.a,{className:"mx_CallEvent_content_button mx_CallEvent_content_button_reject",onClick:this.props.callEventGrouper.rejectCall,kind:"danger"},r.a.createElement("span",null," ",Object(b.a)("Decline")," ")),r.a.createElement(O.a,{className:"mx_CallEvent_content_button mx_CallEvent_content_button_answer",onClick:this.props.callEventGrouper.answerCall,kind:"primary"},r.a.createElement("span",null," ",Object(b.a)("Accept")," ")),this.props.timestamp)}if(e===w.e.Ended){const e=this.props.callEventGrouper.hangupReason;if(this.props.callEventGrouper.gotRejected)return r.a.createElement("div",{className:"mx_CallEvent_content"},Object(b.a)("Call declined"),this.renderCallBackButton(Object(b.a)("Call back")),this.props.timestamp);if([w.b.UserHangup,"user hangup"].includes(e)||!e){const e=this.props.callEventGrouper.duration;let t=Object(b.a)("Call ended");return e&&(t+=" • "+Object(k.a)(e)),r.a.createElement("div",{className:"mx_CallEvent_content"},t,this.props.timestamp)}if(e===w.b.InviteTimeout)return r.a.createElement("div",{className:"mx_CallEvent_content"},Object(b.a)("No answer"),this.renderCallBackButton(Object(b.a)("Call back")),this.props.timestamp);let t;return t=e===w.b.IceFailed?Object(b.a)("Could not connect media"):"ice_timeout"===e?Object(b.a)("Connection failed"):e===w.b.NoUserMedia?Object(b.a)("Their device couldn't start the camera or microphone"):"unknown_error"===e?Object(b.a)("An unknown error occurred"):e===w.b.UserBusy?Object(b.a)("The user you called is busy."):Object(b.a)("Unknown failure: %(reason)s",{reason:e}),r.a.createElement("div",{className:"mx_CallEvent_content"},r.a.createElement(R.b,{tooltip:t,className:"mx_CallEvent_content_tooltip",kind:R.a.Warning}),Object(b.a)("Connection failed"),this.renderCallBackButton(Object(b.a)("Retry")),this.props.timestamp)}return e===w.e.Connected?r.a.createElement("div",{className:"mx_CallEvent_content"},r.a.createElement(x.a,{seconds:this.state.length,"aria-live":"off"}),this.props.timestamp):e===w.e.Connecting?r.a.createElement("div",{className:"mx_CallEvent_content"},Object(b.a)("Connecting"),this.props.timestamp):e===C.b.Missed?r.a.createElement("div",{className:"mx_CallEvent_content"},Object(b.a)("Missed call"),this.renderCallBackButton(Object(b.a)("Call back")),this.props.timestamp):r.a.createElement("div",{className:"mx_CallEvent_content"},Object(b.a)("The call is in an unknown state!"),this.props.timestamp)}render(){const e=this.props.mxEvent,t=e.sender?e.sender.name:e.getSender(),n=this.props.callEventGrouper.isVoice,i=n?Object(b.a)("Voice call"):Object(b.a)("Video call"),s=this.state.callState,o=this.props.callEventGrouper.hangupReason,a=this.renderContent(s),c=p()("mx_CallEvent",{mx_CallEvent_voice:n,mx_CallEvent_video:!n,mx_CallEvent_narrow:this.state.narrow,mx_CallEvent_missed:s===C.b.Missed,mx_CallEvent_noAnswer:s===w.e.Ended&&o===w.b.InviteTimeout,mx_CallEvent_rejected:s===w.e.Ended&&this.props.callEventGrouper.gotRejected});let l;return this.state.narrow&&this.state.callState===w.e.Ringing&&(l=this.renderSilenceIcon()),r.a.createElement("div",{className:"mx_CallEvent_wrapper",ref:this.wrapperElement},r.a.createElement("div",{className:c},l,r.a.createElement("div",{className:"mx_CallEvent_info"},r.a.createElement(_.a,{member:e.sender,width:32,height:32}),r.a.createElement("div",{className:"mx_CallEvent_info_basic"},r.a.createElement("div",{className:"mx_CallEvent_sender"},t),r.a.createElement("div",{className:"mx_CallEvent_type"},r.a.createElement("div",{className:"mx_CallEvent_type_icon"}),i))),a))}}var j=n(287);class N extends r.a.Component{render(){var e;const t=j.b(this.props.mxEvent,!0,null===(e=this.context)||void 0===e?void 0:e.showHiddenEvents);return t?r.a.createElement("div",{className:"mx_TextualEvent"},t):null}}h()(N,"contextType",l.b);var P=n(100),D=n(135),A=n(164);var M=Object(o.forwardRef)((e,t)=>{let{mxEvent:n,timestamp:i}=e;const s=Object(o.useContext)(P.a),a=n.getRoomId(),c=v.a.get().isRoomEncrypted(a),l=n.getPrevContent(),d=n.getContent();if(!Object(A.c)(l,d))return null;if("m.megolm.v1.aes-sha2"===d.algorithm&&c){let e;const t=D.a.shared().getUserIdForRoomId(a);if("m.megolm.v1.aes-sha2"===l.algorithm)e=Object(b.a)("Some encryption parameters have been changed.");else if(t){var u,h;const n=(null==s||null===(u=s.getRoom(a))||void 0===u||null===(h=u.getMember(t))||void 0===h?void 0:h.rawDisplayName)||t;e=Object(b.a)("Messages here are end-to-end encrypted. Verify %(displayName)s in their profile - tap on their avatar.",{displayName:n})}else e=Object(b.a)("Messages in this room are end-to-end encrypted. When people join, you can verify them in their profile, just tap on their avatar.");return r.a.createElement(S.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(b.a)("Encryption enabled"),subtitle:e,timestamp:i})}return c?r.a.createElement(S.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(b.a)("Encryption enabled"),subtitle:Object(b.a)("Ignored attempt to disable encryption"),timestamp:i}):r.a.createElement(S.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon mx_cryptoEvent_icon_warning",title:Object(b.a)("Encryption not enabled"),subtitle:Object(b.a)("The encryption used by this room isn't supported."),ref:t,timestamp:i})}),U=n(92),L=n(96),F=n(132);class B extends r.a.Component{constructor(){super(...arguments),h()(this,"onLinkClicked",e=>{e.preventDefault();const t=this.props.mxEvent.getContent().predecessor;U.a.dispatch({action:L.a.ViewRoom,event_id:t.event_id,highlighted:!0,room_id:t.room_id,metricsTrigger:"Predecessor",metricsViaKeyboard:"click"!==e.type})})}render(){const e=this.props.mxEvent.getContent().predecessor;if(void 0===e)return r.a.createElement("div",null);const t=v.a.get().getRoom(e.room_id),n=new F.a(t,e.room_id);n.load();const i=n.forEvent(e.event_id),s=r.a.createElement("a",{href:i,onClick:this.onLinkClicked},Object(b.a)("Click here to see older messages."));return r.a.createElement(S.a,{className:"mx_CreateEvent",title:Object(b.a)("This room is a continuation of another conversation."),subtitle:s,timestamp:this.props.timestamp})}}var K=n(95),V=n(128),W=n(130),H=n(359);class q extends r.a.Component{constructor(){super(...arguments),h()(this,"onAvatarClick",()=>{const e=v.a.get(),t=this.props.mxEvent,n=Object(V.b)(t.getContent().url).srcHttp,i=e.getRoom(this.props.mxEvent.getRoomId()),s={src:n,name:Object(b.a)("%(senderDisplayName)s changed the avatar for %(roomName)s",{senderDisplayName:t.sender&&t.sender.name?t.sender.name:t.getSender(),roomName:i?i.name:""})};K.a.createDialog(H.a,s,"mx_Dialog_lightbox",null,!0)})}render(){const e=this.props.mxEvent,t=e.sender&&e.sender.name?e.sender.name:e.getSender();if(!e.getContent().url||0===e.getContent().url.trim().length)return r.a.createElement("div",{className:"mx_TextualEvent"},Object(b.a)("%(senderDisplayName)s removed the room avatar.",{senderDisplayName:t}));const n=v.a.get().getRoom(e.getRoomId()),i={avatarUrl:e.getContent().url,name:n?n.name:""};return r.a.createElement("div",{className:"mx_RoomAvatarEvent"},Object(b.a)("%(senderDisplayName)s changed the room avatar to <img/>",{senderDisplayName:t},{img:()=>r.a.createElement(O.a,{key:"avatar",className:"mx_RoomAvatarEvent_avatar",onClick:this.onAvatarClick},r.a.createElement(W.a,{width:14,height:14,oobData:i}))}))}}var $=n(184),G=n(426),z=n(0),J=n(146),Y=n(139);class Q extends r.a.Component{constructor(){super(...arguments),h()(this,"openRequest",()=>{const{verificationRequest:e}=this.props.mxEvent,t=v.a.get().getUser(e.otherUserId);Y.a.instance.setCards([{phase:J.a.RoomSummary},{phase:J.a.RoomMemberInfo,state:{member:t}},{phase:J.a.EncryptionPanel,state:{verificationRequest:e,member:t}}])}),h()(this,"onRequestChanged",()=>{this.forceUpdate()}),h()(this,"onAcceptClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{this.openRequest(),await e.accept()}catch(e){z.a.error(e.message)}}),h()(this,"onRejectClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{await e.cancel()}catch(e){z.a.error(e.message)}})}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on(g.m.Change,this.onRequestChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off(g.m.Change,this.onRequestChanged)}acceptedLabel(e){return e===v.a.get().getUserId()?Object(b.a)("You accepted"):Object(b.a)("%(name)s accepted",{name:Object(y.a)(e,this.props.mxEvent.getRoomId())})}cancelledLabel(e){const t=v.a.get().getUserId(),{cancellationCode:n}=this.props.mxEvent.verificationRequest,i="m.user"===n;return e===t?i?Object(b.a)("You declined"):Object(b.a)("You cancelled"):i?Object(b.a)("%(name)s declined",{name:Object(y.a)(e,this.props.mxEvent.getRoomId())}):Object(b.a)("%(name)s cancelled",{name:Object(y.a)(e,this.props.mxEvent.getRoomId())})}render(){const{mxEvent:e}=this.props,t=e.verificationRequest;if(!t||t.invalid)return null;let n,i,s;if(!t.canAccept){let e;t.ready||t.started||t.done?e=r.a.createElement(O.a,{onClick:this.openRequest},this.acceptedLabel(t.receivingUserId)):t.cancelled?e=this.cancelledLabel(t.cancellingUserId):t.accepting?e=Object(b.a)("Accepting …"):t.declining&&(e=Object(b.a)("Declining …")),s=r.a.createElement("div",{className:"mx_cryptoEvent_state"},e)}if(t.initiatedByMe)n=Object(b.a)("You sent a verification request"),i=Object(y.b)(t.receivingUserId,e.getRoomId());else{const o=Object(y.a)(t.requestingUserId,e.getRoomId());n=Object(b.a)("%(name)s wants to verify",{name:o}),i=Object(y.b)(t.requestingUserId,e.getRoomId()),t.canAccept&&(s=r.a.createElement("div",{className:"mx_cryptoEvent_buttons"},r.a.createElement(O.a,{kind:"danger",onClick:this.onRejectClicked},Object(b.a)("Decline")),r.a.createElement(O.a,{kind:"primary",onClick:this.onAcceptClicked},Object(b.a)("Accept"))))}return n?r.a.createElement(S.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:n,subtitle:i,timestamp:this.props.timestamp},s):null}}var X=n(181),Z=n(209);class ee extends r.a.PureComponent{constructor(e){super(e)}render(){var e;const t=this.props.mxEvent.getContent().url,n=this.props.mxEvent.getPrevContent().url,i=(null===(e=this.props.mxEvent.sender)||void 0===e?void 0:e.name)||this.props.mxEvent.getSender(),s=v.a.get().getRoom(this.props.mxEvent.getRoomId()),o=this.props.mxEvent.getStateKey(),a=Z.a.instance.getRoom(s.roomId,!0).widgets.find(e=>e.id===o);let c=Object(b.a)("Join the conference at the top of this room");return a&&$.d.instance.isInContainer(s,a,$.a.Right)?c=Object(b.a)("Join the conference from the room information card on the right"):a||(c=null),t?n?r.a.createElement(S.a,{className:"mx_MJitsiWidgetEvent",title:Object(b.a)("Video conference updated by %(senderName)s",{senderName:i}),subtitle:c,timestamp:this.props.timestamp}):r.a.createElement(S.a,{className:"mx_MJitsiWidgetEvent",title:Object(b.a)("Video conference started by %(senderName)s",{senderName:i}),subtitle:c,timestamp:this.props.timestamp}):r.a.createElement(S.a,{className:"mx_MJitsiWidgetEvent",title:Object(b.a)("Video conference ended by %(senderName)s",{senderName:i}),timestamp:this.props.timestamp})}}var te=n(153);var ne=r.a.forwardRef((e,t)=>{let n,{mxEvent:i}=e;const s=i.messageVisibility();switch(s.visible){case!0:throw new Error("HiddenBody should only be applied to hidden messages");case!1:n=s.reason?Object(b.a)("Message pending moderation: %(reason)s",{reason:s.reason}):Object(b.a)("Message pending moderation")}return r.a.createElement("span",{className:"mx_HiddenBody",ref:t},n)}),ie=n(120);class se extends r.a.PureComponent{constructor(e){super(e),h()(this,"onToggle",e=>{e.preventDefault();const{expanded:t}=this.state;this.setState({expanded:!t})}),this.state={expanded:!1}}componentDidMount(){const{mxEvent:e}=this.props;v.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()&&e.once(ie.MatrixEventEvent.Decrypted,()=>this.forceUpdate())}render(){const{mxEvent:e}=this.props,{expanded:t}=this.state;let n;n=t?r.a.createElement("pre",null,JSON.stringify(e,null,4)):r.a.createElement("code",null,`{ "type": ${e.getType()} }`);const i=p()("mx_ViewSourceEvent mx_EventTile_content",{mx_ViewSourceEvent_expanded:t});return r.a.createElement("span",{className:i},n,r.a.createElement(O.a,{kind:"link_inline",title:Object(b.a)("toggle event"),className:"mx_ViewSourceEvent_toggle",onClick:this.onToggle}))}}var oe=n(244);const re=(e,t)=>r.a.createElement(d.a,s()({ref:e},t)),ae=(e,t)=>r.a.createElement(E,s()({ref:e},t)),ce=(e,t)=>r.a.createElement(N,s()({ref:e},t)),le=(e,t)=>r.a.createElement(Q,s()({ref:e},t)),de=(e,t)=>r.a.createElement(ne,s()({ref:e},t)),ue=(e,t)=>r.a.createElement(ee,s()({ref:e},t)),he=(e,t)=>r.a.createElement(se,s()({ref:e},t)),me={[a.b.RoomMessage]:re,[a.b.Sticker]:re,[c.M_POLL_START.name]:re,[c.M_POLL_START.altName]:re,[a.b.KeyVerificationCancel]:ae,[a.b.KeyVerificationDone]:ae,[a.b.CallInvite]:(e,t)=>r.a.createElement(T,s()({ref:e},t))},pe={[a.b.RoomEncryption]:(e,t)=>r.a.createElement(M,s()({ref:e},t)),[a.b.RoomCanonicalAlias]:ce,[a.b.RoomCreate]:(e,t)=>r.a.createElement(B,s()({ref:e},t)),[a.b.RoomMember]:ce,[a.b.RoomName]:ce,[a.b.RoomAvatar]:(e,t)=>r.a.createElement(q,s()({ref:e},t)),[a.b.RoomThirdPartyInvite]:ce,[a.b.RoomHistoryVisibility]:ce,[a.b.RoomTopic]:ce,[a.b.RoomPowerLevels]:ce,[a.b.RoomPinnedEvents]:ce,[a.b.RoomServerAcl]:ce,"im.vector.modular.widgets":ce,[$.c]:ce,[a.b.RoomTombstone]:ce,[a.b.RoomJoinRules]:ce,[a.b.RoomGuestAccess]:ce};for(const e of G.a)pe[e]=ce;const ge=new Set([a.b.RoomEncryption,a.b.RoomCanonicalAlias,a.b.RoomCreate,a.b.RoomName,a.b.RoomAvatar,a.b.RoomHistoryVisibility,a.b.RoomTopic,a.b.RoomPowerLevels,a.b.RoomPinnedEvents,a.b.RoomServerAcl,$.c,a.b.RoomTombstone,a.b.RoomJoinRules,a.b.RoomGuestAccess]);function fe(e,t,n,i){var s;const o=e.getType();if(i&&n)return he;const r=()=>n?he:void 0;if(Object(te.h)(e,t)===te.a.HIDDEN_TO_CURRENT_USER)return de;if(o===a.b.RoomMessage){const n=e.getContent();if((null==n?void 0:n.msgtype)===a.c.KeyVerificationRequest){const i=t.getUserId();return e.getSender()!==i&&n.to!==i?r():le}}else if(o===a.b.KeyVerificationDone){const n=t.getUserId();if(e.getSender()!==n)return r()}if((o===a.b.KeyVerificationCancel||o===a.b.KeyVerificationDone)&&!E.shouldRender(e,e.verificationRequest))return r();if("im.vector.modular.widgets"===o){let t=e.getContent().type;if(t||(t=e.getPrevContent().type),X.a.JITSI.matches(t))return ue}var c,l,d;return e.isState()?(l=e,oe.b.matches(l.getType())&&null!==(d=l.getContent())&&void 0!==d&&d.live?re:ge.has(o)&&""!==e.getStateKey()?r():null!==(c=pe[o])&&void 0!==c?c:r()):e.isRedacted()?re:e.isRelation(a.d.Replace)?r():null!==(s=me[o])&&void 0!==s?s:r()}function ve(e,t,n,i){var s;i=null!==(s=i)&&void 0!==s?s:v.a.get();const o=fe(t.mxEvent,i,n);if(!o)return;const{ref:r,mxEvent:a,forExport:c,replacingEventId:d,editState:u,highlights:h,highlightLink:m,showUrlPreview:p,permalinkCreator:g,onHeightChanged:f,callEventGrouper:b,getRelationsForEvent:y,isSeeingThroughMessageHiddenForModeration:S,timestamp:E}=t;switch(e){case l.a.File:case l.a.Notification:case l.a.Thread:return o(t.ref,{mxEvent:a,highlights:h,highlightLink:m,showUrlPreview:p,onHeightChanged:f,editState:u,replacingEventId:d,getRelationsForEvent:y,isSeeingThroughMessageHiddenForModeration:S,permalinkCreator:g});default:return o(r,{mxEvent:a,forExport:c,replacingEventId:d,editState:u,highlights:h,highlightLink:m,showUrlPreview:p,permalinkCreator:g,onHeightChanged:f,callEventGrouper:b,getRelationsForEvent:y,isSeeingThroughMessageHiddenForModeration:S,timestamp:E})}}function be(e,t,n){var i;n=null!==(i=n)&&void 0!==i?i:v.a.get();const s=fe(e.mxEvent,n,t);if(!s)return;const{ref:o,mxEvent:r,highlights:a,highlightLink:c,onHeightChanged:l,showUrlPreview:d,overrideBodyTypes:u,overrideEventTypes:h,replacingEventId:m,maxImageHeight:p,getRelationsForEvent:g,isSeeingThroughMessageHiddenForModeration:f,permalinkCreator:b}=e;return s(o,{mxEvent:r,highlights:a,highlightLink:c,onHeightChanged:l,showUrlPreview:d,overrideBodyTypes:u,overrideEventTypes:h,replacingEventId:m,maxImageHeight:p,getRelationsForEvent:g,isSeeingThroughMessageHiddenForModeration:f,permalinkCreator:b})}const ye=[a.b.RoomMessage,a.b.Sticker];function Se(e){return ye.includes(e.getType())||c.M_POLL_START.matches(e.getType())}function Ee(e,t){if(e.isRedacted()&&!e.isEncrypted()&&!Se(e)&&!e.isState())return!1;if(e.isRelation(a.d.Replace))return!1;const n=fe(e,v.a.get(),t);return!!n&&(n===ce?Object(j.a)(e,t):n===pe[a.b.RoomCreate]?Boolean(e.getContent().predecessor):n!==he)}},function(e,t,n){"use strict";n.d(t,"d",(function(){return i.a})),n.d(t,"f",(function(){return o})),n.d(t,"g",(function(){return r})),n.d(t,"a",(function(){return a.a})),n.d(t,"e",(function(){return a.b})),n.d(t,"c",(function(){return c.c})),n.d(t,"h",(function(){return c.d})),n.d(t,"b",(function(){return c.b})),n.d(t,"i",(function(){return l.a}));var i=n(501),s=n(18);const o=e=>{var t;const n=s.b.findIn(e);return(null!==(t=null==n?void 0:n.type)&&void 0!==t?t:s.a.Self)==s.a.Self},r=e=>{const t=e.getContent(),n=s.c.findIn(t);return n?n.uri:t.geo_uri};var a=n(398),c=n(502),l=n(504)},function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var i=n(17),s=n.n(i),o=n(143);let r;!function(e){e.DisplayName="User.displayName",e.AvatarUrl="User.avatarUrl",e.Presence="User.presence",e.CurrentlyActive="User.currentlyActive",e.LastPresenceTs="User.lastPresenceTs"}(r||(r={}));class a extends o.b{constructor(e){super(),this.userId=e,s()(this,"modified",void 0),s()(this,"displayName",void 0),s()(this,"rawDisplayName",void 0),s()(this,"avatarUrl",void 0),s()(this,"presenceStatusMsg",null),s()(this,"presence","offline"),s()(this,"lastActiveAgo",0),s()(this,"lastPresenceTs",0),s()(this,"currentlyActive",!1),s()(this,"events",{presence:null,profile:null}),this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.updateModifiedTime()}setPresenceEvent(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const n=[];(e.getContent().presence!==this.presence||t)&&n.push(r.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push(r.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push(r.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&n.push(r.CurrentlyActive),this.presence=e.getContent().presence,n.push(r.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(let t=0;t<n.length;t++)this.emit(n[t],e,this)}setDisplayName(e){const t=this.displayName;this.displayName="string"==typeof e?e:void 0,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName="string"==typeof e?e:void 0}setAvatarUrl(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}},,function(e,t,n){"use strict";let i,s,o;n.d(t,"d",(function(){return i})),n.d(t,"g",(function(){return s})),n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return r})),n.d(t,"h",(function(){return a})),n.d(t,"a",(function(){return c})),n.d(t,"e",(function(){return l})),n.d(t,"f",(function(){return d})),function(e){e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce"}(i||(i={})),function(e){e.Highlight="highlight",e.Sound="sound"}(s||(s={})),function(e){e.ExactEquals="==",e.LessThan="<",e.GreaterThan=">",e.GreaterThanOrEqual=">=",e.LessThanOrEqual="<="}(o||(o={}));const r="2";function a(e){return"==2"===e||"2"===e}let c,l,d;!function(e){e.EventMatch="event_match",e.ContainsDisplayName="contains_display_name",e.RoomMemberCount="room_member_count",e.SenderNotificationPermission="sender_notification_permission"}(c||(c={})),function(e){e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride"}(l||(l={})),function(e){e.Master=".m.rule.master",e.ContainsDisplayName=".m.rule.contains_display_name",e.ContainsUserName=".m.rule.contains_user_name",e.AtRoomNotification=".m.rule.roomnotif",e.DM=".m.rule.room_one_to_one",e.EncryptedDM=".m.rule.encrypted_room_one_to_one",e.Message=".m.rule.message",e.EncryptedMessage=".m.rule.encrypted",e.InviteToSelf=".m.rule.invite_for_me",e.MemberEvent=".m.rule.member_event",e.IncomingCall=".m.rule.call",e.SuppressNotices=".m.rule.suppress_notices",e.Tombstone=".m.rule.tombstone"}(d||(d={}))},function(e,t,n){"use strict";n.d(t,"j",(function(){return d})),n.d(t,"k",(function(){return u})),n.d(t,"a",(function(){return h})),n.d(t,"i",(function(){return m})),n.d(t,"h",(function(){return p})),n.d(t,"g",(function(){return g})),n.d(t,"e",(function(){return f})),n.d(t,"d",(function(){return v})),n.d(t,"f",(function(){return b})),n.d(t,"b",(function(){return y})),n.d(t,"c",(function(){return S})),n.d(t,"m",(function(){return E})),n.d(t,"l",(function(){return w}));var i=n(17),s=n.n(i),o=n(0),r=n(316),a=n(369),c=n(143);const l="m.key.verification.",d=l+"request",u=l+"start",h=l+"cancel",m=l+"ready";let p;!function(e){e[e.Unsent=1]="Unsent",e[e.Requested=2]="Requested",e[e.Ready=3]="Ready",e[e.Started=4]="Started",e[e.Cancelled=5]="Cancelled",e[e.Done=6]="Done"}(p||(p={}));const g=p.Unsent,f=p.Requested,v=p.Ready,b=p.Started,y=p.Cancelled,S=p.Done;let E;!function(e){e.Change="change"}(E||(E={}));class w extends c.b{constructor(e,t,n){super(),this.channel=e,this.verificationMethods=t,this.client=n,s()(this,"eventsByUs",new Map),s()(this,"eventsByThem",new Map),s()(this,"_observeOnly",!1),s()(this,"timeoutTimer",null),s()(this,"_accepting",!1),s()(this,"_declining",!1),s()(this,"verifierHasFinished",!1),s()(this,"_cancelled",!1),s()(this,"_chosenMethod",null),s()(this,"_qrCodeData",null),s()(this,"requestReceivedAt",null),s()(this,"commonMethods",[]),s()(this,"_phase",void 0),s()(this,"_cancellingUserId",void 0),s()(this,"_verifier",void 0),s()(this,"cancelOnTimeout",async()=>{try{this.initiatedByMe?await this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):await this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){o.a.error("Error while cancelling verification request",e)}}),this.channel.request=this,this.setPhase(g,!1)}static validateEvent(e,t,n){const i=t.getContent();return!(!e||!e.startsWith(l))&&(i?e!==d&&e!==m||Array.isArray(i.methods)?e!==d&&e!==m&&e!==u||"string"==typeof i.from_device&&0!==i.from_device.length||(o.a.log("VerificationRequest: validateEvent: fail because from_device"),!1):(o.a.log("VerificationRequest: validateEvent: fail because methods"),!1):(o.a.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return this.phase===g}get requested(){return this.phase===f}get cancelled(){return this.phase===y}get ready(){return this.phase===v}get started(){return this.phase===b}get done(){return this.phase===S}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=f){const e=this.requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this.getEventByEither(d);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(d)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<v&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==S&&this._phase!==y}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(e){if(!(arguments.length>1&&void 0!==arguments[1]&&arguments[1])&&!this.ready&&!this.started)return!1;const t=this.eventsByThem.get(d)||this.eventsByThem.get(m);if(!t){if(this.started&&this.initiatedByMe){const t=this.eventsByUs.get(u),n=t&&t.getContent();return e==(n&&n.method)}return!1}const n=t.getContent();if(!n)return!1;const{methods:i}=n;return!!Array.isArray(i)&&i.includes(e)}get initiatedByMe(){const e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===g&&e)return!0;const t=this.eventsByUs.has(d),n=this.eventsByThem.has(d);if(t&&!n)return!0;if(!t&&n)return!1;const i=this.eventsByUs.has(u),s=this.eventsByThem.has(u);return!(!i||s)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this.eventsByUs.get(h),t=this.eventsByThem.get(h);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this.getEventByEither(h);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=(this.eventsByThem.get(d)||this.eventsByThem.get(m)||this.eventsByThem.get(u)).getContent().from_device;return{userId:this.otherUserId,deviceId:e}}beginKeyVerification(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.observeOnly&&!this._verifier){if(this.phase===f||this.phase===v||this.phase===g&&this.channel.canCreateRequest(u)){if(this.commonMethods.length&&!this.commonMethods.includes(e))throw Object(r.g)();if(this._verifier=this.createVerifier(e,null,t),!this._verifier)throw Object(r.g)();this._chosenMethod=e}}return this._verifier}async sendRequest(){if(!this.observeOnly&&this._phase===g){const e=[...this.verificationMethods.keys()];await this.channel.send(d,{methods:e})}}async cancel(){let{reason:e="User declined",code:t="m.user"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.observeOnly&&this._phase!==y){if(this._declining=!0,this.emit(E.Change),this._verifier)return this._verifier.cancel(Object(r.a)(t,e)());this._cancellingUserId=this.client.getUserId(),await this.channel.send(h,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===f&&!this.initiatedByMe){const e=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(E.Change),await this.channel.send(m,{methods:e})}}waitFor(e){return new Promise((t,n)=>{const i=()=>{let s=!1;return e(this)?(t(this),s=!0):this.cancelled&&(n(new Error("cancelled")),s=!0),s&&this.off(E.Change,i),s};i()||this.on(E.Change,i)})}setPhase(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._phase=e,t&&this.emit(E.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1]?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){const e=[{phase:g}],t=()=>e[e.length-1].phase,n=this.eventsByThem.has(d),i=this.getEventBy(d,n);i&&e.push({phase:f,event:i});const s=i&&this.getEventBy(m,!n);let o;if(s&&t()===f&&e.push({phase:v,event:s}),s||!i){const e=this.eventsByThem.get(u),t=this.eventsByUs.get(u);o=e&&t?e.getSender()<t.getSender()?e:t:e||t}else o=this.getEventBy(u,!n);if(o){const n=t()===f&&i.getSender()!==o.getSender(),s=t()===g&&this.channel.canCreateRequest(u);(n||t()===v||s)&&e.push({phase:b,event:o})}const r=this.eventsByUs.get("m.key.verification.done");(this.verifierHasFinished||r&&t()===b)&&e.push({phase:S});const a=this.getEventByEither(h);return(this._cancelled||a)&&t()!==S?(e.push({phase:y,event:a}),e):e}transitionToPhase(e){const{phase:t,event:n}=e;if((t===f||t===v)&&!this.wasSentByOwnDevice(n)){const e=n.getContent();this.commonMethods=e.methods.filter(e=>this.verificationMethods.has(e))}if(this.observeOnly||t!==f&&t!==b&&t!==v||this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(n)&&!this.wasSentByOwnDevice(n)&&(this._observeOnly=!0),t===b){const{method:e}=n.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(e,n),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:"Unknown method: "+e}))}}applyPhaseTransitions(){const e=this.calculatePhaseTransitions(),t=e.findIndex(e=>e.phase===this.phase),n=e.slice(t+1);for(const e of n)this.transitionToPhase(e);return n}isWinningStartRace(e){if(e.getType()!==u)return!1;const t=this._verifier.startEvent;let n,i;if(this.isSelfVerification)if(t){const e=t.getContent();n=e&&e.from_device}else n=this.client.getDeviceId();else n=t?t.getSender():this.client.getUserId();if(this.isSelfVerification){const t=e.getContent();i=t&&t.from_device}else i=e.getSender();return i<n}hasEventId(e){for(const t of this.eventsByUs.values())if(t.getId()===e)return!0;for(const t of this.eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,n,i,s){if(this.done||this.cancelled)return;const r=this._observeOnly;if(this.adjustObserveOnly(t,n),!this.observeOnly&&!i&&await this.cancelOnError(e,t))return;if(s?this.eventsByUs.has(e):this.eventsByThem.has(e))return;const c=this.phase;this.addEvent(e,t,s);const l=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const n=this.isWinningStartRace(t);if(this._verifier.canSwitchStartEvent(t)&&n)this._verifier.switchStartEvent(t);else if(!i){var d;(e===h||null!==(d=this._verifier.events)&&void 0!==d&&d.includes(e))&&this._verifier.handleEvent(t)}}if(l.length){if(n&&l.some(e=>e.phase===v)){this.otherPartySupportsMethod(a.d,!0)&&(this._qrCodeData=await a.a.create(this,this.client))}const e=l[l.length-1],{phase:t}=e;this.setupTimeout(t),this.setPhase(t)}else this._observeOnly!==r&&this.emit(E.Change)}finally{o.a.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${s}, isLiveEvent:${n}, isRemoteEcho:${i}, phase:${c}=>${this.phase}, observeOnly:${r}=>${this._observeOnly}`)}}setupTimeout(e){if(!this.timeoutTimer&&!this.observeOnly&&e===f&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){(e===b||e===v||e===S||e===y)&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}async cancelOnError(e,t){if(e===u){const e=t.getContent().method;if(!this.verificationMethods.has(e))return await this.cancel(Object(r.b)(Object(r.g)())),!0}const n=e===d&&this.phase!==g,i=e===m&&this.phase!==f&&this.phase!==b;if(this.phase!==g&&(n||i)){o.a.warn(`Cancelling, unexpected ${e} verification event from `+t.getSender());const n=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel(Object(r.b)(Object(r.f)({reason:n}))),!0}return!1}adjustObserveOnly(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}addEvent(e,t){if(arguments.length>2&&void 0!==arguments[2]&&arguments[2]?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===d){for(const[e,t]of this.eventsByThem.entries())t.getSender()!==this.otherUserId&&this.eventsByThem.delete(e);this.requestReceivedAt=Date.now()}}createVerifier(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;n||(n=this.targetDevice);const{userId:i,deviceId:s}=n,r=this.verificationMethods.get(e);if(r)return new r(this.channel,this.client,i,s,t,this);o.a.warn("could not find verifier constructor for method",e)}wasSentByOwnUser(e){return e.getSender()===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send("m.key.verification.done",{}),this.verifierHasFinished=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}},,function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"f",(function(){return c})),n.d(t,"h",(function(){return l})),n.d(t,"d",(function(){return d})),n.d(t,"g",(function(){return u})),n.d(t,"a",(function(){return h})),n.d(t,"e",(function(){return m}));var i=n(3),s=n(90);const o=new i.b("m.tile_server","org.matrix.msc3488.tile_server");function r(){const e=s.a.get().getClientWellKnown();return null==e?void 0:e["io.element.call_behaviour"]}function a(){const e=s.a.get().getClientWellKnown();return e&&e["io.element.e2ee"]?e["io.element.e2ee"]:e&&e["im.vector.riot.e2ee"]?e["im.vector.riot.e2ee"]:null}function c(){return l(s.a.get().getClientWellKnown())}function l(e){var t;return null!==(t=null==e?void 0:e[o.name])&&void 0!==t?t:null==e?void 0:e[o.altName]}function d(){var e,t;return null==(t=null===(e=s.a.get())||void 0===e?void 0:e.getClientWellKnown())?void 0:t["io.element.embedded_pages"]}function u(){const e=a();return e&&!0===e.secure_backup_required}let h;function m(){const e=a();return e&&e.secure_backup_setup_methods&&e.secure_backup_setup_methods.length&&(e.secure_backup_setup_methods.includes(h.Key)||e.secure_backup_setup_methods.includes(h.Passphrase))?e.secure_backup_setup_methods:[h.Key,h.Passphrase]}!function(e){e.Key="key",e.Passphrase="passphrase"}(h||(h={}))},,function(e,t,n){"use strict";t.a={getDisplayUserIdentifier:function(e,t){let{roomId:n,withDisplayName:i}=t;return e}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(87),s=n.n(i),o=n(94),r=n.n(o),a=n(89);t.b=e=>{let{className:t,actionLabel:n,onBack:o,onAction:c,children:l}=e;const[d,u]=Object(i.useState)(null);let h;if(d)l=d;else if(c){const e=()=>{c().then(e=>{"string"==typeof e&&u(e)})};h=s.a.createElement("button",{onClick:e},n)}return s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:r()("mx_DevTools_content",t)},l),s.a.createElement("div",{className:"mx_Dialog_buttons"},s.a.createElement("button",{onClick:()=>{d?u(null):o()}},Object(a.a)("Back")),h))};const c=Object(i.createContext)({})},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i=n(88),s=n.n(i),o=n(0),r=n(119),a=n(116),c=n(167),l=n(92),d=n(336),u=n(337),h=n(142),m=n(181),p=n(123);class g extends c.a{constructor(){var e;super(l.a,{}),e=this,s()(this,"widgetMap",new Map),s()(this,"roomMap",new Map),s()(this,"onWidgetEchoStoreUpdate",(e,t)=>{this.initRoom(e),this.loadRoomWidgets(this.matrixClient.getRoom(e)),this.emit(p.b,e)}),s()(this,"onRoom",e=>{this.initRoom(e.roomId),this.loadRoomWidgets(e),this.emit(p.b,e.roomId)}),s()(this,"onRoomStateEvents",e=>{if("im.vector.modular.widgets"!==e.getType())return;const t=e.getRoomId();this.initRoom(t),this.loadRoomWidgets(this.matrixClient.getRoom(t)),this.emit(p.b,t)}),s()(this,"getRoom",(function(t){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return n&&e.initRoom(t),e.roomMap.get(t)})),d.a.on("update",this.onWidgetEchoStoreUpdate)}static get instance(){return g.internalInstance}initRoom(e){this.roomMap.has(e)||this.roomMap.set(e,{widgets:[]})}async onReady(){this.matrixClient.on(r.b.Room,this.onRoom),this.matrixClient.on(a.b.Events,this.onRoomStateEvents),this.matrixClient.getRooms().forEach(e=>{this.loadRoomWidgets(e)}),this.emit(p.b,null)}async onNotReady(){this.matrixClient.off(r.b.Room,this.onRoom),this.matrixClient.off(a.b.Events,this.onRoomStateEvents),this.widgetMap=new Map,this.roomMap=new Map,await this.reset({})}async onAction(e){}generateApps(e){return d.a.getEchoedRoomWidgets(e.roomId,h.a.getRoomWidgets(e)).map(e=>h.a.makeAppConfig(e.getStateKey(),e.getContent(),e.getSender(),e.getRoomId(),e.getId()))}loadRoomWidgets(e){if(!e)return;const t=this.roomMap.get(e.roomId)||{};t.widgets=[],Array.from(this.widgetMap.values()).forEach(t=>{t.roomId===e.roomId&&this.widgetMap.delete(h.a.getWidgetUid(t))});let n=!1;this.generateApps(e).forEach(e=>{const i=this.widgetMap.get(h.a.getWidgetUid(e));i&&o.a.warn(`Possible widget ID conflict for ${e.id} - wants to store in room ${e.roomId} but is currently stored as ${i.roomId} - letting the want win`),this.widgetMap.set(h.a.getWidgetUid(e),e),t.widgets.push(e),n=!0}),n&&!this.roomMap.has(e.roomId)&&this.roomMap.set(e.roomId,t);const i=u.b.instance.getPersistentWidgetId();i&&u.b.instance.getPersistentRoomId()===e.roomId&&!t.widgets.some(e=>e.id===i)&&(o.a.log(`Persistent widget ${i} removed from room ${e.roomId}: destroying.`),u.b.instance.destroyPersistentWidget(i,e.roomId)),this.emit(e.roomId)}getApps(e){const t=this.getRoom(e);return(null==t?void 0:t.widgets)||[]}doesRoomHaveConference(e){const t=this.getRoom(e.roomId);if(!t)return!1;const n=t.widgets.filter(e=>m.a.JITSI.matches(e.type)),i=d.a.roomHasPendingWidgetsOfType(e.roomId,[],m.a.JITSI);return n.length>0||i}isJoinedToConferenceIn(e){const t=this.getRoom(e.roomId);if(!t)return!1;return t.widgets.filter(e=>m.a.JITSI.matches(e.type)).some(t=>u.b.instance.getWidgetPersistence(t.id,e.roomId))}}s()(g,"internalInstance",new g),window.mxWidgetStore=g.instance},function(e,t,n){"use strict";n.d(t,"a",(function(){return E}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(88),c=n.n(a),l=n(87),d=n.n(l),u=n(94),h=n.n(u),m=n(175),p=n(93),g=n(91),f=n(190),v=n(140),b=n(89),y=n(168);const S=["notification","showUnsentTooltip","forceCount","roomId","onClick"];class E extends d.a.PureComponent{constructor(e){super(e),c()(this,"countWatcherRef",void 0),c()(this,"countPreferenceChanged",()=>{this.setState({showCounts:p.b.getValue("Notifications.alwaysShowBadgeCounts",this.roomId)})}),c()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),c()(this,"onMouseOver",e=>{e.stopPropagation(),this.setState({showTooltip:!0})}),c()(this,"onMouseLeave",()=>{this.setState({showTooltip:!1})}),this.props.notification.on(f.b.Update,this.onNotificationUpdate),this.state={showCounts:p.b.getValue("Notifications.alwaysShowBadgeCounts",this.roomId),showTooltip:!1},this.countWatcherRef=p.b.watchSetting("Notifications.alwaysShowBadgeCounts",this.roomId,this.countPreferenceChanged)}get roomId(){return this.props.roomId||null}componentWillUnmount(){p.b.unwatchSetting(this.countWatcherRef),this.props.notification.off(f.b.Update,this.onNotificationUpdate)}componentDidUpdate(e){e.notification&&e.notification.off(f.b.Update,this.onNotificationUpdate),this.props.notification.on(f.b.Update,this.onNotificationUpdate)}render(){const e=this.props,{notification:t,showUnsentTooltip:n,forceCount:i,roomId:o,onClick:a}=e,c=r()(e,S);if(t.isIdle)return null;let l=!(t.symbol||t.count>0)||!t.hasUnreadCount;if(i&&(l=!1,!t.hasUnreadCount))return null;let u=t.symbol||Object(m.c)(t.count);l&&(u="");const p=h()({mx_NotificationBadge:!0,mx_NotificationBadge_visible:!!l||t.hasUnreadCount,mx_NotificationBadge_highlighted:t.hasMentions,mx_NotificationBadge_dot:l,mx_NotificationBadge_2char:u.length>0&&u.length<3,mx_NotificationBadge_3char:u.length>2});if(a){let e,i;return n&&this.state.showTooltip&&t.color===y.a.Unsent&&(e=Object(b.a)("Message didn't send. Click for info."),i=d.a.createElement(v.b,{className:"mx_RoleButton_tooltip",label:e})),d.a.createElement(g.a,s()({"aria-label":e},c,{className:p,onClick:a,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave}),d.a.createElement("span",{className:"mx_NotificationBadge_count"},u),i)}return d.a.createElement("div",{className:p},d.a.createElement("span",{className:"mx_NotificationBadge_count"},u))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(94),d=n.n(l),u=n(236);const h=["class","children","tooltip","tooltipClass","tooltipProps"];class m extends c.a.Component{constructor(e){super(e)}render(){const e=this.props,{class:t,children:n,tooltip:i,tooltipClass:o,tooltipProps:a}=e,l=r()(e,h);return c.a.createElement(u.a,s()({onClick:this.props.onClick,tooltipTargetClassName:d()("mx_TextWithTooltip_target",t)},a,{label:i,tooltipClassName:o,className:"mx_TextWithTooltip_tooltip"},l),n)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(89),d=n(101),u=n(110);class h extends r.a.Component{constructor(){super(...arguments),s()(this,"onFinished",()=>{this.props.onFinished()})}render(){return r.a.createElement(d.a,{className:"mx_InfoDialog",onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",hasCancel:this.props.hasCloseButton,onKeyDown:this.props.onKeyDown,fixedWidth:this.props.fixedWidth},r.a.createElement("div",{className:c()("mx_Dialog_content",this.props.className),id:"mx_Dialog_content"},this.props.description),!1!==this.props.button&&r.a.createElement(u.a,{primaryButton:this.props.button||Object(l.a)("OK"),onPrimaryButtonClick:this.onFinished,hasCancel:!1}))}}s()(h,"defaultProps",{title:"",description:"",hasCloseButton:!1})},function(e,t,n){"use strict";n.d(t,"d",(function(){return N})),n.d(t,"b",(function(){return P})),n.d(t,"k",(function(){return D})),n.d(t,"e",(function(){return A})),n.d(t,"g",(function(){return M})),n.d(t,"c",(function(){return U})),n.d(t,"i",(function(){return L})),n.d(t,"f",(function(){return F})),n.d(t,"h",(function(){return B})),n.d(t,"a",(function(){return K})),n.d(t,"j",(function(){return V}));var i=n(87),s=n.n(i),o=n(97),r=n(125),a=n(132),c=n(95),l=n(523),d=n(183),u=n(89),h=n(748),m=n(212),p=n(193),g=n(0),f=n(101),v=n(91),b=n(100),y=n(265),S=n(131),E=n(528),w=n(343),_=n(746);var C=e=>{var t;let{space:n,onAddExistingSpaceClick:o,onFinished:a}=e;const[c,l]=Object(i.useState)(n),[d,h]=Object(i.useState)(!1),[m,p]=Object(i.useState)(""),C=Object(i.useRef)(),[O,R]=Object(i.useState)(""),I=Object(i.useRef)(),[k,x]=Object(i.useState)(null),[T,j]=Object(i.useState)(""),N=!(null===(t=S.a.instance.restrictedJoinRuleSupport)||void 0===t||!t.preferred),P=n.getJoinRule();let D=r.c.Invite;P===r.c.Public?D=r.c.Public:N&&(D=r.c.Restricted);const[A,M]=Object(i.useState)(D),U=async e=>{if(e.preventDefault(),!d){if(h(!0),!await C.current.validate({allowEmpty:!1}))return C.current.focus(),C.current.validate({allowEmpty:!1,focused:!0}),void h(!1);if(A===r.c.Public&&!await I.current.validate({allowEmpty:!0}))return I.current.focus(),I.current.validate({allowEmpty:!0,focused:!0}),void h(!1);try{await Object(E.c)(m,A===r.c.Public,O,T,k,{},{parentSpace:c,joinRule:A}),a(!0)}catch(e){g.a.error(e)}}};let L;return A===r.c.Restricted?L=s.a.createElement("p",null,Object(u.a)("Anyone in <SpaceName/> will be able to find and join.",{},{SpaceName:()=>s.a.createElement("b",null,c.name)})):A===r.c.Public?L=s.a.createElement("p",null,Object(u.a)("Anyone will be able to find and join this space, not just members of <SpaceName/>.",{},{SpaceName:()=>s.a.createElement("b",null,c.name)})):A===r.c.Invite&&(L=s.a.createElement("p",null,Object(u.a)("Only people invited will be able to find and join this space."))),s.a.createElement(f.a,{title:s.a.createElement(w.c,{title:Object(u.a)("Create a space"),space:n,value:c,onChange:l}),className:"mx_CreateSubspaceDialog",contentId:"mx_CreateSubspaceDialog",onFinished:a,fixedWidth:!1},s.a.createElement(b.a.Provider,{value:n.client},s.a.createElement("div",{className:"mx_CreateSubspaceDialog_content"},s.a.createElement("div",{className:"mx_CreateSubspaceDialog_betaNotice"},s.a.createElement(y.a,null),Object(u.a)("Add a space to a space you manage.")),s.a.createElement(E.a,{busy:d,onSubmit:U,setAvatar:x,name:m,setName:p,nameFieldRef:C,topic:T,setTopic:j,alias:O,setAlias:R,showAliasField:A===r.c.Public,aliasFieldRef:I},s.a.createElement(_.a,{label:Object(u.a)("Space visibility"),labelInvite:Object(u.a)("Private space (invite only)"),labelPublic:Object(u.a)("Public space"),labelRestricted:N?Object(u.a)("Visible to space members"):void 0,width:478,value:A,onChange:M}),L)),s.a.createElement("div",{className:"mx_CreateSubspaceDialog_footer"},s.a.createElement("div",{className:"mx_CreateSubspaceDialog_footer_prompt"},s.a.createElement("div",null,Object(u.a)("Want to add an existing space instead?")),s.a.createElement(v.a,{kind:"link",onClick:()=>{o(),a()}},Object(u.a)("Add existing space"))),s.a.createElement(v.a,{kind:"primary_outline",disabled:d,onClick:()=>a(!1)},Object(u.a)("Cancel")),s.a.createElement(v.a,{kind:"primary",disabled:d,onClick:U},d?Object(u.a)("Adding..."):Object(u.a)("Add")))))};var O=e=>{let{space:t,onCreateSubspaceClick:n,onFinished:o}=e;const[r,a]=Object(i.useState)(t);return s.a.createElement(f.a,{title:s.a.createElement(w.c,{title:Object(u.a)("Add existing space"),space:t,value:r,onChange:a}),className:"mx_AddExistingToSpaceDialog",contentId:"mx_AddExistingToSpace",onFinished:o,fixedWidth:!1},s.a.createElement(b.a.Provider,{value:t.client},s.a.createElement(w.a,{space:t,onFinished:o,footerPrompt:s.a.createElement(s.a.Fragment,null,s.a.createElement("div",null,Object(u.a)("Want to add a new space instead?")),s.a.createElement(v.a,{onClick:n,kind:"link"},Object(u.a)("Create a new space"))),filterPlaceholder:Object(u.a)("Search for spaces"),spacesRenderer:w.g})))},R=n(92),I=n(129),k=n(96),x=n(102),T=n(185),j=n(122);const N=e=>{const t=e.client.getUserId();return"join"===e.getMyMembership()&&(e.currentState.maySendStateEvent(o.b.RoomAvatar,t)||e.currentState.maySendStateEvent(o.b.RoomName,t)||e.currentState.maySendStateEvent(o.b.RoomTopic,t)||e.currentState.maySendStateEvent(o.b.RoomJoinRules,t))},P=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return{type:o.b.SpaceParent,content:{via:Object(a.b)(e),canonical:t},state_key:e.roomId}};function D(e){R.a.dispatch({action:k.a.OpenSpaceSettings,space:e})}const A=e=>{R.a.dispatch({action:k.a.OpenAddToExistingSpaceDialog,space:e})},M=async(e,t)=>{const n=c.a.createTrackedDialog("Space Landing","Create Room",l.a,{type:t,defaultPublic:e.getJoinRule()===r.c.Public,parentSpace:e}),[i,s]=await n.finished;return i&&await Object(d.b)(s),i},U=e=>("join"===(null==e?void 0:e.getMyMembership())&&e.canInvite(e.client.getUserId())||e.getJoinRule()===r.c.Public)&&Object(T.a)(j.a.InviteUsers),L=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if("public"===e.getJoinRule()){const t=c.a.createTrackedDialog("Space Invite","User Menu",m.a,{title:Object(u.a)("Invite to %(spaceName)s",{spaceName:e.name}),description:s.a.createElement(s.a.Fragment,null,s.a.createElement("span",null,Object(u.a)("Share your public space")),s.a.createElement(h.a,{space:e,onFinished:()=>t.close()})),fixedWidth:!1,button:!1,className:"mx_SpacePanel_sharePublicSpace",hasCloseButton:!0})}else Object(p.e)(e.roomId,t)},F=e=>{c.a.createTrackedDialog("Space Landing","Create Subspace",O,{space:e,onCreateSubspaceClick:()=>B(e),onFinished:t=>{t&&I.a.instance.getRoomId()===e.roomId&&R.a.fire(k.a.UpdateSpaceHierarchy)}},"mx_AddExistingToSpaceDialog_wrapper")},B=e=>{c.a.createTrackedDialog("Space Landing","Create Subspace",C,{space:e,onAddExistingSpaceClick:()=>F(e),onFinished:t=>{t&&I.a.instance.getRoomId()===e.roomId&&R.a.fire(k.a.UpdateSpaceHierarchy)}},"mx_CreateSubspaceDialog_wrapper")},K=async(e,t,n)=>{const i=c.a.createDialog(x.a,null,"mx_Dialog_spinner");try{for(const e of t)await n(e);await n(e)}finally{i.close()}},V=(e,t)=>{R.a.dispatch({action:k.a.OpenSpacePreferences,space:e,initialTabId:t})}},function(e,t,n){"use strict";n.d(t,"d",(function(){return A})),n.d(t,"a",(function(){return M})),n.d(t,"c",(function(){return B})),n.d(t,"e",(function(){return K})),n.d(t,"b",(function(){return V})),n.d(t,"f",(function(){return W}));var i=n(371),s=n(372),o=n(161),r=n(0),a=n(95),c=n(90),l=n(89),d=n(205),u=n(88),h=n.n(u),m=n(111),p=n(94),g=n.n(p),f=n(87),v=n.n(f),b=n(105),y=n(91),S=n(227),E=n(110),w=n(101),_=n(248);class C extends v.a.PureComponent{constructor(e){super(e),h()(this,"fileUpload",v.a.createRef()),h()(this,"onCancel",()=>{this.state.resetting&&this.setState({resetting:!1}),this.props.onFinished(!1)}),h()(this,"onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),h()(this,"validateRecoveryKeyOnChange",Object(m.debounce)(async()=>{await this.validateRecoveryKey()},200)),h()(this,"onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyFileError:null}),this.fileUpload.current&&(this.fileUpload.current.value=null),this.validateRecoveryKeyOnChange()}),h()(this,"onRecoveryKeyFileChange",async e=>{if(0===e.target.files.length)return;const t=e.target.files[0];if(t.size>128)this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1});else{const e=await t.text();/^[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\s]+$/.test(e)?(this.setState({recoveryKeyFileError:null,recoveryKey:e.trim()}),await this.validateRecoveryKey()):this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1,recoveryKey:""})}}),h()(this,"onRecoveryKeyFileUploadClick",()=>{this.fileUpload.current.click()}),h()(this,"onPassPhraseNext",async e=>{if(e.preventDefault(),this.state.passPhrase.length<=0)return;this.setState({keyMatches:null});const t={passphrase:this.state.passPhrase},n=await this.props.checkPrivateKey(t);n?this.props.onFinished(t):this.setState({keyMatches:n})}),h()(this,"onRecoveryKeyNext",async e=>{if(e.preventDefault(),!this.state.recoveryKeyValid)return;this.setState({keyMatches:null});const t={recoveryKey:this.state.recoveryKey},n=await this.props.checkPrivateKey(t);n?this.props.onFinished(t):this.setState({keyMatches:n})}),h()(this,"onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value,keyMatches:null})}),h()(this,"onResetAllClick",e=>{e.preventDefault(),this.setState({resetting:!0})}),h()(this,"onConfirmResetAllClick",async()=>{a.a.toggleCurrentDialogVisibility();try{await V(async()=>{const e=c.a.get();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:n}=a.a.createTrackedDialog("Cross-signing keys dialog","",S.a,{title:Object(l.a)("Setting up keys"),matrixClient:e,makeRequest:t}),[i]=await n;if(!i)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0}),this.props.onFinished(!0)},!0)}catch(e){r.a.error(e),this.props.onFinished(!1)}}),this.state={recoveryKey:"",recoveryKeyValid:null,recoveryKeyCorrect:null,recoveryKeyFileError:null,forceRecoveryKey:!1,passPhrase:"",keyMatches:null,resetting:!1}}async validateRecoveryKey(){if(""!==this.state.recoveryKey)try{const e=c.a.get(),t=e.keyBackupKeyFromRecoveryKey(this.state.recoveryKey),n=await e.checkSecretStorageKey(t,this.props.keyInfo);this.setState({recoveryKeyValid:!0,recoveryKeyCorrect:n})}catch(e){this.setState({recoveryKeyValid:!1,recoveryKeyCorrect:!1})}else this.setState({recoveryKeyValid:null,recoveryKeyCorrect:null})}getKeyValidationText(){return this.state.recoveryKeyFileError?Object(l.a)("Wrong file type"):this.state.recoveryKeyCorrect?Object(l.a)("Looks good!"):this.state.recoveryKeyValid?Object(l.a)("Wrong Security Key"):null===this.state.recoveryKeyValid?"":Object(l.a)("Invalid Security Key")}render(){const e=this.props.keyInfo&&this.props.keyInfo.passphrase&&this.props.keyInfo.passphrase.salt&&this.props.keyInfo.passphrase.iterations,t=v.a.createElement("div",{className:"mx_AccessSecretStorageDialog_reset"},Object(l.a)("Forgotten or lost all recovery methods? <a>Reset all</a>",null,{a:e=>v.a.createElement(y.a,{kind:"link_inline",onClick:this.onResetAllClick,className:"mx_AccessSecretStorageDialog_reset_link"},e)}));let n,i,s;if(this.state.resetting)i=Object(l.a)("Reset everything"),s=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_resetBadge"],n=v.a.createElement("div",null,v.a.createElement("p",null,Object(l.a)("Only do this if you have no other device to complete verification with.")),v.a.createElement("p",null,Object(l.a)("If you reset everything, you will restart with no trusted sessions, no trusted users, and might not be able to see past messages.")),v.a.createElement(E.a,{primaryButton:Object(l.a)("Reset"),onPrimaryButtonClick:this.onConfirmResetAllClick,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryButtonClass:"danger"}));else if(e&&!this.state.forceRecoveryKey){let e;i=Object(l.a)("Security Phrase"),s=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_securePhraseTitle"],e=!1===this.state.keyMatches?v.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"},"👎 ",Object(l.a)("Unable to access secret storage. Please verify that you entered the correct Security Phrase.")):v.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"}),n=v.a.createElement("div",null,v.a.createElement("p",null,Object(l.a)("Enter your Security Phrase or <button>use your Security Key</button> to continue.",{},{button:e=>v.a.createElement(y.a,{className:"mx_linkButton",element:"span",onClick:this.onUseRecoveryKeyClick},e)})),v.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this.onPassPhraseNext},v.a.createElement(b.a,{id:"mx_passPhraseInput",className:"mx_AccessSecretStorageDialog_passPhraseInput",type:"password",label:Object(l.a)("Security Phrase"),value:this.state.passPhrase,onChange:this.onPassPhraseChange,autoFocus:!0,autoComplete:"new-password"}),e,v.a.createElement(E.a,{primaryButton:Object(l.a)("Continue"),onPrimaryButtonClick:this.onPassPhraseNext,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryDisabled:0===this.state.passPhrase.length,additive:t})))}else{i=Object(l.a)("Security Key"),s=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_secureBackupTitle"];const e=g()({mx_AccessSecretStorageDialog_recoveryKeyFeedback:!0,mx_AccessSecretStorageDialog_recoveryKeyFeedback_valid:!0===this.state.recoveryKeyCorrect,mx_AccessSecretStorageDialog_recoveryKeyFeedback_invalid:!1===this.state.recoveryKeyCorrect}),o=v.a.createElement("div",{className:e},this.getKeyValidationText());n=v.a.createElement("div",null,v.a.createElement("p",null,Object(l.a)("Use your Security Key to continue.")),v.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this.onRecoveryKeyNext,spellCheck:!1,autoComplete:"off"},v.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry"},v.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_textInput"},v.a.createElement(b.a,{type:"password",id:"mx_securityKey",label:Object(l.a)("Security Key"),value:this.state.recoveryKey,onChange:this.onRecoveryKeyChange,forceValidity:this.state.recoveryKeyCorrect,autoComplete:"off"})),v.a.createElement("span",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_entryControlSeparatorText"},Object(l.a)("or")),v.a.createElement("div",null,v.a.createElement("input",{type:"file",className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_fileInput",ref:this.fileUpload,onClick:_.a,onChange:this.onRecoveryKeyFileChange}),v.a.createElement(y.a,{kind:"primary",onClick:this.onRecoveryKeyFileUploadClick},Object(l.a)("Upload")))),o,v.a.createElement(E.a,{primaryButton:Object(l.a)("Continue"),onPrimaryButtonClick:this.onRecoveryKeyNext,hasCancel:!0,cancelButton:Object(l.a)("Go Back"),cancelButtonClass:"danger",onCancel:this.onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid,additive:t})))}return v.a.createElement(w.a,{className:"mx_AccessSecretStorageDialog",onFinished:this.props.onFinished,title:i,titleClass:s},v.a.createElement("div",null,n))}}var O=n(323),R=n(93),I=n(249),k=n(115);let x={},T={},j=!1,N=!1,P={};function D(){return j}function A(){return j}class M extends Error{constructor(){super("Secret storage access canceled")}}async function U(){const[e]=await a.a.createDialog(k.a,{title:Object(l.a)("Cancel entering passphrase?"),description:Object(l.a)("Are you sure you want to cancel entering passphrase?"),danger:!1,button:Object(l.a)("Go Back"),cancelButton:Object(l.a)("Cancel")}).finished;return!e}function L(e){return async t=>{let{passphrase:n,recoveryKey:o}=t;return n?Object(i.a)(n,e.passphrase.salt,e.passphrase.iterations):Object(s.a)(o)}}function F(e,t,n){D()&&(x[e]=n,T[e]=t)}const B={getSecretStorageKey:async function(e){var t;let{keys:n}=e;const i=c.a.get();let s,o=await i.getDefaultSecretStorageKeyId();if(o&&(s=n[o],s||(o=void 0)),!o){const e=Object.entries(n);if(e.length>1)throw new Error("Multiple storage key requests not implemented");[o,s]=e[0]}if(D()&&x[o])return[o,x[o]];if(P.key&&await c.a.get().checkSecretStorageKey(P.key,s))return F(o,s,P.key),[o,P.key];const l=null===(t=I.a.getSecretStorageKey)||void 0===t?void 0:t.call(I.a);if(l)return r.a.log("Using key from security customisations (secret storage)"),F(o,s,l),[o,l];if(N)throw new Error("Could not unlock non-interactively");const d=L(s),{finished:u}=a.a.createTrackedDialog("Access Secret Storage dialog","",C,{keyInfo:s,checkPrivateKey:async e=>{const t=await d(e);return c.a.get().checkSecretStorageKey(t,s)}},null,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||U()}),[h]=await u;if(!h)throw new M;const m=await d(h);return F(o,s,m),[o,m]},cacheSecretStorageKey:F,onSecretRequested:async function(e,t,n,i,s){r.a.log("onSecretRequested",e,t,n,i,s);const a=c.a.get();if(e===a.getUserId())if(null!=s&&s.isVerified()){if("m.cross_signing.master"===i||"m.cross_signing.self_signing"===i||"m.cross_signing.user_signing"===i){const e=a.getCrossSigningCacheCallbacks();if(!e.getCrossSigningKeyCache)return;const n=i.replace("m.cross_signing.",""),s=await e.getCrossSigningKeyCache(n);return s||r.a.log(`${n} requested by ${t}, but not found in cache`),s&&Object(o.encodeBase64)(s)}if("m.megolm_backup.v1"===i){const e=await a.crypto.getSessionBackupPrivateKey();return e||r.a.log(`session backup key requested by ${t}, but not found in cache`),e&&Object(o.encodeBase64)(e)}r.a.warn("onSecretRequested didn't recognise the secret named ",i)}else r.a.log("Ignoring secret request from untrusted device "+t)},getDehydrationKey:async function(e,t){var n;const i=null===(n=I.a.getSecretStorageKey)||void 0===n?void 0:n.call(I.a);if(i)return r.a.log("Using key from security customisations (dehydration)"),i;const s=L(e),{finished:o}=a.a.createTrackedDialog("Access Secret Storage dialog","",C,{keyInfo:e,checkPrivateKey:async e=>{const n=await s(e);try{return t(n),!0}catch(e){return!1}}},null,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||U()}),[c]=await o;if(!c)throw new M;const l=await s(c);return P={key:new Uint8Array(l),keyInfo:e},l}};async function K(){let e;const{finished:t}=a.a.createTrackedDialog("Restore Backup","",O.a,{showSummary:!1,keyCallback:t=>e=t},null,!1,!0);if(!await t)throw new Error("Key backup prompt cancelled");return e}async function V(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:async()=>{},t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=c.a.get();j=!0;try{if(!await i.hasSecretStorageKey()||t){const{finished:e}=a.a.createTrackedDialogAsync("Create Secret Storage dialog","",n.e(29).then(n.bind(null,1501)),{forceReset:t},null,!1,!0,{onBeforeClose:async e=>"backgroundClick"!==e||!Object(d.g)()}),[i]=await e;if(!i)throw new Error("Secret storage creation canceled")}else{await i.bootstrapCrossSigning({authUploadDeviceSigningKeys:async e=>{const{finished:t}=a.a.createTrackedDialog("Cross-signing keys dialog","",S.a,{title:Object(l.a)("Setting up keys"),matrixClient:i,makeRequest:e}),[n]=await t;if(!n)throw new Error("Cross-signing key upload auth canceled")}}),await i.bootstrapSecretStorage({getKeyBackupPassphrase:K});const e=Object.keys(x)[0];if(e&&R.b.getValue("feature_dehydration")){let t={};T[e]&&T[e].passphrase&&(t={passphrase:T[e].passphrase}),r.a.log("Setting dehydration key"),await i.setDehydrationKey(x[e],t,"Backup device")}else e?r.a.log("Not setting dehydration key: feature disabled"):r.a.warn("Not setting dehydration key: no SSSS key found")}return await e()}catch(e){var s;throw null===(s=I.a.catchAccessSecretStorageError)||void 0===s||s.call(I.a,e),r.a.error(e),e}finally{j=!1,D()||(x={},T={})}}async function W(e){const t=P.key;let n=!1;if(t&&await e.isSecretStorageReady()){r.a.log("Trying to set up cross-signing using dehydration key"),j=!0,N=!0;try{await e.checkOwnCrossSigningTrust();let i={};P.keyInfo&&P.keyInfo.passphrase&&(i={passphrase:P.keyInfo.passphrase}),await e.setDehydrationKey(t,i,"Backup device");const s=await e.getKeyBackupVersion();s&&(n=!0,e.restoreKeyBackupWithSecretStorage(s).finally(()=>{j=!1,N=!1,D()||(x={},T={})}))}finally{P={},n||(j=!1,N=!1,D()||(x={},T={}))}}}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"d",(function(){return o})),n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"e",(function(){return c}));var i=n(116);let s;function o(e){const t={[s.Invite]:[],[s.Join]:[],[s.Leave]:[]};for(const n of e)t[r(n.getMyMembership())].push(n);return t}function r(e){return"invite"===e?s.Invite:"join"===e?s.Join:s.Leave}function a(e){const t=r(e);return t===s.Join||t===s.Invite}async function c(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{timeout:1500};const{timeout:o}=s;let r;return new Promise(s=>{r=function(e,i,o){o.userId===n&&o.roomId===t&&s(!0)},e.on(i.b.NewMember,r),setTimeout(s,o,!1)}).finally(()=>{e.removeListener(i.b.NewMember,r)})}!function(e){e.Join="JOIN",e.Invite="INVITE",e.Leave="LEAVE"}(s||(s={}))},,function(e,t,n){"use strict";n.d(t,"b",(function(){return f})),n.d(t,"e",(function(){return v})),n.d(t,"d",(function(){return b})),n.d(t,"c",(function(){return E})),n.d(t,"a",(function(){return w}));var i=n(88),s=n.n(i),o=n(474),r=n.n(o),a=n(670),c=n.n(a),l=n(137),d=n(97),u=n(158),h=n(132),m=n(93);function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function f(e){if(e&&!e.isRedacted())return e.replyEventId?e.replyEventId:void 0}function v(e){const t=e.split("\n");for(;t.length&&t[0].startsWith("> ");)t.shift();return""===t[0]&&t.shift(),t.join("\n")}function b(e){return r()(e,{allowedTags:!1,allowedAttributes:!1,allowedSchemes:[...u.a,"mxc"],exclusiveFilter:e=>"mx-reply"===e.tag})}function y(e,t){if(!e)return null;let{body:n,formatted_body:i,msgtype:s}=e.getContent();f(e)&&n&&(n=v(n)),n||(n=""),i=i?b(i):c()(n).replace(/\n/g,"<br/>");const o=t.forEvent(e.getId()),r=Object(h.g)(e.getSender()),a=e.getSender();switch(s){case d.c.Text:case d.c.Notice:{i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>${i}</blockquote></mx-reply>`;const e=n.trim().split("\n");e.length>0&&(e[0]=`<${a}> ${e[0]}`,n=e.map(e=>"> "+e).join("\n")+"\n\n");break}case d.c.Image:i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>sent an image.</blockquote></mx-reply>`,n=`> <${a}> sent an image.\n\n`;break;case d.c.Video:i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>sent a video.</blockquote></mx-reply>`,n=`> <${a}> sent a video.\n\n`;break;case d.c.Audio:i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>sent an audio file.</blockquote></mx-reply>`,n=`> <${a}> sent an audio file.\n\n`;break;case d.c.File:i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>sent a file.</blockquote></mx-reply>`,n=`> <${a}> sent a file.\n\n`;break;case d.c.Emote:{i=`<mx-reply><blockquote><a href="${o}">In reply to</a> * <a href="${r}">${a}</a><br>${i}</blockquote></mx-reply>`;const e=n.trim().split("\n");e.length>0&&(e[0]=`* <${a}> ${e[0]}`,n=e.map(e=>"> "+e).join("\n")+"\n\n");break}default:return null}return{body:n,html:i}}function S(e){if(!e)return{};const t={"m.in_reply_to":{event_id:e.getId()}};if(e.threadRootId)if(m.b.getValue("feature_thread"))t.is_falling_back=!1;else{const n=e.getRelation();t.rel_type=n.rel_type,t.event_id=n.event_id}return t}function E(e){var t,n;if(e.isRedacted())return!1;const i=null===(t=e.getWireContent())||void 0===t||null===(n=t["m.relates_to"])||void 0===n?void 0:n["m.in_reply_to"];if(!i)return!1;const s=e.getRelation();return(!m.b.getValue("feature_thread")||(null==s?void 0:s.rel_type)!==l.c.name||null==s||!s.is_falling_back)&&!!i.event_id}function w(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeLegacyFallback:!0};if(e["m.relates_to"]=g(g({},e["m.relates_to"]||{}),S(t)),n.includeLegacyFallback){const i=y(t,n.permalinkCreator);i&&(e.formatted_body&&(e.formatted_body=i.html+e.formatted_body),e.body=i.body+e.body)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(88),c=n.n(a),l=n(87),d=n.n(l),u=n(94),h=n.n(u);const m=["children","className","disabled","outlined","childrenInLabel","inputRef"];class p extends d.a.PureComponent{render(){const e=this.props,{children:t,className:n,disabled:i,outlined:o,childrenInLabel:a,inputRef:c}=e,l=r()(e,m),u=h()("mx_StyledRadioButton",n,{mx_StyledRadioButton_disabled:i,mx_StyledRadioButton_enabled:!i,mx_StyledRadioButton_checked:this.props.checked,mx_StyledRadioButton_outlined:o}),p=d.a.createElement(d.a.Fragment,null,d.a.createElement("input",s()({ref:c,type:"radio",disabled:i},l)),d.a.createElement("div",null,d.a.createElement("div",null)));return a?d.a.createElement("label",{className:u},p,d.a.createElement("div",{className:"mx_StyledRadioButton_content"},t),d.a.createElement("div",{className:"mx_StyledRadioButton_spacer"})):d.a.createElement("div",{className:u},d.a.createElement("label",{className:"mx_StyledRadioButton_innerLabel"},p),d.a.createElement("div",{className:"mx_StyledRadioButton_content"},t),d.a.createElement("div",{className:"mx_StyledRadioButton_spacer"}))}}c()(p,"defaultProps",{className:"",childrenInLabel:!0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"d",(function(){return l})),n.d(t,"e",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(111),s=n(135),o=n(128);function r(e,t,n,i){let s;return null!=e&&e.getMxcAvatarUrl()&&(s=Object(o.b)(e.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,n,i)),s||(s=l(e?e.userId:"")),s}function a(e,t,n,i){return e.avatarUrl?Object(o.b)(e.avatarUrl).getThumbnailOfSourceHttp(t,n,i):null}const c=new Map;function l(e){if(!e)return"";const t=["#0DBD8B","#368bd6","#ac3ba8"];let n=0;for(let t=0;t<e.length;++t)n+=e.charCodeAt(t);const i=n%t.length,s="--avatar-background-colors_"+i,o=document.body.style.getPropertyValue(s)||t[i];let r=c.get(o);return r||(!function(e){return"string"==typeof e&&(7===e.length||9===e.length)&&"#"===e.charAt(0)&&!e.slice(1).split("").some(e=>isNaN(parseInt(e,16)))}(o)?r="":(r=function(e){const t=document.createElement("canvas");t.width=40,t.height=40;const n=t.getContext("2d");return n?(n.fillStyle=e,n.fillRect(0,0,40,40),t.toDataURL()):""}(o),c.set(o,r))),r}function d(e){if(!e)return void console.trace("`name` argument to `getInitialLetter` not supplied");if(e.length<1)return;const t=e[0];return"@"!==t&&"#"!==t&&"+"!==t||!e[1]||(e=e.substring(1)),Object(i.split)(e,"",1)[0].toUpperCase()}function u(e,t,n,i){if(!e)return null;if(e.getMxcAvatarUrl())return Object(o.b)(e.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,n,i);if(e.isSpaceRoom())return null;if(!s.a.shared().getUserIdForRoomId(e.roomId))return null;const r=e.getAvatarFallbackMember();return null!=r&&r.getMxcAvatarUrl()?Object(o.b)(r.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,n,i):null}},function(e,t,n){"use strict";n.d(t,"d",(function(){return i})),n.d(t,"c",(function(){return s})),n.d(t,"h",(function(){return r})),n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return h})),n.d(t,"f",(function(){return m})),n.d(t,"g",(function(){return p})),n.d(t,"e",(function(){return g})),n.d(t,"k",(function(){return f})),n.d(t,"i",(function(){return E})),n.d(t,"j",(function(){return _}));const i=e=>{return t=e.timestamp,n=e.timeout,Math.max(0,t+n-Date.now());var t,n},s=e=>e.beaconInfo.timestamp+e.beaconInfo.timeout,o=(e,t)=>s(t)-s(e),r=(e,t)=>t.beaconInfo.timestamp-e.beaconInfo.timestamp;var a=n(0);let c;!function(e){e.Unavailable="Unavailable",e.PermissionDenied="PermissionDenied",e.PositionUnavailable="PositionUnavailable",e.Timeout="Timeout",e.Default="Default"}(c||(c={}));const l={timeout:1e4,maximumAge:6e4},d=e=>{var t;if(a.a.error("Geolocation failed",null!==(t=null==e?void 0:e.message)&&void 0!==t?t:e),!(e=>"object"==typeof e&&!!e.PERMISSION_DENIED)(e))return e.message===c.Unavailable?c.Unavailable:c.Default;switch(null==e?void 0:e.code){case e.PERMISSION_DENIED:return c.PermissionDenied;case e.POSITION_UNAVAILABLE:return c.PositionUnavailable;case e.TIMEOUT:return c.Timeout;default:return c.Default}},u=()=>{if(!navigator.geolocation)throw new Error(c.Unavailable);return navigator.geolocation},h=e=>{const{latitude:t,longitude:n,altitude:i,accuracy:s}=e.coords;return{timestamp:Date.now(),latitude:t,longitude:n,altitude:i,accuracy:s}},m=e=>`geo:${e.latitude},${e.longitude}${Number.isFinite(e.altitude)?","+e.altitude:""}${Number.isFinite(e.accuracy)?";u="+e.accuracy:""}`,p=e=>{const t=h(e);return{timestamp:t.timestamp,geoUri:m(t)}},g=async()=>{try{return await new Promise((e,t)=>{u().getCurrentPosition(e,t,l)})}catch(e){throw new Error(d(e))}},f=(e,t)=>{try{const n=e=>t(d(e)),i=u().watchPosition(e,n,l);return()=>{u().clearWatch(i)}}catch(e){throw new Error(d(e))}};var v=n(87),b=n(120),y=n(100),S=n(118);const E=e=>{const t=Object(v.useContext)(y.a),[n,i]=Object(v.useState)();Object(v.useEffect)(()=>{const n=e.getRoomId(),s=Object(b.getBeaconInfoIdentifier)(e),o=t.getRoom(n).currentState.beacons.get(s);(null==o?void 0:o.beaconInfoId)===e.getId()?i(o):i(void 0)},[e,t]);const s=Object(S.b)(n,b.BeaconEvent.Update,()=>null==n?void 0:n.beaconInfoId);return Object(v.useEffect)(()=>{s&&s!==e.getId()&&i(void 0)},[s,e]),Object(v.useEffect)(()=>{n&&n.monitorLiveness()},[n]),n};var w=n(347);const _=e=>{const[t,n]=Object(v.useState)(!1),i=Object(S.b)(w.a.instance,w.b.LocationPublishError,()=>e.some(w.a.instance.beaconHasLocationPublishError)),s=Object(S.b)(w.a.instance,w.b.BeaconUpdateError,()=>e.some(e=>w.a.instance.beaconUpdateErrors.has(e)));Object(v.useEffect)(()=>{s&&n(!1)},[s]),Object(v.useEffect)(()=>{n(!1)},[e]);return{onStopSharing:async()=>{n(!0);try{await Promise.all(e.map(e=>w.a.instance.stopBeacon(e)))}catch(e){n(!1)}},onResetLocationPublishError:()=>{e.forEach(e=>{w.a.instance.resetLocationPublishError(e)})},beacon:e.map(e=>w.a.instance.getBeaconById(e)).sort(o).shift(),stoppingInProgress:t,hasLocationPublishError:i,hasStopSharingError:s}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return p})),n.d(t,"c",(function(){return O})),n.d(t,"a",(function(){return R}));var i=n(88),s=n.n(i),o=n(111),r=n(486),a=n.n(r);class c{constructor(e,t,n,i){this.updateCallback=e,this.getAutocompleterComponent=t,this.updateQuery=n,this.partCreator=i,s()(this,"partIndex",void 0)}onEscape(e){this.getAutocompleterComponent().onEscape(e)}close(){this.updateCallback({close:!0})}hasSelection(){return this.getAutocompleterComponent().hasSelection()}hasCompletions(){const e=this.getAutocompleterComponent();return e&&e.countCompletions()>0}confirmCompletion(){this.getAutocompleterComponent().onConfirmCompletion(),this.updateCallback({close:!0})}async startSelection(){const e=this.getAutocompleterComponent();0===e.countCompletions()&&await e.forceComplete()}selectPreviousSelection(){this.getAutocompleterComponent().moveSelection(-1)}selectNextSelection(){this.getAutocompleterComponent().moveSelection(1)}onPartUpdate(e,t){return this.partIndex=t.index,this.updateQuery(e.text)}onComponentConfirm(e){this.updateCallback({replaceParts:this.partForCompletion(e),close:!0})}partForCompletion(e){const{completionId:t}=e,n=e.completion;switch(e.type){case"room":return[this.partCreator.roomPill(n,t),this.partCreator.plain(e.suffix)];case"at-room":return[this.partCreator.atRoomPill(t),this.partCreator.plain(e.suffix)];case"user":return this.partCreator.createMentionParts(0===this.partIndex,n,t);case"command":return[this.partCreator.command(n)];default:return this.partCreator.plainWithEmoji(n)}}}var l=n(158),d=n(221),u=n(92),h=n(96),m=n(93);let p;!function(e){e.Plain="plain",e.Newline="newline",e.Emoji="emoji",e.Command="command",e.UserPill="user-pill",e.RoomPill="room-pill",e.AtRoomPill="at-room-pill",e.PillCandidate="pill-candidate"}(p||(p={}));class g{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";s()(this,"_text",void 0),this._text=e}acceptsInsertion(e,t,n){return!0}acceptsRemoval(e,t){return!0}merge(e){return!1}split(e){const t=this.text.slice(e);return this._text=this.text.slice(0,e),new v(t)}remove(e,t){const n=this.text.slice(0,e)+this.text.slice(e+t);for(let i=e;i<t+e;++i){const e=this.text.charAt(i);if(!this.acceptsRemoval(i,e))return n}this._text=n}appendUntilRejected(e,t){const n=this.text.length;let i=e;for(;i;){const[s]=Object(o.split)(i,"",2);if(!this.acceptsInsertion(s,n+e.length-i.length,t))break;i=i.slice(s.length)}return this._text+=e.slice(0,e.length-i.length),i||void 0}validateAndInsert(e,t,n){for(let i=0;i<t.length;++i){const s=t.charAt(i);if(!this.acceptsInsertion(s,e+i,n))return!1}const i=this._text.slice(0,e),s=this._text.slice(e);return this._text=i+t+s,!0}createAutoComplete(e){}trim(e){const t=this._text.slice(e);return this._text=this._text.slice(0,e),t}get text(){return this._text}get canEdit(){return!0}get acceptsCaret(){return this.canEdit}toString(){return`${this.type}(${this.text})`}serialize(){return{type:this.type,text:this.text}}}class f extends g{acceptsInsertion(e,t,n){return"\n"!==e&&!a.a.test(e)&&("insertFromPaste"===n||"insertFromDrop"===n||("@"!==e&&"#"!==e&&":"!==e&&"+"!==e||0!==t&&(" "!==this._text[t-1]&&("+"!==this._text[t-1]||":"!==e))))}toDOMNode(){return document.createTextNode(this.text)}merge(e){return e.type===this.type&&(this._text=this.text+e.text,!0)}updateDOMNode(e){e.textContent!==this.text&&(e.textContent=this.text)}canUpdateDOMNode(e){return e.nodeType===Node.TEXT_NODE}}class v extends f{get type(){return p.Plain}}class b extends g{constructor(e,t){super(t),this.resourceId=e,s()(this,"onClick",void 0)}acceptsInsertion(e){return" "!==e}acceptsRemoval(e,t){return 0!==e}toDOMNode(){const e=document.createElement("span");return e.setAttribute("spellcheck","false"),e.setAttribute("contentEditable","false"),e.onclick=this.onClick,e.className=this.className,e.appendChild(document.createTextNode(this.text)),this.setAvatar(e),e}updateDOMNode(e){const t=e.childNodes[0];t.textContent!==this.text&&(t.textContent=this.text),e.className!==this.className&&(e.className=this.className),e.onclick!==this.onClick&&(e.onclick=this.onClick),this.setAvatar(e)}canUpdateDOMNode(e){return e.nodeType===Node.ELEMENT_NODE&&"SPAN"===e.nodeName&&1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE}setAvatarVars(e,t,n){const i=`url('${t}')`,s=`'${n}'`;e.style.getPropertyValue("--avatar-background")!==i&&e.style.setProperty("--avatar-background",i),e.style.getPropertyValue("--avatar-letter")!==s&&e.style.setProperty("--avatar-letter",s)}serialize(){return{type:this.type,text:this.text,resourceId:this.resourceId}}get canEdit(){return!1}}class y extends g{acceptsInsertion(e,t){return 0===t&&"\n"===e}acceptsRemoval(e,t){return!0}toDOMNode(){return document.createElement("br")}merge(){return!1}updateDOMNode(){}canUpdateDOMNode(e){return"BR"===e.tagName}get type(){return p.Newline}get canEdit(){return!1}}class S extends g{acceptsInsertion(e,t){return a.a.test(e)}acceptsRemoval(e,t){return!1}toDOMNode(){const e=document.createElement("span");return e.className="mx_Emoji",e.setAttribute("title",Object(l.i)(this.text)),e.appendChild(document.createTextNode(this.text)),e}updateDOMNode(e){const t=e.childNodes[0];t.textContent!==this.text&&(e.setAttribute("title",Object(l.i)(this.text)),t.textContent=this.text)}canUpdateDOMNode(e){return"mx_Emoji"===e.className}get type(){return p.Emoji}get canEdit(){return!1}get acceptsCaret(){return!0}}class E extends b{constructor(e,t,n){super(e,t),this.room=n}setAvatar(e){let t="",n=d.b(this.room,16,16,"crop");n||(t=d.e(this.room?this.room.name:this.resourceId),n=d.d(this.room?this.room.roomId:this.resourceId)),this.setAvatarVars(e,n,t)}get type(){return p.RoomPill}get className(){return"mx_Pill "+(this.room.isSpaceRoom()?"mx_SpacePill":"mx_RoomPill")}}class w extends E{constructor(e,t){super(e,e,t)}get type(){return p.AtRoomPill}serialize(){return{type:this.type,text:this.text}}}class _ extends b{constructor(e,t,n){super(e,t),this.member=n,s()(this,"onClick",()=>{u.a.dispatch({action:h.a.ViewUser,member:this.member})})}get type(){return p.UserPill}get className(){return"mx_UserPill mx_Pill"}setAvatar(e){if(!this.member)return;const t=this.member.name||this.member.userId,n=d.d(this.member.userId),i=d.a(this.member,16,16,"crop");let s="";i===n&&(s=d.e(t)),this.setAvatarVars(e,i,s)}}class C extends f{constructor(e,t){super(e),this.autoCompleteCreator=t}createAutoComplete(e){return this.autoCompleteCreator.create(e)}acceptsInsertion(e,t,n){return 0===t||super.acceptsInsertion(e,t,n)}merge(){return!1}acceptsRemoval(e,t){return!0}get type(){return p.PillCandidate}}function O(e,t){return n=>i=>new c(i,e,t,n)}class R extends class{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.room=e,this.client=t,s()(this,"autoCompleteCreator",void 0),this.autoCompleteCreator={create:null==n?void 0:n(this)}}setAutoCompleteCreator(e){this.autoCompleteCreator.create=e(this)}createPartForInput(e,t,n){switch(e[0]){case"#":case"@":case":":case"+":return this.pillCandidate("");case"\n":return new y;default:return a.a.test(Object(o.split)(e,"",2)[0])?new S:new v}}createDefaultPart(e){return this.plain(e)}deserializePart(e){switch(e.type){case p.Plain:return this.plain(e.text);case p.Newline:return this.newline();case p.Emoji:return this.emoji(e.text);case p.AtRoomPill:return this.atRoomPill(e.text);case p.PillCandidate:return this.pillCandidate(e.text);case p.RoomPill:return this.roomPill(e.resourceId);case p.UserPill:return this.userPill(e.text,e.resourceId)}}plain(e){return new v(e)}newline(){return new y("\n")}emoji(e){return new S(e)}pillCandidate(e){return new C(e,this.autoCompleteCreator)}roomPill(e,t){let n;return n=t||"#"!==e[0]?this.client.getRoom(t||e):this.client.getRooms().find(t=>t.getCanonicalAlias()===e||t.getAltAliases().includes(e)),new E(e,n?n.name:e,n)}atRoomPill(e){return new w(e,this.room)}userPill(e,t){const n=this.room.getMember(t);return new _(t,e,n)}plainWithEmoji(e){const t=[];let n="";for(const i of Object(o.split)(e,""))a.a.test(i)?(n&&(t.push(this.plain(n)),n=""),t.push(this.emoji(i))):n+=i;return n&&t.push(this.plain(n)),t}createMentionParts(e,t,n){const i=this.userPill(t,n);m.b.getValue("MessageComposerInput.insertTrailingColon")||(e=!1);return[i,this.plain(e?": ":" ")]}}{createPartForInput(e,t){return 0===t&&"/"===e[0]?this.command(""):super.createPartForInput(e,t)}command(e){return new I(e,this.autoCompleteCreator)}deserializePart(e){return e.type===p.Command?this.command(e.text):super.deserializePart(e)}}class I extends C{get type(){return p.Command}}},function(e,t,n){"use strict";(function(e){n.d(t,"j",(function(){return u})),n.d(t,"l",(function(){return h})),n.d(t,"m",(function(){return m})),n.d(t,"k",(function(){return p})),n.d(t,"g",(function(){return g})),n.d(t,"h",(function(){return f})),n.d(t,"i",(function(){return v})),n.d(t,"f",(function(){return b})),n.d(t,"c",(function(){return y})),n.d(t,"e",(function(){return S})),n.d(t,"d",(function(){return C})),n.d(t,"b",(function(){return O})),n.d(t,"a",(function(){return R})),n.d(t,"n",(function(){return I}));var i=n(17),s=n.n(i),o=n(879),r=n(880),a=n(7),c=n(0);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const u="/_matrix/client/r0",h="/_matrix/client/v1",m="/_matrix/client/v3",p="/_matrix/client/unstable",g="/_matrix/identity/api/v1",f="/_matrix/identity/v2",v="/_matrix/media/r0";let b,y;!function(e){e.Get="GET",e.Put="PUT",e.Post="POST",e.Delete="DELETE"}(b||(b={})),function(e){e.SessionLoggedOut="Session.logged_out",e.NoConsent="no_consent"}(y||(y={}));class S{constructor(e,t){this.eventEmitter=e,this.opts=t,s()(this,"uploads",[]),a.e(t,["baseUrl","request","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=!!t.useAuthorizationHeader}setIdBaseUrl(e){this.opts.idBaseUrl=e}getContentUri(){return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:{access_token:this.opts.accessToken}}}uploadContent(t,n){a.s(n)?n={callback:n}:n||(n={});const i=!1!==n.includeFilename,s=n.type||t.type||"application/octet-stream",o=n.name||t.name;let l=t;const d=l.stream;d&&"function"!=typeof d&&(c.a.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),l=d);let u=n.rawResponse;void 0===u&&(e.XMLHttpRequest?u=!1:(c.a.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),u=!0));let h=n.onlyContentUri;u||void 0!==h||(e.XMLHttpRequest?(c.a.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),h=!0):h=!1);const m={loaded:0,total:0};let p,g=null;if(u||(g=function(e){let t=JSON.parse(e);if(h&&(t=t.content_uri,void 0===t))throw Error("Bad response");return t}),e.XMLHttpRequest){const t=a.l(),c=new e.XMLHttpRequest,d=w(t,n.callback,this.opts.onlyData),u=function(){c.abort(),d(new Error("Timeout"))};let h=r.b(u,3e4);c.onreadystatechange=function(){let t;switch(c.readyState){case e.XMLHttpRequest.DONE:r.a(h);try{if(0===c.status)throw new R;if(!c.responseText)throw new Error("No response body.");t=c.responseText,g&&(t=g(t))}catch(e){return e.httpStatus=c.status,void d(e)}d(void 0,c,t)}},c.upload.addEventListener("progress",(function(e){r.a(h),m.loaded=e.loaded,m.total=e.total,h=r.b(u,3e4),n.progressHandler&&n.progressHandler({loaded:e.loaded,total:e.total})}));let f=this.opts.baseUrl+"/_matrix/media/r0/upload";const v=[];i&&o&&v.push("filename="+encodeURIComponent(o)),this.opts.useAuthorizationHeader||v.push("access_token="+encodeURIComponent(this.opts.accessToken)),v.length>0&&(f+="?"+v.join("&")),c.open("POST",f),this.opts.useAuthorizationHeader&&c.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),c.setRequestHeader("Content-Type",s),c.send(l),p=t.promise,p.abort=c.abort.bind(c)}else{const e={};i&&o&&(e.filename=o);const t={"Content-Type":s};0===l.length&&(t["Content-Length"]="0"),p=this.authedRequest(n.callback,b.Post,"/upload",e,l,{prefix:"/_matrix/media/r0",headers:t,json:!1,bodyParser:g})}return m.promise=p.finally(()=>{for(let e=0;e<this.uploads.length;++e)if(this.uploads[e]===m)return void this.uploads.splice(e,1)}),m.promise.abort=p.abort,this.uploads.push(m),m.promise}cancelUpload(e){return!!e.abort&&(e.abort(),!0)}getCurrentUploads(){return this.uploads}idServerRequest(e,t,n,i,s,o){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");const r=this.opts.idBaseUrl+s+n;if(void 0!==e&&!a.s(e))throw Error("Expected callback to be a function but got "+typeof e);const c={uri:r,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};t===b.Get?c.qs=i:"object"==typeof i&&(c.json=i),o&&(c.headers.Authorization="Bearer "+o);const l=a.l();return this.opts.request(c,w(l,e,this.opts.onlyData)),l.promise}generateWebSocket(e){e||(e={}),e.access_token||(e.access_token=this.opts.accessToken);let t="ws://"+this.opts.baseUrl.substring("http://".length);this.opts.baseUrl.startsWith("https://")&&(t="wss://"+this.opts.baseUrl.substring("https://".length));const n={filter:e.filter,since:e.since,access_token:e.access_token};return new WebSocket(t+"/_matrix/client/ws/r0?"+a.m(n),"m.json")}authedRequest(e,t,n,i,s,o){i||(i={});let r=o||{};this.opts.useAuthorizationHeader?(isFinite(o)&&(r={localTimeoutMs:o}),r.headers||(r.headers={}),r.headers.Authorization||(r.headers.Authorization="Bearer "+this.opts.accessToken),i.access_token&&delete i.access_token):i.access_token||(i.access_token=this.opts.accessToken);const a=this.request(e,t,n,i,s,r);return a.catch(e=>{var t;"M_UNKNOWN_TOKEN"!=e.errcode||null!==(t=r)&&void 0!==t&&t.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==e.errcode&&this.eventEmitter.emit(y.NoConsent,e.message,e.data.consent_uri):this.eventEmitter.emit(y.SessionLoggedOut,e)}),a}request(e,t,n,i,s,o){var r;const a=null!==(r=null==o?void 0:o.prefix)&&void 0!==r?r:this.opts.prefix,c=this.opts.baseUrl+a+n;return this.requestOtherUrl(e,t,c,i,s,o)}requestOtherUrl(e,t,n,i,s,o){let r=o||{};return isFinite(o)&&(r={localTimeoutMs:o}),this.doRequest(e,t,n,i,s,r)}getUrl(e,t,n){let i="";return t&&(i="?"+a.m(t)),this.opts.baseUrl+n+e+i}doRequest(e,t,n,i,s,o){var c;if(void 0!==e&&!a.s(e))throw Error("Expected callback to be a function but got "+typeof e);this.opts.extraParams&&(i=d(d({},i||{}),this.opts.extraParams));const l=Object.assign({},o.headers||{});o||(o={});const u=null===(c=o.json)||void 0===c||c;let h=o.bodyParser;u&&(s&&(s=JSON.stringify(s),l["content-type"]="application/json"),l.accept||(l.accept="application/json"),void 0===h&&(h=function(e){return JSON.parse(e)}));const m=a.l();let p,g,f=!1;const v=o.localTimeoutMs||this.opts.localTimeoutMs,b=()=>{v&&(p&&r.a(p),p=r.b((function(){var e,t;f=!0,null===(e=g)||void 0===e||null===(t=e.abort)||void 0===t||t.call(e),m.reject(new C({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:v}))}),v))};b();const y=m.promise;try{g=this.opts.request({uri:n,method:t,withCredentials:!1,qs:i,qsStringifyOptions:o.qsStringifyOptions,useQuerystring:!0,body:s,json:!1,timeout:v,headers:l||{},_matrix_opts:this.opts},(t,n,i)=>{if(v&&(r.a(p),f))return;w(m,e,this.opts.onlyData,h)(t,n,i)}),g&&("onprogress"in g&&(g.onprogress=e=>{b()}),g.abort&&(y.abort=g.abort.bind(g)))}catch(t){m.reject(t),e&&e(t)}return y}}function E(e){return e.status||e.statusCode}function w(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;return function(s,o,r){if(s){"AbortError"===s.name||"aborted"===s||s instanceof C||(s=new O("request failed",s))}let a=r;if(!s)try{E(o)>=400?s=_(o,r):i&&(a=i(r))}catch(e){s=new Error("Error parsing server response: "+e)}if(s)e.reject(s),null==t||t(s);else if(n)e.resolve(a),null==t||t(null,a);else{const n={code:E(o),headers:o.headers,data:a};e.resolve(n),null==t||t(null,n)}}}function _(e,t){const n=E(e),i=function(e){let t;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return Object(o.parse)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e);let s;if(i)if("application/json"===i.type){const e="object"==typeof t?t:JSON.parse(t);s=new C(e)}else"text/plain"===i.type&&(s=new Error(`Server returned ${n} error: ${t}`));return s||(s=new Error(`Server returned ${n} error`)),s.httpStatus=n,s}class C extends Error{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super("MatrixError: "+e.errcode),s()(this,"errcode",void 0),s()(this,"data",void 0),s()(this,"httpStatus",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}}class O extends Error{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;super(e+(t?": "+t.message:""))}get name(){return"ConnectionError"}}class R extends Error{constructor(){super("Operation aborted")}get name(){return"AbortError"}}async function I(e,t){let n=0,i=null;for(;n<e;)try{if(n>0){const e=1e3*Math.pow(2,n);c.a.log(`network operation failed ${n} times, retrying in ${e}ms...`),await Object(a.G)(e)}return t()}catch(e){if(!(e instanceof O))throw e;n+=1,i=e}throw i}}).call(this,n(30))},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM"}(i||(i={}))},,function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(89),c=n(91),l=n(450),d=n(272),u=n(101);class h extends r.a.Component{constructor(e){super(e),s()(this,"onAuthFinished",(e,t)=>{e?this.props.onFinished(!0,t):t===l.a?this.props.onFinished(!1,null):this.setState({authError:t})}),s()(this,"onUpdateStagePhase",(e,t)=>{this.setState({uiaStage:e,uiaStagePhase:t})}),s()(this,"onDismissClick",()=>{this.props.onFinished(!1)}),this.state={authError:null,uiaStage:null,uiaStagePhase:null}}getDefaultDialogAesthetics(){const e={[d.c.PHASE_PREAUTH]:{title:Object(a.a)("Use Single Sign On to continue"),body:Object(a.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(a.a)("Single Sign On"),continueKind:"primary"},[d.c.PHASE_POSTAUTH]:{title:Object(a.a)("Confirm to continue"),body:Object(a.a)("Click the button below to confirm your identity."),continueText:Object(a.a)("Confirm"),continueKind:"primary"}};return{[d.c.LOGIN_TYPE]:e,[d.c.UNSTABLE_LOGIN_TYPE]:e}}render(){let e=this.state.authError?"Error":this.props.title||Object(a.a)("Authentication"),t=this.state.authError?null:this.props.body,n=null,i=null;const s=this.props.aestheticsForStagePhases||this.getDefaultDialogAesthetics();if(!this.state.authError&&s&&s[this.state.uiaStage]){const o=s[this.state.uiaStage][this.state.uiaStagePhase];o&&o.title&&(e=o.title),o&&o.body&&(t=o.body),o&&o.continueText&&(n=o.continueText),o&&o.continueKind&&(i=o.continueKind)}let o;return o=this.state.authError?r.a.createElement("div",{id:"mx_Dialog_content"},r.a.createElement("div",{role:"alert"},this.state.authError.message||this.state.authError.toString()),r.a.createElement("br",null),r.a.createElement(c.a,{onClick:this.onDismissClick,className:"mx_GeneralButton",autoFocus:!0},Object(a.a)("Dismiss"))):r.a.createElement("div",{id:"mx_Dialog_content"},t,r.a.createElement(l.b,{matrixClient:this.props.matrixClient,authData:this.props.authData,makeRequest:this.props.makeRequest,onAuthFinished:this.onAuthFinished,onStagePhaseChange:this.onUpdateStagePhase,continueText:n,continueKind:i})),r.a.createElement(u.a,{className:"mx_InteractiveAuthDialog",onFinished:this.props.onFinished,title:e,contentId:"mx_Dialog_content"},o)}}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return S}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(98),c=n(95),l=n(89),d=n(338),u=n(91),h=n(115),m=n(101),p=n(105),g=n(102),f=n(110),v=n(513),b=n(92),y=n(96);class S extends r.a.Component{constructor(e){super(e),s()(this,"unmounted",void 0),s()(this,"onCancel",()=>{this.props.onFinished(!1)}),s()(this,"onSubmit",()=>{if(!(this.state.text&&this.state.text.trim()||this.state.issueUrl&&this.state.issueUrl.trim()))return void this.setState({err:Object(l.a)("Please tell us what went wrong or, better, create a GitHub issue that describes the problem.")});const e=(this.state.text.length>0?this.state.text+"\n\n":"")+"Issue: "+(this.state.issueUrl.length>0?this.state.issueUrl:"No issue link given");this.setState({busy:!0,progress:null,err:null}),this.sendProgressCallback(Object(l.a)("Preparing to send logs")),Object(d.a)(a.b.get().bug_report_endpoint_url,{userText:e,sendLogs:!0,progressCallback:this.sendProgressCallback,labels:this.props.label?[this.props.label]:[]}).then(()=>{this.unmounted||(this.props.onFinished(!1),c.a.createTrackedDialog("Bug report sent","",h.a,{title:Object(l.a)("Logs sent"),description:Object(l.a)("Thank you!"),hasCancelButton:!1}))},e=>{this.unmounted||this.setState({busy:!1,progress:null,err:Object(l.a)("Failed to send logs: ")+""+e.message})}),Object(v.b)(this.state.text,this.state.issueUrl,this.props.error)}),s()(this,"onDownload",async()=>{this.setState({downloadBusy:!0}),this.downloadProgressCallback(Object(l.a)("Preparing to download logs"));try{await Object(d.b)({sendLogs:!0,progressCallback:this.downloadProgressCallback,labels:this.props.label?[this.props.label]:[]}),this.setState({downloadBusy:!1,downloadProgress:null})}catch(e){this.unmounted||this.setState({downloadBusy:!1,downloadProgress:Object(l.a)("Failed to send logs: ")+""+e.message})}}),s()(this,"onTextChange",e=>{this.setState({text:e.currentTarget.value})}),s()(this,"onIssueUrlChange",e=>{this.setState({issueUrl:e.currentTarget.value})}),s()(this,"sendProgressCallback",e=>{this.unmounted||this.setState({progress:e})}),s()(this,"downloadProgressCallback",e=>{this.unmounted||this.setState({downloadProgress:e})}),this.state={sendLogs:!0,busy:!1,err:null,issueUrl:"",text:e.initialText||"",progress:null,downloadBusy:!1,downloadProgress:null},this.unmounted=!1,b.a.dispatch({action:y.a.DumpDebugLogs})}componentWillUnmount(){this.unmounted=!0}render(){let e=null;this.state.err&&(e=r.a.createElement("div",{className:"error"},this.state.err));let t,n=null;return this.state.busy&&(n=r.a.createElement("div",{className:"progress"},r.a.createElement(g.a,null),this.state.progress," ...")),window.Modernizr&&Object.values(window.Modernizr).some(e=>!1===e)&&(t=r.a.createElement("p",null,r.a.createElement("b",null,Object(l.a)("Reminder: Your browser is unsupported, so your experience may be unpredictable.")))),r.a.createElement(m.a,{className:"mx_BugReportDialog",onFinished:this.onCancel,title:Object(l.a)("Submit debug logs"),contentId:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},t,r.a.createElement("p",null,Object(l.a)("Debug logs contain application usage data including your username, the IDs or aliases of the rooms you have visited, which UI elements you last interacted with, and the usernames of other users. They do not contain messages.")),r.a.createElement("p",null,r.a.createElement("b",null,Object(l.a)("Before submitting logs, you must <a>create a GitHub issue</a> to describe your problem.",{},{a:e=>r.a.createElement("a",{target:"_blank",href:"https://github.com/vector-im/element-web/issues/new/choose"},e)}))),r.a.createElement("div",{className:"mx_BugReportDialog_download"},r.a.createElement(u.a,{onClick:this.onDownload,kind:"link",disabled:this.state.downloadBusy},Object(l.a)("Download logs")),this.state.downloadProgress&&r.a.createElement("span",null,this.state.downloadProgress," ...")),r.a.createElement(p.a,{type:"text",className:"mx_BugReportDialog_field_input",label:Object(l.a)("GitHub issue"),onChange:this.onIssueUrlChange,value:this.state.issueUrl,placeholder:"https://github.com/vector-im/element-web/issues/..."}),r.a.createElement(p.a,{className:"mx_BugReportDialog_field_input",element:"textarea",label:Object(l.a)("Notes"),rows:5,onChange:this.onTextChange,value:this.state.text,placeholder:Object(l.a)("If there is additional context that would help in analysing the issue, such as what you were doing at the time, room IDs, user IDs, etc., please include those things here.")}),n,e),r.a.createElement(f.a,{primaryButton:Object(l.a)("Send logs"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}}},,function(e,t,n){"use strict";n.r(t),n.d(t,"CHAT_EFFECTS",(function(){return s}));var i=n(89);const s=[{emojis:["🎊","🎉"],msgType:"nic.custom.confetti",command:"confetti",description:()=>Object(i.c)("Sends the given message with confetti"),fallbackMessage:()=>Object(i.a)("sends confetti")+" 🎉",options:{maxCount:150,speed:3,frameInterval:15,alpha:1,gradient:!1}},{emojis:["🎆"],msgType:"nic.custom.fireworks",command:"fireworks",description:()=>Object(i.c)("Sends the given message with fireworks"),fallbackMessage:()=>Object(i.a)("sends fireworks")+" 🎆",options:{maxCount:500,gravity:.05}},{emojis:["🌧️","⛈️","🌦️"],msgType:"io.element.effect.rainfall",command:"rainfall",description:()=>Object(i.c)("Sends the given message with rainfall"),fallbackMessage:()=>Object(i.a)("sends rainfall")+" 🌧️",options:{maxCount:600,speed:10}},{emojis:["❄","🌨"],msgType:"io.element.effect.snowfall",command:"snowfall",description:()=>Object(i.c)("Sends the given message with snowfall"),fallbackMessage:()=>Object(i.a)("sends snowfall")+" ❄",options:{maxCount:200,gravity:.05,maxDrift:5}},{emojis:["👾","🌌"],msgType:"io.element.effects.space_invaders",command:"spaceinvaders",description:()=>Object(i.c)("Sends the given message with a space themed effect"),fallbackMessage:()=>Object(i.a)("sends space invaders")+" 👾",options:{maxCount:50,gravity:.01}},{emojis:["💝"],msgType:"io.element.effect.hearts",command:"hearts",description:()=>Object(i.c)("Sends the given message with hearts"),fallbackMessage:()=>Object(i.a)("sends hearts")+" 💝",options:{maxCount:120,gravity:3.2}}]},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return M}));var i=n(88),s=n.n(i),o=n(216),r=n.n(o),a=n(0),c=n(119),l=n(98),d=n(95),u=n(361),h=n.n(u),m=n(225),p=n(93),g=n(429),f=n(90);class v{constructor(e,t){this.apiUrl=e,this.uiUrl=t,s()(this,"scalarToken",void 0),s()(this,"termsInteractionCallback",void 0),s()(this,"isDefaultManager",void 0),this.scalarToken=null,this.termsInteractionCallback=void 0;const n=l.b.get("integrations_rest_url"),i=l.b.get("integrations_ui_url");this.isDefaultManager=e===n&&i===t}writeTokenToStore(){window.localStorage.setItem("mx_scalar_token_at_"+this.apiUrl,this.scalarToken),this.isDefaultManager&&window.localStorage.removeItem("mx_scalar_token")}readTokenFromStore(){let e=window.localStorage.getItem("mx_scalar_token_at_"+this.apiUrl);return!e&&this.isDefaultManager&&(e=window.localStorage.getItem("mx_scalar_token")),e}readToken(){return this.scalarToken?this.scalarToken:this.readTokenFromStore()}setTermsInteractionCallback(e){this.termsInteractionCallback=e}connect(){return this.getScalarToken().then(e=>{this.scalarToken=e})}hasCredentials(){return null!=this.scalarToken}getScalarToken(){const e=this.readToken();return e?this.checkToken(e).catch(e=>{if(e instanceof g.b)throw e;return this.registerForToken()}):this.registerForToken()}getAccountName(e){const t=this.apiUrl+"/account";return new Promise((function(n,i){h()({method:"GET",uri:t,qs:{scalar_token:e,v:"1.1"},json:!0},(e,t,s)=>{e?i(e):s&&"M_TERMS_NOT_SIGNED"===s.errcode?i(new g.b):t.statusCode/100!=2?i(s):s&&s.user_id?n(s.user_id):i(new Error("Missing user_id in response"))})}))}checkToken(e){return this.getAccountName(e).then(t=>{const n=f.a.get().getUserId();if(t!==n)throw new Error("Scalar token is owned by someone else: "+n);return e}).catch(t=>{if(t instanceof g.b){a.a.log("Integration manager requires new terms to be agreed to");const t=r.a.parse(this.apiUrl);return t.path="",t.pathname="",Object(g.d)([new g.a(m.a.IM,r.a.format(t),e)],this.termsInteractionCallback).then(()=>e)}throw t})}registerForToken(){return f.a.get().getOpenIdToken().then(e=>this.exchangeForScalarToken(e)).then(e=>this.checkToken(e)).then(e=>(this.scalarToken=e,this.writeTokenToStore(),e))}exchangeForScalarToken(e){const t=this.apiUrl;return new Promise((function(n,i){h()({method:"POST",uri:t+"/register",qs:{v:"1.1"},body:e,json:!0},(e,t,s)=>{e?i(e):t.statusCode/100!=2?i(new Error("Scalar request failed: "+t.statusCode)):s&&s.scalar_token?n(s.scalar_token):i(new Error("Missing scalar_token in response"))})}))}getScalarPageTitle(e){let t=this.apiUrl+"/widgets/title_lookup";return t=this.getStarterLink(t),t+="&curl="+encodeURIComponent(e),new Promise((function(e,n){h()({method:"GET",uri:t,json:!0},(t,i,s)=>{if(t)n(t);else if(i.statusCode/100!=2)n(new Error("Scalar request failed: "+i.statusCode));else if(s){let t="";s.page_title_cache_item&&s.page_title_cache_item.cached_title&&(t=s.page_title_cache_item.cached_title),e(t)}else n(new Error("Missing page title in response"))})}))}disableWidgetAssets(e,t){let n=this.apiUrl+"/widgets/set_assets_state";return n=this.getStarterLink(n),new Promise((i,s)=>{h()({method:"GET",uri:n,json:!0,qs:{widget_type:e.preferred,widget_id:t,state:"disable"}},(e,t,n)=>{e?s(e):t.statusCode/100!=2?s(new Error("Scalar request failed: "+t.statusCode)):n?i():s(new Error("Failed to set widget assets state"))})})}getScalarInterfaceUrlForRoom(e,t,n){const i=e.roomId,s=e.name;let o=this.uiUrl;return o+="?scalar_token="+encodeURIComponent(this.scalarToken),o+="&room_id="+encodeURIComponent(i),o+="&room_name="+encodeURIComponent(s),o+="&theme="+encodeURIComponent(p.b.getValue("theme")),n&&(o+="&integ_id="+encodeURIComponent(n)),t&&(o+="&screen="+encodeURIComponent(t)),o}getStarterLink(e){return e+"?scalar_token="+encodeURIComponent(this.scalarToken)}}var b=n(87),y=n.n(b),S=n(89),E=n(92),w=n(102),_=n(114),C=n(109);class O extends y.a.Component{constructor(){super(...arguments),s()(this,"dispatcherRef",void 0),s()(this,"state",{errored:!1}),s()(this,"onKeyDown",e=>{switch(Object(_.a)().getAccessibilityAction(e)){case C.h.Escape:e.stopPropagation(),e.preventDefault(),this.props.onFinished()}}),s()(this,"onAction",e=>{"close_scalar"===e.action&&this.props.onFinished()}),s()(this,"onError",()=>{this.setState({errored:!0})})}componentDidMount(){this.dispatcherRef=E.a.register(this.onAction),document.addEventListener("keydown",this.onKeyDown)}componentWillUnmount(){E.a.unregister(this.dispatcherRef),document.removeEventListener("keydown",this.onKeyDown)}render(){return this.props.loading?y.a.createElement("div",{className:"mx_IntegrationManager_loading"},y.a.createElement("h3",null,Object(S.a)("Connecting to integration manager...")),y.a.createElement(w.a,null)):!this.props.connected||this.state.errored?y.a.createElement("div",{className:"mx_IntegrationManager_error"},y.a.createElement("h3",null,Object(S.a)("Cannot connect to integration manager")),y.a.createElement("p",null,Object(S.a)("The integration manager is offline or it cannot reach your homeserver."))):y.a.createElement("iframe",{title:Object(S.a)("Integration manager"),src:this.props.url,onError:this.onError})}}let R;s()(O,"defaultProps",{connected:!0,loading:!1}),function(e){e.Account="account",e.Config="config",e.Homeserver="homeserver"}(R||(R={}));class I{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,i=arguments.length>3?arguments[3]:void 0;s()(this,"apiUrl",void 0),s()(this,"uiUrl",void 0),s()(this,"kind",void 0),s()(this,"id",void 0),this.kind=e,this.apiUrl=t,this.uiUrl=n,this.id=i}get name(){return r.a.parse(this.uiUrl).host}get trimmedApiUrl(){const e=r.a.parse(this.apiUrl);return e.pathname="",e.path="",r.a.format(e)}getScalarClient(){return new v(this.apiUrl,this.uiUrl)}async open(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(!p.b.getValue("integrationProvisioning"))return M.sharedInstance().showDisabledDialog();const i=d.a.createTrackedDialog("Integration Manager","",O,{loading:!0},"mx_IntegrationManager"),s=this.getScalarClient();s.setTermsInteractionCallback((e,t)=>Object(g.c)(e,t,"mx_TermsDialog_forIntegrationManager"));const o={};try{await s.connect(),s.hasCredentials()?o.url=s.getScalarInterfaceUrlForRoom(e,t,n):o.connected=!1}catch(e){if(e instanceof g.b)return void i.close();a.a.error(e),o.connected=!1}i.close(),d.a.createTrackedDialog("Integration Manager","",O,o,"mx_IntegrationManager")}}var k=n(101),x=n(110);class T extends y.a.Component{constructor(){super(...arguments),s()(this,"onAcknowledgeClick",()=>{this.props.onFinished()})}render(){const e=l.b.get().brand;return y.a.createElement(k.a,{className:"mx_IntegrationsImpossibleDialog",hasCancel:!1,onFinished:this.props.onFinished,title:Object(S.a)("Integrations not allowed")},y.a.createElement("div",{className:"mx_IntegrationsImpossibleDialog_content"},y.a.createElement("p",null,Object(S.a)("Your %(brand)s doesn't allow you to use an integration manager to do this. Please contact an admin.",{brand:e}))),y.a.createElement(x.a,{primaryButton:Object(S.a)("OK"),onPrimaryButtonClick:this.onAcknowledgeClick,hasCancel:!1}))}}var j=n(96);class N extends y.a.Component{constructor(){super(...arguments),s()(this,"onAcknowledgeClick",()=>{this.props.onFinished()}),s()(this,"onOpenSettingsClick",()=>{this.props.onFinished(),E.a.fire(j.a.ViewUserSettings)})}render(){return y.a.createElement(k.a,{className:"mx_IntegrationsDisabledDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(S.a)("Integrations are disabled")},y.a.createElement("div",{className:"mx_IntegrationsDisabledDialog_content"},y.a.createElement("p",null,Object(S.a)("Enable 'Manage Integrations' in Settings to do this."))),y.a.createElement(x.a,{primaryButton:Object(S.a)("Settings"),onPrimaryButtonClick:this.onOpenSettingsClick,cancelButton:Object(S.a)("OK"),onCancel:this.onAcknowledgeClick}))}}var P=n(142),D=n(149);const A=[R.Account,R.Homeserver,R.Config];class M{static sharedInstance(){return M.instance||(M.instance=new M),M.instance}constructor(){s()(this,"managers",[]),s()(this,"client",void 0),s()(this,"primaryManager",void 0),s()(this,"setupHomeserverManagers",async e=>{if(a.a.log("Updating homeserver-configured integration managers..."),e&&e["m.integrations"]){let t=e["m.integrations"].managers;Array.isArray(t)||(t=[]),a.a.log(`Homeserver has ${t.length} integration managers`),this.managers=this.managers.filter(e=>e.kind!==R.Homeserver);for(const e of t)e.api_url&&this.managers.push(new I(R.Homeserver,e.api_url,e.ui_url));this.primaryManager=null}else a.a.log("Homeserver has no integration managers")}),s()(this,"onAccountData",e=>{"m.widgets"===e.getType()&&this.compileManagers()}),this.compileManagers()}startWatching(){this.stopWatching(),this.client=f.a.get(),this.client.on(c.b.AccountData,this.onAccountData),this.client.on(c.b.ClientWellKnown,this.setupHomeserverManagers),this.compileManagers()}stopWatching(){this.client&&(this.client.removeListener(c.b.AccountData,this.onAccountData),this.client.removeListener(c.b.ClientWellKnown,this.setupHomeserverManagers))}compileManagers(){this.managers=[],this.setupConfiguredManager(),this.setupAccountManagers()}setupConfiguredManager(){const e=l.b.get("integrations_rest_url"),t=l.b.get("integrations_ui_url");e&&t&&(this.managers.push(new I(R.Config,e,t)),this.primaryManager=null)}setupAccountManagers(){if(!this.client||!this.client.getUserId())return;P.a.getIntegrationManagerWidgets().forEach(e=>{const t=e.content.data;if(!t)return;const n=e.content.url,i=t.api_url;if(!i||!n)return;const s=new I(R.Account,i,n,e.id||e.state_key||"");this.managers.push(s)}),this.primaryManager=null}hasManager(){return this.managers.length>0}getOrderedManagers(){const e=[];for(const t of A){const n=this.managers.filter(e=>e.kind===t);n&&n.length&&(t===R.Account&&n.sort((e,t)=>Object(D.a)(e.id,t.id)),e.push(...n))}return e}getPrimaryManager(){return this.hasManager()?(this.primaryManager||(this.primaryManager=this.getOrderedManagers()[0]),this.primaryManager):null}openNoManagerDialog(){d.a.createTrackedDialog("Integrations impossible","",T)}showDisabledDialog(){d.a.createTrackedDialog("Integrations disabled","",N)}async overwriteManagerOnAccount(e){await P.a.removeIntegrationManagerWidgets(),await P.a.addIntegrationManagerWidget(e.name,e.uiUrl,e.apiUrl)}async tryDiscoverManager(e){let t;a.a.log("Looking up integration manager via .well-known"),(e.startsWith("http:")||e.startsWith("https:"))&&(e=r.a.parse(e).host);try{const n=await fetch(`https://${e}/.well-known/matrix/integrations`);t=await n.json()}catch(e){return a.a.error(e),a.a.warn("Failed to locate integration manager"),null}if(!t||!t["m.integrations_widget"])return a.a.warn("Missing integrations widget on .well-known response"),null;const n=t["m.integrations_widget"];if(!n.url||!n.data||!n.data.api_url)return a.a.warn("Malformed .well-known response for integrations widget"),null;const i=new I(R.Account,n.data.api_url,n.url);return a.a.log("Got an integration manager (untested)"),i}}s()(M,"instance",void 0),window.mxIntegrationManagers=M},function(e,t,n){"use strict";var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a);var l=n(140);const d=["children","tooltipTargetClassName","className","id","label","alignment","tooltipClassName","maxParentWidth","ignoreHover"];t.a=e=>{let{children:t,tooltipTargetClassName:n,className:i,id:o,label:u,alignment:h,tooltipClassName:m,maxParentWidth:p,ignoreHover:g}=e,f=r()(e,d);const[v,b]=function(){const[e,t]=Object(a.useState)(!1);return[e,{onFocus:()=>t(!0),onBlur:()=>t(!1)}]}(),[y,S]=function(e){const[t,n]=Object(a.useState)(!1);return[t,{onMouseOver:()=>n(!0),onMouseLeave:()=>n(!1),onMouseMove:t=>{n(!e(t))}}]}(g||(()=>!1)),E=(v||y)&&c.a.createElement(l.b,{id:o,className:i,tooltipClassName:m,label:u,alignment:h,visible:v||y,maxParentWidth:p});return c.a.createElement("div",s()({},S,b,{tabIndex:0,"aria-describedby":o,className:n},f),t,E)}},function(e,t,n){"use strict";n.r(t),n.d(t,"makeHtmlMessage",(function(){return u})),n.d(t,"makeHtmlNotice",(function(){return h})),n.d(t,"makeHtmlEmote",(function(){return m})),n.d(t,"makeTextMessage",(function(){return p})),n.d(t,"makeNotice",(function(){return g})),n.d(t,"makeEmoteMessage",(function(){return f})),n.d(t,"getTextForLocationEvent",(function(){return v})),n.d(t,"makeLocationContent",(function(){return b})),n.d(t,"parseLocationEvent",(function(){return y})),n.d(t,"makeTopicContent",(function(){return S})),n.d(t,"parseTopicContent",(function(){return E})),n.d(t,"makeBeaconInfoContent",(function(){return w})),n.d(t,"parseBeaconInfoContent",(function(){return _})),n.d(t,"makeBeaconContent",(function(){return C})),n.d(t,"parseBeaconContent",(function(){return O}));var i=n(17),s=n.n(i),o=n(434),r=n(97),a=n(35),c=n(18);const l=new(n(3).b)("m.topic","org.matrix.msc3765.topic");function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e,t){return{msgtype:r.c.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function h(e,t){return{msgtype:r.c.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function m(e,t){return{msgtype:r.c.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function p(e){return{msgtype:r.c.Text,body:e}}function g(e){return{msgtype:r.c.Notice,body:e}}function f(e){return{msgtype:r.c.Emote,body:e}}const v=(e,t,n,i)=>{const s="at "+new Date(n).toISOString();return[t===c.a.Self?"User":void 0,"Location",i?`"${i}"`:void 0,e,s].filter(Boolean).join(" ")},b=(e,t,n,i,o)=>{const l=null!=e?e:v(t,o||c.a.Self,n,i),u=n?{[c.d.name]:n}:{};return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({msgtype:r.c.Location,body:l,geo_uri:t,[c.c.name]:{description:i,uri:t},[c.b.name]:{type:o||c.a.Self},[a.a.name]:l},u)},y=e=>{var t,n;const i=c.c.findIn(e),s=c.b.findIn(e),o=c.d.findIn(e),r=a.a.findIn(e),l=null!==(t=null==i?void 0:i.uri)&&void 0!==t?t:null==e?void 0:e.geo_uri,d=null==i?void 0:i.description,u=null!==(n=null==s?void 0:s.type)&&void 0!==n?n:c.a.Self,h=null!=r?r:e.body;return b(h,l,o,d,u)},S=(e,t)=>{const n=[{body:e,mimetype:"text/plain"}];return Object(o.isProvided)(t)&&n.push({body:t,mimetype:"text/html"}),{topic:e,[l.name]:n}},E=e=>{var t,n,i;const s=l.findIn(e);return{text:null!==(t=null==s||null===(n=s.find(e=>!Object(o.isProvided)(e.mimetype)||"text/plain"===e.mimetype))||void 0===n?void 0:n.body)&&void 0!==t?t:e.topic,html:null==s||null===(i=s.find(e=>"text/html"===e.mimetype))||void 0===i?void 0:i.body}},w=(e,t,n,i,s)=>({description:n,timeout:e,live:t,[c.d.name]:s||Date.now(),[c.b.name]:{type:null!=i?i:c.a.Self}}),_=e=>{const{description:t,timeout:n,live:i}=e,{type:s}=c.b.findIn(e);return{description:t,timeout:n,live:i,assetType:s,timestamp:c.d.findIn(e)}},C=(e,t,n,i)=>({[c.c.name]:{description:i,uri:e},[c.d.name]:t,"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:n}}),O=e=>{const{description:t,uri:n}=c.c.findIn(e);return{description:t,uri:n,timestamp:c.d.findIn(e)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d})),n.d(t,"c",(function(){return u})),n.d(t,"d",(function(){return h}));var i=n(88),s=n.n(i),o=n(97),r=n(90);var a={};function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){return d(e.getCanonicalAlias(),e.getAltAliases())}function d(e,t){return a.getDisplayAliasForAliasSet?a.getDisplayAliasForAliasSet(e,t):e||(null==t?void 0:t[0])}function u(e,t){let n;if(t){n=function(e,t){let n,i;for(const s of e.getJoinedMembers())s.userId!=t&&(void 0===n||s.events.member&&s.events.member.getTs()<n)&&(i=s,n=s.events.member.getTs());if(i)return i.userId;for(const s of e.currentState.getMembers())s.userId!=t&&(void 0===n||s.events.member&&s.events.member.getTs()<n)&&(i=s,n=s.events.member.getTs());return void 0===i?t:i.userId}(e,r.a.get().getUserId())}else n=null;return h(e.roomId,n)}async function h(e,t){if(r.a.get().isGuest())return;const n=r.a.get().getAccountData(o.b.Direct);let i={};void 0!==n&&(i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},n.getContent()));for(const n of Object.keys(i)){const s=i[n];if(n!=t){const t=s.indexOf(e);t>-1&&s.splice(t,1)}}if(t){const n=i[t]||[];-1==n.indexOf(e)&&n.push(e),i[t]=n}await r.a.get().setAccountData(o.b.Direct,i)}},function(e,t,n){"use strict";n.d(t,"d",(function(){return p})),n.d(t,"b",(function(){return g})),n.d(t,"a",(function(){return f})),n.d(t,"c",(function(){return v}));var i=n(88),s=n.n(i),o=n(8),r=n.n(o),a=n(178),c=n(0),l=n(123),d=n(121);class u{constructor(e){var t=this;this.context=e,s()(this,"clipStart",0),s()(this,"stopped",!0),s()(this,"lastCheck",0),s()(this,"observable",new a.SimpleObservable),s()(this,"timerId",void 0),s()(this,"clipDuration",0),s()(this,"placeholderDuration",0),s()(this,"checkTime",(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const n=t.timeSeconds;(t.lastCheck!==n||e)&&(t.observable.update([n,t.durationSeconds]),t.lastCheck=n)}))}get durationSeconds(){return this.clipDuration||this.placeholderDuration}set durationSeconds(e){this.clipDuration=e,this.observable.update([this.timeSeconds,this.clipDuration])}get timeSeconds(){return(this.context.currentTime-this.clipStart)%this.clipDuration}get liveData(){return this.observable}populatePlaceholdersFrom(e){var t;const n=Number(null===(t=e.getContent().info)||void 0===t?void 0:t.duration);Number.isFinite(n)&&(this.placeholderDuration=n/1e3)}flagLoadTime(){this.clipStart=this.context.currentTime}flagStart(){this.stopped&&(this.clipStart=this.context.currentTime,this.stopped=!1),this.timerId||(this.timerId=setInterval(this.checkTime,100))}flagStop(){this.stopped=!0,this.clipStart=this.context.currentTime}syncTo(e,t){this.clipStart=e-t,this.stopped=!1,this.checkTime(!0)}destroy(){this.observable.close(),this.timerId&&clearInterval(this.timerId)}}var h=n(776),m=n(250);let p;!function(e){e.Decoding="decoding",e.Stopped="stopped",e.Paused="paused",e.Playing="playing"}(p||(p={}));const g=39,f=Object(d.h)(0,g);class v extends r.a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f;super(),this.buf=e,s()(this,"thumbnailWaveform",void 0),s()(this,"context",void 0),s()(this,"source",void 0),s()(this,"state",p.Decoding),s()(this,"audioBuf",void 0),s()(this,"element",void 0),s()(this,"resampledWaveform",void 0),s()(this,"waveformObservable",new a.SimpleObservable),s()(this,"clock",void 0),s()(this,"fileSize",void 0),s()(this,"onPlaybackEnd",async()=>{await this.context.suspend(),this.emit(p.Stopped)}),this.fileSize=this.buf.byteLength,this.context=Object(h.a)(),this.resampledWaveform=Object(d.c)(null!=t?t:f,g),this.thumbnailWaveform=Object(d.c)(null!=t?t:f,100),this.waveformObservable.update(this.resampledWaveform),this.clock=new u(this.context)}get sizeBytes(){return this.fileSize}get waveform(){return this.resampledWaveform}get waveformData(){return this.waveformObservable}get clockInfo(){return this.clock}get currentState(){return this.state}get isPlaying(){return this.currentState===p.Playing}emit(e){this.state=e;for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n),super.emit(l.b,e,...n),!0}destroy(){this.stop(),this.removeAllListeners(),this.clock.destroy(),this.waveformObservable.close(),this.element&&(URL.revokeObjectURL(this.element.src),this.element.remove())}async prepare(){if(this.state===p.Decoding){if(this.buf.byteLength>5242880){c.a.log("Audio file too large: processing through <audio /> element"),this.element=document.createElement("AUDIO");const e=new Promise((e,t)=>{this.element.onloadeddata=()=>e(null),this.element.onerror=e=>t(e)});this.element.src=URL.createObjectURL(new Blob([this.buf])),await e}else{this.audioBuf=await new Promise((e,t)=>{this.context.decodeAudioData(this.buf,t=>e(t),async n=>{try{c.a.error("Error decoding recording: ",n),c.a.warn("Trying to re-encode to WAV instead...");const i=await Object(h.b)(this.buf);this.context.decodeAudioData(i,t=>e(t),e=>{c.a.error("Still failed to decode recording: ",e),t(e)})}catch(n){c.a.error("Caught decoding error:",n),t(n)}})});const e=Array.from(this.audioBuf.getChannelData(0));this.resampledWaveform=function(e){const t=e.map(e=>Math.abs(e));return Object(d.g)(Object(d.i)(t,g),0,1)}(e)}this.waveformObservable.update(this.resampledWaveform),this.clock.flagLoadTime(),this.clock.durationSeconds=this.element?this.element.duration:this.audioBuf.duration,this.emit(p.Stopped)}}async play(){this.state===p.Stopped&&(this.disconnectSource(),this.makeNewSourceBuffer(),this.element?await this.element.play():this.source.start()),await this.context.resume(),this.clock.flagStart(),this.emit(p.Playing)}disconnectSource(){var e,t;this.element||(null===(e=this.source)||void 0===e||e.disconnect(),null===(t=this.source)||void 0===t||t.removeEventListener("ended",this.onPlaybackEnd))}makeNewSourceBuffer(){this.element&&this.source||(this.element?this.source=this.context.createMediaElementSource(this.element):(this.source=this.context.createBufferSource(),this.source.buffer=this.audioBuf),this.source.addEventListener("ended",this.onPlaybackEnd),this.source.connect(this.context.destination))}async pause(){await this.context.suspend(),this.emit(p.Paused)}async stop(){await this.onPlaybackEnd(),this.clock.flagStop()}async toggle(){this.isPlaying?await this.pause():await this.play()}async skipTo(e){e=Object(m.a)(e,0,this.clock.durationSeconds);const t=this.isPlaying;t&&await this.context.suspend();const n=this.context.currentTime;this.disconnectSource(),this.makeNewSourceBuffer(),this.clock.syncTo(n,e),this.element?this.element.currentTime=e:this.source.start(n,e),t?await this.context.resume():await this.pause()}}},,,function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return y})),n.d(t,"a",(function(){return _}));var i=n(17),s=n.n(i),o=n(200),r=n(113),a=n(7),c=n(273),l=n(144),d=n(282),u=n(0),h=n(243),m=n(119),p=n(224),g=n(97),f=n(116),v=n(151),b=n(364);let y;function S(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function E(){u.a.log(...arguments)}var w;!function(e){e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING"}(y||(y={})),function(e){e.Offline="offline",e.Online="online",e.Unavailable="unavailable"}(w||(w={}));class _{constructor(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.client=e,this.opts=n,s()(this,"_peekRoom",null),s()(this,"currentSyncRequest",null),s()(this,"syncState",null),s()(this,"syncStateData",null),s()(this,"catchingUp",!1),s()(this,"running",!1),s()(this,"keepAliveTimer",null),s()(this,"connectionReturnedDefer",null),s()(this,"notifEvents",[]),s()(this,"failedSyncCount",0),s()(this,"storeIsInvalid",!1),s()(this,"onOnline",()=>{E("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts.initialSyncLimit=null!==(t=this.opts.initialSyncLimit)&&void 0!==t?t:8,this.opts.resolveInvitesToProfiles=this.opts.resolveInvitesToProfiles||!1,this.opts.pollTimeout=this.opts.pollTimeout||3e4,this.opts.pendingEventOrdering=this.opts.pendingEventOrdering||m.d.Chronological,this.opts.experimentalThreadSupport=!0===this.opts.experimentalThreadSupport,n.canResetEntireTimeline||(n.canResetEntireTimeline=e=>!1),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[r.c.Timeline,r.c.TimelineReset])}createRoom(e){const t=this.client,{timelineSupport:n,unstableClientRelationAggregation:i}=t,s=new r.b(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:n,unstableClientRelationAggregation:i});return t.reEmitter.reEmit(s,[r.c.Name,r.c.Redaction,r.c.RedactionCancelled,r.c.Receipt,r.c.Tags,r.c.LocalEchoUpdated,r.c.AccountData,r.c.MyMembership,r.c.Timeline,r.c.TimelineReset]),this.registerStateListeners(s),s}registerStateListeners(e){const t=this.client;t.reEmitter.reEmit(e.currentState,[f.b.Events,f.b.Members,f.b.NewMember,f.b.Update,b.b.New,b.b.Update,b.b.Destroy,b.b.LivenessChange]),e.currentState.on(f.b.NewMember,(function(e,n,i){i.user=t.getUser(i.userId),t.reEmitter.reEmit(i,[v.b.Name,v.b.Typing,v.b.PowerLevel,v.b.Membership])}))}deregisterStateListeners(e){e.currentState.removeAllListeners(f.b.Events),e.currentState.removeAllListeners(f.b.Members),e.currentState.removeAllListeners(f.b.NewMember)}syncLeftRooms(){const e=this.client,t=new c.a(this.client.credentials.userId);t.setTimelineLimit(1),t.setIncludeLeaveRooms(!0);const n=this.opts.pollTimeout+8e4,i={timeout:0};return e.getOrCreateFilter(S(e.credentials.userId,"LEFT_ROOMS"),t).then((function(t){return i.filter=t,e.http.authedRequest(void 0,p.f.Get,"/sync",i,void 0,n)})).then(async t=>{var n;let i=[];return null!==(n=t.rooms)&&void 0!==n&&n.leave&&(i=this.mapSyncResponseToRoomArray(t.rooms.leave)),Promise.all(i.map(async t=>{const n=t.room;if(!t.isBrandNewRoom)return;t.timeline=t.timeline||{};const i=this.mapSyncEventsFormat(t.timeline,n),s=this.mapSyncEventsFormat(t.state,n);return n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,l.b.BACKWARDS),await this.processRoomEvents(n,s,i),n.recalculate(),e.store.storeRoom(n),e.emit(m.b.Room,n),this.processEventsForNotifs(n,i),n}))})}peek(e){if(this._peekRoom&&this._peekRoom.roomId===e)return Promise.resolve(this._peekRoom);const t=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then(e=>{e.messages=e.messages||{chunk:[]},e.messages.chunk=e.messages.chunk||[],e.state=e.state||[];const n=a.j(e.state).map(t.getEventMapper()),i=e.state.map(t.getEventMapper()),s=e.messages.chunk.map(t.getEventMapper());return e.presence&&Array.isArray(e.presence)&&e.presence.map(t.getEventMapper()).forEach((function(e){let n=t.store.getUser(e.getContent().user_id);n?n.setPresenceEvent(e):(n=C(t,e.getContent().user_id),n.setPresenceEvent(e),t.store.storeUser(n)),t.emit(m.b.Event,e)})),e.messages.start&&(this._peekRoom.oldState.paginationToken=e.messages.start),this._peekRoom.oldState.setStateEvents(n),this._peekRoom.currentState.setStateEvents(i),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(s.reverse(),!0,this._peekRoom.getLiveTimeline(),e.messages.start),t.store.storeRoom(this._peekRoom),t.emit(m.b.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){this._peekRoom===e?this.client.http.authedRequest(void 0,p.f.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,5e4).then(t=>{if(this._peekRoom!==e)return void E("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(this.client.getEventMapper()).forEach(e=>{let t=this.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=C(this.client,e.getContent().user_id),t.setPresenceEvent(e),this.client.store.storeUser(t)),this.client.emit(m.b.Event,e)});const n=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(this.client.getEventMapper());e.addLiveEvents(n),this.peekPoll(e,t.end)},n=>{u.a.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout(()=>{this.peekPoll(e,t)},3e4)}):E("Stopped peeking in room %s",e.roomId)}getSyncState(){return this.syncState}getSyncStateData(){return this.syncStateData}async recoverFromSyncStartupError(e,t){await e;const n=this.startKeepAlives();this.updateSyncState(y.Error,{error:t}),await n}async wasLazyLoadingToggled(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!1;if(!await this.client.store.isNewlyCreated()){const n=await this.client.store.getClientOptions();return n&&(t=!!n.lazyLoadMembers),t!==e}return!1}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(u.a.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(y.Error,{error:e}),!0)}sync(){const t=this.client;this.running=!0,e.window&&e.window.addEventListener&&e.window.addEventListener("online",this.onOnline,!1);let n=Promise.resolve(),i=null;const s=async()=>{try{E("Getting push rules...");const e=await t.getPushRules();E("Got push rules"),t.pushRules=e}catch(e){if(u.a.error("Getting push rules failed",e),this.shouldAbortSync(e))return;return E("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(n,e),void s()}r()},o=()=>{const e=new c.a(t.credentials.userId);return e.setTimelineLimit(this.opts.initialSyncLimit),e},r=async()=>{if(E("Checking lazy load status..."),this.opts.lazyLoadMembers&&t.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){E("Checking server lazy load support...");await t.doesServerSupportLazyLoading()?(E("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=o()),this.opts.filter.setLazyLoadMembers(!0)):(E("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)}E("Checking whether lazy loading has changed in store...");if(await this.wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this.storeIsInvalid=!0;const e=h.b.TOGGLED_LAZY_LOADING,t=new h.b(e,!!this.opts.lazyLoadMembers);return this.updateSyncState(y.Error,{error:t}),void u.a.warn("InvalidStoreError: store is not usable: stopping sync.")}this.opts.lazyLoadMembers&&this.opts.crypto&&this.opts.crypto.enableLazyLoading();try{E("Storing client options..."),await this.client.storeClientOptions(),E("Stored client options")}catch(e){throw u.a.error("Storing client options failed",e),e}a()},a=async()=>{let e,s;E("Getting filter..."),e=this.opts.filter?this.opts.filter:o();try{s=await t.getOrCreateFilter(S(t.credentials.userId),e)}catch(e){if(u.a.error("Getting filter failed",e),this.shouldAbortSync(e))return;return E("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(n,e),void a()}t.resetNotifTimelineSet(),null===this.currentSyncRequest&&(E("Sending first sync request..."),this.currentSyncRequest=this.doSyncRequest({filterId:s},i)),E("Waiting for saved sync before starting sync processing..."),await n,this.doSync({filterId:s})};t.isGuest()?this.doSync({}):(E("Getting saved sync token..."),n=t.store.getSavedSyncToken().then(e=>(E("Got saved sync token"),i=e,E("Getting saved sync..."),t.store.getSavedSync())).then(e=>{if(E("Got reply from saved sync, exists? "+!!e),e)return this.syncFromCache(e)}).catch(e=>{u.a.error("Getting saved sync failed",e)}),s())}stop(){var t;E("SyncApi.stop"),e.window&&e.window.removeEventListener&&e.window.removeEventListener("online",this.onOnline,!1),this.running=!1,null===(t=this.currentSyncRequest)||void 0===t||t.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=null)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}async syncFromCache(e){E("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const n={oldSyncToken:null,nextSyncToken:t,catchingUp:!1,fromCache:!0},i={next_batch:t,rooms:e.roomsData,account_data:{events:e.accountData}};try{await this.processSyncResponse(n,i)}catch(e){u.a.error("Error processing cached sync",e)}this.storeIsInvalid||this.updateSyncState(y.Prepared,n)}async doSync(e){const t=this.client;if(!this.running)return E("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=null),void this.updateSyncState(y.Stopped);const n=t.store.getSyncToken();let i;try{null===this.currentSyncRequest&&(this.currentSyncRequest=this.doSyncRequest(e,n)),i=await this.currentSyncRequest}catch(t){return void this.onSyncError(t,e)}finally{this.currentSyncRequest=null}t.store.setSyncToken(i.next_batch),this.failedSyncCount=0,await t.store.setSyncData(i);const s={oldSyncToken:n,nextSyncToken:i.next_batch,catchingUp:this.catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(s);try{await this.processSyncResponse(s,i)}catch(e){u.a.error("Caught /sync error",e),this.client.emit(m.b.SyncUnexpectedError,e)}s.catchingUp=this.catchingUp,e.hasSyncedBefore||(this.updateSyncState(y.Prepared,s),e.hasSyncedBefore=!0),this.opts.crypto&&await this.opts.crypto.onSyncCompleted(s),this.updateSyncState(y.Syncing,s),t.store.wantsSave()&&(this.opts.crypto&&await this.opts.crypto.saveDeviceList(0),t.store.save()),this.doSync(e)}doSyncRequest(e,t){const n=this.getSyncParams(e,t);return this.client.http.authedRequest(void 0,p.f.Get,"/sync",n,void 0,n.timeout+8e4)}getSyncParams(e,t){let n=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this.catchingUp)&&(this.catchingUp=!0,n=0);let i=e.filterId;this.client.isGuest()&&!i&&(i=this.getGuestFilter());const s={filter:i,timeout:n};return this.opts.disablePresence&&(s.set_presence=w.Offline),t?s.since=t:s._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(s.timeout=0),s}onSyncError(e,t){if(!this.running)return E("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=null),void this.updateSyncState(y.Stopped);u.a.error("/sync error %s",e),u.a.error(e),this.shouldAbortSync(e)||(this.failedSyncCount++,u.a.log("Number of consecutive failed sync requests:",this.failedSyncCount),E("Starting keep-alive"),this.startKeepAlives().then(e=>{e&&this.getSyncState()===y.Error&&this.updateSyncState(y.Catchup,{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),this.doSync(t)}),this.currentSyncRequest=null,this.updateSyncState(this.failedSyncCount>=3?y.Error:y.Reconnecting,{error:e}))}async processSyncResponse(e,t){var n;const i=this.client;if(t.presence&&Array.isArray(t.presence.events)&&t.presence.events.map(i.getEventMapper()).forEach((function(e){let t=i.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=C(i,e.getSender()),t.setPresenceEvent(e),i.store.storeUser(t)),i.emit(m.b.Event,e)})),t.account_data&&Array.isArray(t.account_data.events)){const e=t.account_data.events.map(i.getEventMapper()),n=e.reduce((e,t)=>(e[t.getId()]=i.store.getAccountData(t.getType()),e),{});i.store.storeAccountDataEvents(e),e.forEach((function(e){if(e.getType()===g.b.PushRules){const t=e.getContent();i.pushRules=d.a.rewriteDefaultRules(t)}const t=n[e.getId()];return i.emit(m.b.AccountData,e,t),e}))}if(Array.isArray(null===(n=t.to_device)||void 0===n?void 0:n.events)&&t.to_device.events.length>0){const e=[];t.to_device.events.map(i.getEventMapper()).map(t=>{if("m.key.verification.cancel"===t.getType()){const n=t.getContent().transaction_id;n&&e.push(n)}return t}).forEach((function(t){const n=t.getContent();if("m.room.message"!=t.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===t.getType()||"m.key.verification.request"===t.getType()){const i=n.transaction_id;e.includes(i)&&t.flagCancelled()}i.emit(m.b.ToDeviceEvent,t)}else u.a.log("Ignoring undecryptable to-device event from "+t.getSender())}))}else this.catchingUp=!1;let s=[],o=[],c=[];if(t.rooms&&(t.rooms.invite&&(s=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(o=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(c=this.mapSyncResponseToRoomArray(t.rooms.leave))),this.notifEvents=[],await a.z(s,async e=>{const t=e.room,n=this.mapSyncEventsFormat(e.invite_state,t);await this.processRoomEvents(t,n),e.isBrandNewRoom?(t.recalculate(),i.store.storeRoom(t),i.emit(m.b.Room,t)):t.recalculate(),n.forEach((function(e){i.emit(m.b.Event,e)}))}),await a.z(o,async t=>{const n=t.room,s=this.mapSyncEventsFormat(t.state,n),o=this.mapSyncEventsFormat(t.timeline,n,!1),c=this.mapSyncEventsFormat(t.ephemeral),d=this.mapSyncEventsFormat(t.account_data),u=i.isRoomEncrypted(n.roomId);if(t.unread_notifications&&(n.setUnreadNotificationCount(r.a.Total,t.unread_notifications.notification_count),(!u||u&&n.getUnreadNotificationCount(r.a.Highlight)<=0)&&n.setUnreadNotificationCount(r.a.Highlight,t.unread_notifications.highlight_count)),t.timeline=t.timeline||{},t.isBrandNewRoom)n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,l.b.BACKWARDS);else if(t.timeline.limited){let s=!0;for(let e=o.length-1;e>=0;e--){const t=o[e].getId();if(n.getTimelineForEvent(t)){E("Already have event "+t+" in limited sync - not resetting"),s=!1,o.splice(0,e);break}}s&&(this.deregisterStateListeners(n),n.resetLiveTimeline(t.timeline.prev_batch,this.opts.canResetEntireTimeline(n.roomId)?null:e.oldSyncToken),i.resetNotifTimelineSet(),this.registerStateListeners(n))}await this.processRoomEvents(n,s,o,e.fromCache),t.summary&&n.setSummary(t.summary),n.addEphemeralEvents(c),n.addAccountData(d),n.recalculate(),t.isBrandNewRoom&&(i.store.storeRoom(n),i.emit(m.b.Room,n)),this.processEventsForNotifs(n,o);const h=async e=>{i.emit(m.b.Event,e),e.isState()&&"m.room.encryption"==e.getType()&&this.opts.crypto&&await this.opts.crypto.onCryptoEvent(e)};await a.z(s,h),await a.z(o,h),c.forEach((function(e){i.emit(m.b.Event,e)})),d.forEach((function(e){i.emit(m.b.Event,e)})),n.decryptCriticalEvents()}),await a.z(c,async e=>{const t=e.room,n=this.mapSyncEventsFormat(e.state,t),s=this.mapSyncEventsFormat(e.timeline,t),o=this.mapSyncEventsFormat(e.account_data);await this.processRoomEvents(t,n,s),t.addAccountData(o),t.recalculate(),e.isBrandNewRoom&&(i.store.storeRoom(t),i.emit(m.b.Room,t)),this.processEventsForNotifs(t,s),n.forEach((function(e){i.emit(m.b.Event,e)})),s.forEach((function(e){i.emit(m.b.Event,e)})),o.forEach((function(e){i.emit(m.b.Event,e)}))}),e.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((function(e){i.getNotifTimelineSet().addLiveEvent(e)}))),t.device_lists&&this.opts.crypto&&await this.opts.crypto.handleDeviceListChanges(e,t.device_lists),this.opts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.opts.crypto.updateOneTimeKeyCount(e)}if(this.opts.crypto&&(t.device_unused_fallback_key_types||t["org.matrix.msc2732.device_unused_fallback_key_types"])){const e=t.device_unused_fallback_key_types||t["org.matrix.msc2732.device_unused_fallback_key_types"];this.opts.crypto.setNeedsNewFallback(e instanceof Array&&!e.includes("signed_curve25519"))}}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=a.l()),this.connectionReturnedDefer.promise}pokeKeepAlive(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(e),this.connectionReturnedDefer=null)};this.client.http.request(void 0,p.f.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then(()=>{t()},n=>{400==n.httpStatus||404==n.httpStatus?this.keepAliveTimer=setTimeout(t,2e3):(e=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,e),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(y.Error,{error:n}))})}mapSyncResponseToRoomArray(e){const t=this.client;return Object.keys(e).map(n=>{const i=e[n];let s=t.store.getRoom(n),o=!1;return s||(s=this.createRoom(n),o=!0),i.room=s,i.isBrandNewRoom=o,i})}mapSyncEventsFormat(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!e||!Array.isArray(e.events))return[];const i=this.client.getEventMapper({decrypt:n});return e.events.map((function(e){return t&&(e.room_id=t.roomId),i(e)}))}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(n){if(n._requestedProfileInfo)return;n._requestedProfileInfo=!0;const i=t.getUser(n.userId);let s;s=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(n.userId),s.then((function(t){const i=n.events.member;"invite"===i.getContent().membership&&(i.getContent().avatar_url=t.avatar_url,i.getContent().displayname=t.displayname,n.setMembershipEvent(i,e.currentState))}),(function(e){}))}))}async processRoomEvents(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const s=e.getLiveTimeline(),o=0==s.getEvents().length;if(o){for(const e of t)this.client.getPushActionsForEvent(e);s.initialiseState(t)}this.resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(n||[],null,i),this.client.processBeaconEvents(e,n)}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(let e=0;e<t.length;e++){const n=this.client.getPushActionsForEvent(t[e]);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this.notifEvents.push(t[e])}}getGuestFilter(){return"{}"}updateSyncState(e,t){const n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(m.b.Sync,this.syncState,n,t)}}function C(e,t){const n=new o.a(t);return e.reEmitter.reEmit(n,[o.b.AvatarUrl,o.b.DisplayName,o.b.Presence,o.b.CurrentlyActive,o.b.LastPresenceTs]),n}}).call(this,n(30))},function(e,t,n){"use strict";function i(e,t){const n=`Store is invalid because ${e}, please stop the client, delete all data and start the client again`,i=Reflect.construct(Error,[n]);return Reflect.setPrototypeOf(i,Reflect.getPrototypeOf(this)),i.reason=e,i.value=t,i}function s(e){const t=`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`,n=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.name="InvalidCryptoStoreError",n}n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return o})),i.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",i.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(i,Error),s.TOO_NEW="TOO_NEW",s.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(s,Error);class o extends Error{constructor(e,t){super(e),this.value=t}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));var i=n(3);const s=new i.b("m.beacon_info","org.matrix.msc3672.beacon_info"),o=new i.b("m.beacon","org.matrix.msc3672.beacon")},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(225),c=n(120),l=n(0),d=n(90),u=n(95),h=n(89),m=n(429),p=n(383),g=n(115),f=n(322);class v extends Error{}class b{constructor(e){s()(this,"accessToken",void 0),s()(this,"tempClient",void 0),s()(this,"authEnabled",!0),e&&(this.tempClient=Object(c.createClient)({baseUrl:"",idBaseUrl:e}))}get matrixClient(){return this.tempClient?this.tempClient:d.a.get()}writeToken(){this.tempClient||window.localStorage.setItem("mx_is_access_token",this.accessToken)}readToken(){return this.tempClient?null:window.localStorage.getItem("mx_is_access_token")}hasCredentials(){return Boolean(this.accessToken)}async getAccessToken(){let{check:e=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.authEnabled)return null;let t=this.accessToken;if(t||(t=this.readToken()),!t)return t=await this.registerForToken(e),t&&(this.accessToken=t,this.writeToken()),t;if(e)try{await this.checkToken(t)}catch(e){if(e instanceof m.b||e instanceof v)throw e;t=await this.registerForToken(),t&&(this.accessToken=t,this.writeToken())}return t}async checkToken(e){const t=this.matrixClient.getIdentityServerUrl();try{await this.matrixClient.getIdentityAccount(e)}catch(n){if("M_TERMS_NOT_SIGNED"===n.errcode)return l.a.log("Identity server requires new terms to be agreed to"),void await Object(m.d)([new m.a(a.a.IS,t,e)]);throw n}if(!this.tempClient&&!Object(p.a)()&&!await Object(p.b)(t)){const{finished:e}=u.a.createTrackedDialog("Default identity server terms warning","",g.a,{title:Object(h.a)("Identity server has no terms of service"),description:r.a.createElement("div",null,r.a.createElement("p",null,Object(h.a)("This action requires accessing the default identity server <server /> to validate an email address or phone number, but the server does not have any terms of service.",{},{server:()=>r.a.createElement("b",null,Object(f.a)(t))})),r.a.createElement("p",null,Object(h.a)("Only continue if you trust the owner of the server."))),button:Object(h.a)("Trust")}),[n]=await e;if(!n)throw new v("User aborted identity server action without terms");Object(p.d)()}}async registerForToken(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=await d.a.get().getOpenIdToken(),{access_token:n,token:i}=await this.matrixClient.registerWithIdentityServer(t),s=i||n;return e&&await this.checkToken(s),s}}},function(e,t,n){"use strict";function i(e){e.currentTarget.value=""}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";t.a={SHOW_ENCRYPTION_SETUP_UI:!0}},function(e,t,n){"use strict";function i(e,t){return Number.isFinite(e)?Number(e):t}function s(e,t,n){return Math.min(Math.max(e,t),n)}function o(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return[...t].reduce((e,t)=>t+e,0)}function r(e,t,n){return e*(n-t)+t}function a(e,t,n){return(e-t)/(n-t)}n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"e",(function(){return o})),n.d(t,"d",(function(){return r})),n.d(t,"c",(function(){return a}))},,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h})),n.d(t,"g",(function(){return m})),n.d(t,"d",(function(){return p})),n.d(t,"f",(function(){return g})),n.d(t,"i",(function(){return f})),n.d(t,"c",(function(){return b})),n.d(t,"h",(function(){return y})),n.d(t,"e",(function(){return S}));var i=n(87),s=n(111),o=n(152),r=n(116),a=n(118),c=n(209),l=n(181),d=n(142);const u="io.element.video",h="io.element.video.member",m=e=>c.a.instance.getApps(e).find(e=>l.a.JITSI.matches(e.type)&&e.id===u),p=async(e,t)=>{await d.a.addJitsiWidget(e,o.f.Video,"Video channel",u,t)},g=(e,t)=>{const n=new Set;for(const o of e.currentState.getStateEvents(h)){var i,s;const r=e.getMember(o.getStateKey());let a=null!==(i=null===(s=o.getContent())||void 0===s?void 0:s.devices)&&void 0!==i?i:[];t||(null==r?void 0:r.userId)!==e.client.getUserId()||(a=a.filter(t=>t!==e.client.getDeviceId())),a.length&&"join"===(null==r?void 0:r.membership)&&n.add(r)}return t&&n.add(e.getMember(e.client.getUserId())),n},f=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100;const[o,c]=Object(i.useState)(g(e,t));return Object(a.c)(e.currentState,r.b.Update,Object(s.throttle)(()=>{c(g(e,t))},n,{leading:!0,trailing:!0})),o},v=async(e,t)=>{var n,i;if("join"!==(null==e?void 0:e.getMyMembership()))return;const s=e.currentState.getStateEvents(h,e.client.getUserId()),o=t(null!==(n=null==s||null===(i=s.getContent())||void 0===i?void 0:i.devices)&&void 0!==n?n:[]);o&&await e.client.sendStateEvent(e.roomId,h,{devices:o},e.client.getUserId())},b=async e=>{await v(e,t=>Array.from(new Set(t).add(e.client.getDeviceId())))},y=async e=>{await v(e,t=>{const n=new Set(t);return n.delete(e.client.getDeviceId()),Array.from(n)})},S=async(e,t)=>{const n=(new Date).valueOf(),{devices:i}=await e.client.getDevices(),s=new Map(i.map(e=>[e.device_id,e]));await v(e,i=>{const o=i.filter(i=>{const o=s.get(i);return(null==o?void 0:o.last_seen_ts)&&!(i===e.client.getDeviceId()&&!t)&&n-o.last_seen_ts<36e5});return o.length===i.length?null:o})}},function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return u}));var i=n(88),s=n.n(i),o=n(2),r=n(167),a=n(92),c=n(400),l=n(142);let d;!function(e){e.StoreMessaging="store_messaging",e.StopMessaging="stop_messaging",e.WidgetReady="widget_ready"}(d||(d={}));class u extends r.a{constructor(){super(a.a),s()(this,"widgetMap",new c.a),s()(this,"readyWidgets",new Set)}static get instance(){return u.internalInstance}async onAction(e){}async onReady(){this.widgetMap.clear()}storeMessaging(e,t,n){this.stopMessaging(e,t);const i=l.a.calcWidgetUid(e.id,t);this.widgetMap.set(i,n),n.once("action:"+o.a.WidgetReady,e=>{this.readyWidgets.add(i),this.emit(d.WidgetReady,i),n.transport.reply(e.detail,{})}),this.emit(d.StoreMessaging,i,n)}stopMessaging(e,t){this.stopMessagingByUid(l.a.calcWidgetUid(e.id,t))}getMessaging(e,t){return this.widgetMap.get(l.a.calcWidgetUid(e.id,t))}stopMessagingByUid(e){var t;null===(t=this.widgetMap.remove(e))||void 0===t||t.stop(),this.readyWidgets.delete(e),this.emit(d.StopMessaging,e)}getMessagingForUid(e){return this.widgetMap.get(e)}isWidgetReady(e){return this.readyWidgets.has(e)}}s()(u,"internalInstance",new u)},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(111),r=n(7);function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class l{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{keys:[]};s()(this,"_options",void 0),s()(this,"_items",void 0),this._options=t,this.setObjects(e),void 0===this._options.shouldMatchWordsOnly&&(this._options.shouldMatchWordsOnly=!0)}setObjects(e){this._items=new Map;for(const t of e){const e=Object(o.at)(t,this._options.keys);if(this._options.funcs)for(const n of this._options.funcs){const i=n(t);Array.isArray(i)?e.push(...i):e.push(i)}for(const[n,i]of Object.entries(e)){if(!i)continue;const e=this.processQuery(i);this._items.has(e)||this._items.set(e,[]),this._items.get(e).push({keyWeight:Number(n),object:t})}}}match(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;if(e=this.processQuery(e),this._options.shouldMatchWordsOnly&&(e=e.replace(/[^\w]/g,"")),0===e.length)return[];const n=[];for(const[t,i]of this._items.entries()){let s=t;this._options.shouldMatchWordsOnly&&(s=s.replace(/[^\w]/g,""));const o=s.indexOf(e);-1!==o&&n.push(...i.map(e=>c({index:o},e)))}n.sort((e,t)=>{if(e.index<t.index)return-1;if(e.index===t.index){if(e.keyWeight<t.keyWeight)return-1;if(e.keyWeight===t.keyWeight)return 0}return 1});const i=Object(o.uniq)(n.map(e=>e.object)),s=-1===t?i.length:t;return i.slice(0,s)}processQuery(e){return!1!==this._options.fuzzy?Object(r.E)(e.toLowerCase()).toLowerCase():e.toLowerCase()}}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(91),d=n(89),u=n(114),h=n(109);class m extends r.a.Component{constructor(){super(...arguments),s()(this,"onMouseEnter",()=>{this.props.onMouseEnter(this.props.dropdownKey)}),s()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onClick(this.props.dropdownKey)})}render(){const e=c()({mx_Dropdown_option:!0,mx_Dropdown_option_highlight:this.props.highlighted});return r.a.createElement("div",{id:this.props.id,className:e,onClick:this.onClick,onMouseEnter:this.onMouseEnter,role:"option","aria-selected":this.props.highlighted,ref:this.props.inputRef},this.props.children)}}s()(m,"defaultProps",{disabled:!1});class p extends r.a.Component{constructor(e){super(e),s()(this,"buttonRef",Object(o.createRef)()),s()(this,"dropdownRootElement",null),s()(this,"ignoreEvent",null),s()(this,"childrenByKey",{}),s()(this,"onDocumentClick",e=>{e!==this.ignoreEvent&&this.setState({expanded:!1})}),s()(this,"onRootClick",e=>{this.ignoreEvent=e}),s()(this,"onAccessibleButtonClick",e=>{if(this.props.disabled)return;const t=Object(u.a)().getAccessibilityAction(e);this.state.expanded?t===h.h.Enter?(this.props.onOptionChange(this.state.highlightedOption),this.close()):e.key||(this.setState({expanded:!1}),e.preventDefault()):(this.setState({expanded:!0}),e.preventDefault())}),s()(this,"onMenuOptionClick",e=>{this.close(),this.props.onOptionChange(e)}),s()(this,"onKeyDown",e=>{let t=!0;switch(Object(u.a)().getAccessibilityAction(e)){case h.h.Enter:this.props.onOptionChange(this.state.highlightedOption);case h.h.Escape:this.close();break;case h.h.ArrowDown:this.state.expanded?this.setState({highlightedOption:this.nextOption(this.state.highlightedOption)}):this.setState({expanded:!0});break;case h.h.ArrowUp:this.state.expanded?this.setState({highlightedOption:this.prevOption(this.state.highlightedOption)}):this.setState({expanded:!0});break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())}),s()(this,"onInputChange",e=>{this.setState({searchQuery:e.currentTarget.value}),this.props.onSearchChange&&this.props.onSearchChange(e.currentTarget.value)}),s()(this,"collectRoot",e=>{this.dropdownRootElement&&this.dropdownRootElement.removeEventListener("click",this.onRootClick,!1),e&&e.addEventListener("click",this.onRootClick,!1),this.dropdownRootElement=e}),s()(this,"setHighlightedOption",e=>{this.setState({highlightedOption:e})}),this.reindexChildren(this.props.children);const t=r.a.Children.toArray(e.children)[0];this.state={expanded:!1,highlightedOption:t?t.key:null,searchQuery:""},document.addEventListener("click",this.onDocumentClick,!1)}componentWillUnmount(){document.removeEventListener("click",this.onDocumentClick,!1)}UNSAFE_componentWillReceiveProps(e){if(!e.children||0===e.children.length)return;this.reindexChildren(e.children);const t=e.children[0];this.setState({highlightedOption:t?t.key:null})}reindexChildren(e){this.childrenByKey={},r.a.Children.forEach(e,e=>{this.childrenByKey[e.key]=e})}close(){this.setState({expanded:!1}),this.buttonRef.current&&this.buttonRef.current.focus()}nextOption(e){const t=Object.keys(this.childrenByKey),n=t.indexOf(e);return t[(n+1)%t.length]}prevOption(e){const t=Object.keys(this.childrenByKey),n=t.indexOf(e);return t[n<=0?t.length-1:(n-1)%t.length]}scrollIntoView(e){e&&e.scrollIntoView({block:"nearest",behavior:"auto"})}getMenuOptions(){const e=r.a.Children.map(this.props.children,e=>{const t=this.state.highlightedOption===e.key;return r.a.createElement(m,{id:`${this.props.id}__${e.key}`,key:e.key,dropdownKey:e.key,highlighted:t,onMouseEnter:this.setHighlightedOption,onClick:this.onMenuOptionClick,inputRef:t?this.scrollIntoView:void 0},e)});return 0===e.length?[r.a.createElement("div",{key:"0",className:"mx_Dropdown_option",role:"option","aria-selected":!1},Object(d.a)("No results"))]:e}render(){let e;const t={};let n;if(this.props.menuWidth&&(t.width=this.props.menuWidth),this.state.expanded&&(this.props.searchEnabled&&(e=r.a.createElement("input",{id:this.props.id+"_input",type:"text",autoFocus:!0,className:"mx_Dropdown_option",onChange:this.onInputChange,value:this.state.searchQuery,role:"combobox","aria-autocomplete":"list","aria-activedescendant":`${this.props.id}__${this.state.highlightedOption}`,"aria-expanded":this.state.expanded,"aria-controls":this.props.id+"_listbox","aria-disabled":this.props.disabled,"aria-label":this.props.label,onKeyDown:this.onKeyDown})),n=r.a.createElement("div",{className:"mx_Dropdown_menu",style:t,role:"listbox",id:this.props.id+"_listbox"},this.getMenuOptions())),!e){const t=this.props.getShortOption?this.props.getShortOption(this.props.value):this.childrenByKey[this.props.value];e=r.a.createElement("div",{className:"mx_Dropdown_option",id:this.props.id+"_value"},t)}const i={mx_Dropdown:!0,mx_Dropdown_disabled:this.props.disabled};return this.props.className&&(i[this.props.className]=!0),r.a.createElement("div",{className:c()(i),ref:this.collectRoot},r.a.createElement(l.a,{className:"mx_Dropdown_input mx_no_textinput",onClick:this.onAccessibleButtonClick,"aria-haspopup":"listbox","aria-expanded":this.state.expanded,disabled:this.props.disabled,inputRef:this.buttonRef,"aria-label":this.props.label,"aria-describedby":this.props.id+"_value","aria-owns":this.props.id+"_input",onKeyDown:this.onKeyDown},e,r.a.createElement("span",{className:"mx_Dropdown_arrow"}),n))}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return u})),n.d(t,"d",(function(){return h})),n.d(t,"b",(function(){return m})),n.d(t,"a",(function(){return p}));var i=n(96),s=n(205),o=n(92),r=n(238),a=n(89),c=n(526),l=n(98),d=n(747);function u(){const e=Object(s.c)();if(e){return!(!1===e.default)}return!0}const h=(e,t,n)=>{let{roomAlias:s,autoJoin:c=!1,shouldPeek:l=!1,roomServer:d}=n;const u={action:i.a.ViewRoom,auto_join:c,should_peek:l,metricsTrigger:"RoomDirectory"};if(t){if(e.isGuest()&&!t.world_readable&&!t.guest_can_join)return void o.a.dispatch({action:"require_registration"});s||(s=Object(r.a)(t.canonical_alias,t.aliases)),u.oob_data={avatarUrl:t.avatar_url,name:t.name||s||Object(a.a)("Unnamed room")},d&&(u.via_servers=[d])}s?u.room_alias=s:u.room_id=t.room_id,o.a.dispatch(u)};function m(e,t,n){let{instanceId:i,roomServer:s,protocols:o,metricsTrigger:r}=n;if(i&&i!==c.a){const n=Object(c.c)(o,i),s=Object(c.b)(o,i),u=n?p(t,o[n],s):null;if(!u){const e=l.b.get().brand;throw new d.a(Object(a.a)("Unable to join network"),Object(a.a)("%(brand)s does not know how to join a room on this network",{brand:e}))}e.getThirdpartyLocation(n,u).then(t=>{if(!(t.length>0&&t[0].alias))throw new d.a(Object(a.a)("Room not found"),Object(a.a)("Couldn't find a matching Matrix room"));h(e,null,{roomAlias:t[0].alias,autoJoin:!0,metricsTrigger:r})},e=>{throw new d.a(Object(a.a)("Fetching third party location failed"),Object(a.a)("Unable to look up room ID from server"))})}else t.includes(":")||(t=t+":"+s),h(e,null,{roomAlias:t,autoJoin:!0,metricsTrigger:r})}function p(e,t,n){const i=t.location_fields;if(!i)return null;const s={};for(let e=0;e<i.length-1;++e){const t=i[e];if(void 0===n.fields[t])return null;s[t]=n.fields[t]}return s[i[i.length-1]]=e,s}},function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var i=n(87),s=n.n(i),o=n(7),r=n(89),a=n(91),c=n(93),l=n(104),d=n(95),u=n(527),h=n(98),m=n(191),p=n(177),g=n(170),f=n(117);const v=e=>{let{onClick:t,tooltipTitle:n=Object(r.a)("This is a beta feature"),tooltipCaption:i=Object(r.a)("Click for more info")}=e;return t?s.a.createElement(f.a,{className:"mx_BetaCard_betaPill",title:`${n} ${i}`,tooltip:s.a.createElement("div",null,s.a.createElement("div",{className:"mx_Tooltip_title"},n),s.a.createElement("div",{className:"mx_Tooltip_sub"},i)),onClick:t},Object(r.a)("Beta")):s.a.createElement("span",{className:"mx_BetaCard_betaPill"},Object(r.a)("Beta"))};t.b=e=>{let{title:t,featureId:n}=e;const f=c.b.getBetaInfo(n),b=Object(p.a)(n),[y,S]=Object(i.useState)(!1);if(!f)return null;const{title:E,caption:w,disclaimer:_,image:C,feedbackLabel:O,feedbackSubheading:R,extraSettings:I,requiresRefresh:k}=f;let x,T;return b&&O&&R&&h.b.get().bug_report_endpoint_url&&(x=s.a.createElement(a.a,{onClick:()=>{d.a.createTrackedDialog("Beta Feedback",n,u.a,{featureId:n})},kind:"primary"},Object(r.a)("Feedback"))),T=y?s.a.createElement(g.a,null):b?Object(r.a)("Leave the beta"):Object(r.a)("Join the beta"),s.a.createElement("div",{className:"mx_BetaCard"},s.a.createElement("div",{className:"mx_BetaCard_columns"},s.a.createElement("div",{className:"mx_BetaCard_columns_description"},s.a.createElement("h3",{className:"mx_BetaCard_title"},s.a.createElement("span",null,t||Object(r.a)(E)),s.a.createElement(v,null)),s.a.createElement("div",{className:"mx_BetaCard_caption"},w()),s.a.createElement("div",{className:"mx_BetaCard_buttons"},x,s.a.createElement(a.a,{onClick:async()=>{S(!0),k||await Object(o.G)(2e3),await c.b.setValue(n,null,l.a.DEVICE,!b),k||S(!1)},kind:x?"primary_outline":"primary",disabled:y},T)),_&&s.a.createElement("div",{className:"mx_BetaCard_disclaimer"},_(b))),s.a.createElement("div",{className:"mx_BetaCard_columns_image_wrapper"},s.a.createElement("img",{className:"mx_BetaCard_columns_image",src:C,alt:""}))),I&&b&&s.a.createElement("div",{className:"mx_BetaCard_relatedSettings"},I.map(e=>s.a.createElement(m.a,{key:e,name:e,level:l.a.DEVICE}))))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(87);const s=(e,t,n)=>{const[s,o]=Object(i.useState)(n);return Object(i.useEffect)(()=>{let t=!1;return e().then(e=>{t||o(e)}),()=>{t=!0}},t),s}},function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h})),n.d(t,"c",(function(){return m}));var i=n(88),s=n.n(i),o=n(8),r=n.n(o),a=n(0),c=n(93),l=n(104),d=n(90);let u,h;!function(e){e.AudioOutput="audiooutput",e.AudioInput="audioinput",e.VideoInput="videoinput"}(u||(u={})),function(e){e.AudioOutputChanged="audio_output_changed"}(h||(h={}));class m extends r.a{static get instance(){return m.internalInstance||(m.internalInstance=new m),m.internalInstance}static async hasAnyLabeledDevices(){return(await navigator.mediaDevices.enumerateDevices()).some(e=>Boolean(e.label))}static async getDevices(){try{const e=await navigator.mediaDevices.enumerateDevices(),t={[u.AudioOutput]:[],[u.AudioInput]:[],[u.VideoInput]:[]};return e.forEach(e=>t[e.kind].push(e)),t}catch(e){a.a.warn("Unable to refresh WebRTC Devices: ",e)}}static async loadDevices(){const e=c.b.getValue("webrtc_audioinput"),t=c.b.getValue("webrtc_videoinput");await d.a.get().getMediaHandler().setAudioInput(e),await d.a.get().getMediaHandler().setVideoInput(t)}setAudioOutput(e){c.b.setValue("webrtc_audiooutput",null,l.a.DEVICE,e),this.emit(h.AudioOutputChanged,e)}async setAudioInput(e){return c.b.setValue("webrtc_audioinput",null,l.a.DEVICE,e),d.a.get().getMediaHandler().setAudioInput(e)}async setVideoInput(e){return c.b.setValue("webrtc_videoinput",null,l.a.DEVICE,e),d.a.get().getMediaHandler().setVideoInput(e)}async setDevice(e,t){switch(t){case u.AudioOutput:this.setAudioOutput(e);break;case u.AudioInput:await this.setAudioInput(e);break;case u.VideoInput:await this.setVideoInput(e)}}static getAudioOutput(){return c.b.getValueAt(l.a.DEVICE,"webrtc_audiooutput")}static getAudioInput(){return c.b.getValueAt(l.a.DEVICE,"webrtc_audioinput")}static getVideoInput(){return c.b.getValueAt(l.a.DEVICE,"webrtc_videoinput")}static getDevice(e){switch(e){case u.AudioOutput:return this.getAudioOutput();case u.AudioInput:return this.getAudioInput();case u.VideoInput:return this.getVideoInput()}}}s()(m,"internalInstance",void 0)},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(94),r=n.n(o);const a=Object(i.forwardRef)((e,t)=>{let{className:n,title:i,timestamp:o,subtitle:a,children:c}=e;return s.a.createElement("div",{className:r()("mx_EventTileBubble",n),ref:t},s.a.createElement("div",{className:"mx_EventTileBubble_title"},i),a&&s.a.createElement("div",{className:"mx_EventTileBubble_subtitle"},a),c,o)});t.a=a},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(87),s=n.n(i),o=n(94),r=n.n(o),a=n(89),c=n(91),l=n(140);let d;!function(e){e.Verified="verified",e.Warning="warning",e.Unknown="unknown",e.Normal="normal",e.Unauthenticated="unauthenticated"}(d||(d={}));const u={[d.Warning]:Object(a.c)("This user has not verified all of their sessions."),[d.Normal]:Object(a.c)("You have not verified this user."),[d.Verified]:Object(a.c)("You have verified this user. This user has verified all of their sessions.")},h={[d.Warning]:Object(a.c)("Someone is using an unknown session"),[d.Normal]:Object(a.c)("This room is end-to-end encrypted"),[d.Verified]:Object(a.c)("Everyone in this room is verified")};t.b=e=>{let{isUser:t,status:n,className:o,size:m,onClick:p,hideTooltip:g,bordered:f}=e;const[v,b]=Object(i.useState)(!1),y=r()({mx_E2EIcon:!0,mx_E2EIcon_bordered:f,mx_E2EIcon_warning:n===d.Warning,mx_E2EIcon_normal:n===d.Normal,mx_E2EIcon_verified:n===d.Verified},o);let S,E;S=t?u[n]:h[n],m&&(E={width:m+"px",height:m+"px"});const w=()=>b(!0),_=()=>b(!1);let C;return v&&!g&&(C=s.a.createElement(l.b,{label:S?Object(a.a)(S):""})),p?s.a.createElement(c.a,{onClick:p,onMouseOver:w,onMouseLeave:_,className:y,style:E},C):s.a.createElement("div",{onMouseOver:w,onMouseLeave:_,className:y,style:E},C)}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return l})),n.d(t,"d",(function(){return d})),n.d(t,"g",(function(){return u})),n.d(t,"b",(function(){return h})),n.d(t,"f",(function(){return m})),n.d(t,"e",(function(){return f})),n.d(t,"h",(function(){return v}));var i=n(89),s=n(93),o=n(412),r=n(149);const a="light",c={light:"light-high-contrast"};function l(e){return c[e]}function d(e){for(const t in c)if(c[t]===e)return t}function u(e){return Object.values(c).includes(e)}function h(){const e={light:Object(i.a)("Light"),"light-high-contrast":Object(i.a)("Light high contrast"),dark:Object(i.a)("Dark")},t=s.b.getValue("custom_themes"),n={};for(const{name:e}of t)n["custom-"+e]=e;return Object.assign({},n,e)}function m(){const e=Object.entries(h()).map(e=>({id:e[0],name:e[1]})).filter(e=>!u(e.id)),t=e.filter(e=>!e.id.startsWith("custom-")),n=e.filter(e=>!t.includes(e)).sort((e,t)=>Object(r.a)(e.name,t.name));return[...t,...n]}const p=["font-display","font-family","font-stretch","font-style","font-weight","font-variant","font-feature-settings","font-variation-settings","src","unicode-range"];function g(e){const{style:t}=document.body;function n(e,n){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];t.setProperty("--"+e,n),i&&(t.setProperty(`--${e}-0pct`,n+"00"),t.setProperty(`--${e}-15pct`,n+"26"),t.setProperty(`--${e}-50pct`,n+"7F"))}if(e.colors)for(const[t,i]of Object.entries(e.colors))if(Array.isArray(i))for(let e=0;e<i.length;e+=1)n(`${t}_${e}`,i[e],!1);else n(t,i);if(e.fonts){const{fonts:n}=e;if(n.faces){const e=n.faces.map(e=>{const t=e.src&&e.src.map(e=>{let t;return e.format&&(t=`format("${e.format}")`),e.url?`url("${e.url}") ${t}`:e.local?`local("${e.local}") ${t}`:""}).join(", ");return`@font-face {${Object.keys(e).filter(e=>p.includes(e)).map(n=>{let i;return i="src"===n?t:"font-family"===n?`"${e[n]}"`:e[n],`${n}: ${i}`}).join(";")}}`}).join("\n"),t=document.createElement("style");t.setAttribute("title","custom-theme-font-faces"),t.setAttribute("type","text/css"),t.appendChild(document.createTextNode(e)),document.head.appendChild(t)}n.general&&t.setProperty("--font-family",n.general),n.monospace&&t.setProperty("--font-family-monospace",n.monospace)}}function f(e){const t=s.b.getValue("custom_themes");if(!t)throw new Error(`No custom themes set, can't set custom theme "${e}"`);const n=t.find(t=>t.name===e);if(!n){const n=t.map(e=>e.name).join(", ");throw new Error(`Can't find custom theme "${e}", only know ${n}`)}return n}async function v(t){if(!t){t=(new o.a).getEffectiveTheme()}!function(){const e=Object.values(document.body.style);for(const t of e)t.startsWith("--")&&document.body.style.removeProperty(t);const t=document.querySelector("head > style[title='custom-theme-font-faces']");t&&t.remove()}();let n=t;if(t.startsWith("custom-")){const e=f(t.slice(7));n=e.is_dark?"dark-custom":"light-custom",g(e)}const i=Object.create(null);if(Array.from(document.querySelectorAll("[data-mx-theme]")).forEach(e=>{i[e.attributes["data-mx-theme"].value.toLowerCase()]=e}),!(n in i))throw new Error("Unknown theme "+n);return i[n].disabled=!1,new Promise(t=>{const s=function(){i[n].disabled=!1,Object.values(i).forEach(e=>{e!=i[n]&&(e.disabled=!0)});const s=e.getComputedStyle(document.body);if(s.backgroundColor){document.querySelector('meta[name="theme-color"]').content=s.backgroundColor}t()};let o=!1;i[n].onload=()=>{s()};for(let e=0;e<document.styleSheets.length;e++){const t=document.styleSheets[e];if(t&&t.href===i[n].href){o=!0;break}}o&&(i[n].onload=void 0,s())})}}).call(this,n(30))},,function(e,t,n){"use strict";n.d(t,"a",(function(){return w})),n.d(t,"b",(function(){return _})),n.d(t,"c",(function(){return k})),n.d(t,"d",(function(){return T}));var i=n(88),s=n.n(i),o=n(94),r=n.n(o),a=n(374),c=n(0),l=n(87),d=n.n(l);var u=n(89),h=n(93),m=n(451),p=n(621);function g(e){const t=Object(l.useContext)(m.a),n=t?t.dispatch:null;return Object(l.useEffect)(()=>{if(n)return n({type:p.a.Add,value:e}),()=>n({type:p.a.Remove,value:e})},[e,n]),null}var f=n(91),v=n(117),b=n(105),y=n(102),S=n(140),E=n(952);const w=0;class _ extends d.a.Component{constructor(e){super(e),s()(this,"onSubmit",e=>{e.preventDefault(),this.props.busy||this.props.submitAuthDict({type:a.a.Password,user:this.props.matrixClient.credentials.userId,identifier:{type:"m.id.user",user:this.props.matrixClient.credentials.userId},password:this.state.password})}),s()(this,"onPasswordFieldChange",e=>{this.setState({password:e.target.value})}),this.state={password:""}}componentDidMount(){this.props.onPhaseChange(w)}render(){const e=r()({error:this.props.errorText});let t,n;return t=this.props.busy?d.a.createElement(y.a,null):d.a.createElement("input",{type:"submit",className:"mx_Dialog_primary",disabled:!this.state.password,value:Object(u.a)("Continue")}),this.props.errorText&&(n=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),d.a.createElement("div",null,d.a.createElement("p",null,Object(u.a)("Confirm your identity by entering your account password below.")),d.a.createElement("form",{onSubmit:this.onSubmit,className:"mx_InteractiveAuthEntryComponents_passwordSection"},d.a.createElement(b.a,{className:e,type:"password",name:"passwordField",label:Object(u.a)("Password"),autoFocus:!0,value:this.state.password,onChange:this.onPasswordFieldChange}),n,d.a.createElement("div",{className:"mx_button_row"},t)))}}s()(_,"LOGIN_TYPE",a.a.Password);class C extends d.a.Component{constructor(){super(...arguments),s()(this,"onCaptchaResponse",e=>{this.props.submitAuthDict({type:a.a.Recaptcha,response:e})})}componentDidMount(){this.props.onPhaseChange(w)}render(){if(this.props.busy)return d.a.createElement(y.a,null);let e,t,n=this.props.errorText;return this.props.stageParams&&this.props.stageParams.public_key?e=this.props.stageParams.public_key:n=Object(u.a)("Missing captcha public key in homeserver configuration. Please report this to your homeserver administrator."),n&&(t=d.a.createElement("div",{className:"error",role:"alert"},n)),d.a.createElement("div",null,d.a.createElement(E.a,{sitePublicKey:e,onCaptchaResponse:this.onCaptchaResponse}),t)}}s()(C,"LOGIN_TYPE",a.a.Recaptcha);class O extends d.a.Component{constructor(e){super(e),s()(this,"trySubmit",()=>{let e=!0;for(const t of this.state.policies){const n=this.state.toggledPolicies[t.id];e=e&&n}e?this.props.submitAuthDict({type:a.a.Terms}):this.setState({errorText:Object(u.a)("Please review and accept all of the homeserver's policies")})});const t=this.props.stageParams.policies||{},n=h.b.getValue("language"),i={},o=[];for(const e of Object.keys(t)){const s=t[e];let r=s[n];if(r||(r=s.en),!r){r=s[Object.keys(s).find(e=>"version"!==e)]}if(!r)throw new Error("Failed to find a policy to show the user");i[e]=!1,o.push({id:e,name:r.name,url:r.url})}this.state={toggledPolicies:i,policies:o}}componentDidMount(){this.props.onPhaseChange(w)}togglePolicy(e){const t={};for(const n of this.state.policies){let i=this.state.toggledPolicies[n.id];n.id===e&&(i=!i),t[n.id]=i}this.setState({toggledPolicies:t})}render(){if(this.props.busy)return d.a.createElement(y.a,null);const e=[];let t,n,i=!0;for(const t of this.state.policies){const n=this.state.toggledPolicies[t.id];i=i&&n,e.push(d.a.createElement("label",{key:"policy_checkbox_"+t.id,className:"mx_InteractiveAuthEntryComponents_termsPolicy"},d.a.createElement("input",{type:"checkbox",onChange:()=>this.togglePolicy(t.id),checked:n}),d.a.createElement("a",{href:t.url,target:"_blank",rel:"noreferrer noopener"},t.name)))}return(this.props.errorText||this.state.errorText)&&(t=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText||this.state.errorText)),!1!==this.props.showContinue&&(n=d.a.createElement("button",{className:"mx_InteractiveAuthEntryComponents_termsSubmit mx_GeneralButton",onClick:this.trySubmit,disabled:!i},Object(u.a)("Accept"))),d.a.createElement("div",null,d.a.createElement("p",null,Object(u.a)("Please review and accept the policies of this homeserver:")),e,t,n)}}s()(O,"LOGIN_TYPE",a.a.Terms);class R extends d.a.Component{constructor(e){super(e),this.state={requested:!1,requesting:!1}}componentDidMount(){this.props.onPhaseChange(w)}render(){var e;let t;return this.props.errorText&&"M_UNAUTHORIZED"!==this.props.errorCode&&(t=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),void 0===this.props.inputs.emailAddress||null!==(e=this.props.stageState)&&void 0!==e&&e.emailSid?t||d.a.createElement(y.a,null):d.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_emailWrapper"},d.a.createElement(g,{title:Object(u.a)("Check your email to continue"),icon:d.a.createElement("img",{src:"img/element-icons/email-prompt.b304531.svg",alt:Object(u.a)("Unread email icon"),width:16}),hideServerPicker:!0}),d.a.createElement("p",null,Object(u.a)("To create your account, open the link in the email we just sent to %(emailAddress)s.",{emailAddress:d.a.createElement("b",null,this.props.inputs.emailAddress)})),this.state.requesting?d.a.createElement("p",{className:"secondary"},Object(u.a)("Did not receive it? <a>Resend it</a>",{},{a:e=>d.a.createElement(l.Fragment,null,d.a.createElement(f.a,{kind:"link_inline",onClick:()=>null,disabled:!0},e," ",d.a.createElement(y.a,{w:14,h:14})))})):d.a.createElement("p",{className:"secondary"},Object(u.a)("Did not receive it? <a>Resend it</a>",{},{a:e=>d.a.createElement(v.a,{kind:"link_inline",title:this.state.requested?Object(u.a)("Resent!"):Object(u.a)("Resend"),alignment:S.a.Right,tooltipClassName:"mx_Tooltip_noMargin",onHideTooltip:this.state.requested?()=>this.setState({requested:!1}):void 0,onClick:async()=>{this.setState({requesting:!0});try{var e,t;await(null===(e=(t=this.props).requestEmailToken)||void 0===e?void 0:e.call(t))}catch(e){c.a.warn("Email token request failed: ",e)}finally{this.setState({requested:!0,requesting:!1})}}},e)})),t)}}s()(R,"LOGIN_TYPE",a.a.Email);class I extends d.a.Component{constructor(e){super(e),s()(this,"submitUrl",void 0),s()(this,"sid",void 0),s()(this,"msisdn",void 0),s()(this,"onTokenChange",e=>{this.setState({token:e.target.value})}),s()(this,"onFormSubmit",async e=>{if(e.preventDefault(),""!=this.state.token){this.setState({errorText:null});try{let e;if(!this.submitUrl)throw new Error("The registration with MSISDN flow is misconfigured");if(e=await this.props.matrixClient.submitMsisdnTokenOtherUrl(this.submitUrl,this.sid,this.props.clientSecret,this.state.token),e.success){const e={sid:this.sid,client_secret:this.props.clientSecret};this.props.submitAuthDict({type:a.a.Msisdn,threepid_creds:e,threepidCreds:e})}else this.setState({errorText:Object(u.a)("Token incorrect")})}catch(e){this.props.fail(e),c.a.log("Failed to submit msisdn token")}}}),this.state={token:"",requestingToken:!1,errorText:""}}componentDidMount(){this.props.onPhaseChange(w),this.setState({requestingToken:!0}),this.requestMsisdnToken().catch(e=>{this.props.fail(e)}).finally(()=>{this.setState({requestingToken:!1})})}requestMsisdnToken(){return this.props.matrixClient.requestRegisterMsisdnToken(this.props.inputs.phoneCountry,this.props.inputs.phoneNumber,this.props.clientSecret,1).then(e=>{this.submitUrl=e.submit_url,this.sid=e.sid,this.msisdn=e.msisdn})}render(){if(this.state.requestingToken)return d.a.createElement(y.a,null);{const e=Boolean(this.state.token),t=r()({mx_InteractiveAuthEntryComponents_msisdnSubmit:!0,mx_GeneralButton:!0});let n;return this.state.errorText&&(n=d.a.createElement("div",{className:"error",role:"alert"},this.state.errorText)),d.a.createElement("div",null,d.a.createElement("p",null,Object(u.a)("A text message has been sent to %(msisdn)s",{msisdn:d.a.createElement("i",null,this.msisdn)})),d.a.createElement("p",null,Object(u.a)("Please enter the code it contains:")),d.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_msisdnWrapper"},d.a.createElement("form",{onSubmit:this.onFormSubmit},d.a.createElement("input",{type:"text",className:"mx_InteractiveAuthEntryComponents_msisdnEntry",value:this.state.token,onChange:this.onTokenChange,"aria-label":Object(u.a)("Code")}),d.a.createElement("br",null),d.a.createElement("input",{type:"submit",value:Object(u.a)("Submit"),className:t,disabled:!e})),n))}}}s()(I,"LOGIN_TYPE",a.a.Msisdn);class k extends d.a.Component{constructor(e){super(e),s()(this,"ssoUrl",void 0),s()(this,"popupWindow",void 0),s()(this,"attemptFailed",()=>{this.setState({attemptFailed:!0})}),s()(this,"onReceiveMessage",e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.popupWindow&&(this.popupWindow.close(),this.popupWindow=null)}),s()(this,"onStartAuthClick",()=>{this.popupWindow=window.open(this.ssoUrl,"_blank"),this.setState({phase:k.PHASE_POSTAUTH}),this.props.onPhaseChange(k.PHASE_POSTAUTH)}),s()(this,"onConfirmClick",()=>{this.props.submitAuthDict({})}),this.ssoUrl=e.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId),this.popupWindow=null,window.addEventListener("message",this.onReceiveMessage),this.state={phase:k.PHASE_PREAUTH,attemptFailed:!1}}componentDidMount(){this.props.onPhaseChange(k.PHASE_PREAUTH)}componentWillUnmount(){window.removeEventListener("message",this.onReceiveMessage),this.popupWindow&&(this.popupWindow.close(),this.popupWindow=null)}render(){let e=null;const t=d.a.createElement(f.a,{onClick:this.props.onCancel,kind:this.props.continueKind?this.props.continueKind+"_outline":"primary_outline"},Object(u.a)("Cancel"));let n;return e=this.state.phase===k.PHASE_PREAUTH?d.a.createElement(f.a,{onClick:this.onStartAuthClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(u.a)("Single Sign On")):d.a.createElement(f.a,{onClick:this.onConfirmClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(u.a)("Confirm")),this.props.errorText?n=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText):this.state.attemptFailed&&(n=d.a.createElement("div",{className:"error",role:"alert"},Object(u.a)("Something went wrong in confirming your identity. Cancel and try again."))),d.a.createElement(l.Fragment,null,n,d.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_sso_buttons"},t,e))}}s()(k,"LOGIN_TYPE",a.a.Sso),s()(k,"UNSTABLE_LOGIN_TYPE",a.a.SsoUnstable),s()(k,"PHASE_PREAUTH",1),s()(k,"PHASE_POSTAUTH",2);class x extends d.a.Component{constructor(e){super(e),s()(this,"popupWindow",void 0),s()(this,"fallbackButton",Object(l.createRef)()),s()(this,"focus",()=>{this.fallbackButton.current&&this.fallbackButton.current.focus()}),s()(this,"onShowFallbackClick",e=>{e.preventDefault(),e.stopPropagation();const t=this.props.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId);this.popupWindow=window.open(t,"_blank")}),s()(this,"onReceiveMessage",e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.props.submitAuthDict({})}),this.popupWindow=null,window.addEventListener("message",this.onReceiveMessage)}componentDidMount(){this.props.onPhaseChange(w)}componentWillUnmount(){window.removeEventListener("message",this.onReceiveMessage),this.popupWindow&&this.popupWindow.close()}render(){let e;return this.props.errorText&&(e=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),d.a.createElement("div",null,d.a.createElement(f.a,{kind:"link_inline",inputRef:this.fallbackButton,onClick:this.onShowFallbackClick},Object(u.a)("Start authentication")),e)}}function T(e){switch(e){case a.a.Password:return _;case a.a.Recaptcha:return C;case a.a.Email:return R;case a.a.Msisdn:return I;case a.a.Terms:return O;case a.a.Sso:case a.a.SsoUnstable:return k;default:return x}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(17),s=n.n(i),o=n(137);class r{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,n;const i=(null===(t=e.getUnsigned())||void 0===t?void 0:t["m.relations"])||{},s=Object.keys(i),r=[];return this.userId&&null!=i&&null!==(n=i[o.c.name])&&void 0!==n&&n.current_user_participated&&r.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,s,r)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[o.b.name]:this.filterJson[o.b.name]||[],[o.a.name]:this.filterJson[o.a.name]||[]}}checkFields(e,t,n,i,s,r){const a={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const n=t.slice(0,-1);return e.slice(0,n.length)===n}return e===t}(n,e)}};for(let e=0;e<Object.keys(a).length;e++){const t=Object.keys(a)[e],n=a[t],i="not_"+t,s=this.filterJson[i];if(null!=s&&s.some(n))return!1;const o=this.filterJson[t];if(o&&!o.some(n))return!1}const c=this.filterJson.contains_url;if(void 0!==c&&c!==i)return!1;const l=this.filterJson[o.a.name];if(void 0!==l&&!this.arrayMatchesFilter(l,s))return!1;const d=this.filterJson[o.b.name];return!(void 0!==d&&!this.arrayMatchesFilter(d,r))}arrayMatchesFilter(e,t){return t.length>0&&e.every(e=>t.includes(e))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}function a(e,t,n){const i=t.split(".");let s=e;for(let e=0;e<i.length-1;e++)s[i[e]]||(s[i[e]]={}),s=s[i[e]];s[i[i.length-1]]=n}class c{static fromJson(e,t,n){const i=new c(e,t);return i.setDefinition(n),i}constructor(e,t){this.userId=e,this.filterId=t,s()(this,"definition",{}),s()(this,"roomFilter",void 0),s()(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;const t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms)),this.roomFilter=new r(n,this.userId),this.roomTimelineFilter=new r((null==t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomTimelineFilter.filter(this.roomFilter.filter(e))}setTimelineLimit(e){a(this.definition,"room.timeline.limit",e)}setLazyLoadMembers(e){a(this.definition,"room.state.lazy_load_members",!!e)}setIncludeLeaveRooms(e){a(this.definition,"room.include_leave",e)}}s()(c,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(113),d=n(200),u=n(97),h=n(125),m=n(3),p=n(130),g=n(210),f=n(172),v=n(90),b=n(98);var y=n(89),S=n(211),E=n(135);const w=new m.b("busy","org.matrix.msc3026.busy");var _;function C(e){switch(e){case _.Globe:return Object(y.a)("This room is public");case _.PresenceOnline:return Object(y.a)("Online");case _.PresenceAway:return Object(y.a)("Away");case _.PresenceOffline:return Object(y.a)("Offline");case _.PresenceBusy:return Object(y.a)("Busy")}}!function(e){e.None="NONE",e.Globe="GLOBE",e.PresenceOnline="ONLINE",e.PresenceAway="AWAY",e.PresenceOffline="OFFLINE",e.PresenceBusy="BUSY"}(_||(_={}));class O extends r.a.PureComponent{constructor(e){super(e),s()(this,"_dmUser",void 0),s()(this,"isUnmounted",!1),s()(this,"isWatchingTimeline",!1),s()(this,"onRoomTimeline",(e,t)=>{if(!this.isUnmounted&&this.props.room.roomId===(null==t?void 0:t.roomId)&&(e.getType()===u.b.RoomJoinRules||e.getType()===u.b.RoomMember)){const e=this.calculateIcon();e!==this.state.icon&&this.setState({icon:e})}}),s()(this,"onPresenceUpdate",()=>{if(this.isUnmounted)return;const e=this.getPresenceIcon();e!==this.state.icon&&this.setState({icon:e})}),this.state={notificationState:f.a.instance.getRoomState(this.props.room),icon:this.calculateIcon()}}componentWillUnmount(){this.isUnmounted=!0,this.isWatchingTimeline&&this.props.room.off(l.c.Timeline,this.onRoomTimeline),this.dmUser=null}get isPublicRoom(){const e=this.props.room.currentState.getStateEvents(u.b.RoomJoinRules,"");return(e&&e.getContent().join_rule)===h.c.Public}get dmUser(){return this._dmUser}set dmUser(e){const t=this._dmUser;this._dmUser=e,t&&t!==this._dmUser&&(t.off(d.b.CurrentlyActive,this.onPresenceUpdate),t.off(d.b.Presence,this.onPresenceUpdate)),this._dmUser&&t!==this._dmUser&&(this._dmUser.on(d.b.CurrentlyActive,this.onPresenceUpdate),this._dmUser.on(d.b.Presence,this.onPresenceUpdate))}getPresenceIcon(){if(!this.dmUser)return _.None;let e=_.None;const t=this.dmUser.currentlyActive||"online"===this.dmUser.presence;return w.matches(this.dmUser.presence)?e=_.PresenceBusy:t?e=_.PresenceOnline:"offline"===this.dmUser.presence?e=_.PresenceOffline:"unavailable"===this.dmUser.presence&&(e=_.PresenceAway),e}calculateIcon(){let e=_.None;const t=E.a.shared().getUserIdForRoomId(this.props.room.roomId);return t&&2===this.props.room.getJoinedMemberCount()?function(){const e=v.a.get().baseUrl,t=b.b.get("enable_presence_by_hs_url");return!t||!(!t[e]&&void 0!==t[e])}()&&t&&(this.dmUser=v.a.get().getUser(t),e=this.getPresenceIcon()):(e=this.isPublicRoom?_.Globe:_.None,this.isWatchingTimeline||(this.props.room.on(l.c.Timeline,this.onRoomTimeline),this.isWatchingTimeline=!0)),e}render(){let e,t;this.props.displayBadge&&(e=r.a.createElement(g.a,{notification:this.state.notificationState,forceCount:this.props.forceCount,roomId:this.props.room.roomId})),this.state.icon!==_.None&&(t=r.a.createElement(S.a,{tooltip:C(this.state.icon),tooltipProps:this.props.tooltipProps,class:"mx_DecoratedRoomAvatar_icon mx_DecoratedRoomAvatar_icon_"+this.state.icon.toLowerCase()}));const n=c()("mx_DecoratedRoomAvatar",{mx_DecoratedRoomAvatar_cutout:t});return r.a.createElement("div",{className:n},r.a.createElement(p.a,{room:this.props.room,width:this.props.avatarSize,height:this.props.avatarSize,oobData:this.props.oobData,viewAvatarOnClick:this.props.viewAvatarOnClick}),t,e)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return K})),n.d(t,"a",(function(){return V}));var i=n(88),s=n.n(i),o=n(97),r=n(643),a=n.n(r),c=n(1369),l=n.n(c),d=n(0),u=n(137),h=n(92),m=n(89),p=n(95),g=n(102),f=n(96),v=n(93),b=n(777),y=n(106),S=n(129),E=n(219),w=n(107),_=n(335),C=n.n(_),O=n(87),R=n.n(O),I=n(101),k=n(110);class x extends R.a.Component{constructor(){super(...arguments),s()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),s()(this,"onUploadClick",()=>{this.props.onFinished(!0)})}render(){let e,t;if(1===this.props.totalFiles&&1===this.props.badFiles.length)e=Object(m.a)("This file is <b>too large</b> to upload. The file size limit is %(limit)s but this file is %(sizeOfThisFile)s.",{limit:C()(this.props.contentMessages.getUploadLimit()),sizeOfThisFile:C()(this.props.badFiles[0].size)},{b:e=>R.a.createElement("b",null,e)}),t=R.a.createElement(k.a,{primaryButton:Object(m.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.onCancelClick,focus:!0});else if(this.props.totalFiles===this.props.badFiles.length)e=Object(m.a)("These files are <b>too large</b> to upload. The file size limit is %(limit)s.",{limit:C()(this.props.contentMessages.getUploadLimit())},{b:e=>R.a.createElement("b",null,e)}),t=R.a.createElement(k.a,{primaryButton:Object(m.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.onCancelClick,focus:!0});else{e=Object(m.a)("Some files are <b>too large</b> to be uploaded. The file size limit is %(limit)s.",{limit:C()(this.props.contentMessages.getUploadLimit())},{b:e=>R.a.createElement("b",null,e)});const n=this.props.totalFiles-this.props.badFiles.length;t=R.a.createElement(k.a,{primaryButton:Object(m.a)("Upload %(count)s other files",{count:n}),onPrimaryButtonClick:this.onUploadClick,hasCancel:!0,cancelButton:Object(m.a)("Cancel All"),onCancel:this.onCancelClick,focus:!0})}return R.a.createElement(I.a,{className:"mx_UploadFailureDialog",onFinished:this.onCancelClick,title:Object(m.a)("Upload Error"),contentId:"mx_Dialog_content"},R.a.createElement("div",{id:"mx_Dialog_content"},e,void 0),t)}}var T=n(751),j=n(432),N=n(778);function P(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function D(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?P(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const A=[0,0,22,37,0,0,22,37,1];class M extends Error{}const U=["image/avif","image/webp"];async function L(e,t,n){let i="image/png";"image/jpeg"===n.type&&(i="image/jpeg");const s=await async function(e){const t=document.createElement("img"),n=URL.createObjectURL(e),i=new Promise((e,i)=>{t.onload=function(){URL.revokeObjectURL(n),e(t)},t.onerror=function(e){i(e)}});let s;if(t.src=n,"image/png"===e.type){s=B(e).then(e=>{const t=new Uint8Array(e),n=l()(t);for(const e of n)if("pHYs"===e.name){if(e.data.byteLength!==A.length)return;return e.data.every((e,t)=>e===A[t])}return!1})}const[o]=await Promise.all([s,i]);return{width:o?t.width>>1:t.width,height:o?t.height>>1:t.height,img:t}}(n),o=await Object(j.b)(s.img,s.width,s.height,i),r=o.info;if(!U.includes(n.type)){const e=n.size-r.thumbnail_info.size;if(n.size<=32768||e<=65536&&e<=.1*n.size)return delete r.thumbnail_info,r}const a=await K(e,t,o.thumbnail);return r.thumbnail_url=a.url,r.thumbnail_file=a.file,r}function F(e,t,n){let i;return function(e){return new Promise((t,n)=>{const i=document.createElement("video");i.preload="metadata",i.playsInline=!0,i.muted=!0;const s=new FileReader;s.onload=function(e){i.onloadeddata=async function(){t(i),i.pause()},i.onerror=function(e){n(e)};let s=e.target.result;s.startsWith("data:video/quicktime;")&&(s=s.replace("data:video/quicktime;","data:video/mp4;")),i.src=s,i.load(),i.play()},s.onerror=function(e){n(e)},s.readAsDataURL(e)})}(n).then(e=>Object(j.b)(e,e.videoWidth,e.videoHeight,"image/jpeg")).then(n=>(i=n.info,K(e,t,n.thumbnail))).then(e=>(i.thumbnail_url=e.url,i.thumbnail_file=e.file,i))}function B(e){return new Promise((t,n)=>{const i=new FileReader;i.onload=function(e){t(e.target.result)},i.onerror=function(e){n(e)},i.readAsArrayBuffer(e)})}function K(e,t,n,i){let s=!1;if(e.isRoomEncrypted(t)){let t;const o=B(n).then((function(e){if(s)throw new M;return a.a.encryptAttachment(e)})).then((function(n){if(s)throw new M;const o=new Blob([n.data]);return t=e.uploadContent(o,{progressHandler:i,includeFilename:!1}),t.then(e=>{if(s)throw new M;return{file:D(D({},n.info),{},{url:e})}})}));return o.abort=()=>{s=!0,t&&e.cancelUpload(t)},o}{const t=e.uploadContent(n,{progressHandler:i}),o=t.then((function(e){if(s)throw new M;return{url:e}}));return o.abort=()=>{s=!0,e.cancelUpload(t)},o}}class V{constructor(){s()(this,"inprogress",[]),s()(this,"mediaConfig",null)}sendStickerContentToRoom(e,t,n,i,s,o){return o.sendStickerMessage(t,n,e,i,s).catch(n=>{throw d.a.warn(`Failed to send content with URL ${e} to room ${t}`,n),n})}getUploadLimit(){return null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]?this.mediaConfig["m.upload.size"]:null}async sendContentListToRoom(e,t,n,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:y.a.Room;if(i.isGuest())return void h.a.dispatch({action:"require_registration"});const o=S.a.instance.getQuotingEvent();if(!this.mediaConfig){const e=p.a.createDialog(g.a,null,"mx_Dialog_spinner");await this.ensureMediaConfigFetched(i),e.close()}const r=[],a=[];for(const t of e)this.isFileSizeAcceptable(t)?a.push(t):r.push(t);if(r.length>0){const{finished:t}=p.a.createTrackedDialog("Upload Failure","",x,{badFiles:r,totalFiles:e.length,contentMessages:this}),[n]=await t;if(!n)return}let c=!1,l=Promise.resolve();for(let e=0;e<a.length;++e){const s=a[e];if(!c){const{finished:t}=p.a.createTrackedDialog("Upload Files confirmation","",T.a,{file:s,currentIndex:e,totalFiles:a.length}),[n,i]=await t;if(!n)break;i&&(c=!0)}l=this.sendContentToRoom(s,t,n,i,o,l)}o&&h.a.dispatch({action:"reply_to_event",event:null,context:s}),h.a.dispatch({action:f.a.FocusSendMessageComposer,context:s})}getCurrentUploads(e){return this.inprogress.filter(t=>{const n=!e&&!t.relation,i=e&&t.relation&&e.rel_type===t.relation.rel_type&&e.event_id===t.relation.event_id;return(n||i)&&!t.canceled})}cancelUpload(e,t){const n=this.inprogress.find(t=>t.promise===e);n&&(n.canceled=!0,t.cancelUpload(n.promise),h.a.dispatch({action:f.a.UploadCanceled,upload:n}))}sendContentToRoom(e,t,n,i,s,r){const a={body:e.name||"Attachment",info:{size:e.size},msgtype:o.c.File};Object(N.a)(a,n),s&&Object(E.a)(a,s,{includeLegacyFallback:!1}),v.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(b.a)(a),e.type&&(a.info.mimetype=e.type);const c=new Promise(n=>{0===e.type.indexOf("image/")?(a.msgtype=o.c.Image,L(i,t,e).then(e=>{Object.assign(a.info,e),n()},e=>{d.a.error(e),a.msgtype=o.c.File,n()})):0===e.type.indexOf("audio/")?(a.msgtype=o.c.Audio,n()):0===e.type.indexOf("video/")?(a.msgtype=o.c.Video,F(i,t,e).then(e=>{Object.assign(a.info,e),n()},e=>{d.a.error(e),a.msgtype=o.c.File,n()})):(a.msgtype=o.c.File,n())});c.abort=()=>{l.canceled=!0};const l={fileName:e.name||"Attachment",roomId:t,relation:n,total:e.size,loaded:0,promise:c};function g(e){l.total=e.total,l.loaded=e.loaded,h.a.dispatch({action:f.a.UploadProgress,upload:l})}let y;return this.inprogress.push(l),h.a.dispatch({action:f.a.UploadStarted,upload:l}),c.then(()=>{if(l.canceled)throw new M;return l.promise=K(i,t,e,g),l.promise.then((function(e){a.file=e.file,a.url=e.url}))}).then(()=>r).then((function(){if(l.canceled)throw new M;const e=(null==n?void 0:n.rel_type)===u.c.name?n.event_id:null,s=i.sendMessage(t,e,a);return v.b.getValue("Performance.addSendMessageTimingMetadata")&&s.then(e=>{Object(b.b)(i,t,e.event_id)}),s}),(function(e){if(y=e,!l.canceled){let t=Object(m.a)("The file '%(fileName)s' failed to upload.",{fileName:l.fileName});413===e.httpStatus&&(t=Object(m.a)("The file '%(fileName)s' exceeds this homeserver's size limit for uploads",{fileName:l.fileName})),p.a.createTrackedDialog("Upload failed","",w.a,{title:Object(m.a)("Upload Failed"),description:t})}})).finally(()=>{for(let e=0;e<this.inprogress.length;++e)if(this.inprogress[e].promise===l.promise){this.inprogress.splice(e,1);break}var e;y?(413===(null===(e=y)||void 0===e?void 0:e.httpStatus)&&(this.mediaConfig=null),h.a.dispatch({action:f.a.UploadFailed,upload:l,error:y})):(h.a.dispatch({action:f.a.UploadFinished,upload:l}),h.a.dispatch({action:"message_sent"}))})}isFileSizeAcceptable(e){return!(null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]&&e.size>this.mediaConfig["m.upload.size"])}ensureMediaConfigFetched(e){if(null===this.mediaConfig)return d.a.log("[Media Config] Fetching"),e.getMediaConfig().then(e=>(d.a.log("[Media Config] Fetched config:",e),e)).catch(()=>(d.a.log("[Media Config] Could not fetch config, so not limiting uploads."),{})).then(e=>{this.mediaConfig=e})}static sharedInstance(){return void 0===window.mxContentMessages&&(window.mxContentMessages=new V),window.mxContentMessages}}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i extends class{constructor(e){this.target=e}reEmit(e,t){var n=this;for(const i of t){const t=function(){if("error"!==i||0!==n.target.listenerCount("error")){for(var t=arguments.length,s=new Array(t),o=0;o<t;o++)s[o]=arguments[o];n.target.emit(i,...s,e)}};e.on(i,t)}}}{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(17),s=n.n(i),o=n(7),r=n(0),a=n(202),c=n(97);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const u=[a.e.Override,a.e.ContentSpecific,a.e.RoomSpecific,a.e.SenderSpecific,a.e.Underride],h=[{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:a.a.EventMatch,key:"type",pattern:"m.reaction"}],actions:[a.d.DontNotify]},{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:a.a.EventMatch,key:"type",pattern:c.b.RoomServerAcl}],actions:[]}];class m{constructor(e){this.client=e}static actionListToActionsObject(e){const t={notify:!1,tweaks:{}};for(let n=0;n<e.length;++n){const i=e[n];i===a.d.Notify?t.notify=!0:"object"==typeof i&&(void 0===i.value&&(i.value=!0),t.tweaks[i.set_tweak]=i.value)}return t}static rewriteDefaultRules(e){let t=JSON.parse(JSON.stringify(e));t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]);const n=t.global.override;for(const e of h){const t=n.find(t=>t.rule_id===e.rule_id);if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{const t=e.rule_id;r.a.warn("Adding default global override for "+t),n.push(e)}}return t}matchingRuleFromKindSet(e,t){for(let n=0;n<u.length;++n){const i=u[n],s=t[i];if(s)for(let t=0;t<s.length;++t){const n=s[t];if(!n.enabled)continue;const o=this.templateRuleToRaw(i,n);if(o&&this.ruleMatchesEvent(o,e))return d(d({},n),{},{kind:i})}}return null}templateRuleToRaw(e,t){const n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case a.e.Underride:case a.e.Override:n.conditions=t.conditions;break;case a.e.RoomSpecific:if(!t.rule_id)return null;n.conditions.push({kind:a.a.EventMatch,key:"room_id",value:t.rule_id});break;case a.e.SenderSpecific:if(!t.rule_id)return null;n.conditions.push({kind:a.a.EventMatch,key:"user_id",value:t.rule_id});break;case a.e.ContentSpecific:if(!t.pattern)return null;n.conditions.push({kind:a.a.EventMatch,key:"content.body",pattern:t.pattern})}return n}eventFulfillsCondition(e,t){switch(e.kind){case a.a.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case a.a.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case a.a.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case a.a.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){const n=e.key;if(!n)return!1;const i=this.client.getRoom(t.getRoomId());return!(null==i||!i.currentState)&&i.currentState.mayTriggerNotifOfType(n,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;const n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;const i=n.currentState.getJoinedMemberCount(),s=e.is.match(/^([=<>]*)(\d*)$/);if(!s)return!1;const o=s[1],r=parseInt(s[2]);if(isNaN(r))return!1;switch(o){case"":case"==":return i==r;case"<":return i<r;case">":return i>r;case"<=":return i<=r;case">=":return i>=r;default:return!1}}eventFulfillsDisplayNameCondition(e,t){let n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;const i=this.client.getRoom(t.getRoomId());if(!(i&&i.currentState&&i.currentState.members&&i.currentState.getMember(this.client.credentials.userId)))return!1;const s=i.currentState.getMember(this.client.credentials.userId).name,r=new RegExp("(^|\\W)"+Object(o.p)(s)+"(\\W|$)","i");return n.body.search(r)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;const n=this.valueForDottedKey(e.key,t);if("string"!=typeof n)return!1;if(e.value)return e.value===n;if("string"!=typeof e.pattern)return!1;let i;return i="content.body"==e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$"),!!n.match(i)}createCachedRegex(e,t,n){return m.cachedGlobToRegex[t]||(m.cachedGlobToRegex[t]=new RegExp(e+Object(o.r)(t)+n,"i")),m.cachedGlobToRegex[t]}valueForDottedKey(e,t){const n=e.split(".");let i;const s=n[0];for("content"===s?(i=t.getContent(),n.shift()):"type"===s?(i=t.getType(),n.shift()):i=t.event;n.length>0;){const e=n.shift();if(Object(o.t)(i[e]))return null;i=i[e]}return i}matchingRuleForEventWithRulesets(e,t){return t?e.getSender()===this.client.credentials.userId?null:this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){const n=this.matchingRuleForEventWithRulesets(e,t);if(!n)return{};const i=m.actionListToActionsObject(n.actions);return void 0===i.tweaks.highlight&&(i.tweaks.highlight=n.kind==a.e.ContentSpecific),i}ruleMatchesEvent(e,t){var n;if(null===(n=e.conditions)||void 0===n||!n.length)return!0;let i=!0;for(let n=0;n<e.conditions.length;++n){const s=e.conditions[n];i&=this.eventFulfillsCondition(s,t)}return i}actionsForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){for(const t of["global"])if(void 0!==this.client.pushRules[t])for(const n of u)if(void 0!==this.client.pushRules[t][n])for(const i of this.client.pushRules[t][n])if(i.rule_id===e)return i;return null}}s()(m,"cachedGlobToRegex",{})},function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var i=n(17),s=n.n(i),o=n(0);let r;!function(e){e.SUCCESS="SUCCESS",e.IGNORE="IGNORE",e.PROMPT="PROMPT",e.FAIL_PROMPT="FAIL_PROMPT",e.FAIL_ERROR="FAIL_ERROR"}(r||(r={}));class a{static async fromDiscoveryConfig(e){const t={"m.homeserver":{state:a.FAIL_ERROR,error:a.ERROR_INVALID,base_url:null},"m.identity_server":{state:a.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return o.a.error("No m.homeserver key in config"),t["m.homeserver"].state=a.FAIL_PROMPT,t["m.homeserver"].error=a.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"].base_url)return o.a.error("No m.homeserver base_url in config"),t["m.homeserver"].state=a.FAIL_PROMPT,t["m.homeserver"].error=a.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const n=this.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!n)return o.a.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=a.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const i=await this.fetchWellKnownObject(n+"/_matrix/client/versions");if(!i||!i.raw.versions)return o.a.error("Invalid /versions response"),t["m.homeserver"].error=a.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=n,Promise.resolve(t);t["m.homeserver"]={state:a.SUCCESS,error:null,base_url:n};let s="";if(e["m.identity_server"]){const n={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:a.FAIL_PROMPT,error:a.ERROR_INVALID_IS,base_url:null}};if(s=this.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!s)return o.a.error("Invalid base_url for m.identity_server"),n["m.identity_server"].error=a.ERROR_INVALID_IS_BASE_URL,Promise.resolve(n);const i=await this.fetchWellKnownObject(s+"/_matrix/identity/api/v1");if(!i||!i.raw||i.action!==r.SUCCESS)return o.a.error("Invalid /api/v1 response"),n["m.identity_server"].error=a.ERROR_INVALID_IDENTITY_SERVER,n["m.identity_server"].base_url=s,Promise.resolve(n)}return s&&s.toString().length>0&&(t["m.identity_server"]={state:a.SUCCESS,error:null,base_url:s}),Object.keys(e).forEach(n=>{if("m.homeserver"===n||"m.identity_server"===n){const i=["error","state","base_url"];for(const s of Object.keys(e[n]))i.includes(s)||(t[n][s]=e[n][s])}else t[n]=e[n]}),Promise.resolve(t)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:a.FAIL_ERROR,error:a.ERROR_INVALID,base_url:null},"m.identity_server":{state:a.PROMPT,error:null,base_url:null}},n=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return n&&n.action===r.SUCCESS?a.fromDiscoveryConfig(n.raw):(o.a.error("No response or error when parsing .well-known"),n.reason&&o.a.error(n.reason),n.action===r.IGNORE?t["m.homeserver"]={state:a.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=a.FAIL_PROMPT,t["m.homeserver"].error=a.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static sanitizeWellKnownUrl(e){if(!e)return!1;try{let t=null;try{t=new URL(e)}catch(e){o.a.error("Could not parse url",e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;const n=t.port?":"+t.port:"",i=t.pathname?t.pathname:"";let s=`${t.protocol}//${t.hostname}${n}${i}`;return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(e){return o.a.error(e),!1}}static fetchWellKnownObject(e){return new Promise((function(t){const i=n(120).getRequest();if(!i)throw new Error("No request library available");i({method:"GET",uri:e,timeout:5e3},(e,n,i)=>{if(e||n&&(n.statusCode<200||n.statusCode>=300)){let i=r.FAIL_PROMPT,s=(e?e.message:null)||"General failure";return n&&404===n.statusCode&&(i=r.IGNORE,s=a.ERROR_MISSING_WELLKNOWN),void t({raw:{},action:i,reason:s,error:e})}try{t({raw:JSON.parse(i),action:r.SUCCESS})}catch(e){let n=a.ERROR_INVALID;"SyntaxError"===e.name&&(n=a.ERROR_INVALID_JSON),t({raw:{},action:r.FAIL_PROMPT,reason:n,error:e})}})}))}}s()(a,"ERROR_INVALID","Invalid homeserver discovery response"),s()(a,"ERROR_GENERIC_FAILURE","Failed to get autodiscovery configuration from server"),s()(a,"ERROR_INVALID_HS_BASE_URL","Invalid base_url for m.homeserver"),s()(a,"ERROR_INVALID_HOMESERVER","Homeserver URL does not appear to be a valid Matrix homeserver"),s()(a,"ERROR_INVALID_IS_BASE_URL","Invalid base_url for m.identity_server"),s()(a,"ERROR_INVALID_IDENTITY_SERVER","Identity server URL does not appear to be a valid identity server"),s()(a,"ERROR_INVALID_IS","Invalid identity server discovery response"),s()(a,"ERROR_MISSING_WELLKNOWN","No .well-known JSON file found"),s()(a,"ERROR_INVALID_JSON","Invalid JSON"),s()(a,"ALL_ERRORS",[a.ERROR_INVALID,a.ERROR_GENERIC_FAILURE,a.ERROR_INVALID_HS_BASE_URL,a.ERROR_INVALID_HOMESERVER,a.ERROR_INVALID_IS_BASE_URL,a.ERROR_INVALID_IDENTITY_SERVER,a.ERROR_INVALID_IS,a.ERROR_MISSING_WELLKNOWN,a.ERROR_INVALID_JSON]),s()(a,"FAIL_ERROR",r.FAIL_ERROR),s()(a,"FAIL_PROMPT",r.FAIL_PROMPT),s()(a,"PROMPT",r.PROMPT),s()(a,"SUCCESS",r.SUCCESS)},function(e,t,n){"use strict";(function(e){n.d(t,"c",(function(){return l})),n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return u}));var i=n(7),s=n(161);const o="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,r=new Uint8Array(8);function a(t,n){const s=Object(i.q)(),o=s.createHmac("sha256",r).update(t).digest(),a=e.alloc(1,1),c=s.createHmac("sha256",o).update(n,"utf8").update(a).digest();a[0]=2;return[c,s.createHmac("sha256",o).update(c).update(n,"utf8").update(a).digest()]}async function c(e,t){const n=await o.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),i=await o.deriveBits({name:"HKDF",salt:r,info:(new TextEncoder).encode(t),hash:"SHA-256"},n,512),s=i.slice(0,32),a=i.slice(32),c=o.importKey("raw",s,{name:"AES-CTR"},!1,["encrypt","decrypt"]),l=o.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([c,l])}function l(t,n,r,l){return o?async function(e,t,n,i){let r;i?r=Object(s.decodeBase64)(i):(r=new Uint8Array(16),window.crypto.getRandomValues(r),r[8]&=127);const[a,l]=await c(t,n),d=(new TextEncoder).encode(e),u=await o.encrypt({name:"AES-CTR",counter:r,length:64},a,d),h=await o.sign({name:"HMAC"},l,u);return{iv:Object(s.encodeBase64)(r),ciphertext:Object(s.encodeBase64)(u),mac:Object(s.encodeBase64)(h)}}(t,n,r,l):async function(t,n,o,r){const c=Object(i.q)();if(!c)throw new Error("No usable crypto implementation");let l;r?l=Object(s.decodeBase64)(r):(l=c.randomBytes(16),l[8]&=127);const[d,u]=a(n,o),h=c.createCipheriv("aes-256-ctr",d,l),m=e.concat([h.update(t,"utf8"),h.final()]),p=c.createHmac("sha256",u).update(m).digest("base64");return{iv:Object(s.encodeBase64)(l),ciphertext:m.toString("base64"),mac:p}}(t,n,r,l)}function d(t,n,r){return o?async function(e,t,n){const[i,r]=await c(t,n),a=Object(s.decodeBase64)(e.ciphertext);if(!await o.verify({name:"HMAC"},r,Object(s.decodeBase64)(e.mac),a))throw new Error(`Error decrypting secret ${n}: bad MAC`);const l=await o.decrypt({name:"AES-CTR",counter:Object(s.decodeBase64)(e.iv),length:64},i,a);return(new TextDecoder).decode(new Uint8Array(l))}(t,n,r):async function(t,n,o){const r=Object(i.q)();if(!r)throw new Error("No usable crypto implementation");const[c,l]=a(n,o);if(r.createHmac("sha256",l).update(e.from(t.ciphertext,"base64")).digest("base64").replace(/=+$/g,"")!==t.mac.replace(/=+$/g,""))throw new Error(`Error decrypting secret ${o}: bad MAC`);const d=r.createDecipheriv("aes-256-ctr",c,Object(s.decodeBase64)(t.iv));return d.update(t.ciphertext,"base64","utf8")+d.final("utf8")}(t,n,r)}function u(e,t){return l("\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",e,"",t)}}).call(this,n(31).Buffer)},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.Read="m.read",e.FullyRead="m.fully_read",e.ReadPrivate="org.matrix.msc2285.read.private"}(i||(i={}))},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"Notifier",(function(){return x}));var i=n(108),s=n(113),o=n(119),r=n(0),a=n(97),c=n(18),l=n(90),d=n(98),u=n(126),h=n(287),m=n(162),p=n(221),g=n(92),f=n(89),v=n(95),b=n(93),y=n(548),S=n(104),E=n(622),w=n(129),_=n(549),C=n(128),O=n(107),R=n(156),I=n(406);const k={[a.c.KeyVerificationRequest]:e=>{const t=(e.sender||{}).name;return Object(f.a)("%(name)s is requesting verification",{name:t})},[c.c.name]:e=>h.c(e)(),[c.c.altName]:e=>h.c(e)()},x={notifsByRoom:{},pendingEncryptedEventIds:[],notificationMessageForEvent:function(e){return k.hasOwnProperty(e.getContent().msgtype)?k[e.getContent().msgtype](e):h.b(e)},_displayPopupNotification:function(e,t){const n=u.a.get();if(!n)return;if(!n.supportsNotifications()||!n.maySendNotifications())return;let i,s=this.notificationMessageForEvent(e);if(!s)return;e.sender&&t.name!==e.sender.name?"m.room.member"===e.getType()?i=t.name:e.sender&&(i=e.sender.name+" ("+t.name+")",e.getContent().body&&!k.hasOwnProperty(e.getContent().msgtype)&&(s=e.getContent().body)):(i=t.name,e.getContent().body&&!k.hasOwnProperty(e.getContent().msgtype)&&(s=e.getContent().body)),this.isBodyEnabled()||(s="");let o=null;e.sender&&!b.b.getValue("lowBandwidth")&&(o=p.a(e.sender,40,40,"crop"));const r=n.displayNotification(i,s,o,t,e);r&&(void 0===this.notifsByRoom[e.getRoomId()]&&(this.notifsByRoom[e.getRoomId()]=[]),this.notifsByRoom[e.getRoomId()].push(r))},getSoundForRoom:function(e){const t=b.b.getValue("notificationSound",e);return t?t.url?t.url.startsWith("mxc://")?{url:Object(C.b)(t.url).srcHttp,name:t.name,type:t.type,size:t.size}:(r.a.warn(e+" has custom notification sound event, but url is not a mxc url"),null):(r.a.warn(e+" has custom notification sound event, but no url key"),null):null},_playAudioNotification:async function(e,t){const n=this.getSoundForRoom(t.roomId);r.a.log(`Got sound ${n&&n.name||"default"} for ${t.roomId}`);try{const e=document.querySelector(n?`audio[src='${n.url}']`:"#messageAudio");let t=e;if(!e){if(!n)return void r.a.error("No audio element or sound to play for notification");t=new Audio(n.url),n.type&&(t.type=n.type),document.body.appendChild(t)}await t.play()}catch(e){r.a.warn("Caught error when trying to fetch room notification sound:",e)}},start:function(){this.boundOnEvent=this.boundOnEvent||this.onEvent.bind(this),this.boundOnSyncStateChange=this.boundOnSyncStateChange||this.onSyncStateChange.bind(this),this.boundOnRoomReceipt=this.boundOnRoomReceipt||this.onRoomReceipt.bind(this),this.boundOnEventDecrypted=this.boundOnEventDecrypted||this.onEventDecrypted.bind(this),l.a.get().on(o.b.Event,this.boundOnEvent),l.a.get().on(s.c.Receipt,this.boundOnRoomReceipt),l.a.get().on(i.c.Decrypted,this.boundOnEventDecrypted),l.a.get().on(o.b.Sync,this.boundOnSyncStateChange),this.toolbarHidden=!1,this.isSyncing=!1},stop:function(){l.a.get()&&(l.a.get().removeListener(o.b.Event,this.boundOnEvent),l.a.get().removeListener(s.c.Receipt,this.boundOnRoomReceipt),l.a.get().removeListener(i.c.Decrypted,this.boundOnEventDecrypted),l.a.get().removeListener(o.b.Sync,this.boundOnSyncStateChange)),this.isSyncing=!1},supportsDesktopNotifications:function(){const e=u.a.get();return e&&e.supportsNotifications()},setEnabled:function(e,t){const n=u.a.get();n&&(m.a.trackEvent("Notifier","Set Enabled",String(e)),b.b.isLevelSupported(S.a.DEVICE)&&b.b.setValue("audioNotificationsEnabled",null,S.a.DEVICE,this.isEnabled()),e?n.requestNotificationPermission().then(e=>{if("granted"===e)t&&t(),g.a.dispatch({action:"notifier_enabled",value:!0});else{const t=d.b.get().brand,n="denied"===e?Object(f.a)("%(brand)s does not have permission to send you notifications - please check your browser settings",{brand:t}):Object(f.a)("%(brand)s was not given permission to send notifications - please try again",{brand:t});v.a.createTrackedDialog("Unable to enable Notifications",e,O.a,{title:Object(f.a)("Unable to enable Notifications"),description:n})}}):g.a.dispatch({action:"notifier_enabled",value:!1}),this.setPromptHidden(!0))},isEnabled:function(){return this.isPossible()&&b.b.getValue("notificationsEnabled")},isPossible:function(){const e=u.a.get();return!!e&&(!!e.supportsNotifications()&&!!e.maySendNotifications())},isBodyEnabled:function(){return this.isEnabled()&&b.b.getValue("notificationBodyEnabled")},isAudioEnabled:function(){return b.b.getValue("audioNotificationsEnabled")},setPromptHidden:function(t){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.toolbarHidden=t,m.a.trackEvent("Notifier","Set Toolbar Hidden",String(t)),Object(y.a)(),n&&e.localStorage&&e.localStorage.setItem("notifications_hidden",String(t))},shouldShowPrompt:function(){const e=l.a.get();if(!e)return!1;return!e.isGuest()&&this.supportsDesktopNotifications()&&!Object(E.c)()&&!this.isEnabled()&&!this._isPromptHidden()},_isPromptHidden:function(){return e.localStorage?"true"===e.localStorage.getItem("notifications_hidden"):this.toolbarHidden},onSyncStateChange:function(e){"SYNCING"===e?this.isSyncing=!0:"STOPPED"!==e&&"ERROR"!==e||(this.isSyncing=!1)},onEvent:function(e){if(this.isSyncing&&e.getSender()!==l.a.get().credentials.userId)if(l.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure())for(this.pendingEncryptedEventIds.push(e.getId());this.pendingEncryptedEventIds.length>20;)this.pendingEncryptedEventIds.shift();else this._evaluateEvent(e)},onEventDecrypted:function(e){if(e.isDecryptionFailure())return;const t=this.pendingEncryptedEventIds.indexOf(e.getId());-1!==t&&(this.pendingEncryptedEventIds.splice(t,1),this._evaluateEvent(e))},onRoomReceipt:function(e,t){if(0===t.getUnreadNotificationCount()){const e=u.a.get();if(!e)return;if(void 0===this.notifsByRoom[t.roomId])return;for(const n of this.notifsByRoom[t.roomId])e.clearNotification(n);delete this.notifsByRoom[t.roomId]}},_evaluateEvent:function(e){let t=e.getRoomId();if(R.b.instance.getSupportsVirtualRooms()){const e=I.a.sharedInstance().nativeRoomForVirtualRoom(t);e&&(t=e)}const n=l.a.get().getRoom(t),i=l.a.get().getPushActionsForEvent(e);if(null!=i&&i.notify){if(w.a.instance.getRoomId()===n.roomId&&_.a.sharedInstance().userActiveRecently()&&!v.a.hasDialogs())return;this.isEnabled()&&this._displayPopupNotification(e,n),i.tweaks.sound&&this.isAudioEnabled()&&(u.a.get().loudNotification(e,n),this._playAudioNotification(e,n))}}};window.mxNotifier||(window.mxNotifier=x),t.default=window.mxNotifier}.call(this,n(30))},function(e,t,n){"use strict";n.d(t,"c",(function(){return N})),n.d(t,"a",(function(){return L})),n.d(t,"b",(function(){return F}));var i=n(87),s=n.n(i),o=n(0),r=n(7),a=n(125),c=n(97),l=n(165),d=n(89),u=n(456),h=n(193),m=n(93),p=n(426),g=n(184),f=n(146),v=n(96),b=n(92),y=n(90),S=n(356),E=n(91),w=n(139),_=n(207),C=n(153);function O(e){var t,n,i;return null!==(t=null!==(n=null===(i=e.sender)||void 0===i?void 0:i.name)&&void 0!==n?n:e.getSender())&&void 0!==t?t:Object(d.a)("Someone")}function R(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.getSender();const i=y.a.get(),s=e.getRoomId(),o=null===(t=i.getRoom(s))||void 0===t?void 0:t.getMember(n);return(null==o?void 0:o.rawDisplayName)||n||Object(d.a)("Someone")}const I=()=>{b.a.dispatch({action:"open_room_settings",initial_tab_id:S.b})};function k(e){return Object(C.k)(e)?N(e):()=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let n=e.getContent().body;if(e.isRedacted()&&(n=P(e)),m.b.isEnabled("feature_extensible_events")){const n=e.unstableExtensibleEvent;if(n){if(n.isEquivalentTo(l.M_EMOTE))return`* ${t} ${n.text}`;if(n.isEquivalentTo(l.M_NOTICE)||n.isEquivalentTo(l.M_MESSAGE))return`${t}: ${n.text}`}}return n=e.getContent().msgtype===c.c.Emote?"* "+t+" "+n:e.getContent().msgtype===c.c.Image?Object(d.a)("%(senderDisplayName)s sent an image.",{senderDisplayName:t}):e.getType()==c.b.Sticker?Object(d.a)("%(senderDisplayName)s sent a sticker.",{senderDisplayName:t}):t+": "+n,n}}const x=(e,t)=>{b.a.dispatch({action:v.a.ViewRoom,event_id:e,highlighted:!0,room_id:t,metricsTrigger:void 0})},T=()=>{w.a.instance.setCard({phase:f.a.PinnedMessages},!1)};function j(e){const t=O(e),{entity:n}=e.getPrevContent(),{entity:i,recommendation:s,reason:o}=e.getContent();return i?s&&o?i===n?p.g.includes(e.getType())?()=>Object(d.a)("%(senderName)s updated the rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):p.c.includes(e.getType())?()=>Object(d.a)("%(senderName)s updated the rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):p.f.includes(e.getType())?()=>Object(d.a)("%(senderName)s updated the rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):()=>Object(d.a)("%(senderName)s updated a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):n?p.g.includes(e.getType())?()=>Object(d.a)("%(senderName)s changed a rule that was banning users matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:n,newGlob:i,reason:o}):p.c.includes(e.getType())?()=>Object(d.a)("%(senderName)s changed a rule that was banning rooms matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:n,newGlob:i,reason:o}):p.f.includes(e.getType())?()=>Object(d.a)("%(senderName)s changed a rule that was banning servers matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:n,newGlob:i,reason:o}):()=>Object(d.a)("%(senderName)s updated a ban rule that was matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:n,newGlob:i,reason:o}):p.g.includes(e.getType())?()=>Object(d.a)("%(senderName)s created a rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):p.c.includes(e.getType())?()=>Object(d.a)("%(senderName)s created a rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):p.f.includes(e.getType())?()=>Object(d.a)("%(senderName)s created a rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):()=>Object(d.a)("%(senderName)s created a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):()=>Object(d.a)("%(senderName)s updated an invalid ban rule",{senderName:t}):p.g.includes(e.getType())?()=>Object(d.a)("%(senderName)s removed the rule banning users matching %(glob)s",{senderName:t,glob:n}):p.c.includes(e.getType())?()=>Object(d.a)("%(senderName)s removed the rule banning rooms matching %(glob)s",{senderName:t,glob:n}):p.f.includes(e.getType())?()=>Object(d.a)("%(senderName)s removed the rule banning servers matching %(glob)s",{senderName:t,glob:n}):()=>Object(d.a)("%(senderName)s removed a ban rule matching %(glob)s",{senderName:t,glob:n})}function N(e){return()=>Object(d.a)("%(senderName)s has shared their location",{senderName:O(e)})}function P(e){var t;let n=Object(d.a)("Message deleted");const i=e.getUnsigned(),s=null==i||null===(t=i.redacted_because)||void 0===t?void 0:t.sender;if(s&&s!==e.getSender()){const t=y.a.get().getRoom(e.getRoomId()),i=null==t?void 0:t.getMember(s);n=Object(d.a)("Message deleted by %(name)s",{name:(null==i?void 0:i.name)||s})}return n}function D(e){return()=>{let t="";if(e.isRedacted()){var n,i;t=P(e);t=(null!==(n=null===(i=e.sender)||void 0===i?void 0:i.name)&&void 0!==n?n:e.getSender())+": "+t}else{var s,o;t=Object(d.a)("%(senderName)s has started a poll - %(pollQuestion)s",{senderName:O(e),pollQuestion:null===(s=e.unstableExtensibleEvent)||void 0===s||null===(o=s.question)||void 0===o?void 0:o.text})}return t}}function A(e){return()=>Object(d.a)("%(senderName)s has ended a poll",{senderName:O(e)})}const M={[c.b.RoomMessage]:k,[c.b.Sticker]:k,[c.b.CallInvite]:function(e){var t,n;const i=O(e),s=!(null!==(t=e.getContent().offer)&&void 0!==t&&null!==(n=t.sdp)&&void 0!==n&&n.includes("m=video")),o=y.a.get().supportsVoip();return s&&o?()=>Object(d.a)("%(senderName)s placed a voice call.",{senderName:i}):s&&!o?()=>Object(d.a)("%(senderName)s placed a voice call. (not supported by this browser)",{senderName:i}):!s&&o?()=>Object(d.a)("%(senderName)s placed a video call.",{senderName:i}):s||o?void 0:()=>Object(d.a)("%(senderName)s placed a video call. (not supported by this browser)",{senderName:i})},[l.M_POLL_START.name]:D,[l.M_POLL_END.name]:A,[l.M_POLL_START.altName]:D,[l.M_POLL_END.altName]:A},U={[c.b.RoomCanonicalAlias]:function(e){const t=O(e),n=e.getPrevContent().alias,i=e.getPrevContent().alt_aliases||[],s=e.getContent().alias,o=e.getContent().alt_aliases||[],r=i.filter(e=>!o.includes(e)),a=o.filter(e=>!i.includes(e));if(r.length||a.length){if(s!==n)return()=>Object(d.a)("%(senderName)s changed the main and alternative addresses for this room.",{senderName:t});if(a.length&&!r.length)return()=>Object(d.a)("%(senderName)s added the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:a.join(", "),count:a.length});if(r.length&&!a.length)return()=>Object(d.a)("%(senderName)s removed the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:r.join(", "),count:r.length});if(r.length&&a.length)return()=>Object(d.a)("%(senderName)s changed the alternative addresses for this room.",{senderName:t})}else{if(s)return()=>Object(d.a)("%(senderName)s set the main address for this room to %(address)s.",{senderName:t,address:e.getContent().alias});if(n)return()=>Object(d.a)("%(senderName)s removed the main address for this room.",{senderName:t})}return()=>Object(d.a)("%(senderName)s changed the addresses for this room.",{senderName:t})},[c.b.RoomName]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return e.getContent().name&&0!==e.getContent().name.trim().length?e.getPrevContent().name?()=>Object(d.a)("%(senderDisplayName)s changed the room name from %(oldRoomName)s to %(newRoomName)s.",{senderDisplayName:t,oldRoomName:e.getPrevContent().name,newRoomName:e.getContent().name}):()=>Object(d.a)("%(senderDisplayName)s changed the room name to %(roomName)s.",{senderDisplayName:t,roomName:e.getContent().name}):()=>Object(d.a)("%(senderDisplayName)s removed the room name.",{senderDisplayName:t})},[c.b.RoomTopic]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return()=>Object(d.a)('%(senderDisplayName)s changed the topic to "%(topic)s".',{senderDisplayName:t,topic:e.getContent().topic})},[c.b.RoomMember]:function(e,t,n){var i,s;const a=(null===(i=e.sender)||void 0===i?void 0:i.name)||R(e),c=(null===(s=e.target)||void 0===s?void 0:s.name)||R(e,e.getStateKey()),l=e.getPrevContent(),u=e.getContent(),h=u.reason;switch(u.membership){case"invite":{const e=u.third_party_invite;return e?e.display_name?()=>Object(d.a)("%(targetName)s accepted the invitation for %(displayName)s",{targetName:c,displayName:e.display_name}):()=>Object(d.a)("%(targetName)s accepted an invitation",{targetName:c}):()=>Object(d.a)("%(senderName)s invited %(targetName)s",{senderName:a,targetName:c})}case"ban":return()=>h?Object(d.a)("%(senderName)s banned %(targetName)s: %(reason)s",{senderName:a,targetName:c,reason:h}):Object(d.a)("%(senderName)s banned %(targetName)s",{senderName:a,targetName:c});case"join":return l&&"join"===l.membership?l.displayname&&u.displayname&&l.displayname!==u.displayname?()=>Object(d.a)("%(oldDisplayName)s changed their display name to %(displayName)s",{oldDisplayName:Object(r.C)(l.displayname),displayName:Object(r.C)(u.displayname)}):!l.displayname&&u.displayname?()=>Object(d.a)("%(senderName)s set their display name to %(displayName)s",{senderName:e.getSender(),displayName:Object(r.C)(u.displayname)}):l.displayname&&!u.displayname?()=>Object(d.a)("%(senderName)s removed their display name (%(oldDisplayName)s)",{senderName:a,oldDisplayName:Object(r.C)(l.displayname)}):l.avatar_url&&!u.avatar_url?()=>Object(d.a)("%(senderName)s removed their profile picture",{senderName:a}):l.avatar_url&&u.avatar_url&&l.avatar_url!==u.avatar_url?()=>Object(d.a)("%(senderName)s changed their profile picture",{senderName:a}):!l.avatar_url&&u.avatar_url?()=>Object(d.a)("%(senderName)s set a profile picture",{senderName:a}):(null!=n?n:m.b.getValue("showHiddenEventsInTimeline"))?()=>Object(d.a)("%(senderName)s made no change",{senderName:a}):null:(e.target||o.a.warn("Join message has no target! -- "+e.getContent().state_key),()=>Object(d.a)("%(targetName)s joined the room",{targetName:c}));case"leave":return e.getSender()===e.getStateKey()?"invite"===l.membership?()=>Object(d.a)("%(targetName)s rejected the invitation",{targetName:c}):()=>h?Object(d.a)("%(targetName)s left the room: %(reason)s",{targetName:c,reason:h}):Object(d.a)("%(targetName)s left the room",{targetName:c}):"ban"===l.membership?()=>Object(d.a)("%(senderName)s unbanned %(targetName)s",{senderName:a,targetName:c}):"invite"===l.membership?()=>h?Object(d.a)("%(senderName)s withdrew %(targetName)s's invitation: %(reason)s",{senderName:a,targetName:c,reason:h}):Object(d.a)("%(senderName)s withdrew %(targetName)s's invitation",{senderName:a,targetName:c}):"join"===l.membership?()=>h?Object(d.a)("%(senderName)s removed %(targetName)s: %(reason)s",{senderName:a,targetName:c,reason:h}):Object(d.a)("%(senderName)s removed %(targetName)s",{senderName:a,targetName:c}):null}},[c.b.RoomAvatar]:function(e){var t;const n=(null==e||null===(t=e.sender)||void 0===t?void 0:t.name)||e.getSender();return()=>Object(d.a)("%(senderDisplayName)s changed the room avatar.",{senderDisplayName:n})},[c.b.RoomThirdPartyInvite]:function(e){const t=O(e);return Object(h.c)(e)?()=>Object(d.a)("%(senderName)s sent an invitation to %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getContent().display_name}):()=>Object(d.a)("%(senderName)s revoked the invitation for %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getPrevContent().display_name||Object(d.a)("Someone")})},[c.b.RoomHistoryVisibility]:function(e){const t=O(e);switch(e.getContent().history_visibility){case a.b.Invited:return()=>Object(d.a)("%(senderName)s made future room history visible to all room members, from the point they are invited.",{senderName:t});case a.b.Joined:return()=>Object(d.a)("%(senderName)s made future room history visible to all room members, from the point they joined.",{senderName:t});case a.b.Shared:return()=>Object(d.a)("%(senderName)s made future room history visible to all room members.",{senderName:t});case a.b.WorldReadable:return()=>Object(d.a)("%(senderName)s made future room history visible to anyone.",{senderName:t});default:return()=>Object(d.a)("%(senderName)s made future room history visible to unknown (%(visibility)s).",{senderName:t,visibility:e.getContent().history_visibility})}},[c.b.RoomPowerLevels]:function(e){const t=O(e);if(!(e.getPrevContent()&&e.getPrevContent().users&&e.getContent()&&e.getContent().users))return null;const n=e.getPrevContent().users_default||0,i=e.getContent().users_default||0,s=[];Object.keys(e.getContent().users).forEach(e=>{-1===s.indexOf(e)&&s.push(e)}),Object.keys(e.getPrevContent().users).forEach(e=>{-1===s.indexOf(e)&&s.push(e)});const o=[];return s.forEach(t=>{let s=e.getPrevContent().users[t];Number.isInteger(s)||(s=n);let r=e.getContent().users[t];if(Number.isInteger(r)||(r=i),(s!==n||r!==i)&&r!==s){const n=_.a.getDisplayUserIdentifier(t,{roomId:e.getRoomId()});o.push({userId:t,name:n,from:s,to:r})}}),o.length?()=>Object(d.a)("%(senderName)s changed the power level of %(powerLevelDiffText)s.",{senderName:t,powerLevelDiffText:o.map(e=>Object(d.a)("%(userId)s from %(fromPowerLevel)s to %(toPowerLevel)s",{userId:e.name,fromPowerLevel:u.b(e.from,n),toPowerLevel:u.b(e.to,i)})).join(", ")}):null},[c.b.RoomPinnedEvents]:function(e,t){var n,i;if(!m.b.getValue("feature_pinning"))return null;const o=O(e),r=e.getRoomId(),a=null!==(n=e.getContent().pinned)&&void 0!==n?n:[],c=null!==(i=e.getPrevContent().pinned)&&void 0!==i?i:[],l=a.filter(e=>c.indexOf(e)<0),u=c.filter(e=>a.indexOf(e)<0);if(1===l.length&&0===u.length){if(t){const e=l.pop();return()=>s.a.createElement("span",null,Object(d.a)("%(senderName)s pinned <a>a message</a> to this room. See all <b>pinned messages</b>.",{senderName:o},{a:t=>s.a.createElement(E.a,{kind:"link_inline",onClick:t=>x(e,r)},t),b:e=>s.a.createElement(E.a,{kind:"link_inline",onClick:T},e)}))}return()=>Object(d.a)("%(senderName)s pinned a message to this room. See all pinned messages.",{senderName:o})}if(1===u.length&&0===l.length){if(t){const e=u.pop();return()=>s.a.createElement("span",null,Object(d.a)("%(senderName)s unpinned <a>a message</a> from this room. See all <b>pinned messages</b>.",{senderName:o},{a:t=>s.a.createElement(E.a,{kind:"link_inline",onClick:t=>x(e,r)},t),b:e=>s.a.createElement(E.a,{kind:"link_inline",onClick:T},e)}))}return()=>Object(d.a)("%(senderName)s unpinned a message from this room. See all pinned messages.",{senderName:o})}return t?()=>s.a.createElement("span",null,Object(d.a)("%(senderName)s changed the <a>pinned messages</a> for the room.",{senderName:o},{a:e=>s.a.createElement(E.a,{kind:"link_inline",onClick:T},e)})):()=>Object(d.a)("%(senderName)s changed the pinned messages for the room.",{senderName:o})},[c.b.RoomServerAcl]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),n=e.getPrevContent(),i=e.getContent(),s=Array.isArray(n.deny)?n.deny:[],o=Array.isArray(n.allow)?n.allow:[];n.allow_ip_literals;let r=null;return r=0===s.length&&0===o.length?()=>Object(d.a)("%(senderDisplayName)s set the server ACLs for this room.",{senderDisplayName:t}):()=>Object(d.a)("%(senderDisplayName)s changed the server ACLs for this room.",{senderDisplayName:t}),Array.isArray(i.allow)||(i.allow=[]),0===i.allow.length?()=>r()+" "+Object(d.a)("🎉 All servers are banned from participating! This room can no longer be used."):r},[c.b.RoomTombstone]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return()=>Object(d.a)("%(senderDisplayName)s upgraded this room.",{senderDisplayName:t})},[c.b.RoomJoinRules]:function(e,t){const n=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().join_rule){case a.c.Public:return()=>Object(d.a)("%(senderDisplayName)s made the room public to whoever knows the link.",{senderDisplayName:n});case a.c.Invite:return()=>Object(d.a)("%(senderDisplayName)s made the room invite only.",{senderDisplayName:n});case a.c.Restricted:return t?()=>s.a.createElement("span",null,Object(d.a)("%(senderDisplayName)s changed who can join this room. <a>View settings</a>.",{senderDisplayName:n},{a:e=>s.a.createElement(E.a,{kind:"link_inline",onClick:I},e)})):()=>Object(d.a)("%(senderDisplayName)s changed who can join this room.",{senderDisplayName:n});default:return()=>Object(d.a)("%(senderDisplayName)s changed the join rule to %(rule)s",{senderDisplayName:n,rule:e.getContent().join_rule})}},[c.b.RoomGuestAccess]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().guest_access){case a.a.CanJoin:return()=>Object(d.a)("%(senderDisplayName)s has allowed guests to join the room.",{senderDisplayName:t});case a.a.Forbidden:return()=>Object(d.a)("%(senderDisplayName)s has prevented guests from joining the room.",{senderDisplayName:t});default:return()=>Object(d.a)("%(senderDisplayName)s changed guest access to %(rule)s",{senderDisplayName:t,rule:e.getContent().guest_access})}},"im.vector.modular.widgets":function(e){const t=O(e),{name:n,type:i,url:s}=e.getPrevContent(),{name:o,type:r,url:a}=e.getContent()||{};let c=o||n||r||i||"";return c&&c.length>0&&(c=c[0].toUpperCase()+c.slice(1)),a?s?()=>Object(d.a)("%(widgetName)s widget modified by %(senderName)s",{widgetName:c,senderName:t}):()=>Object(d.a)("%(widgetName)s widget added by %(senderName)s",{widgetName:c,senderName:t}):()=>Object(d.a)("%(widgetName)s widget removed by %(senderName)s",{widgetName:c,senderName:t})},[g.c]:function(e){const t=O(e);return()=>Object(d.a)("%(senderName)s has updated the room layout",{senderName:t})}};for(const e of p.a)U[e]=j;function L(e,t){const n=(e.isState()?U:M)[e.getType()];return Boolean(null==n?void 0:n(e,!1,t))}function F(e){var t;let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0;const s=(e.isState()?U:M)[e.getType()];return(null==s||null===(t=s(e,n,i))||void 0===t?void 0:t())||""}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const i=new RegExp("^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$","i");function s(e){return i.test(e)}},function(e,t,n){"use strict";let i,s;n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),function(e){e.Manual="MANUAL",e.Alphabetic="ALPHABETIC",e.Recent="RECENT"}(i||(i={})),function(e){e.Importance="IMPORTANCE",e.Natural="NATURAL"}(s||(s={}))},,,function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(94),r=n.n(o),a=n(89),c=n(149),l=n(117);t.a=e=>{let{children:t,getTextToCopy:n,border:o=!0,className:d}=e;const[u,h]=Object(i.useState)(void 0),m=r()("mx_CopyableText",d,{mx_CopyableText_border:o});return s.a.createElement("div",{className:m},t,s.a.createElement(l.a,{title:null!=u?u:Object(a.a)("Copy"),onClick:async e=>{e.preventDefault();const t=await Object(c.c)(n());h(t?Object(a.a)("Copied!"):Object(a.a)("Failed to copy"))},className:"mx_CopyableText_copyButton",onHideTooltip:()=>{u&&h(void 0)}}))}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(88),s=n.n(i);class o{constructor(e){this.timeout=e,s()(this,"timerHandle",void 0),s()(this,"startTs",void 0),s()(this,"promise",void 0),s()(this,"resolve",void 0),s()(this,"reject",void 0),s()(this,"onTimeout",()=>{const e=Date.now()-this.startTs;if(e>=this.timeout)this.resolve(),this.setNotStarted();else{const t=this.timeout-e;this.timerHandle=setTimeout(this.onTimeout,t)}}),this.setNotStarted()}setNotStarted(){this.timerHandle=null,this.startTs=null,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t}).finally(()=>{this.timerHandle=null})}changeTimeout(e){if(e===this.timeout)return;const t=e<this.timeout;this.timeout=e,this.isRunning()&&t&&(clearTimeout(this.timerHandle),this.onTimeout())}start(){return this.isRunning()||(this.startTs=Date.now(),this.timerHandle=setTimeout(this.onTimeout,this.timeout)),this}restart(){return this.isRunning()?(this.startTs=Date.now(),this):this.start()}abort(){return this.isRunning()&&(clearTimeout(this.timerHandle),this.reject(new Error("Timer was aborted.")),this.setNotStarted()),this}finished(){return this.promise}isRunning(){return null!==this.timerHandle}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return v}));var i=n(88),s=n.n(i),o=n(113),r=n(93),a=n(104),c=n(92),l=n(2),d=n(258),u=n(257),h=n(325),m=n(142),p=n(167);let g;!function(e){e.StartConnect="start_connect",e.Connect="connect",e.Disconnect="disconnect",e.Participants="participants"}(g||(g={}));const f=async function(e,t){let n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>!0;const s=new Promise(s=>{n=function(){i(...arguments)&&s()},e.on(t,n)}),o=!1===await Object(h.b)(s,!1,16e3);if(e.off(t,n),o)throw new Error("Timed out")};class v extends p.a{static get instance(){return v._instance||(v._instance=new v),v._instance}constructor(){super(c.a),s()(this,"activeChannel",void 0),s()(this,"_connected",!1),s()(this,"_participants",[]),s()(this,"connect",async(e,t,n)=>{this.activeChannel&&await this.disconnect();const i=Object(u.g)(e);if(!i)throw new Error("No video channel in room "+e);const s=m.a.getWidgetUid(i),r=d.a.instance;let a=r.getMessagingForUid(s);if(!a)try{await f(r,d.b.StoreMessaging,(e,t)=>e===s&&(a=t,!0))}catch(t){throw new Error(`Failed to bind video channel in room ${e}: ${t}`)}const c=new Promise((e,t)=>{const n=e=>{e===s&&(o(),t(new Error("Messaging stopped")))},i=()=>{o(),e()},o=()=>{r.off(d.b.StopMessaging,n),this.off(g.Connect,i),this.off(g.Disconnect,i)};r.on(d.b.StopMessaging,n),this.on(g.Connect,i),this.on(g.Disconnect,i)});if(!r.isWidgetReady(s))try{await Promise.race([f(r,d.b.WidgetReady,e=>e===s),c])}catch(t){throw new Error(`Video channel in room ${e} never became ready: ${t}`)}this.activeChannel=a,this.roomId=e,a.on("action:"+l.a.CallParticipants,this.onParticipants),a.on("action:"+l.a.MuteAudio,this.onMuteAudio),a.on("action:"+l.a.UnmuteAudio,this.onUnmuteAudio),a.on("action:"+l.a.MuteVideo,this.onMuteVideo),a.on("action:"+l.a.UnmuteVideo,this.onUnmuteVideo),a.once("action:"+l.a.HangupCall,this.onHangup),this.emit(g.StartConnect,e);const h=f(a,"action:"+l.a.JoinCall,e=>(this.ack(e),!0));a.transport.send(l.a.JoinCall,{audioDevice:null==t?void 0:t.label,videoDevice:null==n?void 0:n.label});try{await Promise.race([h,c])}catch(t){throw this.activeChannel=null,this.roomId=null,a.off("action:"+l.a.CallParticipants,this.onParticipants),a.off("action:"+l.a.MuteAudio,this.onMuteAudio),a.off("action:"+l.a.UnmuteAudio,this.onUnmuteAudio),a.off("action:"+l.a.MuteVideo,this.onMuteVideo),a.off("action:"+l.a.UnmuteVideo,this.onUnmuteVideo),a.off("action:"+l.a.HangupCall,this.onHangup),a.transport.ready&&a.transport.send(l.a.ForceHangupCall,{}),this.emit(g.Disconnect,e),new Error(`Failed to join call in room ${e}: ${t}`)}this.connected=!0,this.room.on(o.c.MyMembership,this.onMyMembership),window.addEventListener("beforeunload",this.setDisconnected),this.emit(g.Connect,e),await Object(u.c)(this.room)}),s()(this,"disconnect",async()=>{if(!this.activeChannel)throw new Error("Not connected to any video channel");const e=f(this,g.Disconnect);this.activeChannel.transport.send(l.a.HangupCall,{});try{await e}catch(e){throw new Error(`Failed to hangup call in room ${this.roomId}: ${e}`)}}),s()(this,"setDisconnected",async()=>{const e=this.roomId,t=this.room;this.activeChannel.off("action:"+l.a.HangupCall,this.onHangup),this.activeChannel.off("action:"+l.a.CallParticipants,this.onParticipants),t.off(o.c.MyMembership,this.onMyMembership),window.removeEventListener("beforeunload",this.setDisconnected),this.activeChannel=null,this.roomId=null,this.connected=!1,this.participants=[],this.emit(g.Disconnect,e),await Object(u.h)(t)}),s()(this,"ack",e=>{this.activeChannel.transport.reply(e.detail,{})}),s()(this,"onHangup",async e=>{this.ack(e),this.connected||await f(this,g.Connect),await this.setDisconnected()}),s()(this,"onParticipants",e=>{this.participants=e.detail.data.participants,this.emit(g.Participants,this.roomId,e.detail.data.participants),this.ack(e)}),s()(this,"onMuteAudio",e=>{this.audioMuted=!0,this.ack(e)}),s()(this,"onUnmuteAudio",e=>{this.audioMuted=!1,this.ack(e)}),s()(this,"onMuteVideo",e=>{this.videoMuted=!0,this.ack(e)}),s()(this,"onUnmuteVideo",e=>{this.videoMuted=!1,this.ack(e)}),s()(this,"onMyMembership",(e,t)=>{"join"!==t&&this.setDisconnected()})}async onAction(e){}get roomId(){return r.b.getValue("videoChannelRoomId")}set roomId(e){r.b.setValue("videoChannelRoomId",null,a.a.DEVICE,e)}get room(){return this.matrixClient.getRoom(this.roomId)}get connected(){return this._connected}set connected(e){this._connected=e}get participants(){return this._participants}set participants(e){this._participants=e}get audioMuted(){return r.b.getValue("audioInputMuted")}set audioMuted(e){r.b.setValue("audioInputMuted",null,a.a.DEVICE,e)}get videoMuted(){return r.b.getValue("videoInputMuted")}set videoMuted(e){r.b.setValue("videoInputMuted",null,a.a.DEVICE,e)}}s()(v,"_instance",void 0)},,function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(88),c=n.n(a),l=n(87),d=n.n(l),u=n(111),h=n(94),m=n.n(h),p=n(91),g=n(114),f=n(109);const v=["onSearch","onCleared","onKeyDown","onFocus","onBlur","className","placeholder","blurredPlaceholder","autoFocus","initialValue","collapsed"];class b extends d.a.Component{constructor(e){super(e),c()(this,"search",Object(l.createRef)()),c()(this,"onChange",()=>{this.search.current&&(this.setState({searchTerm:this.search.current.value}),this.onSearch())}),c()(this,"onSearch",Object(u.throttle)(()=>{this.props.onSearch(this.search.current.value)},200,{trailing:!0,leading:!0})),c()(this,"onKeyDown",e=>{switch(Object(g.a)().getAccessibilityAction(e)){case f.h.Escape:this.clearSearch("keyboard")}this.props.onKeyDown&&this.props.onKeyDown(e)}),c()(this,"onFocus",e=>{this.setState({blurred:!1}),e.target.select(),this.props.onFocus&&this.props.onFocus(e)}),c()(this,"onBlur",e=>{this.setState({blurred:!0}),this.props.onBlur&&this.props.onBlur(e)}),this.state={searchTerm:e.initialValue||"",blurred:!0}}clearSearch(e){this.search.current.value="",this.onChange(),this.props.onCleared&&this.props.onCleared(e)}render(){const e=this.props,{onSearch:t,onCleared:n,onKeyDown:i,onFocus:o,onBlur:a,className:c="",placeholder:l,blurredPlaceholder:u,autoFocus:h,initialValue:g,collapsed:f}=e,b=r()(e,v);if(f)return null;const y=!this.state.blurred||this.state.searchTerm?d.a.createElement(p.a,{key:"button",tabIndex:-1,className:"mx_SearchBox_closeButton",onClick:()=>{this.clearSearch("button")}}):void 0;return d.a.createElement("div",{className:m()("mx_SearchBox","mx_textinput",{mx_SearchBox_blurred:this.state.blurred})},d.a.createElement("input",s()({},b,{key:"searchfield",type:"text",ref:this.search,className:"mx_textinput_icon mx_textinput_search "+c,value:this.state.searchTerm,onFocus:this.onFocus,onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this.onBlur,placeholder:this.state.blurred&&u||l,autoComplete:"off",autoFocus:this.props.autoFocus})),y)}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return h})),n.d(t,"d",(function(){return m})),n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return f}));var i=n(88),s=n.n(i),o=n(183),r=n(96),a=n(384),c=n(135),l=n(217),d=n(92),u=n(264);function h(e,t){const n=c.a.shared().getDMRoomsForUserId(t).map(t=>e.getRoom(t)).filter(e=>{if(e&&"join"===e.getMyMembership()){const n=e.currentState.getMembers().filter(e=>Object(l.c)(e.membership));return n.find(e=>e.userId===t)&&2===n.length}return!1}).sort((e,t)=>t.getLastActiveTimestamp()-e.getLastActiveTimestamp());if(n.length)return n[0]}async function m(e,t){const n=t.map(e=>e.userId);let i;if(i=1===n.length?h(e,n[0]):c.a.shared().getDMRoomForIdentifiers(n),i)return void d.a.dispatch({action:r.a.ViewRoom,room_id:i.roomId,should_peek:!1,joining:!1,metricsTrigger:"MessageUser"});const s={inlineErrors:!0};if(Object(u.c)()){if(!t.some(e=>e instanceof f)){await Object(o.a)(e,n)&&(s.encryption=!0)}}const l=1===n.length&&n[0]===e.getUserId();1!==n.length||l||(s.dmUserId=n[0]),n.length>1&&(s.createOpts=n.reduce((t,n)=>{const i=Object(a.b)(n);if("email"===i){const i={id_server:e.getIdentityServerUrl(!0),medium:"email",address:n};t.invite_3pid.push(i)}else"mx-user-id"===i&&t.invite.push(n);return t},{invite:[],invite_3pid:[]})),await Object(o.b)(s)}class p{}class g extends p{constructor(e){super(),s()(this,"_userId",void 0),s()(this,"displayName",void 0),s()(this,"avatarUrl",void 0),this._userId=e.user_id,this.displayName=e.display_name,this.avatarUrl=e.avatar_url}get name(){return this.displayName||this._userId}get userId(){return this._userId}getMxcAvatarUrl(){return this.avatarUrl}}class f extends p{constructor(e){super(),s()(this,"id",void 0),this.id=e}get isEmail(){return this.id.includes("@")}get name(){return this.id}get userId(){return this.id}getMxcAvatarUrl(){return null}}},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(94),r=n.n(o),a=n(220);t.a=function(e){let{name:t,definitions:n,value:i,className:o,outlined:c,disabled:l,onChange:d}=e;const u=e=>{d(e.target.value)};return s.a.createElement(s.a.Fragment,null,n.map(e=>{var n;const d=`${t}-${e.value}`;return s.a.createElement(s.a.Fragment,{key:e.value},s.a.createElement(a.a,{id:d,className:r()(o,e.className),onChange:u,checked:void 0!==e.checked?e.checked:e.value===i,name:t,value:e.value,disabled:null!==(n=e.disabled)&&void 0!==n?n:l,outlined:c,"aria-describedby":e.description?d+"-description":void 0},e.label),e.description?s.a.createElement("span",{id:d+"-description"},e.description):null)}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return E}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(335),c=n.n(a),l=n(0),d=n(89),u=n(95),h=n(91),m=n(128),p=n(107),g=n(399),f=n(763),v=n(211),b=n(106);let y;function S(e){if(!e)return"";const t=window.getComputedStyle(e,null);let n=t.cssText;if(""==n)for(let e=0;e<t.length;e++)n+=t[e]+":",n+=t.getPropertyValue(t[e])+";";return n}!async function(){if(y)return;const e=await fetch(n(1326).default).then(e=>e.text());y="data:image/svg+xml;base64,"+window.btoa(e)}();class E extends r.a.Component{constructor(e){super(e),s()(this,"context",void 0),s()(this,"iframe",Object(o.createRef)()),s()(this,"dummyLink",Object(o.createRef)()),s()(this,"userDidClick",!1),s()(this,"fileDownloader",new f.a(()=>this.iframe.current)),s()(this,"decryptFile",async()=>{if(!this.state.decryptedBlob)try{this.userDidClick=!0,this.setState({decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value})}catch(e){l.a.warn("Unable to decrypt attachment: ",e),u.a.createTrackedDialog("Error decrypting attachment","",p.a,{title:Object(d.a)("Error"),description:Object(d.a)("Error decrypting attachment")})}}),s()(this,"onPlaceholderClick",async()=>{const e=this.props.mediaEventHelper;null!=e&&e.media.isEncrypted?(await this.decryptFile(),this.downloadFile(this.fileName,this.linkText)):this.fileDownloader.download({blob:await e.sourceBlob.value,name:this.fileName})}),this.state={}}getContentUrl(){if(this.props.forExport)return null;return Object(m.a)(this.props.mxEvent.getContent()).srcHttp}get content(){return this.props.mxEvent.getContent()}get fileName(){return this.content.body&&this.content.body.length>0?this.content.body:Object(d.a)("Attachment")}get linkText(){return Object(g.a)(this.content)}downloadFile(e,t){this.fileDownloader.download({blob:this.state.decryptedBlob,name:e,autoDownload:this.userDidClick,opts:{imgSrc:y,imgStyle:null,style:S(this.dummyLink.current),textContent:Object(d.a)("Download %(text)s",{text:t})}})}componentDidUpdate(e,t){this.props.onHeightChanged&&!t.decryptedBlob&&this.state.decryptedBlob&&this.props.onHeightChanged()}render(){var e;const t=null===(e=this.props.mediaEventHelper)||void 0===e?void 0:e.media.isEncrypted,n=this.getContentUrl(),i=this.content.info?this.content.info.size:null,s=this.content.info?this.content.info.mimetype:"application/octet-stream";let o=null;if(this.props.showGenericPlaceholder&&(o=r.a.createElement(h.a,{className:"mx_MediaBody mx_MFileBody_info",onClick:this.onPlaceholderClick},r.a.createElement("span",{className:"mx_MFileBody_info_icon"}),r.a.createElement(v.a,{tooltip:Object(g.a)(this.content,Object(d.a)("Attachment"),!0)},r.a.createElement("span",{className:"mx_MFileBody_info_filename"},Object(g.a)(this.content,Object(d.a)("Attachment"),!0,!0))))),this.props.forExport){var a;const e=this.props.mxEvent.getContent();return r.a.createElement("span",{className:"mx_MFileBody"},r.a.createElement("a",{href:(null===(a=e.file)||void 0===a?void 0:a.url)||e.url},o))}let u=!this.props.showGenericPlaceholder||this.context.timelineRenderingType!==b.a.Room&&this.context.timelineRenderingType!==b.a.Search&&this.context.timelineRenderingType!==b.a.Pinned;if(this.context.timelineRenderingType===b.a.Thread&&(u=!1),t){if(!this.state.decryptedBlob)return r.a.createElement("span",{className:"mx_MFileBody"},o,u&&r.a.createElement("div",{className:"mx_MFileBody_download"},r.a.createElement(h.a,{onClick:this.decryptFile},Object(d.a)("Decrypt %(text)s",{text:this.linkText}))));const e="usercontent/";return r.a.createElement("span",{className:"mx_MFileBody"},o,u&&r.a.createElement("div",{className:"mx_MFileBody_download"},r.a.createElement("div",{"aria-hidden":!0,style:{display:"none"}},r.a.createElement("a",{ref:this.dummyLink})),r.a.createElement("iframe",{"aria-hidden":!0,title:Object(g.a)(this.content,Object(d.a)("Attachment"),!0,!0),src:e,onLoad:()=>this.downloadFile(this.fileName,this.linkText),ref:this.iframe,sandbox:"allow-scripts allow-downloads allow-downloads-without-user-activation"})))}if(n){var m;const e={target:"_blank",rel:"noreferrer noopener",href:n},t="number"!=typeof i||i>524288e3;return["application/pdf"].includes(s)&&!t?e.onClick=e=>{l.a.log(`Downloading ${s} as blob (unencrypted)`),e.preventDefault(),e.stopPropagation(),this.props.mediaEventHelper.sourceBlob.value.then(e=>{const t=URL.createObjectURL(e),n=document.createElement("a");n.download=this.fileName,n.href=t,document.body.appendChild(n),n.click(),n.remove()})}:e.download=this.fileName,r.a.createElement("span",{className:"mx_MFileBody"},o,u&&r.a.createElement("div",{className:"mx_MFileBody_download"},r.a.createElement("a",e,r.a.createElement("span",{className:"mx_MFileBody_download_icon"}),Object(d.a)("Download %(text)s",{text:this.linkText})),this.context.timelineRenderingType===b.a.File&&r.a.createElement("div",{className:"mx_MImageBody_size"},null!==(m=this.content.info)&&void 0!==m&&m.size?c()(this.content.info.size):"")))}{const e=this.linkText?": "+this.linkText:"";return r.a.createElement("span",{className:"mx_MFileBody"},o,Object(d.a)("Invalid file%(extra)s",{extra:e}))}}}s()(E,"contextType",b.b),s()(E,"defaultProps",{showGenericPlaceholder:!0})},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return l}));var i,s,o,r,a=n(87);function c(){return(c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function l(e){return a.createElement("svg",c({xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",viewBox:"0 0 24 23",role:"presentation","aria-hidden":!0},e),i||(i=a.createElement("defs",null,a.createElement("path",{id:"warning_svg__a",d:"M9.2 2.2c1.6-2.9 4.1-2.9 5.7 0l8.3 15.4c1.6 2.9.2 5.3-3.2 5.3H4c-3.3 0-4.7-2.4-3.2-5.3L9.2 2.2zm0 0"}))),s||(s=a.createElement("clipPath",{id:"warning_svg__b"},a.createElement("use",{xlinkHref:"#warning_svg__a",overflow:"visible"}))),o||(o=a.createElement("path",{clipPath:"url(#warning_svg__b)",fill:"#ff0064",d:"M-4.8-5h33.6v32.9H-4.8z"})),r||(r=a.createElement("g",null,a.createElement("defs",null,a.createElement("path",{id:"warning_svg__c",d:"M12.7 15l.3-9.6h-2l.3 9.6h1.4zm-.7 4.1c.7 0 1.2-.5 1.2-1.2s-.5-1.2-1.2-1.2-1.2.5-1.2 1.2.5 1.2 1.2 1.2zm0 0"})),a.createElement("clipPath",{id:"warning_svg__d"},a.createElement("use",{xlinkHref:"#warning_svg__c",overflow:"visible"})),a.createElement("path",{clipPath:"url(#warning_svg__d)",fill:"#fff",d:"M5.8.4h12.4v23.7H5.8z"}))))}t.default="img/warning.05cc423.svg"},function(e,t,n){"use strict";var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(94),d=n.n(l),u=n(543);const h=["className","withError","isIdle"];t.a=e=>{let{className:t,withError:n,isIdle:i}=e,o=r()(e,h);return c.a.createElement(u.a,s()({},o,{className:d()("mx_StyledLiveBeaconIcon",t,{mx_StyledLiveBeaconIcon_error:n,mx_StyledLiveBeaconIcon_idle:i})}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return p})),n.d(t,"c",(function(){return g}));var i=n(88),s=n.n(i),o=n(87),r=n(94),a=n.n(r),c=n(0),l=n(89),d=n(176),u=n(91),h=n(127);class m{constructor(e,t,n,i,s){this.id=e,this.label=t,this.icon=n,this.body=i,this.screenName=s}}let p;!function(e){e.LEFT="left",e.TOP="top"}(p||(p={}));class g extends o.Component{constructor(e){super(e);let t=0;if(e.initialTabId){const n=e.tabs.findIndex(t=>t.id===e.initialTabId);n>=0&&(t=n)}this.state={activeTabIndex:t}}getActiveTabIndex(){return this.state&&this.state.activeTabIndex?this.state.activeTabIndex:0}setActiveTab(e){const t=this.props.tabs.indexOf(e);-1!==t?(this.props.onChange&&this.props.onChange(e.id),this.setState({activeTabIndex:t})):c.a.error("Could not find tab "+e.label+" in tabs")}renderTabLabel(e){let t="mx_TabbedView_tabLabel ";this.props.tabs.indexOf(e)===this.getActiveTabIndex()&&(t+="mx_TabbedView_tabLabel_active");let n=null;e.icon&&(n=o.createElement("span",{className:"mx_TabbedView_maskedIcon "+e.icon}));const i=Object(l.a)(e.label);return o.createElement(u.a,{className:t,key:"tab_label_"+e.label,onClick:()=>this.setActiveTab(e)},n,o.createElement("span",{className:"mx_TabbedView_tabLabel_text"},i))}renderTabPanel(e){return o.createElement("div",{className:"mx_TabbedView_tabPanel",key:"mx_tabpanel_"+e.label},o.createElement(d.a,{className:"mx_TabbedView_tabPanelContent"},e.body))}render(){var e;const t=this.props.tabs.map(e=>this.renderTabLabel(e)),n=this.props.tabs[this.getActiveTabIndex()],i=this.renderTabPanel(n),s=a()({mx_TabbedView:!0,mx_TabbedView_tabsOnLeft:this.props.tabLocation==p.LEFT,mx_TabbedView_tabsOnTop:this.props.tabLocation==p.TOP});return o.createElement("div",{className:s},o.createElement(h.a,{screenName:null!==(e=null==n?void 0:n.screenName)&&void 0!==e?e:this.props.screenName}),o.createElement("div",{className:"mx_TabbedView_tabLabels"},t),i)}}s()(g,"defaultProps",{tabLocation:p.LEFT})},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"c",(function(){return m})),n.d(t,"b",(function(){return p})),n.d(t,"d",(function(){return g})),n.d(t,"e",(function(){return f}));var i=n(88),s=n.n(i),o=n(161),r=n(0),a=n(92),c=n(96),l=n(578),d=n(90),u=n(381);const h="mx_sso_hs_url",m="mx_sso_is_url",p="mx_sso_idp_id";let g;!function(e){e.Checking="CHECKING",e.Error="ERROR",e.NotAvailable="NOTAVAILABLE",e.Downloading="DOWNLOADING",e.Ready="READY"}(g||(g={}));class f{constructor(){s()(this,"notificationCount",0),s()(this,"errorDidOccur",!1),s()(this,"onAction",e=>{switch(e.action){case"on_client_not_viable":case c.a.OnLoggedOut:this.setNotificationCount(0)}}),a.a.register(this.onAction),this.startUpdateCheck=this.startUpdateCheck.bind(this)}setNotificationCount(e){this.notificationCount=e}setErrorStatus(e){this.errorDidOccur=e}async canSelfUpdate(){return!1}startUpdateCheck(){Object(l.a)(),localStorage.removeItem("mx_defer_update"),a.a.dispatch({action:c.a.CheckUpdates,status:g.Checking})}installUpdate(){}shouldShowUpdate(e){if(d.a.userRegisteredWithinLastHours(24))return!1;try{const[t,n]=JSON.parse(localStorage.getItem("mx_defer_update"));return e!==t||Date.now()>n}catch(e){return!0}}deferUpdate(e){const t=new Date(Date.now()+864e5);t.setHours(8,0,0,0),localStorage.setItem("mx_defer_update",JSON.stringify([e,t.getTime()])),Object(l.a)()}supportsMultiLanguageSpellCheck(){return!1}allowOverridingNativeContextMenus(){return!1}supportsNotifications(){return!1}maySendNotifications(){return!1}displayNotification(e,t,n,i,s){const o={body:t,silent:!0};n&&(o.icon=n);const r=new window.Notification(e,o);return r.onclick=()=>{const e={action:c.a.ViewRoom,room_id:i.roomId,metricsTrigger:"Notification"};s.getThread()&&(e.event_id=s.getId()),a.a.dispatch(e),window.focus()},r}loudNotification(e,t){}clearNotification(e){e.close&&e.close()}screenCaptureErrorString(){return"Not implemented"}supportsAutoLaunch(){return!1}async getAutoLaunchEnabled(){return!1}async setAutoLaunchEnabled(e){throw new Error("Unimplemented")}supportsWarnBeforeExit(){return!1}async shouldWarnBeforeExit(){return!1}async setWarnBeforeExit(e){throw new Error("Unimplemented")}supportsAutoHideMenuBar(){return!1}async getAutoHideMenuBarEnabled(){return!1}async setAutoHideMenuBarEnabled(e){throw new Error("Unimplemented")}supportsMinimizeToTray(){return!1}async getMinimizeToTrayEnabled(){return!1}async setMinimizeToTrayEnabled(e){throw new Error("Unimplemented")}supportsTogglingHardwareAcceleration(){return!1}async getHardwareAccelerationEnabled(){return!0}async setHardwareAccelerationEnabled(e){throw new Error("Unimplemented")}getEventIndexingManager(){return null}async setLanguage(e){}setSpellCheckLanguages(e){}getSpellCheckLanguages(){return null}async getDesktopCapturerSources(e){return[]}supportsDesktopCapturer(){return!1}overrideBrowserShortcuts(){return!1}navigateForwardBack(e){}getAvailableSpellCheckLanguages(){return null}getSSOCallbackUrl(e){const t=new URL(window.location.href);return t.hash=e||"",t}startSingleSignOn(e,t,n,i){localStorage.setItem(h,e.getHomeserverUrl()),e.getIdentityServerUrl()&&localStorage.setItem(m,e.getIdentityServerUrl()),i&&localStorage.setItem(p,i);const s=this.getSSOCallbackUrl(n);window.location.href=e.getSsoLoginUrl(s.toString(),t,i)}onKeyDown(e){return!1}async getPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;let n;try{n=await Object(u.c)("pickleKey",[e,t])}catch(e){r.a.error("idbLoad for pickleKey failed",e)}if(!n)return null;if(!n.encrypted||!n.iv||!n.cryptoKey)return r.a.error("Badly formatted pickle key"),null;const i=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);i[e.length]=124;for(let n=0;n<t.length;n++)i[e.length+1+n]=t.charCodeAt(n);try{const e=await crypto.subtle.decrypt({name:"AES-GCM",iv:n.iv,additionalData:i},n.cryptoKey,n.encrypted);return Object(o.encodeUnpaddedBase64)(e)}catch(e){return r.a.error("Error decrypting pickle key"),null}}async createPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;const n=window.crypto,i=new Uint8Array(32);n.getRandomValues(i);const s=await n.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),r=new Uint8Array(32);n.getRandomValues(r);const a=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)a[t]=e.charCodeAt(t);a[e.length]=124;for(let n=0;n<t.length;n++)a[e.length+1+n]=t.charCodeAt(n);const c=await n.subtle.encrypt({name:"AES-GCM",iv:r,additionalData:a},s,i);try{await Object(u.d)("pickleKey",[e,t],{encrypted:c,iv:r,cryptoKey:s})}catch(e){return null}return Object(o.encodeUnpaddedBase64)(i)}async destroyPickleKey(e,t){try{await Object(u.b)("pickleKey",[e,t])}catch(e){r.a.error("idbDelete failed in destroyPickleKey",e)}}}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(17),s=n.n(i),o=n(0),r=n(7);function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class l{constructor(){s()(this,"outgoingRoomKeyRequests",[]),s()(this,"account",null),s()(this,"crossSigningKeys",null),s()(this,"privateKeys",{}),s()(this,"sessions",{}),s()(this,"sessionProblems",{}),s()(this,"notifiedErrorDevices",{}),s()(this,"inboundGroupSessions",{}),s()(this,"inboundGroupSessionsWithheld",{}),s()(this,"deviceData",null),s()(this,"rooms",{}),s()(this,"sessionsNeedingBackup",{}),s()(this,"sharedHistoryInboundGroupSessions",{})}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return r.A(()=>{const n=this._getOutgoingRoomKeyRequest(t);return n?(o.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),n):(o.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this.outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this.outgoingRoomKeyRequests)if(r.i(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this.outgoingRoomKeyRequests)for(const n of e)if(t.state===n)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter(t=>t.state==e))}getOutgoingRoomKeyRequestsByTarget(e,t,n){const i=[];for(const s of this.outgoingRoomKeyRequests)for(const o of n)s.state===o&&s.recipients.includes({userId:e,deviceId:t})&&i.push(s);return Promise.resolve(i)}updateOutgoingRoomKeyRequest(e,t,n){for(const i of this.outgoingRoomKeyRequests)if(i.requestId===e)return i.state!==t?(o.a.warn(`Cannot update room key request from ${t} as it was already updated to `+i.state),Promise.resolve(null)):(Object.assign(i,n),Promise.resolve(i));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let n=0;n<this.outgoingRoomKeyRequests.length;n++){const i=this.outgoingRoomKeyRequests[n];if(i.requestId===e)return i.state!=t?(o.a.warn(`Cannot delete room key request in state ${i.state} (expected ${t})`),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(n,1),Promise.resolve(i))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,n){t(this.privateKeys[n]||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,n){this.privateKeys[t]=n}countEndToEndSessions(e,t){t(Object.keys(this.sessions).length)}getEndToEndSession(e,t,n,i){i((this.sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,n){n(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach(e=>{let[n,i]=e;Object.entries(i).forEach(e=>{let[i,s]=e;t(c(c({},s),{},{deviceKey:n,sessionId:i}))})})}storeEndToEndSession(e,t,n,i){let s=this.sessions[e];void 0===s&&(s={},this.sessions[e]=s),s[t]=n}async storeEndToEndSessionProblem(e,t,n){const i=this.sessionProblems[e]=this.sessionProblems[e]||[];i.push({type:t,fixed:n,time:Date.now()}),i.sort((e,t)=>e.time-t.time)}async getEndToEndSessionProblem(e,t){const n=this.sessionProblems[e]||[];if(!n.length)return null;const i=n[n.length-1];for(const e of n)if(e.time>t)return Object.assign({},e,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){const t=this.notifiedErrorDevices,n=[];for(const i of e){const{userId:e,deviceInfo:s}=i;e in t?s.deviceId in t[e]||(n.push(i),t[e][s.deviceId]=!0):(n.push(i),t[e]={[s.deviceId]:!0})}return n}getEndToEndInboundGroupSession(e,t,n,i){const s=e+"/"+t;i(this.inboundGroupSessions[s]||null,this.inboundGroupSessionsWithheld[s]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this.inboundGroupSessions))t({senderKey:e.slice(0,43),sessionId:e.slice(44),sessionData:this.inboundGroupSessions[e]});t(null)}addEndToEndInboundGroupSession(e,t,n,i){const s=e+"/"+t;void 0===this.inboundGroupSessions[s]&&(this.inboundGroupSessions[s]=n)}storeEndToEndInboundGroupSession(e,t,n,i){this.inboundGroupSessions[e+"/"+t]=n}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){const s=e+"/"+t;this.inboundGroupSessionsWithheld[s]=n}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,n){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){const t=[];for(const n in this.sessionsNeedingBackup)if(this.inboundGroupSessions[n]&&(t.push({senderKey:n.slice(0,43),sessionId:n.slice(44),sessionData:this.inboundGroupSessions[n]}),e&&n.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this.sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this.sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,n){const i=this.sharedHistoryInboundGroupSessions[e]||[];i.push([t,n]),this.sharedHistoryInboundGroupSessions[e]=i}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}doTxn(e,t,n){return Promise.resolve(n(null))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(17),s=n.n(i),o=n(200),r=n(116);function a(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}class c{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s()(this,"rooms",{}),s()(this,"users",{}),s()(this,"syncToken",null),s()(this,"filters",{}),s()(this,"accountData",{}),s()(this,"localStorage",void 0),s()(this,"oobMembers",{}),s()(this,"clientOptions",{}),s()(this,"onRoomMember",(e,t,n)=>{if("invite"===n.membership)return;const i=this.users[n.userId]||new o.a(n.userId);n.name&&(i.setDisplayName(n.name),n.events.member&&i.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&i.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[i.userId]=i}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(r.b.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(r.b.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map((function(e){return e.summary}))}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,n,i){}storeFilter(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)}getFilter(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null}getFilterIdByName(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const e=this.localStorage.getItem(t);if(a(e))return e}catch(e){}return null}setFilterIdByName(e,t){if(!this.localStorage)return;const n="mxjssdk_memory_filter_"+e;try{a(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch(e){}}storeAccountDataEvents(e){e.forEach(e=>{this.accountData[e.getType()]=e})}getAccountData(e){return this.accountData[e]}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers[e]||null)}setOutOfBandMembers(e,t){return this.oobMembers[e]=t,Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers={},Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(7);function s(e,t,n,s,o){let r=arguments.length>5&&void 0!==arguments[5]&&arguments[5];if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return r?t:"";let a=t.slice(6),c="/_matrix/media/r0/download/";const l={};n&&(l.width=Math.round(n).toString()),s&&(l.height=Math.round(s).toString()),o&&(l.method=o),Object.keys(l).length>0&&(c="/_matrix/media/r0/thumbnail/");const d=a.indexOf("#");let u="";d>=0&&(u=a.slice(d),a=a.slice(0,d));const h=0===Object.keys(l).length?"":"?"+i.m(l);return e+c+a+h+u}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return m}));var i=n(17),s=n.n(i),o=n(144),r=n(108),a=n(0),c=n(315),l=n(113),d=n(143);let u,h;u=a.a.log.bind(a.a),function(e){e.Ignore="ignore",e.Replace="replace"}(h||(h={}));class m extends d.b{constructor(e,t){super(),this.room=e,s()(this,"timelineSupport",void 0),s()(this,"unstableClientRelationAggregation",void 0),s()(this,"displayPendingEvents",void 0),s()(this,"liveTimeline",void 0),s()(this,"timelines",void 0),s()(this,"_eventIdToTimeline",void 0),s()(this,"filter",void 0),s()(this,"relations",void 0),this.timelineSupport=Boolean(t.timelineSupport),this.liveTimeline=new o.b(this),this.unstableClientRelationAggregation=!!t.unstableClientRelationAggregation,this.displayPendingEvents=!1!==t.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline={},this.filter=t.filter,this.unstableClientRelationAggregation&&(this.relations={})}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}eventIdToTimeline(e){return this._eventIdToTimeline[e]}replaceEventId(e,t){const n=this._eventIdToTimeline[e];n&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=n)}resetLiveTimeline(e,t){const n=!this.timelineSupport||!t,i=this.liveTimeline,s=n?i.forkLive(o.b.FORWARDS):i.fork(o.b.FORWARDS);n?(this.timelines=[s],this._eventIdToTimeline={}):this.timelines.push(s),t&&i.setPaginationToken(t,o.b.FORWARDS),s.setPaginationToken(e,o.b.BACKWARDS),this.liveTimeline=s,this.emit(l.c.TimelineReset,this.room,this,n)}getTimelineForEvent(e){const t=this._eventIdToTimeline[e];return void 0===t?null:t}findEventById(e){const t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new o.b(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,i){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&!(e=this.filter.filterRoomTimeline(e)).length)return;const s=t?o.b.BACKWARDS:o.b.FORWARDS,r=t?o.b.FORWARDS:o.b.BACKWARDS;let c=!1,l=!1;for(let i=0;i<e.length;i++){const d=e[i],h=d.getId(),m=this._eventIdToTimeline[h];if(!m){this.addEventToTimeline(d,n,t),l=!0,c=!0;continue}if(l=!1,m==n){u("Event "+h+" already in timeline "+n);continue}const p=n.getNeighbouringTimeline(s);if(p){u(m==p?"Event "+h+" in neighbouring timeline - switching to "+m:"Event "+h+" already in a different timeline "+m),n=m;continue}a.a.info("Already have timeline for "+h+" - joining timeline "+n+" to "+m);const g=m===this.liveTimeline,f=n===this.liveTimeline,v=s===o.b.BACKWARDS&&g,b=s===o.b.FORWARDS&&f;v||b?(v&&a.a.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+m+")"),b&&a.a.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+n+")")):(n.setNeighbouringTimeline(m,s),m.setNeighbouringTimeline(n,r),n=m,c=!0)}if(l||!c){if(s===o.b.FORWARDS&&n===this.liveTimeline)return a.a.warn({lastEventWasNew:l,didUpdate:c}),void a.a.warn(`Refusing to set forwards pagination token of live timeline ${n} to ${i}`);n.setPaginationToken(i,s)}}addLiveEvent(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:h.Ignore,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;if(this.filter){if(!this.filter.filterRoomTimeline([e]).length)return}const s=this._eventIdToTimeline[e.getId()];if(s)if(t===h.Replace){u("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=s.getEvents();for(let n=0;n<t.length;n++)if(t[n].getId()===e.getId()){i||(i=s.getState(o.b.FORWARDS)),o.b.setEventMetadata(e,i,!1),t[n]=e;break}}else u("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this.liveTimeline,!1,n,i)}addEventToTimeline(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4?arguments[4]:void 0;const o=e.getId();t.addEvent(e,n,s),this._eventIdToTimeline[o]=t,this.setRelationsTarget(e),this.aggregateRelations(e);const r={timeline:t,liveEvent:!n&&t==this.liveTimeline&&!i};this.emit(l.c.Timeline,e,this.room,Boolean(n),!1,r)}handleRemoteEcho(e,t,n){const i=this._eventIdToTimeline[t];i?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[n]=i):this.filter?this.filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this.liveTimeline,!1):this.addEventToTimeline(e,this.liveTimeline,!1)}removeEvent(e){const t=this._eventIdToTimeline[e];if(!t)return null;const n=t.removeEvent(e);if(n){delete this._eventIdToTimeline[e];const i={timeline:t};this.emit(l.c.Timeline,n,this.room,void 0,!0,i)}return n}compareEventOrdering(e,t){if(e==t)return 0;const n=this._eventIdToTimeline[e],i=this._eventIdToTimeline[t];if(void 0===n)return null;if(void 0===i)return null;if(n===i){let i,s;const o=n.getEvents();for(let n=0;n<o.length&&(void 0===i||void 0===s);n++){const r=o[n].getId();r==e&&(i=n),r==t&&(s=n)}return i-s}let s=n;for(;s;){if(s===i)return-1;s=s.getNeighbouringTimeline(o.b.FORWARDS)}for(s=n;s;){if(s===i)return 1;s=s.getNeighbouringTimeline(o.b.BACKWARDS)}return null}getRelationsForEvent(e,t,n){if(!this.unstableClientRelationAggregation)throw new Error("Client-side relation aggregation is disabled");if(!e||!t||!n)throw new Error("Invalid arguments for `getRelationsForEvent`");return((this.relations[e]||{})[t]||{})[n]}getAllRelationsEventForEvent(e){var t;const n=(null===(t=this.relations)||void 0===t?void 0:t[e])||{},i=[];for(const e of Object.values(n))for(const t of Object.values(e))i.push(...t.getRelations());return i}setRelationsTarget(e){if(!this.unstableClientRelationAggregation)return;const t=this.relations[e.getId()];if(t)for(const n of Object.values(t))for(const t of Object.values(n))t.setTargetEvent(e)}aggregateRelations(e){if(!this.unstableClientRelationAggregation)return;if(e.isRedacted()||e.status===r.a.CANCELLED)return;const t=e=>{e.isDecryptionFailure()?e.once(r.c.Decrypted,t):this.aggregateRelations(e)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption())return void e.once(r.c.Decrypted,t);const n=e.getRelation();if(!n)return;const i=n.event_id,s=n.rel_type,o=e.getType();let a=this.relations[i];a||(a=this.relations[i]={});let l=a[s];l||(l=a[s]={});let d=l[o];if(!d){d=l[o]=new c.a(s,o,this.room);const e=this.findEventById(i)||this.room.getPendingEvent(i);e&&d.setTargetEvent(e)}d.addEvent(e)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d}));var i=n(17),s=n.n(i),o=n(108),r=n(0),a=n(97),c=n(143);let l;!function(e){e.Add="Relations.add",e.Remove="Relations.remove",e.Redaction="Relations.redaction"}(l||(l={}));class d extends c.b{constructor(e,t,n){super(),this.relationType=e,this.eventType=t,this.room=n,s()(this,"relationEventIds",new Set),s()(this,"relations",new Set),s()(this,"annotationsByKey",{}),s()(this,"annotationsBySender",{}),s()(this,"sortedAnnotationsByKey",[]),s()(this,"targetEvent",null),s()(this,"creationEmitted",!1),s()(this,"onEventStatus",(e,t)=>{e.isSending()?t===o.a.CANCELLED&&(e.removeListener(o.c.Status,this.onEventStatus),this.removeEvent(e)):e.removeListener(o.c.Status,this.onEventStatus)}),s()(this,"onBeforeRedaction",async e=>{if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===a.d.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.d.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener(o.c.BeforeRedaction,this.onBeforeRedaction),this.emit(l.Redaction,e)}})}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;const t=e.getRelation();if(!t)return void r.a.error("Event must have relation info");const n=t.rel_type,i=e.getType();if(this.relationType===n&&this.eventType===i){if(e.isSending()&&e.on(o.c.Status,this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===a.d.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===a.d.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on(o.c.BeforeRedaction,this.onBeforeRedaction),this.emit(l.Add,e),this.maybeEmitCreated()}else r.a.error("Event relation info doesn't match this container")}async removeEvent(e){if(!this.relations.has(e))return;const t=e.getRelation();if(!t)return void r.a.error("Event must have relation info");const n=t.rel_type,i=e.getType();if(this.relationType===n&&this.eventType===i){if(this.relations.delete(e),this.relationType===a.d.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.d.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit(l.Remove,e)}else r.a.error("Event relation info doesn't match this container")}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){const{key:t}=e.getRelation();if(!t)return;let n=this.annotationsByKey[t];n||(n=this.annotationsByKey[t]=new Set,this.sortedAnnotationsByKey.push([t,n])),n.add(e),this.sortedAnnotationsByKey.sort((e,t)=>{const n=e[1];return t[1].size-n.size});const i=e.getSender();let s=this.annotationsBySender[i];s||(s=this.annotationsBySender[i]=new Set),s.add(e)}removeAnnotationFromAggregation(e){const{key:t}=e.getRelation();if(!t)return;const n=this.annotationsByKey[t];n&&(n.delete(e),this.sortedAnnotationsByKey.sort((e,t)=>{const n=e[1];return t[1].size-n.size}));const i=e.getSender(),s=this.annotationsBySender[i];s&&s.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==a.d.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==a.d.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==a.d.Replace)return null;if(!this.targetEvent)return null;const e=this.targetEvent.getServerAggregatedRelation(a.d.Replace),t=null==e?void 0:e.origin_server_ts,n=this.getRelations().reduce((e,n)=>n.getSender()!==this.targetEvent.getSender()||t&&t>n.getTs()||e&&e.getTs()>n.getTs()?e:n,null);return null!=n&&n.shouldAttemptDecryption()?await n.attemptDecryption(this.room.client.crypto):null!=n&&n.isBeingDecrypted()&&await n.getDecryptionPromise(),n}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===a.d.Replace&&!this.targetEvent.isState()){const e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(o.c.RelationsCreated,this.relationType,this.eventType))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"h",(function(){return o})),n.d(t,"e",(function(){return r})),n.d(t,"g",(function(){return a})),n.d(t,"f",(function(){return c})),n.d(t,"d",(function(){return l})),n.d(t,"c",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(108);function s(e,t){return function(n){return function(e,t,n){const s=Object.assign({},{code:e,reason:t},n);return new i.b({type:"m.key.verification.cancel",content:s})}(e,t,n)}}const o=s("m.user","Cancelled by user"),r=s("m.timeout","Timed out"),a=(s("m.unknown_transaction","Unknown transaction"),s("m.unknown_method","Unknown method")),c=s("m.unexpected_message","Unexpected message"),l=s("m.key_mismatch","Key mismatch"),d=(s("m.user_error","User mismatch"),s("m.invalid_message","Invalid message"));function u(e){const t=e.getContent();if(t){const{code:e,reason:n}=t;return{code:e,reason:n}}return{code:"Unknown error",reason:"m.unknown"}}},function(e,t,n){"use strict";var i=n(88),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(94),d=n.n(l);const u=["size","className","children"];function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}t.a=e=>{let{size:t,className:n,children:i}=e,s=r()(e,u);return c.a.createElement(t||"h1",m(m({},s),{},{className:d()("mx_Heading_"+t,n),children:i}))}},function(e,t,n){"use strict";var i;!function(e){e[e.LOADING=0]="LOADING",e[e.WELCOME=1]="WELCOME",e[e.LOGIN=2]="LOGIN",e[e.REGISTER=3]="REGISTER",e[e.FORGOT_PASSWORD=4]="FORGOT_PASSWORD",e[e.COMPLETE_SECURITY=5]="COMPLETE_SECURITY",e[e.E2E_SETUP=6]="E2E_SETUP",e[e.LOGGED_IN=7]="LOGGED_IN",e[e.SOFT_LOGOUT=8]="SOFT_LOGOUT"}(i||(i={})),t.a=i},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(88),s=n.n(i);class o{constructor(){s()(this,"watchers",void 0)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return r}));var i=n(216),s=n.n(i);function o(e){if(!e)return"";const t=s.a.parse(e);return t&&"/"===t.path?t.host:e}function r(e){if(!e)return"";let t=e;e.startsWith("https://")||(t="https://"+e);return null===s.a.parse(t).hostname?e:t}},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i,s,o=n(88),r=n.n(o),a=n(87),c=n.n(a),l=n(119),d=n(0),u=n(90),h=n(89),m=n(214),p=n(102),g=n(110),f=n(91),v=n(101);!function(e){e.Passphrase="passphrase",e.RecoveryKey="recovery_key",e.SecretStorage="secret_storage"}(i||(i={})),function(e){e.PreFetch="prefetch",e.Fetch="fetch",e.LoadKeys="load_keys"}(s||(s={}));class b extends c.a.PureComponent{constructor(e){super(e),r()(this,"onCancel",()=>{this.props.onFinished(!1)}),r()(this,"onDone",()=>{this.props.onFinished(!0)}),r()(this,"onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),r()(this,"progressCallback",e=>{this.setState({progress:e})}),r()(this,"onResetRecoveryClick",()=>{this.props.onFinished(!1),Object(m.b)(async()=>{},!0)}),r()(this,"onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyValid:u.a.get().isValidRecoveryKey(e.target.value)})}),r()(this,"onPassPhraseNext",async()=>{this.setState({loading:!0,restoreError:null,restoreType:i.Passphrase});try{const e=await u.a.get().restoreKeyBackupWithPassword(this.state.passPhrase,void 0,void 0,this.state.backupInfo,{progressCallback:this.progressCallback});if(this.props.keyCallback){const e=await u.a.get().keyBackupKeyFromPassword(this.state.passPhrase,this.state.backupInfo);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){d.a.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}),r()(this,"onRecoveryKeyNext",async()=>{if(this.state.recoveryKeyValid){this.setState({loading:!0,restoreError:null,restoreType:i.RecoveryKey});try{const e=await u.a.get().restoreKeyBackupWithRecoveryKey(this.state.recoveryKey,void 0,void 0,this.state.backupInfo,{progressCallback:this.progressCallback});if(this.props.keyCallback){const e=u.a.get().keyBackupKeyFromRecoveryKey(this.state.recoveryKey);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){d.a.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}}),r()(this,"onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value})}),this.state={backupInfo:null,backupKeyStored:null,loading:!1,loadError:null,restoreError:null,recoveryKey:"",recoverInfo:null,recoveryKeyValid:!1,forceRecoveryKey:!1,passPhrase:"",restoreType:null,progress:{stage:s.PreFetch}}}componentDidMount(){this.loadBackupStatus()}async restoreWithSecretStorage(){this.setState({loading:!0,restoreError:null,restoreType:i.SecretStorage});try{await Object(m.b)(async()=>{await u.a.get().restoreKeyBackupWithSecretStorage(this.state.backupInfo,void 0,void 0,{progressCallback:this.progressCallback})}),this.setState({loading:!1})}catch(e){d.a.log("Error restoring backup",e),this.setState({restoreError:e,loading:!1})}}async restoreWithCachedKey(e){if(!e)return!1;try{const t=await u.a.get().restoreKeyBackupWithCache(void 0,void 0,e,{progressCallback:this.progressCallback});return this.setState({recoverInfo:t}),!0}catch(e){return d.a.log("restoreWithCachedKey failed:",e),!1}}async loadBackupStatus(){this.setState({loading:!0,loadError:null});try{const e=u.a.get(),t=await e.getKeyBackupVersion(),n=await e.hasSecretStorageKey()&&await e.isKeyBackupKeyStored();this.setState({backupInfo:t,backupKeyStored:n});if(await this.restoreWithCachedKey(t))return d.a.log("RestoreKeyBackupDialog: found cached backup key"),void this.setState({loading:!1});if(n)return this.restoreWithSecretStorage();this.setState({loadError:null,loading:!1})}catch(e){d.a.log("Error loading backup status",e),this.setState({loadError:e,loading:!1})}}render(){const e=this.state.backupInfo&&this.state.backupInfo.auth_data&&this.state.backupInfo.auth_data.private_key_salt&&this.state.backupInfo.auth_data.private_key_iterations;let t,n;if(this.state.loading){let e;if(n=Object(h.a)("Restoring keys from backup"),this.state.progress.stage===s.Fetch)e=Object(h.a)("Fetching keys from server...");else if(this.state.progress.stage===s.LoadKeys){const{total:t,successes:n,failures:i}=this.state.progress;e=Object(h.a)("%(completed)s of %(total)s keys restored",{total:t,completed:n+i})}else this.state.progress.stage===s.PreFetch&&(e=Object(h.a)("Fetching keys from server..."));t=c.a.createElement("div",null,c.a.createElement("div",null,e),c.a.createElement(p.a,null))}else if(this.state.loadError)n=Object(h.a)("Error"),t=Object(h.a)("Unable to load backup status");else if(this.state.restoreError)this.state.restoreError.errcode===l.c.RESTORE_BACKUP_ERROR_BAD_KEY?this.state.restoreType===i.RecoveryKey?(n=Object(h.a)("Security Key mismatch"),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Key: please verify that you entered the correct Security Key.")))):(n=Object(h.a)("Incorrect Security Phrase"),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Phrase: please verify that you entered the correct Security Phrase.")))):(n=Object(h.a)("Error"),t=Object(h.a)("Unable to restore backup"));else if(null===this.state.backupInfo)n=Object(h.a)("Error"),t=Object(h.a)("No backup found!");else if(this.state.recoverInfo){let e;n=Object(h.a)("Keys restored"),this.state.recoverInfo.total>this.state.recoverInfo.imported&&(e=c.a.createElement("p",null,Object(h.a)("Failed to decrypt %(failedCount)s sessions!",{failedCount:this.state.recoverInfo.total-this.state.recoverInfo.imported}))),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("Successfully restored %(sessionCount)s keys",{sessionCount:this.state.recoverInfo.imported})),e,c.a.createElement(g.a,{primaryButton:Object(h.a)("OK"),onPrimaryButtonClick:this.onDone,hasCancel:!1,focus:!0}))}else if(e&&!this.state.forceRecoveryKey)n=Object(h.a)("Enter Security Phrase"),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("<b>Warning</b>: you should only set up key backup from a trusted computer.",{},{b:e=>c.a.createElement("b",null,e)})),c.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Phrase.")),c.a.createElement("form",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},c.a.createElement("input",{type:"password",className:"mx_RestoreKeyBackupDialog_passPhraseInput",onChange:this.onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0}),c.a.createElement(g.a,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this.onPassPhraseNext,primaryIsSubmit:!0,hasCancel:!0,onCancel:this.onCancel,focus:!1})),Object(h.a)("If you've forgotten your Security Phrase you can <button1>use your Security Key</button1> or <button2>set up new recovery options</button2>",{},{button1:e=>c.a.createElement(f.a,{className:"mx_linkButton",element:"span",onClick:this.onUseRecoveryKeyClick},e),button2:e=>c.a.createElement(f.a,{className:"mx_linkButton",element:"span",onClick:this.onResetRecoveryClick},e)}));else{let e;n=Object(h.a)("Enter Security Key"),e=0===this.state.recoveryKey.length?c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"}):this.state.recoveryKeyValid?c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👍 ",Object(h.a)("This looks like a valid Security Key!")):c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👎 ",Object(h.a)("Not a valid Security Key")),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("<b>Warning</b>: You should only set up key backup from a trusted computer.",{},{b:e=>c.a.createElement("b",null,e)})),c.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Key.")),c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},c.a.createElement("input",{className:"mx_RestoreKeyBackupDialog_recoveryKeyInput",onChange:this.onRecoveryKeyChange,value:this.state.recoveryKey,autoFocus:!0}),e,c.a.createElement(g.a,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this.onRecoveryKeyNext,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})),Object(h.a)("If you've forgotten your Security Key you can <button>set up new recovery options</button>",{},{button:e=>c.a.createElement(f.a,{className:"mx_linkButton",element:"span",onClick:this.onResetRecoveryClick},e)}))}return c.a.createElement(v.a,{className:"mx_RestoreKeyBackupDialog",onFinished:this.props.onFinished,title:n},c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_content"},t))}}r()(b,"defaultProps",{showSummary:!0})},,function(e,t,n){"use strict";async function i(e,t,n){const i=new Promise(i=>{const s=setTimeout(i,n,t);e.then(()=>{clearTimeout(s)})});return Promise.race([e,i])}async function s(e,t,n){let i;for(let s=0;s<t;s++)try{return await e()}catch(e){if(n&&!n(e))throw e;i=e}throw i}n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"c",(function(){return h}));var i=n(282),s=n(113),o=n(202),r=n(97),a=n(90);let c;!function(e){e.AllMessagesLoud="all_messages_loud",e.AllMessages="all_messages",e.MentionsOnly="mentions_only",e.Mute="mute"}(c||(c={}));const l=[c.AllMessages,c.AllMessagesLoud];c.MentionsOnly;function d(e){var t;if(a.a.get().isGuest())return c.AllMessages;if(m(e))return c.Mute;let n=null;try{n=a.a.get().getRoomPushRule("global",e)}catch(e){return null}if(null===(t=n)||void 0===t||!t.enabled)return c.AllMessages;if(g(n))return c.MentionsOnly;return i.a.actionListToActionsObject(n.actions).tweaks.sound?c.AllMessagesLoud:null}function u(e,t){return t===c.Mute?function(e){const t=a.a.get(),n=[],i=t.getRoomPushRule("global",e);i&&n.push(t.deletePushRule("global",o.e.RoomSpecific,i.rule_id));return n.push(t.addPushRule("global",o.e.Override,e,{conditions:[{kind:o.a.EventMatch,key:"room_id",pattern:e}],actions:[o.d.DontNotify]})),Promise.all(n)}(e):function(e,t){const n=a.a.get(),i=[],s=m(e);s&&i.push(n.deletePushRule("global",o.e.Override,s.rule_id));if(t===c.AllMessages){const t=n.getRoomPushRule("global",e);t&&i.push(n.deletePushRule("global",o.e.RoomSpecific,t.rule_id))}else t===c.MentionsOnly?(i.push(n.addPushRule("global",o.e.RoomSpecific,e,{actions:[o.d.DontNotify]})),i.push(n.setPushRuleEnabled("global",o.e.RoomSpecific,e,!0))):t===c.AllMessagesLoud&&(i.push(n.addPushRule("global",o.e.RoomSpecific,e,{actions:[o.d.Notify,{set_tweak:o.g.Sound,value:"default"}]})),i.push(n.setPushRuleEnabled("global",o.e.RoomSpecific,e,!0)));return Promise.all(i)}(e,t)}function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=e.getUnreadNotificationCount(t);const i=e.currentState.getStateEvents(r.b.RoomCreate,"");if(i&&i.getContent().predecessor){const e=i.getContent().predecessor.room_id,t=a.a.get().getRoom(e);t&&(n+=t.getUnreadNotificationCount(s.a.Highlight))}return n}function m(e){var t,n;const i=a.a.get();if(null==i||null===(t=i.pushRules)||void 0===t||null===(n=t.global)||void 0===n||!n.override)return null;for(const t of i.pushRules.global.override)if(t.enabled&&p(e,t)&&g(t))return t;return null}function p(e,t){var n;if(1!==(null===(n=t.conditions)||void 0===n?void 0:n.length))return!1;const i=t.conditions[0];return i.kind===o.a.EventMatch&&"room_id"===i.key&&i.pattern===e}function g(e){return 1===e.actions.length&&e.actions[0]===o.d.DontNotify}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(97),s=n(93);function o(e,t){const n=t?e=>t[e]:t=>s.b.getValue(t,e.getRoomId());if(e.isRedacted()&&!n("showRedactions")&&!e.getThread())return!0;if(e.isRelation(i.d.Replace))return!0;const o=function(e){const t={isMemberEvent:e.getType()===i.b.RoomMember};if(!t.isMemberEvent)return t;const n=e.getContent(),s=e.getPrevContent(),o=n.membership!==s.membership;t.isJoin=o&&"join"===n.membership,t.isPart=o&&"leave"===n.membership&&e.getStateKey()===e.getSender();const r=!o&&"join"===n.membership;return t.isDisplaynameChange=r&&n.displayname!==s.displayname,t.isAvatarChange=r&&n.avatar_url!==s.avatar_url,t}(e);if(o.isMemberEvent){if((o.isJoin||o.isPart)&&!n("showJoinLeaves"))return!0;if(o.isAvatarChange&&!n("showAvatarChanges"))return!0;if(o.isDisplaynameChange&&!n("showDisplaynameChanges"))return!0}return!1}},,,,function(e,t,n){"use strict";n.d(t,"c",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return p}));var i=n(88),s=n.n(i),o=n(1018),r=n(1019);function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const l=new Map,d=new Map,u=e=>l.get(g(e)),h=["people","people","control","nature","foods","places","activity","objects","symbols","flags"],m={people:[],nature:[],foods:[],places:[],activity:[],objects:[],symbols:[],flags:[]},p=o.map(e=>{var t,n;const i=null!==(t=r[e.hexcode])&&void 0!==t?t:[e.label.toLowerCase().replace(/\W+/g,"_")],s=c(c({},e),{},{shortcodes:"string"==typeof i?[i]:i}),o=null!==(n=h[s.group])&&void 0!==n?n:(a=s.unicode,1===Array.from(a).length&&a>="🇦"&&a<="🇿"?"symbols":null);var a;return m.hasOwnProperty(o)&&m[o].push(s),l.set(g(s.unicode),s),s.emoticon&&(Array.isArray(s.emoticon)?s.emoticon.forEach(e=>d.set(e,s)):d.set(s.emoticon,s)),s});function g(e){return e.replace(/[\uFE00-\uFE0F]$/,"")}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(117);const d=["isExpanded","children","onClick","onContextMenu"],u=e=>{let{isExpanded:t,children:n,onClick:i,onContextMenu:o}=e,a=r()(e,d);return c.a.createElement(l.a,s()({},a,{onClick:i,onContextMenu:o||i,"aria-haspopup":!0,"aria-expanded":t,forceHide:t}),n)}},,function(e,t,n){"use strict";var i=n(88),s=n.n(i),o=n(8),r=n.n(o);class a extends r.a{constructor(){super(),s()(this,"roomWidgetEcho",void 0),this.roomWidgetEcho={}}getEchoedRoomWidgets(e,t){const n=[],i=Object.assign({},this.roomWidgetEcho[e]);for(const e of t){const t=e.getStateKey();i[t]&&0===Object.keys(i[t]).length||n.push(e),delete i[t]}return n}roomHasPendingWidgetsOfType(e,t,n){const i=Object.assign({},this.roomWidgetEcho[e]);for(const e of t){delete i[e.getStateKey()]}return void 0===n?Object.keys(i).length>0:Object.values(i).some(e=>n.matches(e.type))}roomHasPendingWidgets(e,t){return this.roomHasPendingWidgetsOfType(e,t)}setRoomWidgetEcho(e,t,n){void 0===this.roomWidgetEcho[e]&&(this.roomWidgetEcho[e]={}),this.roomWidgetEcho[e][t]=n,this.emit("update",e,t)}removeRoomWidgetEcho(e,t){delete this.roomWidgetEcho[e][t],0===Object.keys(this.roomWidgetEcho[e]).length&&delete this.roomWidgetEcho[e],this.emit("update",e,t)}}let c=null;c||(c=new a),t.a=c},function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var i=n(88),s=n.n(i),o=n(8),r=n.n(o),a=n(120),c=n(90),l=n(142),d=n(258);let u;!function(e){e.Persistence="persistence",e.Dock="dock",e.Undock="undock"}(u||(u={}));class h extends r.a{constructor(){super(...arguments),s()(this,"persistentWidgetId",void 0),s()(this,"persistentRoomId",void 0),s()(this,"dockedWidgetsByUid",new Map),s()(this,"onRoomStateEvents",(e,t)=>{let{roomId:n}=t;"im.vector.modular.widgets"===e.getType()&&this.destroyPersistentWidget(e.getStateKey(),n)})}static get instance(){return h.internalInstance||(h.internalInstance=new h),h.internalInstance}start(){c.a.get().on(a.RoomStateEvent.Events,this.onRoomStateEvents)}stop(){var e;null===(e=c.a.get())||void 0===e||e.removeListener(a.RoomStateEvent.Events,this.onRoomStateEvents)}destroyPersistentWidget(e,t){this.getWidgetPersistence(e,t)&&(d.a.instance.stopMessagingByUid(l.a.calcWidgetUid(e,t)),this.setWidgetPersistence(e,t,!1))}setWidgetPersistence(e,t,n){const i=this.getWidgetPersistence(e,t);i&&!n?(this.persistentWidgetId=null,this.persistentRoomId=null):!i&&n&&(this.persistentWidgetId=e,this.persistentRoomId=t),this.emit(u.Persistence)}getWidgetPersistence(e,t){return this.persistentWidgetId===e&&this.persistentRoomId===t}getPersistentWidgetId(){return this.persistentWidgetId}getPersistentRoomId(){return this.persistentRoomId}dockWidget(e,t){var n;const i=l.a.calcWidgetUid(e,t),s=null!==(n=this.dockedWidgetsByUid.get(i))&&void 0!==n?n:0;this.dockedWidgetsByUid.set(i,s+1),0===s&&this.emit(u.Dock)}undockWidget(e,t){const n=l.a.calcWidgetUid(e,t),i=this.dockedWidgetsByUid.get(n);i&&this.dockedWidgetsByUid.set(n,i-1),1===i&&this.emit(u.Undock)}isDocked(e,t){var n;const i=l.a.calcWidgetUid(e,t);return(null!==(n=this.dockedWidgetsByUid.get(i))&&void 0!==n?n:0)>0}isLive(e,t){return this.isDocked(e,t)||this.getWidgetPersistence(e,t)}}s()(h,"internalInstance",void 0),window.mxActiveWidgetStore=h.instance},function(e,t,n){"use strict";n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return f})),n.d(t,"c",(function(){return b}));var i=n(1267),s=n.n(i),o=n(1276),r=n.n(o),a=n(0),c=n(90),l=n(126),d=n(89),u=n(512),h=n(93),m=n(98);async function p(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=e.progressCallback||(()=>{});n(Object(d.a)("Collecting app version information"));let i="UNKNOWN";try{i=await l.a.get().getAppVersion()}catch(e){}let o="UNKNOWN";window.navigator&&window.navigator.userAgent&&(o=window.navigator.userAgent);let r="UNKNOWN";try{r=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}let m="UNKNOWN";try{m=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}const p=c.a.get();a.a.log("Sending bug report.");const g=new FormData;if(g.append("text",e.userText||"User did not supply any additional text."),g.append("app",e.customApp||"element-web"),g.append("version",i),g.append("user_agent",o),g.append("installed_pwa",r),g.append("touch_input",m),e.customFields)for(const t in e.customFields)g.append(t,e.customFields[t]);if(p&&(g.append("user_id",p.credentials.userId),g.append("device_id",p.deviceId),p.isCryptoEnabled())){const e=["ed25519:"+p.getDeviceEd25519Key()];p.getDeviceCurve25519Key&&e.push("curve25519:"+p.getDeviceCurve25519Key()),g.append("device_keys",e.join(", ")),g.append("cross_signing_key",p.getCrossSigningId());const t=p.crypto.crossSigningInfo,n=p.crypto.secretStorage;g.append("cross_signing_ready",String(await p.isCrossSigningReady())),g.append("cross_signing_supported_by_hs",String(await p.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))),g.append("cross_signing_key",t.getId()),g.append("cross_signing_privkey_in_secret_storage",String(!!await t.isStoredInSecretStorage(n)));const i=p.getCrossSigningCacheCallbacks();g.append("cross_signing_master_privkey_cached",String(!(!i||!await i.getCrossSigningKeyCache("master")))),g.append("cross_signing_self_signing_privkey_cached",String(!(!i||!await i.getCrossSigningKeyCache("self_signing")))),g.append("cross_signing_user_signing_privkey_cached",String(!(!i||!await i.getCrossSigningKeyCache("user_signing")))),g.append("secret_storage_ready",String(await p.isSecretStorageReady())),g.append("secret_storage_key_in_account",String(!!await n.hasKey())),g.append("session_backup_key_in_secret_storage",String(!!await p.isKeyBackupKeyStored()));const s=await p.crypto.getSessionBackupPrivateKey();g.append("session_backup_key_cached",String(!!s)),g.append("session_backup_key_well_formed",String(s instanceof Uint8Array))}if(e.labels)for(const t of e.labels)g.append("label",t);const f=h.b.getFeatureSettingNames().filter(e=>h.b.getValue(e));if(f.length&&g.append("enabled_labs",f.join(", ")),h.b.getValue("lowBandwidth")&&g.append("lowBandwidth","enabled"),navigator.storage&&navigator.storage.persisted)try{g.append("storageManager_persisted",String(await navigator.storage.persisted()))}catch(e){}else if(document.hasStorageAccess)try{g.append("storageManager_persisted",String(await document.hasStorageAccess()))}catch(e){}if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate();g.append("storageManager_quota",String(e.quota)),g.append("storageManager_usage",String(e.usage)),e.usageDetails&&Object.keys(e.usageDetails).forEach(t=>{g.append("storageManager_usage_"+t,String(e.usageDetails[t]))})}catch(e){}if(window.Modernizr){const e=Object.keys(window.Modernizr).filter(e=>!1===window.Modernizr[e]);e.length>0&&g.append("modernizr_missing_features",e.join(", "))}if(g.append("mx_local_settings",localStorage.getItem("mx_local_settings")),e.sendLogs){n(Object(d.a)("Collecting logs"));const e=await u.c();for(const n of e){let e=(new TextEncoder).encode(n.lines);t&&(e=s.a.gzip(e)),g.append("compressed-log",new Blob([e]),n.id)}}return g}async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)throw new Error("No bug report endpoint has been set.");const n=t.progressCallback||(()=>{}),i=await p(t);return n(Object(d.a)("Uploading logs")),y(e,i,n)}async function f(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=e.progressCallback||(()=>{}),n=await p(e,!1);t(Object(d.a)("Downloading logs"));let i="";const s=new r.a;let o=0;for(const[e,t]of n.entries())"compressed-log"===e?await new Promise(e=>{const n=new FileReader;n.addEventListener("loadend",t=>{s.append(`log-${o++}.log`,(new TextDecoder).decode(t.target.result)),e()}),n.readAsArrayBuffer(t)}):i+=`${e} = ${t}\n`;s.append("issue.txt",i);const a=document.createElement("a");a.href="data:application/octet-stream;base64,"+btoa(v(s.out)),a.download="rageshake.tar",document.body.appendChild(a),a.click(),document.body.removeChild(a)}function v(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return t}async function b(e,t,n){var i;let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},r="UNKNOWN";try{r=await l.a.get().getAppVersion()}catch(e){}const a=new FormData;a.append("label",t),a.append("text",n),a.append("can_contact",s?"yes":"no"),a.append("app","element-web"),a.append("version",r),a.append("platform",l.a.get().getHumanReadableName()),a.append("user_id",null===(i=c.a.get())||void 0===i?void 0:i.getUserId());for(const e in o)a.append(e,JSON.stringify(o[e]));await y(m.b.get().bug_report_endpoint_url,a,()=>{})}function y(e,t,n){return new Promise((i,s)=>{const o=new XMLHttpRequest;o.open("POST",e),o.responseType="json",o.timeout=3e5,o.onreadystatechange=function(){if(o.readyState===XMLHttpRequest.LOADING)n(Object(d.a)("Waiting for response from server"));else if(o.readyState===XMLHttpRequest.DONE){if(o.status<200||o.status>=400)return void s(new Error("HTTP "+o.status));i(o.response.report_url||"")}},o.send(t)})}},,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return k})),n.d(t,"a",(function(){return T})),n.d(t,"f",(function(){return N})),n.d(t,"g",(function(){return P})),n.d(t,"e",(function(){return D})),n.d(t,"c",(function(){return A}));var i=n(87),s=n.n(i),o=n(94),r=n.n(o),a=n(7),c=n(97),l=n(0),d=n(89),u=n(101),h=n(263),m=n(300),p=n(131),g=n(130),f=n(238),v=n(91),b=n(176),y=n(135),S=n(132),E=n(141),w=n(100),_=n(405),C=n(529),O=n(276),R=n(259),I=n(701);const k=e=>{let{room:t,checked:n,onChange:i}=e;return s.a.createElement("label",{className:"mx_AddExistingToSpace_entry"},null!=t&&t.isSpaceRoom()?s.a.createElement(g.a,{room:t,height:32,width:32}):s.a.createElement(O.a,{room:t,avatarSize:32}),s.a.createElement("span",{className:"mx_AddExistingToSpace_entry_name"},t.name),s.a.createElement(E.b,{onChange:i?e=>i(e.target.checked):null,checked:n,disabled:!i}))},x=function(e,t){let{scrollTop:n,height:i}=e,s=0;for(var o=arguments.length,r=new Array(o>2?o-2:0),a=2;a<o;a++)r[a-2]=arguments[a];r.forEach(e=>{s+=39+44*e});const c=n,l=c+i,d=s+15,u=d+44*t,h=Math.max(c,d),m=Math.min(l,u);return{scrollTop:Math.max(0,n-d),height:Math.max(0,m-h)}},T=e=>{let{space:t,footerPrompt:o,emptySelectionButton:r,filterPlaceholder:c,roomsRenderer:u,dmsRenderer:h,spacesRenderer:g,onFinished:f}=e;const E=Object(i.useContext)(w.a),O=Object(i.useMemo)(()=>E.getVisibleRooms().filter(e=>"join"===e.getMyMembership()),[E]),I=Object(i.useRef)(),[k,T]=Object(i.useState)({scrollTop:0,height:600}),[j,N]=Object(i.useState)(new Set),[P,D]=Object(i.useState)(null),[A,M]=Object(i.useState)(null),[U,L]=Object(i.useState)(""),F=U.toLowerCase().trim(),B=Object(i.useMemo)(()=>new Set(p.a.instance.getChildSpaces(t.roomId)),[t]),K=Object(i.useMemo)(()=>new Set(p.a.instance.getChildRooms(t.roomId)),[t]),[V,W,H]=Object(i.useMemo)(()=>{let e=O;if(F){e=new R.a(O,{keys:["name"],funcs:[e=>[e.getCanonicalAlias(),...e.getAltAliases()].filter(Boolean)],shouldMatchWordsOnly:!1}).match(F)}const n=t.getJoinRule();return Object(_.b)(e).reduce((e,i)=>(i.isSpaceRoom()?i===t||B.has(i)||e[0].push(i):K.has(i)||(y.a.shared().getUserIdForRoomId(i.roomId)?"public"!==n&&e[2].push(i):e[1].push(i)),e),[[],[],[]])},[O,t,F,K,B]),q=async()=>{let e;M(null),D(0);for(const n of j){const i=Object(S.b)(n);try{await p.a.instance.addRoomToSpace(t,n.roomId,i).catch(async e=>{if("M_LIMIT_EXCEEDED"===e.errcode)return await Object(a.G)(e.data.retry_after_ms),p.a.instance.addRoomToSpace(t,n.roomId,i);throw e}),D(e=>e+1)}catch(t){l.a.error("Failed to add rooms to space",t),M(e=t);break}}e||f(!0)},$=null!==P;let G;if(A)G=s.a.createElement(s.a.Fragment,null,s.a.createElement("img",{src:n(530).default,height:"24",width:"24",alt:""}),s.a.createElement("span",{className:"mx_AddExistingToSpaceDialog_error"},s.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_errorHeading"},Object(d.a)("Not all selected were added")),s.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_errorCaption"},Object(d.a)("Try again"))),s.a.createElement(v.a,{className:"mx_AddExistingToSpaceDialog_retryButton",onClick:q},Object(d.a)("Retry")));else if($)G=s.a.createElement("span",null,s.a.createElement(C.a,{value:P,max:j.size}),s.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_progressText"},Object(d.a)("Adding rooms... (%(progress)s out of %(count)s)",{count:j.size,progress:P})));else{let e=r;(!e||j.size>0)&&(e=s.a.createElement(v.a,{kind:"primary",disabled:j.size<1,onClick:q},Object(d.a)("Add"))),G=s.a.createElement(s.a.Fragment,null,s.a.createElement("span",null,o),e)}const z=$||A?null:(e,t)=>{e?j.add(t):j.delete(t),N(new Set(j))},J=!g||h||u?0:V.length,Y=u?W.length:0,Q=h?H.length:0;let X=!0;(J>0||Y>0||Q>0)&&(X=!1);const Z=x(k,Y),ee=x(k,J,Y),te=x(k,Q,J,Y);return s.a.createElement("div",{className:"mx_AddExistingToSpace"},s.a.createElement(m.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:c,onSearch:L,autoFocus:!0}),s.a.createElement(b.a,{className:"mx_AddExistingToSpace_content",onScroll:()=>{var e;const t=null===(e=I.current)||void 0===e?void 0:e.containerRef.current;T({scrollTop:t.scrollTop,height:t.clientHeight})},wrappedRef:e=>{T({scrollTop:e.scrollTop,height:e.clientHeight})},ref:I},W.length>0&&u?u(W,j,Z,z):void 0,V.length>0&&g?g(V,j,ee,z):null,H.length>0&&h?h(H,j,te,z):null,X?s.a.createElement("span",{className:"mx_AddExistingToSpace_noResults"},Object(d.a)("No results")):void 0),s.a.createElement("div",{className:"mx_AddExistingToSpace_footer"},G))},j=e=>(t,n,i,o)=>{let{scrollTop:r,height:a}=i;return s.a.createElement("div",{className:"mx_AddExistingToSpace_section"},s.a.createElement("h3",null,Object(d.a)(e)),s.a.createElement(I.a,{itemHeight:44,items:t,scrollTop:r,height:a,renderItem:e=>s.a.createElement(k,{key:e.roomId,room:e,checked:n.has(e),onChange:o?t=>{o(t,e)}:null})}))},N=j(Object(d.c)("Rooms")),P=j(Object(d.c)("Spaces")),D=j(Object(d.c)("Direct Messages")),A=e=>{let{title:t,space:n,value:o,onChange:a}=e;const l=Object(i.useMemo)(()=>[n,...p.a.instance.getChildSpaces(n.roomId).filter(e=>e.currentState.maySendStateEvent(c.b.SpaceChild,e.client.credentials.userId))],[n]);let u;return u=l.length>1?s.a.createElement(h.a,{id:"mx_SpaceSelectDropdown",className:"mx_SpaceSelectDropdown",onOptionChange:e=>{a(l.find(t=>t.roomId===e)||n)},value:o.roomId,label:Object(d.a)("Space selection")},l.map(e=>{const t=r()({mx_SubspaceSelector_dropdownOptionActive:e===o});return s.a.createElement("div",{key:e.roomId,className:t},s.a.createElement(g.a,{room:e,width:24,height:24}),e.name||Object(f.b)(e)||e.roomId)})):s.a.createElement("div",{className:"mx_SubspaceSelector_onlySpace"},n.name||Object(f.b)(n)||n.roomId),s.a.createElement("div",{className:"mx_SubspaceSelector"},s.a.createElement(g.a,{room:o,height:40,width:40}),s.a.createElement("div",null,s.a.createElement("h1",null,t),u))};t.d=e=>{let{space:t,onCreateRoomClick:n,onAddSubspaceClick:o,onFinished:r}=e;const[a,c]=Object(i.useState)(t);return s.a.createElement(u.a,{title:s.a.createElement(A,{title:Object(d.a)("Add existing rooms"),space:t,value:a,onChange:c}),className:"mx_AddExistingToSpaceDialog",contentId:"mx_AddExistingToSpace",onFinished:r,fixedWidth:!1},s.a.createElement(w.a.Provider,{value:t.client},s.a.createElement(T,{space:t,onFinished:r,footerPrompt:s.a.createElement(s.a.Fragment,null,s.a.createElement("div",null,Object(d.a)("Want to add a new room instead?")),s.a.createElement(v.a,{kind:"link",onClick:e=>{n(e),r()}},Object(d.a)("Create a new room"))),filterPlaceholder:Object(d.a)("Search for rooms"),roomsRenderer:N,spacesRenderer:()=>s.a.createElement("div",{className:"mx_AddExistingToSpace_section"},s.a.createElement("h3",null,Object(d.a)("Spaces")),s.a.createElement(v.a,{kind:"link",onClick:()=>{o(),r()}},Object(d.a)("Adding spaces has moved."))),dmsRenderer:D})))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(87);const s=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const[t,n]=Object(i.useState)(e),s=()=>{n(!t)};return[t,s,n]}},function(e,t,n){"use strict";n.r(t),n.d(t,"containsEmoji",(function(){return i}));const i=(e,t)=>t.some(t=>e.body&&e.body.includes(t))},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(88),s=n.n(i);class o{constructor(e,t){this.fn=e,this.onMarkCallback=t,s()(this,"marked",!1)}reset(){this.marked=!1}mark(){var e;this.marked||null===(e=this.onMarkCallback)||void 0===e||e.call(this),this.marked=!0}trigger(){this.marked&&(this.reset(),this.fn())}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return v})),n.d(t,"a",(function(){return y}));var i=n(88),s=n.n(i),o=n(111),r=n(120),a=n(237),c=n(244),l=n(0),d=n(92),u=n(167),h=n(121),m=n(222);function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const f=(e,t)=>e.beaconInfoOwner===t;let v;!function(e){e.LivenessChange="OwnBeaconStore.LivenessChange",e.MonitoringLivePosition="OwnBeaconStore.MonitoringLivePosition",e.LocationPublishError="LocationPublishError",e.BeaconUpdateError="BeaconUpdateError"}(v||(v={}));const b=()=>{let e;try{var t;if(e=JSON.parse(null!==(t=window.localStorage.getItem("mx_live_beacon_created_id"))&&void 0!==t?t:"[]"),!Array.isArray(e))throw new Error("Invalid stored value")}catch(t){l.a.error("Failed to retrieve locally created beacon event ids",t),e=[]}return e};class y extends u.a{constructor(){super(d.a),s()(this,"beacons",new Map),s()(this,"beaconsByRoomId",new Map),s()(this,"beaconLocationPublishErrorCounts",new Map),s()(this,"beaconUpdateErrors",new Map),s()(this,"liveBeaconIds",[]),s()(this,"locationInterval",void 0),s()(this,"geolocationError",void 0),s()(this,"clearPositionWatch",void 0),s()(this,"lastPublishedPositionTimestamp",void 0),s()(this,"hasLiveBeacons",e=>!!this.getLiveBeaconIds(e).length),s()(this,"hasLocationPublishErrors",e=>this.getLiveBeaconIds(e).some(this.beaconHasLocationPublishError)),s()(this,"beaconHasLocationPublishError",e=>this.beaconLocationPublishErrorCounts.get(e)>=2),s()(this,"resetLocationPublishError",e=>{this.incrementBeaconLocationPublishErrorCount(e,!1),this.publishCurrentLocationToBeacons()}),s()(this,"getLiveBeaconIds",e=>e?this.liveBeaconIds.filter(t=>{var n;return null===(n=this.beaconsByRoomId.get(e))||void 0===n?void 0:n.has(t)}):this.liveBeaconIds),s()(this,"getLiveBeaconIdsWithLocationPublishError",e=>this.getLiveBeaconIds(e).filter(this.beaconHasLocationPublishError)),s()(this,"getBeaconById",e=>this.beacons.get(e)),s()(this,"stopBeacon",async e=>{var t;const n=this.beacons.get(e);null!=n&&null!==(t=n.beaconInfo)&&void 0!==t&&t.live&&(await this.updateBeaconEvent(n,{live:!1}),(e=>{const t=b();window.localStorage.setItem("mx_live_beacon_created_id",JSON.stringify(t.filter(t=>t!==e)))})(n.beaconInfoId))}),s()(this,"onNewBeacon",(e,t)=>{f(t,this.matrixClient.getUserId())&&(this.addBeacon(t),this.checkLiveness())}),s()(this,"onUpdateBeacon",(e,t)=>{f(t,this.matrixClient.getUserId())&&(this.checkLiveness(),t.monitorLiveness())}),s()(this,"onDestroyBeacon",e=>{this.beacons.has(e)&&this.checkLiveness()}),s()(this,"onBeaconLiveness",(e,t)=>{this.beacons.has(t.identifier)&&(e||this.stopBeacon(t.identifier),this.checkLiveness(),this.emit(v.LivenessChange,this.getLiveBeaconIds()))}),s()(this,"onRoomStateMembers",(e,t,n)=>{var i;this.beaconsByRoomId.has(t.roomId)&&n.userId===this.matrixClient.getUserId()&&("leave"!==n.membership&&"ban"!==n.membership||(null===(i=this.beaconsByRoomId.get(t.roomId))||void 0===i||i.forEach(this.removeBeacon),this.beaconsByRoomId.delete(t.roomId)))}),s()(this,"initialiseBeaconState",()=>{const e=this.matrixClient.getUserId();this.matrixClient.getVisibleRooms().forEach(t=>{[...t.currentState.beacons.values()].filter(t=>f(t,e)).forEach(e=>this.addBeacon(e))}),this.checkLiveness()}),s()(this,"addBeacon",e=>{this.beacons.set(e.identifier,e),this.beaconsByRoomId.has(e.roomId)||this.beaconsByRoomId.set(e.roomId,new Set),this.beaconsByRoomId.get(e.roomId).add(e.identifier),e.monitorLiveness()}),s()(this,"removeBeacon",e=>{this.beacons.has(e)&&(this.beacons.get(e).destroy(),this.beacons.delete(e),this.checkLiveness())}),s()(this,"checkLiveness",()=>{const e=b(),t=this.getLiveBeaconIds();this.liveBeaconIds=[...this.beacons.values()].filter(t=>t.isLive&&e.includes(t.beaconInfoId)).sort(m.h).map(e=>e.identifier);const n=Object(h.a)(t,this.liveBeaconIds);(n.added.length||n.removed.length)&&this.emit(v.LivenessChange,this.liveBeaconIds),n.added.length&&this.isMonitoringLiveLocation&&this.publishCurrentLocationToBeacons(),!(null==t||!t.length)!=!!this.liveBeaconIds.length&&this.togglePollingLocation()}),s()(this,"createLiveBeacon",async(e,t)=>{const{event_id:n}=await this.matrixClient.unstable_createLiveBeacon(e,t);(e=>{const t=b();window.localStorage.setItem("mx_live_beacon_created_id",JSON.stringify([...t,e]))})(n)}),s()(this,"togglePollingLocation",()=>{this.liveBeaconIds.length?this.startPollingLocation():this.stopPollingLocation()}),s()(this,"startPollingLocation",async()=>{this.stopPollingLocation();try{this.clearPositionWatch=Object(m.k)(this.onWatchedPosition,this.onGeolocationError)}catch(e){return void this.onGeolocationError(null==e?void 0:e.message)}this.locationInterval=setInterval(()=>{this.lastPublishedPositionTimestamp&&this.lastPublishedPositionTimestamp<=Date.now()-3e4&&this.publishCurrentLocationToBeacons()},3e4),this.emit(v.MonitoringLivePosition)}),s()(this,"stopPollingLocation",()=>{clearInterval(this.locationInterval),this.locationInterval=void 0,this.lastPublishedPositionTimestamp=void 0,this.geolocationError=void 0,this.clearPositionWatch&&(this.clearPositionWatch(),this.clearPositionWatch=void 0),this.emit(v.MonitoringLivePosition)}),s()(this,"onWatchedPosition",e=>{const t=Object(m.g)(e);this.lastPublishedPositionTimestamp?this.debouncedPublishLocationToBeacons(t):this.publishLocationToBeacons(t)}),s()(this,"onGeolocationError",async e=>{this.geolocationError=e,l.a.error("Geolocation failed",this.geolocationError),[m.a.Unavailable,m.a.PermissionDenied].includes(e)&&(this.stopPollingLocation(),await Promise.all(this.liveBeaconIds.map(this.stopBeacon)))}),s()(this,"publishCurrentLocationToBeacons",async()=>{try{const e=await Object(m.e)();this.publishLocationToBeacons(Object(m.g)(e))}catch(e){this.onGeolocationError(null==e?void 0:e.message)}}),s()(this,"updateBeaconEvent",async(e,t)=>{const{description:n,timeout:i,timestamp:s,live:o,assetType:r}=g(g({},e.beaconInfo),t),c=Object(a.makeBeaconInfoContent)(i,o,n,r,s);try{await this.matrixClient.unstable_setLiveBeacon(e.roomId,c);this.beaconUpdateErrors.has(e.identifier)&&(this.beaconUpdateErrors.delete(e.identifier),this.emit(v.BeaconUpdateError,e.identifier,!1))}catch(t){throw l.a.error("Failed to update beacon",t),this.beaconUpdateErrors.set(e.identifier,t),this.emit(v.BeaconUpdateError,e.identifier,!0),t}}),s()(this,"publishLocationToBeacons",async e=>{this.lastPublishedPositionTimestamp=Date.now(),await Promise.all(this.healthyLiveBeaconIds.map(t=>this.sendLocationToBeacon(this.beacons.get(t),e)))}),s()(this,"debouncedPublishLocationToBeacons",Object(o.debounce)(this.publishLocationToBeacons,2e3)),s()(this,"sendLocationToBeacon",async(e,t)=>{let{geoUri:n,timestamp:i}=t;const s=Object(a.makeBeaconContent)(n,i,e.beaconInfoId);try{await this.matrixClient.sendEvent(e.roomId,c.a.name,s),this.incrementBeaconLocationPublishErrorCount(e.identifier,!1)}catch(t){l.a.error(t),this.incrementBeaconLocationPublishErrorCount(e.identifier,!0)}}),s()(this,"incrementBeaconLocationPublishErrorCount",(e,t)=>{const n=this.beaconHasLocationPublishError(e);var i;t?this.beaconLocationPublishErrorCounts.set(e,(null!==(i=this.beaconLocationPublishErrorCounts.get(e))&&void 0!==i?i:0)+1):this.beaconLocationPublishErrorCounts.delete(e);this.beaconHasLocationPublishError(e)!==n&&this.emit(v.LocationPublishError,e)})}static get instance(){return y.internalInstance}get isMonitoringLiveLocation(){return!!this.clearPositionWatch}async onNotReady(){this.matrixClient.removeListener(r.BeaconEvent.LivenessChange,this.onBeaconLiveness),this.matrixClient.removeListener(r.BeaconEvent.New,this.onNewBeacon),this.matrixClient.removeListener(r.BeaconEvent.Update,this.onUpdateBeacon),this.matrixClient.removeListener(r.BeaconEvent.Destroy,this.onDestroyBeacon),this.matrixClient.removeListener(r.RoomStateEvent.Members,this.onRoomStateMembers),this.beacons.forEach(e=>e.destroy()),this.stopPollingLocation(),this.beacons.clear(),this.beaconsByRoomId.clear(),this.liveBeaconIds=[],this.beaconLocationPublishErrorCounts.clear(),this.beaconUpdateErrors.clear()}async onReady(){this.matrixClient.on(r.BeaconEvent.LivenessChange,this.onBeaconLiveness),this.matrixClient.on(r.BeaconEvent.New,this.onNewBeacon),this.matrixClient.on(r.BeaconEvent.Update,this.onUpdateBeacon),this.matrixClient.on(r.BeaconEvent.Destroy,this.onDestroyBeacon),this.matrixClient.on(r.RoomStateEvent.Members,this.onRoomStateMembers),this.initialiseBeaconState()}async onAction(e){}get healthyLiveBeaconIds(){return this.liveBeaconIds.filter(e=>!this.beaconHasLocationPublishError(e)&&!this.beaconUpdateErrors.has(e))}}s()(y,"internalInstance",new y)},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}));var i=n(87),s=n.n(i),o=n(89);function r(e,t,n,i){let r=n[e];void 0===r&&(r=n[""]);const a=e=>t?s.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e):e;return r.includes("<a>")?Object(o.a)(r,{},Object.assign({a:a},i)):Object(o.a)(r,{},i)}function a(e){if("M_RESOURCE_LIMIT_EXCEEDED"===e.errcode){const t=r(e.data.limit_type,e.data.admin_contact,{monthly_active_user:Object(o.c)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(o.c)("This homeserver has been blocked by its administrator."),"":Object(o.c)("This homeserver has exceeded one of its resource limits.")}),n=r(e.data.limit_type,e.data.admin_contact,{"":Object(o.c)("Please <a>contact your service administrator</a> to continue using the service.")});return s.a.createElement("div",null,s.a.createElement("div",null,t),s.a.createElement("div",null,n))}return s.a.createElement("div",null,Object(o.a)("Unable to connect to Homeserver. Retrying..."))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(168),r=n(190);class a extends r.a{constructor(e,t,n){super(),this._symbol=e,this._count=t,this._color=n}static forCount(e,t){return new a(null,e,t)}static forSymbol(e,t){return new a(e,0,t)}}s()(a,"RED_EXCLAMATION",a.forSymbol("!",o.a.Red))},function(e,t,n){"use strict";var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(94),d=n.n(l);const u=["legend","className","children","description"];t.a=e=>{let{legend:t,className:n,children:i,description:o}=e,a=r()(e,u);return c.a.createElement("fieldset",s()({},a,{className:d()("mx_SettingsFieldset",n)}),c.a.createElement("legend",{className:"mx_SettingsFieldset_legend"},t),o&&c.a.createElement("div",{className:"mx_SettingsFieldset_description"},o),i)}},,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return ce})),n.d(t,"a",(function(){return le})),n.d(t,"c",(function(){return de}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(113),c=n(306),l=n(89),d=n(795),u=n(797),h=n(90),m=n(105),p=n(128),g=n(91),f=n(799),v=n(248);function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?b(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class S extends r.a.Component{constructor(e){super(e),s()(this,"avatarUpload",Object(o.createRef)()),s()(this,"uploadAvatar",()=>{this.avatarUpload.current.click()}),s()(this,"removeAvatar",()=>{this.avatarUpload.current.value="",this.setState({avatarUrl:null,avatarFile:null,profileFieldsTouched:y(y({},this.state.profileFieldsTouched),{},{avatar:!0})})}),s()(this,"isSaveEnabled",()=>Boolean(Object.values(this.state.profileFieldsTouched).length)),s()(this,"cancelProfileChanges",async e=>{e.stopPropagation(),e.preventDefault(),this.isSaveEnabled()&&this.setState({profileFieldsTouched:{},displayName:this.state.originalDisplayName,topic:this.state.originalTopic,avatarUrl:this.state.originalAvatarUrl,avatarFile:null})}),s()(this,"saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.isSaveEnabled())return;this.setState({profileFieldsTouched:{}});const t=h.a.get(),n={},i=this.state.displayName.trim();if(this.state.originalDisplayName!==this.state.displayName&&(await t.setRoomName(this.props.roomId,i),n.originalDisplayName=i,n.displayName=i),this.state.avatarFile){const e=await t.uploadContent(this.state.avatarFile);await t.sendStateEvent(this.props.roomId,"m.room.avatar",{url:e},""),n.avatarUrl=Object(p.b)(e).getSquareThumbnailHttp(96),n.originalAvatarUrl=n.avatarUrl,n.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.sendStateEvent(this.props.roomId,"m.room.avatar",{},"");this.state.originalTopic!==this.state.topic&&(await t.setRoomTopic(this.props.roomId,this.state.topic),n.originalTopic=this.state.topic),this.setState(n)}),s()(this,"onDisplayNameChanged",e=>{this.setState({displayName:e.target.value}),this.state.originalDisplayName===e.target.value?this.setState({profileFieldsTouched:y(y({},this.state.profileFieldsTouched),{},{name:!1})}):this.setState({profileFieldsTouched:y(y({},this.state.profileFieldsTouched),{},{name:!0})})}),s()(this,"onTopicChanged",e=>{this.setState({topic:e.target.value}),this.state.originalTopic===e.target.value?this.setState({profileFieldsTouched:y(y({},this.state.profileFieldsTouched),{},{topic:!1})}):this.setState({profileFieldsTouched:y(y({},this.state.profileFieldsTouched),{},{topic:!0})})}),s()(this,"onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,profileFieldsTouched:y(y({},this.state.profileFieldsTouched),{},{avatar:!1})});const t=e.target.files[0],n=new FileReader;n.onload=e=>{this.setState({avatarUrl:String(e.target.result),avatarFile:t,profileFieldsTouched:y(y({},this.state.profileFieldsTouched),{},{avatar:!0})})},n.readAsDataURL(t)});const t=h.a.get(),n=t.getRoom(e.roomId);if(!n)throw new Error("Expected a room for ID: "+e.roomId);const i=n.currentState.getStateEvents("m.room.avatar","");let r=i&&i.getContent()?i.getContent().url:null;r&&(r=Object(p.b)(r).getSquareThumbnailHttp(96));const a=n.currentState.getStateEvents("m.room.topic",""),c=a&&a.getContent()?a.getContent().topic:"",l=n.currentState.getStateEvents("m.room.name",""),d=l&&l.getContent()?l.getContent().name:"";this.state={originalDisplayName:d,displayName:d,originalAvatarUrl:r,avatarUrl:r,avatarFile:null,originalTopic:c,topic:c,profileFieldsTouched:{},canSetName:n.currentState.maySendStateEvent("m.room.name",t.getUserId()),canSetTopic:n.currentState.maySendStateEvent("m.room.topic",t.getUserId()),canSetAvatar:n.currentState.maySendStateEvent("m.room.avatar",t.getUserId())}}render(){let e;return(this.state.canSetName||this.state.canSetTopic||this.state.canSetAvatar)&&(e=r.a.createElement("div",{className:"mx_ProfileSettings_buttons"},r.a.createElement(g.a,{onClick:this.cancelProfileChanges,kind:"link",disabled:!this.isSaveEnabled()},Object(l.a)("Cancel")),r.a.createElement(g.a,{onClick:this.saveProfile,kind:"primary",disabled:!this.isSaveEnabled()},Object(l.a)("Save")))),r.a.createElement("form",{onSubmit:this.saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings_profileForm"},r.a.createElement("input",{type:"file",ref:this.avatarUpload,className:"mx_ProfileSettings_avatarUpload",onClick:v.a,onChange:this.onAvatarChanged,accept:"image/*"}),r.a.createElement("div",{className:"mx_ProfileSettings_profile"},r.a.createElement("div",{className:"mx_ProfileSettings_controls"},r.a.createElement(m.a,{label:Object(l.a)("Room Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onDisplayNameChanged,disabled:!this.state.canSetName}),r.a.createElement(m.a,{className:"mx_ProfileSettings_controls_topic",id:"profileTopic",label:Object(l.a)("Room Topic"),disabled:!this.state.canSetTopic,type:"text",value:this.state.topic,autoComplete:"off",onChange:this.onTopicChanged,element:"textarea"})),r.a.createElement(f.a,{avatarUrl:this.state.avatarUrl,avatarName:this.state.displayName||this.props.roomId,avatarAltText:Object(l.a)("Room avatar"),uploadAvatar:this.state.canSetAvatar?this.uploadAvatar:void 0,removeAvatar:this.state.canSetAvatar?this.removeAvatar:void 0})),e)}}var E=n(92),w=n(100),_=n(93),C=n(122),O=n(96),R=n(104),I=n(191),k=n(350);class x extends r.a.Component{constructor(){super(...arguments),s()(this,"onClickUserSettings",e=>{e.preventDefault(),e.stopPropagation(),E.a.fire(O.a.ViewUserSettings)})}render(){const e=this.props.room.roomId,t=h.a.get().isRoomEncrypted(e);let n=null,i=null;if(t)n=Object(l.a)("In encrypted rooms, like this one, URL previews are disabled by default to ensure that your homeserver (where the previews are generated) cannot gather information about links you see in this room.");else{if(n=_.b.getValueAt(R.a.ACCOUNT,"urlPreviewsEnabled")?Object(l.a)("You have <a>enabled</a> URL previews by default.",{},{a:e=>r.a.createElement(g.a,{kind:"link_inline",onClick:this.onClickUserSettings},e)}):Object(l.a)("You have <a>disabled</a> URL previews by default.",{},{a:e=>r.a.createElement(g.a,{kind:"link_inline",onClick:this.onClickUserSettings},e)}),_.b.canSetValue("urlPreviewsEnabled",e,R.a.ROOM))i=r.a.createElement("label",null,r.a.createElement(I.a,{name:"urlPreviewsEnabled",level:R.a.ROOM,roomId:e,isExplicit:!0}));else{let t=Object(l.c)("URL previews are enabled by default for participants in this room.");_.b.getValueAt(R.a.ROOM,"urlPreviewsEnabled",e,!0)||(t=Object(l.c)("URL previews are disabled by default for participants in this room.")),i=r.a.createElement("label",null,Object(l.a)(t))}}const s=r.a.createElement(I.a,{name:t?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled",level:R.a.ROOM_ACCOUNT,roomId:e}),o=r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,Object(l.a)("When someone puts a URL in their message, a URL preview can be shown to give more information about that link such as the title, description, and an image from the website.")),r.a.createElement("p",null,n));return r.a.createElement(k.a,{legend:Object(l.a)("URL Previews"),description:o},i,r.a.createElement("label",null,s))}}var T=n(847),j=n(127);class N extends r.a.Component{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"onLeaveClick",e=>{E.a.dispatch({action:"leave_room",room_id:this.props.roomId}),j.b.trackInteraction("WebRoomSettingsLeaveButton",e)}),this.state={isRoomPublished:!1}}render(){const e=this.context,t=e.getRoom(this.props.roomId),n=t.currentState.mayClientSendStateEvent("m.room.canonical_alias",e),i=t.currentState.getStateEvents("m.room.canonical_alias",""),s=_.b.getValue(C.b.URLPreviews)?r.a.createElement(x,{room:t}):null;let o;return"join"===t.getMyMembership()&&(o=r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Leave room")),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement(g.a,{kind:"danger",onClick:this.onLeaveClick},Object(l.a)("Leave room"))))),r.a.createElement("div",{className:"mx_SettingsTab mx_GeneralRoomSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("General")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralRoomSettingsTab_profileSection"},r.a.createElement(S,{roomId:this.props.roomId})),r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Room Addresses")),r.a.createElement(T.a,{roomId:this.props.roomId,canSetCanonicalAlias:n,canSetAliases:!0,canonicalAliasEvent:i}),r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Other")),s,o)}}s()(N,"contextType",w.a);var P=n(125),D=n(116),A=n(97),M=n(0),U=n(195),L=n(95),F=n(115),B=n(302),K=n(183),V=n(523),W=n(853),H=n(107),q=n(801);class $ extends r.a.Component{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"onStateEvent",e=>{[A.b.RoomJoinRules,A.b.RoomGuestAccess,A.b.RoomHistoryVisibility,A.b.RoomEncryption].includes(e.getType())&&this.forceUpdate()}),s()(this,"onEncryptionChange",async()=>{var e;if((null===(e=this.context.getRoom(this.props.roomId))||void 0===e?void 0:e.getJoinRule())===P.c.Public){const e=L.a.createTrackedDialog("Confirm Public Encrypted Room","",F.a,{title:Object(l.a)("Are you sure you want to add encryption to this public room?"),description:r.a.createElement("div",null,r.a.createElement("p",null," ",Object(l.a)("<b>It's not recommended to add encryption to public rooms.</b>Anyone can find and join public rooms, so anyone can read messages in them. You'll get none of the benefits of encryption, and you won't be able to turn it off later. Encrypting messages in a public room will make receiving and sending messages slower.",null,{b:e=>r.a.createElement("b",null,e)})," "),r.a.createElement("p",null," ",Object(l.a)("To avoid these issues, create a <a>new encrypted room</a> for the conversation you plan to have.",null,{a:t=>r.a.createElement(g.a,{kind:"link_inline",onClick:()=>{e.close(),this.createNewRoom(!1,!0)}}," ",t," ")})," "))}),{finished:t}=e,[n]=await t;if(!n)return}L.a.createTrackedDialog("Enable encryption","",F.a,{title:Object(l.a)("Enable encryption?"),description:Object(l.a)("Once enabled, encryption for a room cannot be disabled. Messages sent in an encrypted room cannot be seen by the server, only by the participants of the room. Enabling encryption may prevent many bots and bridges from working correctly. <a>Learn more about encryption.</a>",{},{a:e=>r.a.createElement(q.a,{href:"https://element.io/help#encryption"},e)}),onFinished:e=>{if(!e)return void this.setState({encrypted:!1});const t=this.state.encrypted;this.setState({encrypted:!0}),this.context.sendStateEvent(this.props.roomId,A.b.RoomEncryption,{algorithm:"m.megolm.v1.aes-sha2"}).catch(e=>{M.a.error(e),this.setState({encrypted:t})})}})}),s()(this,"onGuestAccessChange",e=>{const t=e?P.a.CanJoin:P.a.Forbidden,n=this.state.guestAccess;n!==t&&(this.setState({guestAccess:t}),this.context.sendStateEvent(this.props.roomId,A.b.RoomGuestAccess,{guest_access:t},"").catch(e=>{M.a.error(e),this.setState({guestAccess:n})}))}),s()(this,"createNewRoom",async(e,t)=>{const n=L.a.createTrackedDialog("Create Room","Create room after trying to make an E2EE room public",V.a,{defaultPublic:e,defaultEncrypted:t});j.b.trackInteraction("WebRoomSettingsSecurityTabCreateNewRoomButton");const[i,s]=await n.finished;return i&&await Object(K.b)(s),i}),s()(this,"onHistoryRadioToggle",e=>{const t=this.state.history;t!==e&&(this.setState({history:e}),this.context.sendStateEvent(this.props.roomId,A.b.RoomHistoryVisibility,{history_visibility:e},"").catch(e=>{M.a.error(e),this.setState({history:t})}))}),s()(this,"updateBlacklistDevicesFlag",e=>{this.context.getRoom(this.props.roomId).setBlacklistUnverifiedDevices(e)}),s()(this,"onJoinRuleChangeError",e=>{var t;L.a.createTrackedDialog("Room not found","",H.a,{title:Object(l.a)("Failed to update the join rules"),description:null!==(t=e.message)&&void 0!==t?t:Object(l.a)("Unknown failure")})}),s()(this,"onBeforeJoinRuleChange",async e=>{if(this.state.encrypted&&e===P.c.Public){const e=L.a.createTrackedDialog("Confirm Public Encrypted Room","",F.a,{title:Object(l.a)("Are you sure you want to make this encrypted room public?"),description:r.a.createElement("div",null,r.a.createElement("p",null," ",Object(l.a)("<b>It's not recommended to make encrypted rooms public.</b> It will mean anyone can find and join the room, so anyone can read messages. You'll get none of the benefits of encryption. Encrypting messages in a public room will make receiving and sending messages slower.",null,{b:e=>r.a.createElement("b",null,e)})," "),r.a.createElement("p",null," ",Object(l.a)("To avoid these issues, create a <a>new public room</a> for the conversation you plan to have.",null,{a:t=>r.a.createElement(g.a,{kind:"link_inline",onClick:()=>{e.close(),this.createNewRoom(!0,!1)}}," ",t," ")})," "))}),{finished:t}=e,[n]=await t;if(!n)return!1}return!0}),s()(this,"toggleAdvancedSection",()=>{this.setState({showAdvancedSection:!this.state.showAdvancedSection})});const n=t.getRoom(this.props.roomId).currentState;this.state={guestAccess:this.pullContentPropertyFromEvent(n.getStateEvents(A.b.RoomGuestAccess,""),"guest_access",P.a.Forbidden),history:this.pullContentPropertyFromEvent(n.getStateEvents(A.b.RoomHistoryVisibility,""),"history_visibility",P.b.Shared),hasAliases:!1,encrypted:t.isRoomEncrypted(this.props.roomId),showAdvancedSection:!1}}componentDidMount(){this.context.on(D.b.Events,this.onStateEvent),this.hasAliases().then(e=>this.setState({hasAliases:e}))}pullContentPropertyFromEvent(e,t,n){return(null==e?void 0:e.getContent()[t])||n}componentWillUnmount(){this.context.removeListener(D.b.Events,this.onStateEvent)}async hasAliases(){const e=this.context,t=(await e.getLocalAliases(this.props.roomId)).aliases;return Array.isArray(t)&&0!==t.length}renderJoinRule(){const e=this.context.getRoom(this.props.roomId);let t=null;e.getJoinRule()!==P.c.Public||this.state.hasAliases||(t=r.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_warning"},r.a.createElement("img",{src:n(304).default,width:15,height:15}),r.a.createElement("span",null,Object(l.a)("To link to this room, please add an address."))));const i=Object(l.a)("Decide who can join %(roomName)s.",{roomName:null==e?void 0:e.name});return r.a.createElement(k.a,{legend:Object(l.a)("Access"),description:i},r.a.createElement(W.a,{room:e,beforeChange:this.onBeforeJoinRuleChange,onError:this.onJoinRuleChangeError,closeSettingsFn:this.props.closeSettingsFn,promptUpgrade:!0,aliasWarning:t}))}renderHistory(){if(!_.b.getValue(C.b.RoomHistorySettings))return null;const e=this.context,t=this.state.history,n=e.getRoom(this.props.roomId).currentState.mayClientSendStateEvent(A.b.RoomHistoryVisibility,e),i=[{value:P.b.Shared,label:Object(l.a)("Members only (since the point in time of selecting this option)")},{value:P.b.Invited,label:Object(l.a)("Members only (since they were invited)")},{value:P.b.Joined,label:Object(l.a)("Members only (since they joined)")}];this.state.encrypted&&t!==P.b.WorldReadable||i.unshift({value:P.b.WorldReadable,label:Object(l.a)("Anyone")});const s=Object(l.a)("Changes to who can read history will only apply to future messages in this room. The visibility of existing history will be unchanged.");return r.a.createElement(k.a,{legend:Object(l.a)("Who can read history?"),description:s},r.a.createElement(B.a,{name:"historyVis",value:t,onChange:this.onHistoryRadioToggle,disabled:!n,definitions:i}))}renderAdvanced(){const e=this.context,t=this.state.guestAccess,n=e.getRoom(this.props.roomId).currentState.mayClientSendStateEvent(A.b.RoomGuestAccess,e);return r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement(U.a,{value:t===P.a.CanJoin,onChange:this.onGuestAccessChange,disabled:!n,label:Object(l.a)("Enable guest access")}),r.a.createElement("p",null,Object(l.a)("People with supported clients will be able to join the room without having a registered account.")))}render(){const e=this.context,t=e.getRoom(this.props.roomId),n=this.state.encrypted,i=t.currentState.mayClientSendStateEvent(A.b.RoomEncryption,e),s=!n&&i;let o=null;n&&_.b.isEnabled("blacklistUnverifiedDevices")&&(o=r.a.createElement(I.a,{name:"blacklistUnverifiedDevices",level:R.a.ROOM_DEVICE,onChange:this.updateBlacklistDevicesFlag,roomId:this.props.roomId}));const a=this.renderHistory();let c;return t.getJoinRule()===P.c.Public&&(c=r.a.createElement(r.a.Fragment,null,r.a.createElement(g.a,{onClick:this.toggleAdvancedSection,kind:"link",className:"mx_SettingsTab_showAdvanced"},this.state.showAdvancedSection?Object(l.a)("Hide advanced"):Object(l.a)("Show advanced")),this.state.showAdvancedSection&&this.renderAdvanced())),r.a.createElement("div",{className:"mx_SettingsTab mx_SecurityRoomSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Security & Privacy")),r.a.createElement(k.a,{legend:Object(l.a)("Encryption"),description:Object(l.a)("Once enabled, encryption cannot be disabled.")},r.a.createElement(U.a,{value:n,onChange:this.onEncryptionChange,label:Object(l.a)("Encrypted"),disabled:!s}),o),this.renderJoinRule(),c,a)}}s()($,"contextType",w.a);var G=n(286),z=n(576),J=n(326),Y=n(155);class Q extends r.a.Component{constructor(e,t){super(e,t),s()(this,"roomProps",void 0),s()(this,"soundUpload",Object(o.createRef)()),s()(this,"context",void 0),s()(this,"triggerUploader",async e=>{e.stopPropagation(),e.preventDefault(),this.soundUpload.current.click()}),s()(this,"onSoundUploadChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({uploadedFile:null});const t=e.target.files[0];this.setState({uploadedFile:t})}),s()(this,"onClickSaveSound",async e=>{e.stopPropagation(),e.preventDefault();try{await this.saveSound()}catch(e){M.a.error("Unable to save notification sound for "+this.props.roomId),M.a.error(e)}}),s()(this,"clearSound",e=>{e.stopPropagation(),e.preventDefault(),_.b.setValue("notificationSound",this.props.roomId,R.a.ROOM_ACCOUNT,null),this.setState({currentSound:"default"})}),s()(this,"onRoomNotificationChange",e=>{this.roomProps.notificationVolume=e,this.forceUpdate()}),s()(this,"onOpenSettingsClick",()=>{this.props.closeSettingsFn(),E.a.dispatch({action:O.a.ViewUserSettings,initialTabId:Y.a.Notifications})}),this.roomProps=z.a.forRoom(t.getRoom(this.props.roomId)),this.state={currentSound:"default",uploadedFile:null}}UNSAFE_componentWillMount(){const e=G.default.getSoundForRoom(this.props.roomId);e&&this.setState({currentSound:e.name||e.url})}async saveSound(){if(!this.state.uploadedFile)return;let e=this.state.uploadedFile.type;"video/ogg"===e&&(e="audio/ogg");const t=await h.a.get().uploadContent(this.state.uploadedFile,{type:e});await _.b.setValue("notificationSound",this.props.roomId,R.a.ROOM_ACCOUNT,{name:this.state.uploadedFile.name,type:e,size:this.state.uploadedFile.size,url:t}),this.setState({uploadedFile:null,currentSound:this.state.uploadedFile.name})}render(){let e=null;return this.state.uploadedFile&&(e=r.a.createElement("div",null,r.a.createElement("span",null,Object(l.a)("Uploaded sound"),": ",r.a.createElement("code",null,this.state.uploadedFile.name)))),r.a.createElement("div",{className:"mx_SettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Notifications")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_NotificationSettingsTab_notificationsSection"},r.a.createElement(B.a,{name:"roomNotificationSetting",definitions:[{value:J.a.AllMessages,className:"mx_NotificationSettingsTab_defaultEntry",label:r.a.createElement(r.a.Fragment,null,Object(l.a)("Default"),r.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(l.a)("Get notifications as set up in your <a>settings</a>",{},{a:e=>r.a.createElement(g.a,{kind:"link",onClick:this.onOpenSettingsClick},e)})))},{value:J.a.AllMessagesLoud,className:"mx_NotificationSettingsTab_allMessagesEntry",label:r.a.createElement(r.a.Fragment,null,Object(l.a)("All messages"),r.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(l.a)("Get notified for every message")))},{value:J.a.MentionsOnly,className:"mx_NotificationSettingsTab_mentionsKeywordsEntry",label:r.a.createElement(r.a.Fragment,null,Object(l.a)("@mentions & keywords"),r.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(l.a)("Get notified only with mentions and keywords as set up in your <a>settings</a>",{},{a:e=>r.a.createElement(g.a,{kind:"link",onClick:this.onOpenSettingsClick},e)})))},{value:J.a.Mute,className:"mx_NotificationSettingsTab_noneEntry",label:r.a.createElement(r.a.Fragment,null,Object(l.a)("Off"),r.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(l.a)("You won't get any notifications")))}],onChange:this.onRoomNotificationChange,value:this.roomProps.notificationVolume})),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Sounds")),r.a.createElement("div",null,r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("span",null,Object(l.a)("Notification sound"),": ",r.a.createElement("code",null,this.state.currentSound))),r.a.createElement(g.a,{className:"mx_NotificationSound_resetSound",disabled:"default"==this.state.currentSound,onClick:this.clearSound,kind:"primary"},Object(l.a)("Reset"))),r.a.createElement("div",null,r.a.createElement("h3",null,Object(l.a)("Set a new custom sound")),r.a.createElement("div",{className:"mx_SettingsFlag"},r.a.createElement("form",{autoComplete:"off",noValidate:!0},r.a.createElement("input",{ref:this.soundUpload,className:"mx_NotificationSound_soundUpload",type:"file",onClick:v.a,onChange:this.onSoundUploadChanged,accept:"audio/*"})),e),r.a.createElement(g.a,{className:"mx_NotificationSound_browse",onClick:this.triggerUploader,kind:"primary"},Object(l.a)("Browse")),r.a.createElement(g.a,{className:"mx_NotificationSound_save",disabled:null==this.state.uploadedFile,onClick:this.onClickSaveSound,kind:"primary"},Object(l.a)("Save")),r.a.createElement("br",null))))}}s()(Q,"contextType",w.a);var X=n(163),Z=n.n(X),ee=n(489),te=n(132),ne=n(148),ie=n(158);class se extends r.a.PureComponent{render(){var e,t;const n=this.props.ev.getContent();if(null===(e=n.channel)||void 0===e||!e.id||null===(t=n.protocol)||void 0===t||!t.id)return M.a.warn(`Bridge info event ${this.props.ev.getId()} has missing content. Tile will not render`),null;n.bridgebot||(M.a.warn(`Bridge info event ${this.props.ev.getId()} does not provide a 'bridgebot' key whichis deprecated behaviour. Using sender for now.`),n.bridgebot=this.props.ev.getSender());const{channel:i,network:s,protocol:o}=n,a=o.displayname||o.id,c=i.displayname||i.id;let d=null;n.creator&&(d=r.a.createElement("li",null,Object(l.a)("This bridge was provisioned by <user />.",{},{user:()=>r.a.createElement(ee.b,{type:ee.a.UserMention,room:this.props.room,url:Object(te.g)(n.creator),shouldShowPillAvatar:_.b.getValue("Pill.shouldShowPillAvatar")})})));const u=r.a.createElement("li",null,Object(l.a)("This bridge is managed by <user />.",{},{user:()=>r.a.createElement(ee.b,{type:ee.a.UserMention,room:this.props.room,url:Object(te.g)(n.bridgebot),shouldShowPillAvatar:_.b.getValue("Pill.shouldShowPillAvatar")})}));let h;if(o.avatar_url){const e=Object(p.b)(o.avatar_url).getSquareThumbnailHttp(64);h=r.a.createElement(ne.a,{className:"mx_RoomSettingsDialog_protocolIcon",width:48,height:48,resizeMethod:"crop",name:a,idName:a,url:e})}else h=r.a.createElement("div",{className:"mx_RoomSettingsDialog_noProtocolIcon"});let m=null;if(s){const e=s.displayname||s.id;let t=r.a.createElement("span",null,e);"string"==typeof s.external_url&&Object(ie.e)(s.external_url)&&(t=r.a.createElement("a",{href:s.external_url,target:"_blank",rel:"noreferrer noopener"},e)),m=Object(l.a)("Workspace: <networkLink/>",{},{networkLink:()=>t})}let g=r.a.createElement("span",null,c);"string"==typeof i.external_url&&Object(ie.e)(i.external_url)&&(g=r.a.createElement("a",{href:i.external_url,target:"_blank",rel:"noreferrer noopener"},c));const f=this.props.ev.getId();return r.a.createElement("li",{key:f,className:"mx_RoomSettingsDialog_BridgeList_listItem"},r.a.createElement("div",{className:"mx_RoomSettingsDialog_column_icon"},h),r.a.createElement("div",{className:"mx_RoomSettingsDialog_column_data"},r.a.createElement("h3",{className:"mx_RoomSettingsDialog_column_data_protocolName"},a),r.a.createElement("p",{className:"mx_RoomSettingsDialog_column_data_details mx_RoomSettingsDialog_workspace_channel_details"},m,r.a.createElement("span",{className:"mx_RoomSettingsDialog_channel"},Object(l.a)("Channel: <channelLink/>",{},{channelLink:()=>g}))),r.a.createElement("ul",{className:"mx_RoomSettingsDialog_column_data_metadata mx_RoomSettingsDialog_metadata"},d," ",u)))}}s()(se,"propTypes",{ev:Z.a.object.isRequired,room:Z.a.object.isRequired});const oe=["uk.half-shot.bridge"];class re extends r.a.Component{renderBridgeCard(e,t){const n=e.getContent();return n&&n.channel&&n.protocol?r.a.createElement(se,{key:e.getId(),room:t,ev:e}):null}static getBridgeStateEvents(e){const t=h.a.get().getRoom(e).currentState;return oe.map(e=>t.getStateEvents(e)).flat(1)}render(){const e=re.getBridgeStateEvents(this.props.roomId),t=h.a.get().getRoom(this.props.roomId);let n;return n=e.length>0?r.a.createElement("div",null,r.a.createElement("p",null,Object(l.a)("This room is bridging messages to the following platforms. <a>Learn more.</a>",{},{a:e=>r.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),r.a.createElement("ul",{className:"mx_RoomSettingsDialog_BridgeList"},e.map(e=>this.renderBridgeCard(e,t)))):r.a.createElement("p",null,Object(l.a)("This room isn't bridging messages to any platforms. <a>Learn more.</a>",{},{a:e=>r.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),r.a.createElement("div",{className:"mx_SettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Bridges")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},n))}}var ae=n(101);const ce="ROOM_SECURITY_TAB",le="ROOM_NOTIFICATIONS_TAB";class de extends r.a.Component{constructor(e){super(e),s()(this,"dispatcherRef",void 0),s()(this,"onAction",e=>{e.action===O.a.ViewHomePage&&this.props.onFinished(!0)}),s()(this,"onRoomName",()=>{this.setState({roomName:h.a.get().getRoom(this.props.roomId).name})}),this.state={roomName:""}}componentDidMount(){this.dispatcherRef=E.a.register(this.onAction),h.a.get().on(a.c.Name,this.onRoomName),this.onRoomName()}componentWillUnmount(){this.dispatcherRef&&E.a.unregister(this.dispatcherRef),h.a.get().removeListener(a.c.Name,this.onRoomName)}getTabs(){const e=[];return e.push(new c.a("ROOM_GENERAL_TAB",Object(l.c)("General"),"mx_RoomSettingsDialog_settingsIcon",r.a.createElement(N,{roomId:this.props.roomId}),"RoomSettingsGeneral")),e.push(new c.a(ce,Object(l.c)("Security & Privacy"),"mx_RoomSettingsDialog_securityIcon",r.a.createElement($,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}),"RoomSettingsSecurityPrivacy")),e.push(new c.a("ROOM_ROLES_TAB",Object(l.c)("Roles & Permissions"),"mx_RoomSettingsDialog_rolesIcon",r.a.createElement(u.a,{roomId:this.props.roomId}),"RoomSettingsRolesPermissions")),e.push(new c.a(le,Object(l.c)("Notifications"),"mx_RoomSettingsDialog_notificationsIcon",r.a.createElement(Q,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}),"RoomSettingsNotifications")),_.b.getValue("feature_bridge_state")&&e.push(new c.a("ROOM_BRIDGES_TAB",Object(l.c)("Bridges"),"mx_RoomSettingsDialog_bridgesIcon",r.a.createElement(re,{roomId:this.props.roomId}),"RoomSettingsBridges")),_.b.getValue(C.b.AdvancedSettings)&&e.push(new c.a("ROOM_ADVANCED_TAB",Object(l.c)("Advanced"),"mx_RoomSettingsDialog_warningIcon",r.a.createElement(d.a,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}),"RoomSettingsAdvanced")),e}render(){const e=this.state.roomName;return r.a.createElement(ae.a,{className:"mx_RoomSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Room Settings - %(roomName)s",{roomName:e})},r.a.createElement("div",{className:"mx_SettingsDialog_content"},r.a.createElement(c.c,{tabs:this.getTabs(),initialTabId:this.props.initialTabId,screenName:"RoomSettings"})))}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return R})),n.d(t,"a",(function(){return I})),n.d(t,"b",(function(){return k})),n.d(t,"d",(function(){return x}));var i=n(88),s=n.n(i),o=n(1367),r=n(1368),a=n(178),c=n(8),l=n.n(c),d=n(0),u=n(267),h=n(400);const m=new h.a;class p{constructor(){}static for(e,t){if(!e||!t)throw new Error("An instance and key must be supplied");return new g(e,t)}static forgetAllFor(e){m.delete(e)}static forgetAll(){for(const e of m.keys())m.remove(e)}}s()(p,"Void",Symbol("void"));class g{constructor(e,t){this.instance=e,this.key=t}forget(){const e=m.get(this.instance);e&&(e.remove(this.key),e.size||m.remove(this.instance))}do(e){const t=m.getOrCreate(this.instance,new h.a);let n=t.get(this.key);return void 0===n&&(n=e(),t.set(this.key,n)),n}}let f;!function(e){e.Timekeep="timekeep",e.AmplitudeMark="amplitude_mark"}(f||(f={}));var v=n(123),b=n(239),y=n(776),S=n(277),E=n(121);class w{constructor(e,t){this.width=e,s()(this,"samples",[]),this.samples=Object(E.h)(t,this.width)}get value(){return this.samples}pushValue(e){let t=Object(E.b)(this.samples);t.splice(0,0,e),t.length>this.width&&(t=t.slice(0,this.width)),this.samples=t}}var _=n(250),C=n(1371),O=n.n(C);const R=48e3,I=44;let k;!function(e){e.Started="started",e.EndingSoon="ending_soon",e.Ended="ended",e.Uploading="uploading",e.Uploaded="uploaded"}(k||(k={}));class x extends l.a{constructor(e){super(),this.client=e,s()(this,"recorder",void 0),s()(this,"recorderContext",void 0),s()(this,"recorderSource",void 0),s()(this,"recorderStream",void 0),s()(this,"recorderWorklet",void 0),s()(this,"recorderProcessor",void 0),s()(this,"buffer",new Uint8Array(0)),s()(this,"lastUpload",void 0),s()(this,"recording",!1),s()(this,"observable",void 0),s()(this,"amplitudes",[]),s()(this,"playback",void 0),s()(this,"liveWaveform",new w(I,0)),s()(this,"onAudioProcess",e=>{this.processAudioUpdate(e.playbackTime)}),s()(this,"processAudioUpdate",e=>{if(!this.recording)return;this.observable.update({waveform:this.liveWaveform.value.map(e=>Object(_.a)(e,0,1)),timeSeconds:e});const t=120-this.recorder.encodedSamplePosition/48e3;t<0?this.stop():t<=10&&p.for(this,"ending_soon").do(()=>(this.emit(k.EndingSoon,{secondsLeft:t}),p.Void))})}get contentType(){return"audio/ogg"}get contentLength(){return this.buffer.length}get durationSeconds(){if(!this.recorder)throw new Error("Duration not available without a recording");return this.recorderContext.currentTime}get isRecording(){return this.recording}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n),super.emit(v.b,e,...n),!0}async makeRecorder(){try{this.recorderStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,noiseSuppression:!0,deviceId:u.c.getAudioInput()}}),this.recorderContext=Object(y.a)({}),this.recorderSource=this.recorderContext.createMediaStreamSource(this.recorderStream),this.recorderContext.audioWorklet?(await this.recorderContext.audioWorklet.addModule(O.a),this.recorderWorklet=new AudioWorkletNode(this.recorderContext,"mx-voice-worklet"),this.recorderSource.connect(this.recorderWorklet),this.recorderWorklet.connect(this.recorderContext.destination),this.recorderWorklet.port.onmessage=e=>{switch(e.data.ev){case f.Timekeep:this.processAudioUpdate(e.data.timeSeconds);break;case f.AmplitudeMark:e.data.forIndex===this.amplitudes.length&&(this.amplitudes.push(e.data.amplitude),this.liveWaveform.pushValue(e.data.amplitude))}}):(this.recorderProcessor=this.recorderContext.createScriptProcessor(1024,1,1),this.recorderSource.connect(this.recorderProcessor),this.recorderProcessor.connect(this.recorderContext.destination),this.recorderProcessor.addEventListener("audioprocess",this.onAudioProcess)),this.recorder=new o({encoderPath:r.a,encoderSampleRate:R,encoderApplication:2048,streamPages:!0,encoderFrameSize:20,numberOfChannels:1,sourceNode:this.recorderSource,encoderBitRate:24e3,encoderComplexity:3,resampleQuality:3}),this.recorder.ondataavailable=e=>{const t=new Uint8Array(e),n=new Uint8Array(this.buffer.length+t.length);n.set(this.buffer,0),n.set(t,this.buffer.length),this.buffer=n}}catch(e){throw d.a.error("Error starting recording: ",e),e instanceof DOMException&&d.a.error(`${e.name} (${e.code}): ${e.message}`),this.recorderStream&&this.recorderStream.getTracks().forEach(e=>e.stop()),this.recorderSource&&this.recorderSource.disconnect(),this.recorder&&this.recorder.close(),this.recorderContext&&this.recorderContext.close(),e}}get audioBuffer(){return this.buffer.slice(0)}get liveData(){if(!this.recording)throw new Error("No observable when not recording");return this.observable}get isSupported(){return!!o.isRecordingSupported()}get hasRecording(){return this.buffer.length>0}async start(){if(this.lastUpload||this.hasRecording)throw new Error("Recording already prepared");if(this.recording)throw new Error("Recording already in progress");this.observable&&this.observable.close(),this.observable=new a.SimpleObservable,await this.makeRecorder(),await this.recorder.start(),this.recording=!0,this.emit(k.Started)}async stop(){return p.for(this,"stop").do(async()=>{if(!this.recording)throw new Error("No recording to stop");return await this.recorder.stop(),this.recorderSource.disconnect(),this.recorderWorklet&&this.recorderWorklet.disconnect(),this.recorderProcessor&&(this.recorderProcessor.disconnect(),this.recorderProcessor.removeEventListener("audioprocess",this.onAudioProcess)),await this.recorderContext.close(),this.recorderStream.getTracks().forEach(e=>e.stop()),this.recording=!1,await this.recorder.close(),this.emit(k.Ended),this.audioBuffer})}getPlayback(){return this.playback=p.for(this,"playback").do(()=>new b.c(this.audioBuffer.buffer,this.amplitudes)),this.playback}destroy(){var e;this.stop(),this.removeAllListeners(),p.forgetAllFor(this),null===(e=this.playback)||void 0===e||e.destroy(),this.observable.close()}async upload(e){if(!this.hasRecording)throw new Error("No recording available to upload");if(this.lastUpload)return this.lastUpload;try{this.emit(k.Uploading);const{url:t,file:n}=await Object(S.b)(this.client,e,new Blob([this.audioBuffer],{type:this.contentType}));this.lastUpload={mxc:t,encrypted:n},this.emit(k.Uploaded)}catch(e){throw this.emit(k.Ended),e}return this.lastUpload}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return w})),n.d(t,"e",(function(){return _})),n.d(t,"d",(function(){return C})),n.d(t,"b",(function(){return O})),n.d(t,"c",(function(){return R}));var i=n(385),s=n(958),o=n.n(s),r=n(959),a=n.n(r),c=n(151),l=n(632),d=n(132),u=n(92),h=n(96),m=n(87),p=n(95),g=n(115),f=n(89),v=n(98);let b;function y(e){let{scanner:t,parser:n,utils:i,token:s,name:o}=e;const{DOT:r,NUM:a,TLD:c,COLON:l,SYM:d,HYPHEN:u,UNDERSCORE:h,LOCALHOST:m,domain:p}=t.tokens,g=n.start,f=i.createTokenClass(o,{isLink:!0}),v=[p,c,m,d,h,u],b=[p,c,m,u],y=g.tt(s),S=y.tt(p);for(const e of v)y.tt(e,S),S.tt(e,S);const E=S.tt(r);for(const e of v)E.tt(e,S);const w=S.tt(l),_=w.tt(p);_.tt(r,w);for(const e of b)_.tt(e,_),_.tt(e,f);for(const e of b)w.tt(e,_);_.tt(l).tt(a,f)}function S(e,t){e.preventDefault();const n=new c.a(null,t);n&&u.a.dispatch({action:h.a.ViewUser,member:n})}function E(e,t){e.preventDefault(),function(e){var t;const n=null!==(t=v.b.get().spaces_learn_more_url)&&void 0!==t?t:v.a.spaces_learn_more_url;p.a.createTrackedDialog("Groups are now Spaces","",g.a,{title:Object(f.a)("That link is no longer supported"),description:m.createElement(m.Fragment,null,m.createElement("p",null,Object(f.a)("You're trying to access a community link (%(groupId)s).<br/>Communities are no longer supported and have been replaced by spaces.<br2/><a>Learn more about spaces here.</a>",{groupId:e},{br:()=>m.createElement("br",null),br2:()=>m.createElement("br",null),a:e=>m.createElement("a",{href:n,rel:"noreferrer noopener",target:"_blank"},e)}))),hasCancelButton:!1})}(t)}!function(e){e.URL="url",e.UserId="userid",e.RoomAlias="roomalias",e.GroupId="groupid"}(b||(b={}));const w="^(?:vector://|https?://)?(?:"+((window.location.host+window.location.pathname).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"|(?:www\\.)?(?:riot|vector)\\.im/(?:app|beta|staging|develop)/|(?:app|beta|staging|develop)\\.element\\.io/)(#.*)");l.a;const _={events:function(e,t){switch(t){case b.URL:try{const t=Object(d.h)(e);if(null!=t&&t.userId)return{click:function(e){S(e,t.userId)}};{const t=Object(d.j)(e);if(t!==e)return{click:function(e){e.preventDefault(),window.location.hash=t}}}}catch(e){}break;case b.UserId:return{click:function(t){S(t,Object(d.h)(e).userId)}};case b.RoomAlias:return{click:function(t){const n=Object(d.h)(e).roomIdOrAlias;var i;i=n,t.preventDefault(),u.a.dispatch({action:h.a.ViewRoom,room_alias:i,metricsTrigger:"Timeline",metricsViaKeyboard:!1})}};case b.GroupId:return{click:function(t){E(t,Object(d.h)(e).groupId)}}}},formatHref:function(e,t){switch(t){case b.RoomAlias:case b.UserId:case b.GroupId:default:return Object(d.i)(e)}},attributes:{rel:"noreferrer noopener"},ignoreTags:["pre","code"],className:"linkified",target:function(e,t){if(t===b.URL)try{return Object(d.j)(e)!==e||decodeURIComponent(e).match(w)?null:"_blank"}catch(e){}return null}};Object(i.registerPlugin)(b.RoomAlias,e=>{let{scanner:t,parser:n,utils:i}=e;y({scanner:t,parser:n,utils:i,token:t.tokens.POUND,name:b.RoomAlias})}),Object(i.registerPlugin)(b.GroupId,e=>{let{scanner:t,parser:n,utils:i}=e;y({scanner:t,parser:n,utils:i,token:t.tokens.PLUS,name:b.GroupId})}),Object(i.registerPlugin)(b.UserId,e=>{let{scanner:t,parser:n,utils:i}=e;y({scanner:t,parser:n,utils:i,token:t.tokens.AT,name:b.UserId})}),Object(i.registerCustomProtocol)("matrix",!0);const C=i,O=o.a,R=a.a},function(e,t,n){"use strict";n.d(t,"a",(function(){return x}));var i=n(99),s=n.n(i),o=n(88),r=n.n(o),a=n(87),c=n.n(a),l=n(376),d=n.n(l),u=n(89),h=n(117),m=n(136),p=n(334),g=n(584),f=n(112),v=n(709),b=n(93),y=n(133),S=n(92),E=n(96);function w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function _(e){let t,n,i;return 1===e.deltaMode?(t=18*e.deltaX,n=18*e.deltaY,i=18*e.deltaZ):(t=e.deltaX,n=e.deltaY,i=e.deltaZ),new WheelEvent("syntheticWheel",function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?w(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({deltaMode:0,deltaY:n,deltaX:t,deltaZ:i},e))}var C=n(147),O=n(109),R=n(114),I=n(399);const k=()=>{const e=getComputedStyle(document.documentElement).getPropertyValue("--image-view-panel-height");return parseInt(e.slice(0,e.length-2))};class x extends c.a.Component{constructor(e){var t,n;super(e),r()(this,"contextMenuButton",Object(a.createRef)()),r()(this,"focusLock",Object(a.createRef)()),r()(this,"imageWrapper",Object(a.createRef)()),r()(this,"image",Object(a.createRef)()),r()(this,"initX",0),r()(this,"initY",0),r()(this,"previousX",0),r()(this,"previousY",0),r()(this,"animatingLoading",!1),r()(this,"imageIsLoaded",!1),r()(this,"imageLoaded",()=>{const{thumbnailInfo:e}=this.props;null!=e&&e.width&&this.setState({zoom:e.width/this.image.current.naturalWidth}),this.imageIsLoaded=!0,this.animatingLoading=!0,this.setZoomAndRotation(),this.setState({translationX:0,translationY:0}),this.animatingLoading=!1}),r()(this,"recalculateZoom",()=>{this.setZoomAndRotation()}),r()(this,"setZoomAndRotation",e=>{const t=this.image.current,n=this.imageWrapper.current,i=null!=e?e:this.state.rotation,s=i%180==0,o=s?t.naturalWidth:t.naturalHeight,r=s?t.naturalHeight:t.naturalWidth,a=n.clientWidth/o,c=n.clientHeight/r;if(a>=1&&c>=1)return void this.setState({zoom:1,minZoom:1,maxZoom:1,rotation:i});const l=.95*Math.min(a,c),d=this.state.zoom<=this.state.minZoom?l:this.state.zoom;this.setState({minZoom:l,maxZoom:1,rotation:i,zoom:d})}),r()(this,"onWheel",e=>{if(e.target===this.image.current){e.stopPropagation(),e.preventDefault();const{deltaY:t}=_(e);this.zoomDelta(.0025*-t,e.offsetX,e.offsetY)}}),r()(this,"onZoomInClick",()=>{this.zoomDelta(.1)}),r()(this,"onZoomOutClick",()=>{this.zoomDelta(-.1)}),r()(this,"onKeyDown",e=>{switch(Object(R.a)().getAccessibilityAction(e)){case O.h.Escape:e.stopPropagation(),e.preventDefault(),this.props.onFinished()}}),r()(this,"onRotateCounterClockwiseClick",()=>{const e=this.state.rotation;this.setZoomAndRotation(e-90)}),r()(this,"onRotateClockwiseClick",()=>{const e=this.state.rotation;this.setZoomAndRotation(e+90)}),r()(this,"onDownloadClick",()=>{const e=document.createElement("a");e.href=this.props.src,e.download=this.props.name,e.target="_blank",e.rel="noreferrer noopener",e.click()}),r()(this,"onOpenContextMenu",()=>{this.setState({contextMenuDisplayed:!0})}),r()(this,"onCloseContextMenu",()=>{this.setState({contextMenuDisplayed:!1})}),r()(this,"onPermalinkClicked",e=>{e.preventDefault(),S.a.dispatch({action:E.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}),this.props.onFinished()}),r()(this,"onStartMoving",e=>{e.stopPropagation(),e.preventDefault(),0===e.button&&(this.state.zoom!==this.state.minZoom?(this.setState({moving:!0}),this.previousX=this.state.translationX,this.previousY=this.state.translationY,this.initX=e.pageX-this.state.translationX,this.initY=e.pageY-this.state.translationY):this.zoom(this.state.maxZoom,e.nativeEvent.offsetX,e.nativeEvent.offsetY))}),r()(this,"onMoving",e=>{e.stopPropagation(),e.preventDefault(),this.state.moving&&this.setState({translationX:e.pageX-this.initX,translationY:e.pageY-this.initY})}),r()(this,"onEndMoving",()=>{!0===this.state.moving&&Math.abs(this.state.translationX-this.previousX)<10&&Math.abs(this.state.translationY-this.previousY)<10&&(this.zoom(this.state.minZoom),this.initX=0,this.initY=0),this.setState({moving:!1})});const{thumbnailInfo:i}=this.props;this.state={zoom:0,minZoom:.95,maxZoom:.95,rotation:0,translationX:null!==(t=(null==i?void 0:i.positionX)+(null==i?void 0:i.width)/2-C.b.instance.windowWidth/2)&&void 0!==t?t:0,translationY:null!==(n=(null==i?void 0:i.positionY)+(null==i?void 0:i.height)/2-C.b.instance.windowHeight/2-k()/2)&&void 0!==n?n:0,moving:!1,contextMenuDisplayed:!1}}componentDidMount(){this.focusLock.current.addEventListener("wheel",this.onWheel,{passive:!1}),window.addEventListener("resize",this.recalculateZoom),this.image.current.addEventListener("load",this.imageLoaded)}componentWillUnmount(){this.focusLock.current.removeEventListener("wheel",this.onWheel),window.removeEventListener("resize",this.recalculateZoom),this.image.current.removeEventListener("load",this.imageLoaded)}zoomDelta(e,t,n){this.zoom(this.state.zoom+e,t,n)}zoom(e,t,n){const i=this.state.zoom,s=Math.min(e,this.state.maxZoom);if(s<=this.state.minZoom)this.setState({zoom:this.state.minZoom,translationX:0,translationY:0});else if("number"!=typeof t&&"number"!=typeof n)this.setState({zoom:s,translationX:this.state.translationX*s/i,translationY:this.state.translationY*s/i});else{let e,o;switch((this.state.rotation%360+360)%360){case 0:e=this.image.current.clientWidth/2-t,o=this.image.current.clientHeight/2-n;break;case 90:e=n-this.image.current.clientHeight/2,o=this.image.current.clientWidth/2-t;break;case 180:e=t-this.image.current.clientWidth/2,o=n-this.image.current.clientHeight/2;break;case 270:e=this.image.current.clientHeight/2-n,o=t-this.image.current.clientWidth/2}this.setState({zoom:s,translationX:this.state.translationX+(s-i)*e,translationY:this.state.translationY+(s-i)*o})}}renderContextMenu(){let e=null;return this.state.contextMenuDisplayed&&(e=c.a.createElement(g.a,s()({},Object(f.j)(this.contextMenuButton.current.getBoundingClientRect()),{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,onFinished:this.onCloseContextMenu,onCloseDialog:this.props.onFinished}))),c.a.createElement(c.a.Fragment,null,e)}render(){var e;const t=!!this.props.mxEvent,n=this.state.maxZoom===this.state.minZoom;let i,s;i=this.animatingLoading?"mx_ImageView_image_animatingLoading":this.state.moving||!this.imageIsLoaded?"":"mx_ImageView_image_animating",s=this.state.moving?"grabbing":n?"default":this.state.zoom===this.state.minZoom?"zoom-in":"zoom-out";const o=this.state.rotation+"deg",r=this.state.zoom,a={cursor:s,transform:`translateX(${this.state.translationX+"px"})\n                        translateY(${this.state.translationY+"px"})\n                        scale(${r})\n                        rotate(${o})`};let l,g,f,S,E;if(t){const e=this.props.mxEvent,t=b.b.getValue("showTwelveHourTimestamps");let n="#";this.props.permalinkCreator&&(n=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const i=e.sender?e.sender.name:e.getSender(),s=c.a.createElement("div",{className:"mx_ImageView_info_sender"},i),o=c.a.createElement("a",{href:n,onClick:this.onPermalinkClicked,"aria-label":Object(y.d)(new Date(this.props.mxEvent.getTs()),t,!1)},c.a.createElement(v.a,{showFullDate:!0,showTwelveHour:t,ts:e.getTs(),showSeconds:!1})),r=c.a.createElement(m.a,{member:e.sender,fallbackUserId:e.getSender(),width:32,height:32,viewUserOnClick:!0});l=c.a.createElement("div",{className:"mx_ImageView_info_wrapper"},r,c.a.createElement("div",{className:"mx_ImageView_info"},s,o))}else l=c.a.createElement("div",null);var w;(this.props.mxEvent&&(g=c.a.createElement(p.a,{className:"mx_ImageView_button mx_ImageView_button_more",title:Object(u.a)("Options"),onClick:this.onOpenContextMenu,inputRef:this.contextMenuButton,isExpanded:this.state.contextMenuDisplayed})),n||(f=c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_zoomOut",title:Object(u.a)("Zoom out"),onClick:this.onZoomOutClick}),S=c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_zoomIn",title:Object(u.a)("Zoom in"),onClick:this.onZoomInClick})),null!==(e=this.props.mxEvent)&&void 0!==e&&e.getContent())&&(E=c.a.createElement("div",{className:"mx_ImageView_title"},Object(I.a)(null===(w=this.props.mxEvent)||void 0===w?void 0:w.getContent(),Object(u.a)("Image"),!0)));return c.a.createElement(d.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog"},className:"mx_ImageView",ref:this.focusLock},c.a.createElement("div",{className:"mx_ImageView_panel"},l,E,c.a.createElement("div",{className:"mx_ImageView_toolbar"},f,S,c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_rotateCCW",title:Object(u.a)("Rotate Left"),onClick:this.onRotateCounterClockwiseClick}),c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_rotateCW",title:Object(u.a)("Rotate Right"),onClick:this.onRotateClockwiseClick}),c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_download",title:Object(u.a)("Download"),onClick:this.onDownloadClick}),g,c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_close",title:Object(u.a)("Close"),onClick:this.props.onFinished}),this.renderContextMenu())),c.a.createElement("div",{className:"mx_ImageView_image_wrapper",ref:this.imageWrapper,onMouseDown:this.props.onFinished,onMouseMove:this.onMoving,onMouseUp:this.onEndMoving,onMouseLeave:this.onEndMoving},c.a.createElement("img",{src:this.props.src,style:a,alt:this.props.name,ref:this.image,className:"mx_ImageView_image "+i,draggable:!0,onMouseDown:this.onStartMoving})))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return X})),n.d(t,"c",(function(){return ie})),n.d(t,"b",(function(){return se})),n.d(t,"e",(function(){return oe})),n.d(t,"d",(function(){return re}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(144),c=n(97),l=n(237),d=n(664),u=n(0),h=n(90),m=n(92),p=n(89),g=n(95),f=n(579),v=n(158),b=n(115),y=n(142),S=n(720),E=n(384),w=n(322),_=n(383),C=n(132),O=n(181),R=n(505),I=n(230),k=n(183),x=n(96),T=n(217),j=n(98),N=n(93),P=n(122),D=n(232),A=n(156),M=n(238),U=n(407),L=n(751),F=n(575),B=n(752),K=n(212);var V=e=>{let{onFinished:t}=e;const n={};ie.forEach(e=>{e.isEnabled()&&(n[e.category]||(n[e.category]=[]),n[e.category].push(e))});const i=Object.values(X).filter(e=>n[e]).map(e=>{const t=[r.a.createElement("tr",{key:"_category_"+e,className:"mx_SlashCommandHelpDialog_headerRow"},r.a.createElement("td",{colSpan:3},r.a.createElement("h2",null,Object(p.a)(e))))];return n[e].forEach(e=>{t.push(r.a.createElement("tr",{key:e.command},r.a.createElement("td",null,r.a.createElement("strong",null,e.getCommand())),r.a.createElement("td",null,e.args),r.a.createElement("td",null,e.description)))}),t});return r.a.createElement(K.a,{className:"mx_SlashCommandHelpDialog",title:Object(p.a)("Command Help"),description:r.a.createElement("table",null,r.a.createElement("tbody",null,i)),hasCloseButton:!0,onFinished:t})},W=n(185),H=n(106),q=n(129),$=n(173),G=n(406),z=n(427);function J(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?J(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):J(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Q=async()=>new Promise(e=>{const t=document.createElement("input");t.setAttribute("type","file"),t.onchange=t=>{const n=t.target.files[0];g.a.createTrackedDialog("Upload Files confirmation","",L.a,{file:n,onFinished:t=>{e(t?h.a.get().uploadContent(n):null)}})},t.click()}),X={messages:Object(p.c)("Messages"),actions:Object(p.c)("Actions"),admin:Object(p.c)("Admin"),advanced:Object(p.c)("Advanced"),effects:Object(p.c)("Effects"),other:Object(p.c)("Other")};class Z{constructor(e){s()(this,"command",void 0),s()(this,"aliases",void 0),s()(this,"args",void 0),s()(this,"description",void 0),s()(this,"runFn",void 0),s()(this,"category",void 0),s()(this,"hideCompletionAfterSpace",void 0),s()(this,"renderingTypes",void 0),s()(this,"analyticsName",void 0),s()(this,"_isEnabled",void 0),this.command=e.command,this.aliases=e.aliases||[],this.args=e.args||"",this.description=e.description,this.runFn=e.runFn,this.category=e.category||X.other,this.hideCompletionAfterSpace=e.hideCompletionAfterSpace||!1,this._isEnabled=e.isEnabled,this.renderingTypes=e.renderingTypes,this.analyticsName=e.analyticsName}getCommand(){return"/"+this.command}getCommandWithArgs(){return this.getCommand()+" "+this.args}run(e,t,n){var i;if(!this.runFn)return ee(Object(p.i)("Command error: Unable to handle slash command."));const s=t?H.a.Thread:H.a.Room;return!this.renderingTypes||null!==(i=this.renderingTypes)&&void 0!==i&&i.includes(s)?(this.analyticsName&&$.a.instance.trackEvent({eventName:"SlashCommand",command:this.analyticsName}),this.runFn.bind(this)(e,n)):ee(Object(p.i)("Command error: Unable to find rendering type (%(renderingType)s)",{renderingType:s}))}getUsage(){return Object(p.a)("Usage")+": "+this.getCommandWithArgs()}isEnabled(){return!this._isEnabled||this._isEnabled()}}function ee(e){return{error:e}}function te(e){return{promise:e}}function ne(e){return te(Promise.resolve(e))}const ie=[new Z({command:"spoiler",args:"<message>",description:Object(p.c)("Sends the given message as a spoiler"),runFn:function(e,t){return ne(l.makeHtmlMessage(t,`<span data-mx-spoiler>${t}</span>`))},category:X.messages}),new Z({command:"shrug",args:"<message>",description:Object(p.c)("Prepends ¯\\_(ツ)_/¯ to a plain-text message"),runFn:function(e,t){let n="¯\\_(ツ)_/¯";return t&&(n=n+" "+t),ne(l.makeTextMessage(n))},category:X.messages}),new Z({command:"tableflip",args:"<message>",description:Object(p.c)("Prepends (╯°□°）╯︵ ┻━┻ to a plain-text message"),runFn:function(e,t){let n="(╯°□°）╯︵ ┻━┻";return t&&(n=n+" "+t),ne(l.makeTextMessage(n))},category:X.messages}),new Z({command:"unflip",args:"<message>",description:Object(p.c)("Prepends ┬──┬ ノ( ゜-゜ノ) to a plain-text message"),runFn:function(e,t){let n="┬──┬ ノ( ゜-゜ノ)";return t&&(n=n+" "+t),ne(l.makeTextMessage(n))},category:X.messages}),new Z({command:"lenny",args:"<message>",description:Object(p.c)("Prepends ( ͡° ͜ʖ ͡°) to a plain-text message"),runFn:function(e,t){let n="( ͡° ͜ʖ ͡°)";return t&&(n=n+" "+t),ne(l.makeTextMessage(n))},category:X.messages}),new Z({command:"plain",args:"<message>",description:Object(p.c)("Sends a message as plain text, without interpreting it as markdown"),runFn:function(e,t){return ne(l.makeTextMessage(t))},category:X.messages}),new Z({command:"html",args:"<message>",description:Object(p.c)("Sends a message as html, without interpreting it as markdown"),runFn:function(e,t){return ne(l.makeHtmlMessage(t,t))},category:X.messages}),new Z({command:"upgraderoom",args:"<new_version>",description:Object(p.c)("Upgrades a room to a new version"),runFn:function(e,t){if(t){const n=h.a.get(),i=n.getRoom(e);if(!i.currentState.mayClientSendStateEvent("m.room.tombstone",n))return ee(Object(p.i)("You do not have the required permissions to use this command."));const{finished:s}=g.a.createTrackedDialog("Slash Commands","upgrade room confirmation",B.a,{roomId:e,targetVersion:t},null,!1,!0);return te(s.then(async e=>{let[n]=e;null!=n&&n.continue&&await Object(U.b)(i,t,n.invite)}))}return ee(this.getUsage())},category:X.admin,renderingTypes:[H.a.Room]}),new Z({command:"jumptodate",args:"<YYYY-MM-DD>",description:Object(p.c)("Jump to the given date in the timeline"),isEnabled:()=>N.b.getValue("feature_jump_to_date"),runFn:function(e,t){return t?te((async()=>{const n=Date.parse(t);if(!n)throw Object(p.i)("We were unable to understand the given date (%(inputDate)s). Try using the format YYYY-MM-DD.",{inputDate:t});const i=h.a.get(),{event_id:s,origin_server_ts:o}=await i.timestampToEvent(e,n,a.a.Forward);u.a.log(`/timestamp_to_event: found ${s} (${o}) for timestamp=${n}`),m.a.dispatch({action:x.a.ViewRoom,event_id:s,highlighted:!0,room_id:e,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0})})()):ee(this.getUsage())},category:X.actions}),new Z({command:"nick",args:"<display_name>",description:Object(p.c)("Changes your display nickname"),runFn:function(e,t){return t?te(h.a.get().setDisplayName(t)):ee(this.getUsage())},category:X.actions,renderingTypes:[H.a.Room]}),new Z({command:"myroomnick",aliases:["roomnick"],args:"<display_name>",description:Object(p.c)("Changes your display nickname in the current room only"),runFn:function(e,t){if(t){const n=h.a.get(),i=n.getRoom(e).currentState.getStateEvents("m.room.member",n.getUserId()),s=Y(Y({},i?i.getContent():{membership:"join"}),{},{displayname:t});return te(n.sendStateEvent(e,"m.room.member",s,n.getUserId()))}return ee(this.getUsage())},category:X.actions,renderingTypes:[H.a.Room]}),new Z({command:"roomavatar",args:"[<mxc_url>]",description:Object(p.c)("Changes the avatar of the current room"),runFn:function(e,t){let n=Promise.resolve(t);return t||(n=Q()),te(n.then(t=>{if(t)return h.a.get().sendStateEvent(e,"m.room.avatar",{url:t},"")}))},category:X.actions,renderingTypes:[H.a.Room]}),new Z({command:"myroomavatar",args:"[<mxc_url>]",description:Object(p.c)("Changes your avatar in this current room only"),runFn:function(e,t){const n=h.a.get(),i=n.getRoom(e),s=n.getUserId();let o=Promise.resolve(t);return t||(o=Q()),te(o.then(t=>{if(!t)return;const o=i.currentState.getStateEvents("m.room.member",s),r=Y(Y({},o?o.getContent():{membership:"join"}),{},{avatar_url:t});return n.sendStateEvent(e,"m.room.member",r,s)}))},category:X.actions,renderingTypes:[H.a.Room]}),new Z({command:"myavatar",args:"[<mxc_url>]",description:Object(p.c)("Changes your avatar in all rooms"),runFn:function(e,t){let n=Promise.resolve(t);return t||(n=Q()),te(n.then(e=>{if(e)return h.a.get().setAvatarUrl(e)}))},category:X.actions,renderingTypes:[H.a.Room]}),new Z({command:"topic",args:"[<topic>]",description:Object(p.c)("Gets or sets the room topic"),runFn:function(e,t){const n=h.a.get();if(t)return te(n.setRoomTopic(e,t));const i=n.getRoom(e);if(!i)return ee(Object(p.i)("Failed to get room topic: Unable to find room (%(roomId)s",{roomId:e}));const s=i.currentState.getStateEvents("m.room.topic",""),r=s&&s.getContent().topic,a=r?Object(v.f)(r):Object(p.a)("This room has no topic.");return g.a.createTrackedDialog("Slash Commands","Topic",K.a,{title:i.name,description:o.createElement("div",{dangerouslySetInnerHTML:{__html:a}}),hasCloseButton:!0}),te()},category:X.admin,renderingTypes:[H.a.Room]}),new Z({command:"roomname",args:"<name>",description:Object(p.c)("Sets the room name"),runFn:function(e,t){return t?te(h.a.get().setRoomName(e,t)):ee(this.getUsage())},category:X.admin,renderingTypes:[H.a.Room]}),new Z({command:"invite",args:"<user-id> [<reason>]",description:Object(p.c)("Invites user with given id to current room"),analyticsName:"Invite",isEnabled:()=>Object(W.a)(P.a.InviteUsers),runFn:function(e,t){if(t){const[n,i]=t.split(/\s+(.+)/);if(n){let t=Promise.resolve();if(Object(E.b)(n)===E.a.Email&&!h.a.get().getIdentityServerUrl()){const e=Object(_.c)();if(!e)return ee(Object(p.i)("Use an identity server to invite by email. Manage in Settings."));{const{finished:n}=g.a.createTrackedDialog("Slash Commands","Identity server",b.a,{title:Object(p.a)("Use an identity server"),description:o.createElement("p",null,Object(p.a)("Use an identity server to invite by email. Click continue to use the default identity server (%(defaultIdentityServerName)s) or manage in Settings.",{defaultIdentityServerName:Object(w.a)(e)})),button:Object(p.a)("Continue")});t=n.then(e=>{let[t]=e;if(!t)throw Object(p.i)("Use an identity server to invite by email. Manage in Settings.");Object(_.d)()})}}const s=new f.a(e);return te(t.then(()=>s.invite([n],i,!0)).then(()=>{if("invited"!==s.getCompletionState(n))throw new Error(s.getErrorText(n))}))}}return ee(this.getUsage())},category:X.actions,renderingTypes:[H.a.Room]}),new Z({command:"join",aliases:["j","goto"],args:"<room-address>",description:Object(p.c)("Joins room with given address"),runFn:function(e,t){if(t){const e=t.split(" ");if(e.length<1)return ee(this.getUsage());let n=!1;if(e[0].startsWith("http:")||e[0].startsWith("https:")){const t=new URL(e[0]),i=t.host||t.hostname;Object(C.d)(i)&&(n=!0)}if("#"===e[0][0]){let t=e[0];return t.includes(":")||(t+=":"+h.a.get().getDomain()),m.a.dispatch({action:x.a.ViewRoom,room_alias:t,auto_join:!0,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0}),te()}if("!"===e[0][0]){const[t,...n]=e;return m.a.dispatch({action:x.a.ViewRoom,room_id:t,via_servers:n,auto_join:!0,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0}),te()}if(n){const t=Object(C.h)(e[0]);if(!t)return ee(this.getUsage());if(!t.roomIdOrAlias)return ee(this.getUsage());const n=t.roomIdOrAlias,i=t.viaServers,s=t.eventId,o={action:x.a.ViewRoom,auto_join:!0,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0};return"!"===n[0]?o.room_id=n:o.room_alias=n,s&&(o.event_id=s,o.highlighted=!0),i&&(o.opts={viaServers:i},o.via_servers=i),m.a.dispatch(o),te()}}return ee(this.getUsage())},category:X.actions,renderingTypes:[H.a.Room]}),new Z({command:"part",args:"[<room-address>]",description:Object(p.c)("Leave room"),analyticsName:"Part",runFn:function(e,t){const n=h.a.get();let i;if(t){const e=t.match(/^(\S+)$/);if(e){let t=e[1];if("#"!==t[0])return ee(this.getUsage());t.includes(":")||(t+=":"+n.getDomain());const s=n.getRooms();for(let e=0;e<s.length;e++){const n=s[e].currentState.getStateEvents("m.room.aliases");for(let o=0;o<n.length;o++){const r=n[o].getContent().aliases||[];for(let n=0;n<r.length;n++)if(r[n]===t){i=s[e].roomId;break}if(i)break}if(i)break}if(!i)return ee(Object(p.i)("Unrecognised room address: %(roomAlias)s",{roomAlias:t}))}}return i||(i=e),te(Object(z.a)(i))},category:X.actions,renderingTypes:[H.a.Room]}),new Z({command:"remove",aliases:["kick"],args:"<user-id> [reason]",description:Object(p.c)("Removes user with given id from this room"),runFn:function(e,t){if(t){const n=t.match(/^(\S+?)( +(.*))?$/);if(n)return te(h.a.get().kick(e,n[1],n[3]))}return ee(this.getUsage())},category:X.admin,renderingTypes:[H.a.Room]}),new Z({command:"ban",args:"<user-id> [reason]",description:Object(p.c)("Bans user with given id"),runFn:function(e,t){if(t){const n=t.match(/^(\S+?)( +(.*))?$/);if(n)return te(h.a.get().ban(e,n[1],n[3]))}return ee(this.getUsage())},category:X.admin,renderingTypes:[H.a.Room]}),new Z({command:"unban",args:"<user-id>",description:Object(p.c)("Unbans user with given ID"),runFn:function(e,t){if(t){const n=t.match(/^(\S+)$/);if(n)return te(h.a.get().unban(e,n[1]))}return ee(this.getUsage())},category:X.admin,renderingTypes:[H.a.Room]}),new Z({command:"ignore",args:"<user-id>",description:Object(p.c)("Ignores a user, hiding their messages from you"),runFn:function(e,t){if(t){const e=h.a.get(),n=t.match(/^(@[^:]+:\S+)$/);if(n){const t=n[1],i=e.getIgnoredUsers();return i.push(t),te(e.setIgnoredUsers(i).then(()=>{g.a.createTrackedDialog("Slash Commands","User ignored",K.a,{title:Object(p.a)("Ignored user"),description:o.createElement("div",null,o.createElement("p",null,Object(p.a)("You are now ignoring %(userId)s",{userId:t})))})}))}}return ee(this.getUsage())},category:X.actions}),new Z({command:"unignore",args:"<user-id>",description:Object(p.c)("Stops ignoring a user, showing their messages going forward"),runFn:function(e,t){if(t){const e=h.a.get(),n=t.match(/(^@[^:]+:\S+$)/);if(n){const t=n[1],i=e.getIgnoredUsers(),s=i.indexOf(t);return-1!==s&&i.splice(s,1),te(e.setIgnoredUsers(i).then(()=>{g.a.createTrackedDialog("Slash Commands","User unignored",K.a,{title:Object(p.a)("Unignored user"),description:o.createElement("div",null,o.createElement("p",null,Object(p.a)("You are no longer ignoring %(userId)s",{userId:t})))})}))}}return ee(this.getUsage())},category:X.actions}),new Z({command:"op",args:"<user-id> [<power-level>]",description:Object(p.c)("Define the power level of a user"),isEnabled(){const e=h.a.get(),t=e.getRoom(q.a.instance.getRoomId());return null==t?void 0:t.currentState.maySendStateEvent(c.b.RoomPowerLevels,e.getUserId())},runFn:function(e,t){if(t){const n=t.match(/^(\S+?)( +(-?\d+))?$/);let i=50;if(n){const t=n[1];if(4===n.length&&void 0!==n[3]&&(i=parseInt(n[3],10)),!isNaN(i)){const n=h.a.get(),s=n.getRoom(e);if(!s)return ee(Object(p.i)("Command failed: Unable to find room (%(roomId)s",{roomId:e}));const o=s.getMember(t);if(!o||Object(T.b)(o.membership)===T.a.Leave)return ee(Object(p.i)("Could not find user in room"));const r=s.currentState.getStateEvents("m.room.power_levels","");return te(n.setPowerLevel(e,t,i,r))}}}return ee(this.getUsage())},category:X.admin,renderingTypes:[H.a.Room]}),new Z({command:"deop",args:"<user-id>",description:Object(p.c)("Deops user with given id"),isEnabled(){const e=h.a.get(),t=e.getRoom(q.a.instance.getRoomId());return null==t?void 0:t.currentState.maySendStateEvent(c.b.RoomPowerLevels,e.getUserId())},runFn:function(e,t){if(t){if(t.match(/^(\S+)$/)){const n=h.a.get(),i=n.getRoom(e);if(!i)return ee(Object(p.i)("Command failed: Unable to find room (%(roomId)s",{roomId:e}));const s=i.currentState.getStateEvents("m.room.power_levels","");return s.getContent().users[t]?te(n.setPowerLevel(e,t,void 0,s)):ee(Object(p.i)("Could not find user in room"))}}return ee(this.getUsage())},category:X.admin,renderingTypes:[H.a.Room]}),new Z({command:"devtools",description:Object(p.c)("Opens the Developer Tools dialog"),runFn:function(e){return g.a.createDialog(F.a,{roomId:e},"mx_DevtoolsDialog_wrapper"),te()},category:X.advanced}),new Z({command:"addwidget",args:"<url | embed code | Jitsi url>",description:Object(p.c)("Adds a custom widget by URL to the room"),isEnabled:()=>N.b.getValue(P.b.Widgets)&&Object(W.a)(P.a.AddIntegrations),runFn:function(e,t){if(!t)return ee(Object(p.i)("Please supply a widget URL or embed code"));if(t.toLowerCase().startsWith("<iframe ")){const e=Object(d.parseFragment)(t);if(e&&e.childNodes&&1===e.childNodes.length){const n=e.childNodes[0];if("iframe"===n.tagName.toLowerCase()&&n.attrs){const e=n.attrs.find(e=>"src"===e.name);u.a.log("Pulling URL out of iframe (embed code)"),t=e.value}}}if(!t.startsWith("https://")&&!t.startsWith("http://"))return ee(Object(p.i)("Please supply a https:// or http:// widget URL"));if(y.a.canUserModifyWidgets(e)){const n=h.a.get().getUserId(),i=(new Date).getTime(),s=encodeURIComponent(`${e}_${n}_${i}`);let o=O.a.CUSTOM,r="Custom",a={};const c=R.a.getInstance().parsePreferredConferenceUrl(t);return c&&(u.a.log("Making /addwidget widget a Jitsi conference"),o=O.a.JITSI,r="Jitsi",a=c,t=y.a.getLocalJitsiWrapperUrl()),te(y.a.setRoomWidget(e,s,o,t,r,a))}return ee(Object(p.i)("You cannot modify widgets in this room."))},category:X.admin,renderingTypes:[H.a.Room]}),new Z({command:"verify",args:"<user-id> <device-id> <device-signing-key>",description:Object(p.c)("Verifies a user, session, and pubkey tuple"),runFn:function(e,t){if(t){const e=t.match(/^(\S+) +(\S+) +(\S+)$/);if(e){const t=h.a.get(),n=e[1],i=e[2],s=e[3];return te((async()=>{const e=t.getStoredDevice(n,i);if(!e)throw Object(p.i)("Unknown (user, session) pair: (%(userId)s, %(deviceId)s)",{userId:n,deviceId:i});if((await t.checkDeviceTrust(n,i)).isVerified())throw e.getFingerprint()===s?Object(p.i)("Session already verified!"):Object(p.i)("WARNING: Session already verified, but keys do NOT MATCH!");if(e.getFingerprint()!==s){const t=e.getFingerprint();throw Object(p.i)('WARNING: KEY VERIFICATION FAILED! The signing key for %(userId)s and session %(deviceId)s is "%(fprint)s" which does not match the provided key "%(fingerprint)s". This could mean your communications are being intercepted!',{fprint:t,userId:n,deviceId:i,fingerprint:s})}await t.setDeviceVerified(n,i,!0),g.a.createTrackedDialog("Slash Commands","Verified key",K.a,{title:Object(p.a)("Verified key"),description:o.createElement("div",null,o.createElement("p",null,Object(p.a)("The signing key you provided matches the signing key you received from %(userId)s's session %(deviceId)s. Session marked as verified.",{userId:n,deviceId:i})))})})())}}return ee(this.getUsage())},category:X.advanced,renderingTypes:[H.a.Room]}),new Z({command:"discardsession",description:Object(p.c)("Forces the current outbound group session in an encrypted room to be discarded"),runFn:function(e){try{h.a.get().forceDiscardSession(e)}catch(e){return ee(e.message)}return te()},category:X.advanced,renderingTypes:[H.a.Room]}),new Z({command:"rainbow",description:Object(p.c)("Sends the given message coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?ne(l.makeHtmlMessage(t,Object(S.a)(t))):ee(this.getUserId())},category:X.messages}),new Z({command:"rainbowme",description:Object(p.c)("Sends the given emote coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?ne(l.makeHtmlEmote(t,Object(S.a)(t))):ee(this.getUserId())},category:X.messages}),new Z({command:"help",description:Object(p.c)("Displays list of commands with usages and descriptions"),runFn:function(){return g.a.createTrackedDialog("Slash Commands","Help",V),te()},category:X.advanced}),new Z({command:"whois",description:Object(p.c)("Displays information about a user"),args:"<user-id>",runFn:function(e,t){if(!t||!t.startsWith("@")||!t.includes(":"))return ee(this.getUsage());const n=h.a.get().getRoom(e).getMember(t);return m.a.dispatch({action:x.a.ViewUser,member:n||{userId:t}}),te()},category:X.advanced}),new Z({command:"rageshake",aliases:["bugreport"],description:Object(p.c)("Send a bug report with logs"),isEnabled:()=>!!j.b.get().bug_report_endpoint_url,args:"<description>",runFn:function(e,t){return te(g.a.createTrackedDialog("Slash Commands","Bug Report Dialog",I.a,{initialText:t}).finished)},category:X.advanced}),new Z({command:"tovirtual",description:Object(p.c)("Switches to this room's virtual room, if it has one"),category:X.advanced,isEnabled:()=>A.b.instance.getSupportsVirtualRooms(),runFn:e=>te((async()=>{const t=await G.a.sharedInstance().getVirtualRoomForRoom(e);if(!t)throw Object(p.i)("No virtual room for this room");m.a.dispatch({action:x.a.ViewRoom,room_id:t.roomId,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0})})())}),new Z({command:"query",description:Object(p.c)("Opens chat with the given user"),args:"<user-id>",runFn:function(e,t){const n=t&&/^\+?[0123456789]+$/.test(t);return t&&(t.startsWith("@")&&t.includes(":")||n)?te((async()=>{if(n){const e=await A.b.instance.pstnLookup(this.state.value);if(!e||0===e.length||!e[0].userid)throw Object(p.i)("Unable to find Matrix ID for phone number");t=e[0].userid}const e=await Object(k.c)(h.a.get(),t);m.a.dispatch({action:x.a.ViewRoom,room_id:e,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0})})()):ee(this.getUsage())},category:X.actions}),new Z({command:"msg",description:Object(p.c)("Sends a message to the given user"),args:"<user-id> [<message>]",runFn:function(e,t){if(t){const e=t.match(/^(\S+?)(?: +(.*))?$/s);if(e){const[t,n]=e.slice(1);if(t&&t.startsWith("@")&&t.includes(":"))return te((async()=>{const e=h.a.get(),i=await Object(k.c)(e,t);m.a.dispatch({action:x.a.ViewRoom,room_id:i,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0}),n&&e.sendTextMessage(i,n)})())}}return ee(this.getUsage())},category:X.actions}),new Z({command:"holdcall",description:Object(p.c)("Places the call in the current room on hold"),category:X.other,runFn:function(e,t){const n=A.b.instance.getCallForRoom(e);return n?(n.setRemoteOnHold(!0),te()):ee(Object(p.i)("No active call in this room"))},renderingTypes:[H.a.Room]}),new Z({command:"unholdcall",description:Object(p.c)("Takes the call in the current room off hold"),category:X.other,runFn:function(e,t){const n=A.b.instance.getCallForRoom(e);return n?(n.setRemoteOnHold(!1),te()):ee(Object(p.i)("No active call in this room"))},renderingTypes:[H.a.Room]}),new Z({command:"converttodm",description:Object(p.c)("Converts the room to a DM"),category:X.other,runFn:function(e,t){const n=h.a.get().getRoom(e);return te(Object(M.c)(n,!0))},renderingTypes:[H.a.Room]}),new Z({command:"converttoroom",description:Object(p.c)("Converts the DM to a room"),category:X.other,runFn:function(e,t){const n=h.a.get().getRoom(e);return te(Object(M.c)(n,!1))},renderingTypes:[H.a.Room]}),new Z({command:"me",args:"<message>",description:Object(p.c)("Displays action"),category:X.messages,hideCompletionAfterSpace:!0}),...D.CHAT_EFFECTS.map(e=>new Z({command:e.command,description:e.description(),args:"<message>",runFn:function(t,n){return te((async()=>{if(n){const i={msgtype:e.msgType,body:n};h.a.get().sendMessage(t,i)}else n=e.fallbackMessage(),h.a.get().sendEmoteMessage(t,n);m.a.dispatch({action:"effects."+e.command})})())},category:X.effects,renderingTypes:[H.a.Room]}))],se=new Map;function oe(e){if("/"!==(e=e.replace(/\s+$/,""))[0])return{};const t=e.match(/^(\S+?)(?:[ \n]+((.|\n)*))?$/);let n,i;return t?(n=t[1].substring(1).toLowerCase(),i=t[2]):n=e,{cmd:n,args:i}}function re(e){const{cmd:t,args:n}=oe(e);return se.has(t)&&se.get(t).isEnabled()?{cmd:se.get(t),args:n}:{}}ie.forEach(e=>{se.set(e.command,e),e.aliases.forEach(t=>{se.set(t,e)})})},,,function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return l})),n.d(t,"d",(function(){return d})),n.d(t,"c",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(17),s=n.n(i),o=n(18),r=n(237),a=n(7),c=n(143);let l;!function(e){e.New="Beacon.new",e.Update="Beacon.update",e.LivenessChange="Beacon.LivenessChange",e.Destroy="Beacon.Destroy",e.LocationUpdate="Beacon.LocationUpdate"}(l||(l={}));const d=(e,t,n)=>n>=e&&e+t>=n,u=e=>`${e.getRoomId()}_${e.getStateKey()}`;class h extends c.b{constructor(e){super(),this.rootEvent=e,s()(this,"roomId",void 0),s()(this,"_beaconInfo",void 0),s()(this,"_isLive",void 0),s()(this,"livenessWatchInterval",void 0),s()(this,"_latestLocationState",void 0),s()(this,"clearLatestLocation",()=>{this._latestLocationState=void 0,this.emit(l.LocationUpdate,this.latestLocationState)}),this.setBeaconInfo(this.rootEvent),this.roomId=this.rootEvent.getRoomId()}get isLive(){return this._isLive}get identifier(){return u(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationState}update(e){if(u(e)!==this.identifier)throw new Error("Invalid updating event");e.event.origin_server_ts<this.rootEvent.event.origin_server_ts||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(l.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchInterval&&clearInterval(this.livenessWatchInterval),this._isLive=!1,this.emit(l.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchInterval&&clearInterval(this.livenessWatchInterval),this.checkLiveness(),this.isLive){var e,t;const n=(null===(e=this._beaconInfo)||void 0===e?void 0:e.timestamp)+(null===(t=this._beaconInfo)||void 0===t?void 0:t.timeout)-Date.now();n>1&&(this.livenessWatchInterval=setInterval(()=>{this.monitorLiveness()},n))}}addLocations(e){var t;if(!this.isLive)return;const n=null===(t=e.filter(e=>{const t=e.getContent(),n=o.d.findIn(t);return d(this._beaconInfo.timestamp,this._beaconInfo.timeout,n)&&(!this.latestLocationState||n>this.latestLocationState.timestamp)}).sort(a.H))||void 0===t?void 0:t[0];n&&(this._latestLocationState=Object(r.parseBeaconContent)(n.getContent()),this.emit(l.LocationUpdate,this.latestLocationState))}setBeaconInfo(e){this._beaconInfo=Object(r.parseBeaconInfoContent)(e.getContent()),this.checkLiveness()}checkLiveness(){var e,t,n;const i=this.isLive;this._isLive=(null===(e=this._beaconInfo)||void 0===e?void 0:e.live)&&d(null===(t=this._beaconInfo)||void 0===t?void 0:t.timestamp,null===(n=this._beaconInfo)||void 0===n?void 0:n.timeout,Date.now()),i!==this.isLive&&this.emit(l.LivenessChange,this.isLive,this)}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(17),o=n.n(s);!function(e){e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified"}(i||(i={}));class r{static fromStorage(e,t){const n=new r(t);for(const t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}constructor(e){this.deviceId=e,o()(this,"algorithms",void 0),o()(this,"keys",{}),o()(this,"verified",i.Unverified),o()(this,"known",!1),o()(this,"unsigned",{}),o()(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==i.Blocked}isVerified(){return this.verified==i.Verified}isUnverified(){return this.verified==i.Unverified}isKnown(){return!0===this.known}}o()(r,"DeviceVerification",{VERIFIED:i.Verified,UNVERIFIED:i.Unverified,BLOCKED:i.Blocked})},function(e,t,n){"use strict";n.d(t,"d",(function(){return o})),n.d(t,"a",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return l})),n.d(t,"f",(function(){return d})),n.d(t,"g",(function(){return u}));var i=n(17),s=n.n(i);const o={},r={};class a{constructor(e){s()(this,"userId",void 0),s()(this,"deviceId",void 0),s()(this,"crypto",void 0),s()(this,"olmDevice",void 0),s()(this,"baseApis",void 0),s()(this,"roomId",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,n){}}class c{constructor(e){s()(this,"userId",void 0),s()(this,"crypto",void 0),s()(this,"olmDevice",void 0),s()(this,"baseApis",void 0),s()(this,"roomId",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}onRoomKeyEvent(e){}async importRoomKey(e,t){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){return!1}}class l extends Error{constructor(e,t,n){super(t),this.code=e,s()(this,"detailedString",void 0),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let n=e.name+"[msg: "+e.message;t&&(n+=", "+Object.keys(t).map(e=>e+": "+t[e]).join(", "));return n+="]",n}(this,n)}}class d extends Error{constructor(e,t){super(e),this.devices=t,this.name="UnknownDeviceError",this.devices=t}}function u(e,t,n){o[e]=t,r[e]=n}},function(e,t,n){"use strict";(function(e,i){n.d(t,"a",(function(){return u})),n.d(t,"c",(function(){return m})),n.d(t,"b",(function(){return p})),n.d(t,"d",(function(){return g})),n.d(t,"e",(function(){return f}));var s=n(17),o=n.n(s),r=n(161),a=n(0),c=n(187),l=n(284);function d(e){return Object.values(e.keys)[0]}class u{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.userId=e,this.callbacks=t,this.cacheCallbacks=n,o()(this,"keys",{}),o()(this,"firstUse",!0),o()(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){const n=new u(t);for(const t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(t,n){const i=["master","self_signing","user_signing"].indexOf(t)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function s(t){if(!t)return;const i=new e.Olm.PkSigning,s=i.init_with_seed(t);if(s===n)return[s,i];i.free()}let o;void 0===n&&(n=this.getId(t)),this.cacheCallbacks.getCrossSigningKeyCache&&i&&(o=await this.cacheCallbacks.getCrossSigningKeyCache(t,n));const r=s(o);if(r)return r;o=await this.callbacks.getCrossSigningKey(t,n);const a=s(o);if(a)return this.cacheCallbacks.storeCrossSigningKeyCache&&i&&await this.cacheCallbacks.storeCrossSigningKeyCache(t,o),a;if(!o)throw new Error("getCrossSigningKey callback for "+t+" returned falsey");throw new Error("Key type "+t+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master")||{};function n(e){for(const n of Object.keys(t))e[n]||delete t[n]}for(const t of["self_signing","user_signing"])n(await e.isStored("m.cross_signing."+t)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[n,i]of e){const e=Object(r.encodeBase64)(i);await t.store("m.cross_signing."+n,e)}}static async getFromSecretStorage(e,t){const n=await t.get("m.cross_signing."+e);return n?Object(r.decodeBase64)(n):null}async isStoredInKeyCache(e){const t=this.cacheCallbacks;if(!t)return!1;const n=e?[e]:["master","self_signing","user_signing"];for(const e of n)if(!await t.getCrossSigningKeyCache(e))return!1;return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this.cacheCallbacks;if(!t)return e;for(const n of["master","self_signing","user_signing"]){const i=await t.getCrossSigningKeyCache(n);i&&e.set(n,i)}return e}getId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"master";if(!this.keys[e])return null;return d(this.keys[e])}async resetKeys(t){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===t||t&h.MASTER||!this.keys.master)t=h.MASTER|h.USER_SIGNING|h.SELF_SIGNING;else if(0===t)return;const n={},i={};let s,o;try{if(t&h.MASTER?(s=new e.Olm.PkSigning,n.master=s.generate_seed(),o=s.init_with_seed(n.master),i.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+o]:o}}):[o,s]=await this.getCrossSigningKey("master"),t&h.SELF_SIGNING){const t=new e.Olm.PkSigning;try{n.self_signing=t.generate_seed();const e=t.init_with_seed(n.self_signing);i.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+e]:e}},Object(r.pkSign)(i.self_signing,s,this.userId,o)}finally{t.free()}}if(t&h.USER_SIGNING){const t=new e.Olm.PkSigning;try{n.user_signing=t.generate_seed();const e=t.init_with_seed(n.user_signing);i.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+e]:e}},Object(r.pkSign)(i.user_signing,s,this.userId,o)}finally{t.free()}}Object.assign(this.keys,i),this.callbacks.saveCrossSigningKeys(n)}finally{s&&s.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw a.a.error(t),new Error(t)}this.keys.master?d(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const n=d(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw a.a.error(t),new Error(t)}try{Object(r.pkVerify)(e.user_signing,n,this.userId)}catch(e){throw a.a.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw a.a.error(t),new Error(t)}try{Object(r.pkVerify)(e.self_signing,n,this.userId)}catch(e){throw a.a.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[n,i]=await this.getCrossSigningKey(t);try{return Object(r.pkSign)(e,i,this.userId,n),e}finally{i.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");a.a.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");a.a.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new m(!0,!0,this.firstUse);if(!this.keys.user_signing)return new m(!1,!1,e.firstUse);let t;const n=e.keys.master,i=this.getId("user_signing");try{Object(r.pkVerify)(n,i,this.userId),t=!0}catch(e){t=!1}return new m(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,n,i){const s=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new p(!1,!1,n,i);const a=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return Object(r.pkVerify)(o,e.getId(),e.userId),Object(r.pkVerify)(a,d(o),e.userId),p.fromUserTrustLevel(s,n,i)}catch(e){return new p(!1,!1,n,i)}}getCacheCallbacks(){return this.cacheCallbacks}}let h;!function(e){e[e.MASTER=4]="MASTER",e[e.USER_SIGNING=2]="USER_SIGNING",e[e.SELF_SIGNING=1]="SELF_SIGNING"}(h||(h={}));class m{constructor(e,t,n){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class p{constructor(e,t,n,i){this.crossSigningVerified=e,this.tofu=t,this.localVerified=n,this.trustCrossSignedDevices=i}static fromUserTrustLevel(e,t,n){return new p(e.isCrossSigningVerified(),e.isTofu(),t,n)}isVerified(){return Boolean(this.isLocallyVerified()||this.trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function g(e,t){return{getCrossSigningKeyCache:async function(n,s){const o=await new Promise(t=>e.doTxn("readonly",[c.a.STORE_ACCOUNT],i=>{e.getSecretStorePrivateKey(i,t,n)}));if(o&&o.ciphertext){const e=i.from(t.pickleKey),s=await Object(l.b)(o,e,n);return Object(r.decodeBase64)(s)}return o},storeCrossSigningKeyCache:async function(n,s){if(!(s instanceof Uint8Array))throw new Error("storeCrossSigningKeyCache expects Uint8Array, got "+s);const o=i.from(t.pickleKey),a=await Object(l.c)(Object(r.encodeBase64)(s),o,n);return e.doTxn("readwrite",[c.a.STORE_ACCOUNT],t=>{e.storeSecretStorePrivateKey(t,n,a)})}}}function f(e,t,n){if(e.getUserId()===t)return a.a.log("Cross-signing: Self-verification done; requesting keys"),new Promise((t,i)=>{const s=e,o=s.crypto.crossSigningInfo,c=new u(o.userId,{getCrossSigningKey:async e=>{a.a.debug("Cross-signing: requesting secret",e,n);const{promise:t}=s.requestSecret("m.cross_signing."+e,[n]),i=await t,o=Object(r.decodeBase64)(i);return Uint8Array.from(o)}},o.getCacheCallbacks());c.keys=o.keys;const l=new Promise(e=>{setTimeout(e,6e4,new Error("Timeout"))}),d=(async()=>{if(!await s.crypto.getSessionBackupPrivateKey()){a.a.info("No cached backup key found. Requesting...");const e=s.requestSecret("m.megolm_backup.v1",[n]),t=await e.promise;a.a.info("Got key backup key, decoding...");const i=Object(r.decodeBase64)(t);a.a.info("Decoded backup key, storing..."),await s.crypto.storeSessionBackupPrivateKey(Uint8Array.from(i)),a.a.info("Backup key stored. Starting backup restore...");const o=await s.getKeyBackupVersion();s.restoreKeyBackupWithCache(void 0,void 0,o).then(()=>{a.a.info("Backup restored.")})}})();return Promise.race([Promise.all([c.getCrossSigningKey("master"),c.getCrossSigningKey("self_signing"),c.getCrossSigningKey("user_signing"),d]),l]).then(t,i)}).catch(e=>{a.a.warn("Cross-signing: failure while requesting keys:",e)})}}).call(this,n(30),n(31).Buffer)},function(e,t,n){"use strict";(function(e,i){n.d(t,"e",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"b",(function(){return h})),n.d(t,"c",(function(){return m})),n.d(t,"a",(function(){return g}));var s=n(17),o=n.n(s),r=n(370),a=n(316),c=n(161),l=n(0);const d="m.qr_code.show.v1",u="m.qr_code.scan.v1";let h;!function(e){e.ShowReciprocateQr="show_reciprocate_qr"}(h||(h={}));class m extends r.b{constructor(){super(...arguments),o()(this,"reciprocateQREvent",void 0),o()(this,"doVerification",async()=>{if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==e.encodedSharedSecret)throw Object(a.d)();await new Promise((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t(Object(a.h)())},this.emit(h.ShowReciprocateQr,this.reciprocateQREvent)});const t={};switch(e.mode){case p.VerifyOtherUser:{const n=e.otherUserMasterKey;t["ed25519:"+n]=n;break}case p.VerifySelfTrusted:{const n=this.request.targetDevice.deviceId;t["ed25519:"+n]=e.otherDeviceKey;break}case p.VerifySelfUntrusted:{const n=e.myMasterKey;t["ed25519:"+n]=n;break}}await this.verifyKeys(this.userId,t,(e,n,i)=>{const s=t[e];if(!s)throw Object(a.d)();if(i!==s)throw l.a.error("key ID from key info does not match"),Object(a.d)();for(const e in n.keys){if(!e.startsWith("ed25519"))continue;const i=t[e];if(!i)throw Object(a.d)();if(n.keys[e]!==i)throw l.a.error("master key does not match"),Object(a.d)()}})})}static factory(e,t,n,i,s,o){return new m(e,t,n,i,s,o)}static get NAME(){return"m.reciprocate.v1"}}var p;!function(e){e[e.VerifyOtherUser=0]="VerifyOtherUser",e[e.VerifySelfTrusted=1]="VerifySelfTrusted",e[e.VerifySelfUntrusted=2]="VerifySelfUntrusted"}(p||(p={}));class g{constructor(e,t,n,i,s,o){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=n,this.otherDeviceKey=i,this.myMasterKey=s,this.buffer=o}static async create(e,t){const n=g.generateSharedSecret(),i=g.determineMode(e,t);let s=null,o=null,r=null;if(i===p.VerifyOtherUser){s=t.getStoredCrossSigningForUser(e.otherUserId).getId("master")}else if(i===p.VerifySelfTrusted)o=await g.getOtherDeviceKey(e,t);else if(i===p.VerifySelfUntrusted){const e=t.getUserId();r=t.getStoredCrossSigningForUser(e).getId("master")}const a=g.generateQrData(e,t,i,n,s,o,r),c=g.generateBuffer(a);return new g(i,n,s,o,r,c)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){const t=new Uint8Array(11);return e.crypto.getRandomValues(t),Object(c.encodeUnpaddedBase64)(t)}static async getOtherDeviceKey(e,t){const n=t.getUserId(),i=e.targetDevice,s=i?i.deviceId:null,o=t.getStoredDevice(n,s);if(!o)throw new Error("could not find device "+s);return o.getFingerprint()}static determineMode(e,t){const n=t.getUserId(),i=e.otherUserId;let s=p.VerifyOtherUser;if(n===i){s=t.checkUserTrust(n).isCrossSigningVerified()?p.VerifySelfTrusted:p.VerifySelfUntrusted}return s}static generateQrData(e,t,n,i,s,o,r){const a=t.getUserId(),c={prefix:"MATRIX",version:2,mode:n,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:i},l=t.getStoredCrossSigningForUser(a);return n===p.VerifyOtherUser?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=s):n===p.VerifySelfTrusted?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=o):n===p.VerifySelfUntrusted&&(c.firstKeyB64=t.getDeviceEd25519Key(),c.secondKeyB64=r),c}static generateBuffer(e){let t=i.alloc(0);const n=e=>{const n=i.from([e]);t=i.concat([t,n])},s=e=>{const n=i.alloc(2);n.writeInt16BE(e,0),t=i.concat([t,n])},o=function(e,n){let o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const r=i.from(e,n);o&&s(r.byteLength),t=i.concat([t,r])},r=e=>{const n=Object(c.decodeBase64)(e),s=i.from(n);t=i.concat([t,s])};return o(e.prefix,"ascii",!1),n(e.version),n(e.mode),o(e.transactionId,"utf-8"),r(e.firstKeyB64),r(e.secondKeyB64),r(e.secretB64),t}}}).call(this,n(30),n(31).Buffer)},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"c",(function(){return m})),n.d(t,"b",(function(){return p}));var i=n(17),s=n.n(i),o=n(108),r=n(0),a=n(366),c=n(316),l=n(368),d=n(143);const u=new Error("Verification timed out");class h extends Error{constructor(e){super(),this.startEvent=e}}let m;!function(e){e.Cancel="cancel"}(m||(m={}));class p extends d.b{constructor(e,t,n,i,o,r){super(),this.channel=e,this.baseApis=t,this.userId=n,this.deviceId=i,this.startEvent=o,this.request=r,s()(this,"cancelled",!1),s()(this,"_done",!1),s()(this,"promise",null),s()(this,"transactionTimeoutTimer",null),s()(this,"expectedEvent",void 0),s()(this,"resolve",void 0),s()(this,"reject",void 0),s()(this,"resolveEvent",void 0),s()(this,"rejectEvent",void 0),s()(this,"started",void 0),s()(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){r.a.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout(()=>{this._done||this.cancelled||(r.a.info("Triggering verification timeout"),this.cancel(u))},6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise((e,t)=>{this.resolveEvent=e,this.rejectEvent=t}))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(r.a.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){const t=this.rejectEvent;this.rejectEvent=void 0,t(new h(e))}else this.startEvent=e}handleEvent(e){if(!this._done)if(e.getType()===this.expectedEvent)"m.key.verification.done"!==this.expectedEvent&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),this.resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){const t=this.reject;if(this.reject=void 0,t){const n=e.getContent(),{reason:i,code:s}=n;t(new Error(`Other side cancelled verification because ${i} (${s})`))}}else if(this.expectedEvent){const t=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){const e=this.rejectEvent;this.rejectEvent=void 0,e(t)}this.cancel(t)}}done(){if(this.endTimer(),!this._done)return this.request.onVerifierFinished(),this.resolve(),Object(l.e)(this.baseApis,this.userId,this.deviceId)}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===u){const e=Object(c.e)();this.send(e.getType(),e.getContent())}else if(e instanceof o.b){if(e.getSender()!==this.userId){const t=e.getContent();"m.key.verification.cancel"===e.getType()?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this.send("m.key.verification.cancel",t)):this.send("m.key.verification.cancel",{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this.send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this.promise?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(m.Cancel,e)}}verify(){var e=this;return this.promise||(this.promise=new Promise((t,n)=>{this.resolve=function(){e._done=!0,e.endTimer(),t(...arguments)},this.reject=e=>{this._done=!0,this.endTimer(),n(e)}}),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),Promise.resolve(this.doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}async verifyKeys(e,t,n){const i=[];for(const[s,o]of Object.entries(t)){const t=s.split(":",2)[1],c=this.baseApis.getStoredDevice(e,t);if(c)n(s,c,o),i.push(t);else{const c=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);c&&c.getId()===t?(n(s,a.a.fromStorage({keys:{[s]:t}},t),o),i.push(t)):r.a.warn(`verification: Could not find device ${t} to verify`)}}if(!i.length)throw new Error("No devices could be verified");r.a.info("Verification completed! Marking devices verified: ",i);for(const t of i)await this.baseApis.setDeviceVerified(e,t)}get events(){}}},function(e,t,n){"use strict";(function(e,i){n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return c})),n.d(t,"a",(function(){return l}));var s=n(186),o=n(7);const r="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null;function a(t,n){if(!e.Olm)throw new Error("Olm is not available");if(!t.private_key_salt||!t.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return l(n,t.private_key_salt,t.private_key_iterations,t.private_key_bits||256)}async function c(t){if(!e.Olm)throw new Error("Olm is not available");const n=Object(s.b)(32);return{key:await l(t,n,5e5,256),salt:n,iterations:5e5}}async function l(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:256;return r?d(e,t,n,i):u(e,t,n,i)}async function d(t,n,i,s){const o=e.crypto.subtle,r=e.TextEncoder;if(!o||!r)throw new Error("Password-based backup is not avaiable on this platform");const a=await o.importKey("raw",(new r).encode(t),{name:"PBKDF2"},!1,["deriveBits"]),c=await o.deriveBits({name:"PBKDF2",salt:(new r).encode(n),iterations:i,hash:"SHA-512"},a,s);return new Uint8Array(c)}async function u(e,t,n,s){const r=Object(o.q)();if(!r)throw new Error("No usable crypto implementation");return r.pbkdf2Sync(e,i.from(t,"binary"),n,s,"sha512")}}).call(this,n(30),n(31).Buffer)},function(e,t,n){"use strict";(function(e,i){n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var s=n(889);const o=[139,1];function r(t){const n=e.alloc(o.length+t.length+1);n.set(o,0),n.set(t,o.length);let i=0;for(let e=0;e<n.length-1;++e)i^=n[e];n[n.length-1]=i;return s.encode(n).match(/.{1,4}/g).join(" ")}function a(e){const t=s.decode(e.replace(/ /g,""));let n=0;for(const e of t)n^=e;if(0!==n)throw new Error("Incorrect parity");for(let e=0;e<o.length;++e)if(t[e]!==o[e])throw new Error("Incorrect prefix");if(t.length!==o.length+i.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(o.length,o.length+i.Olm.PRIVATE_KEY_LENGTH))}}).call(this,n(31).Buffer,n(30))},function(e,t,n){"use strict";var i;let s;n.d(t,"a",(function(){return s})),function(e){e.RoomId="room_id",e.Sender="sender"}(i||(i={})),function(e){e.Recent="recent",e.Rank="rank"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return l}));var i=n(17),s=n.n(i),o=n(0),r=n(7);let a;!function(e){e.Password="m.login.password",e.Recaptcha="m.login.recaptcha",e.Terms="m.login.terms",e.Email="m.login.email.identity",e.Msisdn="m.login.msisdn",e.Sso="m.login.sso",e.SsoUnstable="org.matrix.login.sso",e.Dummy="m.login.dummy",e.RegistrationToken="m.login.registration_token",e.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token"}(a||(a={}));class c extends Error{constructor(e,t,n){super(e),this.required_stages=t,this.flows=n,s()(this,"name","NoAuthFlowFoundError")}}class l{constructor(e){var t;s()(this,"matrixClient",void 0),s()(this,"inputs",void 0),s()(this,"clientSecret",void 0),s()(this,"requestCallback",void 0),s()(this,"busyChangedCallback",void 0),s()(this,"stateUpdatedCallback",void 0),s()(this,"requestEmailTokenCallback",void 0),s()(this,"data",void 0),s()(this,"emailSid",void 0),s()(this,"requestingEmailToken",!1),s()(this,"attemptAuthDeferred",null),s()(this,"chosenFlow",null),s()(this,"currentStage",null),s()(this,"emailAttempt",1),s()(this,"submitPromise",null),s()(this,"requestEmailToken",async()=>{if(this.requestingEmailToken)o.a.warn("Could not request email token: Already requesting");else{o.a.trace("Requesting email token. Attempt: "+this.emailAttempt),this.requestingEmailToken=!0;try{const e=await this.requestEmailTokenCallback(this.inputs.emailAddress,this.clientSecret,this.emailAttempt++,this.data.session);this.emailSid=e.sid,o.a.trace("Email token request succeeded")}finally{this.requestingEmailToken=!1}}}),this.matrixClient=e.matrixClient,this.data=e.authData||{},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=null!==(t=e.emailSid)&&void 0!==t?t:null}attemptAuth(){var e;this.attemptAuthDeferred=Object(r.l)();const t=this.attemptAuthDeferred.promise;if(null!==(e=this.data)&&void 0!==e&&e.flows)this.startNextAuthStage();else{var n;null===(n=this.busyChangedCallback)||void 0===n||n.call(this,!0);let e=null;this.data.session&&(e={session:this.data.session}),this.doRequest(e).finally(()=>{var e;null===(e=this.busyChangedCallback)||void 0===e||e.call(this,!1)})}return t}async poll(){if(!this.data.session)return;if(!this.attemptAuthDeferred)return;if(this.submitPromise)return;let e={};if("m.login.email.identity"==this.currentStage&&this.emailSid){const t={sid:this.emailSid,client_secret:this.clientSecret};if(await this.matrixClient.doesServerRequireIdServerParam()){const e=new URL(this.matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:"m.login.email.identity",threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)}getSessionId(){return this.data?this.data.session:void 0}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null===(t=this.data.params)||void 0===t?void 0:t[e]}getChosenFlow(){return this.chosenFlow}async submitAuthDict(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");var n;t||(null===(n=this.busyChangedCallback)||void 0===n||n.call(this,!0));for(;this.submitPromise;)try{await this.submitPromise}catch(e){}let i;this.data.session?(i={session:this.data.session},Object.assign(i,e)):i=e;try{this.submitPromise=this.doRequest(i,t),await this.submitPromise}finally{var s;if(this.submitPromise=null,!t)null===(s=this.busyChangedCallback)||void 0===s||s.call(this,!1)}}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}async doRequest(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{const n=await this.requestCallback(e,t);this.attemptAuthDeferred.resolve(n),this.attemptAuthDeferred=null}catch(e){var n,i;const r=null!==(n=null===(i=e.data)||void 0===i?void 0:i.flows)&&void 0!==n?n:null,c=this.data.flows||Boolean(r);var s;if(401!==e.httpStatus||!e.data||!c)if(t)o.a.log("Background poll request failed doing UI auth: ignoring",e);else null===(s=this.attemptAuthDeferred)||void 0===s||s.reject(e);e.data.flows||e.data.completed||e.data.session||(e.data.flows=this.data.flows,e.data.completed=this.data.completed,e.data.session=this.data.session),this.data=e.data;try{this.startNextAuthStage()}catch(e){return this.attemptAuthDeferred.reject(e),void(this.attemptAuthDeferred=null)}if(!this.emailSid&&this.chosenFlow.stages.includes(a.Email))try{await this.requestEmailToken()}catch(e){this.attemptAuthDeferred.reject(e),this.attemptAuthDeferred=null}}}startNextAuthStage(){const e=this.chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this.currentStage=e,e===a.Dummy)return void this.submitAuthDict({type:"m.login.dummy"});if(this.data&&this.data.errcode||this.data.error)return void this.stateUpdatedCallback(e,{errcode:this.data.errcode||"",error:this.data.error||""});const t={};"m.login.email.identity"==e&&(t.emailSid=this.emailSid),this.stateUpdatedCallback(e,t)}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),o.a.log("Active flow => %s",JSON.stringify(this.chosenFlow));const e=this.firstUncompletedStage(this.chosenFlow);return o.a.log("Next stage: %s",e),e}chooseFlow(){const e=this.data.flows||[],t=Boolean(this.inputs.emailAddress)||Boolean(this.emailSid),n=Boolean(this.inputs.phoneCountry)&&Boolean(this.inputs.phoneNumber);for(const i of e){let e=!1,s=!1;for(const t of i.stages)"m.login.email.identity"===t?e=!0:"m.login.msisdn"==t&&(s=!0);if(e==t&&s==n)return i}const i=[];throw t&&i.push("m.login.email.identity"),n&&i.push("m.login.msisdn"),new c("No appropriate authentication flow found",i,e)}firstUncompletedStage(e){const t=this.data.completed||[];for(let n=0;n<e.stages.length;++n){const i=e.stages[n];if(-1===t.indexOf(i))return i}}}},,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(88),s=n.n(i),o=n(321);class r extends o.a{static set matrixClient(e){const t=r._matrixClient;r._matrixClient=e;for(const n of r.instances)n.initMatrixClient(t,e)}constructor(){super(),r.instances.push(this)}get client(){return r._matrixClient}}s()(r,"_matrixClient",void 0),s()(r,"instances",[])},function(e,t,n){"use strict";n.d(t,"g",(function(){return m})),n.d(t,"a",(function(){return p})),n.d(t,"f",(function(){return g})),n.d(t,"e",(function(){return f})),n.d(t,"c",(function(){return y})),n.d(t,"d",(function(){return S})),n.d(t,"b",(function(){return E}));var i=n(598),s=n(425),o=n(187),r=n(0),a=n(162);const c=window.localStorage;let l;try{l=window.indexedDB}catch(e){}function d(e){r.a.log("StorageManager: "+e)}function u(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];r.a.error("StorageManager: "+e,...n)}function h(e){a.a.trackEvent("StorageManager",e)}function m(){navigator.storage&&navigator.storage.persist?navigator.storage.persist().then(e=>{r.a.log("StorageManager: Persistent?",e)}):document.requestStorageAccess?document.requestStorageAccess().then(()=>r.a.log("StorageManager: Persistent?",!0),()=>r.a.log("StorageManager: Persistent?",!1)):r.a.log("StorageManager: Persistence unsupported")}async function p(){d("Checking storage consistency"),d("Local storage supported? "+!!c),d("IndexedDB supported? "+!!l);let e=!1,t=!1,n=!1,r=!0;if(c?(e=c.length>0,d("Local storage contains data? "+e),n=!!c.getItem("mx_crypto_initialised"),d("Crypto initialised? "+n)):(r=!1,u("Local storage cannot be used on this browser"),h("Local storage disabled")),l&&c){(await async function(){let e=!1;try{return e=await s.a.exists(l,"riot-web-sync"),d("Sync store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){u("Sync store using IndexedDB inaccessible",e),h("Sync store using IndexedDB inaccessible")}return d("Sync store using memory only"),{exists:e,healthy:!1}}()).healthy||(r=!1)}else r=!1,u("Sync store cannot be used on this browser"),h("Sync store disabled");if(l){const e=await async function(){let e=!1;try{return e=await o.a.exists(l,"matrix-js-sdk:crypto"),d("Crypto store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){u("Crypto store using IndexedDB inaccessible",e),h("Crypto store using IndexedDB inaccessible")}try{return e=i.a.exists(c),d("Crypto store using local storage contains data? "+e),{exists:e,healthy:!0}}catch(e){u("Crypto store using local storage inaccessible",e),h("Crypto store using local storage inaccessible")}return d("Crypto store using memory only"),{exists:e,healthy:!1}}();t=e.exists,e.healthy||(r=!1)}else r=!1,u("Crypto store cannot be used on this browser"),h("Crypto store disabled");return e&&n&&!t&&(r=!1,u("Data exists in local storage and crypto is marked as initialised  but no data found in crypto store. IndexedDB storage has likely been evicted by the browser!"),h("Crypto store evicted")),r?(d("Storage consistency checks passed"),h("Consistency checks passed")):(u("Storage consistency checks failed"),h("Consistency checks failed")),{dataInLocalStorage:e,dataInCryptoStore:t,cryptoInited:n,healthy:r}}function g(e){var t,n;null===(t=e.store)||void 0===t||null===(n=t.on)||void 0===n||n.call(t,"degraded",()=>{h("Sync store using IndexedDB degraded to memory")})}function f(e){c.setItem("mx_crypto_initialised",String(e))}let v=null;async function b(){if(!l)throw new Error("IndexedDB not available");v=await new Promise((e,t)=>{const n=l.open("matrix-react-sdk",1);n.onerror=t,n.onsuccess=()=>{e(n.result)},n.onupgradeneeded=()=>{const e=n.result;e.createObjectStore("pickleKey"),e.createObjectStore("account")}})}async function y(e,t){return v||await b(),new Promise((n,i)=>{const s=v.transaction([e],"readonly");s.onerror=i;const o=s.objectStore(e).get(t);o.onerror=i,o.onsuccess=e=>{n(o.result)}})}async function S(e,t,n){return v||await b(),new Promise((i,s)=>{const o=v.transaction([e],"readwrite");o.onerror=s;const r=o.objectStore(e).put(n,t);r.onerror=s,r.onsuccess=e=>{i()}})}async function E(e,t){return v||await b(),new Promise((n,i)=>{const s=v.transaction([e],"readwrite");s.onerror=i;const o=s.objectStore(e).delete(t);o.onerror=i,o.onsuccess=()=>{n()}})}},,function(e,t,n){"use strict";n.d(t,"c",(function(){return a})),n.d(t,"d",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d}));var i=n(225),s=n(0),o=n(98),r=n(90);function a(){return o.b.get("validated_server_config").isUrl}function c(){const e=a();r.a.get().setAccountData("m.identity_server",{base_url:e})}async function l(e){let t;try{t=await r.a.get().getTerms(i.a.IS,e)}catch(e){if(s.a.error(e),"rejected"!==e.cors&&404!==e.httpStatus)throw e;t=null}return t&&t.policies&&Object.keys(t.policies).length>0}function d(){const e=r.a.get().getAccountData("m.identity_server");return e&&e.getContent()&&e.getContent().base_url}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}));const i=/^\S+@\S+\.\S+$/,s=/^@\S+:\S+$/,o=/^!\S+:\S+$/;let r;!function(e){e.Email="email",e.MatrixUserId="mx-user-id",e.MatrixRoomId="mx-room-id"}(r||(r={}));r.Email,r.MatrixRoomId,r.MatrixUserId;function a(e){return i.test(e)?r.Email:s.test(e)?r.MatrixUserId:o.test(e)?r.MatrixRoomId:null}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s}));const i="filter_changed";let s;!function(e){e[e.Prefilter=0]="Prefilter",e[e.Runtime=1]="Runtime"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));const i=new Map;function s(e,t){i.set(e,t)}function o(e){return i.get(e)}},,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(87);const s=n.n(i).a.createContext({isCard:!1})},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(108),s=n(0),o=n(90),r=n(92);class a{static resendUnsentEvents(e){return Promise.all(e.getPendingEvents().filter((function(e){return e.status===i.a.NOT_SENT})).map((function(e){return a.resend(e)})))}static cancelUnsentEvents(e){e.getPendingEvents().filter((function(e){return e.status===i.a.NOT_SENT})).forEach((function(e){a.removeFromQueue(e)}))}static resend(e){const t=o.a.get().getRoom(e.getRoomId());return o.a.get().resendEvent(e,t).then((function(t){r.a.dispatch({action:"message_sent",event:e})}),(function(e){s.a.log("Resend got send failure: "+e.name+"("+e+")")}))}static removeFromQueue(e){o.a.get().cancelPendingEvent(e)}}},function(e,t,n){"use strict";n.d(t,"f",(function(){return u})),n.d(t,"d",(function(){return h})),n.d(t,"e",(function(){return m})),n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return f})),n.d(t,"c",(function(){return v}));var i=n(87),s=n.n(i),o=n(89),r=n(105),a=n(208),c=n(100),l=n(169),d=n(493);const u=e=>JSON.stringify(e,null,2),h=e=>({id:"eventType",label:Object(o.c)("Event Type"),default:e}),m=e=>({id:"stateKey",label:Object(o.c)("State Key"),default:e}),p=Object(l.a)({deriveData(e){let{value:t}=e;try{JSON.parse(t)}catch(e){return e}},rules:[{key:"validJson",test:(e,t)=>{let{value:n}=e;return!n||!t},invalid:e=>Object(o.a)("Doesn't look like valid JSON.")+" "+e}]}),g=e=>{let{fieldDefs:t,defaultContent:n="{\n\n}",onSend:c,onBack:l}=e;const[d,u]=Object(i.useState)(t.map(e=>{var t;return null!==(t=e.default)&&void 0!==t?t:""})),[h,m]=Object(i.useState)(n),g=Object(i.useRef)(),f=t.map((e,t)=>s.a.createElement(r.a,{key:e.id,id:e.id,label:Object(o.a)(e.label),size:42,autoFocus:void 0===n&&0===t,type:"text",autoComplete:"on",value:d[t],onChange:e=>u(n=>(n[t]=e.target.value,[...n]))}));return s.a.createElement(a.b,{actionLabel:Object(o.a)("Send"),onAction:async()=>{if(!await g.current.validate({}))return g.current.focus(),void g.current.validate({focused:!0});try{const e=JSON.parse(h);await c(d,e)}catch(e){return Object(o.a)("Failed to send event!")+` (${e.toString()})`}return Object(o.a)("Event sent!")},onBack:l},s.a.createElement("div",{className:"mx_DevTools_eventTypeStateKeyGroup"},f),s.a.createElement(r.a,{id:"evContent",label:Object(o.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:h,onChange:e=>m(e.target.value),element:"textarea",onValidate:p,ref:g,autoFocus:!!n}))},f=e=>{let{mxEvent:t,onBack:n,Editor:r}=e;const[c,l]=Object(i.useState)(!1);if(c){const e=()=>{l(!1)};return s.a.createElement(r,{mxEvent:t,onBack:e})}return s.a.createElement(a.b,{onBack:n,actionLabel:Object(o.a)("Edit"),onAction:async()=>{l(!0)}},s.a.createElement(d.a,{language:"json"},u(t.event)))},v=e=>{let{mxEvent:t,onBack:n}=e;const o=Object(i.useContext)(a.a),r=Object(i.useContext)(c.a),l=Object(i.useMemo)(()=>[h(null==t?void 0:t.getType())],[t]);let d;if(t){var m,p;const e=t.getContent(),n=null!==(m=null===(p=e["m.new_content"])||void 0===p?void 0:p.body)&&void 0!==m?m:e.body,i={body:" * "+n,msgtype:e.msgtype,"m.new_content":{body:n,msgtype:e.msgtype},"m.relates_to":{rel_type:"m.replace",event_id:(f=t,null!==(b=null===(y=(null!==(v=f.replacingEvent())&&void 0!==v?v:f).getWireContent()["m.relates_to"])||void 0===y?void 0:y.event_id)&&void 0!==b?b:f.getId())}};d=u(i)}var f,v,b,y;return s.a.createElement(g,{fieldDefs:l,defaultContent:d,onSend:(e,t)=>{let[n]=e;return r.sendEvent(o.room.roomId,n,t)},onBack:n})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(89);let s;!function(e){e.MapStyleUrlNotConfigured="MapStyleUrlNotConfigured",e.MapStyleUrlNotReachable="MapStyleUrlNotReachable",e.Default="Default"}(s||(s={}));const o=e=>{switch(e){case s.MapStyleUrlNotConfigured:return Object(i.a)("This homeserver is not configured to display maps.");case s.MapStyleUrlNotReachable:default:return Object(i.a)("This homeserver is not configured correctly to display maps, or the configured map server may be unreachable.")}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(335),s=n.n(i),o=n(89);function r(e){var t,n;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(o.a)("Attachment"),r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=i;if((null===(t=e.body)||void 0===t?void 0:t.length)>0&&(c=e.body),a&&c.length>19){const e=c.split(".");let t=e.slice(0,e.length-1).join(".").substring(0,15);const n=e[e.length-1];t=t.replace(/\.*$/g,""),c=`${t}...${n}`}return null!==(n=e.info)&&void 0!==n&&n.size&&r&&(c+=" ("+s()(e.info.size)+")"),c}},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));var i=n(121);function s(e,t){const n=[...e.keys()],s=[...t.keys()],o=Object(i.a)(n,s);return{changed:Object(i.f)(n,s).filter(n=>e.get(n)!==t.get(n)),added:o.added,removed:o.removed}}class o extends Map{constructor(e){super(e)}getOrCreate(e,t){return this.has(e)?this.get(e):(this.set(e,t),t)}remove(e){const t=this.get(e);return this.delete(e),t}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(0),c=n(93),l=n(297),d=n(176),u=n(114),h=n(109);const m=function(){if(c.b.getValue("debug_scroll_panel")){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];a.a.log.call(console,"ScrollPanel debuglog:",...t)}};class p extends r.a.Component{constructor(e,t){var n,i;super(e,t),n=this,s()(this,"pendingFillRequests",{b:null,f:null}),s()(this,"itemlist",Object(o.createRef)()),s()(this,"unmounted",!1),s()(this,"scrollTimeout",void 0),s()(this,"isFilling",void 0),s()(this,"isFillingDueToPropsUpdate",!1),s()(this,"fillRequestWhileRunning",void 0),s()(this,"pendingFillDueToPropsUpdate",void 0),s()(this,"scrollState",void 0),s()(this,"preventShrinkingState",void 0),s()(this,"unfillDebouncer",void 0),s()(this,"bottomGrowth",void 0),s()(this,"minListHeight",void 0),s()(this,"heightUpdateInProgress",void 0),s()(this,"divScroll",void 0),s()(this,"onScroll",e=>{this.props.resizeNotifier&&this.props.resizeNotifier.isResizing||(m("onScroll",this.getScrollNode().scrollTop),this.scrollTimeout.restart(),this.saveScrollState(),this.updatePreventShrinking(),this.props.onScroll(e),this.checkFillState())}),s()(this,"onResize",()=>{m("onResize"),this.checkScroll(),this.preventShrinkingState&&this.preventShrinking()}),s()(this,"checkScroll",(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];n.unmounted||(n.restoreSavedScrollState(),n.checkFillState(0,e))})),s()(this,"isAtBottom",()=>{const e=this.getScrollNode();return e.scrollHeight-(e.scrollTop+e.clientHeight)<=1}),s()(this,"checkFillState",(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(n.unmounted)return;const i=0===e,s=n.getScrollNode();if(i){if(n.isFilling&&!n.isFillingDueToPropsUpdate)return m("isFilling: not entering while request is ongoing, marking for a subsequent request"),n.fillRequestWhileRunning=!0,void(n.pendingFillDueToPropsUpdate=t);m("isFilling: setting"),n.isFilling=!0,n.isFillingDueToPropsUpdate=t}const o=n.itemlist.current,r=o&&o.firstElementChild,c=r&&r.offsetTop,l=[];if((!r||s.scrollTop-c<s.clientHeight)&&l.push(n.maybeFill(e,!0)),s.scrollHeight-s.scrollTop<2*s.clientHeight&&l.push(n.maybeFill(e,!1)),l.length)try{await Promise.all(l)}catch(e){a.a.error(e)}if(i&&(m("isFilling: clearing"),n.isFilling=!1,n.isFillingDueToPropsUpdate=!1),n.fillRequestWhileRunning){const e=n.pendingFillDueToPropsUpdate;n.fillRequestWhileRunning=!1,n.pendingFillDueToPropsUpdate=!1,n.checkFillState(0,e)}})),s()(this,"getScrollState",()=>this.scrollState),s()(this,"resetScrollState",()=>{this.scrollState={stuckAtBottom:this.props.startAtBottom},this.bottomGrowth=0,this.minListHeight=0,this.scrollTimeout=new l.a(100),this.heightUpdateInProgress=!1}),s()(this,"scrollToTop",()=>{this.getScrollNode().scrollTop=0,this.saveScrollState()}),s()(this,"scrollToBottom",()=>{const e=this.getScrollNode();e.scrollTop=e.scrollHeight,this.saveScrollState()}),s()(this,"scrollRelative",e=>{const t=this.getScrollNode(),n=e*t.clientHeight*.9;t.scrollBy(0,n),this.saveScrollState()}),s()(this,"handleScrollKey",e=>{switch(Object(u.a)().getRoomAction(e)){case h.h.ScrollUp:this.scrollRelative(-1);break;case h.h.ScrollDown:this.scrollRelative(1);break;case h.h.JumpToFirstMessage:this.scrollToTop();break;case h.h.JumpToLatestMessage:this.scrollToBottom()}}),s()(this,"scrollToToken",(e,t,n)=>{t=t||0,n=n||0,this.scrollState={stuckAtBottom:!1,trackedScrollToken:e};const i=this.getTrackedNode(),s=this.getScrollNode();i&&(m("scrollToken: setting scrollTop",{offsetBase:n,pixelOffset:t,offsetTop:i.offsetTop}),s.scrollTop=i.offsetTop-s.clientHeight*n+t,this.saveScrollState())}),s()(this,"collectScroll",e=>{this.divScroll=e}),s()(this,"preventShrinking",()=>{const e=this.itemlist.current,t=e&&e.children;if(!e)return;let n;for(let e=t.length-1;e>=0;e--){const i=t[e];if(i.dataset.scrollTokens){n=i;break}}if(!n)return;this.clearPreventShrinking();const i=e.clientHeight-(n.offsetTop+n.clientHeight);this.preventShrinkingState={offsetFromBottom:i,offsetNode:n},m("prevent shrinking, last tile ",i,"px from bottom")}),s()(this,"clearPreventShrinking",()=>{const e=this.itemlist.current,t=e&&e.parentElement;t&&(t.style.paddingBottom=null),this.preventShrinkingState=null,m("prevent shrinking cleared")}),s()(this,"updatePreventShrinking",()=>{if(this.preventShrinkingState){const e=this.getScrollNode(),t=this.scrollState,n=this.itemlist.current,{offsetNode:i,offsetFromBottom:s}=this.preventShrinkingState,o=n.parentElement;let r=!i.parentElement;if(!r&&!t.stuckAtBottom){r=e.scrollHeight-(e.scrollTop+e.clientHeight)>=200}if(!r){const e=s-(n.clientHeight-(i.offsetTop+i.clientHeight));e>0?(o.style.paddingBottom=e+"px",m("update prevent shrinking ",e,"px from bottom")):e<0&&(r=!0)}r&&this.clearPreventShrinking()}}),null===(i=this.props.resizeNotifier)||void 0===i||i.on("middlePanelResizedNoisy",this.onResize),this.resetScrollState()}componentDidMount(){this.checkScroll()}componentDidUpdate(){this.checkScroll(!0),this.updatePreventShrinking()}componentWillUnmount(){var e;this.unmounted=!0,null===(e=this.props.resizeNotifier)||void 0===e||e.removeListener("middlePanelResizedNoisy",this.onResize)}getExcessHeight(e){const t=this.getScrollNode(),n=this.getMessagesHeight(),i=n-this.getListHeight(),s=t.scrollTop+i;return e?s-t.clientHeight-6e3:n-(s+2*t.clientHeight)-6e3}checkUnfillState(e){let t=this.getExcessHeight(e);if(t<=0)return;const n=t,i=this.itemlist.current.children;let s,o=null;for(let n=0;n<i.length&&(s=i[e?n:i.length-1-n],t-=s.clientHeight,!(s.clientHeight>t));n++)s.dataset.scrollTokens&&(o=s.dataset.scrollTokens.split(",")[0]);o&&(this.unfillDebouncer&&clearTimeout(this.unfillDebouncer),this.unfillDebouncer=setTimeout(()=>{this.unfillDebouncer=null,m("unfilling now",e,n),this.props.onUnfillRequest(e,o)},200))}maybeFill(e,t){const n=t?"b":"f";if(!this.pendingFillRequests[n])return m("starting "+n+" fill"),this.pendingFillRequests[n]=!0,new Promise(e=>setTimeout(e,1)).then(()=>this.props.onFillRequest(t)).finally(()=>{this.pendingFillRequests[n]=!1}).then(i=>{if(!this.unmounted)return this.checkUnfillState(!t),m(n+" fill complete; hasMoreResults:"+i),i?this.checkFillState(e+1):void 0});m("Already a "+n+" fill in progress - not starting another")}saveScrollState(){if(this.props.stickyBottom&&this.isAtBottom())return this.scrollState={stuckAtBottom:!0},void m("saved stuckAtBottom state");const e=this.getScrollNode(),t=e.scrollHeight-(e.scrollTop+e.clientHeight),n=this.itemlist.current.children;let i=null;for(let e=n.length-1;e>=0&&!(n[e].dataset.scrollTokens&&(i=n[e],this.topFromBottom(i)>t));--e);if(!i)return void m("unable to save scroll state: found no children in the viewport");const s=i.dataset.scrollTokens.split(",")[0];m("saving anchored scroll state to message",i.innerText,s);const o=this.topFromBottom(i);this.scrollState={stuckAtBottom:!1,trackedNode:i,trackedScrollToken:s,bottomOffset:o,pixelOffset:o-t}}async restoreSavedScrollState(){const e=this.scrollState;if(e.stuckAtBottom){const e=this.getScrollNode();e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight)}else if(e.trackedScrollToken){const t=this.itemlist.current,n=this.getTrackedNode();if(n){const i=this.topFromBottom(n),s=i-e.bottomOffset;this.bottomGrowth+=s,e.bottomOffset=i;const o=this.getListHeight()+"px";t.style.height!==o&&(t.style.height=o),m("balancing height because messages below viewport grew by",s)}}if(this.heightUpdateInProgress)m("not updating height because request already in progress");else{this.heightUpdateInProgress=!0;try{await this.updateHeight()}finally{this.heightUpdateInProgress=!1}}}async updateHeight(){if(this.scrollTimeout.isRunning()?(m("updateHeight waiting for scrolling to end ... "),await this.scrollTimeout.finished()):m("updateHeight getting straight to business, no scrolling going on."),this.unmounted)return;const e=this.getScrollNode(),t=this.itemlist.current,n=this.getMessagesHeight();n<e.clientHeight?this.minListHeight=e.clientHeight:this.minListHeight=400*Math.ceil(n/400),this.bottomGrowth=0;const i=this.getListHeight()+"px",s=this.scrollState;if(s.stuckAtBottom)t.style.height!==i&&(t.style.height=i),e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight),m("updateHeight to",i);else if(s.trackedScrollToken){const n=this.getTrackedNode();if(n){const s=n.offsetTop;t.style.height!==i&&(t.style.height=i);const o=n.offsetTop-s;e.scrollBy(0,o),m("updateHeight to",{newHeight:i,topDiff:o})}}}getTrackedNode(){const e=this.scrollState,t=e.trackedNode;if(null==t||!t.parentElement){let t;const i=this.itemlist.current.children,s=e.trackedScrollToken;for(let e=i.length-1;e>=0;--e){var n;const o=i[e];if(null!==(n=o.dataset.scrollTokens)&&void 0!==n&&n.split(",").includes(s)){t=o;break}}t&&m("had to find tracked node again for "+e.trackedScrollToken),e.trackedNode=t}if(e.trackedNode)return e.trackedNode;m("No node with ; '"+e.trackedScrollToken+"'")}getListHeight(){return this.bottomGrowth+this.minListHeight}getMessagesHeight(){const e=this.itemlist.current,t=e.lastElementChild;return(t?t.offsetTop+t.clientHeight:0)-(e.firstElementChild?e.firstElementChild.offsetTop:0)+36}topFromBottom(e){return this.itemlist.current.clientHeight-e.offsetTop}getScrollNode(){if(this.unmounted)throw new Error("ScrollPanel.getScrollNode called when unmounted");if(!this.divScroll)throw new Error("ScrollPanel.getScrollNode called before AutoHideScrollbar ref collected");return this.divScroll}render(){return r.a.createElement(d.a,{wrappedRef:this.collectScroll,onScroll:this.onScroll,className:"mx_ScrollPanel "+this.props.className,style:this.props.style},this.props.fixedChildren,r.a.createElement("div",{className:"mx_RoomView_messageListWrapper"},r.a.createElement("ol",{ref:this.itemlist,className:"mx_RoomView_MessageList","aria-live":"polite"},this.props.children)))}}s()(p,"defaultProps",{stickyBottom:!0,startAtBottom:!0,onFillRequest:function(e){return Promise.resolve(!1)},onUnfillRequest:function(e,t){},onScroll:function(){}})},,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return d}));var i=n(97),s=n(90),o=n(641),r=n(217);function a(e){const t=e.getType(),n=e.getContent(),s=e.getPrevContent();return t===i.b.RoomMember&&s.membership!==n.membership||(t!==i.b.RoomMember||s.displayname===n.displayname)&&(t!==i.b.RoomMember||s.avatar_url===n.avatar_url)}const c=e=>{let t="";s.a.get()&&(t=s.a.get().getUserId());const n={};return e.sort((e,i)=>{var s,o;const r=null!==(s=n[e.roomId])&&void 0!==s?s:l(e,t),a=null!==(o=n[i.roomId])&&void 0!==o?o:l(i,t);return n[e.roomId]=r,n[i.roomId]=a,a-r})},l=(e,t)=>(()=>{var n,s;if(null==e||!e.timeline)return Number.MAX_SAFE_INTEGER;if(Object(r.b)(e.getMyMembership())!==r.a.Join){const n=e.currentState.getStateEvents(i.b.RoomMember,t);if(n&&!Array.isArray(n))return n.getTs()}for(let n=e.timeline.length-1;n>=0;--n){const i=e.timeline[n];if(i.getTs()&&(i.getSender()===t&&a(i)||o.b(i)))return i.getTs()}return null!==(n=null===(s=e.timeline[0])||void 0===s?void 0:s.getTs())&&void 0!==n?n:Number.MAX_SAFE_INTEGER})();class d{sortRooms(e,t){return c(e)}getLastTs(e,t){return l(e,t)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(88),s=n.n(i),o=n(0),r=n(97),a=n(183),c=n(90),l=n(135),d=n(156),u=n(745),h=n(301);class m{constructor(){s()(this,"virtualToNativeRoomIdCache",new Map)}static sharedInstance(){return void 0===window.mxVoipUserMapper&&(window.mxVoipUserMapper=new m),window.mxVoipUserMapper}async userToVirtualUser(e){const t=await d.b.instance.sipVirtualLookup(e);return 0!==t.length&&t[0].fields.lookup_success?t[0].userid:null}async getVirtualUserForRoom(e){const t=l.a.shared().getUserIdForRoomId(e);if(!t)return null;const n=await this.userToVirtualUser(t);return n||null}async getOrCreateVirtualRoomForRoom(e){const t=await this.getVirtualUserForRoom(e);if(!t)return null;const n=await Object(a.d)(c.a.get(),t,e);return c.a.get().setRoomAccountData(n,u.a,{native_room:e}),this.virtualToNativeRoomIdCache.set(n,e),n}async getVirtualRoomForRoom(e){const t=await this.getVirtualUserForRoom(e);return t?Object(h.c)(c.a.get(),t):null}nativeRoomForVirtualRoom(e){const t=this.virtualToNativeRoomIdCache.get(e);if(t)return o.a.log("Returning native room ID "+t+" for virtual room ID "+e+" from cache"),t;const n=c.a.get().getRoom(e);if(!n)return null;const i=n.getAccountData(u.a);if(!i||!i.getContent())return null;const s=i.getContent().native_room,r=c.a.get().getRoom(s);return r&&"join"===r.getMyMembership()?s:null}isVirtualRoom(e){if(this.nativeRoomForVirtualRoom(e.roomId))return!0;if(this.virtualToNativeRoomIdCache.has(e.roomId))return!0;const t=e.currentState.getStateEvents(r.b.RoomCreate,"");if(!t||!t.getContent())return!1;if(t.getSender()!==c.a.get().getUserId())return!1;const n=t.getContent()[u.a];return Boolean(n)}async onNewInvitedRoom(e){if(!d.b.instance.getSupportsVirtualRooms())return;const t=e.getDMInviter();o.a.log(`Checking virtual-ness of room ID ${e.roomId}, invited by ${t}`);const n=await d.b.instance.sipNativeLookup(t);if(0!==n.length&&n[0].fields.is_virtual){const t=n[0].userid,i=Object(h.c)(c.a.get(),t);i&&(c.a.get().setRoomAccountData(e.roomId,u.a,{native_room:i.roomId}),c.a.get().joinRoom(e.roomId)),this.virtualToNativeRoomIdCache.set(e.roomId,i.roomId)}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return f})),n.d(t,"b",(function(){return v}));var i=n(88),s=n.n(i),o=n(97),r=n(0),a=n(119),c=n(193),l=n(95),d=n(89),u=n(107),h=n(131),m=n(102);function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}async function f(e,t){const n=e.getRoom(t);return n||new Promise(n=>{const i=s=>{s.roomId===t&&(n(s),e.off(a.b.Room,i))};e.on(a.b.Room,i)})}async function v(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],p=arguments.length>5&&void 0!==arguments[5]&&arguments[5],v=arguments.length>6?arguments[6]:void 0;const b=e.client;let y;v||(y=l.a.createDialog(m.a,null,"mx_Dialog_spinner"));let S=[];i&&(S=[...e.getMembersWithMembership("join"),...e.getMembersWithMembership("invite")].map(e=>e.userId).filter(e=>e!==b.getUserId()));let E=[];a&&(E=Array.from(h.a.instance.getKnownParents(e.roomId)).map(e=>b.getRoom(e)).filter(e=>null==e?void 0:e.currentState.maySendStateEvent(o.b.SpaceChild,b.getUserId())));const w={roomUpgraded:!1,roomSynced:!p&&!i&&void 0,inviteUsersProgress:i?0:void 0,inviteUsersTotal:S.length,updateSpacesProgress:a?0:void 0,updateSpacesTotal:E.length};let _;null==v||v(w);try{({replacement_room:_}=await b.upgradeRoom(e.roomId,t))}catch(e){if(!s)throw e;throw r.a.error(e),l.a.createTrackedDialog("Room Upgrade Error","",u.a,{title:Object(d.a)("Error upgrading room"),description:Object(d.a)("Double check that your server supports the room version chosen and try again.")}),e}if(w.roomUpgraded=!0,null==v||v(w),(p||i)&&(await f(e.client,_),w.roomSynced=!0,null==v||v(w)),S.length>0&&await Object(c.b)(_,S,!1,()=>{w.inviteUsersProgress++,null==v||v(w)}),E.length>0)try{for(const t of E){const n=t.currentState.getStateEvents(o.b.SpaceChild,e.roomId);await b.sendStateEvent(t.roomId,o.b.SpaceChild,g(g({},(null==n?void 0:n.getContent())||{}),{},{via:[b.getDomain()]}),_),await b.sendStateEvent(t.roomId,o.b.SpaceChild,{},e.roomId),w.updateSpacesProgress++,null==v||v(w)}}catch(e){r.a.warn("Failed to update parent spaces during room upgrade",e)}return null===(n=y)||void 0===n||n.close(),_}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.Send="send",e.Edit="edit"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}));const i={w:800,h:600},s={w:324,h:324},o={w:182.25,h:324};let r;function a(e,t,n){const a=t.w/t.h,c=a<1,l=e===r.Large?i:c?o:s;if(!t.w||!t.h)return l;const d={w:Math.min(l.w,t.w),h:n?Math.min(l.h,t.h,n):Math.min(l.h,t.h)};return d.h*a<d.w?{w:Math.floor(d.h*a),h:d.h}:{w:d.w,h:Math.floor(d.w/a)}}!function(e){e.Normal="normal",e.Large="large"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(87),s=n.n(i),o=n(133);class r extends s.a.Component{constructor(e){super(e)}shouldComponentUpdate(e){return Math.floor(this.props.seconds)!==Math.floor(e.seconds)}render(){return s.a.createElement("span",{"aria-live":this.props["aria-live"],className:"mx_Clock"},Object(o.j)(this.props.seconds))}}},,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(0),r=n(93),a=n(92),c=n(96),l=n(550),d=n(270),u=n(104);class h{constructor(){s()(this,"themeWatchRef",void 0),s()(this,"systemThemeWatchRef",void 0),s()(this,"dispatcherRef",void 0),s()(this,"preferDark",void 0),s()(this,"preferLight",void 0),s()(this,"preferHighContrast",void 0),s()(this,"currentTheme",void 0),s()(this,"onChange",()=>{this.recheck()}),s()(this,"onAction",e=>{e.action===c.a.RecheckTheme&&this.recheck(e.forceTheme)}),this.themeWatchRef=null,this.systemThemeWatchRef=null,this.dispatcherRef=null,this.preferDark=e.matchMedia("(prefers-color-scheme: dark)"),this.preferLight=e.matchMedia("(prefers-color-scheme: light)"),this.preferHighContrast=e.matchMedia("(prefers-contrast: more)"),this.currentTheme=this.getEffectiveTheme()}start(){this.themeWatchRef=r.b.watchSetting("theme",null,this.onChange),this.systemThemeWatchRef=r.b.watchSetting("use_system_theme",null,this.onChange),this.preferDark.addEventListener&&(this.preferDark.addEventListener("change",this.onChange),this.preferLight.addEventListener("change",this.onChange),this.preferHighContrast.addEventListener("change",this.onChange)),this.dispatcherRef=a.a.register(this.onAction)}stop(){this.preferDark.addEventListener&&(this.preferDark.removeEventListener("change",this.onChange),this.preferLight.removeEventListener("change",this.onChange),this.preferHighContrast.removeEventListener("change",this.onChange)),r.b.unwatchSetting(this.systemThemeWatchRef),r.b.unwatchSetting(this.themeWatchRef),a.a.unregister(this.dispatcherRef)}recheck(e){const t=this.currentTheme;this.currentTheme=void 0===e?this.getEffectiveTheme():e,t!==this.currentTheme&&Object(d.h)(this.currentTheme)}getEffectiveTheme(){if(l.a.isLogin)return"light";if(r.b.getValueAt(u.a.DEVICE,"use_system_theme",null,!1,!0)){o.a.log("returning explicit system theme");const e=this.themeBasedOnSystem();if(e)return e}const e=r.b.getValueAt(u.a.DEVICE,"theme",null,!1,!0);if(e)return o.a.log("returning explicit theme: "+e),e;if(r.b.getValue("use_system_theme")){const e=this.themeBasedOnSystem();if(e)return e}return o.a.log("returning theme value"),r.b.getValue("theme")}themeBasedOnSystem(){let e;if(this.preferDark.matches?e="dark":this.preferLight.matches&&(e="light"),this.preferHighContrast.matches){const t=Object(d.c)(e);t&&(e=t)}return e}isSystemThemeSupported(){return this.preferDark.matches||this.preferLight.matches}}}).call(this,n(30))},,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var i=n(17),s=n.n(i),o=n(311),r=n(443),a=n(7),c=n(599),l=n(0);function d(e,t,n){const i=e.openCursor(t);return new Promise((e,t)=>{const s=[];i.onerror=()=>{t(new Error("Query failed: "+i.error))},i.onsuccess=()=>{const t=i.result;t?(s.push(n(t)),t.continue()):e(s)}})}function u(e){return new Promise((t,n)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){n(e.error)}})}function h(e){return new Promise((t,n)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){n(e.error)}})}function m(e){return h(e).then(t=>e.result)}class p{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),c.a(e,t)}constructor(e,t){this.indexedDB=e,s()(this,"dbName",void 0),s()(this,"syncAccumulator",void 0),s()(this,"db",null),s()(this,"disconnected",!0),s()(this,"_isNewlyCreated",!1),s()(this,"isPersisting",!1),s()(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+(t||"default"),this.syncAccumulator=new r.b}connect(){if(!this.disconnected)return l.a.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,l.a.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this.dbName,3);return e.onupgradeneeded=t=>{const n=e.result,i=t.oldVersion;l.a.log("LocalIndexedDBStoreBackend.connect: upgrading from "+i),i<1&&(this._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(n)),i<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(n),i<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(n)},e.onblocked=()=>{l.a.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},l.a.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),h(e).then(()=>(l.a.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.result,this.db.onversionchange=()=>{this.db.close()},this.init()))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{let[t,n]=e;l.a.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:n.nextBatch,rooms:n.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,n)=>{const i=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),s=IDBKeyRange.only(e),o=i.openCursor(s),r=[];let a=!1;o.onsuccess=()=>{const e=o.result;if(!e)return r.length||a?t(r):t(null);const n=e.value;n.oob_written?a=!0:r.push(n),e.continue()},o.onerror=e=>{n(e)}}).then(t=>(l.a.log(`LL: got ${null==t?void 0:t.length} membershipEvents from storage for room ${e} ...`),t))}async setOutOfBandMembers(e,t){l.a.log("LL: backend about to store "+t.length+" members for "+e);const n=this.db.transaction(["oob_membership_events"],"readwrite"),i=n.objectStore("oob_membership_events");t.forEach(e=>{i.put(e)});const s={room_id:e,oob_written:!0,state_key:0};i.put(s),await u(n),l.a.log(`LL: backend done storing for ${e}!`)}async clearOutOfBandMembers(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),n=IDBKeyRange.only(e),i=m(t.openKeyCursor(n,"next")).then(e=>e&&e.primaryKey[1]),s=m(t.openKeyCursor(n,"prev")).then(e=>e&&e.primaryKey[1]),[o,r]=await Promise.all([i,s]),a=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),c=IDBKeyRange.bound([e,o],[e,r]);var d;l.a.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,o],[e,r]),await(d=a.delete(c),new Promise((e,t)=>{d.onsuccess=()=>e(d),d.onerror=e=>t(e)}))}clearDatabase(){return new Promise(e=>{l.a.log("Removing indexeddb instance: "+this.dbName);const t=this.indexedDB.deleteDatabase(this.dbName);t.onblocked=()=>{l.a.log(`can't yet delete indexeddb ${this.dbName} because it is open elsewhere`)},t.onerror=()=>{l.a.warn("unable to delete js-sdk store indexeddb: "+t.error),e()},t.onsuccess=()=>{l.a.log("Removed indexeddb instance: "+this.dbName),e()}})}getSavedSync(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(a.j(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}async syncToDatabase(e){const t=this.syncAccumulator.getJSON(!0);if(this.isPersisting)return l.a.warn("Skipping syncToDatabase() as persist already in flight"),void this.pendingUserPresenceData.push(...e);e.unshift(...this.pendingUserPresenceData),this.isPersisting=!0;try{await Promise.all([this.persistUserPresenceEvents(e),this.persistAccountData(t.accountData),this.persistSyncData(t.nextBatch,t.roomsData)])}finally{this.isPersisting=!1}}persistSyncData(e,t){return l.a.log("Persisting sync data up to",e),a.A(()=>{const n=this.db.transaction(["sync"],"readwrite");return n.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t}),u(n).then(()=>{l.a.log("Persisted sync data up to",e)})})}persistAccountData(e){return a.A(()=>{const t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(let t=0;t<e.length;t++)n.put(e[t]);return u(t).then()})}persistUserPresenceEvents(e){return a.A(()=>{const t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(const t of e)n.put({userId:t[0],event:t[1]});return u(t).then()})}getUserPresenceEvents(){return a.A(()=>d(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,e=>[e.value.userId,e.value.event]))}loadAccountData(){return l.a.log("LocalIndexedDBStoreBackend: loading account data..."),a.A(()=>d(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,e=>e.value).then(e=>(l.a.log("LocalIndexedDBStoreBackend: loaded account data"),e)))}loadSyncData(){return l.a.log("LocalIndexedDBStoreBackend: loading sync data..."),a.A(()=>d(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,e=>e.value).then(e=>(l.a.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&l.a.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))}getClientOptions(){return Promise.resolve().then(()=>d(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.options}).then(e=>e[0]))}async storeClientOptions(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await u(t)}}class g{constructor(e,t){this.workerFactory=e,this.dbName=t,s()(this,"worker",void 0),s()(this,"nextSeq",0),s()(this,"inFlight",{}),s()(this,"startPromise",null),s()(this,"onWorkerMessage",e=>{const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void l.a.error("Got reply from worker with no seq");const e=this.inFlight[t.seq];if(void 0===e)return void l.a.error("Got reply for unknown seq "+t.seq);if(delete this.inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const n=new Error(t.error.message);n.name=t.error.name,e.reject(n)}}else l.a.warn("Unrecognised message from worker: ",t)})}connect(){return this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}ensureStarted(){return null===this.startPromise&&(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("_setupWorker",[this.dbName]).then(()=>{l.a.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{const n=this.nextSeq++,i=Object(a.l)();return this.inFlight[n]=i,this.worker.postMessage({command:e,seq:n,args:t}),i.promise})}}var f=n(200),v=n(108),b=n(143);class y extends o.a{static exists(e,t){return p.exists(e,t)}constructor(e){if(super(e),s()(this,"backend",void 0),s()(this,"startedUp",!1),s()(this,"syncTs",0),s()(this,"userModifiedMap",{}),s()(this,"emitter",new b.b),s()(this,"on",this.emitter.on.bind(this.emitter)),s()(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),s()(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),s()(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),s()(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{l.a.log("Deleted indexeddb data.")},e=>{throw l.a.error("Failed to delete indexeddb data: "+e),e})))),s()(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();const e=[];for(const t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)})),s()(this,"setSyncData",this.degradable(e=>this.backend.setSyncData(e),"setSyncData")),s()(this,"getOutOfBandMembers",this.degradable(e=>this.backend.getOutOfBandMembers(e),"getOutOfBandMembers")),s()(this,"setOutOfBandMembers",this.degradable((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t)),"setOutOfBandMembers")),s()(this,"clearOutOfBandMembers",this.degradable(e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e)),"clearOutOfBandMembers")),s()(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),s()(this,"storeClientOptions",this.degradable(e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new g(e.workerFactory,e.dbName):this.backend=new p(e.indexedDB,e.dbName)}startup(){return this.startedUp?(l.a.log("IndexedDBStore.startup: already started"),Promise.resolve()):(l.a.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then(()=>(l.a.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{l.a.log("IndexedDBStore.startup: processing presence events"),e.forEach(e=>{let[t,n]=e;const i=new f.a(t);n&&i.setPresenceEvent(new v.b(n)),this.userModifiedMap[i.userId]=i.getLastModifiedTime(),this.storeUser(i)})}))}wantsSave(){return Date.now()-this.syncTs>3e5}save(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var n=this;const i=super[t];return async function(){for(var t=arguments.length,s=new Array(t),o=0;o<t;o++)s[o]=arguments[o];try{return await e.call(n,...s)}catch(e){l.a.error("IndexedDBStore failure, degrading to MemoryStore",e),n.emitter.emit("degraded",e);try{l.a.log("IndexedDBStore trying to delete degraded data"),await n.backend.clearDatabase(),l.a.log("IndexedDBStore delete after degrading succeeded")}catch(e){l.a.warn("IndexedDBStore delete after degrading failed",e)}if(i)return i.call(n,...s)}}}}},function(e,t,n){"use strict";n.d(t,"e",(function(){return h})),n.d(t,"d",(function(){return p})),n.d(t,"g",(function(){return g})),n.d(t,"c",(function(){return f})),n.d(t,"f",(function(){return v})),n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return S}));var i=n(88),s=n.n(i),o=n(972),r=n.n(o);class a{constructor(e){s()(this,"_regex",void 0);const t=r()(e,{extended:!1,globstar:!1}).toString().replace(/\\\?/g,".");this._regex=new RegExp(t.substring(1,t.length-1))}test(e){return this._regex.test(e)}}const c=["m.ban","org.matrix.mjolnir.ban"];function l(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return c.includes(e)?t?c[c.length-1]:"m.ban":null}class d{constructor(e,t,n,i){s()(this,"_glob",void 0),s()(this,"_entity",void 0),s()(this,"_action",void 0),s()(this,"_reason",void 0),s()(this,"_kind",void 0),this._glob=new a(e),this._entity=e,this._action=l(t,!1),this._reason=n,this._kind=i}get entity(){return this._entity}get reason(){return this._reason}get kind(){return this._kind}get recommendation(){return this._action}isMatch(e){return this._glob.test(e)}}var u=n(90);const h="m.policy.rule.user",m="m.policy.rule.room",p="m.policy.rule.server",g=[h,"m.room.rule.user","org.matrix.mjolnir.rule.user"],f=[m,"m.room.rule.room","org.matrix.mjolnir.rule.room"],v=[p,"m.room.rule.server","org.matrix.mjolnir.rule.server"],b=[...g,...f,...v];function y(e){return g.includes(e)?h:f.includes(e)?m:v.includes(e)?p:null}class S{constructor(e){s()(this,"_rules",[]),s()(this,"_roomId",void 0),this._roomId=e,this.updateList()}get roomId(){return this._roomId}get serverRules(){return this._rules.filter(e=>e.kind===p)}get userRules(){return this._rules.filter(e=>e.kind===h)}get roomRules(){return this._rules.filter(e=>e.kind===m)}async banEntity(e,t,n){await u.a.get().sendStateEvent(this._roomId,y(e),{entity:t,reason:n,recommendation:l("m.ban",!0)},"rule:"+t),this._rules.push(new d(t,"m.ban",n,y(e)))}async unbanEntity(e,t){await u.a.get().sendStateEvent(this._roomId,y(e),{},"rule:"+t),this._rules=this._rules.filter(n=>n.kind!==y(e)||n.entity!==t)}updateList(){this._rules=[];const e=u.a.get().getRoom(this._roomId);if(e)for(const t of b){const n=e.currentState.getStateEvents(t);for(const e of n){if(!e.getStateKey())continue;const n=y(t),i=e.getContent().entity,s=e.getContent().recommendation,o=e.getContent().reason;i&&s&&o&&this._rules.push(new d(i,s,o,n))}}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return O})),n.d(t,"b",(function(){return R}));var i=n(7),s=n(87),o=n.n(s),r=n(363),a=n(108),c=n(95),l=n(102),d=n(90),u=n(89),h=n(107),m=n(171),p=n(131),g=n(129),f=n(92),v=n(96),b=n(125),y=n(110),S=n(101),E=n(753);const w=e=>{const t=e.client.getUserId();return 100===e.getMember(t).powerLevelNorm&&e.getJoinedMembers().every(e=>e.userId===t||e.powerLevelNorm<100)};var _=e=>{let{space:t,onFinished:n}=e;const i=Object(s.useMemo)(()=>{const e=new Set(p.a.instance.getSpaceFilteredRoomIds(t.roomId));return p.a.instance.traverseSpace(t.roomId,n=>{t.roomId!==n&&e.add(n)},!1),Array.from(e).map(e=>t.client.getRoom(e)).filter(Boolean)},[t]),[r,a]=Object(s.useState)([]),c=Object(s.useMemo)(()=>new Set(r),[r]);let l,d;if(t.getJoinRule()!==b.c.Public&&(l=Object(u.a)("You won't be able to rejoin unless you are re-invited.")),w(t))d=Object(u.a)("You're the only admin of this space. Leaving it will mean no one has control over it.");else{r.filter(w).length>0&&(d=Object(u.a)("You're the only admin of some of the rooms or spaces you wish to leave. Leaving them will leave them without any admins."))}return o.a.createElement(S.a,{title:Object(u.a)("Leave %(spaceName)s",{spaceName:t.name}),className:"mx_LeaveSpaceDialog",contentId:"mx_LeaveSpaceDialog",onFinished:()=>n(!1),fixedWidth:!1},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_LeaveSpaceDialog"},o.a.createElement("p",null,Object(u.a)("You are about to leave <spaceName/>.",{},{spaceName:()=>o.a.createElement("b",null,t.name)})," ",l,l&&o.a.createElement(o.a.Fragment,null," "),i.length>0&&Object(u.a)("Would you like to leave the rooms in this space?")),i.length>0&&o.a.createElement(E.a,{space:t,spaceChildren:i,selected:c,onChange:a,noneLabel:Object(u.a)("Don't leave any rooms"),allLabel:Object(u.a)("Leave all rooms"),specificLabel:Object(u.a)("Leave some rooms")}),d&&o.a.createElement("div",{className:"mx_LeaveSpaceDialog_section_warning"},d)),o.a.createElement(y.a,{primaryButton:Object(u.a)("Leave space"),primaryButtonClass:"danger",onPrimaryButtonClick:()=>n(!0,r),hasCancel:!0,onCancel:()=>n(!1)}))},C=n(213);async function O(e){var t;let n,s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],b=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];b&&(n=c.a.createDialog(l.a,null,"mx_Dialog_spinner"));const y=d.a.get();let S=!0;const E=y.getRoomUpgradeHistory(e);if(E&&E.length>0){E[E.length-1].roomId!==e&&(S=!1)}const w=y.getRoom(e);await Promise.all(w.getPendingEvents().filter(e=>[r.a.QUEUED,r.a.ENCRYPTING,r.a.SENDING].includes(e.status)).map(e=>new Promise((t,i)=>{const s=()=>{var o;e.status===r.a.NOT_SENT&&(null===(o=n)||void 0===o||o.close(),i(e.error));e.status&&e.status!==r.a.SENT||(e.off(a.c.Status,s),t())};e.on(a.c.Status,s)})));let _={};if(S)_=await y.leaveRoomChain(e,s);else try{await y.leave(e)}catch(t){var C;if(null!=t&&null!==(C=t.data)&&void 0!==C&&C.errcode){const n=t.data.error||Object(u.a)("Unexpected server error trying to leave the room");_[e]=Object.assign(new Error(n),{errcode:t.data.errcode,data:t.data})}else _[e]=t||new Error("Failed to leave room for unknown causes")}if(s){const t=Object.values(_).find(e=>"M_LIMIT_EXCEEDED"===(null==e?void 0:e.errcode));var R;if(t)return await Object(i.G)(null!==(R=t.data.retry_after_ms)&&void 0!==R?R:100),O(e,!1,!1)}null===(t=n)||void 0===t||t.close();const I=Object.entries(_).filter(e=>!!e[1]);if(I.length>0){const t=[];for(const n of I){const i=n[1];let s=Object(u.a)("Unexpected server error trying to leave the room");if(i.errcode&&i.message){if("M_CANNOT_LEAVE_SERVER_NOTICE_ROOM"===i.errcode)return void c.a.createTrackedDialog("Error Leaving Room","",h.a,{title:Object(u.a)("Can't leave Server Notices room"),description:Object(u.a)("This room is used for important messages from the Homeserver, so you cannot leave it.")});s=_[e].message}t.push(s,o.a.createElement("BR"))}c.a.createTrackedDialog("Error Leaving Room","",h.a,{title:Object(u.a)("Error leaving room"),description:t})}else Object(m.h)(p.a.instance.activeSpace)||p.a.instance.activeSpace===e||g.a.instance.getRoomId()!==e?f.a.dispatch({action:v.a.ViewHomePage}):f.a.dispatch({action:v.a.ViewRoom,room_id:p.a.instance.activeSpace,metricsTrigger:void 0})}const R=e=>{c.a.createTrackedDialog("Leave Space","",_,{space:e,onFinished:async(t,n)=>{t&&(await Object(C.a)(e,n,e=>O(e.roomId)),f.a.dispatch({action:v.a.AfterLeaveRoom,room_id:e.roomId}))}},"mx_LeaveSpaceDialog_wrapper")}},,function(e,t,n){"use strict";n.d(t,"b",(function(){return S})),n.d(t,"a",(function(){return E})),n.d(t,"d",(function(){return w})),n.d(t,"c",(function(){return _}));var i=n(94),s=n.n(i),o=n(0),r=n(90),a=n(95),c=n(88),l=n.n(c),d=n(216),u=n.n(d),h=n(87),m=n.n(h),p=n(225),g=n(89),f=n(110),v=n(101);class b extends m.a.PureComponent{constructor(){super(...arguments),l()(this,"onChange",e=>{this.props.onChange(this.props.url,e.currentTarget.checked)})}render(){return m.a.createElement("input",{type:"checkbox",onChange:this.onChange,checked:this.props.checked})}}class y extends m.a.PureComponent{constructor(e){super(e),l()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),l()(this,"onNextClick",()=>{this.props.onFinished(!0,Object.keys(this.state.agreedUrls).filter(e=>this.state.agreedUrls[e]))}),l()(this,"onTermsCheckboxChange",(e,t)=>{this.setState({agreedUrls:Object.assign({},this.state.agreedUrls,{[e]:t})})}),this.state={agreedUrls:{}};for(const t of e.agreedUrls)this.state.agreedUrls[t]=!0}nameForServiceType(e,t){switch(e){case p.a.IS:return m.a.createElement("div",null,Object(g.a)("Identity server"),m.a.createElement("br",null),"(",t,")");case p.a.IM:return m.a.createElement("div",null,Object(g.a)("Integration manager"),m.a.createElement("br",null),"(",t,")")}}summaryForServiceType(e){switch(e){case p.a.IS:return m.a.createElement("div",null,Object(g.a)("Find others by phone or email"),m.a.createElement("br",null),Object(g.a)("Be found by phone or email"));case p.a.IM:return m.a.createElement("div",null,Object(g.a)("Use bots, bridges, widgets and sticker packs"))}}render(){const e=[];for(const t of this.props.policiesAndServicePairs){const n=u.a.parse(t.service.baseUrl),i=Object.values(t.policies);for(let s=0;s<i.length;++s){const o=i[s],r=Object(g.j)(Object.keys(o).filter(e=>"version"!==e));let a,c;0===s&&(a=this.nameForServiceType(t.service.serviceType,n.host),c=this.summaryForServiceType(t.service.serviceType)),e.push(m.a.createElement("tr",{key:o[r].url},m.a.createElement("td",{className:"mx_TermsDialog_service"},a),m.a.createElement("td",{className:"mx_TermsDialog_summary"},c),m.a.createElement("td",null,o[r].name,m.a.createElement("a",{rel:"noreferrer noopener",target:"_blank",href:o[r].url},m.a.createElement("span",{className:"mx_TermsDialog_link"}))),m.a.createElement("td",null,m.a.createElement(b,{url:o[r].url,onChange:this.onTermsCheckboxChange,checked:Boolean(this.state.agreedUrls[o[r].url])}))))}}let t=!1;for(const e of this.props.policiesAndServicePairs){let n=0;for(const t of Object.values(e.policies)){let e=!1;for(const n of Object.keys(t))if("version"!==n&&this.state.agreedUrls[t[n].url]){e=!0;break}e&&++n}if(n===Object.keys(e.policies).length){t=!0;break}}return m.a.createElement(v.a,{fixedWidth:!1,onFinished:this.onCancelClick,title:Object(g.a)("Terms of Service"),contentId:"mx_Dialog_content",hasCancel:!1},m.a.createElement("div",{id:"mx_Dialog_content"},m.a.createElement("p",null,Object(g.a)("To continue you need to accept the terms of this service.")),m.a.createElement("table",{className:"mx_TermsDialog_termsTable"},m.a.createElement("tbody",null,m.a.createElement("tr",{className:"mx_TermsDialog_termsTableHeader"},m.a.createElement("th",null,Object(g.a)("Service")),m.a.createElement("th",null,Object(g.a)("Summary")),m.a.createElement("th",null,Object(g.a)("Document")),m.a.createElement("th",null,Object(g.a)("Accept"))),e))),m.a.createElement(f.a,{primaryButton:Object(g.a)("Next"),hasCancel:!0,onCancel:this.onCancelClick,onPrimaryButtonClick:this.onNextClick,primaryDisabled:!t}))}}class S extends Error{}class E{constructor(e,t,n){this.serviceType=e,this.baseUrl=t,this.accessToken=n}}async function w(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_;const n=e.map(e=>r.a.get().getTerms(e.serviceType,e.baseUrl)),i=await Promise.all(n),s=i.map((t,n)=>({service:e[n],policies:t.policies})),a=await r.a.get().getAccountData("m.accepted_terms");let c;c=a&&a.getContent()&&a.getContent().accepted?new Set(a.getContent().accepted):new Set;const l=[];for(const{service:e,policies:t}of s){const n={};for(const[e,i]of Object.entries(t)){let t=!1;for(const e of Object.keys(i))if("version"!==e&&c.has(i[e].url)){t=!0;break}t||(n[e]=i)}Object.keys(n).length>0&&l.push({service:e,policies:n})}const d=c.size;if(l.length>0){const e=await t(l,[...c]);o.a.log("User has agreed to URLs",e),e.forEach(e=>c.add(e))}else o.a.log("User has already agreed to all required policies");if(c.size!==d){const e={accepted:Array.from(c)};await r.a.get().setAccountData("m.accepted_terms",e)}const u=s.map(e=>{const t=Array.from(c).filter(t=>{for(const n of Object.values(e.policies))for(const e of Object.keys(n))if("version"!==e&&n[e].url===t)return!0;return!1});return 0===t.length?Promise.resolve():r.a.get().agreeToTerms(e.service.serviceType,e.service.baseUrl,e.service.accessToken,t)});return Promise.all(u)}async function _(e,t,n){o.a.log("Terms that need agreement",e);const{finished:i}=a.a.createTrackedDialog("Terms of Service","",y,{policiesAndServicePairs:e,agreedUrls:t},s()("mx_TermsDialog",n)),[r,c]=await i;if(!r)throw new S;return c}},function(e,t,n){"use strict";n.d(t,"b",(function(){return C})),n.d(t,"c",(function(){return O})),n.d(t,"d",(function(){return R})),n.d(t,"a",(function(){return I}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(108),d=n(315),u=n(165),h=n(17),m=n.n(h);class p{constructor(e){m()(this,"relations",void 0),this.relations=e.filter(e=>!!e)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(n=>n.on(e,t))}off(e,t){this.relations.forEach(n=>n.off(e,t))}}var g=n(89),f=n(95),v=n(175),b=n(220),y=n(100),S=n(107),E=n(854),w=n(90);function _(e,t){return new p([e(t,"m.reference",u.M_POLL_RESPONSE.name),e(t,"m.reference",u.M_POLL_RESPONSE.altName)])}function C(e,t,n){if(!n)return"";const i=e.unstableExtensibleEvent;if(null==i||!i.isEquivalentTo(u.M_POLL_START))return console.warn("Failed to parse poll to determine top answer - assuming no best answer"),"";const s=_(n,e.getId()),o=new p([n(e.getId(),"m.reference",u.M_POLL_END.name),n(e.getId(),"m.reference",u.M_POLL_END.altName)]),r=A(D(N(e,t,s,o),t.getUserId(),null),i),a=Math.max(...r.values()),c=[];for(const[e,t]of r)t==a&&c.push(e);const l=c.map(e=>{var t,n;return null!==(t=null===(n=i.answers.find(t=>t.id===e))||void 0===n?void 0:n.text)&&void 0!==t?t:""});return Object(v.b)(l,3)}function O(e,t,n){if(!n)return!1;const i=t.getRoom(e.getRoomId()).currentState;const s=new p([n(e.getId(),"m.reference",u.M_POLL_END.name),n(e.getId(),"m.reference",u.M_POLL_END.altName)]);if(!s)return!1;return s.getRelations().filter((function(t){return i.maySendRedactionForEvent(e,t.getSender())})).length>0}function R(e,t){var n,i;(function(e,t){return!!t&&_(t,e.getId()).getRelations().length>0})(e,t)?f.a.createTrackedDialog("Not allowed to edit poll","",S.a,{title:Object(g.a)("Can't edit poll"),description:Object(g.a)("Sorry, you can't edit a poll after votes have been cast.")}):f.a.createTrackedDialog("Polls","create",E.a,{room:w.a.get().getRoom(e.getRoomId()),threadId:null!==(n=null===(i=e.getThread())||void 0===i?void 0:i.id)&&void 0!==n?n:null,editingMxEvent:e},"mx_CompoundDialog",!1,!0)}class I extends r.a.Component{constructor(e){super(e),s()(this,"context",void 0),s()(this,"seenEventIds",[]),s()(this,"voteRelationsReceived",!1),s()(this,"endRelationsReceived",!1),s()(this,"onRelationsCreated",(e,t)=>{if("m.reference"===e){if(u.M_POLL_RESPONSE.matches(t)){this.voteRelationsReceived=!0;const e=this.fetchVoteRelations();this.addListeners(e),this.removeListeners(this.state.voteRelations),this.setState({voteRelations:e})}else if(u.M_POLL_END.matches(t)){this.endRelationsReceived=!0;const e=this.fetchEndRelations();this.addListeners(e),this.removeListeners(this.state.endRelations),this.setState({endRelations:e})}this.voteRelationsReceived&&this.endRelationsReceived&&this.props.mxEvent.removeListener(l.c.RelationsCreated,this.onRelationsCreated)}}),s()(this,"onRelationsChange",()=>{this.unselectIfNewEventFromMe()}),s()(this,"onOptionSelected",e=>{this.selectOption(e.currentTarget.value)}),this.state={selected:null,voteRelations:this.fetchVoteRelations(),endRelations:this.fetchEndRelations()},this.addListeners(this.state.voteRelations,this.state.endRelations),this.props.mxEvent.on(l.c.RelationsCreated,this.onRelationsCreated)}componentWillUnmount(){this.props.mxEvent.off(l.c.RelationsCreated,this.onRelationsCreated),this.removeListeners(this.state.voteRelations,this.state.endRelations)}addListeners(e,t){e&&(e.on(d.b.Add,this.onRelationsChange),e.on(d.b.Remove,this.onRelationsChange),e.on(d.b.Redaction,this.onRelationsChange)),t&&(t.on(d.b.Add,this.onRelationsChange),t.on(d.b.Remove,this.onRelationsChange),t.on(d.b.Redaction,this.onRelationsChange))}removeListeners(e,t){e&&(e.off(d.b.Add,this.onRelationsChange),e.off(d.b.Remove,this.onRelationsChange),e.off(d.b.Redaction,this.onRelationsChange)),t&&(t.off(d.b.Add,this.onRelationsChange),t.off(d.b.Remove,this.onRelationsChange),t.off(d.b.Redaction,this.onRelationsChange))}selectOption(e){var t;if(this.isEnded())return;const n=this.collectUserVotes(),i=this.context.getUserId();if(e===(null===(t=n.get(i))||void 0===t?void 0:t.answers[0]))return;const s=u.PollResponseEvent.from([e],this.props.mxEvent.getId()).serialize();this.context.sendEvent(this.props.mxEvent.getRoomId(),s.type,s.content).catch(e=>{console.error("Failed to submit poll response event:",e),f.a.createTrackedDialog("Vote not registered","",S.a,{title:Object(g.a)("Vote not registered"),description:Object(g.a)("Sorry, your vote was not registered. Please try again.")})}),this.setState({selected:e})}fetchVoteRelations(){return this.fetchRelations(u.M_POLL_RESPONSE)}fetchEndRelations(){return this.fetchRelations(u.M_POLL_END)}fetchRelations(e){return this.props.getRelationsForEvent?new p([this.props.getRelationsForEvent(this.props.mxEvent.getId(),"m.reference",e.name),this.props.getRelationsForEvent(this.props.mxEvent.getId(),"m.reference",e.altName)]):null}collectUserVotes(){return D(N(this.props.mxEvent,this.context,this.state.voteRelations,this.state.endRelations),this.context.getUserId(),this.state.selected)}unselectIfNewEventFromMe(){const e=this.state.voteRelations.getRelations().filter(P).filter(e=>!this.seenEventIds.includes(e.getId()));let t=this.state.selected;if(e.length>0)for(const n of e)n.getSender()===this.context.getUserId()&&(t=null);const n=e.map(e=>e.getId());this.seenEventIds=this.seenEventIds.concat(n),this.setState({selected:t})}totalVotes(e){let t=0;for(const n of e.values())t+=n;return t}isEnded(){return O(this.props.mxEvent,this.context,this.props.getRelationsForEvent)}render(){var e;const t=this.props.mxEvent.unstableExtensibleEvent;if(null==t||!t.isEquivalentTo(u.M_POLL_START))return null;const n=this.isEnded(),i=this.props.mxEvent.getId(),s=this.collectUserVotes(),o=A(s,t),a=this.totalVotes(o),l=Math.max(...o.values()),d=this.context.getUserId(),h=null===(e=s.get(d))||void 0===e?void 0:e.answers[0],m=u.M_POLL_KIND_DISCLOSED.matches(t.kind.name),p=n||m&&void 0!==h;let f;f=n?Object(g.a)("Final result based on %(count)s votes",{count:a}):m?void 0===h?0===a?Object(g.a)("No votes cast"):Object(g.a)("%(count)s votes cast. Vote to see the results",{count:a}):Object(g.a)("Based on %(count)s votes",{count:a}):Object(g.a)("Results will be visible when the poll is ended");const v=this.props.mxEvent.replacingEvent()?r.a.createElement("span",{className:"mx_MPollBody_edited"}," (",Object(g.a)("edited"),")"):null;return r.a.createElement("div",{className:"mx_MPollBody"},r.a.createElement("h2",null,t.question.text,v),r.a.createElement("div",{className:"mx_MPollBody_allOptions"},t.answers.map(e=>{let t=0,s="";var d;p&&(t=null!==(d=o.get(e.id))&&void 0!==d?d:0,s=Object(g.a)("%(count)s votes",{count:t}));const u=!n&&h===e.id||n&&t===l,m=c()({mx_MPollBody_option:!0,mx_MPollBody_option_checked:u,mx_MPollBody_option_ended:n}),f=0===a?0:Math.round(100*t/a);return r.a.createElement("div",{key:e.id,className:m,onClick:()=>this.selectOption(e.id)},n?r.a.createElement(k,{answer:e,checked:u,votesText:s}):r.a.createElement(x,{pollId:i,answer:e,checked:u,votesText:s,onOptionSelected:this.onOptionSelected}),r.a.createElement("div",{className:"mx_MPollBody_popularityBackground"},r.a.createElement("div",{className:"mx_MPollBody_popularityAmount",style:{width:f+"%"}})))})),r.a.createElement("div",{className:"mx_MPollBody_totalVotes"},f))}}function k(e){const t=c()({mx_MPollBody_endedOption:!0,mx_MPollBody_endedOptionWinner:e.checked});return r.a.createElement("div",{className:t,"data-value":e.answer.id},r.a.createElement("div",{className:"mx_MPollBody_optionDescription"},r.a.createElement("div",{className:"mx_MPollBody_optionText"},e.answer.text),r.a.createElement("div",{className:"mx_MPollBody_optionVoteCount"},e.votesText)))}function x(e){return r.a.createElement(b.a,{className:"mx_MPollBody_live-option",name:"poll_answer_select-"+e.pollId,value:e.answer.id,checked:e.checked,onChange:e.onOptionSelected},r.a.createElement("div",{className:"mx_MPollBody_optionDescription"},r.a.createElement("div",{className:"mx_MPollBody_optionText"},e.answer.text),r.a.createElement("div",{className:"mx_MPollBody_optionVoteCount"},e.votesText)))}s()(I,"contextType",y.a);class T{constructor(e,t,n){this.ts=e,this.sender=t,this.answers=n}}function j(e){const t=e.unstableExtensibleEvent;if(null==t||!t.isEquivalentTo(u.M_POLL_RESPONSE))throw new Error("Failed to parse Poll Response Event to determine user response");return new T(e.getTs(),e.getSender(),t.answerIds)}function N(e,t,n,i){const s=function(e,t,n){if(!n)return null;const i=t.getRoom(e.getRoomId()).currentState;const s=n.getRelations().filter((function(t){return i.maySendRedactionForEvent(e,t.getSender())})).map(e=>e.getTs());return 0===s.length?null:Math.min(...s)}(e,t,i);return n?n.getRelations().filter(P).filter((function(e){return null===s||e.getTs()<=s})).map(j):[]}function P(e){var t;return null===(t=e.unstableExtensibleEvent)||void 0===t?void 0:t.isEquivalentTo(u.M_POLL_RESPONSE)}function D(e,t,n){const i=new Map;for(const t of e){const e=i.get(t.sender);(!e||e.ts<t.ts)&&i.set(t.sender,t)}return n&&i.set(t,new T(0,t,[n])),i}function A(e,t){const n=new Map;for(const i of e.values()){const e=u.PollResponseEvent.from(i.answers,"$irrelevant");if(e.validateAgainst(t),!e.spoiled)for(const t of e.answerIds)n.has(t)?n.set(t,n.get(t)+1):n.set(t,1)}return n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return R}));var i=n(99),s=n.n(i),o=n(88),r=n.n(o),a=n(87),c=n.n(a),l=n(144),d=n(0),u=n(89),h=n(133),m=n(90),p=n(92),g=n(96),f=n(93),v=n(122),b=n(95),y=n(107),S=n(506),E=n(112),w=n(154),_=n(105),C=n(134);var O=e=>{let{ts:t,onDatePicked:n}=e;const i=new Date(t),s=`${i.getFullYear()}-${(""+(i.getMonth()+1)).padStart(2,"0")}-${(""+i.getDate()).padStart(2,"0")}`,[o,r]=Object(a.useState)(s),[l,d,h]=Object(C.i)(),m=e=>{e.preventDefault(),n(o)};return c.a.createElement("form",{className:"mx_JumpToDatePicker_form",onSubmit:m},c.a.createElement("span",{className:"mx_JumpToDatePicker_label"},Object(u.a)("Jump to date")),c.a.createElement(_.a,{element:"input",type:"date",onInput:e=>r(e.target.value),value:o,className:"mx_JumpToDatePicker_datePicker",label:Object(u.a)("Pick a date to jump to"),onFocus:l,inputRef:h,tabIndex:d?0:-1}),c.a.createElement(C.a,{element:"button",type:"submit",kind:"primary",className:"mx_JumpToDatePicker_submitButton",onClick:m},Object(u.a)("Go")))};class R extends c.a.Component{constructor(e,t){super(e,t),r()(this,"settingWatcherRef",null),r()(this,"onContextMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),r()(this,"onContextMenuCloseClick",()=>{this.closeMenu()}),r()(this,"closeMenu",()=>{this.setState({contextMenuPosition:null})}),r()(this,"pickDate",async e=>{const t=new Date(e).getTime(),n=m.a.get();try{const e=this.props.roomId,{event_id:i,origin_server_ts:s}=await n.timestampToEvent(e,t,l.a.Forward);d.a.log(`/timestamp_to_event: found ${i} (${s}) for timestamp=${t} (looking forward)`),p.a.dispatch({action:g.a.ViewRoom,event_id:i,highlighted:!0,room_id:e,metricsTrigger:void 0})}catch(e){const t=e.errcode||e.statusCode;void 0!==t&&b.a.createTrackedDialog("Unable to find event at that date","",y.a,{title:Object(u.a)("Error"),description:Object(u.a)("Unable to find event at that date. (%(code)s)",{code:t})})}}),r()(this,"onLastWeekClicked",()=>{const e=new Date;e.setDate(e.getDate()-7),this.pickDate(e),this.closeMenu()}),r()(this,"onLastMonthClicked",()=>{const e=new Date;e.setMonth(e.getMonth()-1,1),this.pickDate(e),this.closeMenu()}),r()(this,"onTheBeginningClicked",()=>{const e=new Date(0);this.pickDate(e),this.closeMenu()}),r()(this,"onDatePicked",e=>{this.pickDate(e),this.closeMenu()}),this.state={jumpToDateEnabled:f.b.getValue("feature_jump_to_date")},this.settingWatcherRef=f.b.watchSetting("feature_jump_to_date",null,(e,t,n,i,s)=>{this.setState({jumpToDateEnabled:s})})}componentWillUnmount(){f.b.unwatchSetting(this.settingWatcherRef)}getLabel(){const e=new Date(this.props.ts),t=!f.b.getValue(v.b.TimelineEnableRelativeDates);if(this.props.forExport||t)return Object(h.g)(e);const n=new Date,i=new Date,s=[Object(u.a)("Sunday"),Object(u.a)("Monday"),Object(u.a)("Tuesday"),Object(u.a)("Wednesday"),Object(u.a)("Thursday"),Object(u.a)("Friday"),Object(u.a)("Saturday")];return i.setDate(n.getDate()-1),e.toDateString()===n.toDateString()?Object(u.a)("Today"):e.toDateString()===i.toDateString()?Object(u.a)("Yesterday"):n.getTime()-e.getTime()<5184e5?s[e.getDay()]:Object(h.g)(e)}renderJumpToDateMenu(){let e;return this.state.contextMenuPosition&&(e=c.a.createElement(w.e,s()({},Object(S.a)(this.state.contextMenuPosition),{onFinished:this.onContextMenuCloseClick}),c.a.createElement(w.c,{first:!0},c.a.createElement(w.b,{label:Object(u.a)("Last week"),onClick:this.onLastWeekClicked}),c.a.createElement(w.b,{label:Object(u.a)("Last month"),onClick:this.onLastMonthClicked}),c.a.createElement(w.b,{label:Object(u.a)("The beginning of the room"),onClick:this.onTheBeginningClicked})),c.a.createElement(w.c,null,c.a.createElement(O,{ts:this.props.ts,onDatePicked:this.onDatePicked})))),c.a.createElement(E.c,{className:"mx_DateSeparator_jumpToDateMenu",onClick:this.onContextMenuOpenClick,isExpanded:!!this.state.contextMenuPosition,title:Object(u.a)("Jump to date")},c.a.createElement("div",{"aria-hidden":"true"},this.getLabel()),c.a.createElement("div",{className:"mx_DateSeparator_chevron"}),e)}render(){const e=this.getLabel();let t;return t=this.state.jumpToDateEnabled?this.renderJumpToDateMenu():c.a.createElement("div",{"aria-hidden":"true"},e),c.a.createElement("h2",{className:"mx_DateSeparator",role:"separator",tabIndex:-1,"aria-label":e},c.a.createElement("hr",{role:"none"}),t,c.a.createElement("hr",{role:"none"}))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return d}));var i=n(88),s=n.n(i),o=n(7),r=n(1327),a=n.n(r);class c{static get instance(){return c.internalInstance}constructor(){s()(this,"worker",void 0),s()(this,"seq",0),s()(this,"pendingDeferredMap",new Map),s()(this,"onMessage",e=>{const{seq:t,blurhash:n}=e.data,i=this.pendingDeferredMap.get(t);i&&(this.pendingDeferredMap.delete(t),i.resolve(n))}),this.worker=new a.a,this.worker.onmessage=this.onMessage}getBlurhash(e){const t=this.seq++,n=Object(o.l)();return this.pendingDeferredMap.set(t,n),this.worker.postMessage({seq:t,imageData:e}),n.promise}}s()(c,"internalInstance",new c);const l="xyz.amorgan.blurhash";async function d(e,t,n,i){let s,o,r,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],d=t,u=n;u>600&&(d=Math.floor(d*(600/u)),u=600),d>800&&(u=Math.floor(u*(800/d)),d=800);try{s=new window.OffscreenCanvas(d,u),o=s.getContext("2d")}catch(e){s=document.createElement("canvas"),s.width=d,s.height=u,o=s.getContext("2d")}o.drawImage(e,0,0,d,u),r=window.OffscreenCanvas?s.convertToBlob({type:i}):new Promise(e=>s.toBlob(e,i));const h=o.getImageData(0,0,d,u),m=a?await c.instance.getBlurhash(h):void 0,p=await r;return{info:{thumbnail_info:{w:d,h:u,mimetype:p.type,size:p.size},w:t,h:n,[l]:m},thumbnail:p}}},,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{constructor(e,t){this.roomId=e}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s}));const i="org.matrix.msc3077.sdp_stream_metadata";let s;!function(e){e.Usermedia="m.usermedia",e.Screenshare="m.screenshare"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var i=n(17),s=n.n(i),o=n(143);let r;!function(e){e.NewStream="new_stream",e.MuteStateChanged="mute_state_changed",e.VolumeChanged="volume_changed",e.Speaking="speaking"}(r||(r={}));class a extends o.b{constructor(e){super(),s()(this,"stream",void 0),s()(this,"userId",void 0),s()(this,"purpose",void 0),s()(this,"speakingVolumeSamples",void 0),s()(this,"client",void 0),s()(this,"roomId",void 0),s()(this,"audioMuted",void 0),s()(this,"videoMuted",void 0),s()(this,"measuringVolumeActivity",!1),s()(this,"audioContext",void 0),s()(this,"analyser",void 0),s()(this,"frequencyBinCount",void 0),s()(this,"speakingThreshold",-60),s()(this,"speaking",!1),s()(this,"volumeLooperTimeout",void 0),s()(this,"onAddTrack",()=>{this.emit(r.NewStream,this.stream)}),s()(this,"volumeLooper",()=>{if(!this.analyser)return;if(!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let e=-1/0;for(let t=0;t<this.frequencyBinCount.length;t++)this.frequencyBinCount[t]>e&&(e=this.frequencyBinCount[t]);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(r.VolumeChanged,e);let t=!1;for(let e=0;e<this.speakingVolumeSamples.length;e++){if(this.speakingVolumeSamples[e]>this.speakingThreshold){t=!0;break}}this.speaking!==t&&(this.speaking=t,this.emit(r.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,200)}),this.client=e.client,this.roomId=e.roomId,this.userId=e.userId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(8).fill(-1/0),this.updateStream(null,e.stream),this.hasAudioTrack&&this.initVolumeMeasuring()}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){t!==e&&(e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),t&&(this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?this.initVolumeMeasuring():this.measureVolumeActivity(!1)),this.emit(r.NewStream,this.stream))}initVolumeMeasuring(){const e=window.AudioContext||window.webkitAudioContext;if(!this.hasAudioTrack||!e)return;this.audioContext=new e,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}getMember(){return this.client.getRoom(this.roomId).getMember(this.userId)}isLocal(){return this.userId===this.client.getUserId()}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioMuted(e){this.audioMuted=e,this.speakingVolumeSamples.fill(-1/0),this.emit(r.MuteStateChanged,this.audioMuted,this.videoMuted)}setVideoMuted(e){this.videoMuted=e,this.emit(r.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!(this.audioContext&&this.analyser&&this.frequencyBinCount&&this.hasAudioTrack))return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(r.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}dispose(){clearTimeout(this.volumeLooperTimeout)}}},function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return T})),n.d(t,"a",(function(){return j}));var i=n(17),s=n.n(i),o=n(365),r=n.n(o),a=n(370),c=n(316),l=n(0);const d="m.key.verification.start",u=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"];let h;const m=Object(c.a)("m.mismatched_sas","Mismatched short authentication string"),p=Object(c.a)("m.mismatched_commitment","Mismatched commitment");const g=[["🐶","dog"],["🐱","cat"],["🦁","lion"],["🐎","horse"],["🦄","unicorn"],["🐷","pig"],["🐘","elephant"],["🐰","rabbit"],["🐼","panda"],["🐓","rooster"],["🐧","penguin"],["🐢","turtle"],["🐟","fish"],["🐙","octopus"],["🦋","butterfly"],["🌷","flower"],["🌳","tree"],["🌵","cactus"],["🍄","mushroom"],["🌏","globe"],["🌙","moon"],["☁️","cloud"],["🔥","fire"],["🍌","banana"],["🍎","apple"],["🍓","strawberry"],["🌽","corn"],["🍕","pizza"],["🎂","cake"],["❤️","heart"],["🙂","smiley"],["🤖","robot"],["🎩","hat"],["👓","glasses"],["🔧","spanner"],["🎅","santa"],["👍","thumbs up"],["☂️","umbrella"],["⌛","hourglass"],["⏰","clock"],["🎁","gift"],["💡","light bulb"],["📕","book"],["✏️","pencil"],["📎","paperclip"],["✂️","scissors"],["🔒","lock"],["🔑","key"],["🔨","hammer"],["☎️","telephone"],["🏁","flag"],["🚂","train"],["🚲","bicycle"],["✈️","aeroplane"],["🚀","rocket"],["🏆","trophy"],["⚽","ball"],["🎸","guitar"],["🎺","trumpet"],["🔔","bell"],["⚓️","anchor"],["🎧","headphones"],["📁","folder"],["📌","pin"]];const f={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map(e=>g[e])}};function v(e,t){const n={};for(const i of t)i in f&&(n[i]=f[i](e));return n}const b={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"};function y(e,t){return function(){const n=e[b[t]];for(var i=arguments.length,s=new Array(i),o=0;o<i;o++)s[o]=arguments[o];const r=n.apply(e,s);return l.a.log("SAS calculateMAC:",t,s,r),r}}const S={"curve25519-hkdf-sha256":function(e,t,n){const i=`${e.baseApis.getUserId()}|${e.baseApis.deviceId}|`+e.ourSASPubKey+"|",s=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?i+s:s+i)+e.channel.transactionId;return t.generate_bytes(o,n)},curve25519:function(e,t,n){const i=`${e.baseApis.getUserId()}${e.baseApis.deviceId}`,s=`${e.userId}${e.deviceId}`,o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?i+s:s+i)+e.channel.transactionId;return t.generate_bytes(o,n)}},E=["curve25519-hkdf-sha256","curve25519"],w=["sha256"],_=["hkdf-hmac-sha256","hmac-sha256"],C=Object.keys(f),O=new Set(E),R=new Set(w),I=new Set(_),k=new Set(C);function x(e,t){return e instanceof Array?e.filter(e=>t.has(e)):[]}let T;!function(e){e.ShowSas="show_sas"}(T||(T={}));class j extends a.b{constructor(){super(...arguments),s()(this,"waitingForAccept",void 0),s()(this,"ourSASPubKey",void 0),s()(this,"theirSASPubKey",void 0),s()(this,"sasEvent",void 0),s()(this,"doVerification",async()=>{await e.Olm.init(),h=h||new e.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let t=!1;do{try{return this.initiatedByMe?await this.doSendVerification():await this.doRespondVerification()}catch(e){if(!(e instanceof a.a))throw e;this.startEvent=e.startEvent,t=!0}}while(t)})}static get NAME(){return"m.sas.v1"}get events(){return u}canSwitchStartEvent(e){if(e.getType()!==d)return!1;const t=e.getContent();return t&&t.method===j.NAME&&this.waitingForAccept}async sendStart(){const e=this.channel.completeContent(d,{method:j.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:E,hashes:w,message_authentication_codes:_,short_authentication_string:C});return await this.channel.sendCompleted(d,e),e}async doSendVerification(){let t,n;if(this.waitingForAccept=!0,t=this.startEvent?this.channel.completedContentFromEvent(this.startEvent):await this.sendStart(),!this.initiatedByMe)throw new a.a(this.startEvent);try{n=await this.waitForEvent("m.key.verification.accept")}finally{this.waitingForAccept=!1}let i=n.getContent();const s=x(i.short_authentication_string,k);if(!(O.has(i.key_agreement_protocol)&&R.has(i.hash)&&I.has(i.message_authentication_code)&&s.length))throw Object(c.g)();if("string"!=typeof i.commitment)throw Object(c.c)();const o=i.key_agreement_protocol,l=i.message_authentication_code,d=i.commitment,u=new e.Olm.SAS;try{this.ourSASPubKey=u.get_pubkey(),await this.send("m.key.verification.key",{key:this.ourSASPubKey}),n=await this.waitForEvent("m.key.verification.key"),i=n.getContent();const e=i.key+r.a.stringify(t);if(h.sha256(e)!==d)throw p();this.theirSASPubKey=i.key,u.set_their_key(i.key);const a=S[o](this,u,6),g=new Promise((e,t)=>{this.sasEvent={sas:v(a,s),confirm:async()=>{try{await this.sendMAC(u,l),e()}catch(e){t(e)}},cancel:()=>t(Object(c.h)()),mismatch:()=>t(m())},this.emit(T.ShowSas,this.sasEvent)});[n]=await Promise.all([this.waitForEvent("m.key.verification.mac").then(e=>(this.expectedEvent="m.key.verification.done",e)),g]),i=n.getContent(),await this.checkMAC(u,i,l)}finally{u.free()}}async doRespondVerification(){let t=this.channel.completedContentFromEvent(this.startEvent);const n=x(E,new Set(t.key_agreement_protocols))[0],i=x(w,new Set(t.hashes))[0],s=x(_,new Set(t.message_authentication_codes))[0],o=x(t.short_authentication_string,k);if(void 0===n||void 0===i||void 0===s||!o.length)throw Object(c.g)();const a=new e.Olm.SAS;try{const e=a.get_pubkey()+r.a.stringify(t);await this.send("m.key.verification.accept",{key_agreement_protocol:n,hash:i,message_authentication_code:s,short_authentication_string:o,commitment:h.sha256(e)});let l=await this.waitForEvent("m.key.verification.key");t=l.getContent(),this.theirSASPubKey=t.key,a.set_their_key(t.key),this.ourSASPubKey=a.get_pubkey(),await this.send("m.key.verification.key",{key:this.ourSASPubKey});const d=S[n](this,a,6),u=new Promise((e,t)=>{this.sasEvent={sas:v(d,o),confirm:async()=>{try{await this.sendMAC(a,s),e()}catch(e){t(e)}},cancel:()=>t(Object(c.h)()),mismatch:()=>t(m())},this.emit(T.ShowSas,this.sasEvent)});[l]=await Promise.all([this.waitForEvent("m.key.verification.mac").then(e=>(this.expectedEvent="m.key.verification.done",e)),u]),t=l.getContent(),await this.checkMAC(a,t,s)}finally{a.free()}}sendMAC(e,t){const n={},i=[],s="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,o="ed25519:"+this.baseApis.deviceId;n[o]=y(e,t)(this.baseApis.getDeviceEd25519Key(),s+o),i.push(o);const r=this.baseApis.getCrossSigningId();if(r){const o="ed25519:"+r;n[o]=y(e,t)(r,s+o),i.push(o)}const a=y(e,t)(i.sort().join(","),s+"KEY_IDS");return this.send("m.key.verification.mac",{mac:n,keys:a})}async checkMAC(e,t,n){const i="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(t.keys!==y(e,n)(Object.keys(t.mac).sort().join(","),i+"KEY_IDS"))throw Object(c.d)();await this.verifyKeys(this.userId,t.mac,(t,s,o)=>{if(o!==y(e,n)(s.keys[t],i+t))throw Object(c.d)()})}}}).call(this,n(30))},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(17),s=n.n(i),o=n(7),r=(n(0),n(97));class a{static RETRY_BACKOFF_RATELIMIT(e,t,n){if(400===n.httpStatus||403===n.httpStatus||401===n.httpStatus)return-1;if("rejected"===n.cors)return-1;if("M_TOO_LARGE"===n.name)return-1;if("M_LIMIT_EXCEEDED"===n.name){const e=n.data.retry_after_ms;if(e>0)return e}return t>4?-1:1e3*Math.pow(2,t)}static QUEUE_MESSAGES(e){return e.getType()===r.b.RoomMessage||e.hasAssocation()?"message":null}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,s()(this,"queues",{}),s()(this,"activeQueues",[]),s()(this,"procFn",null),s()(this,"processQueue",e=>{const t=this.peekNextEvent(e);if(!t){const t=this.activeQueues.indexOf(e);return t>=0&&this.activeQueues.splice(t,1),void c("Stopping queue '%s' as it is now empty",e)}c("Queue '%s' has %s pending events",e,this.queues[e].length),Promise.resolve().then(()=>this.procFn(t.event)).then(n=>{this.removeNextEvent(e),c("Queue '%s' sent event %s",e,t.event.getId()),t.defer.resolve(n),this.processQueue(e)},n=>{t.attempts+=1;const i=this.retryAlgorithm(t.event,t.attempts,n);c("retry(%s) err=%s event_id=%s waitTime=%s",t.attempts,n,t.event.getId(),i),-1===i?(c("Queue '%s' giving up on event %s",e,t.event.getId()),this.removeNextEvent(e),t.defer.reject(n),this.processQueue(e)):setTimeout(this.processQueue,i,e)})})}getQueueForEvent(e){const t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map((function(e){return e.event})):null}removeEventFromQueue(e){const t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let n=!1;return o.D(this.queues[t],t=>{if(t.event.getId()===e.getId())return n=!0,!0}),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){const t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);const n=o.l();return this.queues[t].push({event:e,defer:n,attempts:0}),c("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),c("Spinning up queue: '%s'",e),this.processQueue(e)})}peekNextEvent(e){const t=this.queues[e];return Array.isArray(t)?t[0]:null}removeNextEvent(e){const t=this.queues[e];return Array.isArray(t)?t.shift():null}}function c(){0}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return l}));var i=n(17),s=n.n(i),o=n(0),r=n(7),a=n(285);let c;!function(e){e.Invite="invite",e.Leave="leave",e.Join="join"}(c||(c={}));class l{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.opts=e,s()(this,"accountData",{}),s()(this,"inviteRooms",{}),s()(this,"joinRooms",{}),s()(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach(e=>{this.accountData[e.type]=e})}accumulateRooms(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(n=>{this.accumulateRoom(n,c.Invite,e.rooms.invite[n],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(n=>{this.accumulateRoom(n,c.Join,e.rooms.join[n],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(n=>{this.accumulateRoom(n,c.Leave,e.rooms.leave[n],t)}))}accumulateRoom(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(t){case c.Invite:this.accumulateInviteState(e,n);break;case c.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,i);break;case c.Leave:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:o.a.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const n=this.inviteRooms[e];t.invite_state.events.forEach(e=>{let t=!1;for(let i=0;i<n.invite_state.events.length;i++){const s=n.invite_state.events[i];s.type===e.type&&s.state_key==e.state_key&&(n.invite_state.events[i]=e,t=!0)}t||n.invite_state.events.push(e)})}accumulateJoinState(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});const i=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(e=>{i._accountData[e.type]=e}),t.unread_notifications&&(i._unreadNotifications=t.unread_notifications),t.summary){const e="m.heroes",n="m.invited_member_count",s="m.joined_member_count",o=i._summary,r=t.summary;o[e]=r[e]||o[e],o[s]=r[s]||o[s],o[n]=r[n]||o[n]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach(e=>{"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach(t=>{if(!e.content[t][a.a.Read]&&!e.content[t][a.a.ReadPrivate])return;const n=e.content[t][a.a.Read];n&&Object.keys(n).forEach(n=>{i._readReceipts[n]={data:e.content[t][a.a.Read][n],type:a.a.Read,eventId:t}});const s=e.content[t][a.a.ReadPrivate];s&&Object.keys(s).forEach(n=>{i._readReceipts[n]={data:e.content[t][a.a.ReadPrivate][n],type:a.a.ReadPrivate,eventId:t}})})}),t.timeline&&t.timeline.limited&&(i._timeline=[]),t.state&&t.state.events&&t.state.events.forEach(e=>{d(i._currentState,e)}),t.timeline&&t.timeline.events&&t.timeline.events.forEach((e,s)=>{let o;if(d(i._currentState,e),n)o=e;else{o=Object.assign({},e),void 0!==o.unsigned&&(o.unsigned=Object.assign({},o.unsigned));const t=e.unsigned?e.unsigned.age:e.age;void 0!==t&&(o._localTs=Date.now()-t)}i._timeline.push({event:o,token:0===s?t.timeline.prev_batch:null})}),i._timeline.length>this.opts.maxTimelineEntries){for(let e=i._timeline.length-this.opts.maxTimelineEntries;e<i._timeline.length;e++)if(i._timeline[e].token){i._timeline=i._timeline.slice(e,i._timeline.length);break}}}getJSON(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach(e=>{t.invite[e]=this.inviteRooms[e]}),Object.keys(this.joinRooms).forEach(n=>{const i=this.joinRooms[n],s={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:i._unreadNotifications,summary:i._summary};Object.keys(i._accountData).forEach(e=>{s.account_data.events.push(i._accountData[e])});const o={type:"m.receipt",room_id:n,content:{}};Object.keys(i._readReceipts).forEach(e=>{const t=i._readReceipts[e];o.content[t.eventId]||(o.content[t.eventId]={}),o.content[t.eventId][t.type]||(o.content[t.eventId][t.type]={}),o.content[t.eventId][t.type][e]=t.data}),Object.keys(o.content).length>0&&s.ephemeral.events.push(o),i._timeline.forEach(t=>{if(!s.timeline.prev_batch){if(!t.token)return;s.timeline.prev_batch=t.token}let n;!e&&t.event._localTs?(n=Object.assign({},t.event),void 0!==n.unsigned&&(n.unsigned=Object.assign({},n.unsigned)),delete n._localTs,n.unsigned=n.unsigned||{},n.unsigned.age=Date.now()-t.event._localTs):n=t.event,s.timeline.events.push(n)});const a=Object.create(null);for(let e=s.timeline.events.length-1;e>=0;e--){const t=s.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const n=Object(r.j)(t);n.unsigned&&(n.unsigned.prev_content&&(n.content=n.unsigned.prev_content),n.unsigned.prev_sender&&(n.sender=n.unsigned.prev_sender)),d(a,n)}Object.keys(i._currentState).forEach(e=>{Object.keys(i._currentState[e]).forEach(t=>{let n=i._currentState[e][t];a[e]&&a[e][t]&&(n=a[e][t]),s.state.events.push(n)})}),t.join[n]=s});const n=[];return Object.keys(this.accountData).forEach(e=>{n.push(this.accountData[e])}),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}}function d(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return c}));var i=n(17),s=n.n(i),o=n(144);n(0);const r=function(){};class a{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.client=e,this.timelineSet=t,s()(this,"windowLimit",void 0),s()(this,"start",null),s()(this,"end",null),s()(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3}load(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;const n=n=>{let i;const s=n.getEvents();if(e){if(i=s.findIndex(t=>t.getId()===e),i<0)throw new Error("getEventTimeline result didn't include requested event")}else i=s.length;const o=Math.min(s.length,i+Math.ceil(t/2)),r=Math.max(0,o-t);this.start=new c(n,r-n.getBaseIndex()),this.end=new c(n,o-n.getBaseIndex()),this.eventCount=o-r};if(e){const t=this.timelineSet.getTimelineForEvent(e);return t?(n(t),Promise.resolve()):this.client.getEventTimeline(this.timelineSet,e).then(n)}return n(this.timelineSet.getLiveTimeline()),Promise.resolve()}getTimelineIndex(e){if(e==o.b.BACKWARDS)return this.start;if(e==o.b.FORWARDS)return this.end;throw new Error("Invalid direction '"+e+"'")}extend(e,t){const n=this.getTimelineIndex(e);if(!n)return r("TimelineWindow: no timeline yet"),!1;const i=e==o.b.BACKWARDS?n.retreat(t):n.advance(t);if(i){this.eventCount+=i,r("TimelineWindow: increased cap by "+i+" (now "+this.eventCount+")");const t=this.eventCount-this.windowLimit;return t>0&&this.unpaginate(t,e!=o.b.BACKWARDS),!0}return!1}canPaginate(e){const t=this.getTimelineIndex(e);if(!t)return r("TimelineWindow: no timeline yet"),!1;if(e==o.b.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||null!==t.timeline.getPaginationToken(e))}paginate(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5;const s=this.getTimelineIndex(e);if(!s)return r("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(s.pendingPaginate)return s.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!n||0===i)return Promise.resolve(!1);if(null===s.timeline.getPaginationToken(e))return r("TimelineWindow: no token"),Promise.resolve(!1);r("TimelineWindow: starting request");const a=this.client.paginateEventTimeline(s.timeline,{backwards:e==o.b.BACKWARDS,limit:t}).finally((function(){s.pendingPaginate=null})).then(n=>(r("TimelineWindow: request completed with result "+n),!!n&&this.paginate(e,t,!0,i-1)));return s.pendingPaginate=a,a}unpaginate(e,t){const n=t?this.start:this.end;if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this.eventCount+" in the timeline");for(;e>0;){const i=t?n.advance(e):n.retreat(e);if(i<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=i,this.eventCount-=i,r("TimelineWindow.unpaginate: dropped "+i+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];const e=[];let t=this.start.timeline;for(;;){const n=t.getEvents();let i=0,s=n.length;t===this.start.timeline&&(i=this.start.index+t.getBaseIndex()),t===this.end.timeline&&(s=this.end.index+t.getBaseIndex());for(let t=i;t<s;t++)e.push(n[t]);if(t===this.end.timeline)break;t=t.getNeighbouringTimeline(o.b.FORWARDS)}return e}}class c{constructor(e,t){this.timeline=e,this.index=t,s()(this,"pendingPaginate",void 0)}minIndex(){return-1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const n=this.timeline.getNeighbouringTimeline(e<0?o.b.BACKWARDS:o.b.FORWARDS);return n?(this.timeline=n,this.index=e<0?this.maxIndex():this.minIndex(),r("paginate: switched to new neighbour"),this.advance(e)):0}retreat(e){return-1*this.advance(-1*e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(7);n(0);const s="session.e2e.";function o(e){if(this.store=e,!(i.s(e.getItem)&&i.s(e.setItem)&&i.s(e.removeItem)&&i.s(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}o.prototype={removeEndToEndAccount:function(){this.store.removeItem(r)},getEndToEndAccount:function(){return this.store.getItem(r)},getAllEndToEndDevices:function(){const e=d(""),t={};for(let n=0;n<this.store.length;++n){const i=this.store.key(n),s=i.slice(e.length);i.startsWith(e)&&(t[s]=m(this.store,i))}return t},getEndToEndDeviceTrackingStatus:function(){return m(this.store,c)},getEndToEndDeviceSyncToken:function(){return m(this.store,a)},removeEndToEndDeviceData:function(){g(this.store,d("")),g(this.store,c),g(this.store,a)},getEndToEndSessions:function(e){return m(this.store,u(e))},getAllEndToEndSessions:function(){const e=p(this.store,u("")),t={};for(const n of e){t[n.slice(u("").length)]=m(this.store,n)}return t},removeAllEndToEndSessions:function(){g(this.store,u(""))},getAllEndToEndInboundGroupSessionKeys:function(){const e=s+"inboundgroupsessions/",t=[];for(let n=0;n<this.store.length;n++){const i=this.store.key(n);i.startsWith(e)&&t.push({senderKey:i.slice(e.length,e.length+43),sessionId:i.slice(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){const n=function(e,t){return s+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(n)},removeAllEndToEndInboundGroupSessions:function(){g(this.store,s+"inboundgroupsessions/")},getAllEndToEndRooms:function(){const e=p(this.store,h("")),t={};for(const n of e){t[n.slice(h("").length)]=m(this.store,n)}return t},removeAllEndToEndRooms:function(){g(this.store,h(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(l,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(l)}};const r=s+"account",a=s+"device_sync_token",c=s+"device_tracking",l=s+"trusted_backup_pubkey";function d(e){return s+"devices/"+e}function u(e){return s+"sessions/"+e}function h(e){return s+"rooms/"+e}function m(e,t){try{return JSON.parse(e.getItem(t))}catch(e){f("Failed to get key %s: %s",t,e),f(e.stack)}return null}function p(e,t){const n=[];for(let i=0;i<e.length;++i){const s=e.key(i);s.startsWith(t)&&n.push(s)}return n}function g(e,t){const n=[];for(let i=0;i<e.length;++i){const s=e.key(i);s.startsWith(t)&&n.push(s)}for(const t of n)e.removeItem(t)}function f(){0}},function(e,t,n){"use strict";var i;!function(e){e.HomePage="home_page",e.RoomView="room_view",e.UserView="user_view",e.LegacyGroupView="legacy_group_view"}(i||(i={})),t.a=i},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var i=n(88),s=n.n(i),o=n(374),r=n(87),a=n.n(r),c=n(0),l=n(272),d=n(102);const u=new Error("User cancelled auth session");class h extends a.a.Component{constructor(e){super(e),s()(this,"authLogic",void 0),s()(this,"intervalId",null),s()(this,"stageComponent",Object(r.createRef)()),s()(this,"unmounted",!1),s()(this,"requestEmailToken",async(e,t,n,i)=>{this.setState({busy:!0});try{return await this.props.requestEmailToken(e,t,n,i)}finally{this.setState({busy:!1})}}),s()(this,"authStateUpdated",(e,t)=>{const n=this.state.authStage;this.setState({busy:!1,authStage:e,stageState:t,errorText:t.error,errorCode:t.errcode},()=>{if(n!==e)this.setFocus();else if(!t.error){var i,s;null===(i=this.stageComponent.current)||void 0===i||null===(s=i.attemptFailed)||void 0===s||s.call(i)}})}),s()(this,"requestCallback",(e,t)=>this.props.makeRequest(e)),s()(this,"onBusyChanged",e=>{e&&this.setState({busy:!0,errorText:null,errorCode:null})}),s()(this,"submitAuthDict",e=>{this.authLogic.submitAuthDict(e)}),s()(this,"onPhaseChange",e=>{var t,n;null===(t=(n=this.props).onStagePhaseChange)||void 0===t||t.call(n,this.state.authStage,e||0)}),s()(this,"onStageCancel",()=>{this.props.onAuthFinished(!1,u)}),s()(this,"onAuthStageFailed",e=>{this.props.onAuthFinished(!1,e)}),s()(this,"setEmailSid",e=>{this.authLogic.setEmailSid(e)}),this.state={authStage:null,busy:!1,errorText:null,errorCode:null,submitButtonEnabled:!1},this.authLogic=new o.b({authData:this.props.authData,doRequest:this.requestCallback,busyChanged:this.onBusyChanged,inputs:this.props.inputs,stateUpdated:this.authStateUpdated,matrixClient:this.props.matrixClient,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.emailSid,requestEmailToken:this.requestEmailToken}),this.props.poll&&(this.intervalId=setInterval(()=>{this.authLogic.poll()},2e3))}UNSAFE_componentWillMount(){this.authLogic.attemptAuth().then(e=>{const t={emailSid:this.authLogic.getEmailSid(),clientSecret:this.authLogic.getClientSecret()};this.props.onAuthFinished(!0,e,t)}).catch(e=>{if(this.props.onAuthFinished(!1,e),c.a.error("Error during user-interactive auth:",e),this.unmounted)return;const t=e.message||e.toString();this.setState({errorText:t,errorCode:e.errcode})})}componentWillUnmount(){this.unmounted=!0,null!==this.intervalId&&clearInterval(this.intervalId)}setFocus(){var e,t;null===(e=this.stageComponent.current)||void 0===e||null===(t=e.focus)||void 0===t||t.call(e)}render(){const e=this.state.authStage;if(!e)return this.state.busy?a.a.createElement(d.a,null):null;const t=Object(l.d)(e);return a.a.createElement(t,{ref:this.stageComponent,loginType:e,matrixClient:this.props.matrixClient,authSessionId:this.authLogic.getSessionId(),clientSecret:this.authLogic.getClientSecret(),stageParams:this.authLogic.getStageParams(e),submitAuthDict:this.submitAuthDict,errorText:this.state.errorText,errorCode:this.state.errorCode,busy:this.state.busy,inputs:this.props.inputs,stageState:this.state.stageState,fail:this.onAuthStageFailed,setEmailSid:this.setEmailSid,showContinue:!this.props.continueIsManaged,onPhaseChange:this.onPhaseChange,requestEmailToken:this.authLogic.requestEmailToken,continueText:this.props.continueText,continueKind:this.props.continueKind,onCancel:this.onStageCancel})}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(87);const s=Object(i.createContext)(void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(88),s=n.n(i),o=n(321);class r extends o.a{static clear(){r.itemCache.clear(),r.objectCache.clear()}constructor(){super(),r.storageListenerBound||(r.storageListenerBound=!0,window.addEventListener("storage",r.onStorageEvent))}getItem(e){if(!r.itemCache.has(e)){const t=localStorage.getItem(e);return r.itemCache.set(e,t),t}return r.itemCache.get(e)}getBoolean(e){const t=this.getItem(e);return"true"===t||"false"!==t&&null}getObject(e){if(!r.objectCache.has(e))try{const t=JSON.parse(localStorage.getItem(e));return r.objectCache.set(e,t),t}catch(e){return console.error("Failed to parse localStorage object",e),null}return r.objectCache.get(e)}setItem(e,t){r.itemCache.set(e,t),localStorage.setItem(e,t)}setBoolean(e,t){this.setItem(e,""+t)}setObject(e,t){r.objectCache.set(e,t),localStorage.setItem(e,JSON.stringify(t))}removeItem(e){localStorage.removeItem(e),r.itemCache.delete(e),r.objectCache.delete(e)}isSupported(){return void 0!==localStorage&&null!==localStorage}}s()(r,"itemCache",new Map),s()(r,"objectCache",new Map),s()(r,"storageListenerBound",!1),s()(r,"onStorageEvent",e=>{null===e.key?r.clear():(r.itemCache.delete(e.key),r.objectCache.delete(e.key))})},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(89);function s(e){return{undefined:Object(i.a)("Default"),0:Object(i.a)("Restricted"),[e]:Object(i.a)("Default"),50:Object(i.a)("Moderator"),100:Object(i.a)("Admin")}}function o(e,t){const n=s(t);return n[e]?n[e]:Object(i.a)("Custom (%(level)s)",{level:e})}},function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return r}));var i=n(88),s=n.n(i);class o{forEvent(e,t){throw new Error("Not implemented")}forRoom(e){throw new Error("Not implemented")}forGroup(e){throw new Error("Not implemented")}forUser(e){throw new Error("Not implemented")}forEntity(e){throw new Error("Not implemented")}isPermalinkHost(e){throw new Error("Not implemented")}parsePermalink(e){throw new Error("Not implemented")}}class r{constructor(e,t,n,i,o){s()(this,"roomIdOrAlias",void 0),s()(this,"eventId",void 0),s()(this,"userId",void 0),s()(this,"viaServers",void 0),s()(this,"groupId",void 0),this.roomIdOrAlias=e,this.eventId=t,this.userId=n,this.groupId=i,this.viaServers=o}static forUser(e){return new r(null,null,e,null,null)}static forGroup(e){return new r(null,null,null,e,null)}static forRoom(e){return new r(e,null,null,null,arguments.length>1&&void 0!==arguments[1]?arguments[1]:[])}static forEvent(e,t){return new r(e,t,null,null,arguments.length>2&&void 0!==arguments[2]?arguments[2]:[])}get primaryEntityId(){return this.roomIdOrAlias||this.userId}get sigil(){return this.primaryEntityId[0]}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(242),r=n(8),a=n(90),c=n(96);class l extends r.EventEmitter{constructor(e){super(),this.dispatcher=e,s()(this,"matrixClient",void 0),s()(this,"dispatcherRef",void 0),s()(this,"onAction",async e=>{if(this.onDispatcherAction(e),"MatrixActions.sync"===e.action){if(e.prevState!==o.b.Prepared||e.state===o.b.Prepared)return;this.matrixClient!==e.matrixClient&&(this.matrixClient&&await this.onNotReady(),this.matrixClient=e.matrixClient,await this.onReady())}else"on_client_not_viable"!==e.action&&e.action!==c.a.OnLoggedOut||this.matrixClient&&(await this.onNotReady(),this.matrixClient=null)}),this.dispatcherRef=this.dispatcher.register(this.onAction),a.a.get()&&(this.matrixClient=a.a.get(),this.onReady())}get mxClient(){return this.matrixClient}useUnitTestClient(e){this.matrixClient=e}destroy(){this.dispatcher.unregister(this.dispatcherRef)}async onReady(){}async onNotReady(){}onDispatcherAction(e){}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i=n(88),s=n.n(i),o=n(125),r=n(0),a=n(116),c=n(90),l=n(426),d=n(93),u=n(89),h=n(92),m=n(104),p=n(96);class g{constructor(){s()(this,"_lists",[]),s()(this,"_roomIds",[]),s()(this,"mjolnirWatchRef",null),s()(this,"dispatcherRef",null),s()(this,"onAction",e=>{"setup_mjolnir"===e.action&&(r.a.log("Setting up Mjolnir: after sync"),this.setup())}),s()(this,"onEvent",e=>{c.a.get()&&this._roomIds.includes(e.getRoomId())&&l.a.includes(e.getType())&&this.updateLists(this._roomIds)})}get roomIds(){return this._roomIds}get lists(){return this._lists}start(){this.mjolnirWatchRef=d.b.watchSetting("mjolnirRooms",null,this.onListsChanged.bind(this)),this.dispatcherRef=h.a.register(this.onAction),h.a.dispatch({action:p.a.DoAfterSyncPrepared,deferred_action:{action:"setup_mjolnir"}})}setup(){c.a.get()&&(this.updateLists(d.b.getValue("mjolnirRooms")),c.a.get().on(a.b.Events,this.onEvent))}stop(){this.mjolnirWatchRef&&(d.b.unwatchSetting(this.mjolnirWatchRef),this.mjolnirWatchRef=null),this.dispatcherRef&&(h.a.unregister(this.dispatcherRef),this.dispatcherRef=null),c.a.get()&&c.a.get().removeListener(a.b.Events,this.onEvent)}async getOrCreatePersonalList(){let e=d.b.getValue("mjolnirPersonalRoom");if(!e){const t=await c.a.get().createRoom({name:Object(u.a)("My Ban List"),topic:Object(u.a)("This is your list of users/servers you have blocked - don't leave the room!"),preset:o.d.PrivateChat});e=t.room_id,await d.b.setValue("mjolnirPersonalRoom",null,m.a.ACCOUNT,e),await d.b.setValue("mjolnirRooms",null,m.a.ACCOUNT,[e,...this._roomIds])}if(!e)throw new Error("Error finding a room ID to use");let t=this._lists.find(t=>t.roomId===e);return t||(t=new l.b(e)),t}getPersonalList(){const e=d.b.getValue("mjolnirPersonalRoom");if(!e)return null;let t=this._lists.find(t=>t.roomId===e);return t||(t=new l.b(e)),t}async subscribeToList(e){const t=[...this._roomIds,e];await d.b.setValue("mjolnirRooms",null,m.a.ACCOUNT,t),this._lists.push(new l.b(e))}async unsubscribeFromList(e){const t=this._roomIds.filter(t=>t!==e);await d.b.setValue("mjolnirRooms",null,m.a.ACCOUNT,t),this._lists=this._lists.filter(t=>t.roomId!==e)}onListsChanged(e,t,n,i){this.updateLists(i)}updateLists(e){if(c.a.get()&&(r.a.log("Updating Mjolnir ban lists to: "+e),this._lists=[],this._roomIds=e||[],e))for(const t of e)this._lists.push(new l.b(t))}isServerBanned(e){for(const t of this._lists)for(const n of t.serverRules)if(n.isMatch(e))return!0;return!1}isUserBanned(e){for(const t of this._lists)for(const n of t.userRules)if(n.isMatch(e))return!0;return!1}static sharedInstance(){return g.instance||(g.instance=new g),g.instance}}s()(g,"instance",null)},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(89),r=n(100),a=n(133),c=n(93);const l=s.a.forwardRef((e,t)=>{let{mxEvent:n}=e;const l=Object(i.useContext)(r.a);let d=Object(o.a)("Message deleted");const u=n.getUnsigned(),h=u&&u.redacted_because&&u.redacted_because.sender;if(h&&h!==n.getSender()){const e=l.getRoom(n.getRoomId()),t=e&&e.getMember(h);d=Object(o.a)("Message deleted by %(name)s",{name:t?t.name:h})}const m=c.b.getValue("showTwelveHourTimestamps"),p=Object(a.d)(new Date(u.redacted_because.origin_server_ts),m),g=Object(o.a)("Message deleted on %(date)s",{date:p});return s.a.createElement("span",{className:"mx_RedactedBody",ref:t,title:g},d)});t.a=l},,,,,,,,,,,,,,,,,,,function(e,t){},function(e,t){},,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(117),d=n(134);const u=["inputRef","onFocus"],h=e=>{let{inputRef:t,onFocus:n}=e,i=r()(e,u);const[o,a,h]=Object(d.i)(t);return c.a.createElement(l.a,s()({},i,{onFocus:e=>{o(),null==n||n(e)},inputRef:h,tabIndex:a?0:-1}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(91);const d=["label","isExpanded","children","onClick","onContextMenu"],u=e=>{let{label:t,isExpanded:n,children:i,onClick:o,onContextMenu:a}=e,u=r()(e,d);return c.a.createElement(l.a,s()({},u,{onClick:o,onContextMenu:a||o,title:t,"aria-label":t,"aria-haspopup":!0,"aria-expanded":n}),i)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return y})),n.d(t,"b",(function(){return S}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(151),d=n(0),u=n(92),h=n(90),m=n(132),p=n(100),g=n(96),f=n(140),v=n(130),b=n(136);let y;!function(e){e.UserMention="TYPE_USER_MENTION",e.RoomMention="TYPE_ROOM_MENTION",e.AtRoomMention="TYPE_AT_ROOM_MENTION"}(y||(y={}));class S extends r.a.Component{static roomNotifPos(e){return e.indexOf("@room")}static roomNotifLen(){return"@room".length}constructor(e){super(e),s()(this,"unmounted",!0),s()(this,"matrixClient",void 0),s()(this,"onMouseOver",()=>{this.setState({hover:!0})}),s()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),s()(this,"onUserPillClicked",e=>{e.preventDefault(),u.a.dispatch({action:g.a.ViewUser,member:this.state.member})}),this.state={resourceId:null,pillType:null,member:null,room:null,hover:!1}}async UNSAFE_componentWillReceiveProps(e){let t,n;if(e.url)if(e.inMessage){const i=Object(m.h)(e.url);t=i.primaryEntityId,n=i.sigil}else t=Object(m.c)(e.url),n=t?t[0]:void 0;const i=this.props.type||{"@":y.UserMention,"#":y.RoomMention,"!":y.RoomMention}[n];let s,o;switch(i){case y.AtRoomMention:o=e.room;break;case y.UserMention:{const n=e.room?e.room.getMember(t):void 0;s=n,n||(s=new l.a(null,t),this.doProfileLookup(t,s))}break;case y.RoomMention:{const e="#"===t[0]?h.a.get().getRooms().find(e=>e.getCanonicalAlias()===t||e.getAltAliases().includes(t)):h.a.get().getRoom(t);o=e}}this.setState({resourceId:t,pillType:i,member:s,room:o})}componentDidMount(){this.unmounted=!1,this.matrixClient=h.a.get(),this.UNSAFE_componentWillReceiveProps(this.props)}componentWillUnmount(){this.unmounted=!0}doProfileLookup(e,t){h.a.get().getProfileInfo(e).then(e=>{this.unmounted||(t.name=e.displayname,t.rawDisplayName=e.displayname,t.events.member={getContent:()=>({avatar_url:e.avatar_url}),getDirectionalContent:function(){return this.getContent()}},this.setState({member:t}))}).catch(t=>{d.a.error("Could not retrieve profile data for "+e+":",t)})}render(){const e=this.state.resourceId;let t,n,i,s=null,o=e,a=this.props.url;switch(this.state.pillType){case y.AtRoomMention:{const e=this.props.room;e&&(o="@room",this.props.shouldShowPillAvatar&&(s=r.a.createElement(v.a,{room:e,width:16,height:16,"aria-hidden":"true"})),t="mx_AtRoomPill")}break;case y.UserMention:{const e=this.state.member;e&&(n=e.userId,e.rawDisplayName=e.rawDisplayName||"",o=e.rawDisplayName,this.props.shouldShowPillAvatar&&(s=r.a.createElement(b.a,{member:e,width:16,height:16,"aria-hidden":"true",hideTitle:!0})),t="mx_UserPill",a=null,i=this.onUserPillClicked)}break;case y.RoomMention:{const n=this.state.room;n&&(o=n.name||e,this.props.shouldShowPillAvatar&&(s=r.a.createElement(v.a,{room:n,width:16,height:16,"aria-hidden":"true"}))),t=null!=n&&n.isSpaceRoom()?"mx_SpacePill":"mx_RoomPill"}}const l=c()("mx_Pill",t,{mx_UserPill_me:n===h.a.get().getUserId()});if(this.state.pillType){let t;return this.state.hover&&e&&(t=r.a.createElement(f.b,{label:e,alignment:f.a.Right})),r.a.createElement(p.a.Provider,{value:this.matrixClient},this.props.inMessage?r.a.createElement("a",{className:l,href:a,onClick:i,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},s,o,t):r.a.createElement("span",{className:l,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},s,o,t))}return null}}},function(e,t,n){"use strict";function i(e){return e+"px"}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(315),c=n(97),l=n(845),d=n(90),u=n(92),h=n(96),m=n(106);class p extends r.a.Component{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"onReactionsChange",()=>{this.setState({selectedEmojis:new Set(Object.keys(this.getReactions()))})}),s()(this,"onChoose",e=>{this.componentWillUnmount(),this.props.onFinished();const t=this.getReactions();return t.hasOwnProperty(e)?(d.a.get().redactEvent(this.props.mxEvent.getRoomId(),t[e]),u.a.dispatch({action:h.a.FocusAComposer,context:this.context.timelineRenderingType}),!1):(d.a.get().sendEvent(this.props.mxEvent.getRoomId(),c.b.Reaction,{"m.relates_to":{rel_type:c.d.Annotation,event_id:this.props.mxEvent.getId(),key:e}}),u.a.dispatch({action:"message_sent"}),u.a.dispatch({action:h.a.FocusAComposer,context:this.context.timelineRenderingType}),!0)}),this.state={selectedEmojis:new Set(Object.keys(this.getReactions()))},this.addListeners()}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.addListeners(),this.onReactionsChange())}addListeners(){this.props.reactions&&(this.props.reactions.on(a.b.Add,this.onReactionsChange),this.props.reactions.on(a.b.Remove,this.onReactionsChange),this.props.reactions.on(a.b.Redaction,this.onReactionsChange))}componentWillUnmount(){this.props.reactions&&(this.props.reactions.removeListener(a.b.Add,this.onReactionsChange),this.props.reactions.removeListener(a.b.Remove,this.onReactionsChange),this.props.reactions.removeListener(a.b.Redaction,this.onReactionsChange))}getReactions(){if(!this.props.reactions)return{};const e=d.a.get().getUserId(),t=this.props.reactions.getAnnotationsBySender()[e]||[];return Object.fromEntries([...t].filter(e=>!e.isRedacted()).map(e=>[e.getRelation().key,e.getId()]))}render(){return r.a.createElement(l.d,{onChoose:this.onChoose,selectedEmojis:this.state.selectedEmojis,showQuickReactions:!0})}}s()(p,"contextType",m.b),t.a=p},function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(493),c=n(89),l=n(100),d=n(153),u=n(90),h=n(101),m=n(208),p=n(494),g=n(397),f=n(295);class v extends r.a.Component{constructor(e){super(e),s()(this,"onBack",()=>{this.setState({isEditing:!1})}),this.state={isEditing:!1}}onEdit(){this.setState({isEditing:!0})}viewSourceContent(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isEncrypted(),n=e.clearEvent,i=e.event,s=()=>Object(g.f)(i);if(t){const e=()=>Object(g.f)(n);return r.a.createElement(r.a.Fragment,null,r.a.createElement("details",{open:!0,className:"mx_ViewSource_details"},r.a.createElement("summary",null,r.a.createElement("span",{className:"mx_ViewSource_heading"},Object(c.a)("Decrypted event source"))),r.a.createElement("div",{className:"mx_ViewSource_container"},r.a.createElement(f.a,{getTextToCopy:e},r.a.createElement(a.a,{language:"json"},Object(g.f)(n))))),r.a.createElement("details",{className:"mx_ViewSource_details"},r.a.createElement("summary",null,r.a.createElement("span",{className:"mx_ViewSource_heading"},Object(c.a)("Original event source"))),r.a.createElement("div",{className:"mx_ViewSource_container"},r.a.createElement(f.a,{getTextToCopy:s},r.a.createElement(a.a,{language:"json"},Object(g.f)(i))))))}return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_ViewSource_heading"},Object(c.a)("Original event source")),r.a.createElement("div",{className:"mx_ViewSource_container"},r.a.createElement(f.a,{getTextToCopy:s},r.a.createElement(a.a,{language:"json"},Object(g.f)(i)))))}editSourceContent(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isState(),n=e.getRoomId();return t?r.a.createElement(l.a.Consumer,null,t=>r.a.createElement(m.a.Provider,{value:{room:t.getRoom(n)}},r.a.createElement(p.b,{onBack:this.onBack,mxEvent:e}))):r.a.createElement(l.a.Consumer,null,t=>r.a.createElement(m.a.Provider,{value:{room:t.getRoom(n)}},r.a.createElement(g.c,{onBack:this.onBack,mxEvent:e})))}canSendStateEvent(e){const t=u.a.get();return t.getRoom(e.getRoomId()).currentState.mayClientSendStateEvent(e.getType(),t)}render(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=this.state.isEditing,n=e.getRoomId(),i=e.getId(),s=e.isState()?this.canSendStateEvent(e):Object(d.c)(this.props.mxEvent);return r.a.createElement(h.a,{className:"mx_ViewSource",onFinished:this.props.onFinished,title:Object(c.a)("View Source")},r.a.createElement("div",null,r.a.createElement("div",null,r.a.createElement(f.a,{getTextToCopy:()=>n,border:!1},Object(c.a)("Room ID: %(roomId)s",{roomId:n}))),r.a.createElement("div",null,r.a.createElement(f.a,{getTextToCopy:()=>i,border:!1},Object(c.a)("Event ID: %(eventId)s",{eventId:i}))),r.a.createElement("div",{className:"mx_ViewSource_separator"}),t?this.editSourceContent():this.viewSourceContent()),!t&&s&&r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:()=>this.onEdit()},Object(c.a)("Edit"))))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(87),s=n.n(i),o=n(702),r=n.n(o);class a extends s.a.PureComponent{render(){const{children:e,language:t}=this.props,n=t?r.a.highlight(t,e):r.a.highlightAuto(e);return s.a.createElement("pre",{className:"mx_SyntaxHighlight hljs language-"+n.language},s.a.createElement("code",{dangerouslySetInnerHTML:{__html:n.value}}))}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return p}));var i=n(87),s=n.n(i),o=n(94),r=n.n(o),a=n(89),c=n(208),l=n(100),d=n(397),u=n(495);const h=e=>{let{mxEvent:t,onBack:n}=e;const o=Object(i.useContext)(c.a),r=Object(i.useContext)(l.a),a=Object(i.useMemo)(()=>[Object(d.d)(null==t?void 0:t.getType()),Object(d.e)(null==t?void 0:t.getStateKey())],[t]),u=t?Object(d.f)(t.getContent()):void 0;return s.a.createElement(d.a,{fieldDefs:a,defaultContent:u,onSend:(e,t)=>{let[n,i]=e;return r.sendStateEvent(o.room.roomId,n,t,i)},onBack:n})},m=e=>{let{eventType:t,onBack:n}=e;const o=Object(i.useContext)(c.a),[l,m]=Object(i.useState)(""),[p,g]=Object(i.useState)(null),f=o.room.currentState.events.get(t);if(Object(i.useEffect)(()=>{1===f.size&&f.has("")?g(f.get("")):g(null)},[f]),p){const e=()=>{g(null)};return s.a.createElement(d.b,{mxEvent:p,onBack:e,Editor:h})}return s.a.createElement(c.b,{onBack:n},s.a.createElement(u.a,{query:l,onChange:m},Array.from(f.entries()).map(e=>{let[t,n]=e;const i=t.trim();return s.a.createElement("button",{className:r()("mx_DevTools_button",{mx_DevTools_RoomStateExplorer_button_hasSpaces:i.length!==t.length,mx_DevTools_RoomStateExplorer_button_emptyString:!i}),key:t,onClick:()=>{g(n)}},i?t:Object(a.a)("<%(count)s spaces>",{count:t.length}))})))},p=e=>{let{onBack:t,setTool:n}=e;const o=Object(i.useContext)(c.a),[r,l]=Object(i.useState)(""),[d,p]=Object(i.useState)(null),g=o.room.currentState.events;if(d){const e=()=>{p(null)};return s.a.createElement(m,{eventType:d,onBack:e})}return s.a.createElement(c.b,{onBack:t,actionLabel:Object(a.a)("Send custom state event"),onAction:async()=>{n(Object(a.a)("Send custom state event"),h)}},s.a.createElement(u.a,{query:r,onChange:l},Array.from(g.keys()).map(e=>s.a.createElement("button",{className:"mx_DevTools_button",key:e,onClick:()=>{p(e)}},e))))}},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(89),r=n(105),a=n(496);t.a=e=>{var t,n;let{children:c,query:l,onChange:d}=e;const[u,h]=Object(i.useState)(20),[m,p]=Object(i.useState)(c);Object(i.useEffect)(()=>{let e=c;if(l){const t=l.toLowerCase();e=c.filter(e=>e.key.toString().toLowerCase().includes(t))}p(e),h(20)},[c,l]);return s.a.createElement(s.a.Fragment,null,s.a.createElement(r.a,{label:Object(o.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:l,onChange:e=>d(e.target.value),className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query",key:null!==(t=null==c||null===(n=c[0])||void 0===n?void 0:n.key)&&void 0!==t?t:""}),m.length<1?Object(o.a)("No results found"):s.a.createElement(a.a,{getChildren:(e,t)=>m.slice(e,t),getChildCount:()=>m.length,truncateAt:u,createOverflowElement:(e,t)=>s.a.createElement("button",{className:"mx_DevTools_button",onClick:()=>{h(e=>e+50)}},Object(o.a)("and %(count)s others...",{count:e}))}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(89);class c extends r.a.Component{getChildren(e,t){return this.props.getChildren&&this.props.getChildCount?this.props.getChildren(e,t):r.a.Children.toArray(this.props.children).filter(e=>null!=e).slice(e,t)}getChildCount(){return this.props.getChildren&&this.props.getChildCount?this.props.getChildCount():r.a.Children.toArray(this.props.children).filter(e=>null!=e).length}render(){let e=null;const t=this.getChildCount();let n=t;if(this.props.truncateAt>=0){const i=t-this.props.truncateAt;i>1&&(e=this.props.createOverflowElement(i,t),n=this.props.truncateAt)}const i=this.getChildren(0,n);return r.a.createElement("div",{className:this.props.className},i,e)}}s()(c,"defaultProps",{truncateAt:2,createOverflowElement:(e,t)=>r.a.createElement("div",null,Object(a.a)("And %(count)s more...",{count:e}))})},function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return u}));var i=n(87),s=n.n(i),o=n(89),r=n(90),a=n(95),c=n(107),l=n(703);class d extends s.a.Component{render(){return s.a.createElement(l.a,{onFinished:this.props.onFinished,title:Object(o.a)("Confirm Removal"),description:Object(o.a)("Are you sure you wish to remove (delete) this event? Note that if you delete a room name or topic change, it could undo the change."),placeholder:Object(o.a)("Reason (optional)"),focus:!0,button:Object(o.a)("Remove")})}}function u(e){let{mxEvent:t,onCloseDialog:n=(()=>{})}=e;a.a.createTrackedDialog("Confirm Redact Dialog","",d,{onFinished:async(e,i)=>{if(!e)return;const s=r.a.get();try{null==n||n(),await s.redactEvent(t.getRoomId(),t.getId(),void 0,i?{reason:i}:{})}catch(e){const t=e.errcode||e.statusCode;void 0!==t&&a.a.createTrackedDialog("You cannot delete this message","",c.a,{title:Object(o.a)("Error"),description:Object(o.a)("You cannot delete this message. (%(code)s)",{code:t})})}}},"mx_Dialog_confirmredact")}},function(e,t,n){"use strict";n.d(t,"a",(function(){return S}));var i=n(88),s=n.n(i),o=n(87),r=n(113),a=n(200),c=n(151),l=n(108),d=n(89),u=n(704),h=n(132),m=n(149),p=n(141),g=n(93),f=n(122),v=n(101),b=n(295);const y=[{name:"Facebook",img:n(1256),url:e=>"https://www.facebook.com/sharer/sharer.php?u="+e},{name:"Twitter",img:n(1257),url:e=>"https://twitter.com/home?status="+e},{name:"LinkedIn",img:n(1258),url:e=>"https://www.linkedin.com/shareArticle?mini=true&url="+e},{name:"Reddit",img:n(1259),url:e=>"https://www.reddit.com/submit?url="+e},{name:"email",img:n(1260),url:e=>"mailto:?body="+e}];class S extends o.PureComponent{constructor(e){super(e),s()(this,"closeCopiedTooltip",void 0),s()(this,"onLinkSpecificEventCheckboxClick",()=>{this.setState({linkSpecificEvent:!this.state.linkSpecificEvent})});let t=null;e.target instanceof r.b&&(t=new h.a(e.target),t.load()),this.state={linkSpecificEvent:this.props.target instanceof l.b,permalinkCreator:t}}static onLinkClick(e){e.preventDefault(),Object(m.e)(e.target)}componentWillUnmount(){this.closeCopiedTooltip&&this.closeCopiedTooltip()}getUrl(){let e;if(this.props.target instanceof r.b)if(this.state.linkSpecificEvent){const t=this.props.target.getLiveTimeline().getEvents();e=this.state.permalinkCreator.forEvent(t[t.length-1].getId())}else e=this.state.permalinkCreator.forShareableRoom();else this.props.target instanceof a.a||this.props.target instanceof c.a?e=Object(h.g)(this.props.target.userId):this.props.target instanceof l.b&&(e=this.state.linkSpecificEvent?this.props.permalinkCreator.forEvent(this.props.target.getId()):this.props.permalinkCreator.forShareableRoom());return e}render(){let e,t;if(this.props.target instanceof r.b){e=Object(d.a)("Share Room");this.props.target.getLiveTimeline().getEvents().length>0&&(t=o.createElement("div",null,o.createElement(p.b,{checked:this.state.linkSpecificEvent,onChange:this.onLinkSpecificEventCheckboxClick},Object(d.a)("Link to most recent message"))))}else this.props.target instanceof a.a||this.props.target instanceof c.a?e=Object(d.a)("Share User"):this.props.target instanceof l.b&&(e=Object(d.a)("Share Room Message"),t=o.createElement("div",null,o.createElement(p.b,{checked:this.state.linkSpecificEvent,onChange:this.onLinkSpecificEventCheckboxClick},Object(d.a)("Link to selected message"))));const n=this.getUrl(),i=encodeURIComponent(n),s=g.b.getValue(f.b.ShareQRCode),h=g.b.getValue(f.b.ShareSocial);let m;return(s||h)&&(m=o.createElement(o.Fragment,null,o.createElement("hr",null),o.createElement("div",{className:"mx_ShareDialog_split"},s&&o.createElement("div",{className:"mx_ShareDialog_qrcode_container"},o.createElement(u.a,{data:n,width:256})),h&&o.createElement("div",{className:"mx_ShareDialog_social_container"},y.map(e=>o.createElement("a",{rel:"noreferrer noopener",target:"_blank",key:e.name,title:e.name,href:e.url(i),className:"mx_ShareDialog_social_icon"},o.createElement("img",{src:e.img,alt:e.name,height:64,width:64}))))))),o.createElement(v.a,{title:e,className:"mx_ShareDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},o.createElement("div",{className:"mx_ShareDialog_content"},o.createElement(b.a,{getTextToCopy:()=>n},o.createElement("a",{title:Object(d.a)("Link to room"),href:n,onClick:S.onLinkClick},n)),t,m))}}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(0),s=n(98),o=n(205),r=n(398);function a(){var e,t;const n=null!==(e=null===(t=Object(o.f)())||void 0===t?void 0:t.map_style_url)&&void 0!==e?e:s.b.get().map_style_url;if(!n)throw i.a.error("'map_style_url' missing from homeserver .well-known area, and missing from from config.json."),new Error(r.a.MapStyleUrlNotConfigured);return n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"c",(function(){return u})),n.d(t,"d",(function(){return h})),n.d(t,"b",(function(){return m}));var i=n(503),s=n.n(i),o=n(18),r=n(0),a=n(504),c=n(501),l=n(398);const d=(e,t,n)=>{try{const i=Object(c.a)(),o=new s.a.Map({container:t,style:i,zoom:15,interactive:e,attributionControl:!1});return o.addControl(new s.a.AttributionControl,"top-right"),o.on("error",e=>{r.a.error("Failed to load map: check map_style_url in config.json has a valid URL and API key",e.error),n(new Error(l.a.MapStyleUrlNotReachable))}),o}catch(e){throw r.a.error("Failed to render map",e),e}},u=(e,t)=>new s.a.Marker({element:t,anchor:"bottom",offset:[0,-1]}).setLngLat({lon:e.longitude,lat:e.latitude}),h=e=>"https://www.openstreetmap.org/?mlat="+e.latitude+"&mlon="+e.longitude+`#map=16/${e.latitude}/${e.longitude}`,m=e=>{const t=e.getContent(),n=t[o.c.name];if(void 0!==n){const e=n.uri;if(void 0!==e)return h(Object(a.a)(e))}else{const e=t.geo_uri;if(e)return h(Object(a.a)(e))}return null}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i=e=>{function t(e){const t=parseFloat(e);return Number.isNaN(t)?void 0:t}const n=e.match(/^\s*geo:(.*?)\s*$/);if(!n)return;const i=n[1].split(";"),s=i[0].split(",");let o;for(const e of i.slice(1)){const n=e.match(/u=(.*)/);n&&(o=t(n[1]))}return{latitude:t(s[0]),longitude:t(s[1]),altitude:t(s[2]),accuracy:o,altitudeAccuracy:void 0,heading:void 0,speed:void 0}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(0),r=n(119),a=n(98),c=n(90);class l{constructor(){s()(this,"domain",void 0),s()(this,"update",async e=>{var t,n;let i=(null===(t=a.b.getObject("jitsi"))||void 0===t?void 0:t.get("preferred_domain"))||"meet.element.io";o.a.log("Attempting to get Jitsi conference information from homeserver");const s=null==e||null===(n=e["im.vector.riot.jitsi"])||void 0===n?void 0:n.preferredDomain;s&&(i=s),this.domain=i,o.a.log("Jitsi conference domain:",this.preferredDomain)})}get preferredDomain(){return this.domain||"meet.element.io"}async getJitsiAuth(){if(!this.preferredDomain)return null;let e;try{const t=await fetch(`https://${this.preferredDomain}/.well-known/element/jitsi`);e=await t.json()}catch(e){return null}return e.auth?e.auth:null}start(){const e=c.a.get();e.on(r.b.ClientWellKnown,this.update),this.update(e.getClientWellKnown())}parsePreferredConferenceUrl(e){const t=new URL(e);return t.hostname!==this.preferredDomain?null:{conferenceId:t.pathname.substring(1),domain:t.hostname,isAudioOnly:!1}}static getInstance(){return l.instance||(l.instance=new l),l.instance}}s()(l,"instance",void 0)},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return H})),n.d(t,"b",(function(){return q}));var i,s=n(99),o=n.n(s),r=n(88),a=n.n(r),c=n(87),l=n.n(c),d=n(113),u=n(94),h=n.n(u),m=n(0),p=n(116),g=n(134),f=n(91),v=n(92),b=n(96),y=n(93),S=n(89),E=n(112),w=n(166),_=n(573),C=n(276),O=n(326),R=n(90),I=n(210),k=n(189),x=n(855),T=n(172),j=n(190),N=n(117),P=n(576),D=n(711),A=n(712),M=n(154),U=n(298),L=n(257),F=n(127),B=n(109),K=n(114),V=n(129);!function(e){e[e.Disconnected=0]="Disconnected",e[e.Connecting=1]="Connecting",e[e.Connected=2]="Connected"}(i||(i={}));const W=e=>"mx_RoomTile_messagePreview_"+e,H=e=>({left:e.left+window.scrollX-9,top:e.bottom+window.scrollY+17,chevronFace:E.a.None});class q extends l.a.PureComponent{constructor(t){let n;super(t),a()(this,"dispatcherRef",void 0),a()(this,"roomTileRef",Object(c.createRef)()),a()(this,"notificationState",void 0),a()(this,"roomProps",void 0),a()(this,"isVideoRoom",void 0),a()(this,"onRoomNameUpdate",e=>{this.forceUpdate()}),a()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),a()(this,"onRoomPropertyUpdate",e=>{e===D.a.NotificationVolume&&this.onNotificationUpdate()}),a()(this,"onAction",t=>{t.action===b.a.ViewRoom&&t.room_id===this.props.room.roomId&&t.show_room_tile&&e(()=>{this.scrollIntoView()})}),a()(this,"onRoomPreviewChanged",e=>{this.props.room&&e.roomId===this.props.room.roomId&&this.generatePreview()}),a()(this,"scrollIntoView",()=>{this.roomTileRef.current&&this.roomTileRef.current.scrollIntoView({block:"nearest",behavior:"auto"})}),a()(this,"onTileClick",async e=>{e.preventDefault(),e.stopPropagation();const t=Object(K.a)().getAccessibilityAction(e);v.a.dispatch({action:b.a.ViewRoom,show_room_tile:!0,room_id:this.props.room.roomId,clear_search:[B.h.Enter,B.h.Space].includes(t),metricsTrigger:"RoomList",metricsViaKeyboard:"click"!==e.type})}),a()(this,"onActiveRoomUpdate",e=>{this.setState({selected:e})}),a()(this,"onNotificationsMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({notificationsMenuPosition:t.getBoundingClientRect()}),F.b.trackInteraction("WebRoomListRoomTileNotificationsMenu",e)}),a()(this,"onCloseNotificationsMenu",()=>{this.setState({notificationsMenuPosition:null})}),a()(this,"onGeneralMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({generalMenuPosition:t.getBoundingClientRect()})}),a()(this,"onContextMenu",e=>{this.showContextMenu&&(e.preventDefault(),e.stopPropagation(),this.setState({generalMenuPosition:{left:e.clientX,bottom:e.clientY}}))}),a()(this,"onCloseGeneralMenu",()=>{this.setState({generalMenuPosition:null})}),a()(this,"onTagRoom",(e,t)=>{if(e.preventDefault(),e.stopPropagation(),t===w.a.Favourite||t===w.a.LowPriority){const e=t===w.a.Favourite?w.a.LowPriority:w.a.Favourite,n=k.b.instance.getTagsForRoom(this.props.room).includes(t),i=n?t:e,s=n?null:t;v.a.dispatch(x.a.tagRoom(R.a.get(),this.props.room,i,s,void 0,0))}else m.a.warn(`Unexpected tag ${t} applied to ${this.props.room.roomId}`);switch(Object(K.a)().getAccessibilityAction(e)){case B.h.Enter:this.setState({generalMenuPosition:null})}}),a()(this,"onLeaveRoomClick",e=>{e.preventDefault(),e.stopPropagation(),v.a.dispatch({action:"leave_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null}),F.b.trackInteraction("WebRoomListRoomTileContextMenuLeaveItem",e)}),a()(this,"onForgetRoomClick",e=>{e.preventDefault(),e.stopPropagation(),v.a.dispatch({action:"forget_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),a()(this,"onOpenRoomSettings",e=>{e.preventDefault(),e.stopPropagation(),v.a.dispatch({action:"open_room_settings",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null}),F.b.trackInteraction("WebRoomListRoomTileContextMenuSettingsItem",e)}),a()(this,"onCopyRoomClick",e=>{e.preventDefault(),e.stopPropagation(),v.a.dispatch({action:"copy_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),a()(this,"onInviteClick",e=>{e.preventDefault(),e.stopPropagation(),v.a.dispatch({action:"view_invite",roomId:this.props.room.roomId}),this.setState({generalMenuPosition:null}),F.b.trackInteraction("WebRoomListRoomTileContextMenuInviteItem",e)}),a()(this,"onClickAllNotifs",e=>this.saveNotifState(e,O.a.AllMessages)),a()(this,"onClickAlertMe",e=>this.saveNotifState(e,O.a.AllMessagesLoud)),a()(this,"onClickMentions",e=>this.saveNotifState(e,O.a.MentionsOnly)),a()(this,"onClickMute",e=>this.saveNotifState(e,O.a.Mute)),a()(this,"updateVideoMembers",()=>{this.setState(e=>({videoMembers:Object(L.f)(this.props.room,e.videoStatus===i.Connected)}))}),a()(this,"updateVideoStatus",()=>{var e,t,n,i;U.b.instance.roomId===(null===(e=this.props.room)||void 0===e?void 0:e.roomId)?U.b.instance.connected?this.onConnectVideo(null===(t=this.props.room)||void 0===t?void 0:t.roomId):this.onStartConnectVideo(null===(n=this.props.room)||void 0===n?void 0:n.roomId):this.onDisconnectVideo(null===(i=this.props.room)||void 0===i?void 0:i.roomId)}),a()(this,"onConnectVideo",e=>{var t;e===(null===(t=this.props.room)||void 0===t?void 0:t.roomId)&&(this.setState({videoStatus:i.Connected,videoMembers:Object(L.f)(this.props.room,!0)}),U.b.instance.on(U.a.Participants,this.updateJitsiParticipants))}),a()(this,"onStartConnectVideo",e=>{var t;e===(null===(t=this.props.room)||void 0===t?void 0:t.roomId)&&this.setState({videoStatus:i.Connecting})}),a()(this,"onDisconnectVideo",e=>{var t;e===(null===(t=this.props.room)||void 0===t?void 0:t.roomId)&&(this.setState({videoStatus:i.Disconnected,videoMembers:Object(L.f)(this.props.room,!1)}),U.b.instance.off(U.a.Participants,this.updateJitsiParticipants))}),a()(this,"updateJitsiParticipants",(e,t)=>{this.setState({jitsiParticipants:t})}),n=U.b.instance.roomId===this.props.room.roomId?U.b.instance.connected?i.Connected:i.Connecting:i.Disconnected,this.state={selected:V.a.instance.getRoomId()===this.props.room.roomId,notificationsMenuPosition:null,generalMenuPosition:null,messagePreview:"",videoStatus:n,videoMembers:Object(L.f)(this.props.room,n===i.Connected),jitsiParticipants:U.b.instance.participants},this.generatePreview(),this.notificationState=T.a.instance.getRoomState(this.props.room),this.roomProps=P.a.forRoom(this.props.room),this.isVideoRoom=y.b.getValue("feature_video_rooms")&&this.props.room.isElementVideoRoom()}get showContextMenu(){return this.props.tag!==w.a.Invite}get showMessagePreview(){return!this.props.isMinimized&&this.props.showMessagePreview}componentDidUpdate(e,t){var n,i;const s=e.showMessagePreview!==this.props.showMessagePreview,o=e.isMinimized!==this.props.isMinimized;var r,a,c,l,u,h;((s||o)&&this.generatePreview(),(null===(n=e.room)||void 0===n?void 0:n.roomId)!==(null===(i=this.props.room)||void 0===i?void 0:i.roomId))&&(_.a.instance.off(_.a.getPreviewChangedEventName(e.room),this.onRoomPreviewChanged),_.a.instance.on(_.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),null===(r=e.room)||void 0===r||null===(a=r.currentState)||void 0===a||a.off(p.b.Events,this.updateVideoMembers),null===(c=this.props.room)||void 0===c||null===(l=c.currentState)||void 0===l||l.on(p.b.Events,this.updateVideoMembers),this.updateVideoStatus(),null===(u=e.room)||void 0===u||u.off(d.c.Name,this.onRoomNameUpdate),null===(h=this.props.room)||void 0===h||h.on(d.c.Name,this.onRoomNameUpdate))}componentDidMount(){this.state.selected&&this.scrollIntoView(),V.a.instance.addRoomListener(this.props.room.roomId,this.onActiveRoomUpdate),this.dispatcherRef=v.a.register(this.onAction),_.a.instance.on(_.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),this.notificationState.on(j.b.Update,this.onNotificationUpdate),this.roomProps.on(A.b,this.onRoomPropertyUpdate),this.props.room.on(d.c.Name,this.onRoomNameUpdate),this.props.room.currentState.on(p.b.Events,this.updateVideoMembers),U.b.instance.on(U.a.Connect,this.onConnectVideo),U.b.instance.on(U.a.StartConnect,this.onStartConnectVideo),U.b.instance.on(U.a.Disconnect,this.onDisconnectVideo),U.b.instance.roomId===this.props.room.roomId&&U.b.instance.on(U.a.Participants,this.updateJitsiParticipants)}componentWillUnmount(){V.a.instance.removeRoomListener(this.props.room.roomId,this.onActiveRoomUpdate),_.a.instance.off(_.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),this.props.room.off(d.c.Name,this.onRoomNameUpdate),this.props.room.currentState.off(p.b.Events,this.updateVideoMembers),v.a.unregister(this.dispatcherRef),this.notificationState.off(j.b.Update,this.onNotificationUpdate),this.roomProps.off(A.b,this.onRoomPropertyUpdate),U.b.instance.off(U.a.Connect,this.onConnectVideo),U.b.instance.off(U.a.StartConnect,this.onStartConnectVideo),U.b.instance.off(U.a.Disconnect,this.onDisconnectVideo)}async generatePreview(){if(!this.showMessagePreview)return null;const e=await _.a.instance.getPreviewForRoom(this.props.room,this.props.tag);this.setState({messagePreview:e})}async saveNotifState(e,t){if(e.preventDefault(),e.stopPropagation(),R.a.get().isGuest())return;this.roomProps.notificationVolume=t;switch(Object(K.a)().getAccessibilityAction(e)){case B.h.Enter:this.setState({notificationsMenuPosition:null})}}renderNotificationsMenu(e){if(R.a.get().isGuest()||this.props.tag===w.a.Archived||!this.showContextMenu||this.props.isMinimized)return null;const t=this.roomProps.notificationVolume;let n=null;this.state.notificationsMenuPosition&&(n=l.a.createElement(M.e,o()({},H(this.state.notificationsMenuPosition),{onFinished:this.onCloseNotificationsMenu,className:"mx_RoomTile_contextMenu",compact:!0}),l.a.createElement(M.c,{first:!0},l.a.createElement(M.d,{label:Object(S.a)("Use default"),active:t===O.a.AllMessages,iconClassName:"mx_RoomTile_iconBell",onClick:this.onClickAllNotifs}),l.a.createElement(M.d,{label:Object(S.a)("All messages"),active:t===O.a.AllMessagesLoud,iconClassName:"mx_RoomTile_iconBellDot",onClick:this.onClickAlertMe}),l.a.createElement(M.d,{label:Object(S.a)("Mentions & Keywords"),active:t===O.a.MentionsOnly,iconClassName:"mx_RoomTile_iconBellMentions",onClick:this.onClickMentions}),l.a.createElement(M.d,{label:Object(S.a)("None"),active:t===O.a.Mute,iconClassName:"mx_RoomTile_iconBellCrossed",onClick:this.onClickMute}))));const i=h()("mx_RoomTile_notificationsButton",{mx_RoomTile_iconBell:t===O.a.AllMessages,mx_RoomTile_iconBellDot:t===O.a.AllMessagesLoud,mx_RoomTile_iconBellMentions:t===O.a.MentionsOnly,mx_RoomTile_iconBellCrossed:t===O.a.Mute,mx_RoomTile_notificationsButton_show:t===O.a.Mute});return l.a.createElement(l.a.Fragment,null,l.a.createElement(E.c,{className:i,onClick:this.onNotificationsMenuOpenClick,title:Object(S.a)("Notification options"),isExpanded:!!this.state.notificationsMenuPosition,tabIndex:e?0:-1}),n)}renderGeneralMenu(){if(!this.showContextMenu)return null;let e=null;if(this.state.generalMenuPosition&&this.props.tag===w.a.Archived)e=l.a.createElement(M.e,o()({},H(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),l.a.createElement(M.c,{red:!0},l.a.createElement(M.b,{iconClassName:"mx_RoomTile_iconSignOut",label:Object(S.a)("Forget Room"),onClick:this.onForgetRoomClick})));else if(this.state.generalMenuPosition){const t=k.b.instance.getTagsForRoom(this.props.room),n=t.includes(w.a.Favourite),i=n?Object(S.a)("Favourited"):Object(S.a)("Favourite"),s=t.includes(w.a.LowPriority),r=Object(S.a)("Low Priority"),a=t.includes(w.a.DM),c=R.a.get().getUserId(),d=this.props.room.canInvite(c)&&!a;e=l.a.createElement(M.e,o()({},H(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),l.a.createElement(M.c,null,l.a.createElement(M.a,{onClick:e=>{this.onTagRoom(e,w.a.Favourite),F.b.trackInteraction("WebRoomListRoomTileContextMenuFavouriteToggle",e)},active:n,label:i,iconClassName:"mx_RoomTile_iconStar"}),l.a.createElement(M.a,{onClick:e=>this.onTagRoom(e,w.a.LowPriority),active:s,label:r,iconClassName:"mx_RoomTile_iconArrowDown"}),d?l.a.createElement(M.b,{onClick:this.onInviteClick,label:Object(S.a)("Invite"),iconClassName:"mx_RoomTile_iconInvite"}):null,a?null:l.a.createElement(M.b,{onClick:this.onCopyRoomClick,label:Object(S.a)("Copy room link"),iconClassName:"mx_RoomTile_iconCopyLink"}),l.a.createElement(M.b,{onClick:this.onOpenRoomSettings,label:Object(S.a)("Settings"),iconClassName:"mx_RoomTile_iconSettings"})),l.a.createElement(M.c,{red:!0},l.a.createElement(M.b,{onClick:this.onLeaveRoomClick,label:Object(S.a)("Leave"),iconClassName:"mx_RoomTile_iconSignOut"})))}return l.a.createElement(l.a.Fragment,null,l.a.createElement(E.c,{className:"mx_RoomTile_menuButton",onClick:this.onGeneralMenuOpenClick,title:Object(S.a)("Room options"),isExpanded:!!this.state.generalMenuPosition}),e)}render(){const e=h()({mx_RoomTile:!0,mx_RoomTile_selected:this.state.selected,mx_RoomTile_hasMenuOpen:!(!this.state.generalMenuPosition&&!this.state.notificationsMenuPosition),mx_RoomTile_minimized:this.props.isMinimized});let t,n,s=this.props.room.name;if("string"!=typeof s&&(s=""),s=s.replace(":",":​"),!this.props.isMinimized&&this.notificationState&&(t=l.a.createElement("div",{className:"mx_RoomTile_badgeContainer","aria-hidden":"true"},l.a.createElement(I.a,{notification:this.notificationState,forceCount:!1,roomId:this.props.room.roomId}))),this.isVideoRoom){let e,t,s;switch(this.state.videoStatus){case i.Disconnected:e=Object(S.a)("Video"),t=!1,s=this.state.videoMembers.size;break;case i.Connecting:e=Object(S.a)("Joining…"),t=!0,s=this.state.videoMembers.size;break;case i.Connected:e=Object(S.a)("Joined"),t=!0,s=this.state.jitsiParticipants.length}n=l.a.createElement("div",{className:"mx_RoomTile_subtitle"},l.a.createElement("span",{className:h()({mx_RoomTile_videoIndicator:!0,mx_RoomTile_videoIndicator_active:t})},e),s?l.a.createElement(l.a.Fragment,null," · ",l.a.createElement("span",{className:"mx_RoomTile_videoParticipants","aria-label":Object(S.a)("%(count)s participants",{count:s})},s)):null)}else this.showMessagePreview&&this.state.messagePreview&&(n=l.a.createElement("div",{className:"mx_RoomTile_subtitle",id:W(this.props.room.roomId),title:this.state.messagePreview},this.state.messagePreview));const r=h()({mx_RoomTile_title:!0,mx_RoomTile_titleWithSubtitle:!!n,mx_RoomTile_titleHasUnreadEvents:this.notificationState.isUnread}),a=this.props.isMinimized?null:l.a.createElement("div",{className:"mx_RoomTile_titleContainer"},l.a.createElement("div",{title:s,className:r,tabIndex:-1},l.a.createElement("span",{dir:"auto"},s)),n);let c,d=s;this.props.tag===w.a.Invite||(this.notificationState.hasMentions?d+=" "+Object(S.a)("%(count)s unread messages including mentions.",{count:this.notificationState.count}):this.notificationState.hasUnreadCount?d+=" "+Object(S.a)("%(count)s unread messages.",{count:this.notificationState.count}):this.notificationState.isUnread&&(d+=" "+Object(S.a)("Unread messages."))),this.showMessagePreview&&(c=W(this.props.room.roomId));const u={};let m=f.a;return this.props.isMinimized&&(m=N.a,u.title=s,u.forceHide=!!this.state.generalMenuPosition),l.a.createElement(l.a.Fragment,null,l.a.createElement(g.e,{inputRef:this.roomTileRef},n=>{let{onFocus:i,isActive:s,ref:r}=n;return l.a.createElement(m,o()({},u,{onFocus:i,tabIndex:s?0:-1,inputRef:r,className:e,onClick:this.onTileClick,onContextMenu:this.onContextMenu,role:"treeitem","aria-label":d,"aria-selected":this.state.selected,"aria-describedby":c}),l.a.createElement(C.a,{room:this.props.room,avatarSize:32,displayBadge:this.props.isMinimized,tooltipProps:{tabIndex:s?0:-1}}),a,t,this.renderGeneralMenu(),this.renderNotificationsMenu(s))}))}}}).call(this,n(179).setImmediate)},function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(713);let r;!function(e){e[e.Pending=0]="Pending",e[e.Success=1]="Success",e[e.Error=2]="Error"}(r||(r={}));class a extends o.a{constructor(e,t){super(),this.auditName=e,this.runFn=t,s()(this,"_status",r.Pending),s()(this,"didFail",!1),s()(this,"startTime",new Date)}get didPreviouslyFail(){return this.didFail}get status(){return this._status}run(){if(this.status===r.Success)throw new Error("Cannot re-run a successful echo transaction");this.setStatus(r.Pending),this.runFn().then(()=>this.setStatus(r.Success)).catch(()=>this.setStatus(r.Error))}cancel(){this.setStatus(r.Success)}setStatus(e){this._status=e,e===r.Error?this.didFail=!0:e===r.Success&&(this.didFail=!1),this.notifyCondition(e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(88),s=n.n(i);const o=(e,t,n)=>""===n.text[t].trim();class r{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;this.model=e,s()(this,"_start",void 0),s()(this,"_end",void 0),s()(this,"_lastStart",void 0),s()(this,"_initializedEmpty",void 0);const i=t.compare(n)<0;this._start=i?t:n,this._end=i?n:t,this._lastStart=this._start,this._initializedEmpty=this._start.index===this._end.index&&this._start.offset==this._end.offset}moveStartForwards(e){this._start=this._start.forwardsWhile(this.model,()=>(e-=1)>=0)}wasInitializedEmpty(){return this._initializedEmpty}setWasEmpty(e){this._initializedEmpty=e}getLastStartingPosition(){return this._lastStart}setLastStartingPosition(e){this._lastStart=e}moveEndBackwards(e){this._end=this._end.backwardsWhile(this.model,()=>(e-=1)>=0)}trim(){""!==this.text.trim()?(this._start=this._start.forwardsWhile(this.model,o),this._end=this._end.backwardsWhile(this.model,o)):this._start=this._end}expandBackwardsWhile(e){this._start=this._start.backwardsWhile(this.model,e)}expandForwardsWhile(e){this._end=this._end.forwardsWhile(this.model,e)}get text(){let e="";return this._start.iteratePartsBetween(this._end,this.model,(t,n,i)=>{const s=t.text.substring(n,i);e+=s}),e}replace(e){const t=e.reduce((e,t)=>e+t.text.length,0);let n=0;return this._start.iteratePartsBetween(this._end,this.model,(e,t,i)=>{n+=i-t}),this.model.replaceRange(this._start,this._end,e),t-n}get parts(){const e=[];return this._start.iteratePartsBetween(this._end,this.model,(t,n,i)=>{const s=t.serialize();s.text=t.text.substring(n,i);const o=this.model.partCreator.deserializePart(s);e.push(o)}),e}get length(){let e=0;return this._start.iteratePartsBetween(this._end,this.model,(t,n,i)=>{e+=i-n}),e}get start(){return this._start}get end(){return this._end}}},function(e,t,n){"use strict";n.d(t,"d",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return d})),n.d(t,"e",(function(){return h}));var i=n(223);function s(e,t){const n=!t||t.type===i.b.Newline;return!e.acceptsCaret&&(n||!t.acceptsCaret)}function o(e,t){return!e.acceptsCaret&&t}function r(e,t){const n=e.nextSibling;n?e.parentElement.insertBefore(t,n):e.parentElement.appendChild(t)}const a="\ufeff";function c(){const e=document.createElement("span");return e.className="caretNode",e.appendChild(document.createTextNode(a)),e}function l(e){e.textContent!==a&&(e.textContent=a)}function d(e){return e&&"SPAN"===e.tagName&&"caretNode"===e.className}function u(e){if(e)for(e=e.nextSibling;e;){const t=e;e=e.nextSibling,t.remove()}}function h(e,t){const n=t.parts.reduce((e,t)=>{if(t.type===i.b.Newline)e.push([]);else{e[e.length-1].push(t)}return e},[[]]);n.forEach((t,n)=>{let i=e.childNodes[n];for(;i&&("DIV"!==i.tagName||i.className);)e.removeChild(i),i=e.childNodes[n];i||(i=document.createElement("div"),e.appendChild(i)),t.length?function(e,t){let n,i;const a=t[t.length-1];for(const u of t){for(n=!i?e.firstChild:n.nextSibling,s(u,i)&&(d(n)?(l(n),n=n.nextSibling):e.insertBefore(c(),n));n&&!u.canUpdateDOMNode(n);){const t=n.nextSibling;e.removeChild(n),n=t}if(n&&u?u.updateDOMNode(n):u&&(n=u.toDOMNode(),e.appendChild(n)),o(u,u===a))if(d(n.nextSibling))n=n.nextSibling,l(n);else{const e=c();r(n,e),n=e}i=u}u(n)}(i,t):function(e){let t=!1,n=e.firstChild;for(;n;){const e=n.nextSibling;t||"BR"!==n.tagName?n.remove():t=!0,n=e}t||e.appendChild(document.createElement("br"))}(i)}),n.length?u(e.children[n.length-1]):function(e){const t=e.firstChild;t&&(u(t),t.remove())}(e)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"c",(function(){return y})),n.d(t,"b",(function(){return S}));var i=n(97),s=n(158),o=n(132),r=n(223),a=n(98),c=n(720),l=n(219);const d=["UL","OL","LI"];function u(e){return e.replace(/[\\*_[\]`<]|^>/g,e=>"\\"+e)}function h(e){let t=0,n=0;for(const i of e)"`"===i?n++:(t=Math.max(t,n),n=0);return Math.max(t,n)}function m(e){var t;return d.includes(null===(t=e.parentNode)||void 0===t?void 0:t.nodeName)}function p(e,t,n){const i=[];return e.split("@room").forEach((e,s,o)=>{e.length&&i.push(...t.plainWithEmoji(n.shouldEscape?u(e):e));s===o.length-1||i.push(t.atRoomPill("@room"))}),i}function g(e,t,n){e.unshift(n.plain(t));for(let i=0;i<e.length;i++)e[i].type===r.b.Newline&&(e.splice(i+1,0,n.plain(t)),i+=1)}function f(e,t,n,i){let o;return Array.from(e.childNodes).flatMap(e=>{const r=v(e,t,n,i);return r.length&&o&&(Object(s.c)(o)||Object(s.c)(e))&&(m(e)?r.unshift(t.newline()):r.unshift(t.newline(),t.newline())),r.length&&(o=e),r})}function v(e,t,n,i){var s;if(function(e){return e.nodeType===Node.TEXT_NODE?"\n"===e.nodeValue:e.nodeType!==Node.ELEMENT_NODE||"MX-REPLY"===e.nodeName}(e))return[];switch(e.nodeType){case Node.TEXT_NODE:return p(e.nodeValue,t,n);case Node.ELEMENT_NODE:switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return function(e,t,n){const i=parseInt(e.nodeName.slice(1),10);return[t.plain("#".repeat(i)+" "),...f(e,t,n)]}(e,t,n);case"A":return function(e,t,n){const{href:i}=e,s=Object(o.c)(i);switch(null==s?void 0:s[0]){case"@":return[t.userPill(e.textContent,s)];case"#":return[t.roomPill(s)]}const r=Array.from(e.childNodes);return i===e.textContent&&r.every(e=>e.nodeType===Node.TEXT_NODE)?p(e.textContent,t,n):[t.plain("["),...f(e,t,n),t.plain(`](${i})`)]}(e,t,n);case"IMG":return function(e,t,n){const{alt:i,src:s}=e;return t.plainWithEmoji(`![${u(i)}](${s})`)}(e,t);case"BR":return[t.newline()];case"HR":return[t.plain("---")];case"EM":return[t.plain("_"),...f(e,t,n),t.plain("_")];case"STRONG":return[t.plain("**"),...f(e,t,n),t.plain("**")];case"DEL":return[t.plain("<del>"),...f(e,t,n),t.plain("</del>")];case"SUB":return[t.plain("<sub>"),...f(e,t,n),t.plain("</sub>")];case"SUP":return[t.plain("<sup>"),...f(e,t,n),t.plain("</sup>")];case"U":return[t.plain("<u>"),...f(e,t,n),t.plain("</u>")];case"PRE":return function(e,t,n){var i;let s="";if("CODE"===(null===(i=e.firstChild)||void 0===i?void 0:i.nodeName))for(const t of e.firstChild.classList)if(t.startsWith("language-")&&!t.startsWith("language-_")){s=t.slice("language-".length);break}const o=e.textContent.replace(/\n$/,""),r="`".repeat(Math.max(3,h(o)+1)),a=[...t.plainWithEmoji(r+s),t.newline()];return o.split("\n").forEach(e=>{a.push(...t.plainWithEmoji(e)),a.push(t.newline())}),a.push(t.plain(r)),a}(e,t);case"CODE":{const n="`".repeat(h(e.textContent)+1);return t.plainWithEmoji(`${n}${e.textContent}${n}`)}case"BLOCKQUOTE":{const i=f(e,t,n);return g(i,"> ",t),i}case"LI":return null!==(s=null==i?void 0:i(e))&&void 0!==s?s:f(e,t,n);case"UL":{const i=f(e,t,n,e=>[t.plain("- "),...f(e,t,n)]);return m(e)&&g(i,"    ",t),i}case"OL":{var r;let i=null!==(r=e.start)&&void 0!==r?r:1;const s=f(e,t,n,e=>{const s=[t.plain(i+". "),...f(e,t,n)];return i++,s});return m(e)&&g(s,"    ",t),s}case"DIV":case"SPAN":if(e.hasAttribute("data-mx-maths")){var c,l,d,v,b,y,S,E;const n=a.b.get().latex_maths_delims,i="SPAN"===e.nodeName?null!==(c=null==n||null===(l=n.inline)||void 0===l?void 0:l.left)&&void 0!==c?c:"\\(":null!==(d=null==n||null===(v=n.display)||void 0===v?void 0:v.left)&&void 0!==d?d:"\\[",s="SPAN"===e.nodeName?null!==(b=null==n||null===(y=n.inline)||void 0===y?void 0:y.right)&&void 0!==b?b:"\\)":null!==(S=null==n||null===(E=n.display)||void 0===E?void 0:E.right)&&void 0!==S?S:"\\]",o=e.getAttribute("data-mx-maths");return t.plainWithEmoji(`${i}${o}${s}`)}}}return f(e,t,n)}function b(e,t,n){const i=v((new DOMParser).parseFromString(e,"text/html").body,t,n);return n.isQuotedMessage&&g(i,"> ",t),i}function y(e,t,n){const i=e.split(/\r\n|\r|\n/g);return i.reduce((e,s,o)=>{n.isQuotedMessage&&e.push(t.plain("> ")),e.push(...p(s,t,n));return o===i.length-1||e.push(t.newline()),e},[])}function S(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{shouldEscape:!0};const s=e.getContent();let o;const r=s.msgtype===i.c.Emote;let a=!1;if("org.matrix.custom.html"===s.format)o=b(s.formatted_body||"",t,n),s.body&&s.formatted_body&&Object(c.a)(s.body)===s.formatted_body&&(a=!0);else{let i=s.body||"";e.replyEventId&&(i=Object(l.e)(i)),o=y(i,t,n)}return r&&a?o.unshift(t.plain("/rainbowme ")):a?o.unshift(t.plain("/rainbow ")):r&&o.unshift(t.plain("/me ")),o}},,function(e,t,n){"use strict";(function(e){n.d(t,"d",(function(){return d})),n.d(t,"e",(function(){return u})),n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return m})),n.d(t,"c",(function(){return p}));var i=n(88),s=n.n(i),o=n(0),r=n(186),a=n(1278);class c{constructor(){s()(this,"logs",""),s()(this,"originalFunctions",{})}monkeyPatch(e){var t=this;const n={log:"I",info:"I",warn:"W",error:"E"};Object.keys(n).forEach(i=>{const s=n[i],o=e[i].bind(e);this.originalFunctions[i]=o,e[i]=function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];t.log(s,...n),o(...n)}})}bypassRageshake(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];this.originalFunctions[e](...n)}log(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];let s=`${(new Date).toISOString()} ${e} ${(n=n.map(e=>e instanceof DOMException?e.message+` (${e.name} | ${e.code})`:e instanceof Error?e.message+(e.stack?"\n"+e.stack:""):"object"==typeof e?JSON.stringify(e,Object(a.a)()):e)).join(" ")}\n`;s=s.replace(/token=[a-zA-Z0-9-]+/gm,"token=xxxxx"),this.logs+=s}flush(e){if(e)return this.logs;const t=this.logs;return this.logs="",t}}class l{constructor(e,t){this.indexedDB=e,this.logger=t,s()(this,"id",void 0),s()(this,"index",0),s()(this,"db",null),s()(this,"flushPromise",null),s()(this,"flushAgainPromise",null),this.id="instance-"+Object(r.b)(16)}connect(){const e=this.indexedDB.open("logs");return new Promise((t,n)=>{e.onsuccess=e=>{this.db=e.target.result,setInterval(this.flush.bind(this),3e4),t()},e.onerror=e=>{const t="Failed to open log database: "+e.target.error.name;o.a.error(t),n(new Error(t))},e.onupgradeneeded=e=>{const t=e.target.result,n=t.createObjectStore("logs",{keyPath:["id","index"]});n.createIndex("id","id",{unique:!1}),n.add(this.generateLogEntry(new Date+" ::: Log database was created."));t.createObjectStore("logslastmod",{keyPath:"id"}).add(this.generateLastModifiedTime())}})}flush(){return this.flushPromise?(this.flushAgainPromise||(this.flushAgainPromise=this.flushPromise.then(()=>this.flush()).then(()=>{this.flushAgainPromise=null})),this.flushAgainPromise):(this.flushPromise=new Promise((e,t)=>{if(!this.db)return void t(new Error("No connected database"));const n=this.logger.flush();if(0===n.length)return void e();const i=this.db.transaction(["logs","logslastmod"],"readwrite"),s=i.objectStore("logs");i.oncomplete=t=>{e()},i.onerror=e=>{o.a.error("Failed to flush logs : ",e),t(new Error("Failed to write logs: "+e.target.errorCode))},s.add(this.generateLogEntry(n));i.objectStore("logslastmod").put(this.generateLastModifiedTime())}).then(()=>{this.flushPromise=null}),this.flushPromise)}async consume(){const e=this.db;function t(t,n){const i=e.transaction("logs","readonly").objectStore("logs");return new Promise((e,s)=>{const o=i.index("id").openCursor(IDBKeyRange.only(t),"prev");let r="";o.onerror=e=>{s(new Error("Query failed: "+e.target.errorCode))},o.onsuccess=t=>{const i=t.target.result;i?(r=i.value.lines+r,r.length>=n?e(r):i.continue()):e(r)}})}const n=await function(e,t,n){const i=e.openCursor(t);return new Promise((e,t)=>{const s=[];i.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},i.onsuccess=t=>{const i=t.target.result;i?(s.push(n(i)),i.continue()):e(s)}})}(e.transaction("logslastmod","readonly").objectStore("logslastmod"),void 0,e=>({id:e.value.id,ts:e.value.ts})).then(e=>e.sort((e,t)=>t.ts-e.ts).map(e=>e.id));let i=[];const s=[];let r=0;for(let e=0;e<n.length;e++){const o=await t(n[e],5242880-r);if(s.push({lines:o,id:n[e]}),r+=o.length,r>=5242880){i=n.slice(e+1);break}}return i.length>0&&(o.a.log("Removing logs: ",i),Promise.all(i.map(t=>function(t){return new Promise((n,i)=>{const s=e.transaction(["logs","logslastmod"],"readwrite"),o=s.objectStore("logs");o.index("id").openKeyCursor(IDBKeyRange.only(t)).onsuccess=e=>{const t=e.target.result;t&&(o.delete(t.primaryKey),t.continue())},s.oncomplete=()=>{n()},s.onerror=e=>{i(new Error(`Failed to delete logs for '${t}' : ${e.target.errorCode}`))};s.objectStore("logslastmod").delete(t)})}(t))).then(()=>{o.a.log(`Removed ${i.length} old logs.`)},e=>{o.a.error(e)})),s}generateLogEntry(e){return{id:this.id,lines:e,index:this.index++}}generateLastModifiedTime(){return{id:this.id,ts:Date.now()}}}function d(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return e.mx_rage_initPromise?e.mx_rage_initPromise:(e.mx_rage_logger=new c,e.mx_rage_logger.monkeyPatch(window.console),t?u():(e.mx_rage_initPromise=Promise.resolve(),e.mx_rage_initPromise))}function u(){if(e.mx_rage_initStoragePromise)return e.mx_rage_initStoragePromise;let t;o.a.log("Configuring rageshake persistence...");try{t=window.indexedDB}catch(e){}return t?(e.mx_rage_store=new l(t,e.mx_rage_logger),e.mx_rage_initStoragePromise=e.mx_rage_store.connect(),e.mx_rage_initStoragePromise):(e.mx_rage_initStoragePromise=Promise.resolve(),e.mx_rage_initStoragePromise)}function h(){e.mx_rage_store&&e.mx_rage_store.flush()}async function m(){e.mx_rage_store&&await e.mx_rage_store.consume()}async function p(){if(!e.mx_rage_logger)throw new Error("No console logger, did you forget to call init()?");return e.mx_rage_store?(await e.mx_rage_store.flush(),e.mx_rage_store.consume()):[{lines:e.mx_rage_logger.flush(!0),id:"-"}]}}).call(this,n(30))},function(e,t,n){"use strict";n.d(t,"b",(function(){return m})),n.d(t,"c",(function(){return p})),n.d(t,"a",(function(){return g}));var i=n(1279),s=n(98),o=n(90),r=n(93);async function a(){const e={};if(navigator.storage&&navigator.storage.persisted)try{e.storageManager_persisted=String(await navigator.storage.persisted())}catch(e){}else if(document.hasStorageAccess)try{e.storageManager_persisted=String(await document.hasStorageAccess())}catch(e){}if(navigator.storage&&navigator.storage.estimate)try{const t=await navigator.storage.estimate();if(e.storageManager_quota=String(t.quota),e.storageManager_usage=String(t.usage),t.usageDetails){const n=[];Object.keys(t.usageDetails).forEach(e=>{n.push(`${e}: ${String(t.usageDetails[e])}`)}),e.storageManager_usage=n.join(", ")}}catch(e){}return e}function c(e){return{username:e.credentials.userId,enabled_labs:l(),low_bandwidth:r.b.getValue("lowBandwidth")?"enabled":"disabled"}}function l(){const e=r.b.getFeatureSettingNames().filter(e=>r.b.getValue(e));return e.length?e.join(", "):""}async function d(e){if(!e.isCryptoEnabled())return{};const t=["ed25519:"+e.getDeviceEd25519Key()];e.getDeviceCurve25519Key&&t.push("curve25519:"+e.getDeviceCurve25519Key());const n=e.crypto.crossSigningInfo,i=e.crypto.secretStorage,s=e.getCrossSigningCacheCallbacks(),o=await e.crypto.getSessionBackupPrivateKey();return{device_keys:t.join(", "),cross_signing_ready:String(await e.isCrossSigningReady()),cross_signing_supported_by_hs:String(await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")),cross_signing_key:n.getId(),cross_signing_privkey_in_secret_storage:String(!!await n.isStoredInSecretStorage(i)),cross_signing_master_privkey_cached:String(!(!s||!await s.getCrossSigningKeyCache("master"))),cross_signing_user_signing_privkey_cached:String(!(!s||!await s.getCrossSigningKeyCache("user_signing"))),secret_storage_ready:String(await e.isSecretStorageReady()),secret_storage_key_in_account:String(!!await i.hasKey()),session_backup_key_in_secret_storage:String(!!await e.isKeyBackupKeyStored()),session_backup_key_cached:String(!!o),session_backup_key_well_formed:String(o instanceof Uint8Array)}}function u(e){const t={device_id:null==e?void 0:e.deviceId,mx_local_settings:localStorage.getItem("mx_local_settings")};if(window.Modernizr){const e=Object.keys(window.Modernizr).filter(e=>!1===window.Modernizr[e]);e.length>0&&(t.modernizr_missing_features=e.join(", "))}return t}async function h(){const e=o.a.get();return{user:c(e),crypto:await d(e),device:u(e),storage:await a()}}async function m(e,t,n){if(!s.b.getObject("sentry"))return;const o={contexts:await h(),extra:{user_text:e,issue_url:t}};n?i.captureException(n,o):t&&i.captureMessage("Issue: "+t,o)}function p(e){s.b.get().sentry&&r.b.getValue("automaticErrorReporting")&&i.setUser({username:e})}async function g(e){if(!e)return;const t=[new i.Integrations.InboundFilters,new i.Integrations.FunctionToString,new i.Integrations.Breadcrumbs,new i.Integrations.UserAgent,new i.Integrations.Dedupe];r.b.getValue("automaticErrorReporting")&&(t.push(new i.Integrations.GlobalHandlers({onerror:!1,onunhandledrejection:!0})),t.push(new i.Integrations.TryCatch)),i.init({dsn:e.dsn,release:"!!UNSET!!",environment:e.environment,defaultIntegrations:!1,autoSessionTracking:!1,integrations:t,tracesSampleRate:1})}window.mxSendSentryReport=m},,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return _}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(97),c=n(125),l=n(98),d=n(169),u=n(89),h=n(90),m=n(105),p=n(524),g=n(195),f=n(110),v=n(101),b=n(131),y=n(746),S=n(114),E=n(109),w=n(264);class _ extends r.a.Component{constructor(e){var t,n;super(e),s()(this,"supportsRestricted",void 0),s()(this,"nameField",Object(o.createRef)()),s()(this,"aliasField",Object(o.createRef)()),s()(this,"onKeyDown",e=>{switch(Object(S.a)().getAccessibilityAction(e)){case E.h.Enter:this.onOk(),e.preventDefault(),e.stopPropagation()}}),s()(this,"onOk",async()=>{const e=document.activeElement;if(e&&e.blur(),await this.nameField.current.validate({allowEmpty:!1}),this.aliasField.current&&await this.aliasField.current.validate({allowEmpty:!1}),await new Promise(e=>this.setState({},e)),!this.state.nameIsValid||this.aliasField.current&&!this.aliasField.current.isValid){let e;this.state.nameIsValid?this.aliasField.current&&!this.aliasField.current.isValid&&(e=this.aliasField.current):e=this.nameField.current,e&&(e.focus(),e.validate({allowEmpty:!1,focused:!0}))}else this.props.onFinished(!0,this.roomCreateOptions())}),s()(this,"onCancel",()=>{this.props.onFinished(!1)}),s()(this,"onNameChange",e=>{this.setState({name:e.target.value})}),s()(this,"onTopicChange",e=>{this.setState({topic:e.target.value})}),s()(this,"onJoinRuleChange",e=>{this.setState({joinRule:e})}),s()(this,"onEncryptedChange",e=>{this.setState({isEncrypted:e})}),s()(this,"onAliasChange",e=>{this.setState({alias:e})}),s()(this,"onDetailsToggled",e=>{this.setState({detailsOpen:e.target.open})}),s()(this,"onNoFederateChange",e=>{this.setState({noFederate:e})}),s()(this,"onNameValidate",async e=>{const t=await _.validateRoomName(e);return this.setState({nameIsValid:t.valid}),t}),this.supportsRestricted=this.props.parentSpace&&!(null===(t=b.a.instance.restrictedJoinRuleSupport)||void 0===t||!t.preferred);let i=c.c.Invite;this.props.defaultPublic?i=c.c.Public:this.supportsRestricted&&(i=c.c.Restricted),this.state={isPublic:this.props.defaultPublic||!1,isEncrypted:null!==(n=this.props.defaultEncrypted)&&void 0!==n?n:Object(w.c)(),joinRule:i,name:this.props.defaultName||"",topic:"",alias:"",detailsOpen:!1,noFederate:!1===l.b.get().default_federate,nameIsValid:!1,canChangeEncryption:!0},h.a.get().doesServerForceEncryptionForPreset(c.d.PrivateChat).then(e=>this.setState({canChangeEncryption:!e}))}roomCreateOptions(){const e={},t=e.createOpts={};if(e.roomType=this.props.type,t.name=this.state.name,this.state.joinRule===c.c.Public){t.visibility=c.f.Public,t.preset=c.d.PublicChat,e.guestAccess=!1;const{alias:n}=this.state;t.room_alias_name=n.substring(1,n.indexOf(":"))}else e.encryption=!this.state.canChangeEncryption||this.state.isEncrypted;return this.state.topic&&(t.topic=this.state.topic),this.state.noFederate&&(t.creation_content={"m.federate":!1}),e.parentSpace=this.props.parentSpace,this.props.parentSpace&&this.state.joinRule===c.c.Restricted&&(e.joinRule=c.c.Restricted),e}componentDidMount(){this.nameField.current.focus()}componentWillUnmount(){}render(){const e=this.props.type===a.f.ElementVideo;let t,n,i;if(this.state.joinRule===c.c.Public){const e=h.a.get().getDomain();t=r.a.createElement("div",{className:"mx_CreateRoomDialog_aliasContainer"},r.a.createElement(p.a,{ref:this.aliasField,onChange:this.onAliasChange,domain:e,value:this.state.alias}))}if(this.state.joinRule===c.c.Restricted?n=r.a.createElement("p",null,Object(u.a)("Everyone in <SpaceName/> will be able to find and join this room.",{},{SpaceName:()=>r.a.createElement("b",null,this.props.parentSpace.name)})," ",Object(u.a)("You can change this at any time from room settings.")):this.state.joinRule===c.c.Public&&this.props.parentSpace?n=r.a.createElement("p",null,Object(u.a)("Anyone will be able to find and join this room, not just members of <SpaceName/>.",{},{SpaceName:()=>r.a.createElement("b",null,this.props.parentSpace.name)})," ",Object(u.a)("You can change this at any time from room settings.")):this.state.joinRule===c.c.Public?n=r.a.createElement("p",null,Object(u.a)("Anyone will be able to find and join this room.")," ",Object(u.a)("You can change this at any time from room settings.")):this.state.joinRule===c.c.Invite&&(n=r.a.createElement("p",null,Object(u.a)("Only people invited will be able to find and join this room.")," ",Object(u.a)("You can change this at any time from room settings."))),this.state.joinRule!==c.c.Public){let e;e=Object(w.c)()?this.state.canChangeEncryption?Object(u.a)("You can't disable this later. Bridges & most bots won't work yet."):Object(u.a)("Your server requires encryption to be enabled in private rooms."):Object(u.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."),i=r.a.createElement(r.a.Fragment,null,r.a.createElement(g.a,{label:Object(u.a)("Enable end-to-end encryption"),onChange:this.onEncryptedChange,value:this.state.isEncrypted,className:"mx_CreateRoomDialog_e2eSwitch",disabled:!this.state.canChangeEncryption}),r.a.createElement("p",null,e))}let s,o=Object(u.a)("You might enable this if the room will only be used for collaborating with internal teams on your homeserver. This cannot be changed later.");return!1===l.b.get().default_federate&&(o=Object(u.a)("You might disable this if the room will be used for collaborating with external teams who have their own homeserver. This cannot be changed later.")),s=e?Object(u.a)("Create a video room"):this.props.parentSpace?Object(u.a)("Create a room"):this.state.joinRule===c.c.Public?Object(u.a)("Create a public room"):Object(u.a)("Create a private room"),r.a.createElement(v.a,{className:"mx_CreateRoomDialog",onFinished:this.props.onFinished,title:s,screenName:"CreateRoom"},r.a.createElement("form",{onSubmit:this.onOk,onKeyDown:this.onKeyDown},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(m.a,{ref:this.nameField,label:Object(u.a)("Name"),onChange:this.onNameChange,onValidate:this.onNameValidate,value:this.state.name,className:"mx_CreateRoomDialog_name"}),r.a.createElement(m.a,{label:Object(u.a)("Topic (optional)"),onChange:this.onTopicChange,value:this.state.topic,className:"mx_CreateRoomDialog_topic"}),r.a.createElement(y.a,{label:Object(u.a)("Room visibility"),labelInvite:Object(u.a)("Private room (invite only)"),labelPublic:Object(u.a)("Public room"),labelRestricted:this.supportsRestricted?Object(u.a)("Visible to space members"):void 0,value:this.state.joinRule,onChange:this.onJoinRuleChange}),n,i,t,r.a.createElement("details",{onToggle:this.onDetailsToggled,className:"mx_CreateRoomDialog_details"},r.a.createElement("summary",{className:"mx_CreateRoomDialog_details_summary"},this.state.detailsOpen?Object(u.a)("Hide advanced"):Object(u.a)("Show advanced")),r.a.createElement(g.a,{label:Object(u.a)("Block anyone not part of %(serverName)s from ever joining this room.",{serverName:h.a.getHomeserverName()}),onChange:this.onNoFederateChange,value:this.state.noFederate}),r.a.createElement("p",null,o)))),r.a.createElement(f.a,{primaryButton:e?Object(u.a)("Create video room"):Object(u.a)("Create room"),onPrimaryButtonClick:this.onOk,onCancel:this.onCancel}))}}s()(_,"validateRoomName",Object(d.a)({rules:[{key:"required",test:async e=>{let{value:t}=e;return!!t},invalid:()=>Object(u.a)("Please enter a name for the room")}]}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(89),c=n(169),l=n(105),d=n(100);class u extends r.a.PureComponent{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"fieldRef",Object(o.createRef)()),s()(this,"onChange",e=>{this.props.onChange&&this.props.onChange(this.asFullAlias(e.target.value))}),s()(this,"onValidate",async e=>{const t=await this.validationRules(e);return this.setState({isValid:t.valid}),t}),s()(this,"validationRules",Object(c.a)({rules:[{key:"hasDomain",test:async e=>{let{value:t}=e;return!(t&&!this.props.domain)||!(t.split(":").length<2)},invalid:()=>Object(a.a)("Missing domain separator e.g. (:domain.org)")},{key:"hasLocalpart",test:async e=>{let{value:t}=e;if(!t||this.props.domain)return!0;const n=t.split(":");return n.length<2||!(n[0].length<1)},invalid:()=>Object(a.a)("Missing room name or separator e.g. (my-room:domain.org)")},{key:"safeLocalpart",test:async e=>{let{value:t}=e;if(!t)return!0;if(this.props.domain){const e=this.asFullAlias(t),n=!this.props.domain||!t.includes(":");return!t.includes("#")&&n&&!t.includes(",")&&encodeURI(e)===e}return!0},invalid:()=>Object(a.a)("Some characters not allowed")},{key:"required",test:async e=>{let{value:t,allowEmpty:n}=e;return n||!!t},invalid:()=>Object(a.a)("Please provide an address")},this.props.roomId?{key:"matches",final:!0,test:async e=>{let{value:t}=e;if(!t)return!0;const n=this.context;try{return(await n.getRoomIdForAlias(this.asFullAlias(t))).room_id===this.props.roomId}catch(e){return console.log(e),!1}},invalid:()=>Object(a.a)("This address does not point at this room")}:{key:"taken",final:!0,test:async e=>{let{value:t}=e;if(!t)return!0;const n=this.context;try{return await n.getRoomIdForAlias(this.asFullAlias(t)),!1}catch(e){return console.log(e),!!e.errcode}},valid:()=>Object(a.a)("This address is available to use"),invalid:()=>this.props.domain?Object(a.a)("This address is already in use"):Object(a.a)("This address had invalid server or is already in use")}]})),this.state={isValid:!0}}asFullAlias(e){const t="#"+e;return this.props.domain?`${t}:${this.props.domain}`:t}get domainProps(){const{domain:e}=this.props,t=r.a.createElement("span",null,"#"),n=e?r.a.createElement("span",{title:":"+e},":"+e):r.a.createElement("span",null),i=e?255-e.length-2:254;return{prefix:t,postfix:n,value:e?this.props.value.substring(1,this.props.value.length-this.props.domain.length-1):this.props.value.substring(1),maxlength:i}}render(){const{prefix:e,postfix:t,value:n,maxlength:i}=this.domainProps;return r.a.createElement(l.a,{label:this.props.label||Object(a.a)("Room address"),className:"mx_RoomAliasField",prefixComponent:e,postfixComponent:t,ref:this.fieldRef,onValidate:this.onValidate,placeholder:this.props.placeholder||Object(a.a)("e.g. my-room"),onChange:this.onChange,value:n,maxLength:i,disabled:this.props.disabled,autoComplete:"off",onKeyDown:this.props.onKeyDown})}get isValid(){return this.state.isValid}validate(e){var t;return null===(t=this.fieldRef.current)||void 0===t?void 0:t.validate(e)}focus(){var e;null===(e=this.fieldRef.current)||void 0===e||e.focus()}}s()(u,"contextType",d.a)},function(e,t,n){"use strict";var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(94),d=n.n(l),u=n(91);const h=["checked","disabled","onChange"];t.a=e=>{let{checked:t,disabled:n=!1,onChange:i}=e,o=r()(e,h);const a=d()({mx_ToggleSwitch:!0,mx_ToggleSwitch_on:t,mx_ToggleSwitch_enabled:!n});return c.a.createElement(u.a,s()({},o,{className:a,onClick:()=>{n||i(!t)},role:"switch","aria-checked":t,"aria-disabled":n}),c.a.createElement("div",{className:"mx_ToggleSwitch_ball"}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return o}));const i="ALL_ROOMS";function s(e,t){if(!t)return null;for(const n of Object.keys(e))if(e[n].instances||!(e[n].instances instanceof Array))for(const i of e[n].instances)if(i.instance_id==t)return i}function o(e,t){if(!t)return null;for(const n of Object.keys(e))if(e[n].instances||!(e[n].instances instanceof Array))for(const i of e[n].instances)if(i.instance_id==t)return n}},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(89),r=n(93),a=n(91),c=n(92),l=n(96),d=n(155),u=n(749);t.a=e=>{var t;let{featureId:n,onFinished:i}=e;const h=r.b.getBetaInfo(n);return s.a.createElement(u.a,{title:Object(o.a)("%(featureName)s Beta feedback",{featureName:h.title}),subheading:Object(o.a)(h.feedbackSubheading),onFinished:i,rageshakeLabel:h.feedbackLabel,rageshakeData:Object.fromEntries(((null===(t=r.b.getBetaInfo(n))||void 0===t?void 0:t.extraSettings)||[]).map(e=>r.b.getValue(e)))},s.a.createElement(a.a,{kind:"link",onClick:()=>{i(!1),c.a.dispatch({action:l.a.ViewUserSettings,initialTabId:d.a.Labs})}},Object(o.a)("To leave the beta, visit your settings.")))}},function(e,t,n){"use strict";n.d(t,"c",(function(){return T})),n.d(t,"b",(function(){return A})),n.d(t,"a",(function(){return M}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(97),d=n(125),u=n(0),h=n(89),m=n(117),p=n(112),g=n(183),f=n(100),v=n(750),b=n(91),y=n(105),S=n(169),E=n(524),w=n(98),_=n(95),C=n(749),O=n(93),R=n(114),I=n(109);function k(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function x(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?k(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):k(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const T=async function(e,t,n,i,s){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};return Object(g.b)(x({createOpts:x({name:e,preset:t?d.d.PublicChat:d.d.PrivateChat,power_level_content_override:{events_default:100,invite:t?0:50},room_alias_name:t&&n?n.substring(1,n.indexOf(":")):void 0,topic:i},o),avatar:s,roomType:l.f.Space,historyVisibility:t?d.b.WorldReadable:d.b.Invited,spinner:!1,encryption:!1,andView:!0,inlineErrors:!0},r))},j=e=>{let{title:t,description:n,className:i,onClick:s}=e;return r.a.createElement(b.a,{className:c()("mx_SpaceCreateMenuType",i),onClick:s},r.a.createElement("h3",null,t),r.a.createElement("span",null,n))};var N;!function(e){e[e.Public=0]="Public",e[e.Private=1]="Private"}(N||(N={}));const P=Object(S.a)({rules:[{key:"required",test:async e=>{let{value:t}=e;return!!t},invalid:()=>Object(h.a)("Please enter a name for the space")}]}),D=e=>e.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9_-]+/gi,""),A=e=>{let{onClick:t}=e;return w.b.get().bug_report_endpoint_url?r.a.createElement("div",{className:"mx_SpaceFeedbackPrompt"},r.a.createElement("span",{className:"mx_SpaceFeedbackPrompt_text"},Object(h.a)("Spaces are a new feature.")),r.a.createElement(b.a,{kind:"link",onClick:()=>{t&&t(),_.a.createTrackedDialog("Spaces Feedback","",C.a,{title:Object(h.a)("Spaces feedback"),subheading:Object(h.a)("Thank you for trying Spaces. Your feedback will help inform the next versions."),rageshakeLabel:"spaces-feedback",rageshakeData:Object.fromEntries(["Spaces.allRoomsInHome","Spaces.enabledMetaSpaces"].map(e=>[e,O.b.getValue(e)]))})}},Object(h.a)("Give feedback."))):null},M=e=>{let{busy:t,onSubmit:n,avatarUrl:i,setAvatar:s,name:a,setName:c,nameFieldRef:l,alias:d,aliasFieldRef:u,setAlias:m,showAliasField:p,topic:g,setTopic:b,children:S}=e;const w=Object(o.useContext)(f.a).getDomain(),_=e=>{switch(Object(R.a)().getAccessibilityAction(e)){case I.h.Enter:n(e)}};return r.a.createElement("form",{className:"mx_SpaceBasicSettings",onSubmit:n},r.a.createElement(v.a,{avatarUrl:i,setAvatar:s,avatarDisabled:t}),r.a.createElement(y.a,{name:"spaceName",label:Object(h.a)("Name"),autoFocus:!0,value:a,onChange:e=>{const t=e.target.value;var n;d&&d!==`#${D(a)}:${w}`||(m(`#${D(t)}:${w}`),null===(n=u.current)||void 0===n||n.validate({allowEmpty:!0}));c(t)},onKeyDown:_,ref:l,onValidate:P,disabled:t,autoComplete:"off"}),p?r.a.createElement(E.a,{ref:u,onChange:m,domain:w,value:d,placeholder:a?D(a):Object(h.a)("e.g. my-space"),label:Object(h.a)("Address"),disabled:t,onKeyDown:_}):null,r.a.createElement(y.a,{name:"spaceTopic",element:"textarea",label:Object(h.a)("Description"),value:g,onChange:e=>b(e.target.value),rows:3,disabled:t}),S)};t.d=e=>{let{onFinished:t}=e;const[n,i]=Object(o.useState)(null),[s,a]=Object(o.useState)(!1),[c,l]=Object(o.useState)(""),d=Object(o.useRef)(),[g,f]=Object(o.useState)(""),v=Object(o.useRef)(),[y,S]=Object(o.useState)(null),[E,w]=Object(o.useState)(""),_=async e=>{if(e.preventDefault(),!s){if(a(!0),!await d.current.validate({allowEmpty:!1}))return d.current.focus(),d.current.validate({allowEmpty:!1,focused:!0}),void a(!1);if(n===N.Public&&!await v.current.validate({allowEmpty:!1}))return v.current.focus(),v.current.validate({allowEmpty:!1,focused:!0}),void a(!1);try{await T(c,n===N.Public,g,E,y),t()}catch(e){u.a.error(e)}}};let C;return C=null===n?r.a.createElement(r.a.Fragment,null,r.a.createElement("h2",null,Object(h.a)("Create a space")),r.a.createElement("p",null,Object(h.a)("Spaces are a new way to group rooms and people. What kind of Space do you want to create? You can change this later.")),r.a.createElement(j,{title:Object(h.a)("Public"),description:Object(h.a)("Open space for anyone, best for communities"),className:"mx_SpaceCreateMenuType_public",onClick:()=>i(N.Public)}),r.a.createElement(j,{title:Object(h.a)("Private"),description:Object(h.a)("Invite only, best for yourself or teams"),className:"mx_SpaceCreateMenuType_private",onClick:()=>i(N.Private)}),r.a.createElement("p",null,Object(h.a)("To join a space you'll need an invite.")),r.a.createElement(A,{onClick:t})):r.a.createElement(r.a.Fragment,null,r.a.createElement(m.a,{className:"mx_SpaceCreateMenu_back",onClick:()=>i(null),title:Object(h.a)("Go back")}),r.a.createElement("h2",null,n===N.Public?Object(h.a)("Your public space"):Object(h.a)("Your private space")),r.a.createElement("p",null,Object(h.a)("Add some details to help people recognise it.")," ",Object(h.a)("You can change these anytime.")),r.a.createElement(M,{busy:s,onSubmit:_,setAvatar:S,name:c,setName:l,nameFieldRef:d,topic:E,setTopic:w,alias:g,setAlias:f,showAliasField:n===N.Public,aliasFieldRef:v}),r.a.createElement(b.a,{kind:"primary",onClick:_,disabled:s},s?Object(h.a)("Creating..."):Object(h.a)("Create"))),r.a.createElement(p.o,{left:72,top:62,chevronOffset:0,chevronFace:p.a.None,onFinished:t,wrapperClassName:"mx_SpaceCreateMenu_wrapper",managed:!1,focusLock:!0},C)}},function(e,t,n){"use strict";var i=n(87),s=n.n(i);t.a=e=>{let{value:t,max:n}=e;return s.a.createElement("progress",{className:"mx_ProgressBar",max:n,value:t})}},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return r}));var i,s=n(87);function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function r(e){return s.createElement("svg",o({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm-.12 3.504c.84-.06 1.59.57 1.68 1.426v.24l-.48 6c-.045.555-.51.975-1.064.975h-.09a1.06 1.06 0 01-.975-.975l-.48-6a1.527 1.527 0 011.41-1.666zm.12 10.26a1.32 1.32 0 110 2.64 1.32 1.32 0 010-2.64z",fill:"#ff5b55"})))}t.default="img/element-icons/warning-badge.713e1ca.svg"},function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return o}));const i="dm",s="invite",o="call_transfer"},,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(87);function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M12 2C8.13 2 5 5.215 5 9.19c0 4.284 4.42 10.19 6.24 12.44a.976.976 0 001.53 0C14.58 19.38 19 13.474 19 9.19 19 5.216 15.87 2 12 2zm0 9.759c-1.38 0-2.5-1.15-2.5-2.568 0-1.418 1.12-2.569 2.5-2.569s2.5 1.151 2.5 2.569c0 1.417-1.12 2.568-2.5 2.568z",fill:"currentColor"})))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(87);function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 26 14",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M3.654 13.153a.87.87 0 00.063-1.173c-2.41-2.93-2.41-7.185-.007-10.121A.885.885 0 003.654.673a.89.89 0 00-1.318.063c-2.93 3.582-2.93 8.765 0 12.354a.885.885 0 001.318.063zm2.529-2.529a.885.885 0 00.081-1.148 4.432 4.432 0 010-5.12.893.893 0 00-.081-1.148l-.007-.006c-.376-.377-1.016-.352-1.324.081a6.218 6.218 0 000 7.266c.314.433.948.458 1.33.075zm7.132-9.585c-2.429 0-4.392 2.018-4.392 4.512 0 2.688 2.773 6.394 3.915 7.805.25.31.709.31.96 0 1.136-1.411 3.909-5.117 3.909-7.805 0-2.494-1.964-4.512-4.392-4.512zm0 6.123c-.866 0-1.569-.722-1.569-1.611 0-.89.703-1.611 1.569-1.611s1.568.721 1.568 1.61c0 .89-.702 1.612-1.568 1.612zm8.994 4.818a.87.87 0 00.063 1.173.885.885 0 001.318-.063c2.93-3.589 2.93-8.772 0-12.354a.89.89 0 00-1.318-.063.885.885 0 00-.056 1.186c2.403 2.936 2.403 7.19-.007 10.12zm-2.547-2.504a.885.885 0 00.081 1.148c.383.383 1.017.358 1.33-.075a6.217 6.217 0 000-7.266c-.307-.433-.947-.458-1.323-.081l-.007.006a.893.893 0 00-.081 1.148 4.432 4.432 0 010 5.12z",fill:"currentColor"})))}},function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return r}));var i=n(87);const s=(e,t)=>{const n=Object(i.useRef)();Object(i.useEffect)(()=>{n.current=e},[e]),Object(i.useEffect)(()=>{const e=setTimeout(()=>{n.current()},t);return()=>clearTimeout(e)},[t])},o=(e,t)=>{const n=Object(i.useRef)();Object(i.useEffect)(()=>{n.current=e},[e]),Object(i.useEffect)(()=>{const e=setInterval(()=>{n.current()},t);return()=>clearInterval(e)},[t])},r=(e,t,n)=>{const[s,r]=Object(i.useState)(n);return o(()=>r(e=>e-1),t),0===s&&e(),s}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return r}));var i=n(90),s=n(89);function o(e,t){const n=i.a.get().getRoom(t),s=n&&n.getMember(e);return s?s.name:e}function r(e,t){const n=o(e,t);return n!==e?Object(s.a)("%(name)s (%(userId)s)",{name:n,userId:e}):e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return m})),n.d(t,"c",(function(){return p}));var i=n(88),s=n.n(i),o=n(97),r=n(152),a=n(8),c=n(156),l=n(90);let d;!function(e){e.StateChanged="state_changed",e.SilencedChanged="silenced_changed",e.LengthChanged="length_changed"}(d||(d={}));const u=[r.e.Connecting,r.e.WaitLocalMedia,r.e.CreateOffer,r.e.CreateAnswer],h=[r.e.Connected,r.e.Ringing];let m;function p(e,t){const n=new Map;return null==t||t.forEach(t=>{if(!t.getType().startsWith("m.call.")&&!t.getType().startsWith("org.matrix.call."))return;const i=t.getContent().call_id;n.has(i)||(e.has(i)?n.set(i,e.get(i)):n.set(i,new g)),n.get(i).add(t)}),n}!function(e){e.Missed="missed"}(m||(m={}));class g extends a.EventEmitter{constructor(){super(),s()(this,"events",new Set),s()(this,"call",void 0),s()(this,"state",void 0),s()(this,"onSilencedCallsChanged",()=>{const e=c.b.instance.isCallSilenced(this.callId);this.emit(d.SilencedChanged,e)}),s()(this,"onLengthChanged",e=>{this.emit(d.LengthChanged,e)}),s()(this,"answerCall",()=>{c.b.instance.answerCall(this.roomId)}),s()(this,"rejectCall",()=>{c.b.instance.hangupOrReject(this.roomId,!0)}),s()(this,"callBack",()=>{c.b.instance.placeCall(this.roomId,this.isVoice?r.f.Voice:r.f.Video)}),s()(this,"toggleSilenced",()=>{c.b.instance.isCallSilenced(this.callId)?c.b.instance.unSilenceCall(this.callId):c.b.instance.silenceCall(this.callId)}),s()(this,"setState",()=>{var e,t;u.includes(null===(e=this.call)||void 0===e?void 0:e.state)?this.state=r.e.Connecting:h.includes(null===(t=this.call)||void 0===t?void 0:t.state)?this.state=this.call.state:this.callWasMissed?this.state=m.Missed:this.reject||this.hangup?this.state=r.e.Ended:this.invite&&this.call&&(this.state=r.e.Connecting),this.emit(d.StateChanged,this.state)}),s()(this,"setCall",()=>{this.call||(this.call=c.b.instance.getCallById(this.callId),this.setCallListeners(),this.setState())}),c.b.instance.addListener(c.a.CallsChanged,this.setCall),c.b.instance.addListener(c.a.SilencedCallsChanged,this.onSilencedCallsChanged)}get invite(){return[...this.events].find(e=>e.getType()===o.b.CallInvite)}get hangup(){return[...this.events].find(e=>e.getType()===o.b.CallHangup)}get reject(){return[...this.events].find(e=>e.getType()===o.b.CallReject)}get selectAnswer(){return[...this.events].find(e=>e.getType()===o.b.CallSelectAnswer)}get isVoice(){var e,t,n;const i=this.invite;if(i)return-1===(null===(e=i.getContent())||void 0===e||null===(t=e.offer)||void 0===t||null===(n=t.sdp)||void 0===n?void 0:n.indexOf("m=video"))}get hangupReason(){var e,t;return null===(e=this.hangup)||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.reason}get rejectParty(){var e;return null===(e=this.reject)||void 0===e?void 0:e.getSender()}get gotRejected(){return Boolean(this.reject)}get duration(){if(this.hangup&&this.selectAnswer)return new Date(this.hangup.getDate().getTime()-this.selectAnswer.getDate().getTime())}get callWasMissed(){return![...this.events].some(e=>{var t;return(null===(t=e.sender)||void 0===t?void 0:t.userId)===l.a.get().getUserId()})}get callId(){var e,t;return null===(e=[...this.events][0])||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.call_id}get roomId(){var e;return null===(e=[...this.events][0])||void 0===e?void 0:e.getRoomId()}setCallListeners(){this.call&&(this.call.addListener(r.c.State,this.setState),this.call.addListener(r.c.LengthChanged,this.onLengthChanged))}add(e){this.events.has(e)||(this.events.add(e),this.setCall())}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(87),r=n(91),a=n(89);const c=["1","2","3","4","5","6","7","8","9","*","0","#"],l=["","ABC","DEF","GHI","JKL","MNO","PQRS","TUV","WXYZ","","+",""];var d;!function(e){e[e.Digit=0]="Digit",e[e.Dial=1]="Dial"}(d||(d={}));class u extends o.PureComponent{constructor(){super(...arguments),s()(this,"onClick",e=>{this.props.onButtonPress(this.props.digit,e)})}render(){switch(this.props.kind){case d.Digit:return o.createElement(r.a,{className:"mx_DialPad_button",onClick:this.onClick},this.props.digit,o.createElement("div",{className:"mx_DialPad_buttonSubText"},this.props.digitSubtext));case d.Dial:return o.createElement(r.a,{className:"mx_DialPad_button mx_DialPad_dialButton",onClick:this.onClick,"aria-label":Object(a.a)("Dial")})}}}class h extends o.PureComponent{render(){const e=[];for(let t=0;t<c.length;t++){const n=c[t],i=l[t];e.push(o.createElement(u,{key:n,kind:d.Digit,digit:n,digitSubtext:i,onButtonPress:this.props.onDigitPress}))}return this.props.hasDial&&e.push(o.createElement(u,{key:"dial",kind:d.Dial,onButtonPress:this.props.onDialPress})),o.createElement("div",{className:"mx_DialPad"},e)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d}));var i=n(89),s=n(286),o=n(197),r=n(160);const a=()=>{s.default.setEnabled(!0)},c=()=>{s.default.setPromptHidden(!0)},l=e=>{r.a.sharedInstance().addOrReplaceToast({key:"desktopnotifications",title:e?Object(i.a)("Don't miss a reply"):Object(i.a)("Notifications"),props:{description:Object(i.a)("Enable desktop notifications"),acceptLabel:Object(i.a)("Enable"),onAccept:a,rejectLabel:Object(i.a)("Dismiss"),onReject:c},component:o.a,priority:30})},d=()=>{r.a.sharedInstance().dismissToast("desktopnotifications")}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(92),r=n(297);class a{constructor(e,t){this.window=e,this.document=t,s()(this,"activeNowTimeout",void 0),s()(this,"activeRecentlyTimeout",void 0),s()(this,"attachedActiveNowTimers",[]),s()(this,"attachedActiveRecentlyTimers",[]),s()(this,"lastScreenX",0),s()(this,"lastScreenY",0),s()(this,"onPageVisibilityChanged",e=>{"hidden"===this.document.visibilityState?(this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()):this.onUserActivity(e)}),s()(this,"onWindowBlurred",()=>{this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()}),s()(this,"onUserActivity",e=>{if(this.document.hasFocus()){if(e.screenX&&"mousemove"===e.type){if(e.screenX===this.lastScreenX&&e.screenY===this.lastScreenY)return;this.lastScreenX=e.screenX,this.lastScreenY=e.screenY}o.a.dispatch({action:"user_activity"}),this.activeNowTimeout.isRunning()?this.activeNowTimeout.restart():(this.activeNowTimeout.start(),o.a.dispatch({action:"user_activity_start"}),a.runTimersUntilTimeout(this.attachedActiveNowTimers,this.activeNowTimeout)),this.activeRecentlyTimeout.isRunning()?this.activeRecentlyTimeout.restart():(this.activeRecentlyTimeout.start(),a.runTimersUntilTimeout(this.attachedActiveRecentlyTimers,this.activeRecentlyTimeout))}}),this.activeNowTimeout=new r.a(700),this.activeRecentlyTimeout=new r.a(12e4)}static sharedInstance(){return void 0===window.mxUserActivity&&(window.mxUserActivity=new a(window,document)),window.mxUserActivity}timeWhileActiveNow(e){this.timeWhile(e,this.attachedActiveNowTimers),this.userActiveNow()&&e.start()}timeWhileActiveRecently(e){this.timeWhile(e,this.attachedActiveRecentlyTimers),this.userActiveRecently()&&e.start()}timeWhile(e,t){-1===t.indexOf(e)&&(t.push(e),e.finished().finally(()=>{const n=t.indexOf(e);-1!==n&&t.splice(n,1)}).catch(e=>{}))}start(){this.document.addEventListener("mousedown",this.onUserActivity),this.document.addEventListener("mousemove",this.onUserActivity),this.document.addEventListener("keydown",this.onUserActivity),this.document.addEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.addEventListener("blur",this.onWindowBlurred),this.window.addEventListener("focus",this.onUserActivity),this.window.addEventListener("wheel",this.onUserActivity,{passive:!0,capture:!0})}stop(){this.document.removeEventListener("mousedown",this.onUserActivity),this.document.removeEventListener("mousemove",this.onUserActivity),this.document.removeEventListener("keydown",this.onUserActivity),this.window.removeEventListener("wheel",this.onUserActivity,{capture:!0}),this.document.removeEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.removeEventListener("blur",this.onWindowBlurred),this.window.removeEventListener("focus",this.onUserActivity)}userActiveNow(){return this.activeNowTimeout.isRunning()}userActiveRecently(){return this.activeRecentlyTimeout.isRunning()}static async runTimersUntilTimeout(e,t){e.forEach(e=>e.start());try{await t.finished()}catch(e){}e.forEach(e=>e.abort())}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(188),r=n(270);class a extends o.a{getValueOverride(e,t,n,i){if(!n)return null;if(a.isLogin)return"light";return Object(r.b)()[n]?null:r.a}}s()(a,"isLogin",!1)},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(88),s=n.n(i),o=n(92),r=n(93),a=n(490),c=n(96),l=n(104);class d{constructor(){s()(this,"dispatcherRef",void 0),s()(this,"onAction",e=>{e.action===c.a.UpdateFontSize?this.setRootFontSize(e.size):e.action===c.a.UpdateSystemFont?this.setSystemFont(e):e.action===c.a.OnLoggedOut?(this.setRootFontSize(d.DEFAULT_SIZE),this.setSystemFont({useSystemFont:!1,font:""})):e.action===c.a.OnLoggedIn&&this.updateFont()}),s()(this,"setRootFontSize",e=>{const t=Math.max(Math.min(d.MAX_SIZE,e),d.MIN_SIZE);t!==e&&r.b.setValue("baseFontSize",null,l.a.DEVICE,t),document.querySelector(":root").style.fontSize=Object(a.a)(t)}),s()(this,"setSystemFont",e=>{let{useSystemFont:t,font:n}=e;document.body.style.fontFamily=t?n.split(",").map(e=>((e=e.trim()).startsWith('"')||e.endsWith('"')||(e=`"${e}"`),e)).join(","):""}),this.dispatcherRef=null}start(){this.updateFont(),this.dispatcherRef=o.a.register(this.onAction)}stop(){o.a.unregister(this.dispatcherRef)}updateFont(){this.setRootFontSize(r.b.getValue("baseFontSize")),this.setSystemFont({useSystemFont:r.b.getValue("useSystemFont"),font:r.b.getValue("systemFont")})}}s()(d,"MIN_SIZE",8),s()(d,"DEFAULT_SIZE",10),s()(d,"MAX_SIZE",15),s()(d,"SIZE_DIFF",5)},,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return H})),n.d(t,"c",(function(){return q})),n.d(t,"b",(function(){return $}));var i=n(119),s=n(87),o=n.n(s),r=n(89),a=n(622),c=n(550),l=n(90),d=n(188);class u extends d.a{constructor(e,t){super(),this.setter=e,this.inverse=t}onChange(e,t,n){this.setter.call(l.a.get(),this.inverse?!n:n)}}var h=n(126);class m extends d.a{onChange(e,t,n){h.a.get().reload()}}var p=n(92),g=n(96);class f extends d.a{constructor(){super()}onChange(e,t,n){p.a.dispatch({action:g.a.UpdateFontSize,size:n})}}var v=n(93);class b extends d.a{constructor(){super()}onChange(e,t,n){p.a.dispatch({action:g.a.UpdateSystemFont,useSystemFont:v.b.getValue("useSystemFont"),font:n})}}class y extends d.a{constructor(){super()}onChange(e,t,n){p.a.dispatch({action:g.a.UpdateSystemFont,useSystemFont:n,font:v.b.getValue("systemFont")})}}var S=n(104),E=n(192);class w extends d.a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(),this.uiFeatureName=e,this.forcedValue=t}getValueOverride(e,t,n,i){return this.settingDisabled?this.forcedValue:null}get settingDisabled(){return!v.b.getValue(this.uiFeatureName)}}var _=n(122);class C extends d.a{constructor(e){super(),this.controllers=e}getValueOverride(e,t,n,i){for(const s of this.controllers){const o=s.getValueOverride(e,t,n,i);if(null!=o)return o}return null}onChange(e,t,n){for(const i of this.controllers)i.onChange(e,t,n)}get settingDisabled(){for(const e of this.controllers)if(e.settingDisabled)return!0;return!1}}var O=n(157);class R extends d.a{getValueOverride(e,t,n,i){return!this.prefersReducedMotion()&&null}get settingDisabled(){return this.prefersReducedMotion()}prefersReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}}var I=n(607),k=n(409),x=n(171),T=n(98),j=n(137),N=n(95),P=n(115);class D extends d.a{async beforeChange(e,t,n){if(j.d.hasServerSideSupport||!n)return!0;const{finished:i}=N.a.createTrackedDialog("Thread beta","degraded mode",P.a,{title:Object(r.a)("Partial Support for Threads"),description:s.createElement(s.Fragment,null,s.createElement("p",null,Object(r.a)("Your homeserver does not currently support threads, so this feature may be unreliable. Some threaded messages may not be reliably available. <a>Learn more</a>.",{},{a:e=>s.createElement("a",{href:"https://element.io/help#threads",target:"_blank",rel:"noreferrer noopener"},e)})),s.createElement("p",null,Object(r.a)("Do you want to enable threads anyway?"))),button:Object(r.a)("Yes, enable")}),[o]=await i;return o}onChange(e,t,n){h.a.get().reload()}}var A=n(551);const M=[S.a.DEVICE,S.a.ROOM_DEVICE,S.a.ROOM_ACCOUNT,S.a.ACCOUNT,S.a.CONFIG],U=[S.a.ROOM_ACCOUNT,S.a.ACCOUNT],L=[S.a.DEVICE,S.a.ROOM_DEVICE,S.a.ROOM_ACCOUNT,S.a.ACCOUNT,S.a.CONFIG,S.a.ROOM],F=[S.a.DEVICE,S.a.ACCOUNT,S.a.CONFIG],B=[S.a.DEVICE,S.a.CONFIG],K=[S.a.DEVICE],V=[S.a.DEVICE,S.a.CONFIG],W=[S.a.CONFIG];let H;!function(e){e[e.Messaging=0]="Messaging",e[e.Profile=1]="Profile",e[e.Spaces=2]="Spaces",e[e.Widgets=3]="Widgets",e[e.Rooms=4]="Rooms",e[e.Moderation=5]="Moderation",e[e.Analytics=6]="Analytics",e[e.MessagePreviews=7]="MessagePreviews",e[e.Themes=8]="Themes",e[e.Encryption=9]="Encryption",e[e.Experimental=10]="Experimental",e[e.Developer=11]="Developer"}(H||(H={}));const q={[H.Messaging]:Object(r.c)("Messaging"),[H.Profile]:Object(r.c)("Profile"),[H.Spaces]:Object(r.c)("Spaces"),[H.Widgets]:Object(r.c)("Widgets"),[H.Rooms]:Object(r.c)("Rooms"),[H.Moderation]:Object(r.c)("Moderation"),[H.Analytics]:Object(r.c)("Analytics"),[H.MessagePreviews]:Object(r.c)("Message Previews"),[H.Themes]:Object(r.c)("Themes"),[H.Encryption]:Object(r.c)("Encryption"),[H.Experimental]:Object(r.c)("Experimental"),[H.Developer]:Object(r.c)("Developer")},$={feature_msc3531_hide_messages_pending_moderation:{isFeature:!0,labsGroup:H.Moderation,controller:new m,displayName:Object(r.c)("Let moderators hide messages pending moderation."),supportedLevels:B,default:!1},feature_report_to_moderators:{isFeature:!0,labsGroup:H.Moderation,displayName:Object(r.c)("Report to moderators prototype. In rooms that support moderation, the `report` button will let you report abuse to room moderators"),supportedLevels:B,default:!1},feature_latex_maths:{isFeature:!0,labsGroup:H.Messaging,displayName:Object(r.c)("Render LaTeX maths in messages"),supportedLevels:B,default:!1},feature_pinning:{isFeature:!0,labsGroup:H.Messaging,displayName:Object(r.c)("Message Pinning"),supportedLevels:B,default:!1},feature_thread:{isFeature:!0,labsGroup:H.Messaging,controller:new D,displayName:Object(r.c)("Threaded messaging"),supportedLevels:B,default:!1,betaInfo:{title:Object(r.c)("Threads"),caption:()=>o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(r.a)("Keep discussions organised with threads.")),o.a.createElement("p",null,Object(r.a)("Threads help keep conversations on-topic and easy to track. <a>Learn more</a>.",{},{a:e=>o.a.createElement("a",{href:"https://element.io/help#threads",rel:"noreferrer noopener",target:"_blank"},e)}))),disclaimer:()=>T.b.get().bug_report_endpoint_url&&o.a.createElement(o.a.Fragment,null,o.a.createElement("h4",null,Object(r.a)("How can I start a thread?")),o.a.createElement("p",null,Object(r.a)("Use “%(replyInThread)s” when hovering over a message.",{replyInThread:Object(r.a)("Reply in thread")})),o.a.createElement("h4",null,Object(r.a)("How can I leave the beta?")),o.a.createElement("p",null,Object(r.a)("To leave, return to this page and use the “%(leaveTheBeta)s” button.",{leaveTheBeta:Object(r.a)("Leave the beta")}))),feedbackLabel:"thread-feedback",feedbackSubheading:Object(r.c)("Thank you for trying the beta, please go into as much detail as you can so we can improve it."),image:n(1378),requiresRefresh:!0}},feature_video_rooms:{isFeature:!0,labsGroup:H.Rooms,displayName:Object(r.c)("Video rooms (under active development)"),supportedLevels:B,default:!1,controller:new m},feature_state_counters:{isFeature:!0,labsGroup:H.Rooms,displayName:Object(r.c)("Render simple counters in room header"),supportedLevels:B,default:!1},feature_mjolnir:{isFeature:!0,labsGroup:H.Moderation,displayName:Object(r.c)("Try out new ways to ignore people (experimental)"),supportedLevels:B,default:!1},feature_custom_themes:{isFeature:!0,labsGroup:H.Themes,displayName:Object(r.c)("Support adding custom themes"),supportedLevels:B,default:!1},feature_roomlist_preview_reactions_dms:{isFeature:!0,labsGroup:H.MessagePreviews,displayName:Object(r.c)("Show message previews for reactions in DMs"),supportedLevels:B,default:!1,controller:new I.a("feature_roomlist_preview_reactions_all")},feature_roomlist_preview_reactions_all:{isFeature:!0,labsGroup:H.MessagePreviews,displayName:Object(r.c)("Show message previews for reactions in all rooms"),supportedLevels:B,default:!1},feature_dehydration:{isFeature:!0,labsGroup:H.Encryption,displayName:Object(r.c)("Offline encrypted messaging using dehydrated devices"),supportedLevels:B,default:!1},feature_extensible_events:{isFeature:!0,labsGroup:H.Developer,supportedLevels:B,displayName:Object(r.c)("Show extensible event representation of events"),default:!1},feature_use_only_current_profiles:{isFeature:!0,labsGroup:H.Rooms,supportedLevels:B,displayName:Object(r.c)("Show current avatar and name for users in message history"),default:!1},mjolnirRooms:{supportedLevels:[S.a.ACCOUNT],default:[]},mjolnirPersonalRoom:{supportedLevels:[S.a.ACCOUNT],default:null},feature_bridge_state:{isFeature:!0,labsGroup:H.Rooms,supportedLevels:B,displayName:Object(r.c)("Show info about bridges in room settings"),default:!1},feature_breadcrumbs_v2:{isFeature:!0,labsGroup:H.Rooms,supportedLevels:B,displayName:Object(r.c)("Use new room breadcrumbs"),default:!1},feature_spotlight:{isFeature:!0,labsGroup:H.Rooms,supportedLevels:B,displayName:Object(r.c)("New search experience"),default:!1,betaInfo:{title:Object(r.c)("The new search"),caption:()=>o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(r.a)("A new, quick way to search spaces and rooms you're in.")),o.a.createElement("p",null,Object(r.a)("This feature is a work in progress, we'd love to hear your feedback."))),disclaimer:()=>o.a.createElement(o.a.Fragment,null,T.b.get().bug_report_endpoint_url&&o.a.createElement(o.a.Fragment,null,o.a.createElement("h4",null,Object(r.a)("How can I give feedback?")),o.a.createElement("p",null,Object(r.a)("To feedback, join the beta, start a search and click on feedback."))),o.a.createElement("h4",null,Object(r.a)("How can I leave the beta?")),o.a.createElement("p",null,Object(r.a)("To leave, just return to this page or click on the beta badge when you search."))),feedbackLabel:"spotlight-feedback",feedbackSubheading:Object(r.c)("Thank you for trying the beta, please go into as much detail as you can so we can improve it."),image:n(1379)}},feature_right_panel_default_open:{isFeature:!0,labsGroup:H.Rooms,supportedLevels:B,displayName:Object(r.c)("Right panel stays open (defaults to room member list)"),default:!1},feature_jump_to_date:{displayName:Object(r.c)("Jump to date (adds /jumptodate and jump to date headers)"),supportedLevels:B,default:!1},"RoomList.backgroundImage":{supportedLevels:F,default:null},feature_hidden_read_receipts:{supportedLevels:B,displayName:Object(r.c)("Don't send read receipts"),default:!1},feature_message_right_click_context_menu:{isFeature:!0,supportedLevels:B,labsGroup:H.Rooms,displayName:Object(r.c)("Right-click message context menu"),default:!1},feature_location_share_pin_drop:{isFeature:!0,labsGroup:H.Messaging,supportedLevels:B,displayName:Object(r.c)("Location sharing - pin drop"),default:!1},feature_location_share_live:{isFeature:!0,labsGroup:H.Messaging,supportedLevels:B,displayName:Object(r.c)("Live Location Sharing (temporary implementation: locations persist in room history)"),default:!1},baseFontSize:{displayName:Object(r.c)("Font size"),supportedLevels:F,default:A.a.DEFAULT_SIZE,controller:new f},useCustomFontSize:{displayName:Object(r.c)("Use custom size"),supportedLevels:F,default:!1},"MessageComposerInput.suggestEmoji":{supportedLevels:F,displayName:Object(r.c)("Enable Emoji suggestions while typing"),default:!0,invertedSettingName:"MessageComposerInput.dontSuggestEmoji"},"MessageComposerInput.showStickersButton":{supportedLevels:F,displayName:Object(r.c)("Show stickers button"),default:!0,controller:new w(_.b.Widgets,!1)},"MessageComposerInput.showPollsButton":{supportedLevels:F,displayName:Object(r.c)("Show polls button"),default:!0},"MessageComposerInput.insertTrailingColon":{supportedLevels:F,displayName:Object(r.c)("Insert a trailing colon after user mentions at the start of a message"),default:!0},"Notifications.alwaysShowBadgeCounts":{supportedLevels:U,default:!1},useCompactLayout:{supportedLevels:K,displayName:Object(r.c)("Use a more compact 'Modern' layout"),default:!1,controller:new I.a("layout",!1,e=>e!==O.a.Group)},showRedactions:{supportedLevels:L,displayName:Object(r.c)("Show a placeholder for removed messages"),default:!0,invertedSettingName:"hideRedactions"},showJoinLeaves:{supportedLevels:L,displayName:Object(r.c)("Show join/leave messages (invites/removes/bans unaffected)"),default:!0,invertedSettingName:"hideJoinLeaves"},showAvatarChanges:{supportedLevels:L,displayName:Object(r.c)("Show avatar changes"),default:!0,invertedSettingName:"hideAvatarChanges"},showDisplaynameChanges:{supportedLevels:L,displayName:Object(r.c)("Show display name changes"),default:!0,invertedSettingName:"hideDisplaynameChanges"},showReadReceipts:{supportedLevels:M,displayName:Object(r.c)("Show read receipts sent by other users"),default:!0,invertedSettingName:"hideReadReceipts"},showTwelveHourTimestamps:{supportedLevels:F,displayName:Object(r.c)("Show timestamps in 12 hour format (e.g. 2:30pm)"),default:!1},alwaysShowTimestamps:{supportedLevels:F,displayName:Object(r.c)("Always show message timestamps"),default:!1},autoplayGifs:{supportedLevels:F,displayName:Object(r.c)("Autoplay GIFs"),default:!1},autoplayVideo:{supportedLevels:F,displayName:Object(r.c)("Autoplay videos"),default:!1},enableSyntaxHighlightLanguageDetection:{supportedLevels:F,displayName:Object(r.c)("Enable automatic language detection for syntax highlighting"),default:!1},expandCodeByDefault:{supportedLevels:F,displayName:Object(r.c)("Expand code blocks by default"),default:!1},showCodeLineNumbers:{supportedLevels:F,displayName:Object(r.c)("Show line numbers in code blocks"),default:!0},scrollToBottomOnMessageSent:{supportedLevels:F,displayName:Object(r.c)("Jump to the bottom of the timeline when you send a message"),default:!0},"Pill.shouldShowPillAvatar":{supportedLevels:F,displayName:Object(r.c)("Show avatars in user and room mentions"),default:!0,invertedSettingName:"Pill.shouldHidePillAvatar"},"TextualBody.enableBigEmoji":{supportedLevels:F,displayName:Object(r.c)("Enable big emoji in chat"),default:!0,invertedSettingName:"TextualBody.disableBigEmoji"},"MessageComposerInput.isRichTextEnabled":{supportedLevels:F,default:!1},"MessageComposer.showFormatting":{supportedLevels:F,default:!1},sendTypingNotifications:{supportedLevels:F,displayName:Object(r.c)("Send typing notifications"),default:!0,invertedSettingName:"dontSendTypingNotifications"},showTypingNotifications:{supportedLevels:F,displayName:Object(r.c)("Show typing notifications"),default:!0},ctrlFForSearch:{supportedLevels:F,displayName:E.a?Object(r.c)("Use Command + F to search timeline"):Object(r.c)("Use Ctrl + F to search timeline"),default:!1},"MessageComposerInput.ctrlEnterToSend":{supportedLevels:F,displayName:E.a?Object(r.c)("Use Command + Enter to send a message"):Object(r.c)("Use Ctrl + Enter to send a message"),default:!1},"MessageComposerInput.surroundWith":{supportedLevels:F,displayName:Object(r.c)("Surround selected text when typing special characters"),default:!1},"MessageComposerInput.autoReplaceEmoji":{supportedLevels:F,displayName:Object(r.c)("Automatically replace plain text Emoji"),default:!1},"MessageComposerInput.useMarkdown":{supportedLevels:F,displayName:Object(r.c)("Enable Markdown"),description:()=>Object(r.a)("Start messages with <code>/plain</code> to send without markdown and <code>/md</code> to send with.",{},{code:e=>o.a.createElement("code",null,e)}),default:!0},"VideoView.flipVideoHorizontally":{supportedLevels:F,displayName:Object(r.c)("Mirror local video feed"),default:!1},theme:{supportedLevels:F,default:"light",controller:new c.a},custom_themes:{supportedLevels:F,default:[]},use_system_theme:{supportedLevels:K,default:!0,displayName:Object(r.c)("Match system theme")},useSystemFont:{supportedLevels:K,default:!1,displayName:Object(r.c)("Use a system font"),controller:new y},systemFont:{supportedLevels:K,default:"",displayName:Object(r.c)("System font name"),controller:new b},webRtcAllowPeerToPeer:{supportedLevels:V,displayName:Object(r.c)("Allow Peer-to-Peer for 1:1 calls (if you enable this, the other party might be able to see your IP address)"),default:!0,invertedSettingName:"webRtcForceTURN"},webrtc_audiooutput:{supportedLevels:K,default:"default"},webrtc_audioinput:{supportedLevels:K,default:"default"},webrtc_videoinput:{supportedLevels:K,default:"default"},language:{supportedLevels:V,default:"en"},breadcrumb_rooms:{supportedLevels:[S.a.ACCOUNT],default:[]},recent_emoji:{supportedLevels:[S.a.ACCOUNT],default:[]},"SpotlightSearch.recentSearches":{supportedLevels:[S.a.ACCOUNT],default:[]},room_directory_servers:{supportedLevels:[S.a.ACCOUNT],default:[]},integrationProvisioning:{supportedLevels:[S.a.ACCOUNT],default:!0},allowedWidgets:{supportedLevels:[S.a.ROOM_ACCOUNT,S.a.ROOM_DEVICE],supportedLevelsAreOrdered:!0,default:{}},analyticsOptIn:{supportedLevels:V,displayName:Object(r.c)("Send analytics data"),default:!1},showCookieBar:{supportedLevels:V,default:!0},pseudonymousAnalyticsOptIn:{supportedLevels:[S.a.ACCOUNT],displayName:Object(r.c)("Send analytics data"),default:null},autocompleteDelay:{supportedLevels:V,default:200},readMarkerInViewThresholdMs:{supportedLevels:V,default:3e3},readMarkerOutOfViewThresholdMs:{supportedLevels:V,default:3e4},blacklistUnverifiedDevices:{supportedLevels:[S.a.ROOM_DEVICE,S.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:{default:Object(r.c)("Never send encrypted messages to unverified sessions from this session"),"room-device":Object(r.c)("Never send encrypted messages to unverified sessions in this room from this session")},default:!1,controller:new w(_.b.AdvancedEncryption)},urlPreviewsEnabled:{supportedLevels:L,displayName:{default:Object(r.c)("Enable inline URL previews by default"),"room-account":Object(r.c)("Enable URL previews for this room (only affects you)"),room:Object(r.c)("Enable URL previews by default for participants in this room")},default:!0,controller:new w(_.b.URLPreviews)},urlPreviewsEnabled_e2ee:{supportedLevels:[S.a.ROOM_DEVICE,S.a.ROOM_ACCOUNT],displayName:{"room-account":Object(r.c)("Enable URL previews for this room (only affects you)")},default:!1,controller:new w(_.b.URLPreviews)},notificationsEnabled:{supportedLevels:K,default:!1,controller:new a.b},notificationSound:{supportedLevels:U,default:!1},notificationBodyEnabled:{supportedLevels:K,default:!0,controller:new a.a},audioNotificationsEnabled:{supportedLevels:K,default:!0},enableWidgetScreenshots:{supportedLevels:F,displayName:Object(r.c)("Enable widget screenshots on supported widgets"),default:!1},promptBeforeInviteUnknownUsers:{supportedLevels:F,displayName:Object(r.c)("Prompt before sending invites to potentially invalid matrix IDs"),default:!0},widgetOpenIDPermissions:{supportedLevels:K,default:{allow:[],deny:[]}},"RoomList.orderAlphabetically":{supportedLevels:F,displayName:Object(r.c)("Order rooms by name"),default:!1},"RoomList.orderByImportance":{supportedLevels:F,displayName:Object(r.c)("Show rooms with unread notifications first"),default:!0},breadcrumbs:{supportedLevels:F,displayName:Object(r.c)("Show shortcuts to recently viewed rooms above the room list"),default:!0,controller:new I.a("feature_breadcrumbs_v2",!0)},showHiddenEventsInTimeline:{displayName:Object(r.c)("Show hidden events in timeline"),supportedLevels:K,default:!1},lowBandwidth:{supportedLevels:V,displayName:Object(r.c)("Low bandwidth mode (requires compatible homeserver)"),default:!1,controller:new m},fallbackICEServerAllowed:{supportedLevels:K,displayName:Object(r.c)("Allow fallback call assist server turn.matrix.org when your homeserver does not offer one (your IP address would be shared during a call)"),default:null},showImages:{supportedLevels:F,displayName:Object(r.c)("Show previews/thumbnails for images"),default:!0},"RightPanel.phasesGlobal":{supportedLevels:[S.a.DEVICE],default:null},"RightPanel.phases":{supportedLevels:[S.a.ROOM_DEVICE],default:null},enableEventIndexing:{supportedLevels:K,displayName:Object(r.c)("Enable message search in encrypted rooms"),default:!0},crawlerSleepTime:{supportedLevels:K,displayName:Object(r.c)("How fast should messages be downloaded."),default:3e3},showCallButtonsInComposer:{supportedLevels:V,default:!0,controller:new w(_.b.Voip)},"e2ee.manuallyVerifyAllSessions":{supportedLevels:K,displayName:Object(r.c)("Manually verify all remote sessions"),default:!1,controller:new C([new w(_.b.AdvancedEncryption),new u(i.c.prototype.setCryptoTrustCrossSignedDevices,!0)])},ircDisplayNameWidth:{supportedLevels:[S.a.ROOM_DEVICE,S.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:Object(r.c)("IRC display name width"),default:80},layout:{supportedLevels:F,default:O.a.Group},"Images.size":{supportedLevels:F,default:k.a.Normal},showChatEffects:{supportedLevels:L,displayName:Object(r.c)("Show chat effects (animations when receiving e.g. confetti)"),default:!0,controller:new R},"Performance.addSendMessageTimingMetadata":{supportedLevels:[S.a.CONFIG],default:!1},"Widgets.pinned":{supportedLevels:U,default:{}},"Widgets.layout":{supportedLevels:U,default:{}},"Spaces.allRoomsInHome":{displayName:Object(r.c)("Show all rooms in Home"),description:Object(r.c)("All rooms you're in will appear in Home."),supportedLevels:F,default:!1},"Spaces.enabledMetaSpaces":{supportedLevels:F,default:{[x.a.Home]:!0}},"Spaces.showPeopleInSpace":{supportedLevels:[S.a.ROOM_ACCOUNT],default:!0},developerMode:{displayName:Object(r.c)("Developer mode"),supportedLevels:F,default:!1},automaticErrorReporting:{displayName:Object(r.c)("Automatically send debug logs on any error"),supportedLevels:F,default:!1,controller:new m},automaticDecryptionErrorReporting:{displayName:Object(r.c)("Automatically send debug logs on decryption errors"),supportedLevels:K,default:!1,controller:new m},automaticKeyBackNotEnabledReporting:{displayName:Object(r.c)("Automatically send debug logs when key backup is not functioning"),supportedLevels:V,default:!1},debug_scroll_panel:{supportedLevels:K,default:!1},debug_timeline_panel:{supportedLevels:K,default:!1},debug_registration:{supportedLevels:K,default:!1},audioInputMuted:{supportedLevels:K,default:!1},videoInputMuted:{supportedLevels:K,default:!1},videoChannelRoomId:{supportedLevels:K,default:null},[_.b.RoomHistorySettings]:{supportedLevels:W,default:!0},[_.b.AdvancedEncryption]:{supportedLevels:W,default:!0},[_.b.URLPreviews]:{supportedLevels:W,default:!0},[_.b.Widgets]:{supportedLevels:W,default:!0},[_.b.Voip]:{supportedLevels:W,default:!0},[_.b.Feedback]:{supportedLevels:W,default:!0},[_.b.Registration]:{supportedLevels:W,default:!0},[_.b.PasswordReset]:{supportedLevels:W,default:!0},[_.b.Deactivate]:{supportedLevels:W,default:!0},[_.b.ShareQRCode]:{supportedLevels:W,default:!0},[_.b.ShareSocial]:{supportedLevels:W,default:!0},[_.b.IdentityServer]:{supportedLevels:W,default:!0,controller:new w(_.b.ThirdPartyID)},[_.b.ThirdPartyID]:{supportedLevels:W,default:!0},[_.b.AdvancedSettings]:{supportedLevels:W,default:!0},[_.b.TimelineEnableRelativeDates]:{supportedLevels:W,default:!0}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var i=n(88),s=n.n(i),o=n(7),r=n(165),a=n(167),c=n(92),l=n(97),d=n(89),u=n(90),h=n(166);function m(e){const t=u.a.get().getUserId();return"m.room.member"===e.getType()?e.getStateKey()===t:e.getSender()===t}function p(e,t){if(t!==h.a.DM)return!0;const n=u.a.get().getRoom(e);return!n||2!==n.currentState.getJoinedMemberCount()}function g(e){return e.sender?e.sender.name:e.getSender()}var f=n(158),v=n(219);var b=n(100);class y{constructor(){s()(this,"context",void 0)}getTextFor(e,t,n){let i=e.getContent();if(e.isRelation("m.replace")&&(i=e.getContent()["m.new_content"]),!i)return null;try{let s=new r.PollStartEvent({type:e.getType(),content:i}).question.text.trim();return s=Object(d.k)(s),n||m(e)||!p(e.getRoomId(),t)?s:Object(d.a)("%(senderName)s: %(message)s",{senderName:g(e),message:s})}catch(e){if(e instanceof r.InvalidEventError)return null;throw e}}}s()(y,"contextType",b.a);var S=n(93),E=n(135);var w=n(123);const _={"m.room.message":{isState:!1,previewer:new class{getTextFor(e,t,n){var i,s,o;let r=e.getContent();if(e.isRelation(l.d.Replace)&&(r=e.getContent()["m.new_content"]),null===(i=r)||void 0===i||!i.body)return null;let a=r.body.trim();if(!a)return null;const c=null!==(s=r.msgtype)&&void 0!==s?s:l.c.Text,u="org.matrix.custom.html"===r.format&&r.formatted_body;if(u&&(a=r.formatted_body),null!==(o=e.getWireContent()["m.relates_to"])&&void 0!==o&&o["m.in_reply_to"]&&(a=u?(Object(v.d)(a)||"").trim():(Object(v.e)(a)||"").trim(),!a))return null;if(u){const e=Object(f.d)(a.replace(/<br\/?>/gi,"\n"));a=(new DOMParser).parseFromString(e,"text/html").documentElement.textContent}return a=Object(d.k)(a),c===l.c.Emote?Object(d.a)("* %(senderName)s %(emote)s",{senderName:g(e),emote:a}):n||m(e)||!p(e.getRoomId(),t)?a:Object(d.a)("%(senderName)s: %(message)s",{senderName:g(e),message:a})}}},"m.call.invite":{isState:!1,previewer:new class{getTextFor(e,t){return p(e.getRoomId(),t)?m(e)?Object(d.a)("You started a call"):Object(d.a)("%(senderName)s started a call",{senderName:g(e)}):m(e)?Object(d.a)("Waiting for answer"):Object(d.a)("%(senderName)s is calling",{senderName:g(e)})}}},"m.call.answer":{isState:!1,previewer:new class{getTextFor(e,t){return p(e.getRoomId(),t)?m(e)?Object(d.a)("You joined the call"):Object(d.a)("%(senderName)s joined the call",{senderName:g(e)}):Object(d.a)("Call in progress")}}},"m.call.hangup":{isState:!1,previewer:new class{getTextFor(e,t){return p(e.getRoomId(),t)?m(e)?Object(d.a)("You ended the call"):Object(d.a)("%(senderName)s ended the call",{senderName:g(e)}):Object(d.a)("Call ended")}}},"m.sticker":{isState:!1,previewer:new class{getTextFor(e,t,n){const i=e.getContent().body;return i?n||m(e)||!p(e.getRoomId(),t)?i:Object(d.a)("%(senderName)s: %(stickerName)s",{senderName:g(e),stickerName:i}):null}}},"m.reaction":{isState:!1,previewer:new class{getTextFor(e,t,n){const i=S.b.getValue("feature_roomlist_preview_reactions_dms");if(!(S.b.getValue("feature_roomlist_preview_reactions_all")||i&&E.a.shared().getUserIdForRoomId(e.getRoomId())))return null;const s=e.getRelation();if(!s)return null;const o=s.key;return o?n||m(e)||!p(e.getRoomId(),t)?o:Object(d.a)("%(senderName)s: %(reaction)s",{senderName:g(e),reaction:o}):null}}},[r.M_POLL_START.name]:{isState:!1,previewer:new y},[r.M_POLL_START.altName]:{isState:!1,previewer:new y}},C="im.vector.any";class O extends a.a{constructor(){super(c.a,{}),s()(this,"previews",new Map)}static get instance(){return O.internalInstance}static getPreviewChangedEventName(e){return"room_preview_changed:"+(null==e?void 0:e.roomId)}async getPreviewForRoom(e,t){if(!e)return null;this.previews.has(e.roomId)||await this.generatePreview(e,t);const n=this.previews.get(e.roomId);return n?n.has(t)?n.get(t):n.get(C):null}generatePreviewForEvent(e){var t;const n=_[e.getType()];return null!==(t=null==n?void 0:n.previewer.getTextFor(e,null,!0))&&void 0!==t?t:""}async generatePreview(e,t){const n=e.timeline;if(!n)return;let i=this.previews.get(e.roomId);i||(i=new Map,this.previews.set(e.roomId,i)),i.has(C)||i.set(C,null),t&&!i.has(t)&&i.set(t,null);let s=!1;for(let t=n.length-1;t>=0&&t!==n.length-50;t--){const r=n[t];await this.matrixClient.decryptEventIfNeeded(r);const a=_[r.getType()];if(!a)continue;if(a.isState&&Object(o.t)(r.getStateKey()))continue;const c=a.previewer.getTextFor(r,null);if(!c)continue;s=s||c!==i.get(C),i.set(C,c);const l=Array.from(i.keys()).filter(e=>e!==C);for(const e of l){const t=e===C?null:e,n=a.previewer.getTextFor(r,t);n===c?(s=s||c!==i.get(e),i.delete(e)):(s=s||n!==i.get(e),i.set(e,n))}return void(s&&(this.previews.set(e.roomId,i),this.emit(w.b,this),this.emit(O.getPreviewChangedEventName(e),e)))}this.previews.set(e.roomId,new Map),this.emit(w.b,this),this.emit(O.getPreviewChangedEventName(e),e)}async onAction(e){if(this.matrixClient&&("MatrixActions.Room.timeline"===e.action||"MatrixActions.Event.decrypted"===e.action)){const t=e.event,n=e.hasOwnProperty("isLiveEvent")&&!e.isLiveEvent;if(!this.previews.has(t.getRoomId())||n)return;await this.generatePreview(this.matrixClient.getRoom(t.getRoomId()),C)}}}s()(O,"internalInstance",new O)},,function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(89),r=n(100),a=n(101),c=n(397),l=n(97),d=n(208);var u=e=>{let{onBack:t}=e;const n=Object(i.useContext)(d.a),r=Object(i.useMemo)(()=>{const e={};return n.room.currentState.getStateEvents(l.b.RoomMember).forEach(t=>{var n;if("join"!==t.getContent().membership)return;const i=t.getSender().split(":")[1];e[i]=(null!==(n=e[i])&&void 0!==n?n:0)+1}),e},[n.room]);return s.a.createElement(d.b,{onBack:t},s.a.createElement("table",null,s.a.createElement("thead",null,s.a.createElement("tr",null,s.a.createElement("th",null,Object(o.a)("Server")),s.a.createElement("th",null,Object(o.a)("Number of users")))),s.a.createElement("tbody",null,Object.entries(r).map(e=>{let[t,n]=e;return s.a.createElement("tr",{key:t},s.a.createElement("td",null,t),s.a.createElement("td",null,n))}))))},h=n(203),m=n(145),p=n(118);const g={[h.g]:Object(o.c)("Unsent"),[h.e]:Object(o.c)("Requested"),[h.d]:Object(o.c)("Ready"),[h.c]:Object(o.c)("Done"),[h.f]:Object(o.c)("Started"),[h.b]:Object(o.c)("Cancelled")},f=e=>{let{txnId:t,request:n}=e;const[,r]=Object(i.useState)(),[a,c]=Object(i.useState)(n.timeout);return Object(p.c)(n,h.m.Change,r),Object(i.useEffect)(()=>{if(0==n.timeout)return;const e=setInterval(()=>{c(n.timeout)},500);return()=>{clearInterval(e)}},[n]),s.a.createElement("div",{className:"mx_DevTools_VerificationRequest"},s.a.createElement("dl",null,s.a.createElement("dt",null,Object(o.a)("Transaction")),s.a.createElement("dd",null,t),s.a.createElement("dt",null,Object(o.a)("Phase")),s.a.createElement("dd",null,g[n.phase]||n.phase)," // TODO",s.a.createElement("dt",null,Object(o.a)("Timeout")),s.a.createElement("dd",null,Math.floor(a/1e3)),s.a.createElement("dt",null,Object(o.a)("Methods")),s.a.createElement("dd",null,n.methods&&n.methods.join(", ")),s.a.createElement("dt",null,Object(o.a)("Requester")),s.a.createElement("dd",null,n.requestingUserId),s.a.createElement("dt",null,Object(o.a)("Observe only")),s.a.createElement("dd",null,JSON.stringify(n.observeOnly))))};var v=e=>{let{onBack:t}=e;const n=Object(i.useContext)(r.a),a=Object(i.useContext)(d.a),c=Object(p.d)(n,m.b.VerificationRequest,()=>{var e,t;return null!==(e=null===(t=n.crypto.inRoomVerificationRequests.requestsByRoomId)||void 0===t?void 0:t.get(a.room.roomId))&&void 0!==e?e:new Map});return s.a.createElement(d.b,{onBack:t},Array.from(c.entries()).reverse().map(e=>{let[t,n]=e;return s.a.createElement(f,{txnId:t,request:n,key:t})}),c.size<1&&Object(o.a)("No verification requests found"))},b=n(0),y=n(91),S=n(93),E=n(572),w=n(105);var _=e=>{let{onBack:t}=e;const[n,o]=Object(i.useState)(null),[r,a]=Object(i.useState)(!1);if(n&&r){const e=()=>{a(!1)};return s.a.createElement(R,{setting:n,onBack:e})}if(n){const e=()=>{o(null)},t=async()=>{a(!0)};return s.a.createElement(I,{setting:n,onBack:e,onEdit:t})}{const e=e=>{o(e)},n=e=>{o(e),a(!0)};return s.a.createElement(x,{onBack:t,onView:e,onEdit:n})}};const C=e=>{let{setting:t,roomId:n,level:i}=e;const o=S.b.canSetValue(t,n,i),r=o?"mx_DevTools_SettingsExplorer_mutable":"mx_DevTools_SettingsExplorer_immutable";return s.a.createElement("td",{className:r},s.a.createElement("code",null,o.toString()))};function O(e,t){const n={};for(const i of S.a)try{n[i]=S.b.getValueAt(i,e,t,!0,!0),void 0===n[i]&&(n[i]=null)}catch(e){b.a.warn(e)}return JSON.stringify(n,null,4)}const R=e=>{let{setting:t,onBack:n}=e;const r=Object(i.useContext)(d.a),[a,c]=Object(i.useState)(O(t,null)),[l,u]=Object(i.useState)(O(t,r.room.roomId));return s.a.createElement(d.b,{onBack:n,actionLabel:Object(o.a)("Save setting values"),onAction:async()=>{try{const e=JSON.parse(a),i=JSON.parse(l);for(const n of Object.keys(e)){b.a.log(`[Devtools] Setting value of ${t} at ${n} from user input`);try{const i=e[n];await S.b.setValue(t,null,n,i)}catch(e){b.a.warn(e)}}const s=r.room.roomId;for(const n of Object.keys(e)){b.a.log(`[Devtools] Setting value of ${t} at ${n} in ${s} from user input`);try{const e=i[n];await S.b.setValue(t,s,n,e)}catch(e){b.a.warn(e)}}n()}catch(e){return Object(o.a)("Failed to save settings.")+` (${e.message})`}}},s.a.createElement("h3",null,Object(o.a)("Setting:")," ",s.a.createElement("code",null,t)),s.a.createElement("div",{className:"mx_DevTools_SettingsExplorer_warning"},s.a.createElement("b",null,Object(o.a)("Caution:"))," ",Object(o.a)("This UI does NOT check the types of the values. Use at your own risk.")),s.a.createElement("div",null,Object(o.a)("Setting definition:"),s.a.createElement("pre",null,s.a.createElement("code",null,JSON.stringify(E.b[t],null,4)))),s.a.createElement("div",null,s.a.createElement("table",null,s.a.createElement("thead",null,s.a.createElement("tr",null,s.a.createElement("th",null,Object(o.a)("Level")),s.a.createElement("th",null,Object(o.a)("Settable at global")),s.a.createElement("th",null,Object(o.a)("Settable at room")))),s.a.createElement("tbody",null,S.a.map(e=>s.a.createElement("tr",{key:e},s.a.createElement("td",null,s.a.createElement("code",null,e)),s.a.createElement(C,{setting:t,level:e}),s.a.createElement(C,{setting:t,roomId:r.room.roomId,level:e})))))),s.a.createElement("div",null,s.a.createElement(w.a,{id:"valExpl",label:Object(o.a)("Values at explicit levels"),type:"text",className:"mx_DevTools_textarea",element:"textarea",autoComplete:"off",value:a,onChange:e=>c(e.target.value)})),s.a.createElement("div",null,s.a.createElement(w.a,{id:"valExpl",label:Object(o.a)("Values at explicit levels in this room"),type:"text",className:"mx_DevTools_textarea",element:"textarea",autoComplete:"off",value:l,onChange:e=>u(e.target.value)})))},I=e=>{let{setting:t,onEdit:n,onBack:r}=e;const a=Object(i.useContext)(d.a);return s.a.createElement(d.b,{onBack:r,actionLabel:Object(o.a)("Edit values"),onAction:n},s.a.createElement("h3",null,Object(o.a)("Setting:")," ",s.a.createElement("code",null,t)),s.a.createElement("div",null,Object(o.a)("Setting definition:"),s.a.createElement("pre",null,s.a.createElement("code",null,JSON.stringify(E.b[t],null,4)))),s.a.createElement("div",null,Object(o.a)("Value:")," ",s.a.createElement("code",null,k(S.b.getValue(t)))),s.a.createElement("div",null,Object(o.a)("Value in this room:")," ",s.a.createElement("code",null,k(S.b.getValue(t,a.room.roomId)))),s.a.createElement("div",null,Object(o.a)("Values at explicit levels:"),s.a.createElement("pre",null,s.a.createElement("code",null,O(t,null)))),s.a.createElement("div",null,Object(o.a)("Values at explicit levels in this room:"),s.a.createElement("pre",null,s.a.createElement("code",null,O(t,a.room.roomId)))))};function k(e){return["boolean","number"].includes(typeof e)?e.toString():JSON.stringify(e)}const x=e=>{let{onBack:t,onView:n,onEdit:r}=e;const a=Object(i.useContext)(d.a),[c,l]=Object(i.useState)(""),u=Object(i.useMemo)(()=>{let e=Object.keys(E.b);if(c){const t=c.toLowerCase();e=e.filter(e=>e.toLowerCase().includes(t))}return e},[c]);return s.a.createElement(d.b,{onBack:t,className:"mx_DevTools_SettingsExplorer"},s.a.createElement(w.a,{label:Object(o.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:c,onChange:e=>l(e.target.value),className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query"}),s.a.createElement("table",null,s.a.createElement("thead",null,s.a.createElement("tr",null,s.a.createElement("th",null,Object(o.a)("Setting ID")),s.a.createElement("th",null,Object(o.a)("Value")),s.a.createElement("th",null,Object(o.a)("Value in this room")))),s.a.createElement("tbody",null,u.map(e=>s.a.createElement("tr",{key:e},s.a.createElement("td",null,s.a.createElement(y.a,{kind:"link_inline",className:"mx_DevTools_SettingsExplorer_setting",onClick:()=>n(e)},s.a.createElement("code",null,e)),s.a.createElement(y.a,{alt:Object(o.a)("Edit setting"),onClick:()=>r(e),className:"mx_DevTools_SettingsExplorer_edit"},"✏")),s.a.createElement("td",null,s.a.createElement("code",null,k(S.b.getValue(e)))),s.a.createElement("td",null,s.a.createElement("code",null,k(S.b.getValue(e,a.room.roomId)))))))))};var T=n(494),j=n(209),N=n(123),P=n(495);var D=e=>{let{onBack:t}=e;const n=Object(i.useContext)(d.a),[r,a]=Object(i.useState)(""),[c,l]=Object(i.useState)(null),u=Object(p.b)(j.a.instance,N.b,()=>j.a.instance.getApps(n.room.roomId));if(c&&u.includes(c)){const e=()=>{l(null)},t=Array.from(Array.from(n.room.currentState.events.values()).map(e=>e.values())).reduce((e,t)=>(e.push(...t),e),[]).find(e=>e.getId()===c.eventId);return t?s.a.createElement(T.b,{mxEvent:t,onBack:e}):s.a.createElement(d.b,{onBack:e},Object(o.a)("There was an error finding this widget."))}return s.a.createElement(d.b,{onBack:t},s.a.createElement(P.a,{query:r,onChange:a},u.map(e=>s.a.createElement("button",{className:"mx_DevTools_button",key:e.url+e.eventId,onClick:()=>l(e)},e.url))))};const A=e=>{let{mxEvent:t,onBack:n}=e;const o=Object(i.useContext)(r.a),a=Object(i.useMemo)(()=>[Object(c.d)(null==t?void 0:t.getType())],[t]),l=t?Object(c.f)(t.getContent()):void 0;return s.a.createElement(c.a,{fieldDefs:a,defaultContent:l,onSend:(e,t)=>{let[n]=e;return o.setAccountData(n,t)},onBack:n})},M=e=>{let{mxEvent:t,onBack:n}=e;const o=Object(i.useContext)(d.a),a=Object(i.useContext)(r.a),l=Object(i.useMemo)(()=>[Object(c.d)(null==t?void 0:t.getType())],[t]),u=t?Object(c.f)(t.getContent()):void 0;return s.a.createElement(c.a,{fieldDefs:l,defaultContent:u,onSend:(e,t)=>{let[n]=e;return a.setRoomAccountData(o.room.roomId,n,t)},onBack:n})},U=e=>{let{events:t,Editor:n,actionLabel:o,onBack:r,setTool:a}=e;const[l,u]=Object(i.useState)(""),[h,m]=Object(i.useState)(null);if(h){const e=()=>{m(null)};return s.a.createElement(c.b,{mxEvent:h,onBack:e,Editor:n})}return s.a.createElement(d.b,{onBack:r,actionLabel:o,onAction:async()=>{a(o,n)}},s.a.createElement(P.a,{query:l,onChange:u},Object.entries(t).map(e=>{let[t,n]=e;return s.a.createElement("button",{className:"mx_DevTools_button",key:t,onClick:()=>{m(n)}},t)})))};var L=n(191),F=n(104),B=n(266),K=n(102),V=n(493),W=n(90);const H=Symbol("failed-to-load");var q,$=e=>{let{onBack:t}=e;const n=Object(i.useContext)(r.a),a=Object(B.a)(()=>n.getCapabilities(!0).catch(()=>H),[n]),c=Object(B.a)(()=>n.getVersions().catch(()=>H),[n]),l=Object(B.a)(async()=>{let e=n.getHomeserverUrl();try{const t=W.a.getHomeserverName(),n=await fetch(`https://${t}/.well-known/matrix/server`),i=await n.json();i["m.server"]&&(e="https://"+i["m.server"])}catch(e){console.warn(e)}try{return(await fetch(e+"/_matrix/federation/v1/version")).json()}catch(e){console.warn(e)}return H},[n]);let u;return u=a&&c&&l?s.a.createElement(s.a.Fragment,null,s.a.createElement("h4",null,Object(o.a)("Capabilities")),a!==H?s.a.createElement(V.a,{language:"json",children:JSON.stringify(a,null,4)}):s.a.createElement("div",null,Object(o.a)("Failed to load.")),s.a.createElement("h4",null,Object(o.a)("Client Versions")),c!==H?s.a.createElement(V.a,{language:"json",children:JSON.stringify(c,null,4)}):s.a.createElement("div",null,Object(o.a)("Failed to load.")),s.a.createElement("h4",null,Object(o.a)("Server Versions")),l!==H?s.a.createElement(V.a,{language:"json",children:JSON.stringify(l,null,4)}):s.a.createElement("div",null,Object(o.a)("Failed to load."))):s.a.createElement(K.a,null),s.a.createElement(d.b,{onBack:t},u)};!function(e){e[e.Room=0]="Room",e[e.Other=1]="Other"}(q||(q={}));const G={[q.Room]:Object(o.c)("Room"),[q.Other]:Object(o.c)("Other")},z={[q.Room]:[[Object(o.c)("Send custom timeline event"),c.c],[Object(o.c)("Explore room state"),T.a],[Object(o.c)("Explore room account data"),e=>{let{onBack:t,setTool:n}=e;const r=Object(i.useContext)(d.a);return s.a.createElement(U,{events:r.room.accountData,Editor:M,actionLabel:Object(o.a)("Send custom room account data event"),onBack:t,setTool:n})}],[Object(o.c)("View servers in room"),u],[Object(o.c)("Verification explorer"),v],[Object(o.c)("Active Widgets"),D]],[q.Other]:[[Object(o.c)("Explore account data"),e=>{let{onBack:t,setTool:n}=e;const a=Object(i.useContext)(r.a);return s.a.createElement(U,{events:a.store.accountData,Editor:A,actionLabel:Object(o.a)("Send custom account data event"),onBack:t,setTool:n})}],[Object(o.c)("Settings explorer"),_],[Object(o.c)("Server info"),$]]};t.a=e=>{let{roomId:t,onFinished:n}=e;const[c,l]=Object(i.useState)(null);let u,h;if(c){h=()=>{l(null)};const e=c[1];u=s.a.createElement(e,{onBack:h,setTool:(e,t)=>l([e,t])})}else{const e=()=>{n(!1)};u=s.a.createElement(d.b,{onBack:e},Object.entries(z).map(e=>{let[t,n]=e;return s.a.createElement("div",{key:t},s.a.createElement("h3",null,Object(o.a)(G[t])),n.map(e=>{let[t,n]=e;return s.a.createElement("button",{className:"mx_DevTools_button",key:t,onClick:()=>{l([t,n])}},Object(o.a)(t))}))}),s.a.createElement("div",null,s.a.createElement("h3",null,Object(o.a)("Options")),s.a.createElement(L.a,{name:"developerMode",level:F.a.ACCOUNT}),s.a.createElement(L.a,{name:"showHiddenEventsInTimeline",level:F.a.DEVICE}),s.a.createElement(L.a,{name:"enableWidgetScreenshots",level:F.a.ACCOUNT})))}const m=c?c[0]:Object(o.a)("Toolbox");return s.a.createElement(a.a,{className:"mx_QuestionDialog",onFinished:n,title:Object(o.a)("Developer Tools")},s.a.createElement(r.a.Consumer,null,e=>s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"mx_DevTools_label_left"},m),s.a.createElement("div",{className:"mx_DevTools_label_right"},Object(o.a)("Room ID: %(roomId)s",{roomId:t})),s.a.createElement("div",{className:"mx_DevTools_label_bottom"}),s.a.createElement(d.a.Provider,{value:{room:e.getRoom(t)}},u))))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return j}));var i=n(88),s=n.n(i),o=n(711),r=n(507),a=n(121),c=n(713);let l;!function(e){e[e.NotStarted=0]="NotStarted",e[e.PendingErrors=1]="PendingErrors",e[e.AllSuccessful=2]="AllSuccessful"}(l||(l={}));class d extends c.a{constructor(){super(...arguments),s()(this,"_transactions",[]),s()(this,"_state",l.NotStarted),s()(this,"checkTransactions",()=>{let e=l.AllSuccessful;for(const t of this.transactions){if(t.status===r.b.Error||t.didPreviouslyFail){e=l.PendingErrors;break}t.status===r.b.Pending&&(e=l.NotStarted)}this._state=e,this.notifyCondition(e)})}get transactions(){return Object(a.b)(this._transactions)}get state(){return this._state}get firstFailedTime(){const e=this.transactions.find(e=>e.didPreviouslyFail||e.status===r.b.Error);return e?e.startTime:null}disownTransaction(e){const t=this._transactions.indexOf(e);t>=0&&this._transactions.splice(t,1),e.destroy(),this.checkTransactions()}beginTransaction(e,t){const n=new r.a(e,t);return this._transactions.push(n),n.whenAnything(this.checkTransactions),n.when(r.b.Success,()=>n.destroy()),n}destroy(){for(const e of this.transactions)e.destroy();this._transactions=[],super.destroy()}}class u extends d{constructor(e){super(),this.room=e}}var h=n(167),m=n(92),p=n(714),g=n(87),f=n.n(g),v=n(89),b=n(91),y=n(95),S=n(101),E=n(133),w=n(93),_=n(130),C=n(102),O=n(123),R=n(90);class I extends g.PureComponent{constructor(){super(...arguments),s()(this,"onEchosUpdated",()=>{this.forceUpdate()})}componentDidMount(){T.instance.on(O.b,this.onEchosUpdated)}componentWillUnmount(){T.instance.off(O.b,this.onEchosUpdated)}renderTimeline(){return T.instance.contexts.map((e,t)=>{if(!e.firstFailedTime)return null;if(!(e instanceof u))throw new Error("Cannot render unknown context: "+e);const n=g.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline_header"},g.createElement(_.a,{width:24,height:24,room:e.room}),g.createElement("span",null,e.room.name)),i=e.transactions.filter(e=>e.status===r.b.Error||e.didPreviouslyFail).map((e,t)=>{let n=g.createElement(C.a,{w:19,h:19});return e.status===r.b.Error&&(n=g.createElement(b.a,{kind:"link",onClick:()=>e.run()},Object(v.a)("Resend"))),g.createElement("div",{className:"mx_ServerOfflineDialog_content_context_txn",key:"txn-"+t},g.createElement("span",{className:"mx_ServerOfflineDialog_content_context_txn_desc"},e.auditName),n)});return g.createElement("div",{className:"mx_ServerOfflineDialog_content_context",key:"context-"+t},g.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timestamp"},Object(E.k)(e.firstFailedTime,w.b.getValue("showTwelveHourTimestamps"))),g.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline"},n,i))})}render(){let e=this.renderTimeline().filter(e=>!!e);0===e.length&&(e=[g.createElement("div",{key:1},Object(v.a)("You're all caught up."))]);const t=R.a.getHomeserverName();return g.createElement(S.a,{title:Object(v.a)("Server isn't responding"),className:"mx_ServerOfflineDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished,hasCancel:!0},g.createElement("div",{className:"mx_ServerOfflineDialog_content"},g.createElement("p",null,Object(v.a)("Your server isn't responding to some of your requests. Below are some of the most likely reasons.")),g.createElement("ul",null,g.createElement("li",null,Object(v.a)("The server (%(serverName)s) took too long to respond.",{serverName:t})),g.createElement("li",null,Object(v.a)("Your firewall or anti-virus is blocking the request.")),g.createElement("li",null,Object(v.a)("A browser extension is preventing the request.")),g.createElement("li",null,Object(v.a)("The server is offline.")),g.createElement("li",null,Object(v.a)("The server has denied your request.")),g.createElement("li",null,Object(v.a)("Your area is experiencing difficulties connecting to the internet.")),g.createElement("li",null,Object(v.a)("A connection error occurred while trying to contact the server.")),g.createElement("li",null,Object(v.a)("The server is not configured to indicate what the problem is (CORS)."))),g.createElement("hr",null),g.createElement("h2",null,Object(v.a)("Recent changes that have not yet been received")),e))}}class k extends f.a.PureComponent{constructor(){super(...arguments),s()(this,"openDialog",()=>{y.a.createTrackedDialog("Local Echo Server Error","",I,{})})}render(){return f.a.createElement("div",{className:"mx_NonUrgentEchoFailureToast"},f.a.createElement("span",{className:"mx_NonUrgentEchoFailureToast_icon"}),Object(v.a)("Your server isn't responding to some <a>requests</a>.",{},{a:e=>f.a.createElement(b.a,{kind:"link",onClick:this.openDialog},e)}))}}const x=e=>"room-"+e.roomId;class T extends h.a{constructor(){super(m.a),s()(this,"caches",new Map)}static get instance(){return T._instance||(T._instance=new T),T._instance}get contexts(){return Array.from(this.caches.values()).map(e=>e.context)}getOrCreateChamberForRoom(e){if(this.caches.has(x(e)))return this.caches.get(x(e));const t=new u(e);t.whenAnything(()=>this.checkContexts());const n=new o.b(t);return n.setClient(this.matrixClient),this.caches.set(x(e),n),n}async checkContexts(){let e=!1;for(const t of this.caches.values())if(e=t.context.state===l.PendingErrors,e)break;if(e&&!this.state.toastRef){const e=p.a.instance.addToast(k);await this.updateState({toastRef:e})}else!e&&this.state.toastRef&&(p.a.instance.removeToast(this.state.toastRef),await this.updateState({toastRef:null}))}async onReady(){if(this.caches)for(const e of this.caches.values())e.setClient(this.matrixClient)}async onNotReady(){for(const e of this.caches.values())e.setClient(null)}async onAction(e){}}s()(T,"_instance",void 0);class j{constructor(){}static forRoom(e){return T.instance.getOrCreateChamberForRoom(e)}}},,function(e,t,n){"use strict";n.d(t,"b",(function(){return y})),n.d(t,"a",(function(){return S}));var i=n(87),s=n.n(i),o=n(89),r=n(98),a=n(197),c=n(160),l=n(115),d=n(361),u=n.n(d),h=n(102);const m=["vector-im/element-web","matrix-org/matrix-react-sdk","matrix-org/matrix-js-sdk"];class p extends s.a.Component{constructor(e){super(e),this.state={}}componentDidMount(){const e=this.props.newVersion.split("-"),t=this.props.version.split("-");if(null!=e&&null!=t)for(let n=0;n<m.length;n++){const i=t[2*n],s=e[2*n],o=`https://riot.im/github/repos/${m[n]}/compare/${i}...${s}`;u()(o,(e,t,i)=>{t.statusCode<200||t.statusCode>=300?this.setState({[m[n]]:t.statusText}):this.setState({[m[n]]:JSON.parse(i).commits})})}}elementsForCommit(e){return s.a.createElement("li",{key:e.sha,className:"mx_ChangelogDialog_li"},s.a.createElement("a",{href:e.html_url,target:"_blank",rel:"noreferrer noopener"},e.commit.message.split("\n")[0]))}render(){const e=m.map(e=>{let t;return t=null==this.state[e]?s.a.createElement(h.a,{key:e}):"string"==typeof this.state[e]?Object(o.a)("Unable to load commit detail: %(msg)s",{msg:this.state[e]}):this.state[e].map(this.elementsForCommit),s.a.createElement("div",{key:e},s.a.createElement("h2",null,e),s.a.createElement("ul",null,t))}),t=s.a.createElement("div",{className:"mx_ChangelogDialog_content"},null==this.props.version||null==this.props.newVersion?s.a.createElement("h2",null,Object(o.a)("Unavailable")):e);return s.a.createElement(l.a,{title:Object(o.a)("Changelog"),description:t,button:Object(o.a)("Update"),onFinished:this.props.onFinished})}}var g=n(126),f=n(95);function v(e){const t=e.split("-");return 5===t.length&&"react"===t[1]&&"js"===t[3]}function b(){g.a.get().installUpdate()}const y=(e,t,n)=>{let i,d=Object(o.a)("What's new?");n?i=()=>{f.a.createTrackedDialog("Display release notes","",l.a,{title:Object(o.a)("What's New"),description:s.a.createElement("pre",null,n),button:Object(o.a)("Update"),onFinished:e=>{e&&g.a.get()&&g.a.get().installUpdate()}})}:v(e)&&v(t)?i=()=>{f.a.createTrackedDialog("Display Changelog","",p,{version:e,newVersion:t,onFinished:e=>{e&&g.a.get()&&g.a.get().installUpdate()}})}:(i=b,d=Object(o.a)("Update"));const u=r.b.get().brand;c.a.sharedInstance().addOrReplaceToast({key:"update",title:Object(o.a)("Update %(brand)s",{brand:u}),props:{description:Object(o.a)("New version of %(brand)s is available",{brand:u}),acceptLabel:d,onAccept:i,rejectLabel:Object(o.a)("Dismiss"),onReject:function(){g.a.get().deferUpdate(t)}},component:a.a,priority:20})},S=()=>{c.a.sharedInstance().dismissToast("update")}},function(e,t,n){"use strict";n.d(t,"a",(function(){return w}));var i=n(88),s=n.n(i),o=n(224),r=n(7),a=n(0),c=n(97),l=n(125),d=n(90),u=n(384),h=n(89),m=n(95),p=n(93),g=n(87),f=n.n(g),v=n(104),b=n(101);class y extends f.a.Component{constructor(){super(...arguments),s()(this,"onInviteClicked",()=>{this.props.onInviteAnyways(),this.props.onFinished(!0)}),s()(this,"onInviteNeverWarnClicked",()=>{p.b.setValue("promptBeforeInviteUnknownUsers",null,v.a.ACCOUNT,!1),this.props.onInviteAnyways(),this.props.onFinished(!0)}),s()(this,"onGiveUpClicked",()=>{this.props.onGiveUp(),this.props.onFinished(!1)})}render(){const e=this.props.unknownProfileUsers.map(e=>f.a.createElement("li",{key:e.userId},e.userId,": ",e.errorText));return f.a.createElement(b.a,{className:"mx_RetryInvitesDialog",onFinished:this.onGiveUpClicked,title:Object(h.a)("The following users may not exist"),contentId:"mx_Dialog_content"},f.a.createElement("div",{id:"mx_Dialog_content"},f.a.createElement("p",null,Object(h.a)("Unable to find profiles for the Matrix IDs listed below - would you like to invite them anyway?")),f.a.createElement("ul",null,e)),f.a.createElement("div",{className:"mx_Dialog_buttons"},f.a.createElement("button",{onClick:this.onGiveUpClicked},Object(h.a)("Close")),f.a.createElement("button",{onClick:this.onInviteNeverWarnClicked},Object(h.a)("Invite anyway and never warn me again")),f.a.createElement("button",{onClick:this.onInviteClicked,autoFocus:!0},Object(h.a)("Invite anyway"))))}}let S;!function(e){e.Invited="invited",e.Error="error"}(S||(S={}));const E=["M_NOT_FOUND","M_USER_NOT_FOUND","M_PROFILE_UNDISCLOSED","M_PROFILE_NOT_FOUND"];class w{constructor(e,t){this.roomId=e,this.progressCallback=t,s()(this,"matrixClient",void 0),s()(this,"canceled",!1),s()(this,"addresses",[]),s()(this,"busy",!1),s()(this,"_fatal",!1),s()(this,"completionStates",{}),s()(this,"errors",{}),s()(this,"deferred",null),s()(this,"reason",null),this.matrixClient=d.a.get()}get fatal(){return this._fatal}invite(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.addresses.length>0)throw new Error("Already inviting/invited");this.addresses.push(...e),this.reason=t;for(const e of this.addresses)null===Object(u.b)(e)&&(this.completionStates[e]=S.Error,this.errors[e]={errcode:"M_INVALID",errorText:Object(h.a)("Unrecognised address")});if(this.deferred=Object(r.l)(),this.inviteMore(0),!n||!this.roomId||!this.matrixClient.isRoomEncrypted(this.roomId))return this.deferred.promise;const i=this.matrixClient.getRoom(this.roomId),s=null==i?void 0:i.currentState.getStateEvents(c.b.RoomHistoryVisibility,""),o=null==s?void 0:s.getContent().history_visibility;return o!==l.b.WorldReadable&&o!==l.b.Shared?this.deferred.promise:this.deferred.promise.then(async e=>{const t=[];for(const[n,i]of Object.entries(e))i===S.Invited&&Object(u.b)(n)===u.a.MatrixUserId&&t.push(n);return a.a.log("Sharing history with",t),this.matrixClient.sendSharedHistoryKeys(this.roomId,t),e})}cancel(){this.busy&&(this.canceled=!0,this.deferred.reject(new Error("canceled")))}getCompletionState(e){return this.completionStates[e]}getErrorText(e){return this.errors[e]?this.errors[e].errorText:null}async inviteToRoom(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=Object(u.b)(t);if(i===u.a.Email)return this.matrixClient.inviteByEmail(e,t);if(i===u.a.MatrixUserId){const i=this.matrixClient.getRoom(e);if(!i)throw new Error("Room not found");const s=i.getMember(t);if("join"===(null==s?void 0:s.membership))throw new o.d({errcode:"IO.ELEMENT.ALREADY_JOINED",error:"Member already joined"});if("invite"===(null==s?void 0:s.membership))throw new o.d({errcode:"IO.ELEMENT.ALREADY_INVITED",error:"Member already invited"});if(!n&&p.b.getValue("promptBeforeInviteUnknownUsers",this.roomId))try{await this.matrixClient.getProfileInfo(t)}catch(e){switch(e.errcode){case"M_FORBIDDEN":throw new o.d({errcode:"M_PROFILE_UNDISCLOSED"});case"M_NOT_FOUND":throw new o.d({errcode:"M_USER_NOT_FOUND"});default:throw e}}return this.matrixClient.invite(e,t,void 0,this.reason)}throw new Error("Unsupported address")}doInvite(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise((n,i)=>{a.a.log("Inviting "+e);this.inviteToRoom(this.roomId,e,t).then(()=>{var t;this.canceled||(this.completionStates[e]=S.Invited,delete this.errors[e],n(),null===(t=this.progressCallback)||void 0===t||t.call(this))}).catch(s=>{var o;if(this.canceled)return;a.a.error(s);const r=this.roomId&&(null===(o=this.matrixClient.getRoom(this.roomId))||void 0===o?void 0:o.isSpaceRoom());let c,l=!1;switch(s.errcode){case"M_FORBIDDEN":c=r?Object(h.a)("You do not have permission to invite people to this space."):Object(h.a)("You do not have permission to invite people to this room."),l=!0;break;case"IO.ELEMENT.ALREADY_INVITED":c=r?Object(h.a)("User is already invited to the space"):Object(h.a)("User is already invited to the room");break;case"IO.ELEMENT.ALREADY_JOINED":c=r?Object(h.a)("User is already in the space"):Object(h.a)("User is already in the room");break;case"M_LIMIT_EXCEEDED":return void setTimeout(()=>{this.doInvite(e,t).then(n,i)},5e3);case"M_NOT_FOUND":case"M_USER_NOT_FOUND":c=Object(h.a)("User does not exist");break;case"M_PROFILE_UNDISCLOSED":c=Object(h.a)("User may or may not exist");break;case"M_PROFILE_NOT_FOUND":if(!t)return a.a.warn(`User ${e} does not have a profile - inviting anyways automatically`),void this.doInvite(e,!0).then(n,i);break;case"M_BAD_STATE":c=Object(h.a)("The user must be unbanned before they can be invited.");break;case"M_UNSUPPORTED_ROOM_VERSION":c=r?Object(h.a)("The user's homeserver does not support the version of the space."):Object(h.a)("The user's homeserver does not support the version of the room.")}c||(c=Object(h.a)("Unknown server error")),this.completionStates[e]=S.Error,this.errors[e]={errorText:c,errcode:s.errcode},this.busy=!l,this._fatal=l,l?i(s):n()})})}inviteMore(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.canceled)return;if(e===this.addresses.length){if(this.busy=!1,Object.keys(this.errors).length>0){const e=Object.keys(this.errors).filter(e=>E.includes(this.errors[e].errcode));if(e.length>0){const t=()=>{const t=e.map(e=>this.doInvite(e,!0));Promise.all(t).then(()=>this.deferred.resolve(this.completionStates))};return p.b.getValue("promptBeforeInviteUnknownUsers",this.roomId)?(a.a.log("Showing failed to invite dialog..."),void m.a.createTrackedDialog("Failed to invite","",y,{unknownProfileUsers:e.map(e=>({userId:e,errorText:this.errors[e].errorText})),onInviteAnyways:()=>t(),onGiveUp:()=>{for(const t of e)this.completionStates[t]=S.Invited;this.deferred.resolve(this.completionStates)}})):void t()}}return void this.deferred.resolve(this.completionStates)}const n=this.addresses[e];null!==Object(u.b)(n)&&this.completionStates[n]!==S.Invited?this.doInvite(n,t).then(()=>{this.inviteMore(e+1,t)}).catch(()=>this.deferred.resolve(this.completionStates)):this.inviteMore(e+1)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(156);const r={};var a=n(406);class c{constructor(){}static get instance(){return c.internalInstance||(c.internalInstance=new c),c.internalInstance}async onNewInvitedRoom(e){await a.a.sharedInstance().onNewInvitedRoom(e)}isRoomVisible(e){if(!e)return!1;if(o.b.instance.getSupportsVirtualRooms()&&a.a.sharedInstance().isVirtualRoom(e))return!1;if(e.isSpaceRoom())return!1;const t=r.isRoomVisible;return!t||t(e)}}s()(c,"internalInstance",void 0)},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(88),s=n.n(i),o=n(97),r=n(0);class a{constructor(e){this.getFn=e,s()(this,"val",void 0),s()(this,"prom",void 0),s()(this,"done",!1)}get present(){return this.done}get cachedValue(){return this.val}get value(){return this.prom||(this.prom=this.getFn(),this.prom.then(e=>{this.val=e,this.done=!0})),this.prom}}var c=n(128),l=n(642);class d{constructor(e){this.event=e,s()(this,"sourceUrl",void 0),s()(this,"thumbnailUrl",void 0),s()(this,"sourceBlob",void 0),s()(this,"thumbnailBlob",void 0),s()(this,"media",void 0),s()(this,"prepareSourceUrl",async()=>{if(this.media.isEncrypted){const e=await this.sourceBlob.value;return URL.createObjectURL(e)}return this.media.srcHttp}),s()(this,"prepareThumbnailUrl",async()=>{if(this.media.isEncrypted){const e=await this.thumbnailBlob.value;return null===e?null:URL.createObjectURL(e)}return this.media.thumbnailHttp}),s()(this,"fetchSource",()=>{if(this.media.isEncrypted){const e=this.event.getContent();return Object(l.a)(e.file,e.info)}return this.media.downloadSource().then(e=>e.blob())}),s()(this,"fetchThumbnail",()=>{if(!this.media.hasThumbnail)return Promise.resolve(null);if(this.media.isEncrypted){var e;const t=this.event.getContent();return null!==(e=t.info)&&void 0!==e&&e.thumbnail_file?Object(l.a)(t.info.thumbnail_file,t.info.thumbnail_info):(r.a.warn("Media claims to have thumbnail and is encrypted, but no thumbnail_file found"),Promise.resolve(null))}return fetch(this.media.thumbnailHttp).then(e=>e.blob())}),this.sourceUrl=new a(this.prepareSourceUrl),this.thumbnailUrl=new a(this.prepareThumbnailUrl),this.sourceBlob=new a(this.fetchSource),this.thumbnailBlob=new a(this.fetchThumbnail),this.media=Object(c.a)(this.event.getContent())}get fileName(){return this.event.getContent().body||"download"}destroy(){this.media.isEncrypted&&(this.sourceUrl.present&&URL.revokeObjectURL(this.sourceUrl.cachedValue),this.thumbnailUrl.present&&URL.revokeObjectURL(this.thumbnailUrl.cachedValue))}static isEligible(e){if(!e)return!1;if(e.isRedacted())return!1;if(e.getType()===o.b.Sticker)return!0;if(e.getType()!==o.b.RoomMessage)return!1;const t=e.getContent();return!![o.c.Video,o.c.Audio,o.c.Image,o.c.File].includes(t.msgtype)||"string"==typeof t.url}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return M}));var i=n(99),s=n.n(i),o=n(88),r=n.n(o),a=n(87),c=n.n(a),l=n(108),d=n(97),u=n(151),h=n(165),m=n(90),p=n(92),g=n(89),f=n(95),v=n(396),b=n(93),y=n(158),S=n(153),E=n(154),w=n(700),_=n(96),C=n(149),O=n(112),R=n(491),I=n(492),k=n(497),x=n(498),T=n(106),j=n(115),N=n(430),P=n(107);class D extends c.a.Component{constructor(){super(...arguments),r()(this,"onFinished",e=>{const t=Object(N.b)(this.props.event,this.props.matrixClient,this.props.getRelationsForEvent),n=""===t?Object(g.a)("The poll has ended. No votes were cast."):Object(g.a)("The poll has ended. Top answer: %(topAnswer)s",{topAnswer:t});if(e){const e=h.PollEndEvent.from(this.props.event.getId(),n).serialize();this.props.matrixClient.sendEvent(this.props.event.getRoomId(),e.type,e.content).catch(e=>{console.error("Failed to submit poll response event:",e),f.a.createTrackedDialog("Failed to end poll","",P.a,{title:Object(g.a)("Failed to end poll"),description:Object(g.a)("Sorry, the poll did not end. Please try again.")})})}this.props.onFinished(e)})}render(){return c.a.createElement(j.a,{title:Object(g.a)("End Poll"),description:Object(g.a)("Are you sure you want to end this poll? This will show the final results of the poll and stop people from being able to vote."),button:Object(g.a)("End Poll"),onFinished:e=>this.onFinished(e)})}}var A=n(199);class M extends c.a.Component{constructor(e){super(e),r()(this,"context",void 0),r()(this,"reactButtonRef",Object(a.createRef)()),r()(this,"checkPermissions",()=>{const e=m.a.get(),t=e.getRoom(this.props.mxEvent.getRoomId()),n=t.currentState.maySendRedactionForEvent(this.props.mxEvent,e.credentials.userId)&&this.props.mxEvent.getType()!==d.b.RoomServerAcl&&this.props.mxEvent.getType()!==d.b.RoomEncryption;let i=t.currentState.mayClientSendStateEvent(d.b.RoomPinnedEvents,e);b.b.getValue("feature_pinning")||(i=!1),this.setState({canRedact:n,canPin:i})}),r()(this,"onResendReactionsClick",()=>{for(const e of this.getUnsentReactions())v.a.resend(e);this.closeMenu()}),r()(this,"onJumpToRelatedEventClick",e=>{p.a.dispatch({action:"view_room",room_id:this.props.mxEvent.getRoomId(),event_id:e,highlighted:!0})}),r()(this,"onReportEventClick",()=>{p.a.dispatch({action:_.a.OpenReportEventDialog,event:this.props.mxEvent}),this.closeMenu()}),r()(this,"onViewSourceClick",()=>{f.a.createTrackedDialog("View Event Source","",I.a,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource"),this.closeMenu()}),r()(this,"onRedactClick",()=>{const{mxEvent:e,onCloseDialog:t}=this.props;Object(k.a)({mxEvent:e,onCloseDialog:t}),this.closeMenu()}),r()(this,"onForwardClick",()=>{p.a.dispatch({action:_.a.OpenForwardDialog,event:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()}),r()(this,"onPinClick",()=>{var e,t;const n=m.a.get(),i=n.getRoom(this.props.mxEvent.getRoomId()),s=this.props.mxEvent.getId(),o=(null==i||null===(e=i.currentState)||void 0===e||null===(t=e.getStateEvents(d.b.RoomPinnedEvents,""))||void 0===t?void 0:t.getContent().pinned)||[];var r,a;o.includes(s)?o.splice(o.indexOf(s),1):(o.push(s),n.setRoomAccountData(i.roomId,w.a,{event_ids:[...(null===(r=i.getAccountData(w.a))||void 0===r||null===(a=r.getContent())||void 0===a?void 0:a.event_ids)||[],s]}));n.sendStateEvent(this.props.mxEvent.getRoomId(),d.b.RoomPinnedEvents,{pinned:o},""),this.closeMenu()}),r()(this,"closeMenu",()=>{this.props.onFinished()}),r()(this,"onUnhidePreviewClick",()=>{var e;null===(e=this.props.eventTileOps)||void 0===e||e.unhideWidget(),this.closeMenu()}),r()(this,"onQuoteClick",()=>{p.a.dispatch({action:_.a.ComposerInsert,event:this.props.mxEvent,timelineRenderingType:this.context.timelineRenderingType}),this.closeMenu()}),r()(this,"onShareClick",e=>{e.preventDefault(),f.a.createTrackedDialog("share room message dialog","",x.a,{target:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()}),r()(this,"onCopyLinkClick",e=>{e.preventDefault(),Object(C.c)(this.props.link),this.closeMenu()}),r()(this,"onCollapseReplyChainClick",()=>{this.props.collapseReplyChain(),this.closeMenu()}),r()(this,"onCopyClick",()=>{Object(C.c)(Object(C.d)()),this.closeMenu()}),r()(this,"onEditClick",()=>{Object(S.e)(this.props.mxEvent,this.context.timelineRenderingType,this.props.getRelationsForEvent),this.closeMenu()}),r()(this,"onReplyClick",()=>{p.a.dispatch({action:"reply_to_event",event:this.props.mxEvent,context:this.context.timelineRenderingType}),this.closeMenu()}),r()(this,"onReactClick",()=>{this.setState({reactionPickerDisplayed:!0})}),r()(this,"onCloseReactionPicker",()=>{this.setState({reactionPickerDisplayed:!1}),this.closeMenu()}),r()(this,"onEndPollClick",()=>{const e=m.a.get();f.a.createTrackedDialog("End Poll","",D,{matrixClient:e,event:this.props.mxEvent,getRelationsForEvent:this.props.getRelationsForEvent},"mx_Dialog_endPoll"),this.closeMenu()}),r()(this,"viewInRoom",()=>{p.a.dispatch({action:_.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}),this.closeMenu()}),this.state={canRedact:!1,canPin:!1,reactionPickerDisplayed:!1}}componentDidMount(){m.a.get().on(u.b.PowerLevel,this.checkPermissions),this.checkPermissions()}componentWillUnmount(){const e=m.a.get();e&&e.removeListener(u.b.PowerLevel,this.checkPermissions)}isPinned(){const e=m.a.get().getRoom(this.props.mxEvent.getRoomId()).currentState.getStateEvents(d.b.RoomPinnedEvents,"");if(!e)return!1;const t=e.getContent();return t.pinned&&Array.isArray(t.pinned)&&t.pinned.includes(this.props.mxEvent.getId())}canOpenInMapSite(e){return Object(S.k)(e)}canEndPoll(e){return h.M_POLL_START.matches(e.getType())&&this.state.canRedact&&!Object(N.c)(e,m.a.get(),this.props.getRelationsForEvent)}getReactions(e){const t=m.a.get().getRoom(this.props.mxEvent.getRoomId()),n=this.props.mxEvent.getId();return t.getPendingEvents().filter(t=>{const i=t.getRelation();return(null==i?void 0:i.rel_type)===d.d.Annotation&&i.event_id===n&&e(t)})}getUnsentReactions(){return this.getReactions(e=>e.status===l.a.NOT_SENT)}render(){var e,t,n,i;const o=m.a.get().getUserId(),{mxEvent:r,rightClick:a,link:d,eventTileOps:u,reactions:h,collapseReplyChain:p}=this.props,f=r.status,v=this.getUnsentReactions().length,w=Object(S.j)(r),_=null===(e=this.props.permalinkCreator)||void 0===e?void 0:e.forEvent(this.props.mxEvent.getId()),I=!f||f===l.a.SENT,{timelineRenderingType:k,canReact:x,canSendMessages:j}=this.context,N=(k===T.a.Thread||k===T.a.ThreadsList)&&(null==r||null===(t=r.getThread())||void 0===t?void 0:t.rootEvent)===r;let P,D,M,U,L;if(r.isRedacted()||0===v||(P=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconResend",label:Object(g.a)("Resend %(unsentCount)s reaction(s)",{unsentCount:v}),onClick:this.onResendReactionsClick})),I&&this.state.canRedact&&(D=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconRedact",label:Object(g.a)("Remove"),onClick:this.onRedactClick})),this.canOpenInMapSite(r)){const e=Object(A.b)(r);M=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconOpenInMapSite",onClick:null,label:Object(g.a)("Open in OpenStreetMap"),element:"a",href:e,target:"_blank",rel:"noreferrer noopener"})}w&&Object(S.d)(r)&&(U=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconForward",label:Object(g.a)("Forward"),onClick:this.onForwardClick})),w&&this.state.canPin&&(L=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconPin",label:this.isPinned()?Object(g.a)("Unpin"):Object(g.a)("Pin"),onClick:this.onPinClick}));const F=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconSource",label:Object(g.a)("View source"),onClick:this.onViewSourceClick});let B,K,V,W,H,q,$;null!=u&&u.isWidgetHidden()&&(B=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconUnhidePreview",label:Object(g.a)("Show preview"),onClick:this.onUnhidePreviewClick})),_&&(K=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconPermalink",onClick:this.onShareClick,label:Object(g.a)("Share"),element:"a",href:_,target:"_blank",rel:"noreferrer noopener"})),this.canEndPoll(r)&&(V=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconEndPoll",label:Object(g.a)("End Poll"),onClick:this.onEndPollClick})),u&&(W=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconQuote",label:Object(g.a)("Quote"),onClick:this.onQuoteClick})),"string"==typeof r.getContent().external_url&&Object(y.e)(r.getContent().external_url)&&(H=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconLink",onClick:this.closeMenu,label:Object(g.a)("Source URL"),element:"a",target:"_blank",rel:"noreferrer noopener",href:r.getContent().external_url})),p&&(q=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconCollapse",label:Object(g.a)("Collapse reply thread"),onClick:this.onCollapseReplyChainClick}));const G=null===(n=r.getWireContent())||void 0===n||null===(i=n["m.relates_to"])||void 0===i?void 0:i.event_id;let z,J,Y,Q,X,Z,ee,te,ne;G&&b.b.getValue("developerMode")&&($=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_jumpToEvent",label:Object(g.a)("View related event"),onClick:()=>this.onJumpToRelatedEventClick(G)})),r.getSender()!==o&&(z=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconReport",label:Object(g.a)("Report"),onClick:this.onReportEventClick})),d&&(J=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconCopy",onClick:this.onCopyLinkClick,label:Object(g.a)("Copy link"),element:"a",href:d,target:"_blank",rel:"noreferrer noopener"})),a&&Object(C.d)()&&(Y=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconCopy",label:Object(g.a)("Copy"),triggerOnMouseDown:!0,onClick:this.onCopyClick})),a&&Object(S.c)(r)&&(Q=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconEdit",label:Object(g.a)("Edit"),onClick:this.onEditClick})),a&&w&&j&&(X=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconReply",label:Object(g.a)("Reply"),onClick:this.onReplyClick})),a&&w&&x&&(Z=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconReact",label:Object(g.a)("React"),onClick:this.onReactClick,inputRef:this.reactButtonRef})),N&&(ee=c.a.createElement(E.b,{iconClassName:"mx_MessageContextMenu_iconViewInRoom",label:Object(g.a)("View in room"),onClick:this.viewInRoom})),(Y||J)&&(te=c.a.createElement(E.c,null,Y,J)),(Q||X||Z)&&(ne=c.a.createElement(E.c,null,Z,X,Q));const ie=c.a.createElement(E.c,null,ee,M,V,W,U,L,K,z,H,$,B,F,P,q);let se,oe;if(D&&(se=c.a.createElement(E.c,{red:!0},D)),this.state.reactionPickerDisplayed){var re;const e=null===(re=this.reactButtonRef.current)||void 0===re?void 0:re.getBoundingClientRect();oe=c.a.createElement(O.o,s()({},Object(O.p)(e),{onFinished:this.closeMenu,managed:!1}),c.a.createElement(R.a,{mxEvent:r,onFinished:this.onCloseReactionPicker,reactions:h}))}return c.a.createElement(c.a.Fragment,null,c.a.createElement(E.e,s()({},this.props,{className:"mx_MessageContextMenu",compact:!0}),te,ne,ie,se),oe)}}r()(M,"contextType",T.b)},function(e,t,n){"use strict";n.d(t,"a",(function(){return D}));var i=n(99),s=n.n(i),o=n(88),r=n.n(o),a=n(87),c=n.n(a),l=n(1322),d=n(242),u=n(94),h=n.n(u),m=n(764),p=n(0),g=n(119),f=n(303),v=n(95),b=n(89),y=n(93),S=n(102),E=n(128),w=n(432),_=n(359),C=n(409),O=n(90),R=n(106),I=n(121);function k(e){return["image/gif","image/webp","image/png","image/apng","image/avif"].includes(e)}function x(e,t,n){return new Uint8Array(e.slice(t,t+n))}function T(e,t){return new DataView(e,t,4).getUint32(0)}function j(e,t,n){return String.fromCharCode.apply(null,x(e,t,n))}var N,P=n(399);!function(e){e[e.NoImage=0]="NoImage",e[e.Blurhash=1]="Blurhash"}(N||(N={}));class D extends c.a.Component{constructor(e){super(e),r()(this,"context",void 0),r()(this,"unmounted",!0),r()(this,"image",Object(a.createRef)()),r()(this,"timeout",void 0),r()(this,"sizeWatcher",void 0),r()(this,"onClientSync",(e,t)=>{if(this.unmounted)return;e!==d.b.Error&&t!==e&&this.state.imgError&&this.setState({imgError:!1})}),r()(this,"onClick",e=>{if(0===e.button&&!e.metaKey){var t;if(e.preventDefault(),!this.state.showImage)return void this.showImage();const n=this.props.mxEvent.getContent(),i={src:this.state.contentUrl,name:(null===(t=n.body)||void 0===t?void 0:t.length)>0?n.body:Object(b.a)("Attachment"),mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator};if(n.info&&(i.width=n.info.w,i.height=n.info.h,i.fileSize=n.info.size),this.image.current){const e=this.image.current.getBoundingClientRect();i.thumbnailInfo={width:e.width,height:e.height,positionX:e.x,positionY:e.y}}v.a.createDialog(_.a,i,"mx_Dialog_lightbox",null,!0)}}),r()(this,"onImageEnter",e=>{if(this.setState({hover:!0}),!this.state.showImage||!this.state.isAnimated||y.b.getValue("autoplayGifs"))return;e.currentTarget.src=this.state.contentUrl}),r()(this,"onImageLeave",e=>{var t;if(this.setState({hover:!1}),!this.state.showImage||!this.state.isAnimated||y.b.getValue("autoplayGifs"))return;e.currentTarget.src=null!==(t=this.state.thumbUrl)&&void 0!==t?t:this.state.contentUrl}),r()(this,"onImageError",()=>{this.clearBlurhashTimeout(),this.setState({imgError:!0})}),r()(this,"onImageLoad",()=>{let e;if(this.clearBlurhashTimeout(),this.props.onHeightChanged(),this.image.current){const{naturalWidth:t,naturalHeight:n}=this.image.current;e={naturalWidth:t,naturalHeight:n}}this.setState({imgLoaded:!0,loadedImageDimensions:e})}),this.state={imgError:!1,imgLoaded:!1,hover:!1,showImage:y.b.getValue("showImages"),placeholder:N.NoImage}}showImage(){localStorage.setItem("mx_ShowImage_"+this.props.mxEvent.getId(),"true"),this.setState({showImage:!0}),this.downloadImage()}getContentUrl(){return this.props.forExport?this.media.srcMxc:this.media.srcHttp}get media(){return Object(E.a)(this.props.mxEvent.getContent())}getThumbUrl(){const e=this.props.mxEvent.getContent(),t=Object(E.a)(e),n=e.info;if("image/svg+xml"===(null==n?void 0:n.mimetype)&&t.hasThumbnail)return t.getThumbnailHttp(800,600,"scale");if(this.state.isAnimated||1===window.devicePixelRatio||!n||!n.w||!n.h||!n.size)return t.getThumbnailOfSourceHttp(800,600);const i=n.w>800||n.h>600;return n.size>1048576&&i?t.getThumbnailOfSourceHttp(800,600):t.srcHttp}async downloadImage(){var e;if(this.state.contentUrl)return;let t,n;if(this.props.mediaEventHelper.media.isEncrypted)try{[n,t]=await Promise.all([this.props.mediaEventHelper.sourceUrl.value,this.props.mediaEventHelper.thumbnailUrl.value])}catch(e){if(this.unmounted)return;p.a.warn("Unable to decrypt attachment: ",e),this.setState({error:e})}else t=this.getThumbUrl(),n=this.getContentUrl();const i=this.props.mxEvent.getContent();let s=k(null===(e=i.info)||void 0===e?void 0:e.mimetype);if(s&&!y.b.getValue("autoplayGifs")&&(!t||null==i||!i.info.thumbnail_info||k(i.info.thumbnail_info.mimetype))){const e=document.createElement("img"),o=new Promise((t,n)=>{e.onload=t,e.onerror=n});e.crossOrigin="Anonymous",e.src=n,await o;const r=await this.props.mediaEventHelper.sourceBlob.value;if(await async function(e,t){switch(e){case"image/webp":{const e=await t.slice(0,17).arrayBuffer();if("RIFF"===j(e,0,4)&&"WEBP"===j(e,8,4)&&"VP8X"===j(e,12,4)){const[t]=x(e,16,1);return 0!=(t&2)}break}case"image/gif":{const e=new DataView(await t.arrayBuffer(),10),n=e.getUint8(0);let i=0;128&n&&(i=3*Math.pow(2,1+(7&n)));const s=3+i,o=e.getUint8(s),r=e.getUint8(s+1);let a=0;return 33&o&&249&r&&(a=e.getUint16(s+4)),!!a}case"image/png":case"image/apng":{const e=await t.arrayBuffer();if(Object(I.d)([137,80,78,71,13,10,26,10],Array.from(x(e,0,8))))return!1;for(let n=8;n<t.size;){const t=T(e,n);n+=4;const i=j(e,n,4);switch(n+=4,i){case"acTL":return!0;case"IDAT":return!1}n+=t+4}break}}return!1}(i.info.mimetype,r)||(s=!1),s){const n=await Object(w.b)(e,e.width,e.height,i.info.mimetype,!1);t=URL.createObjectURL(n.thumbnail)}}this.unmounted||this.setState({contentUrl:n,thumbUrl:t,isAnimated:s})}clearBlurhashTimeout(){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}componentDidMount(){var e;this.unmounted=!1,O.a.get().on(g.b.Sync,this.onClientSync);(this.state.showImage||"true"===localStorage.getItem("mx_ShowImage_"+this.props.mxEvent.getId()))&&(this.downloadImage(),this.setState({showImage:!0})),null!==(e=this.props.mxEvent.getContent().info)&&void 0!==e&&e[w.a]&&(this.clearBlurhashTimeout(),this.timeout=setTimeout(()=>{this.state.imgLoaded&&this.state.imgError||this.setState({placeholder:N.Blurhash})},150)),this.sizeWatcher=y.b.watchSetting("Images.size",null,()=>{this.forceUpdate()})}componentWillUnmount(){this.unmounted=!0,O.a.get().removeListener(g.b.Sync,this.onClientSync),this.clearBlurhashTimeout(),y.b.unwatchSetting(this.sizeWatcher),this.state.isAnimated&&this.state.thumbUrl&&URL.revokeObjectURL(this.state.thumbUrl)}getBanner(e){return[R.a.ThreadsList,R.a.File].includes(this.context.timelineRenderingType)?null:c.a.createElement("span",{className:"mx_MImageBody_banner"},Object(P.a)(e,Object(b.a)("Image"),!0,!0))}messageContent(e,t,n,i){var s,o,r;let a,l;t||(t=e);let d=!1;if(null!==(s=n.info)&&void 0!==s&&s.w&&null!==(o=n.info)&&void 0!==o&&o.h)a=n.info.w,l=n.info.h,d=n.info.mimetype.startsWith("image/svg");else{if(!this.state.loadedImageDimensions){let i;return i=this.state.showImage?c.a.createElement("img",{style:{display:"none"},src:t,ref:this.image,alt:n.body,onError:this.onImageError,onLoad:this.onImageLoad}):c.a.createElement(A,null),this.wrapImage(e,i)}a=this.state.loadedImageDimensions.naturalWidth,l=this.state.loadedImageDimensions.naturalHeight}const{w:u,h:p}=Object(C.b)(y.b.getValue("Images.size"),{w:a,h:l},null!=i?i:this.props.maxImageHeight);let g,f,v;this.props.forExport||this.state.imgLoaded||(f=this.getPlaceholder(u,p));let b,S=Boolean(f);t&&!this.state.imgError&&(g=c.a.createElement("img",{className:"mx_MImageBody_thumbnail",src:t,ref:this.image,alt:n.body,onError:this.onImageError,onLoad:this.onImageLoad,onMouseEnter:this.onImageEnter,onMouseLeave:this.onImageLeave})),this.state.showImage||(g=c.a.createElement(A,{maxWidth:u}),S=!1),!this.state.isAnimated||y.b.getValue("autoplayGifs")||this.state.hover||(v=c.a.createElement("p",{className:"mx_MImageBody_gifLabel"},"GIF")),this.state.showImage&&this.state.hover&&(b=this.getBanner(n));const E=h()({mx_MImageBody_placeholder:!0,"mx_MImageBody_placeholder--blurhash":null===(r=this.props.mxEvent.getContent().info)||void 0===r?void 0:r[w.a]}),_=d?{maxHeight:p,maxWidth:u,width:u}:{maxHeight:p,maxWidth:u},O=c.a.createElement("div",{className:"mx_MImageBody_thumbnail_container",style:{maxHeight:p,maxWidth:u,aspectRatio:`${a}/${l}`}},c.a.createElement(m.SwitchTransition,{mode:"out-in"},c.a.createElement(m.CSSTransition,{classNames:"mx_rtg--fade",key:"img-"+S,timeout:300},S?c.a.createElement("div",{className:E},f):c.a.createElement(c.a.Fragment,null))),c.a.createElement("div",{style:_},g,v,b),!this.state.imgLoaded&&c.a.createElement("div",{style:{height:p,width:u}}),this.state.hover&&this.getTooltip());return this.wrapImage(e,O)}wrapImage(e,t){return c.a.createElement("a",{href:e,target:this.props.forExport?"_blank":void 0,onClick:this.onClick},t)}getPlaceholder(e,t){var n;const i=null===(n=this.props.mxEvent.getContent().info)||void 0===n?void 0:n[w.a];if(i){if(this.state.placeholder===N.NoImage)return null;if(this.state.placeholder===N.Blurhash)return c.a.createElement(l.Blurhash,{className:"mx_Blurhash",hash:i,width:e,height:t})}return c.a.createElement(S.a,{w:32,h:32})}getTooltip(){return null}getFileBody(){if(this.props.forExport)return null;return this.context.timelineRenderingType===R.a.Room||this.context.timelineRenderingType===R.a.Pinned||this.context.timelineRenderingType===R.a.Search||this.context.timelineRenderingType===R.a.Thread||this.context.timelineRenderingType===R.a.ThreadsList?void 0:c.a.createElement(f.a,s()({},this.props,{showGenericPlaceholder:!1}))}render(){const e=this.props.mxEvent.getContent();if(this.state.error)return c.a.createElement("div",{className:"mx_MImageBody"},c.a.createElement("img",{src:n(304).default,width:"16",height:"16"}),Object(b.a)("Error decrypting image"));const t=this.state.contentUrl;let i;var s;this.props.forExport||this.state.isAnimated&&y.b.getValue("autoplayGifs")?i=t:i=null!==(s=this.state.thumbUrl)&&void 0!==s?s:this.state.contentUrl;const o=this.messageContent(t,i,e),r=this.getFileBody();return c.a.createElement("div",{className:"mx_MImageBody"},o,r)}}r()(D,"contextType",R.b);class A extends c.a.PureComponent{render(){const e=this.props.maxWidth?this.props.maxWidth+"px":null;let t="mx_HiddenImagePlaceholder";return this.props.hover&&(t+=" mx_HiddenImagePlaceholder_hover"),c.a.createElement("div",{className:t,style:{maxWidth:`min(100%, ${e}px)`}},c.a.createElement("div",{className:"mx_HiddenImagePlaceholder_button"},c.a.createElement("span",{className:"mx_HiddenImagePlaceholder_eye"}),c.a.createElement("span",null,Object(b.a)("Show image"))))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(239);class r extends o.c{constructor(e,t){super(t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.a),this.manager=e}async play(){return this.manager.pauseAllExcept(this),super.play()}destroy(){this.manager.destroyPlaybackInstance(this),super.destroy()}}class a{constructor(){s()(this,"instances",[])}static get instance(){return a.internalInstance||(a.internalInstance=new a),a.internalInstance}pauseAllExcept(e){this.instances.filter(t=>t!==e&&t.currentState===o.d.Playing).forEach(e=>e.pause())}destroyPlaybackInstance(e){this.instances=this.instances.filter(t=>t!==e)}createPlaybackInstance(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.a;const n=new r(this,e,t);return this.instances.push(n),n}}s()(a,"internalInstance",void 0)},,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return m}));var i=n(17),s=n.n(i),o=n(108),r=n(0),a=n(152),c=n(97),l=n(119),d=n(242),u=n(113);let h;!function(e){e.Incoming="Call.incoming"}(h||(h={}));class m{constructor(e){s()(this,"client",void 0),s()(this,"calls",void 0),s()(this,"callEventBuffer",void 0),s()(this,"candidateEventsByCall",void 0),s()(this,"evaluateEventBuffer",async()=>{if(this.client.getSyncState()===d.b.Syncing){await Promise.all(this.callEventBuffer.map(e=>{this.client.decryptEventIfNeeded(e)}));const e=new Set;for(const t of this.callEventBuffer)t.getType()!==c.b.CallAnswer&&t.getType()!==c.b.CallHangup||e.add(t.getContent().call_id);for(const t of this.callEventBuffer)if(t.getType()!==c.b.CallInvite||!e.has(t.getContent().call_id))try{await this.handleCallEvent(t)}catch(e){r.a.error("Caught exception handling call event",e)}this.callEventBuffer=[]}}),s()(this,"onRoomTimeline",e=>{this.client.decryptEventIfNeeded(e),(this.eventIsACall(e)||e.isBeingDecrypted())&&this.callEventBuffer.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once(o.c.Decrypted,async()=>{if(this.eventIsACall(e))if(this.callEventBuffer.includes(e))this.evaluateEventBuffer();else try{await this.handleCallEvent(e)}catch(e){r.a.error("Caught exception handling call event",e)}})}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(l.b.Sync,this.evaluateEventBuffer),this.client.on(u.c.Timeline,this.onRoomTimeline)}stop(){this.client.removeListener(l.b.Sync,this.evaluateEventBuffer),this.client.removeListener(u.c.Timeline,this.onRoomTimeline)}eventIsACall(e){const t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")}async handleCallEvent(e){const t=e.getContent(),n=e.getType(),i=e.getSender()===this.client.credentials.userId;let s=t.call_id?this.calls.get(t.call_id):void 0;if(n!==c.b.CallInvite)if(n!==c.b.CallCandidates)if([c.b.CallHangup,c.b.CallReject].includes(n))s?s.state!==a.e.Ended&&(n===c.b.CallHangup?s.onHangupReceived(t):s.onRejectReceived(t),s.state===a.e.Ended&&this.calls.delete(t.call_id)):(s=Object(a.g)(this.client,e.getRoomId()),s&&(s.callId=t.call_id,s.initWithHangup(e),this.calls.set(t.call_id,s)));else if(s&&s.hasPeerConnection){if(e.getContent().party_id!==s.ourPartyId)switch(n){case c.b.CallAnswer:i?s.state===a.e.Ringing&&s.onAnsweredElsewhere(t):s.onAnswerReceived(e);break;case c.b.CallSelectAnswer:s.onSelectAnswerReceived(e);break;case c.b.CallNegotiate:s.onNegotiateReceived(e);break;case c.b.CallAssertedIdentity:case c.b.CallAssertedIdentityPrefix:s.onAssertedIdentityReceived(e);break;case c.b.CallSDPStreamMetadataChanged:case c.b.CallSDPStreamMetadataChangedPrefix:s.onSDPStreamMetadataChangedReceived(e)}}else r.a.info(`Discarding possible call event ${e.getId()} as we don't have a call/peerConn`,n);else{if(i)return;s?s.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(t.call_id)||this.candidateEventsByCall.set(t.call_id,[]),this.candidateEventsByCall.get(t.call_id).push(e))}else{if(i)return;if(e.getLocalAge()>t.lifetime-3e3)return;if(s&&s.state===a.e.Ended)return;s&&r.a.log(`WARN: Already have a MatrixCall with id ${t.call_id} but got an invite. Clobbering.`);const n=this.client.getTurnServersExpiry()-Date.now();if(r.a.info("Current turn creds expire in "+n+" ms"),s=Object(a.g)(this.client,e.getRoomId(),{forceTURN:this.client.forceTURN}),!s)return void r.a.log("Incoming call ID "+t.call_id+" but this client doesn't support WebRTC");if(s.callId=t.call_id,await s.initWithInvite(e),this.calls.set(s.callId,s),this.candidateEventsByCall.get(s.callId))for(const e of this.candidateEventsByCall.get(s.callId))s.onRemoteIceCandidatesReceived(e);let o;for(const e of this.calls.values()){const t=[a.e.WaitLocalMedia,a.e.CreateOffer,a.e.InviteSent].includes(e.state);if(s.roomId===e.roomId&&e.direction===a.a.Outbound&&t){o=e;break}}o?o.state===a.e.WaitLocalMedia||o.state===a.e.CreateOffer||o.callId>s.callId?(r.a.log("Glare detected: answering incoming call "+s.callId+" and canceling outgoing call "+o.callId),o.replacedBy(s),s.answer()):(r.a.log("Glare detected: rejecting incoming call "+s.callId+" and keeping outgoing call "+o.callId),s.hangup(a.b.Replaced,!0)):this.client.emit(h.Incoming,s)}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(0),s=n(310);function o(e){return"crypto.sessions/"+e}function r(e){return"crypto.session.problems/"+e}function a(e,t){return"crypto.inboundgroupsessions/"+e+"/"+t}function c(e,t){return"crypto.inboundgroupsessions.withheld/"+e+"/"+t}function l(e){return"crypto.rooms/"+e}class d extends s.a{static exists(e){const t=e.length;for(let n=0;n<t;n++)if(e.key(n).startsWith("crypto."))return!0;return!1}constructor(e){super(),this.store=e}countEndToEndSessions(e,t){let n=0;for(let e=0;e<this.store.length;++e)this.store.key(e).startsWith(o(""))&&++n;t(n)}_getEndToEndSessions(e){const t=u(this.store,o(e)),n={};for(const[e,i]of Object.entries(t||{}))n[e]="string"==typeof i?{session:i}:i;return n}getEndToEndSession(e,t,n,i){i(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,n){n(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e)if(this.store.key(e).startsWith(o(""))){const n=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(n)))t(e)}}storeEndToEndSession(e,t,n,i){const s=this._getEndToEndSessions(e)||{};s[t]=n,h(this.store,o(e),s)}async storeEndToEndSessionProblem(e,t,n){const i=r(e),s=u(this.store,i)||[];s.push({type:t,fixed:n,time:Date.now()}),s.sort((e,t)=>e.time-t.time),h(this.store,i,s)}async getEndToEndSessionProblem(e,t){const n=r(e),i=u(this.store,n)||[];if(!i.length)return null;const s=i[i.length-1];for(const e of i)if(e.time>t)return Object.assign({},e,{fixed:s.fixed});return s.fixed?null:s}async filterOutNotifiedErrorDevices(e){const t=u(this.store,"crypto.notified_error_devices")||{},n=[];for(const i of e){const{userId:e,deviceInfo:s}=i;e in t?s.deviceId in t[e]||(n.push(i),t[e][s.deviceId]=!0):(n.push(i),t[e]={[s.deviceId]:!0})}return h(this.store,"crypto.notified_error_devices",t),n}getEndToEndInboundGroupSession(e,t,n,i){i(u(this.store,a(e,t)),u(this.store,c(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const n=this.store.key(e);n.startsWith("crypto.inboundgroupsessions/")&&t({senderKey:n.slice("crypto.inboundgroupsessions/".length,"crypto.inboundgroupsessions/".length+43),sessionId:n.slice("crypto.inboundgroupsessions/".length+44),sessionData:u(this.store,n)})}t(null)}addEndToEndInboundGroupSession(e,t,n,i){u(this.store,a(e,t))||this.storeEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){h(this.store,a(e,t),n)}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){h(this.store,c(e,t),n)}getEndToEndDeviceData(e,t){t(u(this.store,"crypto.device_data"))}storeEndToEndDeviceData(e,t){h(this.store,"crypto.device_data",e)}storeEndToEndRoom(e,t,n){h(this.store,l(e),t)}getEndToEndRooms(e,t){const n={},i=l("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(t.startsWith(i)){n[t.slice(i.length)]=u(this.store,t)}}t(n)}getSessionsNeedingBackup(e){const t=u(this.store,"crypto.sessionsneedingbackup")||{},n=[];for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const t=i.slice(0,43),s=i.slice(44);if(this.getEndToEndInboundGroupSession(t,s,null,e=>{n.push({senderKey:t,sessionId:s,sessionData:e})}),e&&n.length>=e)break}return Promise.resolve(n)}countSessionsNeedingBackup(){const e=u(this.store,"crypto.sessionsneedingbackup")||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=u(this.store,"crypto.sessionsneedingbackup")||{};for(const n of e)delete t[n.senderKey+"/"+n.sessionId];return h(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}markSessionsNeedingBackup(e){const t=u(this.store,"crypto.sessionsneedingbackup")||{};for(const n of e)t[n.senderKey+"/"+n.sessionId]=!0;return h(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}deleteAllData(){return this.store.removeItem("crypto.account"),Promise.resolve()}getAccount(e,t){t(u(this.store,"crypto.account"))}storeAccount(e,t){h(this.store,"crypto.account",t)}getCrossSigningKeys(e,t){t(u(this.store,"crypto.cross_signing_keys"))}getSecretStorePrivateKey(e,t,n){t(u(this.store,"crypto.ssss_cache."+n))}storeCrossSigningKeys(e,t){h(this.store,"crypto.cross_signing_keys",t)}storeSecretStorePrivateKey(e,t,n){h(this.store,"crypto.ssss_cache."+t,n)}doTxn(e,t,n){return Promise.resolve(n(null))}}function u(e,t){try{return JSON.parse(e.getItem(t))}catch(e){i.a.log("Error: Failed to get key %s: %s",t,e.stack||e),i.a.log(e.stack)}return null}function h(e,t,n){e.setItem(t,JSON.stringify(n))}},function(e,t,n){"use strict";function i(e,t){return new Promise((n,i)=>{let s=!0;const o=e.open(t);o.onupgradeneeded=()=>{s=!1},o.onblocked=()=>i(o.error),o.onsuccess=()=>{o.result.close(),s||e.deleteDatabase(t),n(s)},o.onerror=e=>i(o.error)})}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return d}));var i=n(17),s=n.n(i),o=n(0),r=n(187),a=n(850);function c(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152){const t=new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is 49152 bytes.");throw t.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"},t}}class l{constructor(e){this.cryptoStore=e,s()(this,"pickleKey","DEFAULT_KEY"),s()(this,"deviceCurve25519Key",null),s()(this,"deviceEd25519Key",null),s()(this,"maxOneTimeKeys",null),s()(this,"outboundGroupSessionStore",{}),s()(this,"inboundGroupSessionMessageIndexes",{}),s()(this,"sessionsInProgress",{}),s()(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return e.Olm.get_library_version()}async init(){let t,{pickleKey:n,fromExportedDevice:i}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const s=new e.Olm.Account;try{i?(n&&o.a.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=i.pickleKey,await this.initialiseFromExportedDevice(i,s)):(n&&(this.pickleKey=n),await this.initialiseAccount(s)),t=JSON.parse(s.identity_keys()),this.maxOneTimeKeys=s.max_number_of_one_time_keys()}finally{s.free()}this.deviceCurve25519Key=t.curve25519,this.deviceEd25519Key=t.ed25519}async initialiseFromExportedDevice(e,t){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT,r.a.STORE_SESSIONS],t=>{this.cryptoStore.storeAccount(t,e.pickledAccount),e.sessions.forEach(e=>{const{deviceKey:n,sessionId:i}=e,s={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(n,i,s,t)})}),t.unpickle(this.pickleKey,e.pickledAccount)}async initialiseAccount(e){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],t=>{this.cryptoStore.getAccount(t,n=>{null!==n?e.unpickle(this.pickleKey,n):(e.create(),n=e.pickle(this.pickleKey),this.cryptoStore.storeAccount(t,n))})})}getAccount(t,n){this.cryptoStore.getAccount(t,t=>{const i=new e.Olm.Account;try{i.unpickle(this.pickleKey,t),n(i)}finally{i.free()}})}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}async export(){const e={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT,r.a.STORE_SESSIONS],t=>{this.cryptoStore.getAccount(t,t=>{e.pickledAccount=t}),e.sessions=[],this.cryptoStore.getAllEndToEndSessions(t,t=>{e.sessions.push(t)})}),e}getSession(e,t,n,i){this.cryptoStore.getEndToEndSession(e,t,n,e=>{this.unpickleSession(e,i)})}unpickleSession(t,n){const i=new e.Olm.Session;try{i.unpickle(this.pickleKey,t.session);n(Object.assign({},t,{session:i}))}finally{i.free()}}saveSession(e,t,n){const i=t.session.session_id(),s=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,i,s,n)}getUtility(t){const n=new e.Olm.Utility;try{return t(n)}finally{n.free()}}async sign(e){let t;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT],n=>{this.getAccount(n,n=>{t=n.sign(e)})}),t}async getOneTimeKeys(){let e;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT],t=>{this.getAccount(t,t=>{e=JSON.parse(t.one_time_keys())})}),e}maxNumberOfOneTimeKeys(){return this.maxOneTimeKeys}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.mark_keys_as_published(),this.storeAccount(e,t)})})}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],t=>{this.getAccount(t,n=>{n.generate_one_time_keys(e),this.storeAccount(t,n)})})}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.generate_fallback_key(),this.storeAccount(e,t)})})}async getFallbackKey(){let e;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT],t=>{this.getAccount(t,t=>{e=JSON.parse(t.unpublished_fallback_key())})}),e}async forgetOldFallbackKey(){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.forget_old_fallback_key(),this.storeAccount(e,t)})})}async createOutboundSession(t,n){let i;return await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT,r.a.STORE_SESSIONS],s=>{this.getAccount(s,o=>{const r=new e.Olm.Session;try{r.create_outbound(o,t,n),i=r.session_id(),this.storeAccount(s,o);const e={session:r,lastReceivedMessageTs:Date.now()};this.saveSession(t,e,s)}finally{r.free()}})},o.a.withPrefix("[createOutboundSession]")),i}async createInboundSession(t,n,i){if(0!==n)throw new Error("Need messageType == 0 to create inbound session");let s;return await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT,r.a.STORE_SESSIONS],o=>{this.getAccount(o,r=>{const a=new e.Olm.Session;try{a.create_inbound_from(r,t,i),r.remove_one_time_keys(a),this.storeAccount(o,r);const e=a.decrypt(n,i),c={session:a,lastReceivedMessageTs:Date.now()};this.saveSession(t,c,o),s={payload:e,session_id:a.session_id()}}finally{a.free()}})},o.a.withPrefix("[createInboundSession]")),s}async getSessionIdsForDevice(e){const t=o.a.withPrefix("[getSessionIdsForDevice]");if(this.sessionsInProgress[e]){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}let n;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_SESSIONS],t=>{this.cryptoStore.getEndToEndSessions(e,t,e=>{n=Object.keys(e)})},t),n}async getSessionIdForDevice(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;const i=await this.getSessionInfoForDevice(e,t,n);if(0===i.length)return null;let s=0;for(let e=1;e<i.length;e++){const t=i[e],n=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,o=i[s],r=void 0===o.lastReceivedMessageTs?0:o.lastReceivedMessageTs;(n>r||n===r&&t.sessionId<o.sessionId)&&(s=e)}return i[s].sessionId}async getSessionInfoForDevice(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.a;if(n=n.withPrefix("[getSessionInfoForDevice]"),this.sessionsInProgress[e]&&!t){n.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}const i=[];return await this.cryptoStore.doTxn("readonly",[r.a.STORE_SESSIONS],t=>{this.cryptoStore.getEndToEndSessions(e,t,e=>{const t=Object.keys(e).sort();for(const n of t)this.unpickleSession(e[n],e=>{i.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:n})})})},n),i}async encryptMessage(e,t,n){let i;return c(n),await this.cryptoStore.doTxn("readwrite",[r.a.STORE_SESSIONS],s=>{this.getSession(e,t,s,r=>{const a=r.session.describe();o.a.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),i=r.session.encrypt(n),this.saveSession(e,r,s)})},o.a.withPrefix("[encryptMessage]")),i}async decryptMessage(e,t,n,i){let s;return await this.cryptoStore.doTxn("readwrite",[r.a.STORE_SESSIONS],r=>{this.getSession(e,t,r,a=>{const c=a.session.describe();o.a.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),s=a.session.decrypt(n,i),a.lastReceivedMessageTs=Date.now(),this.saveSession(e,a,r)})},o.a.withPrefix("[decryptMessage]")),s}async matchesSession(e,t,n,i){if(0!==n)return!1;let s;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_SESSIONS],n=>{this.getSession(e,t,n,e=>{s=e.session.matches_inbound(i)})},o.a.withPrefix("[matchesSession]")),s}async recordSessionProblem(e,t,n){await this.cryptoStore.storeEndToEndSessionProblem(e,t,n)}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(t,n){const i=this.outboundGroupSessionStore[t];if(void 0===i)throw new Error("Unknown outbound group session "+t);const s=new e.Olm.OutboundGroupSession;try{return s.unpickle(this.pickleKey,i),n(s)}finally{s.free()}}createOutboundGroupSession(){const t=new e.Olm.OutboundGroupSession;try{return t.create(),this.saveOutboundGroupSession(t),t.session_id()}finally{t.free()}}encryptGroupMessage(e,t){return o.a.log("encrypting msg with megolm session "+e),c(t),this.getOutboundGroupSession(e,e=>{const n=e.encrypt(t);return this.saveOutboundGroupSession(e),n})}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))}unpickleInboundGroupSession(t,n){const i=new e.Olm.InboundGroupSession;try{return i.unpickle(this.pickleKey,t.session),n(i)}finally{i.free()}}getInboundGroupSession(e,t,n,i,s){this.cryptoStore.getEndToEndInboundGroupSession(t,n,i,(t,n)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this.unpickleInboundGroupSession(t,e=>{s(e,t,n)})}else s(null,null,n)})}async addInboundGroupSession(t,n,i,s,a,c,l){let d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};await this.cryptoStore.doTxn("readwrite",[r.a.STORE_INBOUND_GROUP_SESSIONS,r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,r.a.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],r=>{this.getInboundGroupSession(t,n,s,r,(u,h)=>{const m=new e.Olm.InboundGroupSession;try{if(l?m.import_session(a):m.create(a),s!=m.session_id())throw new Error("Mismatched group session ID from senderKey: "+n);if(u&&(o.a.log("Update for megolm session "+n+"/"+s),u.first_known_index()<=m.first_known_index()&&(u.first_known_index()!=m.first_known_index()||d.untrusted||!h.untrusted)))return void o.a.log("Keeping existing megolm session "+s);o.a.info("Storing megolm session "+n+"/"+s+" with first index "+m.first_known_index());const e=Object.assign({},d,{room_id:t,session:m.pickle(this.pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:i});this.cryptoStore.storeEndToEndInboundGroupSession(n,s,e,r),!u&&d.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(t,n,s,r)}finally{m.free()}})},o.a.withPrefix("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(e,t,n,i,s){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],o=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,n,{room_id:e,code:i,reason:s},o)})}async decryptGroupMessage(e,t,n,i,s,c){let l,d;if(await this.cryptoStore.doTxn("readwrite",[r.a.STORE_INBOUND_GROUP_SESSIONS,r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],o=>{this.getInboundGroupSession(e,t,n,o,(e,r,h)=>{if(null===e)return h&&(d=new a.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",u(h),{session:t+"|"+n})),void(l=null);let m;try{m=e.decrypt(i)}catch(e){return void(d=e&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.message&&h?new a.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",u(h),{session:t+"|"+n}):e)}let p=m.plaintext;if(void 0===p)p=m;else{const e=t+"|"+n+"|"+m.message_index;if(e in this.inboundGroupSessionMessageIndexes){const t=this.inboundGroupSessionMessageIndexes[e];if(t.id!==s||t.timestamp!==c)return void(d=new Error("Duplicate message index, possible replay attack: "+e))}this.inboundGroupSessionMessageIndexes[e]={id:s,timestamp:c}}r.session=e.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(t,n,r,o),l={result:p,keysClaimed:r.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:r.forwardingCurve25519KeyChain||[],untrusted:r.untrusted}})},o.a.withPrefix("[decryptGroupMessage]")),d)throw d;return l}async hasInboundSessionKeys(e,t,n){let i;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_INBOUND_GROUP_SESSIONS,r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],s=>{this.cryptoStore.getEndToEndInboundGroupSession(t,n,s,s=>{null!==s?e!==s.room_id?(o.a.warn(`requested keys for inbound group session ${t}|`+n+", with incorrect room_id "+`(expected ${s.room_id}, `+`was ${e})`),i=!1):i=!0:i=!1})},o.a.withPrefix("[hasInboundSessionKeys]")),i}async getInboundGroupSessionKey(e,t,n,i){let s;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_INBOUND_GROUP_SESSIONS,r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],o=>{this.getInboundGroupSession(e,t,n,o,(e,t)=>{if(null===e)return void(s=null);void 0===i&&(i=e.first_known_index());const n=e.export_session(i),o=(t.keysClaimed||{}).ed25519||null;s={chain_index:i,key:n,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:o,shared_history:t.sharedHistory||!1}})},o.a.withPrefix("[getInboundGroupSessionKey]")),s}exportInboundGroupSession(e,t,n){return this.unpickleInboundGroupSession(n,i=>{const s=i.first_known_index();return{sender_key:e,sender_claimed_keys:n.keysClaimed,room_id:n.room_id,session_id:t,session_key:i.export_session(s),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:i.first_known_index(),"org.matrix.msc3061.shared_history":n.sharedHistory||!1}})}async getSharedHistoryInboundGroupSessions(e){let t;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],n=>{t=this.cryptoStore.getSharedHistoryInboundGroupSessions(e,n)},o.a.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]")),t}verifySignature(e,t,n){this.getUtility((function(i){i.ed25519_verify(e,t,n)}))}}const d={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function u(e){return e.code&&e.code in d?d[e.code]:e.reason?e.reason:"decryption key withheld"}}).call(this,n(30))},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(17),s=n.n(i),o=n(0),r=n(161),a=n(367),c=n(600);function l(e){var t,n;const i=null==e||null===(t=e.currentState)||void 0===t?void 0:t.getStateEvents("m.room.history_visibility",""),s=null==i||null===(n=i.getContent())||void 0===n?void 0:n.history_visibility;return["world_readable","shared"].includes(s)}class d{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.sessionId=e,this.sharedHistory=t,s()(this,"useCount",0),s()(this,"creationTime",void 0),s()(this,"sharedWithDevices",{}),s()(this,"blockedDevicesNotified",{}),this.creationTime=(new Date).getTime()}needsRotation(e,t){const n=(new Date).getTime()-this.creationTime;return(this.useCount>=e||n>=t)&&(o.a.log("Rotating megolm session after "+this.useCount+" messages, "+n+"ms"),!0)}markSharedWithDevice(e,t,n,i){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]={deviceKey:n,messageIndex:i}}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0}sharedWithTooManyDevices(e){for(const t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return o.a.log("Starting new megolm session because we shared with "+t),!0;for(const n in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(n)&&!e[t].hasOwnProperty(n))return o.a.log("Starting new megolm session because we shared with "+t+":"+n),!0}}}class u extends a.e{constructor(e){var t,n,i,o;super(e),s()(this,"setupPromise",Promise.resolve(void 0)),s()(this,"outboundSessions",{}),s()(this,"sessionRotationPeriodMsgs",void 0),s()(this,"sessionRotationPeriodMs",void 0),s()(this,"encryptionPreparation",void 0),s()(this,"encryptionPreparationMetadata",void 0),this.sessionRotationPeriodMsgs=null!==(t=null===(n=e.config)||void 0===n?void 0:n.rotation_period_msgs)&&void 0!==t?t:100,this.sessionRotationPeriodMs=null!==(i=null===(o=e.config)||void 0===o?void 0:o.rotation_period_ms)&&void 0!==i?i:6048e5}async ensureOutboundSession(e,t,n){let i,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];function a(){return i}const c=this.setupPromise.then(async a=>{i=a;const c=l(e);i&&c!==i.sharedHistory&&(i=null),i&&i.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(o.a.log("Starting new megolm session because we need to rotate."),i=null),i&&i.sharedWithTooManyDevices(t)&&(i=null),i||(o.a.log("Starting new megolm session for room "+this.roomId),i=await this.prepareNewSession(c),o.a.log(`Started new megolm session ${i.sessionId} for room `+this.roomId),this.outboundSessions[i.sessionId]=i);const d={};for(const[e,n]of Object.entries(t))for(const[t,s]of Object.entries(n)){s.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(i.sharedWithDevices[e]&&void 0!==i.sharedWithDevices[e][t]||(d[e]=d[e]||[],d[e].push(s)))}const u=this.olmDevice.getOutboundGroupSessionKey(i.sessionId),h={type:"m.room_key",content:{algorithm:r.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:i.sessionId,session_key:u.key,chain_index:u.chain_index,"org.matrix.msc3061.shared_history":c}},[m,p]=await r.getExistingOlmSessions(this.olmDevice,this.baseApis,d);await Promise.all([(async()=>{o.a.debug("Sharing keys with existing Olm sessions in "+this.roomId,p),await this.shareKeyWithOlmSessions(i,u,h,p),o.a.debug("Shared keys with existing Olm sessions in "+this.roomId)})(),(async()=>{o.a.debug("Sharing keys (start phase 1) with new Olm sessions in "+this.roomId,m);const e=[],t=Date.now(),n=[];await this.shareKeyWithDevices(i,u,h,m,e,s?1e4:2e3,n),o.a.debug("Shared keys (end phase 1) with new Olm sessions in "+this.roomId),!s&&Date.now()-t<1e4?(async()=>{const t={},s=new Set;for(const e of n)s.add(e);const r=[];for(const{userId:n,deviceInfo:i}of e){const e=n.slice(n.indexOf(":")+1);s.has(e)?(t[n]=t[n]||[],t[n].push(i)):r.push({userId:n,deviceInfo:i})}o.a.debug("Sharing keys (start phase 2) with new Olm sessions in "+this.roomId),await this.shareKeyWithDevices(i,u,h,t,r,3e4),o.a.debug("Shared keys (end phase 2) with new Olm sessions in "+this.roomId),await this.notifyFailedOlmDevices(i,u,r)})():await this.notifyFailedOlmDevices(i,u,e),o.a.debug("Shared keys (all phases done) with new Olm sessions in "+this.roomId)})(),(async()=>{o.a.debug(`There are ${Object.entries(n).length} blocked devices in ${this.roomId}`,Object.entries(n)),o.a.debug("Notifying newly blocked devices in "+this.roomId);const e={};let t=0;for(const[s,o]of Object.entries(n))for(const[n,r]of Object.entries(o))i.blockedDevicesNotified[s]&&void 0!==i.blockedDevicesNotified[s][n]||(e[s]=e[s]||{},e[s][n]={device:r},t++);await this.notifyBlockedDevices(i,e),o.a.debug(`Notified ${t} newly blocked devices in ${this.roomId}`,e)})()])});return c.catch(e=>{o.a.error("Failed to ensure outbound session in "+this.roomId,e)}),this.setupPromise=c.then(a,a),c.then(a)}async prepareNewSession(e){const t=this.olmDevice.createOutboundGroupSession(),n=this.olmDevice.getOutboundGroupSessionKey(t);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],t,n.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,t),new d(t,e)}getDevicesWithoutSessions(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];for(const[i,s]of Object.entries(t)){const t=e[i];for(const e of s){const s=e.deviceId;t[s].sessionId||(n.push({userId:i,deviceInfo:e}),delete t[s])}}return n}splitDevices(e){let t=[];const n=[t];for(const[i,s]of Object.entries(e)){for(const e of Object.values(s))t.push({userId:i,deviceInfo:e.device});t.length>20&&(t=[],n.push(t))}return 0===t.length&&n.pop(),n}encryptAndSendKeysToDevices(e,t,n,i){const s={},a=new Map,c=[];for(let e=0;e<n.length;e++){const t={algorithm:r.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},o=n[e],l=o.userId,d=o.deviceInfo,u=d.deviceId;a.set(u,d),s[l]||(s[l]={}),s[l][u]=t,c.push(r.encryptMessageForDevice(t.ciphertext,this.userId,this.deviceId,this.olmDevice,l,d,i))}return Promise.all(c).then(()=>{for(const e of Object.keys(s)){for(const t of Object.keys(s[e]))0===Object.keys(s[e][t].ciphertext).length&&(o.a.log("No ciphertext for device "+e+":"+t+": pruning"),delete s[e][t]);0===Object.keys(s[e]).length&&(o.a.log("Pruned all devices for user "+e),delete s[e])}if(0!==Object.keys(s).length)return this.baseApis.sendToDevice("m.room.encrypted",s).then(()=>{for(const n of Object.keys(s))for(const i of Object.keys(s[n]))e.markSharedWithDevice(n,i,a.get(i).getIdentityKey(),t)});o.a.log("No users left to send to: aborting")})}async sendBlockedNotificationsToDevices(e,t,n){const i={};for(const e of t){const t=e.userId,s=e.deviceInfo,o=s.deviceInfo.deviceId,r=Object.assign({},n);r.code=s.code,r.reason=s.reason,"m.no_olm"===r.code&&(delete r.room_id,delete r.session_id),i[t]||(i[t]={}),i[t][o]=r}await this.baseApis.sendToDevice("org.matrix.room_key.withheld",i),await this.baseApis.sendToDevice("m.room_key.withheld",i);for(const t of Object.keys(i))for(const n of Object.keys(i[t]))e.markNotifiedBlockedDevice(t,n)}async reshareKeyWithDevice(e,t,n,i){const s=this.outboundSessions[t];if(!s)return void o.a.debug(`megolm session ${t} not found: not re-sharing keys`);if(void 0===s.sharedWithDevices[n])return void o.a.debug(`megolm session ${t} never shared with user ${n}`);const a=s.sharedWithDevices[n][i.deviceId];if(void 0===a)return void o.a.debug("megolm session ID "+t+" never shared with device "+n+":"+i.deviceId);if(a.deviceKey!==i.getIdentityKey())return void o.a.warn(`Session has been shared with device ${i.deviceId} but with identity key ${a.deviceKey}. Key is now ${i.getIdentityKey()}!`);const c=await this.olmDevice.getInboundGroupSessionKey(this.roomId,e,t,a.messageIndex);if(!c)return void o.a.warn(`No inbound session key found for megolm ${t}: not re-sharing keys`);await r.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[n]:[i]});const l={type:"m.forwarded_room_key",content:{algorithm:r.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":c.shared_history||!1}},d={algorithm:r.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await r.encryptMessageForDevice(d.ciphertext,this.userId,this.deviceId,this.olmDevice,n,i,l),await this.baseApis.sendToDevice("m.room.encrypted",{[n]:{[i.deviceId]:d}}),o.a.debug(`Re-shared key for megolm session ${t} with ${n}:${i.deviceId}`)}async shareKeyWithDevices(e,t,n,i,s,a,c){o.a.debug("Ensuring Olm sessions for devices in "+this.roomId);const l=await r.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,i,!1,a,c,o.a.withPrefix(`[${this.roomId}]`));o.a.debug("Ensured Olm sessions for devices in "+this.roomId),this.getDevicesWithoutSessions(l,i,s),o.a.debug("Sharing keys with newly created Olm sessions in "+this.roomId),await this.shareKeyWithOlmSessions(e,t,n,l),o.a.debug("Shared keys with newly created Olm sessions in "+this.roomId)}async shareKeyWithOlmSessions(e,t,n,i){const s=this.splitDevices(i);for(let i=0;i<s.length;i++){const r=`megolm keys for ${e.sessionId} in ${this.roomId} (slice ${i+1}/${s.length})`;try{o.a.debug("Sharing "+r,s[i].map(e=>`${e.userId}/${e.deviceInfo.deviceId}`)),await this.encryptAndSendKeysToDevices(e,t.chain_index,s[i],n),o.a.debug("Shared "+r)}catch(e){throw o.a.error("Failed to share "+r),e}}}async notifyFailedOlmDevices(e,t,n){o.a.debug(`Notifying ${n.length} devices we failed to create Olm sessions in `+this.roomId);for(const{userId:i,deviceInfo:s}of n){const n=s.deviceId;e.markSharedWithDevice(i,n,s.getIdentityKey(),t.chain_index)}const i=await this.olmDevice.filterOutNotifiedErrorDevices(n);o.a.debug(`Need to notify ${i.length} failed devices which haven't been notified before in `+this.roomId);const s={};for(const{userId:e,deviceInfo:t}of i)s[e]=s[e]||{},s[e][t.deviceId]={device:{code:"m.no_olm",reason:c.b["m.no_olm"],deviceInfo:t}};await this.notifyBlockedDevices(e,s),o.a.debug(`Notified ${i.length} devices we failed to create Olm sessions in `+this.roomId)}async notifyBlockedDevices(e,t){const n={room_id:this.roomId,session_id:e.sessionId,algorithm:r.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},i=this.splitDevices(t);for(let t=0;t<i.length;t++)try{await this.sendBlockedNotificationsToDevices(e,i[t],n),o.a.log(`Completed blacklist notification for ${e.sessionId} in ${this.roomId} (slice ${t+1}/${i.length})`)}catch(n){throw o.a.log(`blacklist notification for ${e.sessionId} in ${this.roomId} (slice ${t+1}/${i.length}) failed`),n}}prepareToEncrypt(e){if(this.encryptionPreparation){const e=Date.now()-this.encryptionPreparationMetadata.startTime;o.a.debug(`Already started preparing to encrypt for ${this.roomId} `+e+" ms ago, skipping")}else o.a.debug("Preparing to encrypt events for "+this.roomId),this.encryptionPreparationMetadata={startTime:Date.now()},this.encryptionPreparation=(async()=>{try{o.a.debug("Getting devices in "+this.roomId);const[t,n]=await this.getDevicesInRoom(e);this.crypto.getGlobalErrorOnUnknownDevices()&&this.removeUnknownDevices(t),o.a.debug("Ensuring outbound session in "+this.roomId),await this.ensureOutboundSession(e,t,n,!0),o.a.debug("Ready to encrypt events for "+this.roomId)}catch(e){o.a.error("Failed to prepare to encrypt events for "+this.roomId,e)}finally{delete this.encryptionPreparationMetadata,delete this.encryptionPreparation}})()}async encryptMessage(e,t,n){if(o.a.log("Starting to encrypt event for "+this.roomId),this.encryptionPreparation)try{await this.encryptionPreparation}catch(e){}const[i,s]=await this.getDevicesInRoom(e);this.crypto.getGlobalErrorOnUnknownDevices()&&this.checkForUnknownDevices(i);const a=await this.ensureOutboundSession(e,i,s),c={room_id:this.roomId,type:t,content:n},l=this.olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(c)),d={algorithm:r.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:l,session_id:a.sessionId,device_id:this.deviceId};return a.useCount++,d}forceDiscardSession(){this.setupPromise=this.setupPromise.then(()=>null)}checkForUnknownDevices(e){const t={};if(Object.keys(e).forEach(n=>{Object.keys(e[n]).forEach(i=>{const s=e[n][i];s.isUnverified()&&!s.isKnown()&&(t[n]||(t[n]={}),t[n][i]=s)})}),Object.keys(t).length)throw new a.f("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(const[t,n]of Object.entries(e)){for(const[e,t]of Object.entries(n))t.isUnverified()&&!t.isKnown()&&delete n[e];0===Object.keys(n).length&&delete e[t]}}async getDevicesInRoom(e){const t=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));let n=this.crypto.getGlobalBlacklistUnverifiedDevices();"boolean"==typeof e.getBlacklistUnverifiedDevices()&&(n=e.getBlacklistUnverifiedDevices());const i=await this.crypto.downloadKeys(t,!1),s={};for(const e in i){if(!i.hasOwnProperty(e))continue;const t=i[e];for(const i in t){if(!t.hasOwnProperty(i))continue;const o=this.crypto.checkDeviceTrust(e,i);if(t[i].isBlocked()||!o.isVerified()&&n){s[e]||(s[e]={});const n=t[i].isBlocked();s[e][i]={code:n?"m.blacklisted":"m.unverified",reason:c.b[n?"m.blacklisted":"m.unverified"],deviceInfo:t[i]},delete t[i]}}}return[i,s]}}class h extends a.b{constructor(){super(...arguments),s()(this,"pendingEvents",{}),s()(this,"olmlib",r)}async decryptEvent(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new a.c("MEGOLM_MISSING_FIELDS","Missing fields in input");let n;this.addEventToPendingList(e);try{n=await this.olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(n){if("DecryptionError"===n.name)throw n;let i="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw n&&"OLM.UNKNOWN_MESSAGE_INDEX"===n.message&&(this.requestKeysForEvent(e),i="OLM_UNKNOWN_MESSAGE_INDEX"),new a.c(i,n?n.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===n){this.requestKeysForEvent(e);const n=await this.olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(n){let e=m[n.type]||m.unknown;throw n.fixed&&(e+=" Trying to create a new secure channel and re-requesting the keys."),new a.c("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e,{session:t.sender_key+"|"+t.session_id})}throw new a.c("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}this.removeEventFromPendingList(e);const i=JSON.parse(n.result);if(i.room_id!==e.getRoomId())throw new a.c("MEGOLM_BAD_ROOM","Message intended for room "+i.room_id);return{clearEvent:i,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain,untrusted:n.untrusted}}requestKeysForEvent(e){const t=e.getWireContent(),n=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},n)}addEventToPendingList(e){const t=e.getWireContent(),n=t.sender_key,i=t.session_id;this.pendingEvents[n]||(this.pendingEvents[n]=new Map);const s=this.pendingEvents[n];s.has(i)||s.set(i,new Set),s.get(i).add(e)}removeEventFromPendingList(e){const t=e.getWireContent(),n=t.sender_key,i=t.session_id,s=this.pendingEvents[n],o=null==s?void 0:s.get(i);o&&(o.delete(e),0===o.size&&s.delete(i),0===s.size&&delete this.pendingEvents[n])}onRoomKeyEvent(e){const t=e.getContent(),n=t.session_id;let i,s=e.getSenderKey(),r=[],a=!1;if(!t.room_id||!n||!t.session_key)return void o.a.error("key event is missing fields");if(!s)return void o.a.error("key event has no sender key (not encrypted?)");if("m.forwarded_room_key"==e.getType()){if(a=!0,r=t.forwarding_curve25519_key_chain,Array.isArray(r)||(r=[]),r=r.slice(),r.push(s),s=t.sender_key,!s)return void o.a.error("forwarded_room_key event is missing sender_key field");const e=t.sender_claimed_ed25519_key;if(!e)return void o.a.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");i={ed25519:e}}else i=e.getKeysClaimed();const c={};return t["org.matrix.msc3061.shared_history"]&&(c.sharedHistory=!0),this.olmDevice.addInboundGroupSession(t.room_id,s,r,n,t.session_key,i,a,c).then(()=>{this.retryDecryption(s,n).then(e=>{e&&this.crypto.cancelRoomKeyRequest({algorithm:t.algorithm,room_id:t.room_id,session_id:t.session_id,sender_key:s})})}).then(()=>{this.crypto.backupManager.backupGroupSession(s,t.session_id)}).catch(e=>{o.a.error("Error handling m.room_key_event: "+e)})}async onRoomKeyWithheldEvent(e){const t=e.getContent(),n=t.sender_key;if("m.no_olm"===t.code){const i=e.getSender();if(o.a.warn(`${i}:${n} was unable to establish an olm session with us`),await this.olmDevice.getSessionIdForDevice(n))return o.a.debug("New session already created.  Not creating a new one."),await this.olmDevice.recordSessionProblem(n,"no_olm",!0),void this.retryDecryptionFromSender(n);let s=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,n);if(!s&&(await this.crypto.downloadKeys([i],!1),s=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,n),!s))return o.a.info("Couldn't find device for identity key "+n+": not establishing session"),await this.olmDevice.recordSessionProblem(n,"no_olm",!1),void this.retryDecryptionFromSender(n);await r.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[i]:[s]},!1);const a={algorithm:r.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await r.encryptMessageForDevice(a.ciphertext,this.userId,void 0,this.olmDevice,i,s,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(n,"no_olm",!0),this.retryDecryptionFromSender(n),await this.baseApis.sendToDevice("m.room.encrypted",{[i]:{[s.deviceId]:a}})}else await this.olmDevice.addInboundGroupSessionWithheld(t.room_id,n,t.session_id,t.code,t.reason)}hasKeysForKeyRequest(e){const t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){const t=e.userId,n=e.deviceId,i=this.crypto.getStoredDevice(t,n),s=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[t]:[i]}).then(e=>e[t][n].sessionId?(o.a.log("sharing keys for session "+s.sender_key+"|"+s.session_id+" with device "+t+":"+n),this.buildKeyForwardingMessage(s.room_id,s.sender_key,s.session_id)):null).then(e=>{const s={algorithm:r.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};return this.olmlib.encryptMessageForDevice(s.ciphertext,this.userId,void 0,this.olmDevice,t,i,e).then(()=>{const e={[t]:{[n]:s}};return this.baseApis.sendToDevice("m.room.encrypted",e)})})}async buildKeyForwardingMessage(e,t,n){const i=await this.olmDevice.getInboundGroupSessionKey(e,t,n);return{type:"m.forwarded_room_key",content:{algorithm:r.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:i.sender_claimed_ed25519_key,session_id:n,session_key:i.key,chain_index:i.chain_index,forwarding_curve25519_key_chain:i.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":i.shared_history||!1}}}importRoomKey(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n={};return(t.untrusted||e.untrusted)&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then(()=>{"backup"!==t.source&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch(e=>{o.a.log("Failed to back up megolm session",e)}),this.retryDecryption(e.sender_key,e.session_id)})}async retryDecryption(e,t){var n;const i=this.pendingEvents[e];if(!i)return!0;const s=i.get(t);return!s||(o.a.debug("Retrying decryption on events",[...s]),await Promise.all([...s].map(async e=>{try{await e.attemptDecryption(this.crypto,{isRetry:!0})}catch(e){}})),!(null!==(n=this.pendingEvents[e])&&void 0!==n&&n.has(t)))}async retryDecryptionFromSender(e){const t=this.pendingEvents[e];return!t||(delete this.pendingEvents[e],await Promise.all([...t].map(async e=>{let[t,n]=e;await Promise.all([...n].map(async e=>{try{await e.attemptDecryption(this.crypto)}catch(e){}}))})),!this.pendingEvents[e])}async sendSharedHistoryInboundSessions(e){await r.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,e),o.a.log("sendSharedHistoryInboundSessions to users",Object.keys(e));const t=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);o.a.log("shared-history sessions",t);for(const[n,i]of t){const t=await this.buildKeyForwardingMessage(this.roomId,n,i),s=[],a={};for(const[n,i]of Object.entries(e)){a[n]={};for(const e of i){const i={algorithm:r.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};a[n][e.deviceId]=i,s.push(r.encryptMessageForDevice(i.ciphertext,this.userId,void 0,this.olmDevice,n,e,t))}}await Promise.all(s);for(const e of Object.keys(a)){for(const t of Object.keys(a[e]))0===Object.keys(a[e][t].ciphertext).length&&(o.a.log("No ciphertext for device "+e+":"+t+": pruning"),delete a[e][t]);0===Object.keys(a[e]).length&&(o.a.log("Pruned all devices for user "+e),delete a[e])}if(0===Object.keys(a).length)return void o.a.log("No users left to send to: aborting");await this.baseApis.sendToDevice("m.room.encrypted",a)}}}const m={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};Object(a.g)(r.MEGOLM_ALGORITHM,u,h)},function(e,t,n){"use strict";(function(e,i){n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return p}));var s=n(17),o=n.n(s),r=n(365),a=n.n(r),c=n(161),l=n(187),d=n(284),u=n(0),h=n(224);const m="org.matrix.msc2697.v1.olm.libolm_pickle";class p{constructor(e){this.crypto=e,o()(this,"inProgress",!1),o()(this,"timeoutId",void 0),o()(this,"key",void 0),o()(this,"keyInfo",void 0),o()(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[l.a.STORE_ACCOUNT],t=>{this.crypto.cryptoStore.getSecretStorePrivateKey(t,async t=>{if(t){const{key:n,keyInfo:s,deviceDisplayName:o,time:r}=t,a=e.from(this.crypto.olmDevice.pickleKey),l=await Object(d.b)(n,a,m);this.key=Object(c.decodeBase64)(l),this.keyInfo=s,this.deviceDisplayName=o;const u=Date.now(),h=Math.max(1,r+6048e5-u);this.timeoutId=i.setTimeout(this.dehydrateDevice.bind(this),h)}},"dehydration")})}async setKeyAndQueueDehydration(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;await this.setKey(e,t,n)||this.dehydrateDevice()}async setKey(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if(!e)return this.timeoutId&&(i.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[l.a.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)}),this.key=void 0,void(this.keyInfo=void 0);let s=this.key&&e.length==this.key.length;for(let t=0;s&&t<e.length;t++)e[t]!=this.key[t]&&(s=!1);return s||(this.key=e,this.keyInfo=t,this.deviceDisplayName=n),s}async dehydrateDevice(){if(this.inProgress)u.a.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(i.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const t=e.from(this.crypto.olmDevice.pickleKey),n=await Object(d.c)(Object(c.encodeBase64)(this.key),t,m);await this.crypto.cryptoStore.doTxn("readwrite",[l.a.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:n,deviceDisplayName:this.deviceDisplayName,time:Date.now()})}),u.a.log("Attempting to dehydrate device"),u.a.log("Creating account");const s=new i.Olm.Account;s.create();const o=JSON.parse(s.identity_keys()),r=s.max_number_of_one_time_keys();s.generate_one_time_keys(r/2),s.generate_fallback_key();const p=JSON.parse(s.one_time_keys()),g=JSON.parse(s.fallback_key());s.mark_keys_as_published();const f=s.pickle(new Uint8Array(this.key)),v={algorithm:m,account:f};this.keyInfo.passphrase&&(v.passphrase=this.keyInfo.passphrase),u.a.log("Uploading account to server");const b=(await this.crypto.baseApis.http.authedRequest(void 0,h.f.Put,"/dehydrated_device",void 0,{device_data:v,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;u.a.log("Preparing device keys",b);const y={algorithms:this.crypto.supportedAlgorithms,device_id:b,user_id:this.crypto.userId,keys:{["ed25519:"+b]:o.ed25519,["curve25519:"+b]:o.curve25519}},S=s.sign(a.a.stringify(y));y.signatures={[this.crypto.userId]:{["ed25519:"+b]:S}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(y,"self_signing"),u.a.log("Preparing one-time keys");const E={};for(const[e,t]of Object.entries(p.curve25519)){const n={key:t},i=s.sign(a.a.stringify(n));n.signatures={[this.crypto.userId]:{["ed25519:"+b]:i}},E["signed_curve25519:"+e]=n}u.a.log("Preparing fallback keys");const w={};for(const[e,t]of Object.entries(g.curve25519)){const n={key:t,fallback:!0},i=s.sign(a.a.stringify(n));n.signatures={[this.crypto.userId]:{["ed25519:"+b]:i}},w["signed_curve25519:"+e]=n}return u.a.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(void 0,h.f.Post,"/keys/upload/"+encodeURI(b),void 0,{device_keys:y,one_time_keys:E,"org.matrix.msc2732.fallback_keys":w}),u.a.log("Done dehydrating"),this.timeoutId=i.setTimeout(this.dehydrateDevice.bind(this),6048e5),b}finally{this.inProgress=!1}}}stop(){this.timeoutId&&(i.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}}).call(this,n(31).Buffer,n(30))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return g}));var i=n(17),s=n.n(i),o=n(119),r=n(0),a=n(161),c=n(371),l=n(7),d=n(187),u=n(372),h=n(284),m=n(3),p=n(145);class g{constructor(e,t){this.baseApis=e,this.getKey=t,s()(this,"algorithm",void 0),s()(this,"backupInfo",void 0),s()(this,"checkedForBackup",void 0),s()(this,"sendingBackups",void 0),this.checkedForBackup=!1,this.sendingBackups=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){const t=y[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if("object"!=typeof e.auth_data)throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){const n=y[e.algorithm];if(!n)throw new Error("Unknown backup algorithm");return n.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await g.makeAlgorithm(e,this.getKey),this.baseApis.emit(p.b.KeyBackupStatus,!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(p.b.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}async prepareKeyBackupVersion(e,t){const n=t?y[t]:S;if(!n)throw new Error("Unknown backup algorithm");const[i,s]=await n.prepare(e),o=Object(u.b)(i);return{algorithm:n.algorithmName,auth_data:s,recovery_key:o,privateKey:i}}async createKeyBackupVersion(e){this.algorithm=await g.makeAlgorithm(e,this.getKey)}async checkAndStart(){if(r.a.log("Checking key backup status..."),this.baseApis.isGuest())return r.a.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{e=await this.baseApis.getKeyBackupVersion()}catch(e){return r.a.log("Error checking for active key backup",e),404===e.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(r.a.log("Found usable key backup v"+e.version+": enabling key backups"),await this.enableKeyBackup(e)):!t.usable&&this.backupInfo?(r.a.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(r.a.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):r.a.log("Backup version "+e.version+" still current")):r.a.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async isKeyBackupTrusted(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.signatures))return r.a.info("Key backup is absent or missing required data"),t;const n=await this.baseApis.crypto.getSessionBackupPrivateKey();if(n){let i;try{i=await g.makeAlgorithm(e,async()=>n),await i.keyMatches(n)&&(r.a.info("Backup is trusted locally"),t.trusted_locally=!0)}catch{}finally{i&&i.free()}}const i=e.auth_data.signatures[this.baseApis.getUserId()]||{};for(const n of Object.keys(i)){const i=n.split(":");if("ed25519"!==i[0]){r.a.log("Ignoring unknown signature type: "+i[0]);continue}const s={deviceId:i[1]},o=this.baseApis.crypto.crossSigningInfo.getId();if(o===s.deviceId){s.crossSigningId=!0;try{await Object(a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),s.deviceId,o),s.valid=!0}catch(e){r.a.warn("Bad signature from cross signing key "+o,e),s.valid=!1}t.sigs.push(s);continue}const c=this.baseApis.crypto.deviceList.getStoredDevice(this.baseApis.getUserId(),s.deviceId);if(c){s.device=c,s.deviceTrust=this.baseApis.checkDeviceTrust(this.baseApis.getUserId(),s.deviceId);try{await Object(a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),c.deviceId,c.getFingerprint()),s.valid=!0}catch(t){r.a.info("Bad signature from key ID "+n+" userID "+this.baseApis.getUserId()+" device ID "+c.deviceId+" fingerprint: "+c.getFingerprint(),e.auth_data,t),s.valid=!1}}else s.valid=null,r.a.info("Ignoring signature from unknown key "+n);t.sigs.push(s)}return t.usable=t.sigs.some(e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId)),t.usable=t.usable||t.trusted_locally,t}async scheduleKeyBackupSend(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;if(!this.sendingBackups){this.sendingBackups=!0;try{const t=Math.random()*e;await Object(l.G)(t);let n=0;for(;;){if(!this.algorithm)return;try{if(0===await this.backupPendingKeys(200))return;n=0}catch(e){if(n++,r.a.log("Key backup request failed",e),e.data&&("M_NOT_FOUND"==e.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==e.data.errcode))throw await this.checkKeyBackup(),this.baseApis.crypto.emit(p.b.KeyBackupFailed,e.data.errcode),e}n&&await Object(l.G)(1e3*Math.pow(2,Math.min(n-1,4)))}}finally{this.sendingBackups=!1}}}async backupPendingKeys(e){const t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let n=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(p.b.KeyBackupSessionsRemaining,n);const i={};for(const e of t){const t=e.sessionData.room_id;void 0===i[t]&&(i[t]={sessions:{}});const n=this.baseApis.crypto.olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);n.algorithm=a.MEGOLM_ALGORITHM;const s=(n.forwarding_curve25519_key_chain||[]).length,o=this.baseApis.crypto.deviceList.getUserByIdentityKey(a.MEGOLM_ALGORITHM,e.senderKey),r=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(a.MEGOLM_ALGORITHM,e.senderKey),c=this.baseApis.crypto.checkDeviceInfoTrust(o,r).isVerified();i[t].sessions[e.sessionId]={first_message_index:n.first_known_index,forwarded_count:s,is_verified:c,session_data:await this.algorithm.encryptSession(n)}}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:i}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),n=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(p.b.KeyBackupSessionsRemaining,n),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[d.a.STORE_INBOUND_GROUP_SESSIONS,d.a.STORE_BACKUP],e=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(e,t=>{null!==t&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([t],e)})});const e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(p.b.KeyBackupSessionsRemaining,e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}class f{constructor(e,t,n){this.authData=e,this.publicKey=t,this.getKey=n}static async init(t,n){if(!t||!("public_key"in t))throw new Error("auth_data missing required information");const i=new e.Olm.PkEncryption;return i.set_recipient_key(t.public_key),new f(t,i,n)}static async prepare(t){const n=new e.Olm.PkDecryption;try{const i={};if(t)if(t instanceof Uint8Array)i.public_key=n.init_with_private_key(t);else{const e=await Object(c.c)(t);i.private_key_salt=e.salt,i.private_key_iterations=e.iterations,i.public_key=n.init_with_private_key(e.key)}else i.public_key=n.generate_key();return(new e.Olm.PkEncryption).set_recipient_key(i.public_key),[n.get_private_key(),i]}finally{n.free()}}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(t){const n=await this.getKey(),i=new e.Olm.PkDecryption;try{if(i.init_with_private_key(n)!==this.authData.public_key)throw{errcode:o.c.RESTORE_BACKUP_ERROR_BAD_KEY};const e=[];for(const[n,s]of Object.entries(t))try{const t=JSON.parse(i.decrypt(s.session_data.ephemeral,s.session_data.mac,s.session_data.ciphertext));t.session_id=n,e.push(t)}catch(e){r.a.log("Failed to decrypt megolm session from backup",e,s)}return e}finally{i.free()}}async keyMatches(t){const n=new e.Olm.PkDecryption;let i;try{i=n.init_with_private_key(t)}finally{n.free()}return i===this.authData.public_key}free(){this.publicKey.free()}}s()(f,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");const v=new m.b(null,"org.matrix.msc3270.v1.aes-hmac-sha2");class b{constructor(e,t){this.authData=e,this.key=t}static async init(e,t){if(!e)throw new Error("auth_data missing");const n=await t();if(e.mac){const{mac:t}=await Object(h.a)(n,e.iv);if(e.mac.replace(/=+$/g,"")!==t.replace(/=+/g,""))throw new Error("Key does not match")}return new b(e,n)}static async prepare(e){let t;const n={};if(e)if(e instanceof Uint8Array)t=new Uint8Array(e);else{const i=await Object(c.c)(e);n.private_key_salt=i.salt,n.private_key_iterations=i.iterations,t=i.key}else t=function(e){var t;const n=Object(l.q)();if(n)return n.randomBytes(e);if(null!==(t=window)&&void 0!==t&&t.crypto){const t=new Uint8Array(e);return window.crypto.getRandomValues(t),t}throw new Error("No usable crypto implementation")}(32);const{iv:i,mac:s}=await Object(h.a)(t);return n.iv=i,n.mac=s,[t,n]}static checkBackupVersion(e){if(!("iv"in e.auth_data)||!("mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,Object(h.c)(JSON.stringify(t),this.key,e.session_id)}async decryptSessions(e){const t=[];for(const[n,i]of Object.entries(e))try{const e=JSON.parse(await Object(h.b)(i.session_data,this.key,n));e.session_id=n,t.push(e)}catch(e){r.a.log("Failed to decrypt megolm session from backup",e,i)}return t}async keyMatches(e){if(this.authData.mac){const{mac:t}=await Object(h.a)(e,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===t.replace(/=+/g,"")}return!0}free(){this.key.fill(0)}}s()(b,"algorithmName",v.name);const y={[f.algorithmName]:f,[b.algorithmName]:b},S=f}).call(this,n(30))},function(e,t,n){},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i=n(88),s=n.n(i),o=n(120),r=n(187),a=n(445),c=n(425),l=n(898),d=n.n(l);function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const m=window.localStorage;let p;try{p=window.indexedDB}catch(e){}function g(e){const t={useAuthorizationHeader:!0};return p&&m&&(t.store=new c.a({indexedDB:p,dbName:"riot-web-sync",localStorage:m,workerFactory:()=>new d.a})),m&&(t.sessionStore=new a.a(m)),p&&(t.cryptoStore=new r.a(p,"matrix-js-sdk:crypto")),Object(o.createClient)(h(h({},t),e))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(88),s=n.n(i);class o{get action(){return"NOT_USED"}constructor(e){s()(this,"fn",void 0),this.fn=e}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(188),s=n(93);class o extends i.a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super(),this.settingName=e,this.forcedValue=t,this.incompatibleValue=n}getValueOverride(e,t,n,i){return this.incompatibleSetting?this.forcedValue:null}get settingDisabled(){return this.incompatibleSetting}get incompatibleSetting(){return"function"==typeof this.incompatibleValue?this.incompatibleValue(s.b.getValue(this.settingName)):s.b.getValue(this.settingName)===this.incompatibleValue}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return l})),n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(192),s=n(89),o=n(126),r=n(93),a=n(109);const c=()=>{const e=r.b.getValue("MessageComposerInput.ctrlEnterToSend"),t={[a.h.SendMessage]:{default:{key:i.b.ENTER,ctrlOrCmdKey:e},displayName:Object(s.c)("Send message")},[a.h.NewLine]:{default:{key:i.b.ENTER,shiftKey:!e},displayName:Object(s.c)("New line")},[a.h.CompleteAutocomplete]:{default:{key:i.b.ENTER},displayName:Object(s.c)("Complete")},[a.h.ForceCompleteAutocomplete]:{default:{key:i.b.TAB},displayName:Object(s.c)("Force complete")},[a.h.SearchInRoom]:{default:{ctrlOrCmdKey:!0,key:i.b.F},displayName:Object(s.c)("Search (must be enabled)")}};return o.a.get().overrideBrowserShortcuts()&&(t[a.h.SwitchToSpaceByNumber]={default:{ctrlOrCmdKey:!0,key:a.e},displayName:Object(s.c)("Switch to space by number")}),t},l=()=>{const e=o.a.get().overrideBrowserShortcuts();return Object.keys(a.f).filter(t=>{var n,s;return(null===(n=a.f[t])||void 0===n||null===(s=n.controller)||void 0===s||!s.settingDisabled)&&(!(a.i.includes(t)&&!i.a)&&!(a.d.includes(t)&&!e))}).reduce((e,t)=>(e[t]=a.f[t],e),{})},d=()=>[...Object.entries(c()),...Object.entries(l())].reduce((e,t)=>{let[n,i]=t;return e[n]=i,e},{}),u=e=>{var t;return null===(t=d()[e])||void 0===t?void 0:t.default},h=e=>{var t;const n=null===(t=d()[e])||void 0===t?void 0:t.displayName;return n&&Object(s.a)(n)}},,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c}));var i=n(111),s=n(87),o=n.n(s),r=n(451);let a;function c(e){let{children:t}=e;const[n,c]=Object(s.useReducer)((e,t)=>{switch(t.type){case a.Add:return[t.value,...e];case a.Remove:return e.length&&Object(i.isEqual)(e[0],t.value)?e.slice(1):e}},[]);return o.a.createElement(r.a.Provider,{value:{state:n,dispatch:c}},t)}!function(e){e[e.Add=0]="Add",e[e.Remove=1]="Remove"}(a||(a={}))},function(e,t,n){"use strict";n.d(t,"c",(function(){return c})),n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return u}));var i=n(0),s=n(282),o=n(202),r=n(188),a=n(90);function c(){const e=new s.a(a.a.get()).getPushRuleById(".m.rule.master");return e?e.enabled&&!e.actions.includes(o.d.Notify):(i.a.warn("No master push rule! Notifications are disabled for this user."),!0)}function l(){let e=n(286);return e.default&&(e=e.default),e}class d extends r.a{getValueOverride(e,t,n,i){return!!l().isPossible()&&(null===n||"default"===i?!c():n)}onChange(e,t,n){l().supportsDesktopNotifications()&&l().setEnabled(n)}}class u extends r.a{getValueOverride(e,t,n){return!!l().isPossible()&&(null===n?!c():n)}}},,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return J}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(0),d=n(89),u=n(90),h=n(132),m=n(135),p=n(98),g=n(291),f=n(383),v=n(322),b=n(247),y=n(633),S=n(193),E=n(96),w=n(166),_=n(189),C=n(93),O=n(122),R=n(128),I=n(148),k=n(91),x=n(149),T=n(105),j=n(306),N=n(547),P=n(115),D=n(102),A=n(101),M=n(793),U=n(156),L=n(207),F=n(295),B=n(109),K=n(114),V=n(301),W=n(531),H=n(95),q=n(92);var $;!function(e){e.UserDirectory="users",e.DialPad="dialpad"}($||($={}));class G extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"onRemove",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRemove(this.props.member)})}render(){const e=this.props.member.isEmail?r.a.createElement("img",{className:"mx_InviteDialog_userTile_avatar mx_InviteDialog_userTile_threepidAvatar",src:n(794).default,width:20,height:20}):r.a.createElement(I.a,{className:"mx_InviteDialog_userTile_avatar",url:this.props.member.getMxcAvatarUrl()?Object(R.b)(this.props.member.getMxcAvatarUrl()).getSquareThumbnailHttp(20):null,name:this.props.member.name,idName:this.props.member.userId,width:20,height:20});let t;return this.props.onRemove&&(t=r.a.createElement(k.a,{className:"mx_InviteDialog_userTile_remove",onClick:this.onRemove},r.a.createElement("img",{src:n(1376).default,alt:Object(d.a)("Remove"),width:8,height:8}))),r.a.createElement("span",{className:"mx_InviteDialog_userTile"},r.a.createElement("span",{className:"mx_InviteDialog_userTile_pill"},e,r.a.createElement("span",{className:"mx_InviteDialog_userTile_name"},this.props.member.name)),t)}}class z extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onToggle(this.props.member)})}highlightName(e){if(!this.props.highlightWord)return e;const t=e.toLowerCase(),n=this.props.highlightWord.toLowerCase(),i=[];let s,o=0;for(;(s=t.indexOf(n,o))>=0;){s>o&&i.push(r.a.createElement("span",{key:o+"begin"},e.substring(o,s))),o=s;const t=e.substring(o,n.length+o);i.push(r.a.createElement("span",{className:"mx_InviteDialog_roomTile_highlight",key:o+"bold"},t)),o+=t.length}return o<e.length&&i.push(r.a.createElement("span",{key:o+"end"},e.substring(o))),i}render(){let e=null;if(this.props.lastActiveTs){const t=Object(y.a)(this.props.lastActiveTs);e=r.a.createElement("span",{className:"mx_InviteDialog_roomTile_time"},t)}const t=this.props.member.isEmail?r.a.createElement("img",{src:n(794).default,width:36,height:36}):r.a.createElement(I.a,{url:this.props.member.getMxcAvatarUrl()?Object(R.b)(this.props.member.getMxcAvatarUrl()).getSquareThumbnailHttp(36):null,name:this.props.member.name,idName:this.props.member.userId,width:36,height:36});let i=null;this.props.isSelected&&(i=r.a.createElement("div",{className:"mx_InviteDialog_roomTile_selected"}));const s=r.a.createElement("span",{className:"mx_InviteDialog_roomTile_avatarStack"},t,i),o=L.a.getDisplayUserIdentifier(this.props.member.userId,{withDisplayName:!0}),a=this.props.member.isEmail?Object(d.a)("Invite by email"):this.highlightName(o);return r.a.createElement("div",{className:"mx_InviteDialog_roomTile",onClick:this.onClick},s,r.a.createElement("span",{className:"mx_InviteDialog_roomTile_nameStack"},r.a.createElement("div",{className:"mx_InviteDialog_roomTile_name"},this.highlightName(this.props.member.name)),r.a.createElement("div",{className:"mx_InviteDialog_roomTile_userId"},a)),e)}}class J extends r.a.PureComponent{constructor(e){if(super(e),s()(this,"closeCopiedTooltip",void 0),s()(this,"debounceTimer",null),s()(this,"editorRef",Object(o.createRef)()),s()(this,"numberEntryFieldRef",Object(o.createRef)()),s()(this,"unmounted",!1),s()(this,"onConsultFirstChange",e=>{this.setState({consultFirst:e.target.checked})}),s()(this,"startDm",async()=>{this.setState({busy:!0});try{const e=u.a.get(),t=this.convertFilter();await Object(V.d)(e,t),this.props.onFinished(!0)}catch(e){l.a.error(e),this.setState({busy:!1,errorText:Object(d.a)("We couldn't create your DM.")})}finally{this.setState({busy:!1})}}),s()(this,"inviteUsers",async()=>{this.setState({busy:!0}),this.convertFilter();const e=this.convertFilter().map(e=>e.userId),t=u.a.get().getRoom(this.props.roomId);if(!t)return l.a.error("Failed to find the room to invite users to"),void this.setState({busy:!1,errorText:Object(d.a)("Something went wrong trying to invite the users.")});try{const n=await Object(S.a)(this.props.roomId,e,!0);this.shouldAbortAfterInviteError(n,t)||this.props.onFinished(!0)}catch(e){l.a.error(e),this.setState({busy:!1,errorText:Object(d.a)("We couldn't invite those users. Please check the users you want to invite and try again.")})}}),s()(this,"transferCall",async()=>{if(this.state.currentTabId==$.UserDirectory){this.convertFilter();const e=this.convertFilter().map(e=>e.userId);if(e.length>1)return void this.setState({errorText:Object(d.a)("A call can only be transferred to a single user.")});U.b.instance.startTransferToMatrixID(this.props.call,e[0],this.state.consultFirst)}else U.b.instance.startTransferToPhoneNumber(this.props.call,this.state.dialPadValue,this.state.consultFirst);this.props.onFinished(!0)}),s()(this,"onKeyDown",e=>{if(this.state.busy)return;let t=!1;const n=e.target.value.trim();switch(Object(K.a)().getAccessibilityAction(e)){case B.h.Backspace:if(n||this.state.targets.length<=0)break;this.removeMember(this.state.targets[this.state.targets.length-1]),t=!0;break;case B.h.Space:if(!n||!n.includes("@")||n.includes(" "))break;this.convertFilter(),t=!0;break;case B.h.Enter:if(!n)break;this.convertFilter(),t=!0}t&&e.preventDefault()}),s()(this,"onCancel",()=>{this.props.onFinished(!1)}),s()(this,"updateSuggestions",async e=>{if(u.a.get().searchUserDirectory({term:e}).then(async t=>{if(e===this.state.filterText){if(t.results||(t.results=[]),"@"===e[0]&&e.indexOf(":")>1)try{const n=await u.a.get().getProfileInfo(e);n&&t.results.splice(0,0,{user_id:e,display_name:n.displayname,avatar_url:n.avatar_url})}catch(n){l.a.warn("Non-fatal error trying to make an invite for a user ID"),l.a.warn(n),t.results.splice(0,0,{user_id:e,display_name:e,avatar_url:null})}this.setState({serverResultsMixin:t.results.map(e=>({userId:e.user_id,user:new V.a(e)}))})}}).catch(e=>{l.a.error("Error searching user directory:"),l.a.error(e),this.setState({serverResultsMixin:[]})}),this.state.canUseIdentityServer){if(e.indexOf("@")>0&&g.a(e)&&C.b.getValue(O.b.IdentityServer)){this.setState({threepidResultsMixin:[{user:new V.b(e),userId:e}]});try{const t=new b.a,n=await t.getAccessToken();if(e!==this.state.filterText)return;const i=await u.a.get().lookupThreePid("email",e,void 0,n);if(e!==this.state.filterText)return;if(!i||!i.mxid)return;const s=await u.a.get().getProfileInfo(i.mxid);if(e!==this.state.filterText||!s)return;this.setState({threepidResultsMixin:[...this.state.threepidResultsMixin,{user:new V.a({user_id:i.mxid,display_name:s.displayname,avatar_url:s.avatar_url}),userId:i.mxid}]})}catch(e){l.a.error("Error searching identity server:"),l.a.error(e),this.setState({threepidResultsMixin:[]})}}}else this.setState({tryingIdentityServer:!0})}),s()(this,"updateFilter",e=>{const t=e.target.value;this.setState({filterText:t}),this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.updateSuggestions(t)},150)}),s()(this,"showMoreRecents",()=>{this.setState({numRecentsShown:this.state.numRecentsShown+5})}),s()(this,"showMoreSuggestions",()=>{this.setState({numSuggestionsShown:this.state.numSuggestionsShown+5})}),s()(this,"toggleMember",e=>{if(!this.state.busy){let t=this.state.filterText,n=this.state.targets.map(e=>e);const i=n.indexOf(e);i>=0?n.splice(i,1):(this.props.kind===W.a&&n.length>0&&(n=[]),n.push(e),t=""),this.setState({targets:n,filterText:t}),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}}),s()(this,"removeMember",e=>{const t=this.state.targets.map(e=>e),n=t.indexOf(e);n>=0&&(t.splice(n,1),this.setState({targets:t})),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}),s()(this,"onPaste",async e=>{if(this.state.filterText)return;e.preventDefault();const t=e.clipboardData.getData("text"),n=[...this.state.recents,...this.state.suggestions,...this.state.serverResultsMixin,...this.state.threepidResultsMixin],i=[],s=[],o=t.split(/[\s,]+/).map(e=>e.trim()).filter(e=>!!e);for(const t of o){const o=n.find(e=>e.userId===t);if(o)i.push(o.user);else if(t.indexOf("@")>0&&g.a(t))i.push(new V.b(t));else if("@"===t[0])try{const e=await u.a.get().getProfileInfo(t),n=e?e.displayname:null,s=e?e.avatar_url:null;i.push(new V.a({user_id:t,display_name:n,avatar_url:s}))}catch(e){l.a.error("Error looking up profile for "+t),l.a.error(e),s.push(t)}else s.push(t)}this.unmounted||(s.length>0&&H.a.createTrackedDialog("Invite Paste Fail","",P.a,{title:Object(d.a)("Failed to find the following users"),description:Object(d.a)("The following users might not exist or are invalid, and cannot be invited: %(csvNames)s",{csvNames:s.join(", ")}),button:Object(d.a)("OK")}),this.setState({targets:[...this.state.targets,...i]}))}),s()(this,"onClickInputArea",e=>{e.preventDefault(),e.stopPropagation(),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}),s()(this,"onUseDefaultIdentityServerClick",e=>{e.preventDefault(),Object(f.d)(),this.setState({canUseIdentityServer:!0,tryingIdentityServer:!1})}),s()(this,"onManageSettingsClick",e=>{e.preventDefault(),q.a.fire(E.a.ViewUserSettings),this.props.onFinished(!1)}),s()(this,"onDialFormSubmit",e=>{e.preventDefault(),this.transferCall()}),s()(this,"onDialChange",e=>{this.setState({dialPadValue:e.currentTarget.value})}),s()(this,"onDigitPress",(e,t)=>{var n;(this.setState({dialPadValue:this.state.dialPadValue+e}),"click"===t.type)&&(null===(n=this.numberEntryFieldRef.current)||void 0===n||n.focus())}),s()(this,"onDeletePress",e=>{var t;0!==this.state.dialPadValue.length&&(this.setState({dialPadValue:this.state.dialPadValue.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))}),s()(this,"onTabChange",e=>{this.setState({currentTabId:e})}),e.kind===W.c&&!e.roomId)throw new Error("When using KIND_INVITE a roomId is required for an InviteDialog");if(e.kind===W.a&&!e.call)throw new Error("When using KIND_CALL_TRANSFER a call is required for an InviteDialog");const t=new Set([u.a.get().getUserId(),p.b.get("welcome_user_id")]);if(e.roomId){const n=u.a.get().getRoom(e.roomId);if(!n)throw new Error("Room ID given to InviteDialog does not look like a room");n.getMembersWithMembership("invite").forEach(e=>t.add(e.userId)),n.getMembersWithMembership("join").forEach(e=>t.add(e.userId)),n.getMembersWithMembership("ban").forEach(e=>t.add(e.userId))}this.state={targets:[],filterText:this.props.initialText,recents:J.buildRecents(t),numRecentsShown:3,suggestions:this.buildSuggestions(t),numSuggestionsShown:3,serverResultsMixin:[],threepidResultsMixin:[],canUseIdentityServer:!!u.a.get().getIdentityServerUrl(),tryingIdentityServer:!1,consultFirst:!1,dialPadValue:"",currentTabId:$.UserDirectory,busy:!1,errorText:null}}componentDidMount(){this.props.initialText&&this.updateSuggestions(this.props.initialText)}componentWillUnmount(){this.unmounted=!0,this.closeCopiedTooltip&&this.closeCopiedTooltip()}static buildRecents(e){const t=m.a.shared().getUniqueRoomsWithIndividuals(),n=_.b.instance.orderedLists[w.a.DM]||[],i=u.a.get().getUserId();for(const e of n){const n=e.getJoinedMembers().filter(e=>e.userId!==i);for(const i of n)t[i.userId]||(l.a.warn(`Adding DM room for ${i.userId} as ${e.roomId} from tag, not DM map`),t[i.userId]=e)}const s=[];for(const n in t){if(e.has(n)){l.a.warn(`[Invite:Recents] Excluding ${n} from recents`);continue}const i=t[n],o=i.getMember(n);if(!o){l.a.warn(`[Invite:Recents] ${n} is missing a member object in their own DM (${i.roomId})`);continue}const r=["m.room.message","m.room.encrypted","m.sticker"],a=20;let c=0;if(i.timeline&&i.timeline.length)for(let e=i.timeline.length-1;e>=0;e--){const t=i.timeline[e];if(r.includes(t.getType())){c=t.getTs();break}if(i.timeline.length-e>a)break}c?s.push({userId:n,user:o,lastActive:c}):l.a.warn(`[Invite:Recents] ${n} (${i.roomId}) has a weird last timestamp: ${c}`)}return s||l.a.warn("[Invite:Recents] No recents to suggest!"),s.sort((e,t)=>t.lastActive-e.lastActive),s}buildSuggestions(e){const t=u.a.get().getRooms().filter(e=>"join"===e.getMyMembership()&&e.getJoinedMemberCount()<=200).reduce((t,n)=>{if(m.a.shared().getUserIdForRoomId(n.roomId))return t;const i=n.getJoinedMembers().filter(t=>!e.has(t.userId));for(const s of i)e.has(s.userId)||(t[s.userId]||(t[s.userId]={member:s,pickedMemberRoomSize:n.getJoinedMemberCount(),rooms:[]}),t[s.userId].rooms.push(n),n.getJoinedMemberCount()<t[s.userId].pickedMemberRoomSize&&(t[s.userId].member=s,t[s.userId].pickedMemberRoomSize=n.getJoinedMemberCount()));return t},{}),n=Object.values(t).reduce((e,t)=>{const n=t.rooms.reduce((e,t)=>e+t.getJoinedMemberCount(),0),i=200*t.rooms.length;return e[t.member.userId]={member:t.member,numRooms:t.rooms.length,score:Math.max(0,Math.pow(1-n/i,5))},e},{}),i=u.a.get().getRooms().filter(e=>"join"===e.getMyMembership()),s=(new Date).getTime(),o=s-36e5,r={},a={};for(const t of i){const n=m.a.shared().getUserIdForRoomId(t.roomId);if(Object.keys(t.tags).includes("m.lowpriority")||n)continue;const i=t.getLiveTimeline().getEvents();for(let n=i.length-1;n>=Math.max(0,i.length-50);n--){const s=i[n];if(!e.has(s.getSender())){if(s.getTs()<=o)break;(!r[s.getSender()]||r[s.getSender()]<s.getTs())&&(r[s.getSender()]=s.getTs(),a[s.getSender()]=t.getMember(s.getSender()))}}}for(const e in r){const t=r[e],i=a[e];if(!i)continue;const c=s-o-Math.abs(s-t),l=Math.max(1,c/9e5);let d=n[e];d||(d=n[e]={score:0}),d.member=i,d.score+=l}const c=Object.values(n);return c.sort((e,t)=>e.score===t.score?e.numRooms===t.numRooms?Object(x.a)(e.member.userId,t.member.userId):t.numRooms-e.numRooms:t.score-e.score),c.map(e=>({userId:e.member.userId,user:e.member}))}shouldAbortAfterInviteError(e,t){this.setState({busy:!1});const n=new Map(this.state.targets.map(e=>[e.userId,e]));return!Object(S.d)(e.states,t,e.inviter,n)}convertFilter(){if(!this.state.filterText||!this.state.filterText.includes("@"))return this.state.targets||[];let e;this.state.filterText.startsWith("@")?e=new V.a({user_id:this.state.filterText,display_name:null,avatar_url:null}):C.b.getValue(O.b.IdentityServer)&&(e=new V.b(this.state.filterText));const t=[...this.state.targets||[],e];return this.setState({targets:t,filterText:""}),t}renderSection(e){let t="recents"===e?this.state.recents:this.state.suggestions,n="recents"===e?this.state.numRecentsShown:this.state.numSuggestionsShown;const i="recents"===e?this.showMoreRecents.bind(this):this.showMoreSuggestions.bind(this);let s="recents"===e?Object(d.a)("Recent Conversations"):Object(d.a)("Suggestions");this.props.kind===W.c&&(s="recents"===e?Object(d.a)("Recently Direct Messaged"):Object(d.a)("Suggestions"));let o=[],a=[];const c=this.state.serverResultsMixin||this.state.threepidResultsMixin;if(this.state.filterText&&c&&"suggestions"===e){const e=e=>!t.some(t=>t.userId===e.userId)&&!o.some(t=>t.userId===e.userId)&&!a.some(t=>t.userId===e.userId);a=this.state.serverResultsMixin.filter(e),o=this.state.threepidResultsMixin.filter(e)}const l=o.length>0||a.length>0;if(0===t.length&&!l)return null;if(this.state.filterText){const e=this.state.filterText.toLowerCase();if(t=t.filter(t=>t.user.name.toLowerCase().includes(e)||t.userId.toLowerCase().includes(e)),0===t.length&&!l)return r.a.createElement("div",{className:"mx_InviteDialog_section"},r.a.createElement("h3",null,s),r.a.createElement("p",null,Object(d.a)("No results")))}t=[...o,...t,...a],n===t.length-1&&n++;const u=t.slice(0,n);let h=null;u.length<t.length&&(h=r.a.createElement("div",{className:"mx_InviteDialog_section_showMore"},r.a.createElement(k.a,{onClick:i,kind:"link"},Object(d.a)("Show more"))));const m=u.map(t=>{return r.a.createElement(z,{member:t.user,lastActiveTs:(n=t,"recents"===e?n.lastActive:null),key:t.userId,onToggle:this.toggleMember,highlightWord:this.state.filterText,isSelected:this.state.targets.some(e=>e.userId===t.userId)});var n});return r.a.createElement("div",{className:"mx_InviteDialog_section"},r.a.createElement("h3",null,s),m,h)}renderEditor(){const e=this.props.kind==W.a&&0===this.state.targets.length&&0===this.state.filterText.length,t=this.state.targets.map(e=>r.a.createElement(G,{member:e,onRemove:!this.state.busy&&this.removeMember,key:e.userId})),n=r.a.createElement("input",{type:"text",onKeyDown:this.onKeyDown,onChange:this.updateFilter,value:this.state.filterText,ref:this.editorRef,onPaste:this.onPaste,autoFocus:!0,disabled:this.state.busy||this.props.kind==W.a&&this.state.targets.length>0,autoComplete:"off",placeholder:e?Object(d.a)("Search"):null});return r.a.createElement("div",{className:"mx_InviteDialog_editor",onClick:this.onClickInputArea},t,n)}renderIdentityServerWarning(){if(!this.state.tryingIdentityServer||this.state.canUseIdentityServer||!C.b.getValue(O.b.IdentityServer))return null;const e=Object(f.c)();return e?r.a.createElement("div",{className:"mx_InviteDialog_identityServer"},Object(d.a)("Use an identity server to invite by email. <default>Use the default (%(defaultIdentityServerName)s)</default> or manage in <settings>Settings</settings>.",{defaultIdentityServerName:Object(v.a)(e)},{default:e=>r.a.createElement(k.a,{kind:"link_inline",onClick:this.onUseDefaultIdentityServerClick},e),settings:e=>r.a.createElement(k.a,{kind:"link_inline",onClick:this.onManageSettingsClick},e)})):r.a.createElement("div",{className:"mx_InviteDialog_identityServer"},Object(d.a)("Use an identity server to invite by email. Manage in <settings>Settings</settings>.",{},{settings:e=>r.a.createElement(k.a,{kind:"link_inline",onClick:this.onManageSettingsClick},e)}))}async onLinkClick(e){e.preventDefault(),Object(x.e)(e.target)}get screenName(){switch(this.props.kind){case W.b:return"StartChat"}}render(){let e,t,i,s,o,a,m,p=null;this.state.busy&&(p=r.a.createElement(D.a,{w:20,h:20}));let g=r.a.createElement("span",null);const f=C.b.getValue(O.b.IdentityServer),v=this.state.targets.length>0||this.state.filterText&&this.state.filterText.includes("@"),b=u.a.get(),y=b.getUserId();if(this.props.kind===W.b){e=Object(d.a)("Direct Messages"),t=f?Object(d.a)("Start a conversation with someone using their name, email address or username (like <userId/>).",{},{userId:()=>r.a.createElement("a",{href:Object(h.g)(y),rel:"noreferrer noopener",target:"_blank"},y)}):Object(d.a)("Start a conversation with someone using their name or username (like <userId/>).",{},{userId:()=>r.a.createElement("a",{href:Object(h.g)(y),rel:"noreferrer noopener",target:"_blank"},y)}),i=Object(d.a)("Go"),s=this.startDm,a=r.a.createElement("div",{className:"mx_InviteDialog_section_hidden_suggestions_disclaimer"},r.a.createElement("span",null,Object(d.a)("Some suggestions may be hidden for privacy.")),r.a.createElement("p",null,Object(d.a)("If you can't see who you're looking for, send them your invite link below.")));const n=Object(h.g)(u.a.get().getUserId());m=r.a.createElement("div",{className:"mx_InviteDialog_footer"},r.a.createElement("h3",null,Object(d.a)("Or send invite link")),r.a.createElement(F.a,{getTextToCopy:()=>Object(h.g)(u.a.get().getUserId())},r.a.createElement("a",{href:n,onClick:this.onLinkClick},n)))}else if(this.props.kind===W.c){var S;const o=null===(S=u.a.get())||void 0===S?void 0:S.getRoom(this.props.roomId),a=null==o?void 0:o.isSpaceRoom();let c;if(e=a?Object(d.a)("Invite to %(spaceName)s",{spaceName:o.name||Object(d.a)("Unnamed Space")}):Object(d.a)("Invite to %(roomName)s",{roomName:o.name||Object(d.a)("Unnamed Room")}),c=a?f?Object(d.c)("Invite someone using their name, email address, username (like <userId/>) or <a>share this space</a>."):Object(d.c)("Invite someone using their name, username (like <userId/>) or <a>share this space</a>."):f?Object(d.c)("Invite someone using their name, email address, username (like <userId/>) or <a>share this room</a>."):Object(d.c)("Invite someone using their name, username (like <userId/>) or <a>share this room</a>."),t=Object(d.a)(c,{},{userId:()=>r.a.createElement("a",{href:Object(h.g)(y),rel:"noreferrer noopener",target:"_blank"},y),a:e=>r.a.createElement("a",{href:Object(h.f)(this.props.roomId),rel:"noreferrer noopener",target:"_blank"},e)}),i=Object(d.a)("Invite"),s=this.inviteUsers,b.isRoomEncrypted(this.props.roomId)){const e=b.getRoom(this.props.roomId).currentState.getStateEvents("m.room.history_visibility",""),t=e&&e.getContent()&&e.getContent().history_visibility;"world_readable"!==t&&"shared"!==t||(g=r.a.createElement("p",{className:"mx_InviteDialog_helpText"},r.a.createElement("img",{src:n(1377).default,width:14,height:14})," "+Object(d.a)("Invited people will be able to read old messages.")))}}else this.props.kind===W.a?(e=Object(d.a)("Transfer"),o=r.a.createElement("div",{className:"mx_InviteDialog_transferConsultConnect"},r.a.createElement("label",null,r.a.createElement("input",{type:"checkbox",checked:this.state.consultFirst,onChange:this.onConsultFirstChange}),Object(d.a)("Consult first")),r.a.createElement(k.a,{kind:"secondary",onClick:this.onCancel,className:"mx_InviteDialog_transferConsultConnect_pushRight"},Object(d.a)("Cancel")),r.a.createElement(k.a,{kind:"primary",onClick:this.transferCall,className:"mx_InviteDialog_transferButton",disabled:!v&&""===this.state.dialPadValue},Object(d.a)("Transfer")))):l.a.error("Unknown kind of InviteDialog: "+this.props.kind);const E=this.props.kind==W.a?null:r.a.createElement(k.a,{kind:"primary",onClick:s,className:"mx_InviteDialog_goButton",disabled:this.state.busy||!v},i),w=r.a.createElement(r.a.Fragment,null,r.a.createElement("p",{className:"mx_InviteDialog_helpText"},t),r.a.createElement("div",{className:"mx_InviteDialog_addressBar"},this.renderEditor(),r.a.createElement("div",{className:"mx_InviteDialog_buttonAndSpinner"},E,p)),g,this.renderIdentityServerWarning(),r.a.createElement("div",{className:"error"},this.state.errorText),r.a.createElement("div",{className:"mx_InviteDialog_userSections"},this.renderSection("recents"),this.renderSection("suggestions"),a),m);let _;if(this.props.kind===W.a){const e=[];e.push(new j.a($.UserDirectory,Object(d.c)("User Directory"),"mx_InviteDialog_userDirectoryIcon",w));const t=r.a.createElement(M.a,{onBackspacePress:this.onDeletePress});let n;n=0!==this.state.dialPadValue.length?r.a.createElement(T.a,{ref:this.numberEntryFieldRef,className:"mx_InviteDialog_dialPadField",id:"dialpad_number",value:this.state.dialPadValue,autoFocus:!0,onChange:this.onDialChange,postfixComponent:t}):r.a.createElement(T.a,{ref:this.numberEntryFieldRef,className:"mx_InviteDialog_dialPadField",id:"dialpad_number",value:this.state.dialPadValue,autoFocus:!0,onChange:this.onDialChange});const i=r.a.createElement("div",{className:"mx_InviteDialog_dialPad"},r.a.createElement("form",{onSubmit:this.onDialFormSubmit},n),r.a.createElement(N.a,{hasDial:!1,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress}));e.push(new j.a($.DialPad,Object(d.c)("Dial pad"),"mx_InviteDialog_dialPadIcon",i)),_=r.a.createElement(r.a.Fragment,null,r.a.createElement(j.c,{tabs:e,initialTabId:this.state.currentTabId,tabLocation:j.b.TOP,onChange:this.onTabChange}),o)}else _=r.a.createElement(r.a.Fragment,null,w,o);return r.a.createElement(A.a,{className:c()({mx_InviteDialog_transfer:this.props.kind===W.a,mx_InviteDialog_other:this.props.kind!==W.a,mx_InviteDialog_hasFooter:!!m}),hasCancel:!0,onFinished:this.props.onFinished,title:e,screenName:this.screenName},r.a.createElement("div",{className:"mx_InviteDialog_content"},_))}}s()(J,"defaultProps",{kind:W.b,initialText:""})},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(457);const s="https://matrix.to";class o extends i.b{constructor(){super()}forEvent(e,t,n){return`${s}/#/${e}/${t}${this.encodeServerCandidates(n)}`}forRoom(e,t){return`${s}/#/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${s}/#/${e}`}forGroup(e){return`${s}/#/${e}`}forEntity(e){return`${s}/#/${e}`}isPermalinkHost(e){return"matrix.to"===e}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(s))throw new Error("Does not appear to be a permalink");const t=e.substring((s+"/#/").length).split("/"),n=t[0];if("@"===n[0])return i.a.forUser(n);if("#"===n[0]||"!"===n[0]){if(1===t.length){const[e,t=""]=n.split("?"),s=t.split(/&?via=/g).filter(e=>!!e);return i.a.forRoom(e,s)}const e=t.length>1?t.slice(1).join("/"):"",[s,o=""]=e.split("?"),r=o.split(/&?via=/g).filter(e=>!!e);return i.a.forEvent(n,s,r)}if("+"===n[0])return i.a.forGroup(n);throw new Error("Unknown entity type in permalink")}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(89);function s(e){let t=Date.now()-e;const n=Math.abs(Math.ceil(t/6e4)),s=Math.ceil(n/60),o=Math.ceil(s/24);return t>=0?t<=15e3?Object(i.a)("a few seconds ago"):t<=75e3?Object(i.a)("about a minute ago"):n<=45?Object(i.a)("%(num)s minutes ago",{num:n}):n<=75?Object(i.a)("about an hour ago"):s<=23?Object(i.a)("%(num)s hours ago",{num:s}):s<=26?Object(i.a)("about a day ago"):Object(i.a)("%(num)s days ago",{num:o}):(t=Math.abs(t),t<=15e3?Object(i.a)("a few seconds from now"):t<=75e3?Object(i.a)("about a minute from now"):n<=45?Object(i.a)("%(num)s minutes from now",{num:n}):n<=75?Object(i.a)("about an hour from now"):s<=23?Object(i.a)("%(num)s hours from now",{num:s}):s<=26?Object(i.a)("about a day from now"):Object(i.a)("%(num)s days from now",{num:o}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(285);function s(e,t){const n=t.getUserId();for(const t of Object.keys(e.getContent())){if(Object.keys(e.getContent()[t][i.a.Read]||{}).includes(n))return!0;if(Object.keys(e.getContent()[t][i.a.ReadPrivate]||{}).includes(n))return!0}}},,,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d}));var i=n(97),s=n(90),o=n(327),r=n(198),a=n(93),c=n(172);function l(e){if(e.getSender()===s.a.get().credentials.userId)return!1;switch(e.getType()){case i.b.RoomMember:case i.b.RoomThirdPartyInvite:case i.b.CallAnswer:case i.b.CallHangup:case i.b.RoomAliases:case i.b.RoomCanonicalAlias:case i.b.RoomServerAcl:return!1}return!e.isRedacted()&&Object(r.c)(e,!1)}function d(e){const t=s.a.get().getUserId(),n=e.getEventReadUpTo(t);if(a.b.getValue("feature_thread")){if(c.a.instance.getThreadsRoomState(e).color>0)return!0}else if(e.timeline.length&&e.timeline[e.timeline.length-1].getSender()===t)return!1;const i=e.findEventById(n);if(null!=i&&i.getThread())return!1;for(let t=e.timeline.length-1;t>=0;--t){const i=e.timeline[t];if(i.getId()==n)return!1;if(!Object(o.a)(i)&&l(i))return!0}return!0}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(643),s=n.n(i),o=n(128),r=n(644);function a(e,t){return Object(o.a)({file:e}).downloadSource().then(e=>e.arrayBuffer()).then(t=>s.a.decryptAttachment(t,e)).then(e=>{let n=null!=t&&t.mimetype?t.mimetype.split(";")[0].trim():"";return n=Object(r.a)(n),new Blob([e],{type:n})})}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const i=["image/jpeg","image/gif","image/png","image/apng","image/webp","image/avif","video/mp4","video/webm","video/ogg","video/quicktime","audio/mp4","audio/webm","audio/aac","audio/mpeg","audio/ogg","audio/wave","audio/wav","audio/x-wav","audio/x-pn-wav","audio/flac","audio/x-flac"];function s(e){return i.includes(e)?e:"application/octet-stream"}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,,,function(e,t){},,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a);const l=["children","label"],d=e=>{let{children:t,label:n}=e,i=r()(e,l);return c.a.createElement("div",s()({},i,{role:"group","aria-label":n}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(134);const d=["children","label","tooltip"],u=e=>{let{children:t,label:n,tooltip:i}=e,o=r()(e,d);const a=o["aria-label"]||n;return i?c.a.createElement(l.b,s()({},o,{role:"menuitem","aria-label":a,title:i}),t):c.a.createElement(l.a,s()({},o,{role:"menuitem","aria-label":a}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(134);const d=["children","label","active","disabled"],u=e=>{let{children:t,label:n,active:i,disabled:o}=e,a=r()(e,d);return c.a.createElement(l.a,s()({},a,{role:"menuitemcheckbox","aria-checked":i,"aria-disabled":o,disabled:o,"aria-label":n}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(134);const d=["children","label","active","disabled"],u=e=>{let{children:t,label:n,active:i,disabled:o}=e,a=r()(e,d);return c.a.createElement(l.a,s()({},a,{role:"menuitemradio","aria-checked":i,"aria-disabled":o,disabled:o,"aria-label":n}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(134),d=n(141),u=n(109),h=n(114);const m=["children","label","onChange","onClose"],p=e=>{let{children:t,label:n,onChange:i,onClose:o}=e,a=r()(e,m);const[p,g,f]=Object(l.i)();return c.a.createElement(d.b,s()({},a,{role:"menuitemcheckbox","aria-label":n,onChange:i,onKeyDown:e=>{let t=!0;switch(Object(h.a)().getAccessibilityAction(e)){case u.h.Space:i();break;case u.h.Enter:i(),o();break;default:t=!1}t&&(e.stopPropagation(),e.preventDefault())},onKeyUp:e=>{switch(Object(h.a)().getAccessibilityAction(e)){case u.h.Space:case u.h.Enter:e.stopPropagation(),e.preventDefault()}},onFocus:p,inputRef:f,tabIndex:g?0:-1}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(134),d=n(220),u=n(109),h=n(114);const m=["children","label","onChange","onClose"],p=e=>{let{children:t,label:n,onChange:i,onClose:o}=e,a=r()(e,m);const[p,g,f]=Object(l.i)();return c.a.createElement(d.a,s()({},a,{role:"menuitemradio","aria-label":n,onChange:i,onKeyDown:e=>{let t=!0;switch(Object(h.a)().getAccessibilityAction(e)){case u.h.Space:i();break;case u.h.Enter:i(),o();break;default:t=!1}t&&(e.stopPropagation(),e.preventDefault())},onKeyUp:e=>{switch(Object(h.a)().getAccessibilityAction(e)){case u.h.Enter:case u.h.Space:e.stopPropagation(),e.preventDefault()}},onFocus:p,inputRef:f,tabIndex:g?0:-1}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return m}));var i=n(87),s=n.n(i),o=n(150),r=n.n(o),a=n(282),c=n(90),l=n(93),d=n(489),u=n(132);function h(e,t,n){const i=c.a.get().getRoom(t.getRoomId()),o=l.b.getValue("Pill.shouldShowPillAvatar");let m=e[0];for(;m;){let e=!1;if("PRE"!==m.tagName&&"CODE"!==m.tagName){if("A"===m.tagName&&m.getAttribute("href")){const t=m.getAttribute("href"),a=Object(u.h)(t);if(a&&!a.eventId){const a=document.createElement("span"),c=s.a.createElement(d.b,{url:t,inMessage:!0,room:i,shouldShowPillAvatar:o});r.a.render(c,a),m.parentNode.replaceChild(a,m),n.push(a),e=!0,m=a}}else if(m.nodeType===Node.TEXT_NODE&&!m.parentElement.classList.contains("mx_AtRoomPill")){let e=m;const l=[];for(;null!==e;){const t=d.b.roomNotifPos(e.textContent);let n=null;if(t>-1){let i=e;t>0&&(i=i.splitText(t)),i.textContent.length>d.b.roomNotifLen()&&(n=i.splitText(d.b.roomNotifLen())),l.push(i)}e=n}if(l.length>0){const e=new a.a(c.a.get()),u=e.getPushRuleById(".m.rule.roomnotif");if(u&&e.ruleMatchesEvent(u,t)){for(const e of l){m=e.nextSibling;const t=document.createElement("span"),a=s.a.createElement(d.b,{type:d.a.AtRoomMention,inMessage:!0,room:i,shouldShowPillAvatar:o});r.a.render(a,t),e.parentNode.replaceChild(t,e),n.push(t)}continue}}}m.childNodes&&m.childNodes.length&&!e&&h(m.childNodes,t,n),m=m.nextSibling}else m=m.nextSibling}}function m(e){for(const t of e)r.a.unmountComponentAtNode(t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(87),s=n.n(i);function o(e,t){const n=[];return e.forEach((i,s)=>{n.push(i,s===e.length-1?null:t)}),s.a.createElement("span",null,n)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i="im.vector.room.read_pins"},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o);class a{constructor(e,t,n){this.topCount=e,this.renderCount=t,this.bottomCount=n}contains(e){return!(!e.renderCount&&this.renderCount)&&(e.topCount>=this.topCount&&e.topCount+e.renderCount<=this.topCount+this.renderCount)}expand(e){if(0===this.renderCount)return this;const t=Math.min(e,this.topCount),n=Math.min(e,this.bottomCount);return new a(this.topCount-t,this.renderCount+t+n,this.bottomCount-n)}totalSize(){return this.topCount+this.renderCount+this.bottomCount}}class c extends r.a.Component{constructor(e){super(e),this.state={renderRange:null}}static getDerivedStateFromProps(e,t){const n=c.getVisibleRangeFromProps(e),i=n.expand(e.overflowMargin),s=n.expand(e.overflowItems);return!(!!t.renderRange&&s.totalSize()!==t.renderRange.totalSize())&&t.renderRange&&t.renderRange.contains(i)?null:{renderRange:s}}static getVisibleRangeFromProps(e){const{items:t,itemHeight:n,scrollTop:i,height:s}=e,o=t?t.length:0,r=Math.min(Math.max(0,Math.floor(i/n)),o),c=o-r,l=0!==s?Math.ceil(s/n):0,d=Math.min(l,c);return new a(r,d,c-d)}render(){const{itemHeight:e,items:t,renderItem:n}=this.props,{renderRange:i}=this.state,{topCount:s,renderCount:o,bottomCount:a}=i,c=s*e,l=a*e,d=(t||[]).slice(s,s+o),u=this.props.element||"div",h={style:{paddingTop:c+"px",paddingBottom:l+"px"},className:this.props.className};return r.a.createElement(u,h,d.map(n))}}s()(c,"defaultProps",{overflowItems:20,overflowMargin:5})},,function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(105),c=n(89),l=n(101),d=n(110);class u extends r.a.Component{constructor(e){super(e),s()(this,"field",Object(o.createRef)()),s()(this,"onOk",async e=>{if(e.preventDefault(),this.props.validator&&(this.setState({busy:!0}),await this.field.current.validate({allowEmpty:!1}),!this.field.current.state.valid))return this.field.current.focus(),this.field.current.validate({allowEmpty:!1,focused:!0}),void this.setState({busy:!1});this.props.onFinished(!0,this.state.value)}),s()(this,"onCancel",()=>{this.props.onFinished(!1)}),s()(this,"onChange",e=>{this.setState({value:e.target.value})}),s()(this,"onValidate",async e=>{const t=await this.props.validator(e);return this.setState({valid:t.valid}),t}),this.state={value:this.props.value,busy:!1,valid:!1}}componentDidMount(){this.props.focus&&this.field.current.focus()}render(){return r.a.createElement(l.a,{className:"mx_TextInputDialog",onFinished:this.props.onFinished,title:this.props.title,fixedWidth:this.props.fixedWidth},r.a.createElement("form",{onSubmit:this.onOk},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_TextInputDialog_label"},r.a.createElement("label",{htmlFor:"textinput"}," ",this.props.description," ")),r.a.createElement("div",null,r.a.createElement(a.a,{className:"mx_TextInputDialog_input",ref:this.field,type:"text",label:this.props.placeholder,value:this.state.value,onChange:this.onChange,onValidate:this.props.validator?this.onValidate:void 0})))),r.a.createElement(d.a,{primaryButton:this.state.busy?Object(c.a)(this.props.busyMessage):this.props.button,disabled:this.state.busy,onPrimaryButtonClick:this.onOk,onCancel:this.onCancel,hasCancel:this.props.hasCancel}))}}s()(u,"defaultProps",{title:"",value:"",description:"",busyMessage:Object(c.c)("Loading..."),focus:!0,hasCancel:!0})},function(e,t,n){"use strict";var i=n(88),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n(1235),l=n(94),d=n.n(l),u=n(89),h=n(102);const m=["data","className"];function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const f={errorCorrectionLevel:"L"};t.a=e=>{let{data:t,className:n}=e,i=r()(e,m);const[s,o]=a.useState(null);return a.useEffect(()=>{let e=!1;return Object(c.toDataURL)(t,g(g({},f),i)).then(t=>{e||o(t)}),()=>{e=!0}},[JSON.stringify(t),i]),a.createElement("div",{className:d()("mx_QRCode",n)},s?a.createElement("img",{src:s,className:"mx_VerificationQRCode",alt:Object(u.a)("QR Code")}):a.createElement(h.a,null))}},,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(87),s=n.n(i),o=n(133);class r extends s.a.Component{render(){const e=new Date(this.props.ts);let t;return t=this.props.showRelative?Object(o.i)(e,this.props.showTwelveHour):this.props.showFullDate?Object(o.d)(e,this.props.showTwelveHour,this.props.showSeconds):this.props.showSeconds?Object(o.h)(e,this.props.showTwelveHour):Object(o.k)(e,this.props.showTwelveHour),s.a.createElement("span",{className:"mx_MessageTimestamp",title:Object(o.d)(e,this.props.showTwelveHour),"aria-hidden":!0},t)}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return d}));var i=n(88),s=n.n(i),o=n(97),r=n(712),a=n(326),c=n(89);let l;!function(e){e[e.NotificationVolume=0]="NotificationVolume"}(l||(l={}));class d extends r.a{constructor(e){super(e,e=>this.properties.get(e)),s()(this,"properties",new Map),s()(this,"onAccountData",e=>{if(e.getType()===o.b.PushRules){this.properties.get(l.NotificationVolume)!==Object(a.b)(this.context.room.roomId)&&this.updateNotificationVolume()}})}onClientChanged(e,t){this.properties.clear(),e&&e.removeListener("accountData",this.onAccountData),t&&(t.on("accountData",this.onAccountData),this.updateNotificationVolume())}updateNotificationVolume(){this.properties.set(l.NotificationVolume,Object(a.b)(this.context.room.roomId)),this.markEchoReceived(l.NotificationVolume),this.emit(r.b,l.NotificationVolume)}get notificationVolume(){return this.getValue(l.NotificationVolume)}set notificationVolume(e){this.setValue(Object(c.a)("Change notification settings"),l.NotificationVolume,e,async()=>Object(a.d)(this.context.room.roomId,e),r.c)}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return a})),n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(8),r=n(507);async function a(){}const c="property_updated";class l extends o.EventEmitter{constructor(e,t){super(),this.context=e,this.lookupFn=t,s()(this,"cache",new Map),s()(this,"matrixClient",void 0)}setClient(e){const t=this.matrixClient;this.matrixClient=e,this.onClientChanged(t,e)}getValue(e){return this.cache.has(e)?this.cache.get(e).val:this.lookupFn(e)}cacheVal(e,t,n){this.cache.set(e,{txn:n,val:t}),this.emit(c,e)}decacheKey(e){this.cache.has(e)&&(this.context.disownTransaction(this.cache.get(e).txn),this.cache.delete(e),this.emit(c,e))}markEchoReceived(e){if(this.cache.has(e)){const t=this.cache.get(e).txn;this.context.disownTransaction(t),t.cancel()}this.decacheKey(e)}setValue(e,t,n,i,s){this.cache.has(t)&&this.cache.get(t).txn.cancel();const o=this.context.beginTransaction(e,i);this.cacheVal(t,n,o),o.when(r.b.Pending,()=>this.cacheVal(t,n,o)).when(r.b.Error,()=>s()),o.run()}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(0),r=n(121);class a{constructor(){s()(this,"listeners",[])}when(e,t){return this.listeners.push({condition:e,fn:t}),this}whenAnyOf(e,t){for(const n of e)this.when(n,t);return this}whenAnything(e){return this.listeners.push({condition:null,fn:e}),this}notifyCondition(e){const t=Object(r.b)(this.listeners);for(const n of t)if(null===n.condition||n.condition===e)try{n.fn(this)}catch(t){o.a.error(`Error calling whenable listener for ${e}:`,t)}}destroy(){this.listeners=[]}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(8),r=n.n(o),a=n(123);class c extends r.a{constructor(){super(...arguments),s()(this,"toasts",new Map)}static get instance(){return c._instance||(c._instance=new c),c._instance}get components(){return Array.from(this.toasts.values())}addToast(e){const t=Symbol();return this.toasts.set(t,e),this.emit(a.b),t}removeToast(e){this.toasts.delete(e),this.emit(a.b)}}s()(c,"_instance",void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(716);class s{constructor(e,t){this.index=e,this.offset=t}compare(e){return this.index===e.index?this.offset-e.offset:this.index-e.index}iteratePartsBetween(e,t,n){if(-1===this.index||-1===e.index)return;const[i,s]=this.compare(e)<0?[this,e]:[e,this];if(i.index===s.index)n(t.parts[this.index],i.offset,s.offset);else{const e=t.parts[i.index];n(e,i.offset,e.text.length);for(let e=i.index+1;e<s.index;++e){const i=t.parts[e];n(i,0,i.text.length)}n(t.parts[s.index],0,s.offset)}}forwardsWhile(e,t){if(-1===this.index)return this;let{index:n,offset:i}=this;const{parts:o}=e;for(;n<o.length;){const e=o[n];for(;i<e.text.length;){if(!t(n,i,e))return new s(n,i);i+=1}if(n===o.length-1)return new s(n,i);n+=1,i=0}}backwardsWhile(e,t){if(-1===this.index)return this;let{index:n,offset:i}=this;const o=e.parts;for(;n>=0;){const e=o[n];for(;i>0;){if(!t(n,i-1,e))return new s(n,i);i-=1}if(0===n)return new s(n,i);n-=1,i=o[n].text.length}}asOffset(e){if(-1===this.index)return new i.a(0,!0);let t=0;for(let n=0;n<this.index;++n)t+=e.parts[n].text.length;t+=this.offset;const n=e.parts[this.index],s=!n||t>=n.text.length;return new i.a(t,s)}isAtEnd(e){if(0===e.parts.length)return!0;const t=e.parts.length-1,n=e.parts[t];return this.index===t&&this.offset===n.text.length}isAtStart(){return 0===this.index&&0===this.offset}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{constructor(e,t){this.offset=e,this.atNodeEnd=t}asPosition(e){return e.positionForOffset(this.offset,this.atNodeEnd)}add(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new i(this.offset+e,t)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return a}));var i=n(509),s=n(716);function o(e,t){const{offset:n,text:i}=r(e,t.focusNode,t.focusOffset);return{caret:n,text:i}}function r(e,t,n){const{node:o,characterOffset:r}=function(e,t){for(;e&&e.nodeType===Node.ELEMENT_NODE;){const n=e.childNodes.length;if(!n)break;t>=n?t=(e=e.lastChild).nodeType===Node.TEXT_NODE?e.textContent.length:Number.MAX_SAFE_INTEGER:(e=e.childNodes[t],t=0)}return{node:e,characterOffset:t}}(t,n),{text:a,offsetToNode:c}=function(e,t){let n=0,s=!1,o="";function r(e){s||e===t&&(s=!0),"BR"===e.tagName&&e.nextSibling&&(s||(n+=1),o+="\n");const r=e.nodeType===Node.TEXT_NODE&&function(e){const t=e.nodeValue;return Object(i.b)(e.parentElement)?1!==t.length?t.replace(i.a,""):"":t}(e);return r&&(s||(n+=r.length),o+=r),!0}function a(e){var t;"DIV"===e.tagName&&"DIV"===(null===(t=e.nextSibling)||void 0===t?void 0:t.tagName)&&(o+="\n",s||(n+=1))}return function(e,t,n){let i=e.firstChild;for(;i&&i!==e;){if(t(i)&&i.firstChild)i=i.firstChild;else if(i.nextSibling)i=i.nextSibling;else{for(;!i.nextSibling&&i!==e;)i=i.parentElement,i!==e&&n(i);i!==e&&(i=i.nextSibling)}}}(e,r,a),{text:o,offsetToNode:n}}(e,o);return{offset:function(e,t,n){if(!e)return new s.a(0,!1);let o=n===e.textContent.length;if(e.nodeType===Node.TEXT_NODE&&Object(i.b)(e.parentElement)){const t=e.nodeValue.indexOf(i.a);-1!==t&&t<n&&(n-=1),o=!0}return new s.a(t+n,o)}(o,c,r),text:a}}function a(e,t,n){const i=r(e,n.focusNode,n.focusOffset).offset,s=r(e,n.anchorNode,n.anchorOffset).offset,o=i.asPosition(t),a=s.asPosition(t);return t.startRange(o,a)}},function(e,t,n){"use strict";n.d(t,"b",(function(){return p})),n.d(t,"f",(function(){return g})),n.d(t,"a",(function(){return f})),n.d(t,"c",(function(){return v})),n.d(t,"d",(function(){return b})),n.d(t,"e",(function(){return y})),n.d(t,"g",(function(){return S}));var i=n(472),s=n(645),o=n.n(s),r=n(670),a=n.n(r),c=n(719),l=n(132),d=n(93),u=n(98),h=n(223);function m(e){return e.parts.reduce((e,t)=>{switch(t.type){case h.b.Newline:return e+"\n";case h.b.Plain:case h.b.Emoji:case h.b.Command:case h.b.PillCandidate:case h.b.AtRoomPill:return e+t.text;case h.b.RoomPill:return e+`[${t.resourceId.replace(/[[\\\]]/g,e=>"\\"+e)}](${Object(l.e)(t.resourceId)})`;case h.b.UserPill:return e+`[${t.text.replace(/[[\\\]]/g,e=>"\\"+e)}](${Object(l.e)(t.resourceId)})`}},"")}function p(e){let{forceHTML:t=!1,useMarkdown:n=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!n)return a()(g(e)).replace(/\n/g,"<br/>");let s=m(e);const r=s;if(d.b.getValue("feature_latex_maths")){const e=["display","inline"],t={tex:{display:"(^)\\$\\$(([^$]|\\\\\\$)+?)\\$\\$$",inline:"(^|\\s|[.,!?:;])(?!\\\\)\\$(?!\\s)(([^$\\n]|\\\\\\$)*([^\\\\\\s\\$]|\\\\\\$)(?:\\\\\\$)?)\\$"},latex:{display:"(^)\\\\\\[(?!\\\\\\])(.*?)\\\\\\]$",inline:"(^|[^\\\\])\\\\\\((?!\\\\\\))(.*?)\\\\\\)"}};["tex","latex"].forEach((function(n){e.forEach((function(e){const o=(((u.b.get("latex_maths_delims")||{})[e]||{}).pattern||{})[n]||t[n][e];s=s.replace(RegExp(o,"gms"),(function(t,n,s){const o=i.AllHtmlEntities.encode(s);switch(e){case"display":return`${n}<div data-mx-maths="${o}">\n\n</div>\n\n`;case"inline":return`${n}<span data-mx-maths="${o}"></span>`}}))}))})),s=s.replace(/(.)<div/g,(function(e,t){return t+"\n<div"}))}const l=new c.a(s);if(!l.isPlainText()||t){const e=o.a.load(l.toHTML(),{_useHtmlParser2:!0,decodeEntities:!1});if(d.b.getValue("feature_latex_maths")){const t=new c.a(r),n=o.a.load(t.toHTML(),{_useHtmlParser2:!0,decodeEntities:!1});n("code").each((function(t){e("code").eq(t).text(n("code").eq(t).text())})),e("div, span").each((function(t,n){const i=e(n).attr("data-mx-maths");i&&e(n).html(`<code>${i}</code>`)}))}return e.html()}return s.indexOf("\\")>-1?l.toPlaintext():void 0}function g(e){return e.parts.reduce((e,t)=>{switch(t.type){case h.b.Newline:return e+"\n";case h.b.Plain:case h.b.Emoji:case h.b.Command:case h.b.PillCandidate:case h.b.AtRoomPill:return e+t.text;case h.b.RoomPill:return e+""+t.resourceId;case h.b.UserPill:return e+""+t.text}},"")}function f(e){var t,n;const i=v(e,"/me ",!1),s=(null===(t=e.parts[0])||void 0===t||null===(n=t.text)||void 0===n?void 0:n.length)>4||e.parts.length>1;return i&&s}function v(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=e.parts[0];let s=(null==i?void 0:i.text)||"";return n||(t=t.toLowerCase(),s=s.toLowerCase()),i&&(i.type===h.b.Plain||i.type===h.b.Command)&&s.startsWith(t)}function b(e){return y(e,"/me ")}function y(e,t){return(e=e.clone()).removeText({index:0,offset:0},t.length),e}function S(e){const{parts:t}=e;if(t.length){const n=t[0];n.type===h.b.Plain&&n.text.startsWith("\\/")&&(e=e.clone()).removeText({index:0,offset:0},1)}return e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i=n(88),s=n.n(i),o=n(1266),r=n(111),a=n(0),c=n(358);const l=["sub","sup","del","u"],d=["text","softbreak","linebreak","paragraph","document"];function u(e){if(null!=e.literal&&null!=e.literal.match('^<((div|span) data-mx-maths="[^"]*"|/(div|span))>$'))return!0;const t=/^<\/?(.*)>$/.exec(e.literal);if(t&&2==t.length){const e=t[1];return l.indexOf(e)>-1}return!1}function h(e){let t=e;for(;t.parent;)t=t.parent;return t.firstChild!=t.lastChild}function m(e){let t=e,n="";for(;null!==t&&"softbreak"!==t.type&&"linebreak"!==t.type;){const{literal:e,type:i}=t;if("text"===i&&e){let t=0,i=e[t];for(;" "!==i&&null!==i&&t<=e.length&&" "!==i;)i&&(n+=i),t+=1,i=e[t];if(" "===i)break}t=t.next}return n}const p={emph:"_",strong:"__"};class g{constructor(e){s()(this,"input",void 0),s()(this,"parsed",void 0),this.input=e;const t=new o.Parser;this.parsed=t.parse(this.input),this.parsed=this.repairLinks(this.parsed)}repairLinks(e){const t=e.walker();let n=null,i="",s=!1,r=null,l=!1;for(;n=t.next();){const{node:e}=n;if("paragraph"===e.type&&(s=!!n.entering),s){if("softbreak"===e.type||"linebreak"===e.type||"text"===e.type&&" "===e.literal){i="";continue}if("text"===e.type){const[n,...s]=e.literal.split(/( )/);e.literal=n,i+=n,s.reverse().forEach(n=>{if(n){const i=new o.Node("text");i.literal=n,e.insertAfter(i),t.resumeAt(i,!0)}})}if(("emph"===e.type||"strong"===e.type)&&"text"===r.type)if(n.entering){const t=c.d.find(i);for(const{value:s}of t)if(e.firstChild.literal){const t=p[e.type],d=`${t}${e.firstChild.literal}${t}`,u=s+d+m(e);if(1===c.d.find(u).length){const t=new o.Node("text");t.literal=d,r.insertAfter(t),e.firstChild.literal="",n=e.walker().next(),e.unlink(),r.insertAfter(n.node),l=!0}else a.a.error("Markdown links escaping found too many links for following text: ",i),a.a.error("Markdown links escaping found too many links for modified text: ",u)}}else l&&(e.unlink(),l=!1)}r=e}return e}isPlainText(){const e=this.parsed.walker();let t;for(;t=e.next();){const e=t.node;if(!(d.indexOf(e.type)>-1)){if("html_inline"!=e.type&&"html_block"!=e.type)return!1;if(u(e))return!1}}return!0}toHTML(){let{externalLinks:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=new o.HtmlRenderer({safe:!1,softbreak:"<br />"}),n=t.paragraph;return t.paragraph=function(e,t){("block_quote"===e.parent.type||h(e))&&n.call(this,e,t)},t.link=function(t,n){const i=this.attrs(t);n?(i.push(["href",this.esc(t.destination)]),t.title&&i.push(["title",this.esc(t.title)]),e&&(i.push(["target","_blank"]),i.push(["rel","noreferrer noopener"])),this.tag("a",i)):this.tag("/a")},t.html_inline=function(e){u(e)?this.lit(e.literal):this.lit(Object(r.escape)(e.literal))},t.html_block=function(e){t.html_inline(e)},t.render(this.parsed)}toPlaintext(){const e=new o.HtmlRenderer({safe:!1});return e.paragraph=function(e,t){h(e)&&!t&&e.next&&this.lit("\n\n")},e.html_block=function(e){this.lit(e.literal),h(e)&&e.next&&this.lit("\n\n")},e.render(this.parsed)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(111);function s(e){const t=2*Math.PI/e.length;return Object(i.split)(e,"").map((e,n)=>{if(" "===e)return e;const[i,s]=function(e,t){const n=127*t*Math.cos(e),i=127*t*Math.sin(e);return[n,i]}(n*t,1),[a,c,l]=function(e,t,n){let i=(e+16)/116;const s=.9505*o(i+t/500),a=1.089*o(i-n/200);i=o(i);const c=-.96924364*s+1.8759675*i+.04155506*a,l=.05563008*s-.20397696*i+1.05697151*a;return[r(3.24096994*s-1.53738318*i-.49861076*a),r(c),r(l)]}(75,i,s);return'<font color="#'+a.toString(16).padStart(2,"0")+c.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")+'">'+e+"</font>"}).join("")}function o(e){return e>.2069?Math.pow(e,3):.1284*e-.01771}function r(e){const t=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055}(e),n=Math.min(Math.max(t,0),1);return Math.round(255*n)}},,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i="im.vector.is_virtual_room"},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(125),r=n(263);t.a=e=>{let{label:t,labelInvite:n,labelPublic:i,labelRestricted:a,value:c,width:l=448,onChange:d}=e;const u=[s.a.createElement("div",{key:o.c.Invite,className:"mx_JoinRuleDropdown_invite"},n),s.a.createElement("div",{key:o.c.Public,className:"mx_JoinRuleDropdown_public"},i)];return a&&u.unshift(s.a.createElement("div",{key:o.c.Restricted,className:"mx_JoinRuleDropdown_restricted"},a)),s.a.createElement(r.a,{id:"mx_JoinRuleDropdown",className:"mx_JoinRuleDropdown",onOptionChange:d,menuWidth:l,value:c,label:t},u)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i extends Error{constructor(e,t){super(e),this.message=e,this.description=t}}},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(7),r=n(89),a=n(91),c=n(149),l=n(132),d=n(193),u=n(90),h=n(185),m=n(122);t.a=e=>{var t;let{space:n,onFinished:p}=e;const[g,f]=Object(i.useState)(Object(r.a)("Click to copy"));return s.a.createElement("div",{className:"mx_SpacePublicShare"},s.a.createElement(a.a,{className:"mx_SpacePublicShare_shareButton",onClick:async()=>{const e=new l.a(n);e.load();const t=await Object(c.c)(e.forShareableRoom())?Object(r.a)("Copied!"):Object(r.a)("Failed to copy");f(t),await Object(o.G)(5e3),g===t&&f(Object(r.a)("Click to copy"))}},s.a.createElement("h3",null,Object(r.a)("Share invite link")),s.a.createElement("span",null,g)),n.canInvite(null===(t=u.a.get())||void 0===t?void 0:t.getUserId())&&Object(h.a)(m.a.InviteUsers)?s.a.createElement(a.a,{className:"mx_SpacePublicShare_inviteButton",onClick:()=>{p&&p(),Object(d.e)(n.roomId)}},s.a.createElement("h3",null,Object(r.a)("Invite people")),s.a.createElement("span",null,Object(r.a)("Invite with email or username"))):null)}},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(115),r=n(89),a=n(105),c=n(98),l=n(338),d=n(141),u=n(95),h=n(212);t.a=e=>{let{title:t,subheading:n,children:m,rageshakeLabel:p,rageshakeData:g={},onFinished:f}=e;const[v,b]=Object(i.useState)(""),[y,S]=Object(i.useState)(!1);return s.a.createElement(o.a,{className:"mx_GenericFeatureFeedbackDialog",hasCancelButton:!0,title:t,description:s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"mx_GenericFeatureFeedbackDialog_subheading"},n," ",Object(r.a)("Your platform and username will be noted to help us use your feedback as much as we can.")," ",m),s.a.createElement(a.a,{id:"feedbackComment",label:Object(r.a)("Feedback"),type:"text",autoComplete:"off",value:v,element:"textarea",onChange:e=>{b(e.target.value)},autoFocus:!0}),s.a.createElement(d.b,{checked:y,onChange:e=>S(e.target.checked)},Object(r.a)("You may contact me if you have any follow up questions"))),button:Object(r.a)("Send feedback"),buttonDisabled:!v,onFinished:async e=>{if(!e)return f(!1);Object(l.c)(c.b.get().bug_report_endpoint_url,p,v,y,g),f(!0),u.a.createTrackedDialog("Feedback Sent",p,h.a,{title:t,description:Object(r.a)("Feedback sent! Thanks, we appreciate it!"),button:Object(r.a)("Close"),hasCloseButton:!1,fixedWidth:!1})}})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(87),s=n.n(i),o=n(89),r=n(91),a=n(105),c=n(248);const l=e=>{let{avatarUrl:t,avatarDisabled:n=!1,setAvatar:a}=e;const l=Object(i.useRef)(),[d,u]=Object(i.useState)(t);let h;return h=n?d?s.a.createElement("img",{className:"mx_SpaceBasicSettings_avatar",src:d,alt:""}):s.a.createElement("div",{className:"mx_SpaceBasicSettings_avatar"}):d?s.a.createElement(s.a.Fragment,null,s.a.createElement(r.a,{className:"mx_SpaceBasicSettings_avatar",onClick:()=>{var e;return null===(e=l.current)||void 0===e?void 0:e.click()},element:"img",src:d,alt:""}),s.a.createElement(r.a,{onClick:()=>{l.current.value="",u(void 0),a(void 0)},kind:"link",className:"mx_SpaceBasicSettings_avatar_remove","aria-label":Object(o.a)("Delete avatar")},Object(o.a)("Delete"))):s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"mx_SpaceBasicSettings_avatar",onClick:()=>{var e;return null===(e=l.current)||void 0===e?void 0:e.click()}}),s.a.createElement(r.a,{onClick:()=>{var e;return null===(e=l.current)||void 0===e?void 0:e.click()},kind:"link","aria-label":Object(o.a)("Upload avatar")},Object(o.a)("Upload"))),s.a.createElement("div",{className:"mx_SpaceBasicSettings_avatarContainer"},h,s.a.createElement("input",{type:"file",ref:l,onClick:c.a,onChange:e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;const n=e.target.files[0];a(n);const i=new FileReader;i.onload=e=>{u(e.target.result)},i.readAsDataURL(n)},accept:"image/*"}))};t.b=e=>{let{avatarUrl:t,avatarDisabled:n=!1,setAvatar:i,name:r="",nameDisabled:c=!1,setName:d,topic:u="",topicDisabled:h=!1,setTopic:m}=e;return s.a.createElement("div",{className:"mx_SpaceBasicSettings"},s.a.createElement(l,{avatarUrl:t,avatarDisabled:n,setAvatar:i}),s.a.createElement(a.a,{name:"spaceName",label:Object(o.a)("Name"),autoFocus:!0,value:r,onChange:e=>d(e.target.value),disabled:c}),s.a.createElement(a.a,{name:"spaceTopic",element:"textarea",label:Object(o.a)("Description"),value:u,onChange:e=>m(e.target.value),rows:3,disabled:h}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(335),c=n.n(a),l=n(89),d=n(644),u=n(101),h=n(110);class m extends r.a.Component{constructor(e){super(e),s()(this,"objectUrl",void 0),s()(this,"mimeType",void 0),s()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),s()(this,"onUploadClick",()=>{this.props.onFinished(!0)}),s()(this,"onUploadAllClick",()=>{this.props.onFinished(!0,!0)}),this.mimeType=Object(d.a)(e.file.type);const t=new Blob([e.file],{type:this.mimeType});this.objectUrl=URL.createObjectURL(t)}componentWillUnmount(){this.objectUrl&&URL.revokeObjectURL(this.objectUrl)}render(){let e,t,i,s;return e=this.props.totalFiles>1&&void 0!==this.props.currentIndex?Object(l.a)("Upload files (%(current)s of %(total)s)",{current:this.props.currentIndex+1,total:this.props.totalFiles}):Object(l.a)("Upload files"),this.mimeType.startsWith("image/")?t=r.a.createElement("img",{className:"mx_UploadConfirmDialog_imagePreview",src:this.objectUrl}):this.mimeType.startsWith("video/")?t=r.a.createElement("video",{className:"mx_UploadConfirmDialog_imagePreview",src:this.objectUrl,playsInline:!0,controls:!1}):i=r.a.createElement("img",{className:"mx_UploadConfirmDialog_fileIcon",src:n(1320).default}),this.props.currentIndex+1<this.props.totalFiles&&(s=r.a.createElement("button",{onClick:this.onUploadAllClick},Object(l.a)("Upload all"))),r.a.createElement(u.a,{className:"mx_UploadConfirmDialog",fixedWidth:!1,onFinished:this.onCancelClick,title:e,contentId:"mx_Dialog_content"},r.a.createElement("div",{id:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_UploadConfirmDialog_previewOuter"},r.a.createElement("div",{className:"mx_UploadConfirmDialog_previewInner"},t&&r.a.createElement("div",null,t),r.a.createElement("div",null,i,this.props.file.name," (",c()(this.props.file.size),")")))),r.a.createElement(h.a,{primaryButton:Object(l.a)("Upload"),hasCancel:!1,onPrimaryButtonClick:this.onUploadClick,focus:!0},s))}}s()(m,"defaultProps",{totalFiles:1})},function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(97),c=n(125),l=n(89),d=n(98),u=n(195),h=n(90),m=n(95),p=n(230),g=n(101),f=n(110),v=n(529),b=n(91);class y extends r.a.Component{constructor(e){var t;super(e),s()(this,"isPrivate",void 0),s()(this,"currentVersion",void 0),s()(this,"onProgressCallback",(e,t,n)=>{this.setState({progressText:e,progress:t,total:n})}),s()(this,"onContinue",()=>{const e={continue:!0,invite:this.isPrivate&&this.state.inviteUsersToNewRoom};this.props.doUpgrade?this.props.doUpgrade(e,this.onProgressCallback).then(()=>{this.props.onFinished(e)}):this.props.onFinished(e)}),s()(this,"onCancel",()=>{this.props.onFinished({continue:!1,invite:!1})}),s()(this,"onInviteUsersToggle",e=>{this.setState({inviteUsersToNewRoom:e})}),s()(this,"openBugReportDialog",e=>{e.preventDefault(),e.stopPropagation(),m.a.createTrackedDialog("Bug Report Dialog","",p.a,{})});const n=h.a.get().getRoom(this.props.roomId),i=null==n?void 0:n.currentState.getStateEvents(a.b.RoomJoinRules,"");this.isPrivate=null===(t=(null==i?void 0:i.getContent().join_rule)!==c.c.Public)||void 0===t||t,this.currentVersion=null==n?void 0:n.getVersion(),this.state={inviteUsersToNewRoom:!0}}render(){const e=d.b.get().brand;let t=null;this.isPrivate&&(t=r.a.createElement(u.a,{value:this.state.inviteUsersToNewRoom,onChange:this.onInviteUsersToggle,label:Object(l.a)("Automatically invite members from this room to the new one")}));const n=this.isPrivate?Object(l.a)("Upgrade private room"):Object(l.a)("Upgrade public room");let i,s=r.a.createElement("p",null,Object(l.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please report a bug.",{brand:e}));return d.b.get().bug_report_endpoint_url&&(s=r.a.createElement("p",null,Object(l.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please <a>report a bug</a>.",{brand:e},{a:e=>r.a.createElement(b.a,{kind:"link_inline",onClick:this.openBugReportDialog},e)}))),i=this.state.progressText?r.a.createElement("span",{className:"mx_RoomUpgradeWarningDialog_progress"},r.a.createElement(v.a,{value:this.state.progress,max:this.state.total}),r.a.createElement("div",{className:"mx_RoomUpgradeWarningDialog_progressText"},this.state.progressText)):r.a.createElement(f.a,{primaryButton:Object(l.a)("Upgrade"),onPrimaryButtonClick:this.onContinue,cancelButton:Object(l.a)("Cancel"),onCancel:this.onCancel}),r.a.createElement(g.a,{className:"mx_RoomUpgradeWarningDialog",hasCancel:!0,fixedWidth:!1,onFinished:this.props.onFinished,title:n},r.a.createElement("div",null,r.a.createElement("p",null,this.props.description||Object(l.a)("Upgrading a room is an advanced action and is usually recommended when a room is unstable due to bugs, missing features or security vulnerabilities.")),r.a.createElement("p",null,Object(l.a)("<b>Please note upgrading will make a new version of the room</b>. All current messages will stay in this archived room.",{},{b:e=>r.a.createElement("b",null,e)})),s,r.a.createElement("p",null,Object(l.a)("You'll upgrade this room from <oldVersion /> to <newVersion />.",{},{oldVersion:()=>r.a.createElement("code",null,this.currentVersion),newVersion:()=>r.a.createElement("code",null,this.props.targetVersion)})),t),i)}}},function(e,t,n){"use strict";var i,s=n(87),o=n.n(s),r=n(89),a=n(302),c=n(259),l=n(300),d=n(176),u=n(343);!function(e){e.All="All",e.Specific="Specific",e.None="None"}(i||(i={}));const h=e=>{let{filterPlaceholder:t,rooms:n,selected:i,onChange:a}=e;const[h,m]=Object(s.useState)(""),p=h.toLowerCase().trim(),g=Object(s.useMemo)(()=>{if(!p)return n;return new c.a(n,{keys:["name"],funcs:[e=>[e.getCanonicalAlias(),...e.getAltAliases()].filter(Boolean)],shouldMatchWordsOnly:!1}).match(p)},[n,p]);return o.a.createElement("div",{className:"mx_SpaceChildrenPicker"},o.a.createElement(l.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:t,onSearch:m,autoFocus:!0}),o.a.createElement(d.a,null,g.map(e=>o.a.createElement(u.b,{key:e.roomId,room:e,checked:i.has(e),onChange:t=>{a(t,e)}})),g.length<1?o.a.createElement("span",{className:"mx_SpaceChildrenPicker_noResults"},Object(r.a)("No results")):void 0))};t.a=e=>{let{space:t,spaceChildren:n,selected:c,onChange:l,noneLabel:d,allLabel:u,specificLabel:m}=e;const[p,g]=Object(s.useState)(d?i.None:i.All);return Object(s.useEffect)(()=>{p===i.All?l(n):l([])},[l,p,n]),o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SpaceChildrenPicker"},o.a.createElement(a.a,{name:"roomsToLeave",value:p,onChange:g,definitions:[{value:i.None,label:d},{value:i.All,label:u},{value:i.Specific,label:m}].filter(e=>e.label)})),p===i.Specific&&o.a.createElement(h,{filterPlaceholder:Object(r.a)("Search %(spaceName)s",{spaceName:t.name}),rooms:n,selected:c,onChange:(e,t)=>{l(e?[t,...c]:[...c].filter(e=>e!==t))}}))}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(90),r=n(93),a=n(297);class c{constructor(){s()(this,"typingStates",void 0),this.reset()}static sharedInstance(){return void 0===window.mxTypingStore&&(window.mxTypingStore=new c),window.mxTypingStore}reset(){this.typingStates={}}setSelfTyping(e,t,n){if(!r.b.getValue("sendTypingNotifications"))return;if(r.b.getValue("lowBandwidth"))return;if(r.b.getValue("feature_thread")&&t)return;let i=this.typingStates[e];!n&&!i||i&&i.isTyping===n||(i||(i=this.typingStates[e]={isTyping:n,serverTimer:new a.a(3e4),userTimer:new a.a(1e4)}),i.isTyping=n,n&&(i.serverTimer.isRunning()?i.serverTimer.restart():i.serverTimer.restart().finished().then(()=>{const t=this.typingStates[e];t&&(t.isTyping=!1)}),i.userTimer.isRunning()?i.userTimer.restart():i.userTimer.restart().finished().then(()=>{this.setSelfTyping(e,t,!1)})),o.a.get().sendTyping(e,n,3e4))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(111),r=n(0);class a{constructor(e,t){s()(this,"history",[]),s()(this,"prefix",void 0),s()(this,"lastIndex",0),s()(this,"currentIndex",0),this.prefix=t+e;let n,i=0;for(;n=sessionStorage.getItem(`${this.prefix}[${i}]`);){try{this.history.push(JSON.parse(n))}catch(e){r.a.warn("Throwing away unserialisable history",e);break}++i}this.lastIndex=this.history.length-1,this.currentIndex=this.lastIndex+1}static createItem(e,t){return{parts:e.serializeParts(),replyEventId:t?t.getId():void 0}}save(e,t){const n=a.createItem(e,t);this.history.push(n),this.currentIndex=this.history.length,this.lastIndex+=1,sessionStorage.setItem(`${this.prefix}[${this.lastIndex}]`,JSON.stringify(n))}getItem(e){return this.currentIndex=Object(o.clamp)(this.currentIndex+e,0,this.history.length-1),this.history[this.currentIndex]}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return m})),n.d(t,"c",(function(){return p})),n.d(t,"d",(function(){return g}));var i=n(87),s=n.n(i),o=n(0),r=n(223),a=n(360),c=n(89),l=n(95),d=n(107),u=n(115);function h(e){const t=e.parts[0];if(t){if(t.type===r.b.Command&&t.text.startsWith("/")&&!t.text.startsWith("//"))return!0;if(t.text.startsWith("/")&&!t.text.startsWith("//")&&(t.type===r.b.Plain||t.type===r.b.PillCandidate))return!0}return!1}function m(e){const t=e.parts.reduce((e,t)=>t.type===r.b.UserPill||t.type===r.b.RoomPill?e+t.resourceId:e+t.text,""),{cmd:n,args:i}=Object(a.d)(t);return[n,i,t]}async function p(e,t,n,i){const s=e.run(n,i,t);let r=null,u=s.error;if(s.promise)try{e.category===a.a.messages?r=await s.promise:await s.promise}catch(e){u=e}if(u){o.a.error("Command failure: %s",u);const e=!!s.promise?Object(c.c)("Server error"):Object(c.c)("Command error");let t;t="string"==typeof u?u:u.translatedMessage?u.translatedMessage:u.message?u.message:Object(c.a)("Server unavailable, overloaded, or something else went wrong."),l.a.createTrackedDialog(e,"",d.a,{title:Object(c.a)(e),description:t})}else if(o.a.log("Command success."),r)return r}async function g(e){const{finished:t}=l.a.createTrackedDialog("Unknown command","",u.a,{title:Object(c.a)("Unknown Command"),description:s.a.createElement("div",null,s.a.createElement("p",null,Object(c.a)("Unrecognised command: %(commandText)s",{commandText:e})),s.a.createElement("p",null,Object(c.a)("You can use <code>/help</code> to list available commands. Did you mean to send this as a message?",{},{code:e=>s.a.createElement("code",null,e)})),s.a.createElement("p",null,Object(c.a)("Hint: Begin your message with <code>//</code> to start it with a slash.",{},{code:e=>s.a.createElement("code",null,e)}))),button:Object(c.a)("Send as message")}),[n]=await t;return n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s}));const i=(e,t)=>`mx_edit_room_${e}_${t}`,s=e=>"mx_edit_state_"+e},,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(88),s=n.n(i);function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const a={imgSrc:"",imgStyle:null,style:"",textContent:""};let c,l;class d{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.iframeFn=e,s()(this,"onLoadPromise",void 0)}get iframe(){var e;const t=null===(e=this.iframeFn)||void 0===e?void 0:e.call(this);if(!t){const e=(c||(c=document.createElement("iframe"),document.body.appendChild(c),c.style.display="none",c.sandbox="allow-scripts allow-downloads allow-downloads-without-user-activation",l=new Promise(e=>{c.onload=()=>{e()},c.src="usercontent/"})),{iframe:c,onLoadPromise:l});return this.onLoadPromise=e.onLoadPromise,e.iframe}return this.onLoadPromise=null,t}async download(e){let{blob:t,name:n,autoDownload:i=!0,opts:s=a}=e;const o=this.iframe;this.onLoadPromise&&await this.onLoadPromise,o.contentWindow.postMessage(r(r({},s),{},{blob:t,download:n,auto:i}),"*")}}},,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(88),c=n.n(a),l=n(87),d=n.n(l),u=n(94),h=n.n(u),m=n(117),p=n(89),g=n(239);const f=["playback","playbackPhase"];class v extends d.a.PureComponent{constructor(e){super(e),c()(this,"onClick",()=>{this.toggleState()})}async toggleState(){await this.props.playback.toggle()}render(){const e=this.props,{playback:t,playbackPhase:n}=e,i=r()(e,f),o=t.isPlaying,a=n===g.d.Decoding,c=h()("mx_PlayPauseButton",{mx_PlayPauseButton_play:!o,mx_PlayPauseButton_pause:o,mx_PlayPauseButton_disabled:a});return d.a.createElement(m.a,s()({"data-test-id":"play-pause-button",className:c,title:o?Object(p.a)("Pause"):Object(p.a)("Play"),onClick:this.onClick,disabled:a},i))}}},,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return l}));var i=n(1364),s=n(1365),o=n(1366),r=n(0),a=n(357);function c(e){if(window.AudioContext)return new AudioContext(e);if(window.webkitAudioContext)return new window.webkitAudioContext(e);throw new Error("Unsupported browser")}function l(e){return new Promise(t=>{r.a.log("Decoder WASM path: "+i.a);const n=new Uint8Array(e),c=new Worker(o.a),l=new Worker(s.a);c.postMessage({command:"init",decoderSampleRate:a.c,outputBufferSampleRate:a.c}),l.postMessage({command:"init",wavBitDepth:24,wavSampleRate:a.c}),c.onmessage=e=>{null!==e.data?l.postMessage({command:"encode",buffers:e.data},e.data.map(e=>e.buffer)):l.postMessage({command:"done"})},l.onmessage=e=>{"page"===e.data.message&&t(new Blob([e.data.page],{type:"audio/wav"}).arrayBuffer())},c.postMessage({command:"decode",pages:n},[n.buffer])})}},function(e,t,n){"use strict";function i(e){e["io.element.performance_metrics"]={sendStartTs:Date.now()}}function s(e,t,n){e.sendEvent(t,"io.element.performance_metric",{"io.element.performance_metrics":{forEventId:n,responseTs:Date.now(),kind:"send_time"}})}n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return F}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(486),c=n.n(a),l=n(111),d=n(97),u=n(0),h=n(137),m=n(92),p=n(856),g=n(718),f=n(844),v=n(223),b=n(153),y=n(756),S=n(360),E=n(277),w=n(100),_=n(96),C=n(345),O=n(232),R=n(90),I=n(114),k=n(93),x=n(777),T=n(106),j=n(715),N=n(408),P=n(757),D=n(109),A=n(173),M=n(219);function U(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function L(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?U(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):U(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function F(e,t){t&&(e["m.relates_to"]=L(L({},e["m.relates_to"]||{}),t))}class B extends r.a.Component{constructor(e,t){super(e),s()(this,"context",void 0),s()(this,"prepareToEncrypt",void 0),s()(this,"editorRef",Object(o.createRef)()),s()(this,"model",null),s()(this,"currentlyComposedEditorState",null),s()(this,"dispatcherRef",void 0),s()(this,"sendHistoryManager",void 0),s()(this,"onKeyDown",e=>{var t,n,i,s;if(null!==(t=this.editorRef.current)&&void 0!==t&&t.isComposing(e))return;const o=(null===(n=this.props.relation)||void 0===n?void 0:n.key)===h.c.name,r=Object(I.a)().getMessageComposerAction(e);switch(r){case D.h.SendMessage:this.sendMessage(),e.preventDefault();break;case D.h.SelectPrevSendHistory:case D.h.SelectNextSendHistory:this.selectSendHistory(r===D.h.SelectPrevSendHistory)&&e.preventDefault();break;case D.h.ShowStickerPicker:if(!k.b.getValue("MessageComposerInput.showStickersButton"))return;this.props.toggleStickerPickerOpen(),e.preventDefault();break;case D.h.EditPrevMessage:if(null!==(i=this.editorRef.current)&&void 0!==i&&i.isSelectionCollapsed()&&null!==(s=this.editorRef.current)&&void 0!==s&&s.isCaretAtStart()){const t=this.context.liveTimeline.getEvents().concat(o?[]:this.props.room.getPendingEvents()),n=Object(b.g)({events:t,isForward:!1});n&&(e.preventDefault(),m.a.dispatch({action:_.a.EditEvent,event:n,timelineRenderingType:this.context.timelineRenderingType}))}break;case D.h.CancelReplyOrEdit:m.a.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType});break;default:this.prepareToEncrypt&&this.prepareToEncrypt()}}),s()(this,"shouldSaveStoredEditorState",()=>!this.model.isEmpty||!!this.props.replyToEvent),s()(this,"saveStoredEditorState",()=>{if(this.shouldSaveStoredEditorState()){const e=y.a.createItem(this.model,this.props.replyToEvent);localStorage.setItem(this.editorStateKey,JSON.stringify(e))}else this.clearStoredEditorState()}),s()(this,"onAction",e=>{var t;if(!this.props.disabled)switch(e.action){case"reply_to_event":case _.a.FocusSendMessageComposer:var n;if((null!==(t=e.context)&&void 0!==t?t:T.a.Room)===this.context.timelineRenderingType)null===(n=this.editorRef.current)||void 0===n||n.focus();break;case _.a.ComposerInsert:if(e.timelineRenderingType!==this.context.timelineRenderingType)break;if(e.composerType!==N.a.Send)break;var i;if(e.userId)null===(i=this.editorRef.current)||void 0===i||i.insertMention(e.userId);else if(e.event){var s;null===(s=this.editorRef.current)||void 0===s||s.insertQuotedMessage(e.event)}else if(e.text){var o;null===(o=this.editorRef.current)||void 0===o||o.insertPlaintext(e.text)}}}),s()(this,"onPaste",e=>{const{clipboardData:t}=e;if(t.files.length&&!t.types.includes("text/rtf"))return E.a.sharedInstance().sendContentListToRoom(Array.from(t.files),this.props.room.roomId,this.props.relation,this.props.mxClient,this.context.timelineRenderingType),!0}),s()(this,"onChange",()=>{this.props.onChange&&this.props.onChange(this.model)}),s()(this,"focusComposer",()=>{var e;null===(e=this.editorRef.current)||void 0===e||e.focus()}),this.props.mxClient.isCryptoEnabled()&&this.props.mxClient.isRoomEncrypted(this.props.room.roomId)&&(this.prepareToEncrypt=Object(l.throttle)(()=>{this.props.mxClient.prepareToEncrypt(this.props.room)},6e4,{leading:!0,trailing:!1})),window.addEventListener("beforeunload",this.saveStoredEditorState)}componentDidUpdate(e){var t,n,i;const s=(null===(t=this.props.relation)||void 0===t?void 0:t.key)===h.c.name,o=(null===(n=this.props.relation)||void 0===n?void 0:n.event_id)!==(null===(i=e.relation)||void 0===i?void 0:i.event_id);if(s&&o){var r;const e=new v.a(this.props.room,this.props.mxClient),t=this.restoreStoredEditorState(e)||[];this.model.reset(t),null===(r=this.editorRef.current)||void 0===r||r.focus()}}selectSendHistory(e){const t=e?-1:1;if(this.sendHistoryManager.currentIndex===this.sendHistoryManager.history.length){if(!e)return!1;this.currentlyComposedEditorState=this.model.serializeParts()}else if(this.sendHistoryManager.currentIndex+t===this.sendHistoryManager.history.length)return this.model.reset(this.currentlyComposedEditorState),this.sendHistoryManager.currentIndex=this.sendHistoryManager.history.length,!0;const{parts:n,replyEventId:i}=this.sendHistoryManager.getItem(t);var s;(m.a.dispatch({action:"reply_to_event",event:i?this.props.room.findEventById(i):null,context:this.context.timelineRenderingType}),n)&&(this.model.reset(n),null===(s=this.editorRef.current)||void 0===s||s.focus());return!0}sendQuickReaction(){const e=this.context.liveTimeline.getEvents(),t=this.model.parts[1].text;for(let n=e.length-1;n>=0;n--)if(e[n].getType()===d.b.RoomMessage){let i=!0;const s=e[n],o=R.a.get().getUserId(),r=this.props.room.getUnfilteredTimelineSet().getRelationsForEvent(s.getId(),d.d.Annotation,d.b.Reaction);if(r){i=![...r.getAnnotationsBySender()[o]||[]].filter(e=>!e.isRedacted()).map(e=>e.getRelation().key).includes(t)}i&&(R.a.get().sendEvent(s.getRoomId(),d.b.Reaction,{"m.relates_to":{rel_type:d.d.Annotation,event_id:s.getId(),key:t}}),m.a.dispatch({action:"message_sent"}));break}}async sendMessage(){var e,t,n;const i=this.model;if(i.isEmpty)return;const s={eventName:"Composer",isEditing:!1,isReply:!!this.props.replyToEvent,inThread:(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===h.c.name};if(s.inThread){var o;const e=this.props.room.findEventById(this.props.relation.event_id);s.startsThread=1===(null==e||null===(o=e.getThread())||void 0===o?void 0:o.events.length)}if(A.a.instance.trackEvent(s),k.b.getValue("MessageComposerInput.autoReplaceEmoji")){var r;const e=i.parts.length-1,t=i.parts[e].text.length;null===(r=this.editorRef.current)||void 0===r||r.replaceEmoticon(new j.a(e,t),f.a)}const a=this.props.replyToEvent;let l,d=!0;if(!Object(g.a)(i)&&Object(P.b)(this.model)){const[e,t,n]=Object(P.a)(this.model);if(e){var u,p;const n=(null===(u=this.props.relation)||void 0===u?void 0:u.rel_type)===h.c.name?null===(p=this.props.relation)||void 0===p?void 0:p.event_id:null;if(e.category===S.a.messages){if(l=await Object(P.c)(e,t,this.props.room.roomId,n),!l)return;F(l,this.props.relation),a&&Object(M.a)(l,a,{permalinkCreator:this.props.permalinkCreator,includeLegacyFallback:!0})}else Object(P.c)(e,t,this.props.room.roomId,n),d=!1}else if(!await Object(P.d)(n))return}if(function(e){const t=e.parts;if(0==t.length)return!1;const n=Object(g.f)(e);if(t.length<=2){const e=n.startsWith("+")||n.startsWith("+ "),t=n.match(c.a);if(e&&t&&1==t.length)return t[0]===n.substring(1)||t[0]===n.substring(2)}return!1}(i)&&(d=!1,this.sendQuickReaction()),d){var v;const{roomId:e}=this.props.room;if(l||(l=function(e,t,n,i){let s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];const o=Object(g.a)(e);o&&(e=Object(g.d)(e)),Object(g.c)(e,"//")&&(e=Object(g.e)(e,"/")),e=Object(g.g)(e);const r=Object(g.f)(e),a={msgtype:o?"m.emote":"m.text",body:r},c=Object(g.b)(e,{forceHTML:!!t,useMarkdown:k.b.getValue("MessageComposerInput.useMarkdown")});return c&&(a.format="org.matrix.custom.html",a.formatted_body=c),F(a,n),t&&Object(M.a)(a,t,{permalinkCreator:i,includeLegacyFallback:s}),a}(i,a,this.props.relation,this.props.permalinkCreator,this.props.includeReplyLegacyFallback)),!l.body.trim())return;k.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(x.a)(l);const t=(null===(v=this.props.relation)||void 0===v?void 0:v.rel_type)===h.c.name?this.props.relation.event_id:null,n=this.props.mxClient.sendMessage(e,t,l);a&&m.a.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType}),m.a.dispatch({action:"message_sent"}),O.CHAT_EFFECTS.forEach(e=>{if(Object(C.containsEmoji)(l,e.emojis)){var t;const n=(null===(t=this.props.relation)||void 0===t?void 0:t.rel_type)!==h.c.name;k.b.getValue("feature_thread")&&!n||m.a.dispatch({action:"effects."+e.command})}}),k.b.getValue("Performance.addSendMessageTimingMetadata")&&n.then(t=>{Object(x.b)(this.props.mxClient,e,t.event_id)})}this.sendHistoryManager.save(i,a),i.reset([]),null===(t=this.editorRef.current)||void 0===t||t.clearUndoHistory(),null===(n=this.editorRef.current)||void 0===n||n.focus(),this.clearStoredEditorState(),d&&k.b.getValue("scrollToBottomOnMessageSent")&&m.a.dispatch({action:"scroll_to_bottom",timelineRenderingType:this.context.timelineRenderingType})}componentWillUnmount(){m.a.unregister(this.dispatcherRef),window.removeEventListener("beforeunload",this.saveStoredEditorState),this.saveStoredEditorState()}UNSAFE_componentWillMount(){const e=new v.a(this.props.room,this.props.mxClient),t=this.restoreStoredEditorState(e)||[];this.model=new p.a(t,e),this.dispatcherRef=m.a.register(this.onAction),this.sendHistoryManager=new y.a(this.props.room.roomId,"mx_cider_history_")}get editorStateKey(){var e;let t="mx_cider_state_"+this.props.room.roomId;return(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===h.c.name&&(t+="_"+this.props.relation.event_id),t}clearStoredEditorState(){localStorage.removeItem(this.editorStateKey)}restoreStoredEditorState(e){var t;if((null===(t=this.props.relation)||void 0===t?void 0:t.key)===h.c.name)return null;const n=localStorage.getItem(this.editorStateKey);if(n)try{const{parts:t,replyEventId:i}=JSON.parse(n),s=t.map(t=>e.deserializePart(t));return i&&m.a.dispatch({action:"reply_to_event",event:this.props.room.findEventById(i),context:this.context.timelineRenderingType}),s}catch(e){u.a.error(e)}}render(){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===h.c.name?this.props.relation.event_id:null;return r.a.createElement("div",{className:"mx_SendMessageComposer",onClick:this.focusComposer,onKeyDown:this.onKeyDown},r.a.createElement(f.b,{onChange:this.onChange,ref:this.editorRef,model:this.model,room:this.props.room,threadId:t,label:this.props.placeholder,placeholder:this.props.placeholder,onPaste:this.onPaste,disabled:this.props.disabled}))}}s()(B,"contextType",T.b),s()(B,"defaultProps",{includeReplyLegacyFallback:!0});const K=Object(w.b)(B);t.b=K},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(239),c=n(346),l=n(250);class d extends r.a.PureComponent{constructor(e){super(e),s()(this,"animationFrameFn",new c.a(()=>this.doUpdate(),()=>requestAnimationFrame(()=>this.animationFrameFn.trigger()))),s()(this,"onChange",e=>{this.props.playback.skipTo(Number(e.target.value)*this.props.playback.clockInfo.durationSeconds)}),this.state={percentage:0},this.props.playback.clockInfo.liveData.onUpdate(()=>this.animationFrameFn.mark())}doUpdate(){this.setState({percentage:Object(l.c)(this.props.playback.clockInfo.timeSeconds,0,this.props.playback.clockInfo.durationSeconds)})}left(){this.props.playback.skipTo(this.props.playback.clockInfo.timeSeconds-5)}right(){this.props.playback.skipTo(this.props.playback.clockInfo.timeSeconds+5)}render(){return r.a.createElement("input",{type:"range",className:"mx_SeekBar",tabIndex:this.props.tabIndex,onChange:this.onChange,min:0,max:1,value:this.state.percentage,step:.001,style:{"--fillTo":this.state.percentage},disabled:this.props.playbackPhase===a.d.Decoding})}}s()(d,"defaultProps",{tabIndex:0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(410),c=n(239),l=n(123);class d extends r.a.PureComponent{constructor(e){super(e),s()(this,"onPlaybackUpdate",e=>{e===c.d.Decoding&&(e=c.d.Stopped),this.setState({playbackPhase:e})}),s()(this,"onTimeUpdate",e=>{this.setState({seconds:e[0],durationSeconds:e[1]})}),this.state={seconds:this.props.playback.clockInfo.timeSeconds,durationSeconds:this.props.playback.clockInfo.durationSeconds,playbackPhase:c.d.Stopped},this.props.playback.on(l.b,this.onPlaybackUpdate),this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}render(){let e=this.state.seconds;return this.state.playbackPhase===c.d.Stopped&&(e=Number.isFinite(this.props.defaultDisplaySeconds)?this.props.defaultDisplaySeconds:this.state.durationSeconds),r.a.createElement(a.a,{seconds:e,"aria-live":this.state.playbackPhase===c.d.Playing?"off":void 0})}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(0),c=n(123),l=n(89),d=n(114),u=n(109);class h extends r.a.PureComponent{constructor(e){super(e),s()(this,"seekRef",Object(o.createRef)()),s()(this,"playPauseRef",Object(o.createRef)()),s()(this,"onKeyDown",e=>{var t,n,i;let s=!0;switch(Object(d.a)().getAccessibilityAction(e)){case u.h.Space:null===(t=this.playPauseRef.current)||void 0===t||t.toggleState();break;case u.h.ArrowLeft:null===(n=this.seekRef.current)||void 0===n||n.left();break;case u.h.ArrowRight:null===(i=this.seekRef.current)||void 0===i||i.right();break;default:s=!1}s&&e.stopPropagation()}),s()(this,"onPlaybackUpdate",e=>{this.setState({playbackPhase:e})}),this.state={playbackPhase:this.props.playback.currentState},this.props.playback.on(c.b,this.onPlaybackUpdate),this.props.playback.prepare().catch(e=>{a.a.error("Error processing audio file:",e),this.setState({error:!0})})}render(){return r.a.createElement(r.a.Fragment,null,this.renderComponent(),this.state.error&&r.a.createElement("div",{className:"text-warning"},Object(l.a)("Error downloading audio")))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(99),s=n.n(i),o=n(87),r=n.n(o),a=n(170),c=n(89),l=n(857),d=n(848),u=n(303);class h extends d.a{render(){return this.state.error?r.a.createElement("span",{className:"mx_MVoiceMessageBody"},r.a.createElement("img",{src:n(304).default,width:"16",height:"16"}),Object(c.a)("Error processing voice message")):this.state.playback?r.a.createElement("span",{className:"mx_MVoiceMessageBody"},r.a.createElement(l.a,{playback:this.state.playback}),this.showFileBody&&r.a.createElement(u.a,s()({},this.props,{showGenericPlaceholder:!1}))):r.a.createElement("span",{className:"mx_MVoiceMessageBody"},r.a.createElement(a.a,null))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a);class l extends r.a.PureComponent{render(){return r.a.createElement("div",{className:"mx_Waveform"},this.props.relHeights.map((e,t)=>{const n=this.props.progress,i=t/this.props.relHeights.length<=n&&n>0,s=c()({mx_Waveform_bar:!0,mx_Waveform_bar_100pct:i});return r.a.createElement("span",{key:t,style:{"--barHeight":e},className:s})}))}}s()(l,"defaultProps",{progress:1})},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(94),r=n.n(o),a=n(542),c=n(175),l=n(136);const d=e=>{let{tooltip:t,children:n}=e;const[o,r]=Object(i.useState)(!1);if(!t)return s.a.createElement(s.a.Fragment,null,n);return s.a.createElement("div",{onMouseEnter:()=>r(!0),onClick:e=>{e.stopPropagation(),r(!o)},onMouseLeave:()=>r(!1)},n,o&&t)},u=s.a.forwardRef((e,t)=>{let{id:n,roomMember:i,useMemberColor:o,tooltip:u}=e;const h=o&&i?Object(c.f)(i.userId):"";return s.a.createElement("div",{ref:t,id:n,className:r()("mx_Marker",h,{mx_Marker_defaultColor:!h})},s.a.createElement(d,{tooltip:u},s.a.createElement("div",{className:"mx_Marker_border"},i?s.a.createElement(l.a,{member:i,width:36,height:36,viewUserOnClick:!1,hideTitle:!!u}):s.a.createElement(a.a,{className:"mx_Marker_icon"}))))});t.a=u},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(120),r=n(133),a=n(118),c=n(544),l=n(89),d=n(222);t.a=e=>{let{beacon:t}=e;const n=(e=>{const t=Object(a.b)(e,o.BeaconEvent.Update,()=>e.beaconInfo),[n,s]=Object(i.useState)(()=>Object(d.d)(t));Object(i.useEffect)(()=>{s(Object(d.d)(t))},[t]);const r=Object(i.useCallback)(()=>{const e=Object(d.d)(t);s(e)},[t]);var l;return Object(c.b)(r,(l=n)>36e5?6e5:l>6e4?6e4:1e3),n})(t),u=Object(r.c)(n),h=Object(l.a)("%(timeRemaining)s left",{timeRemaining:u});return s.a.createElement("span",{"data-test-id":"room-live-share-expiry",className:"mx_LiveTimeRemaining"},h)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(87);function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 12 12",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M11.468 2.04A1 1 0 0010.054.627L6.047 4.633 1.811.398A1 1 0 10.397 1.812l4.236 4.236-4.007 4.006A1 1 0 102.04 11.47l4.007-4.007 3.778 3.778a1 1 0 001.415-1.414L7.46 6.048l4.007-4.007z",fill:"#A9B2BC"})))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(87),s=n.n(i),o=n(94),r=n.n(o),a=n(140),c=n(89),l=n(236);let d;!function(e){e.Info="info",e.Warning="warning"}(d||(d={}));class u extends s.a.PureComponent{constructor(e){super(e)}render(){const{tooltip:e,children:t,tooltipClassName:n,className:i,kind:o}=this.props,u=Object(c.a)("Information"),h=o!==d.Warning?"mx_InfoTooltip_icon_info":"mx_InfoTooltip_icon_warning";return s.a.createElement(l.a,{tooltipTargetClassName:r()("mx_InfoTooltip",i),className:"mx_InfoTooltip_container",tooltipClassName:r()("mx_InfoTooltip_tooltip",n),label:e||u,alignment:a.a.Right},s.a.createElement("span",{className:r()("mx_InfoTooltip_icon",h),"aria-label":u}),t)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return b})),n.d(t,"a",(function(){return y}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(108),c=n(89),l=n(396),d=n(92),u=n(348),h=n(96),m=n(210),p=n(349),g=n(91),f=n(170),v=n(100);function b(e){return e?e.getPendingEvents().filter((function(e){return e.status===a.a.NOT_SENT})):[]}class y extends r.a.PureComponent{constructor(e,t){super(e,t),s()(this,"unmounted",!1),s()(this,"onSyncStateChange",(e,t,n)=>{"SYNCING"===e&&"SYNCING"===t||this.unmounted||this.setState({syncState:e,syncStateData:n})}),s()(this,"onResendAllClick",()=>{l.a.resendUnsentEvents(this.props.room).then(()=>{this.setState({isResending:!1})}),this.setState({isResending:!0}),d.a.fire(h.a.FocusSendMessageComposer)}),s()(this,"onCancelAllClick",()=>{l.a.cancelUnsentEvents(this.props.room),d.a.fire(h.a.FocusSendMessageComposer)}),s()(this,"onRoomLocalEchoUpdated",(e,t)=>{if(t.roomId!==this.props.room.roomId)return;const n=b(this.props.room);this.setState({unsentMessages:n,isResending:n.length>0&&this.state.isResending})}),this.state={syncState:this.context.getSyncState(),syncStateData:this.context.getSyncStateData(),unsentMessages:b(this.props.room),isResending:!1}}componentDidMount(){const e=this.context;e.on("sync",this.onSyncStateChange),e.on("Room.localEchoUpdated",this.onRoomLocalEchoUpdated),this.checkSize()}componentDidUpdate(){this.checkSize()}componentWillUnmount(){this.unmounted=!0;const e=this.context;e&&(e.removeListener("sync",this.onSyncStateChange),e.removeListener("Room.localEchoUpdated",this.onRoomLocalEchoUpdated))}checkSize(){this.getSize()?this.props.onVisible&&this.props.onVisible():this.props.onHidden&&this.props.onHidden()}getSize(){return this.shouldShowConnectionError()?1:this.state.unsentMessages.length>0||this.state.isResending?2:0}shouldShowConnectionError(){const e=Boolean(this.state.syncStateData&&this.state.syncStateData.error&&"M_RESOURCE_LIMIT_EXCEEDED"===this.state.syncStateData.error.name);return"ERROR"===this.state.syncState&&!e}getUnsentMessageContent(){const e=this.state.unsentMessages;let t,n=null,i=null;for(const t of e){if(t.error&&"M_CONSENT_NOT_GIVEN"===t.error.errcode){n=t.error;break}if(t.error&&"M_RESOURCE_LIMIT_EXCEEDED"===t.error.errcode){i=t.error;break}}t=n?Object(c.a)("You can't send any messages until you review and agree to <consentLink>our terms and conditions</consentLink>.",{},{consentLink:e=>r.a.createElement("a",{href:n.data&&n.data.consent_uri,target:"_blank"},e)}):i?Object(u.a)(i.data.limit_type,i.data.admin_contact,{monthly_active_user:Object(c.c)("Your message wasn't sent because this homeserver has hit its Monthly Active User Limit. Please <a>contact your service administrator</a> to continue using the service."),hs_disabled:Object(c.c)("Your message wasn't sent because this homeserver has been blocked by its administrator. Please <a>contact your service administrator</a> to continue using the service."),"":Object(c.c)("Your message wasn't sent because this homeserver has exceeded a resource limit. Please <a>contact your service administrator</a> to continue using the service.")}):Object(c.a)("Some of your messages have not been sent");let s=r.a.createElement(r.a.Fragment,null,r.a.createElement(g.a,{onClick:this.onCancelAllClick,className:"mx_RoomStatusBar_unsentCancelAllBtn"},Object(c.a)("Delete all")),r.a.createElement(g.a,{onClick:this.onResendAllClick,className:"mx_RoomStatusBar_unsentResendAllBtn"},Object(c.a)("Retry all")));return this.state.isResending&&(s=r.a.createElement(r.a.Fragment,null,r.a.createElement(f.a,{w:20,h:20}),r.a.createElement("span",null,Object(c.a)("Sending")))),r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_RoomStatusBar mx_RoomStatusBar_unsentMessages"},r.a.createElement("div",{role:"alert"},r.a.createElement("div",{className:"mx_RoomStatusBar_unsentBadge"},r.a.createElement(m.a,{notification:p.a.RED_EXCLAMATION})),r.a.createElement("div",null,r.a.createElement("div",{className:"mx_RoomStatusBar_unsentTitle"},t),r.a.createElement("div",{className:"mx_RoomStatusBar_unsentDescription"},Object(c.a)("You can select all or individual messages to retry or delete"))),r.a.createElement("div",{className:"mx_RoomStatusBar_unsentButtonBar"},s))))}render(){return this.shouldShowConnectionError()?r.a.createElement("div",{className:"mx_RoomStatusBar"},r.a.createElement("div",{role:"alert"},r.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar"},r.a.createElement("img",{src:n(789).default,width:"24",height:"24",title:"/!\\ ",alt:"/!\\ "}),r.a.createElement("div",null,r.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_title"},Object(c.a)("Connectivity to the server has been lost.")),r.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_desc"},Object(c.a)("Sent messages will be stored until your connection has returned.")))))):this.state.unsentMessages.length>0||this.state.isResending?this.getUnsentMessageContent():null}}s()(y,"contextType",v.a)},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return a}));var i,s,o=n(87);function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function a(e){return o.createElement("svg",r({id:"warning-triangle_svg__Layer_1",xmlns:"http://www.w3.org/2000/svg",x:0,y:0,viewBox:"0 0 14 12",xmlSpace:"preserve",role:"presentation","aria-hidden":!0},e),i||(i=o.createElement("style",null,".warning-triangle_svg__st0{fill:none;stroke:#454545;stroke-linecap:round;stroke-linejoin:round}")),s||(s=o.createElement("path",{className:"warning-triangle_svg__st0",d:"M6 1.5L1.2 9.3c-.2.3-.2.8 0 1.1.2.3.6.6 1 .6h9.7c.4 0 .8-.2 1-.6.2-.3.2-.8 0-1.1L8 1.5c-.2-.3-.6-.5-1-.5s-.8.2-1 .5zM7 4v3M7 9"})))}t.default="img/feather-customised/warning-triangle.d050a38.svg"},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));var i=n(121);function s(e,t){return e.size!==t.size||(!!Array.from(t).some(t=>!e.has(t))||!!Array.from(e).some(e=>!t.has(e)))}function o(e,t){return Object(i.a)(Array.from(e),Array.from(t))}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return x})),n.d(t,"b",(function(){return T}));var i=n(88),s=n.n(i),o=n(87),r=n(7),a=n(94),c=n.n(a),l=n(411),d=n(134),u=n(89),h=n(91),m=n(506),p=n(112),g=n(189),f=n(292),v=n(166),b=n(92),y=n(96),S=n(210),E=n(117),w=n(1373),_=n(172),C=n(851),O=n(121),R=n(164),I=n(114),k=n(109);const x=32;Object(w.a)();class T extends o.Component{constructor(t){super(t),s()(this,"headerButton",Object(o.createRef)()),s()(this,"sublistRef",Object(o.createRef)()),s()(this,"tilesRef",Object(o.createRef)()),s()(this,"dispatcherRef",void 0),s()(this,"layout",void 0),s()(this,"heightAtStart",void 0),s()(this,"isBeingFiltered",void 0),s()(this,"notificationState",void 0),s()(this,"onListsUpdated",()=>{const e={};if(this.props.extraTiles){const t=g.b.instance.getFirstNameFilterCondition();t?e.filteredExtraTiles=this.props.extraTiles.filter(e=>t.matches(Object(r.x)(e.props.displayName||""))):this.state.filteredExtraTiles&&(e.filteredExtraTiles=null)}const t=this.state.rooms,n=Object(O.b)(g.b.instance.orderedLists[this.props.tagId]||[]);Object(O.e)(t,n)&&(e.rooms=n);const i=!!g.b.instance.getFirstNameFilterCondition();i!==this.isBeingFiltered&&(this.isBeingFiltered=i,e.isExpanded=!!i||!this.layout.isCollapsed),Object.keys(e).length>0&&this.setState(e)}),s()(this,"onAction",t=>{t.action===y.a.ViewRoom&&t.show_room_tile&&this.state.rooms&&e(()=>{const e=this.state.rooms.findIndex(e=>e.roomId===t.room_id);!this.state.isExpanded&&e>-1&&this.toggleCollapsed(),e>=this.numVisibleTiles&&(this.layout.visibleTiles=this.layout.tilesWithPadding(e+1,32),this.forceUpdate())})}),s()(this,"onResize",(e,t,n,i)=>{const s=this.heightAtStart+i.height;this.applyHeightChange(s),this.setState({height:s})}),s()(this,"onResizeStart",()=>{this.heightAtStart=this.state.height,this.setState({isResizing:!0})}),s()(this,"onResizeStop",(e,t,n,i)=>{const s=this.heightAtStart+i.height;this.applyHeightChange(s),this.setState({isResizing:!1,height:s})}),s()(this,"onShowAllClick",()=>{const e=this.numVisibleTiles,t=this.layout.tilesToPixelsWithPadding(this.numTiles,this.padding);this.applyHeightChange(t),this.setState({height:t},()=>{this.focusRoomTile(e)})}),s()(this,"onShowLessClick",()=>{const e=this.layout.tilesToPixelsWithPadding(this.layout.defaultVisibleTiles,this.padding);this.applyHeightChange(e),this.setState({height:e})}),s()(this,"focusRoomTile",e=>{if(!this.sublistRef.current)return;const t=this.sublistRef.current.querySelectorAll(".mx_RoomTile"),n=t&&t[e];n&&n.focus()}),s()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),s()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,height:0}})}),s()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),s()(this,"onUnreadFirstChanged",()=>{const e=g.b.instance.getListOrder(this.props.tagId)===f.a.Importance?f.a.Natural:f.a.Importance;g.b.instance.setListOrder(this.props.tagId,e),this.forceUpdate()}),s()(this,"onTagSortChanged",async e=>{await g.b.instance.setTagSorting(this.props.tagId,e),this.forceUpdate()}),s()(this,"onMessagePreviewChanged",()=>{this.layout.showPreviews=!this.layout.showPreviews,this.forceUpdate()}),s()(this,"onBadgeClick",e=>{let t;e.preventDefault(),e.stopPropagation(),t=this.props.tagId===v.a.Invite?this.state.rooms&&this.state.rooms[0]:g.b.instance.unfilteredLists[this.props.tagId].find(e=>{const t=this.notificationState.getForRoom(e);return t.count>0&&t.color===this.notificationState.color}),t&&b.a.dispatch({action:y.a.ViewRoom,room_id:t.roomId,show_room_tile:!0,metricsTrigger:"WebRoomListNotificationBadge",metricsViaKeyboard:"click"!==e.type})}),s()(this,"onHeaderClick",()=>{const t=this.headerButton.current.parentElement,n=t.parentElement.parentElement,i=n.parentElement.parentElement,s=Math.round(i.scrollTop),o=s<=Math.round(x),r=s>=Math.round(i.scrollHeight-i.offsetHeight),a=t.classList.contains("mx_RoomSublist_headerContainer_stickyTop"),c=t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom");if(c&&!r||a&&!o)n.scrollIntoView({behavior:"smooth"});else{const t=this.state.isExpanded;this.toggleCollapsed(),!t&&c&&e(()=>{n.scrollIntoView({behavior:"smooth"})})}}),s()(this,"toggleCollapsed",()=>{this.props.forceExpanded||(this.layout.isCollapsed=this.state.isExpanded,this.setState({isExpanded:!this.layout.isCollapsed}),this.props.onListCollapse&&this.props.onListCollapse(!this.layout.isCollapsed))}),s()(this,"onHeaderKeyDown",e=>{switch(Object(I.a)().getRoomListAction(e)){case k.h.CollapseRoomListSection:e.stopPropagation(),this.state.isExpanded&&this.toggleCollapsed();break;case k.h.ExpandRoomListSection:if(e.stopPropagation(),this.state.isExpanded){if(this.sublistRef.current){const e=this.sublistRef.current.querySelector(".mx_RoomTile");e&&e.focus()}}else this.toggleCollapsed()}}),s()(this,"onKeyDown",e=>{switch(Object(I.a)().getAccessibilityAction(e)){case k.h.ArrowLeft:e.stopPropagation(),this.headerButton.current.focus();break;case k.h.ArrowRight:e.stopPropagation()}}),this.layout=C.a.instance.getLayoutFor(this.props.tagId),this.heightAtStart=0,this.isBeingFiltered=!!g.b.instance.getFirstNameFilterCondition(),this.notificationState=_.a.instance.getListState(this.props.tagId),this.state={contextMenuPosition:null,isResizing:!1,isExpanded:this.isBeingFiltered?this.isBeingFiltered:!this.layout.isCollapsed,height:0,rooms:Object(O.b)(g.b.instance.orderedLists[this.props.tagId]||[])},this.state=Object.assign(this.state,{height:this.calculateInitialHeight()})}calculateInitialHeight(){const e=Math.max(Math.floor(this.layout.visibleTiles),this.layout.minVisibleTiles),t=Math.min(this.numTiles,e);return this.layout.tilesToPixelsWithPadding(t,this.padding)}get padding(){let e=4;const t=this.numTiles>this.numVisibleTiles,n=this.numTiles>this.layout.defaultVisibleTiles;return(t||n)&&(e+=28),e}get extraTiles(){return this.state.filteredExtraTiles?this.state.filteredExtraTiles:this.props.extraTiles?this.props.extraTiles:null}get numTiles(){return T.calcNumTiles(this.state.rooms,this.extraTiles)}static calcNumTiles(e,t){return(e||[]).length+(t||[]).length}get numVisibleTiles(){const e=Math.ceil(this.layout.visibleTiles);return Math.min(e,this.numTiles)}componentDidUpdate(e,t){const n=t.filteredExtraTiles||e.extraTiles;T.calcNumTiles(t.rooms,n)!==this.numTiles&&this.setState({height:this.calculateInitialHeight()})}shouldComponentUpdate(e,t){if(Object(R.c)(this.props,e))return!0;const n=Object(R.b)(this.state,["rooms"]),i=Object(R.b)(t,["rooms"]);if(Object(R.c)(n,i))return!0;const s=this.props.extraTiles||[],o=t.filteredExtraTiles||e.extraTiles||[];if(s.length>0||o.length>0)return!0;if(T.calcNumTiles(t.rooms,o)!==this.numTiles)return!0;if(!t.isExpanded)return!1;if(this.state.rooms.length!==t.rooms.length)return!0;const r=this.state.rooms.slice(0,this.numVisibleTiles),a=t.rooms.slice(0,this.numVisibleTiles);return!!Object(O.e)(r,a)}componentDidMount(){var e;this.dispatcherRef=b.a.register(this.onAction),g.b.instance.on(g.a,this.onListsUpdated),null===(e=this.tilesRef.current)||void 0===e||e.addEventListener("scroll",this.onScrollPrevent,{passive:!0})}componentWillUnmount(){var e;b.a.unregister(this.dispatcherRef),g.b.instance.off(g.a,this.onListsUpdated),null===(e=this.tilesRef.current)||void 0===e||e.removeEventListener("scroll",this.onScrollPrevent)}applyHeightChange(e){const t=Math.ceil(this.layout.pixelsToTiles(e-this.padding));this.layout.visibleTiles=Math.min(this.numTiles,t)}renderVisibleTiles(){if(!this.state.isExpanded&&!this.props.forceExpanded)return[];const e=[];if(this.state.rooms){let t=this.state.rooms;this.props.forceExpanded||(t=t.slice(0,this.numVisibleTiles));for(const n of t)e.push(o.createElement(m.b,{room:n,key:"room-"+n.roomId,showMessagePreview:this.layout.showPreviews,isMinimized:this.props.isMinimized,tag:this.props.tagId}))}return this.extraTiles&&e.push(...this.extraTiles),e.length>this.numVisibleTiles&&!this.props.forceExpanded?e.slice(0,this.numVisibleTiles):e}renderMenu(){if(this.props.tagId===v.a.Suggested)return null;let e=null;if(this.state.contextMenuPosition){const t=g.b.instance.getTagSorting(this.props.tagId)===f.b.Alphabetic,n=g.b.instance.getListOrder(this.props.tagId)===f.a.Importance;let i=null;this.props.tagId!==v.a.Invite&&(i=o.createElement(o.Fragment,null,o.createElement("hr",null),o.createElement("div",null,o.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(u.a)("Appearance")),o.createElement(p.h,{onClose:this.onCloseMenu,onChange:this.onUnreadFirstChanged,checked:n},Object(u.a)("Show rooms with unread messages first")),o.createElement(p.h,{onClose:this.onCloseMenu,onChange:this.onMessagePreviewChanged,checked:this.layout.showPreviews},Object(u.a)("Show previews of messages"))))),e=o.createElement(p.o,{chevronFace:p.a.None,left:this.state.contextMenuPosition.left,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height,onFinished:this.onCloseMenu},o.createElement("div",{className:"mx_RoomSublist_contextMenu"},o.createElement("div",null,o.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(u.a)("Sort by")),o.createElement(p.i,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(f.b.Recent),checked:!t,name:`mx_${this.props.tagId}_sortBy`},Object(u.a)("Activity")),o.createElement(p.i,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(f.b.Alphabetic),checked:t,name:`mx_${this.props.tagId}_sortBy`},Object(u.a)("A-Z"))),i))}return o.createElement(o.Fragment,null,o.createElement(p.c,{className:"mx_RoomSublist_menuButton",onClick:this.onOpenMenuClick,title:Object(u.a)("List options"),isExpanded:!!this.state.contextMenuPosition}),e)}renderHeader(){return o.createElement(d.e,{inputRef:this.headerButton},e=>{let{onFocus:t,isActive:n,ref:i}=e;const s=n?0:-1;let r=Object(u.a)("Jump to first unread room.");this.props.tagId===v.a.Invite&&(r=Object(u.a)("Jump to first invite."));const a=o.createElement(S.a,{forceCount:!0,notification:this.notificationState,onClick:this.onBadgeClick,tabIndex:s,"aria-label":r,showUnsentTooltip:!0});let l=null;if(this.props.AuxButtonComponent){const e=this.props.AuxButtonComponent;l=o.createElement(e,{tabIndex:s})}const d=c()({mx_RoomSublist_collapseBtn:!0,mx_RoomSublist_collapseBtn_collapsed:!this.state.isExpanded}),m=c()({mx_RoomSublist_headerContainer:!0,mx_RoomSublist_headerContainer_withAux:!!l}),p=o.createElement("div",{className:"mx_RoomSublist_badgeContainer"},a);let g=h.a;return this.props.isMinimized&&(g=E.a),o.createElement("div",{className:m,onKeyDown:this.onHeaderKeyDown,onFocus:t,"aria-label":this.props.label},o.createElement("div",{className:"mx_RoomSublist_stickableContainer"},o.createElement("div",{className:"mx_RoomSublist_stickable"},o.createElement(g,{onFocus:t,inputRef:i,tabIndex:s,className:"mx_RoomSublist_headerText",role:"treeitem","aria-expanded":this.state.isExpanded,"aria-level":1,onClick:this.onHeaderClick,onContextMenu:this.onContextMenu,title:this.props.isMinimized?this.props.label:void 0},o.createElement("span",{className:d}),o.createElement("span",null,this.props.label)),this.renderMenu(),this.props.isMinimized?null:p,this.props.isMinimized?null:l)),this.props.isMinimized?p:null,this.props.isMinimized?l:null)})}onScrollPrevent(e){e.target.scrollTop=0}render(){var e;const t=this.renderVisibleTiles(),n=c()({mx_RoomSublist:!0,mx_RoomSublist_hasMenuOpen:!!this.state.contextMenuPosition,mx_RoomSublist_minimized:this.props.isMinimized,mx_RoomSublist_hidden:!(this.state.rooms.length||null!==(e=this.props.extraTiles)&&void 0!==e&&e.length||!0===this.props.alwaysVisible)});let i=null;if(t.length>0&&this.props.forceExpanded)i=o.createElement("div",{className:"mx_RoomSublist_resizeBox mx_RoomSublist_resizeBox_forceExpanded"},o.createElement("div",{className:"mx_RoomSublist_tiles",ref:this.tilesRef},t));else if(t.length>0){const e=this.layout,n=Math.min(e.minVisibleTiles,this.numTiles),s=4+(n<this.numTiles?28:0),r=e.tilesToPixelsWithPadding(n,s),a=e.tilesToPixelsWithPadding(this.numTiles,this.padding),h=c()({mx_RoomSublist_showNButton:!0});let m=null;if(a>this.state.height){const e=this.state.height-4-28,t=Math.floor(e/this.layout.tileHeight),n=this.numTiles-t,i=Object(u.a)("Show %(count)s more",{count:n});let s=o.createElement("span",{className:"mx_RoomSublist_showNButtonText"},i);this.props.isMinimized&&(s=null),m=o.createElement(d.a,{role:"treeitem",onClick:this.onShowAllClick,className:h,"aria-label":i},o.createElement("span",{className:"mx_RoomSublist_showMoreButtonChevron mx_RoomSublist_showNButtonChevron"}),s)}else if(this.numTiles>this.layout.defaultVisibleTiles){const e=Object(u.a)("Show less");let t=o.createElement("span",{className:"mx_RoomSublist_showNButtonText"},e);this.props.isMinimized&&(t=null),m=o.createElement(d.a,{role:"treeitem",onClick:this.onShowLessClick,className:h,"aria-label":e},o.createElement("span",{className:"mx_RoomSublist_showLessButtonChevron mx_RoomSublist_showNButtonChevron"}),t)}const p={bottom:!0,bottomLeft:!1,bottomRight:!1,left:!1,right:!1,top:!1,topLeft:!1,topRight:!1};e.visibleTiles>=this.numTiles&&this.numTiles<=e.minVisibleTiles&&(p.bottom=!1);const g=c()({mx_RoomSublist_resizerHandles:!0,mx_RoomSublist_resizerHandles_showNButton:!!m});i=o.createElement(o.Fragment,null,o.createElement(l.Resizable,{size:{height:this.state.height},minHeight:r,maxHeight:a,onResizeStart:this.onResizeStart,onResizeStop:this.onResizeStop,onResize:this.onResize,handleWrapperClass:g,handleClasses:{bottom:"mx_RoomSublist_resizerHandle"},className:"mx_RoomSublist_resizeBox",enable:p},o.createElement("div",{className:"mx_RoomSublist_tiles",ref:this.tilesRef},t),m))}else this.props.showSkeleton&&this.state.isExpanded&&(i=o.createElement("div",{className:"mx_RoomSublist_skeletonUI"}));return o.createElement("div",{ref:this.sublistRef,className:n,role:"group","aria-label":this.props.label,onKeyDown:this.onKeyDown},this.renderHeader(),i)}}}).call(this,n(179).setImmediate)},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(8),r=n(7),a=n(111),c=n(386);class l extends o.EventEmitter{constructor(){super(),s()(this,"_search",""),s()(this,"callUpdate",Object(a.throttle)(()=>{this.emit(c.a)},200,{trailing:!0,leading:!0}))}get kind(){return c.b.Runtime}get search(){return this._search}set search(e){this._search=e,this.callUpdate()}isVisible(e){const t=this.search.toLowerCase();if("#"===this.search[0]){if(e.getCanonicalAlias()&&e.getCanonicalAlias().toLowerCase().startsWith(t))return!0;if(e.getAltAliases().some(e=>e.toLowerCase().startsWith(t)))return!0}return!!e.name&&this.matches(e.normalizedName)}matches(e){return e.includes(Object(r.x)(this.search))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(87),s=n(89),o=n(91);class r extends i.PureComponent{render(){return i.createElement("div",{className:"mx_DialPadBackspaceButtonWrapper"},i.createElement(o.a,{className:"mx_DialPadBackspaceButton",onClick:this.props.onBackspacePress,"aria-label":Object(s.a)("Backspace")}))}}},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return a}));var i,s,o=n(87);function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function a(e){return o.createElement("svg",r({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 65.631 67.981",role:"presentation","aria-hidden":!0},e),i||(i=o.createElement("defs",null,o.createElement("filter",{x:-.059,y:-.079,width:1.118,height:1.158,filterUnits:"objectBoundingBox",id:"icon-email-pill-avatar_svg__a"},o.createElement("feOffset",{dy:2,in:"SourceAlpha",result:"shadowOffsetOuter1"}),o.createElement("feGaussianBlur",{stdDeviation:16,in:"shadowOffsetOuter1",result:"shadowBlurOuter1"}),o.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0.473684211 0 0 0 0 1 0 0 0 0.241258741 0",in:"shadowBlurOuter1",result:"shadowMatrixOuter1"}),o.createElement("feMerge",null,o.createElement("feMergeNode",{in:"shadowMatrixOuter1"}),o.createElement("feMergeNode",{in:"SourceGraphic"}))))),s||(s=o.createElement("g",{filter:"url(#icon-email-pill-avatar_svg__a)",transform:"translate(-1493.716 -795.144) scale(3.40907)",fill:"none",fillRule:"evenodd",stroke:"#368bd6",strokeLinecap:"round",strokeLinejoin:"round"},o.createElement("g",{transform:"translate(441.5 237.5)"},o.createElement("circle",{r:2.286,cy:5.714,cx:6.286}),o.createElement("path",{d:"M8.571 3.429v2.857a1.714 1.714 0 103.429 0v-.572a5.714 5.714 0 10-2.24 4.537"})))))}t.default="img/icon-email-pill-avatar.575ff20.svg"},function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(97),c=n(89),l=n(90),d=n(91),u=n(796),h=n(95),m=n(92),p=n(96),g=n(295);function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class v extends r.a.Component{constructor(e,t){super(e,t),s()(this,"upgradeRoom",e=>{const t=l.a.get().getRoom(this.props.roomId);h.a.createTrackedDialog("Upgrade Room Version","",u.a,{room:t})}),s()(this,"onOldRoomClicked",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:p.a.ViewRoom,room_id:this.state.oldRoomId,event_id:this.state.oldEventId,metricsTrigger:"WebPredecessorSettings",metricsViaKeyboard:"click"!==e.type}),this.props.closeSettingsFn()}),this.state={upgradeRecommendation:null};const n=l.a.get().getRoom(this.props.roomId);n.getRecommendedVersion().then(e=>{const t=n.currentState.getStateEvents(a.b.RoomTombstone,""),i={},o=n.currentState.getStateEvents(a.b.RoomCreate,""),r=o?o.getContent().predecessor:null;r&&r.room_id&&(i.oldRoomId=r.room_id,i.oldEventId=r.event_id),this.setState(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?f(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({upgraded:!(null==t||!t.getContent().replacement_room),upgradeRecommendation:e},i))})}render(){const e=l.a.get().getRoom(this.props.roomId),t=e.isSpaceRoom();let n;const i=e.currentState.getStateEvents(a.b.RoomCreate,"");let s,o;if(i&&!1===i.getContent()["m.federate"]&&(n=r.a.createElement("div",null,Object(c.a)("This room is not accessible by remote Matrix servers"))),this.state.upgradeRecommendation&&this.state.upgradeRecommendation.needsUpgrade&&!this.state.upgraded&&(s=r.a.createElement("div",null,r.a.createElement("p",{className:"mx_SettingsTab_warningText"},Object(c.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>r.a.createElement("b",null,e),i:e=>r.a.createElement("i",null,e)})),r.a.createElement(d.a,{onClick:this.upgradeRoom,kind:"primary"},t?Object(c.a)("Upgrade this space to the recommended room version"):Object(c.a)("Upgrade this room to the recommended room version")))),this.state.oldRoomId){let n;n=t?Object(c.a)("View older version of %(spaceName)s.",{spaceName:e.name}):Object(c.a)("View older messages in %(roomName)s.",{roomName:e.name}),o=r.a.createElement(d.a,{element:"a",onClick:this.onOldRoomClicked},n)}return r.a.createElement("div",{className:"mx_SettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Advanced")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},null!=e&&e.isSpaceRoom()?Object(c.a)("Space information"):Object(c.a)("Room information")),r.a.createElement("div",null,r.a.createElement("span",null,Object(c.a)("Internal room ID")),r.a.createElement(g.a,{getTextToCopy:()=>this.props.roomId},this.props.roomId)),n),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Room version")),r.a.createElement("div",null,r.a.createElement("span",null,Object(c.a)("Room version:"))," ",e.getVersion()),o,s))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(95),c=n(89),l=n(407),d=n(101),u=n(107),h=n(110),m=n(102);class p extends r.a.Component{constructor(){super(...arguments),s()(this,"targetVersion",void 0),s()(this,"state",{busy:!0}),s()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),s()(this,"onUpgradeClick",()=>{this.setState({busy:!0}),Object(l.b)(this.props.room,this.targetVersion,!1,!1).then(()=>{this.props.onFinished(!0)}).catch(e=>{a.a.createTrackedDialog("Failed to upgrade room","",u.a,{title:Object(c.a)("Failed to upgrade room"),description:e&&e.message?e.message:Object(c.a)("The room upgrade could not be completed")})}).finally(()=>{this.setState({busy:!1})})})}async componentDidMount(){const e=await this.props.room.getRecommendedVersion();this.targetVersion=e.version,this.setState({busy:!1})}render(){let e;return e=this.state.busy?r.a.createElement(m.a,null):r.a.createElement(h.a,{primaryButton:Object(c.a)("Upgrade this room to version %(version)s",{version:this.targetVersion}),primaryButtonClass:"danger",hasCancel:!0,onPrimaryButtonClick:this.onUpgradeClick,onCancel:this.onCancelClick}),r.a.createElement(d.a,{className:"mx_RoomUpgradeDialog",onFinished:this.props.onFinished,title:Object(c.a)("Upgrade Room Version"),contentId:"mx_Dialog_content",hasCancel:!0},r.a.createElement("p",null,Object(c.a)("Upgrading this room requires closing down the current instance of the room and creating a new room in its place. To give room members the best possible experience, we will:")),r.a.createElement("ol",null,r.a.createElement("li",null,Object(c.a)("Create a new room with the same name, description and avatar")),r.a.createElement("li",null,Object(c.a)("Update any local room aliases to point to the new room")),r.a.createElement("li",null,Object(c.a)("Stop users from speaking in the old version of the room, and post a message advising users to move to the new room")),r.a.createElement("li",null,Object(c.a)("Put a link back to the old room at the start of the new room so people can see old messages"))),e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return _}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(97),c=n(116),l=n(0),d=n(111),u=n(89),h=n(90),m=n(91),p=n(95),g=n(149),f=n(107),v=n(798),b=n(350),y=n(93);const S={[a.b.RoomAvatar]:{isState:!0},[a.b.RoomName]:{isState:!0},[a.b.RoomCanonicalAlias]:{isState:!0},[a.b.SpaceChild]:{isState:!0,hideForRoom:!0},[a.b.RoomHistoryVisibility]:{isState:!0,hideForSpace:!0},[a.b.RoomPowerLevels]:{isState:!0},[a.b.RoomTopic]:{isState:!0},[a.b.RoomTombstone]:{isState:!0,hideForSpace:!0},[a.b.RoomEncryption]:{isState:!0,hideForSpace:!0},[a.b.RoomServerAcl]:{isState:!0,hideForSpace:!0},[a.b.RoomPinnedEvents]:{isState:!0,hideForSpace:!0},[a.b.Reaction]:{isState:!1,hideForSpace:!0},[a.b.RoomRedaction]:{isState:!1,hideForSpace:!0},"im.vector.modular.widgets":{isState:!0,hideForSpace:!0}};function E(e,t){const n=parseInt(e);return isNaN(n)?t:n}class w extends r.a.Component{constructor(){super(...arguments),s()(this,"onUnbanClick",e=>{h.a.get().unban(this.props.member.roomId,this.props.member.userId).catch(e=>{l.a.error("Failed to unban: "+e),p.a.createTrackedDialog("Failed to unban","",f.a,{title:Object(u.a)("Error"),description:Object(u.a)("Failed to unban")})})})}render(){let e;this.props.canUnban&&(e=r.a.createElement(m.a,{className:"mx_RolesRoomSettingsTab_unbanBtn",kind:"danger_sm",onClick:this.onUnbanClick},Object(u.a)("Unban")));const t=this.props.member.name===this.props.member.userId?null:this.props.member.userId;return r.a.createElement("li",null,e,r.a.createElement("span",{title:Object(u.a)("Banned by %(displayName)s",{displayName:this.props.by})},r.a.createElement("strong",null,this.props.member.name)," ",t,this.props.reason?" "+Object(u.a)("Reason")+": "+this.props.reason:""))}}class _ extends r.a.Component{constructor(){super(...arguments),s()(this,"onRoomStateUpdate",e=>{e.roomId===this.props.roomId&&this.onThisRoomMembership()}),s()(this,"onThisRoomMembership",Object(d.throttle)(()=>{this.forceUpdate()},200,{leading:!0,trailing:!0})),s()(this,"onPowerLevelsChanged",(e,t)=>{const n=h.a.get(),i=n.getRoom(this.props.roomId).currentState.getStateEvents(a.b.RoomPowerLevels,"");let s=i&&i.getContent()||{};s=Object.assign({},s);if(t.startsWith("event_levels_"))s.events=Object.assign({},s.events||{}),s.events[t.slice("event_levels_".length)]=e;else{const n=t.split(".");let i,o=s;for(const e of n)o[e]||(o[e]={}),i=o,o=o[e];i[n[n.length-1]]=e}n.sendStateEvent(this.props.roomId,a.b.RoomPowerLevels,s).catch(e=>{l.a.error(e),p.a.createTrackedDialog("Power level requirement change failed","",f.a,{title:Object(u.a)("Error changing power level requirement"),description:Object(u.a)("An error occurred changing the room's power level requirements. Ensure you have sufficient permissions and try again.")})})}),s()(this,"onUserPowerLevelChanged",(e,t)=>{const n=h.a.get(),i=n.getRoom(this.props.roomId).currentState.getStateEvents(a.b.RoomPowerLevels,"");let s=i&&i.getContent()||{};s=Object.assign({},s),s.users||(s.users={}),s.users[t]=e,n.sendStateEvent(this.props.roomId,a.b.RoomPowerLevels,s).catch(e=>{l.a.error(e),p.a.createTrackedDialog("Power level change failed","",f.a,{title:Object(u.a)("Error changing power level"),description:Object(u.a)("An error occurred changing the user's power level. Ensure you have sufficient permissions and try again.")})})})}componentDidMount(){h.a.get().on(c.b.Update,this.onRoomStateUpdate)}componentWillUnmount(){const e=h.a.get();e&&e.removeListener(c.b.Update,this.onRoomStateUpdate)}populateDefaultPlEvents(e,t,n){for(const i of Object.keys(S))i in e||(e[i]=S[i].isState?t:n)}render(){const e=h.a.get(),t=e.getRoom(this.props.roomId),n=t.isSpaceRoom(),i=t.currentState.getStateEvents(a.b.RoomPowerLevels,""),s=i&&i.getContent()||{},o=t.currentState.mayClientSendStateEvent(a.b.RoomPowerLevels,e),c={[a.b.RoomAvatar]:n?Object(u.c)("Change space avatar"):Object(u.c)("Change room avatar"),[a.b.RoomName]:n?Object(u.c)("Change space name"):Object(u.c)("Change room name"),[a.b.RoomCanonicalAlias]:n?Object(u.c)("Change main address for the space"):Object(u.c)("Change main address for the room"),[a.b.SpaceChild]:Object(u.c)("Manage rooms in this space"),[a.b.RoomHistoryVisibility]:Object(u.c)("Change history visibility"),[a.b.RoomPowerLevels]:Object(u.c)("Change permissions"),[a.b.RoomTopic]:n?Object(u.c)("Change description"):Object(u.c)("Change topic"),[a.b.RoomTombstone]:Object(u.c)("Upgrade the room"),[a.b.RoomEncryption]:Object(u.c)("Enable room encryption"),[a.b.RoomServerAcl]:Object(u.c)("Change server ACLs"),[a.b.Reaction]:Object(u.c)("Send reactions"),[a.b.RoomRedaction]:Object(u.c)("Remove messages sent by me"),"im.vector.modular.widgets":n?null:Object(u.c)("Modify widgets")};y.b.getValue("feature_pinning")&&(c[a.b.RoomPinnedEvents]=Object(u.c)("Manage pinned events"));const l={users_default:{desc:Object(u.a)("Default role"),defaultValue:0},events_default:{desc:Object(u.a)("Send messages"),defaultValue:0,hideForSpace:!0},invite:{desc:Object(u.a)("Invite users"),defaultValue:0},state_default:{desc:Object(u.a)("Change settings"),defaultValue:50},kick:{desc:Object(u.a)("Remove users"),defaultValue:50},ban:{desc:Object(u.a)("Ban users"),defaultValue:50},redact:{desc:Object(u.a)("Remove messages sent by others"),defaultValue:50,hideForSpace:!0},"notifications.room":{desc:Object(u.a)("Notify everyone"),defaultValue:50,hideForSpace:!0}},d=s.events||{},m=s.users||{},p=E(s.ban,l.ban.defaultValue),f=E(s.users_default,l.users_default.defaultValue);let _=m[e.getUserId()];void 0===_&&(_=f),this.populateDefaultPlEvents(d,E(s.state_default,l.state_default.defaultValue),E(s.events_default,l.events_default.defaultValue));let C,O=r.a.createElement("div",null,Object(u.a)("No users have specific privileges in this room"));if(Object.keys(m).length){const e=[],t=[];Object.keys(m).forEach(n=>{if(!Number.isInteger(m[n]))return;const i=m[n]<_&&o;m[n]>f?e.push(r.a.createElement(v.a,{value:m[n],disabled:!i,label:n,key:n,powerLevelKey:n,onChange:this.onUserPowerLevelChanged})):m[n]<f&&t.push(r.a.createElement(v.a,{value:m[n],disabled:!i,label:n,key:n,powerLevelKey:n,onChange:this.onUserPowerLevelChanged}))});const n=(e,t)=>{const n=m[t.key]-m[e.key];return 0!==n?n:Object(g.a)(e.key.toLocaleLowerCase(),t.key.toLocaleLowerCase())};e.sort(n),t.sort(n),e.length&&(O=r.a.createElement(b.a,{legend:Object(u.a)("Privileged Users")},e)),t.length&&(C=r.a.createElement(b.a,{legend:Object(u.a)("Muted Users")},t))}const R=t.getMembersWithMembership("ban");let I;if(R.length){const e=_>=p;I=r.a.createElement(b.a,{legend:Object(u.a)("Banned users")},r.a.createElement("ul",null,R.map(n=>{const i=n.events.member.getContent(),s=t.getMember(n.events.member.getSender());let o=n.events.member.getSender();return s&&(o=s.name),r.a.createElement(w,{key:n.userId,canUnban:e,member:n,reason:i.reason,by:o})})))}const k=Object.keys(l).map((e,t)=>{const i=l[e];if(n&&i.hideForSpace)return null;const a=e.split(".");let c=s;for(const e of a){if(void 0===c)break;c=c[e]}const d=E(c,i.defaultValue);return r.a.createElement("div",{key:t,className:""},r.a.createElement(v.a,{label:i.desc,value:d,usersDefault:f,disabled:!o||_<d,powerLevelKey:e,onChange:this.onPowerLevelsChanged}))}).filter(Boolean);e.isRoomEncrypted(this.props.roomId)&&delete d[a.b.RoomEncryption];const x=Object.keys(d).map((e,t)=>{var i,s;if(n&&null!==(i=S[e])&&void 0!==i&&i.hideForSpace)return null;if(!n&&null!==(s=S[e])&&void 0!==s&&s.hideForRoom)return null;let a=c[e];return a=a?Object(u.a)(a):Object(u.a)("Send %(eventType)s events",{eventType:e}),r.a.createElement("div",{className:"",key:e},r.a.createElement(v.a,{label:a,value:d[e],usersDefault:f,disabled:!o||_<d[e],powerLevelKey:"event_levels_"+e,onChange:this.onPowerLevelsChanged}))}).filter(Boolean);return r.a.createElement("div",{className:"mx_SettingsTab mx_RolesRoomSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(u.a)("Roles & Permissions")),O,C,I,r.a.createElement(b.a,{legend:Object(u.a)("Permissions"),description:n?Object(u.a)("Select the roles required to change various parts of the space"):Object(u.a)("Select the roles required to change various parts of the room")},k,x))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(456),c=n(89),l=n(105),d=n(109),u=n(114);class h extends r.a.Component{constructor(e){super(e),s()(this,"onSelectChange",e=>{if("SELECT_VALUE_CUSTOM"===e.target.value)this.setState({custom:!0});else{const t=parseInt(e.target.value);this.props.onChange(t,this.props.powerLevelKey),this.setState({selectValue:t})}}),s()(this,"onCustomChange",e=>{this.setState({customValue:parseInt(e.target.value)})}),s()(this,"onCustomBlur",e=>{e.preventDefault(),e.stopPropagation(),this.props.onChange(this.state.customValue,this.props.powerLevelKey)}),s()(this,"onCustomKeyDown",e=>{switch(Object(u.a)().getAccessibilityAction(e)){case d.h.Enter:e.preventDefault(),e.stopPropagation(),e.target.blur()}}),this.state={levelRoleMap:{},options:[],customValue:this.props.value,selectValue:0}}UNSAFE_componentWillMount(){this.initStateFromProps(this.props)}UNSAFE_componentWillReceiveProps(e){this.initStateFromProps(e)}initStateFromProps(e){const t=a.a(e.usersDefault),n=Object.keys(t).filter(t=>void 0===t||parseInt(t)<=e.maxValue||parseInt(t)==e.value).map(e=>parseInt(e)),i=void 0===t[e.value];this.setState({levelRoleMap:t,options:n,custom:i,customLevel:e.value,selectValue:i?"SELECT_VALUE_CUSTOM":e.value})}render(){let e;const t=void 0===this.props.label?Object(c.a)("Power level"):this.props.label;if(this.state.custom)e=r.a.createElement(l.a,{type:"number",label:t,max:this.props.maxValue,onBlur:this.onCustomBlur,onKeyDown:this.onCustomKeyDown,onChange:this.onCustomChange,value:String(this.state.customValue),disabled:this.props.disabled});else{const n=this.state.options.map(e=>({value:String(e),text:a.b(e,this.props.usersDefault)}));n.push({value:"SELECT_VALUE_CUSTOM",text:Object(c.a)("Custom level")});const i=n.map(e=>r.a.createElement("option",{value:e.value,key:e.value},e.text));e=r.a.createElement(l.a,{element:"select",label:t,onChange:this.onSelectChange,value:String(this.state.selectValue),disabled:this.props.disabled},i)}return r.a.createElement("div",{className:"mx_PowerSelector"},e)}}s()(h,"defaultProps",{maxValue:1/0,usersDefault:0})},function(e,t,n){"use strict";var i=n(99),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(89),d=n(91);t.a=e=>{let{avatarUrl:t,avatarAltText:n,avatarName:i,uploadAvatar:a,removeAvatar:u}=e;const[h,m]=Object(o.useState)(!1),p={onMouseEnter:()=>m(!0),onMouseLeave:()=>m(!1)};let g,f,v=r.a.createElement(d.a,s()({element:"div",onClick:a,className:"mx_AvatarSetting_avatarPlaceholder"},p));t&&(v=r.a.createElement(d.a,s()({element:"img",src:t,alt:n,"aria-label":n,onClick:a},p))),a&&(g=r.a.createElement(d.a,s()({onClick:a,className:"mx_AvatarSetting_uploadButton"},p))),t&&u&&(f=r.a.createElement(d.a,{onClick:u,kind:"link_sm"},Object(l.a)("Remove")));const b=c()({mx_AvatarSetting_avatar:!0,mx_AvatarSetting_avatar_hovering:h&&a});return r.a.createElement("div",{className:b},v,r.a.createElement("div",{className:"mx_AvatarSetting_hover"},r.a.createElement("div",{className:"mx_AvatarSetting_hoverBg"}),r.a.createElement("span",null,Object(l.a)("Upload"))),g,f)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(87);const s=(e,t,n)=>{const[s,o]=Object(i.useState)(e);return[s,async i=>{o(i);try{await t(i)}catch(t){o(e()),n(t)}}]}},function(e,t,n){"use strict";var i=n(99),s=n.n(i),o=n(103),r=n.n(o),a=n(87),c=n.n(a),l=n(94),d=n.n(l);const u=["children","className"];t.a=e=>{let{children:t,className:n}=e,i=r()(e,u);return c.a.createElement("a",s()({target:"_blank",rel:"noreferrer noopener"},i,{className:d()("mx_ExternalLink",n)}),t,c.a.createElement("i",{className:"mx_ExternalLink_icon"}))}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return it}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(97),c=n(244),l=n(18),d=n(165),u=n(108),h=n(93),m=n(459),p=n(460),g=Object(o.forwardRef)((e,t)=>{let{mxEvent:n,children:i}=e;const s=n.getContent().body;return r.a.createElement("div",{className:"mx_UnknownBody",ref:t},s,i)}),f=n(583),v=n(100),b=n(973),y=n(585),S=n(303),E=n(848),w=n(782),_=n(153);class C extends r.a.PureComponent{render(){return!this.props.forExport&&Object(_.l)(this.props.mxEvent)?r.a.createElement(w.a,this.props):r.a.createElement(E.a,this.props)}}var O=n(99),R=n.n(O),I=n(760),k=n(0),x=n(89),T=n(170),j=n(128),N=n(432),P=n(409),D=n(106);class A extends r.a.PureComponent{constructor(e){super(e),s()(this,"context",void 0),s()(this,"videoRef",r.a.createRef()),s()(this,"sizeWatcher",void 0),s()(this,"videoOnPlay",async()=>{this.hasContentUrl()||this.state.fetchingData||this.state.error||(this.setState({fetchingData:!0}),this.props.mediaEventHelper.media.isEncrypted?(this.setState({decryptedUrl:await this.props.mediaEventHelper.sourceUrl.value,decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value,fetchingData:!1},()=>{this.videoRef.current&&this.videoRef.current.play()}),this.props.onHeightChanged()):this.setState({error:"No file given in content"}))}),s()(this,"getFileBody",()=>this.props.forExport?null:this.showFileBody&&r.a.createElement(S.a,R()({},this.props,{showGenericPlaceholder:!1}))),this.state={fetchingData:!1,decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,error:null,posterLoading:!1,blurhashUrl:null}}getContentUrl(){var e;const t=this.props.mxEvent.getContent();if(this.props.forExport)return(null===(e=t.file)||void 0===e?void 0:e.url)||t.url;const n=Object(j.a)(t);return n.isEncrypted?this.state.decryptedUrl:n.srcHttp}hasContentUrl(){const e=this.getContentUrl();return e&&!e.startsWith("data:")}getThumbUrl(){if(this.props.forExport)return null;const e=this.props.mxEvent.getContent(),t=Object(j.a)(e);return t.isEncrypted&&this.state.decryptedThumbnailUrl?this.state.decryptedThumbnailUrl:this.state.posterLoading?this.state.blurhashUrl:t.hasThumbnail?t.thumbnailHttp:null}loadBlurhash(){var e;const t=null===(e=this.props.mxEvent.getContent())||void 0===e?void 0:e.info;if(!t[N.a])return;const n=document.createElement("canvas"),{w:i,h:s}=Object(P.b)(h.b.getValue("Images.size"),{w:t.w,h:t.h});n.width=i,n.height=s;const o=Object(I.decode)(t[N.a],i,s),r=n.getContext("2d"),a=r.createImageData(i,s);a.data.set(o),r.putImageData(a,0,0),this.setState({blurhashUrl:n.toDataURL(),posterLoading:!0});const c=this.props.mxEvent.getContent(),l=Object(j.a)(c);if(l.hasThumbnail){const e=new Image;e.onload=()=>{this.setState({posterLoading:!1})},e.src=l.thumbnailHttp}}async componentDidMount(){if(this.sizeWatcher=h.b.watchSetting("Images.size",null,()=>{this.forceUpdate()}),this.loadBlurhash(),this.props.mediaEventHelper.media.isEncrypted&&null===this.state.decryptedUrl)try{const t=h.b.getValue("autoplayVideo"),n=await this.props.mediaEventHelper.thumbnailUrl.value;if(t)k.a.log("Preloading video"),this.setState({decryptedUrl:await this.props.mediaEventHelper.sourceUrl.value,decryptedThumbnailUrl:n,decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value}),this.props.onHeightChanged();else{var e;k.a.log("NOT preloading video");const t=this.props.mxEvent.getContent();let i=null==t||null===(e=t.info)||void 0===e?void 0:e.mimetype;"video/quicktime"==i&&(i="video/mp4"),this.setState({decryptedUrl:`data:${i},`,decryptedThumbnailUrl:n||`data:${i},`,decryptedBlob:null})}}catch(e){k.a.warn("Unable to decrypt attachment: ",e),this.setState({error:e})}}componentWillUnmount(){h.b.unwatchSetting(this.sizeWatcher)}get showFileBody(){return this.context.timelineRenderingType!==D.a.Room&&this.context.timelineRenderingType!==D.a.Pinned&&this.context.timelineRenderingType!==D.a.Search}render(){var e,t,i,s;const o=this.props.mxEvent.getContent(),a=h.b.getValue("autoplayVideo");let c;null!==(e=o.info)&&void 0!==e&&e.w&&null!==(t=o.info)&&void 0!==t&&t.h&&(c=`${o.info.w}/${o.info.h}`);const{w:l,h:d}=Object(P.b)(h.b.getValue("Images.size"),{w:null===(i=o.info)||void 0===i?void 0:i.w,h:null===(s=o.info)||void 0===s?void 0:s.h}),u=r.a.createElement("div",{style:{width:l,height:d}});if(null!==this.state.error)return r.a.createElement("span",{className:"mx_MVideoBody"},r.a.createElement("img",{src:n(304).default,width:"16",height:"16"}),Object(x.a)("Error decrypting video"));if(!this.props.forExport&&void 0!==o.file&&null===this.state.decryptedUrl&&a)return r.a.createElement("span",{className:"mx_MVideoBody"},r.a.createElement("div",{className:"mx_MVideoBody_container",style:{maxWidth:l,maxHeight:d,aspectRatio:c}},r.a.createElement(T.a,null)),u);const m=this.getContentUrl(),p=this.getThumbUrl();let g=null,f="metadata";o.info&&p&&(g=p,f="none");const v=this.getFileBody();return r.a.createElement("span",{className:"mx_MVideoBody"},r.a.createElement("div",{className:"mx_MVideoBody_container",style:{maxWidth:l,maxHeight:d,aspectRatio:c}},r.a.createElement("video",{className:"mx_MVideoBody",ref:this.videoRef,src:m,title:o.body,controls:!0,controlsList:"nodownload",preload:f,muted:a,autoPlay:a,poster:g,onPlay:this.videoOnPlay}),u),v)}}s()(A,"contextType",D.b);var M=n(140);class U extends y.a{constructor(){super(...arguments),s()(this,"onClick",e=>{e.preventDefault(),this.state.showImage||this.showImage()})}wrapImage(e,t){let n=null;return this.state.showImage||(n=this.onClick),r.a.createElement("div",{className:"mx_MStickerBody_wrapper",onClick:n}," ",t," ")}getPlaceholder(e,t){var i;return null!==(i=this.props.mxEvent.getContent().info)&&void 0!==i&&i[N.a]?super.getPlaceholder(e,t):r.a.createElement("img",{className:"mx_MStickerBody_placeholder",src:n(1372).default,width:"80",height:"80",onMouseEnter:this.onImageEnter,onMouseLeave:this.onImageLeave})}getTooltip(){const e=this.props.mxEvent&&this.props.mxEvent.getContent();return e&&e.body&&e.info&&e.info.w?r.a.createElement("div",{style:{left:e.info.w+"px"},className:"mx_MStickerBody_tooltip"},r.a.createElement(M.b,{label:e.body})):null}getFileBody(){return null}getBanner(e){return null}}var L=n(430),F=n(186),B=n(95),K=n(199),V=n(236),W=n(101),H=n(94),q=n.n(H),$=n(503),G=n.n($),z=n(120),J=n(118),Y=n(205),Q=n(502);const X=e=>{let{id:t,centerGeoUri:n,onError:i,interactive:s,bounds:r}=e;const a="mx_Map_"+t,c=Object(o.useContext)(v.a),l=Object(J.b)(c,z.ClientEvent.ClientWellKnown,e=>{var t;return null===(t=Object(Y.h)(e))||void 0===t?void 0:t.map_style_url}),d=(e=>{let{interactive:t,bodyId:n,onError:i}=e;const[s,r]=Object(o.useState)();return Object(o.useEffect)(()=>{try{r(Object(Q.a)(t,n,i))}catch(e){i(e)}return()=>{s&&(s.remove(),r(void 0))}},[t,n,i]),s})({interactive:s,bodyId:a,onError:i});return Object(o.useEffect)(()=>{l&&d&&d.setStyle(l)},[l,d]),Object(o.useEffect)(()=>{if(d&&n)try{const e=Object(K.i)(n);d.setCenter({lon:e.longitude,lat:e.latitude})}catch(e){k.a.error("Could not set map center")}},[d,n]),Object(o.useEffect)(()=>{if(d&&r)try{const e=new G.a.LngLatBounds([r.west,r.south],[r.east,r.north]);d.fitBounds(e,{padding:100,maxZoom:15})}catch(e){k.a.error("Invalid map bounds")}},[d,r]),{map:d,bodyId:a}};var Z=e=>{let{bounds:t,centerGeoUri:n,children:i,className:s,id:o,interactive:a,onError:c,onClick:l}=e;const{map:d,bodyId:u}=X({centerGeoUri:n,onError:c,id:o,interactive:a,bounds:t});return r.a.createElement("div",{className:q()("mx_Map",s),id:u,onClick:e=>{e.target.classList.contains("maplibregl-ctrl-attrib-button")||l&&l()}},!!i&&!!d&&i({map:d}))},ee=n(784);var te,ne=e=>{let{id:t,map:n,geoUri:i,roomMember:s,useMemberColor:a,tooltip:c}=e;const{onElementRef:l}=((e,t)=>{const[n,i]=Object(o.useState)(),s=Object(o.useCallback)(s=>{if(n||!s)return;const o=Object(K.i)(t),r=Object(K.c)(o,s);r.addTo(e),i(r)},[n,t,e]);return Object(o.useEffect)(()=>{if(n){const e=Object(K.i)(t);n.setLngLat({lon:e.longitude,lat:e.latitude})}},[n,t]),Object(o.useEffect)(()=>()=>{n&&n.remove()},[n]),{marker:n,onElementRef:s}})(n,i);return r.a.createElement("span",null,r.a.createElement(ee.a,{ref:l,id:t,roomMember:s,useMemberColor:a,tooltip:c}))},ie=n(91);function se(){return(se=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function oe(e){return o.createElement("svg",se({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0},e),te||(te=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M8.783 2.783a.783.783 0 10-1.566 0v4.434H2.783a.783.783 0 000 1.566h4.434v4.435a.783.783 0 001.566 0V8.783h4.435a.783.783 0 000-1.566H8.783V2.783z",fill:"currentColor"})))}var re;function ae(){return(ae=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function ce(e){return o.createElement("svg",ae({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0},e),re||(re=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M2 8c0-.432.35-.783.783-.783h10.434a.783.783 0 110 1.566H2.783A.783.783 0 012 8z",fill:"currentColor"})))}var le=e=>{let{map:t}=e;return r.a.createElement("div",{className:"mx_ZoomButtons"},r.a.createElement(ie.a,{onClick:()=>{t.zoomIn()},"data-test-id":"map-zoom-in-button",title:Object(x.a)("Zoom in"),className:"mx_ZoomButtons_button"},r.a.createElement(oe,{className:"mx_ZoomButtons_icon"})),r.a.createElement(ie.a,{onClick:()=>{t.zoomOut()},"data-test-id":"map-zoom-out-button",title:Object(x.a)("Zoom out"),className:"mx_ZoomButtons_button"},r.a.createElement(ce,{className:"mx_ZoomButtons_icon"})))};class de extends r.a.Component{constructor(e){super(e),s()(this,"getBodyId",()=>"mx_LocationViewDialog_"+this.props.mxEvent.getId()),s()(this,"onError",e=>{this.setState({error:e})}),this.state={error:void 0}}render(){const{mxEvent:e}=this.props,t=Object(K.f)(e.getContent())?e.sender:void 0,n=Object(K.g)(e);return r.a.createElement(W.a,{className:"mx_LocationViewDialog",onFinished:this.props.onFinished,fixedWidth:!1},r.a.createElement(Z,{id:this.getBodyId(),centerGeoUri:n,onError:this.onError,interactive:!0,className:"mx_LocationViewDialog_map"},e=>{let{map:i}=e;return r.a.createElement(r.a.Fragment,null,r.a.createElement(ne,{map:i,id:this.getBodyId()+"-marker",geoUri:n,roomMember:t}),r.a.createElement(le,{map:i}))}))}}class ue extends r.a.Component{constructor(e){super(e),s()(this,"context",void 0),s()(this,"mapId",void 0),s()(this,"onClick",()=>{B.a.createTrackedDialog("Location View","",de,{matrixClient:this.context,mxEvent:this.props.mxEvent},"mx_LocationViewDialog_wrapper",!1,!0)}),s()(this,"onError",e=>{this.setState({error:e})});const t=`${e.mxEvent.getId()}_${Object(F.b)(8)}`;this.mapId="mx_MLocationBody_"+t,this.state={error:void 0}}render(){return this.state.error?r.a.createElement(he,{error:this.state.error,event:this.props.mxEvent}):r.a.createElement(me,{mxEvent:this.props.mxEvent,mapId:this.mapId,onError:this.onError,tooltip:Object(x.a)("Expand map"),onClick:this.onClick})}}s()(ue,"contextType",v.a);const he=e=>{var t,n;let{error:i,event:s}=e;const o=null==i?void 0:i.message,a=`${Object(x.a)("Unable to load map")}: ${Object(K.e)(o)}`,c=Object(K.f)(s.getContent())?Object(x.a)("Shared their location: ")+(null===(t=s.getContent())||void 0===t?void 0:t.body):Object(x.a)("Shared a location: ")+(null===(n=s.getContent())||void 0===n?void 0:n.body);return r.a.createElement("div",{className:"mx_EventTile_body mx_MLocationBody"},r.a.createElement("span",{className:o!==K.a.MapStyleUrlNotConfigured?"mx_EventTile_tileError":""},a),r.a.createElement("br",null),c)},me=e=>{let{mxEvent:t,mapId:n,tooltip:i,onError:s,onClick:o}=e;const a=Object(K.f)(t.getContent())?t.sender:void 0,c=Object(K.g)(t),l=r.a.createElement(Z,{id:n,centerGeoUri:c,onClick:o,onError:s,className:"mx_MLocationBody_map"},e=>{let{map:t}=e;return r.a.createElement(ne,{map:t,id:n+"-marker",geoUri:c,roomMember:a})});return r.a.createElement("div",{className:"mx_MLocationBody"},i?r.a.createElement(V.a,{label:i,alignment:M.a.InnerBottom,maxParentWidth:450},l):l)};class pe extends r.a.Component{constructor(){super(...arguments),s()(this,"onAllowClick",e=>{e.preventDefault(),e.stopPropagation();const t=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;localStorage.setItem(t,"true"),this.props.onMessageAllowed()})}render(){return r.a.createElement("div",{className:"mx_MjolnirBody"},r.a.createElement("i",null,Object(x.a)("You have ignored this user, so their message is hidden. <a>Show anyways.</a>",{},{a:e=>r.a.createElement(ie.a,{kind:"link_inline",onClick:this.onAllowClick},e)})))}}var ge=n(222);let fe;!function(e){e.Loading="Loading",e.Error="Error",e.Stopped="Stopped",e.Active="Active"}(fe||(fe={}));var ve=n(103),be=n.n(ve),ye=n(305),Se=n(785),Ee=n(133);const we=["beacon","displayStatus","displayLiveTimeRemaining","label","className","children","withIcon"],_e=e=>{let{beacon:t}=e;const n=Object(Ee.k)(new Date(Object(ge.c)(t)));return r.a.createElement("span",{className:"mx_BeaconStatus_expiryTime"},Object(x.a)("Live until %(expiryTime)s",{expiryTime:n}))};var Ce,Oe,Re=e=>{let{beacon:t,displayStatus:n,displayLiveTimeRemaining:i,label:s,className:o,children:a,withIcon:c}=e,l=be()(e,we);const d=n===fe.Loading||n===fe.Stopped;return r.a.createElement("div",R()({},l,{className:q()("mx_BeaconStatus","mx_BeaconStatus_"+n,o)}),c&&r.a.createElement(ye.a,{className:"mx_BeaconStatus_icon",withError:n===fe.Error,isIdle:d}),r.a.createElement("div",{className:"mx_BeaconStatus_description"},n===fe.Loading&&r.a.createElement("span",null,Object(x.a)("Loading live location...")),n===fe.Stopped&&r.a.createElement("span",null,Object(x.a)("Live location ended")),n===fe.Error&&r.a.createElement("span",null,Object(x.a)("Live location error")),n===fe.Active&&t&&r.a.createElement(r.a.Fragment,null,r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_BeaconStatus_label"},s),i?r.a.createElement(Se.a,{beacon:t}):r.a.createElement(_e,{beacon:t})))),a)},Ie=n(542);function ke(){return(ke=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function xe(e){return o.createElement("svg",ke({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 848 556",role:"presentation","aria-hidden":!0},e),o.createElement("mask",{id:"map_svg__a",style:{maskType:"alpha"},maskUnits:"userSpaceOnUse",x:0,y:0,width:848,height:556},Ce||(Ce=o.createElement("path",{fill:"currentColor",d:"M0 0h847.147v555.685H0z"}))),Oe||(Oe=o.createElement("g",{mask:"url(#map_svg__a)"},o.createElement("circle",{cx:424.936,cy:277.842,r:495.758}),o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M424.935 874.689c329.63 0 596.845-267.217 596.845-596.847S754.565-319.005 424.935-319.005c-329.629 0-596.846 267.218-596.846 596.847 0 329.63 267.217 596.847 596.846 596.847zM-46.544 6.905L920.48 442.347l-47.338 105.126-434.953-195.856-219.202 482.882-104.982-47.656L333.061 304.28-93.881 112.031-46.544 6.905z",fill:"currentColor"}))))}var Te=n(102);const je=["className","isLoading","children"];var Ne=e=>{let{className:t,isLoading:n,children:i}=e,s=be()(e,je);return r.a.createElement("div",R()({className:q()("mx_MapFallback",t)},s),r.a.createElement(xe,{className:"mx_MapFallback_bg"}),n?r.a.createElement(Te.a,{h:32,w:32}):r.a.createElement(Ie.a,{className:"mx_MapFallback_icon"}),i)};const Pe=["beacon","displayStatus"];var De=e=>{let{beacon:t,displayStatus:n}=e,i=be()(e,Pe);const{hasLocationPublishError:s,hasStopSharingError:o,stoppingInProgress:a,onStopSharing:c,onResetLocationPublishError:l}=Object(ge.j)([null==t?void 0:t.identifier]),d=s||o?fe.Error:n;return r.a.createElement(Re,R()({beacon:t,displayStatus:d,label:Object(x.a)("Live location enabled"),displayLiveTimeRemaining:!0},i),d===fe.Active&&r.a.createElement(ie.a,{"data-test-id":"beacon-status-stop-beacon",kind:"link",onClick:c,className:"mx_OwnBeaconStatus_button mx_OwnBeaconStatus_destructiveButton",disabled:a},Object(x.a)("Stop")),s&&r.a.createElement(ie.a,{"data-test-id":"beacon-status-reset-wire-error",kind:"link",onClick:l,className:"mx_OwnBeaconStatus_button mx_OwnBeaconStatus_destructiveButton"},Object(x.a)("Retry")),o&&r.a.createElement(ie.a,{"data-test-id":"beacon-status-stop-beacon-retry",kind:"link",onClick:c,className:"mx_OwnBeaconStatus_button mx_OwnBeaconStatus_destructiveButton"},Object(x.a)("Retry")))},Ae=n(543);var Me=e=>{let{map:t,beacon:n,tooltip:i}=e;const s=Object(J.b)(n,z.BeaconEvent.LocationUpdate,()=>n.latestLocationState),a=Object(o.useContext)(v.a).getRoom(n.roomId);if(!s||!n.isLive)return null;const c=null==s?void 0:s.uri,d=n.beaconInfo.assetType===l.a.Self?a.getMember(n.beaconInfoOwner):void 0;return r.a.createElement(ne,{map:t,id:n.identifier,geoUri:c,roomMember:d,tooltip:i,useMemberColor:!0})};var Ue,Le=n(786),Fe=n(317),Be=n(633),Ke=n(136);function Ve(){return(Ve=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function We(e){return o.createElement("svg",Ve({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 11 10",role:"presentation","aria-hidden":!0},e),Ue||(Ue=o.createElement("path",{d:"M8.5 5.5v3a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1h3M7 .5h3v3M4.5 6L10 .5",fill:"none",fillRule:"evenodd",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})))}var He=n(295);var qe=e=>{let{latestLocationState:t}=e;const[n,i]=Object(o.useState)(null);if(Object(o.useEffect)(()=>{if(!t)return;const e=Object(K.i)(t.uri);i(e)},[t]),!t||!n)return null;const s=`${n.latitude},${n.longitude}`,a=Object(K.h)(n);return r.a.createElement(r.a.Fragment,null,r.a.createElement(V.a,{label:Object(x.a)("Open in OpenStreetMap")},r.a.createElement("a",{"data-test-id":"open-location-in-osm",href:a,target:"_blank",rel:"noreferrer noopener"},r.a.createElement(We,{className:"mx_ShareLatestLocation_icon"}))),r.a.createElement(He.a,{className:"mx_ShareLatestLocation_copy",border:!1,getTextToCopy:()=>s}))};var $e=e=>{let{beacon:t}=e;const n=Object(J.b)(t,z.BeaconEvent.LocationUpdate,()=>t.latestLocationState),i=Object(o.useContext)(v.a).getRoom(t.roomId);if(!n||!t.isLive)return null;const s=t.beaconInfo.assetType===l.a.Self,a=s?i.getMember(t.beaconInfoOwner):void 0,c=Object(Be.a)(n.timestamp);return r.a.createElement("li",{className:"mx_BeaconListItem"},s?r.a.createElement(Ke.a,{className:"mx_BeaconListItem_avatar",member:a,height:32,width:32}):r.a.createElement(ye.a,{className:"mx_BeaconListItem_avatarIcon"}),r.a.createElement("div",{className:"mx_BeaconListItem_info"},r.a.createElement(Re,{className:"mx_BeaconListItem_status",beacon:t,label:(null==a?void 0:a.name)||t.beaconInfo.description||t.beaconInfoOwner,displayStatus:fe.Active},r.a.createElement(qe,{latestLocationState:n})),r.a.createElement("span",{className:"mx_BeaconListItem_lastUpdated"},Object(x.a)("Updated %(humanizedUpdateTime)s",{humanizedUpdateTime:c}))))};var Ge=e=>{let{beacons:t,requestClose:n}=e;return r.a.createElement("div",{className:"mx_DialogSidebar"},r.a.createElement("div",{className:"mx_DialogSidebar_header"},r.a.createElement(Fe.a,{size:"h4"},Object(x.a)("View List")),r.a.createElement(ie.a,{className:"mx_DialogSidebar_closeButton",onClick:n,title:Object(x.a)("Close sidebar"),"data-test-id":"dialog-sidebar-close"},r.a.createElement(Le.a,{className:"mx_DialogSidebar_closeButtonIcon"}))),r.a.createElement("ol",{className:"mx_DialogSidebar_list"},t.map(e=>r.a.createElement($e,{key:e.identifier,beacon:e}))))},ze=n(347),Je=n(196);var Ye=e=>{let{roomId:t}=e;const n=(e=>Object(J.b)(Je.a.instance,ze.b.LivenessChange,()=>{const[t]=ze.a.instance.getLiveBeaconIds(e);return ze.a.instance.getBeaconById(t)}))(t),i=Object(o.useContext)(v.a).getRoom(t);if(null==n||!n.isLive)return null;const s=n.beaconInfo.assetType===l.a.Self,a=s?i.getMember(n.beaconInfoOwner):void 0;return r.a.createElement("div",{className:"mx_DialogOwnBeaconStatus"},s?r.a.createElement(Ke.a,{className:"mx_DialogOwnBeaconStatus_avatar",member:a,height:32,width:32}):r.a.createElement(ye.a,{className:"mx_DialogOwnBeaconStatus_avatarIcon"}),r.a.createElement(De,{className:"mx_DialogOwnBeaconStatus_status",beacon:n,displayStatus:fe.Active}))};var Qe=e=>{let{beacon:t}=e;const n=(e=>{const t=Object(o.useContext)(v.a);if(e.beaconInfo.assetType!==l.a.Self)return e.beaconInfo.description;const n=t.getRoom(e.roomId),i=null==n?void 0:n.getMember(e.beaconInfoOwner);return(null==i?void 0:i.rawDisplayName)||e.beaconInfoOwner})(t);return r.a.createElement("div",{className:"mx_BeaconStatusTooltip"},r.a.createElement(Re,{beacon:t,label:n,displayStatus:fe.Active,displayLiveTimeRemaining:!0,className:"mx_BeaconStatusTooltip_inner"},r.a.createElement(qe,{latestLocationState:t.latestLocationState})))};const Xe=(e,t)=>{var n;const i=Object(o.useRef)((e=>{const t=e.filter(e=>!!e.latestLocationState).map(e=>Object(K.i)(e.latestLocationState.uri));if(!t.length)return;const n=[...t].sort((e,t)=>t.latitude-e.latitude),i=[...t].sort((e,t)=>t.longitude-e.longitude);return{north:n[0].latitude,south:n[n.length-1].latitude,east:i[0].longitude,west:i[i.length-1].longitude}})(e)),s=Object(o.useRef)((null==t||null===(n=t.latestLocationState)||void 0===n?void 0:n.uri)||(e=>{if(e)return Object(ge.f)({latitude:(e.north+e.south)/2,longitude:(e.east+e.west)/2,timestamp:Date.now()})})(i.current));return{bounds:i.current,centerGeoUri:s.current}};var Ze=e=>{let{focusBeacon:t,roomId:n,matrixClient:i,onFinished:s}=e;const a=((e,t)=>{const n=t.getRoom(e);return Object(J.b)(n.currentState,z.RoomStateEvent.BeaconLiveness,()=>{var e;return null===(e=n.currentState)||void 0===e?void 0:e.liveBeaconIds.map(e=>n.currentState.beacons.get(e))})})(n,i),[c,l]=Object(o.useState)(!1),{bounds:d,centerGeoUri:u}=Xe(a,t);return r.a.createElement(W.a,{className:"mx_BeaconViewDialog",onFinished:s,fixedWidth:!1},r.a.createElement(v.a.Provider,{value:i},null!=a&&a.length?r.a.createElement(Z,{id:"mx_BeaconViewDialog",bounds:d,centerGeoUri:u,interactive:!0,className:"mx_BeaconViewDialog_map"},e=>{let{map:t}=e;return r.a.createElement(r.a.Fragment,null,a.map(e=>r.a.createElement(Me,{key:e.identifier,map:t,beacon:e,tooltip:r.a.createElement(Qe,{beacon:e})})),r.a.createElement(le,{map:t}))}):r.a.createElement(Ne,{"data-test-id":"beacon-view-dialog-map-fallback",className:"mx_BeaconViewDialog_map"},r.a.createElement("span",{className:"mx_BeaconViewDialog_mapFallbackMessage"},Object(x.a)("No live locations")),r.a.createElement(ie.a,{kind:"primary",onClick:s,"data-test-id":"beacon-view-dialog-fallback-close"},Object(x.a)("Close"))),c?r.a.createElement(Ge,{beacons:a,requestClose:()=>l(!1)}):r.a.createElement(ie.a,{kind:"primary",onClick:()=>l(!0),"data-test-id":"beacon-view-dialog-open-sidebar",className:"mx_BeaconViewDialog_viewListButton"},r.a.createElement(Ae.a,{height:12})," ",Object(x.a)("View list")),r.a.createElement(Ye,{roomId:n})))};var et=r.a.forwardRef((e,t)=>{let{mxEvent:n}=e;const{beacon:i,isLive:s,latestLocationState:a}=(e=>{const t=Object(ge.i)(e),n=Object(J.b)(t,z.BeaconEvent.LivenessChange,()=>null==t?void 0:t.isLive),i=Object(J.b)(t,z.BeaconEvent.LocationUpdate,()=>null==t?void 0:t.latestLocationState);if(!t)return{};const{description:s}=t.beaconInfo;return{beacon:t,description:s,isLive:n,latestLocationState:i}})(n),c=(e=>{const[t,n]=Object(o.useState)(`${e}_${Object(F.b)(8)}`);return Object(o.useEffect)(()=>{n(`${e}_${Object(F.b)(8)}`)},[e]),t})(n.getId()),l=Object(o.useContext)(v.a),[d,u]=Object(o.useState)(),h=((e,t,n)=>n?fe.Error:e?t?t?fe.Active:void 0:fe.Loading:fe.Stopped)(s,a,d),m=Object(K.f)(n.getContent())?n.sender:void 0,p=(null==i?void 0:i.beaconInfoOwner)===l.getUserId();return r.a.createElement("div",{className:"mx_MBeaconBody",ref:t},h===fe.Active?r.a.createElement(Z,{id:c,centerGeoUri:a.uri,onError:u,onClick:()=>{h===fe.Active&&B.a.createTrackedDialog("Beacon View","",Ze,{roomId:n.getRoomId(),matrixClient:l,focusBeacon:i},"mx_BeaconViewDialog_wrapper",!1,!0)},className:"mx_MBeaconBody_map"},e=>{let{map:t}=e;return r.a.createElement(ne,{map:t,id:c+"-marker",geoUri:a.uri,roomMember:m,useMemberColor:!0})}):r.a.createElement(Ne,{isLoading:h===fe.Loading,className:"mx_MBeaconBody_map mx_MBeaconBody_mapFallback"}),p?r.a.createElement(De,{className:"mx_MBeaconBody_chin",beacon:i,displayStatus:h,withIcon:!0}):r.a.createElement(Re,{className:"mx_MBeaconBody_chin",beacon:i,displayStatus:h,label:Object(x.a)("View live location"),withIcon:!0}))});function tt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function nt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tt(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class it extends r.a.Component{constructor(e,t){super(e),s()(this,"body",Object(o.createRef)()),s()(this,"mediaHelper",void 0),s()(this,"context",void 0),s()(this,"getEventTileOps",()=>{var e,t;return(null===(e=this.body.current)||void 0===e||null===(t=e.getEventTileOps)||void 0===t?void 0:t.call(e))||null}),s()(this,"onDecrypted",()=>{var e;f.a.isEligible(this.props.mxEvent)&&(null===(e=this.mediaHelper)||void 0===e||e.destroy(),this.mediaHelper=new f.a(this.props.mxEvent))}),s()(this,"onTileUpdate",()=>{this.forceUpdate()}),f.a.isEligible(this.props.mxEvent)&&(this.mediaHelper=new f.a(this.props.mxEvent))}componentDidMount(){this.props.mxEvent.addListener(u.c.Decrypted,this.onDecrypted)}componentWillUnmount(){var e;this.props.mxEvent.removeListener(u.c.Decrypted,this.onDecrypted),null===(e=this.mediaHelper)||void 0===e||e.destroy()}componentDidUpdate(e){var t;this.props.mxEvent!==e.mxEvent&&f.a.isEligible(this.props.mxEvent)&&(null===(t=this.mediaHelper)||void 0===t||t.destroy(),this.mediaHelper=new f.a(this.props.mxEvent))}get bodyTypes(){return nt({[a.c.Text]:b.a,[a.c.Notice]:b.a,[a.c.Emote]:b.a,[a.c.Image]:y.a,[a.c.File]:S.a,[a.c.Audio]:C,[a.c.Video]:A},this.props.overrideBodyTypes||{})}get evTypes(){return nt({[a.b.Sticker]:U,[d.M_POLL_START.name]:L.a,[d.M_POLL_START.altName]:L.a,[c.b.name]:et,[c.b.altName]:et},this.props.overrideEventTypes||{})}getMediaHelper(){return this.mediaHelper}render(){const e=this.props.mxEvent.getContent(),t=this.props.mxEvent.getType(),n=e.msgtype;let i=p.a;if(this.props.mxEvent.isRedacted()||(i=t&&this.evTypes[t]?this.evTypes[t]:n&&this.bodyTypes[n]?this.bodyTypes[n]:e.url?this.bodyTypes[a.c.File]:g,(l.c.matches(t)||t===a.b.RoomMessage&&n===a.c.Location)&&(i=ue)),h.b.getValue("feature_mjolnir")){const e=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;if(!("true"===localStorage.getItem(e))){const e=this.props.mxEvent.getSender().split(":").slice(1).join(":"),t=m.a.sharedInstance().isUserBanned(this.props.mxEvent.getSender()),n=m.a.sharedInstance().isServerBanned(e);(t||n)&&(i=pe)}}return i?r.a.createElement(i,{ref:this.body,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,forExport:this.props.forExport,maxImageHeight:this.props.maxImageHeight,replacingEventId:this.props.replacingEventId,editState:this.props.editState,onHeightChanged:this.props.onHeightChanged,onMessageAllowed:this.onTileUpdate,permalinkCreator:this.props.permalinkCreator,mediaEventHelper:this.mediaHelper,getRelationsForEvent:this.props.getRelationsForEvent,isSeeingThroughMessageHiddenForModeration:this.props.isSeeingThroughMessageHiddenForModeration}):null}}s()(it,"contextType",v.a)},function(e,t,n){"use strict";n.d(t,"a",(function(){return Oe})),n.d(t,"b",(function(){return Te}));var i=n(88),s=n.n(i),o=n(94),r=n.n(o),a=n(87),c=n.n(a),l=n(754),d=n.n(l),u=n(0);class h{constructor(){s()(this,"stack",[]),s()(this,"newlyTypedCharCount",0),s()(this,"currentIndex",-1),s()(this,"changedSinceLastPush",!1),s()(this,"lastCaret",null),s()(this,"nonWordBoundarySinceLastPush",!1),s()(this,"addedSinceLastPush",!1),s()(this,"removedSinceLastPush",!1)}clear(){this.stack=[],this.newlyTypedCharCount=0,this.currentIndex=-1,this.changedSinceLastPush=!1,this.lastCaret=null,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}shouldPush(e,t){if(t&&("insertText"===e||"deleteContentForward"===e||"deleteContentBackward"===e)){if(t.added&&(this.addedSinceLastPush=!0),t.removed&&(this.removedSinceLastPush=!0),this.addedSinceLastPush!==this.removedSinceLastPush){const e=t.added?t.added:t.removed,n=" "===e||"\t"===e||"\n"===e;return!(!this.nonWordBoundarySinceLastPush||!n)||(n||(this.nonWordBoundarySinceLastPush=!0),this.newlyTypedCharCount+=e.length,this.newlyTypedCharCount>10)}return!0}return!0}pushState(e,t){for(;this.currentIndex<this.stack.length-1;)this.stack.pop();const n=e.serializeParts();this.stack.push({parts:n,caret:t}),this.currentIndex=this.stack.length-1,this.lastCaret=null,this.changedSinceLastPush=!1,this.newlyTypedCharCount=0,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}tryPush(e,t,n,i){if("historyUndo"===n||"historyRedo"===n)return!1;const s=this.shouldPush(n,i);return s?this.pushState(e,t):(this.lastCaret=t,this.changedSinceLastPush=!0),s}ensureLastChangesPushed(e){this.changedSinceLastPush&&this.pushState(e,this.lastCaret)}canUndo(){return this.currentIndex>=1||this.changedSinceLastPush}canRedo(){return this.currentIndex<this.stack.length-1}undo(e){if(this.canUndo())return this.ensureLastChangesPushed(e),this.currentIndex-=1,this.stack[this.currentIndex]}redo(){if(this.canRedo())return this.changedSinceLastPush=!1,this.currentIndex+=1,this.stack[this.currentIndex]}}var m=n(509),p=n(508),g=n(223);function f(e,t,n){n instanceof p.a?function(e,t,n){const i=document.getSelection();i.removeAllRanges();const s=document.createRange(),o=v(e,t,n.start);s.setStart(o.node,o.offset);const r=v(e,t,n.end);s.setEnd(r.node,r.offset),i.addRange(s)}(e,t,n):function(e,t,n){if(t.isEmpty)return;const i=document.createRange(),{node:s,offset:o}=v(e,t,n);i.setStart(s,o),i.collapse(!0);const r=document.getSelection();if(1===r.rangeCount){const e=r.getRangeAt(0);if(e.startContainer===i.startContainer&&e.startOffset===i.startOffset&&e.collapsed===i.collapsed)return}r.removeAllRanges(),r.addRange(i)}(e,t,n)}function v(e,t,n){const{offset:i,lineIndex:s,nodeIndex:o}=function(e,t){const{parts:n}=e,i=t.index,s=function(e,t){let n=0,i=-1,s=null;for(let o=0;o<=t;++o){const r=e[o];if(r.type===g.b.Newline)n+=1,i=-1,s=null;else{if(i+=1,Object(m.d)(r,s)&&(i+=1),o<t){const t=e[o+1],n=!t||t.type===g.b.Newline;Object(m.c)(r,n)&&(i+=1)}s=r}}return{lineIndex:n,nodeIndex:i}}(n,i),{lineIndex:o}=s;let{nodeIndex:r}=s,{offset:a}=t;-1===r?a=0:({nodeIndex:r,offset:a}=function(e,t,n,i){const s=e[t];if(s&&!s.acceptsCaret)if(0===i){n-=1;const o=e[t-1];Object(m.d)(s,o)||(i=o.text.length)}else n+=1,i=0;return{nodeIndex:n,offset:i}}(n,i,r,a));return{lineIndex:o,nodeIndex:r,offset:a}}(t,n),r=e.childNodes[s];let a;return-1===o?a=r:(a=r.childNodes[o],a.nodeType===Node.ELEMENT_NODE&&a.firstChild&&(a=a.firstChild)),{node:a,offset:i}}var b=n(89),y=n(117);let S;!function(e){e.Bold="bold",e.Italics="italics",e.Strikethrough="strikethrough",e.Code="code",e.Quote="quote",e.InsertLink="insert_link"}(S||(S={}));class E extends c.a.PureComponent{constructor(e){super(e),s()(this,"formatBarRef",Object(a.createRef)()),this.state={visible:!1}}render(){const e=r()("mx_MessageComposerFormatBar",{mx_MessageComposerFormatBar_shown:this.state.visible});return c.a.createElement("div",{className:e,ref:this.formatBarRef},c.a.createElement(w,{label:Object(b.a)("Bold"),onClick:()=>this.props.onAction(S.Bold),icon:"Bold",shortcut:this.props.shortcuts.bold,visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Italics"),onClick:()=>this.props.onAction(S.Italics),icon:"Italic",shortcut:this.props.shortcuts.italics,visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Strikethrough"),onClick:()=>this.props.onAction(S.Strikethrough),icon:"Strikethrough",visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Code block"),onClick:()=>this.props.onAction(S.Code),icon:"Code",shortcut:this.props.shortcuts.code,visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Quote"),onClick:()=>this.props.onAction(S.Quote),icon:"Quote",shortcut:this.props.shortcuts.quote,visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Insert link"),onClick:()=>this.props.onAction(S.InsertLink),icon:"InsertLink",shortcut:this.props.shortcuts.insert_link,visible:this.state.visible}))}showAt(e){if(!this.formatBarRef.current)return;this.setState({visible:!0});const t=this.formatBarRef.current.parentElement.getBoundingClientRect();this.formatBarRef.current.style.left=e.left-t.left+"px",this.formatBarRef.current.style.top=e.top-t.top-16-18+"px"}hide(){this.setState({visible:!1})}}class w extends c.a.PureComponent{render(){const e="mx_MessageComposerFormatBar_button mx_MessageComposerFormatBar_buttonIcon"+this.props.icon;let t;this.props.shortcut&&(t=c.a.createElement("div",{className:"mx_MessageComposerFormatBar_tooltipShortcut"},this.props.shortcut));const n=c.a.createElement("div",null,c.a.createElement("div",{className:"mx_Tooltip_title"},this.props.label),c.a.createElement("div",{className:"mx_Tooltip_sub"},t));return c.a.createElement(y.a,{element:"button",type:"button",onClick:this.props.onClick,title:this.props.label,tooltip:n,className:e})}}var _=n(510);function C(e,t){if(e.wasInitializedEmpty()?function(e){e.expandForwardsWhile(k),e.expandBackwardsWhile(k),e.trim()}(e):e.trim(),0!==e.length)switch(t){case S.Bold:D(e,"**");break;case S.Italics:D(e,"_");break;case S.Strikethrough:D(e,"<del>","</del>");break;case S.Code:!function(e){const{model:t,parts:n}=e,{partCreator:i}=t,s=e.length>0&&e.text.startsWith("```")&&e.text.endsWith("```")&&e.text.includes("\n"),o=n.some(e=>e.type===g.b.Newline);if(s){var r,a;n.shift(),n.pop(),"\n"===(null===(r=n[0])||void 0===r?void 0:r.text)&&"\n"===(null===(a=n[n.length-1])||void 0===a?void 0:a.text)&&(n.shift(),n.pop())}else{if(!o){const t=Object(_.a)(e.text),n=e.text.startsWith("`")&&e.text.endsWith("`");return void D(e,"`".repeat(n?t:t+1))}n.unshift(i.plain("```"),i.newline()),x(e)||n.unshift(i.newline()),n.push(i.newline(),i.plain("```")),T(e)||n.push(i.newline())}O(e,n)}(e);break;case S.Quote:!function(e){const{model:t,parts:n}=e,{partCreator:i}=t;for(let e=0;e<n.length;++e){n[e].type===g.b.Newline&&n.splice(e+1,0,i.plain("> "))}n.unshift(i.plain("> ")),x(e)||n.unshift(i.newline());T(e)||n.push(i.newline());n.push(i.newline()),O(e,n)}(e);break;case S.InsertLink:j(e)}}function O(e,t){const{model:n}=e;n.transform(()=>{const i=e.length,s=e.replace(t),o=e.start.asOffset(n),r=o.add(i+s);return n.startRange(o.asPosition(n),r.asPosition(n))})}function R(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{model:s}=e;s.transform(()=>{const o=e.length,r=e.replace(t);return e.start.asOffset(s).add(o+r+n,i).asPosition(s)})}function I(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:i;const{model:o}=e,r=e.getLastStartingPosition(),a=r.offset-e.start.offset,c=e.length-a;if(n){if(a<i)return void R(e,t,-(e.length-2*s));if(c<s)return void R(e,t,0,!0)}o.transform(()=>{const n=Math.sign(e.replace(t)),a=c===s;return r.asOffset(o).add(n*i,a).asPosition(o)})}const k=(e,t,n)=>" "!==n.text[t]&&n.type===g.b.Plain;function x(e){const{model:t}=e,n=0!==e.start.offset,i=0===e.start.index,s=!i&&t.parts[e.start.index-1].type===g.b.Newline;return!n&&(i||s)}function T(e){const{model:t}=e,n=t.parts[e.end.index],i=e.end.offset!==n.text.length,s=e.end.index===t.parts.length-1,o=!s&&t.parts[e.end.index+1].type===g.b.Newline;return!i&&(s||o)}function j(e,t){const{model:n}=e,{partCreator:i}=n,s=/\[(.*?)]\(.*?\)/g;if(s.test(e.text)){const t=e.text.replace(s,"$1");R(e,[i.plain(t)],0)}else R(e,[i.plain("["+e.text+"]("+(null!=t?t:"")+")")],-1)}const N=e=>!e.text||!/\S/.test(e.text),P=e=>e.type===g.b.Newline;function D(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;const{model:i,parts:s}=e,{partCreator:o}=i,r=[];let a=0;for(let e=2;e<s.length;e++)N(s[e-2])&&P(s[e-1])&&!P(s[e])&&!N(s[e])&&(a=e),P(s[e-1])&&P(s[e])?(r.push([a,e-1]),a=e+1):P(s[e-2])&&N(s[e-1])&&P(s[e])&&(r.push([a,e-2]),a=e+1);const c=s.map(N).lastIndexOf(!1);a<=c&&r.push([a,c+1]);let l=0;if(r.forEach(e=>{let[i,r]=e;const a=i+l,c=r+l;if(c-a>0&&s[a].text.startsWith(t)&&s[c-1].text.endsWith(n)){const e=s[a].serialize();e.text=e.text.slice(t.length),s[a]=o.deserializePart(e);const i=s[c-1].serialize(),r=i.text;i.text=r.substring(0,r.length-n.length),s[c-1]=o.deserializePart(i)}else s.splice(c,0,o.plain(n)),s.splice(a,0,o.plain(t)),l+=2}),e.wasInitializedEmpty()&&t===n){const i=e.text.startsWith(t)&&e.text.endsWith(n);I(e,s,i,t.length)}else O(e,s)}var A=n(717),M=n(111),U=n(106);class L{constructor(e){let{commandRegex:t,forcedCommandRegex:n,renderingType:i}=e;if(s()(this,"commandRegex",void 0),s()(this,"forcedCommandRegex",void 0),s()(this,"renderingType",U.a.Room),t){if(!t.global)throw new Error("commandRegex must have global flag set");this.commandRegex=t}if(n){if(!n.global)throw new Error("forcedCommandRegex must have global flag set");this.forcedCommandRegex=n}i&&(this.renderingType=i)}destroy(){}getCurrentCommand(e,t){let n,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=this.commandRegex;if(i&&this.shouldForceComplete()&&(s=this.forcedCommandRegex||/\S+/g),!s)return null;for(s.lastIndex=0;null!==(n=s.exec(e));){const e=n.index,i=e+n[0].length;if(t.start<=i&&t.end>=e)return{command:n,range:{start:e,end:i}}}return{command:null,range:{start:-1,end:-1}}}shouldForceComplete(){return!1}}var F=n(259),B=n(99),K=n.n(B),V=n(103),W=n.n(V);const H=["title","subtitle","description","className","aria-selected"],q=["title","subtitle","description","className","children","aria-selected"],$=Object(a.forwardRef)((e,t)=>{const{title:n,subtitle:i,description:s,className:o,"aria-selected":a}=e,l=W()(e,H);return c.a.createElement("div",K()({},l,{className:r()("mx_Autocomplete_Completion_block",o),role:"option","aria-selected":a,ref:t}),c.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},n),c.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},i),c.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},s))}),G=Object(a.forwardRef)((e,t)=>{const{title:n,subtitle:i,description:s,className:o,children:a,"aria-selected":l}=e,d=W()(e,q);return c.a.createElement("div",K()({},d,{className:r()("mx_Autocomplete_Completion_pill",o),role:"option","aria-selected":l,ref:t}),a,c.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},n),c.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},i),c.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},s))});var z=n(360);const J=/(^\/\w*)(?: .*)?/g;var Y=n(90),Q=n(132),X=n(130);const Z=/\B#\S*/g;function ee(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return{room:e,matchName:n,displayedAlias:t}}class te extends L{constructor(e,t){super({commandRegex:Z,renderingType:t}),s()(this,"matcher",void 0),this.matcher=new F.a([],{keys:["displayedAlias","matchName"]})}getRooms(){return Y.a.get().getVisibleRooms().filter(e=>!e.isSpaceRoom())}async getCompletions(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,s=[];const{command:o,range:r}=this.getCurrentCommand(e,t,n);if(o){let e=this.getRooms().reduce((e,t)=>{if(t.getCanonicalAlias()&&(e=e.concat(ee(t,t.getCanonicalAlias(),t.name))),t.getAltAliases().length){const n=t.getAltAliases().map(e=>ee(t,e));e=e.concat(n)}return e},[]);e=e.filter(t=>{const n=t.room.currentState.getStateEvents("m.room.tombstone","");if(n&&n.getContent()&&n.getContent().replacement_room){return!e.some(e=>e.room.roomId===n.getContent().replacement_room)}return!0}),this.matcher.setObjects(e);const t=o[0];s=this.matcher.match(t,i),s=Object(M.sortBy)(s,[e=>{return t=e.displayedAlias,n=e.room,t===n.getCanonicalAlias()?0:1;var t,n},e=>e.displayedAlias.length]),s=Object(M.uniqBy)(s,e=>e.room),s=s.map(e=>({completion:e.displayedAlias,completionId:e.room.roomId,type:"room",suffix:" ",href:Object(Q.f)(e.displayedAlias),component:c.a.createElement(G,{title:e.room.name,description:e.displayedAlias},c.a.createElement(X.a,{width:24,height:24,room:e.room})),range:r})).filter(e=>!!e.completion&&e.completion.length>0)}return s}getName(){return Object(b.a)("Rooms")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"presentation","aria-label":Object(b.a)("Room Autocomplete")},e)}}var ne=n(113),ie=n(116),se=n(136),oe=n(207);const re=/\B@\S*/g,ae=/[^/,:; \t\n]\S*/g;var ce=n(93),le=n(331);const de=new RegExp("("+d.a.source+"|(?:^|\\s):[+-\\w]*:?)$","g"),ue=le.b.sort((e,t)=>e.group===t.group?e.order-t.order:e.group-t.group).map((e,t)=>({emoji:e,_orderBy:t}));function he(e,t){const n=t.indexOf(e);return-1===n?1/0:n}const me=/@\S*/g;var pe=n(325);const ge=[class extends L{constructor(e,t){super({commandRegex:re,forcedCommandRegex:ae,renderingType:t}),s()(this,"matcher",void 0),s()(this,"users",void 0),s()(this,"room",void 0),s()(this,"onRoomTimeline",(e,t,n,i,s)=>{t&&(i||t.roomId===this.room.roomId&&s.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&!n&&s&&s.liveEvent&&this.onUserSpoke(e.sender))}),s()(this,"onRoomStateUpdate",e=>{e.roomId===this.room.roomId&&(this.users=null)}),this.room=e,this.matcher=new F.a([],{keys:["name"],funcs:[e=>e.userId.slice(1)],shouldMatchWordsOnly:!1}),Y.a.get().on(ne.c.Timeline,this.onRoomTimeline),Y.a.get().on(ie.b.Update,this.onRoomStateUpdate)}destroy(){Y.a.get()&&(Y.a.get().removeListener(ne.c.Timeline,this.onRoomTimeline),Y.a.get().removeListener(ie.b.Update,this.onRoomStateUpdate))}async getCompletions(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;this.users||this.makeUsers();let s=[];const{command:o,range:r}=this.getCurrentCommand(e,t,n);if(!o)return s;const a=o[0];if(a&&"@"!==a){const e=a.startsWith("@")?a.substring(1):a;s=this.matcher.match(e,i).map(e=>{const n=oe.a.getDisplayUserIdentifier(e.userId,{roomId:this.room.roomId,withDisplayName:!0}),i=e.name||e.userId||"";return{completion:e.rawDisplayName,completionId:e.userId,type:"user",suffix:t.beginning&&0===r.start?": ":" ",href:Object(Q.g)(e.userId),component:c.a.createElement(G,{title:i,description:n},c.a.createElement(se.a,{member:e,width:24,height:24})),range:r}})}return s}getName(){return Object(b.a)("Users")}makeUsers(){const e=this.room.getLiveTimeline().getEvents(),t={};for(const n of e)t[n.getSender()]=n.getTs();const n=Y.a.get().credentials.userId;this.users=this.room.getJoinedMembers().filter(e=>{let{userId:t}=e;return t!==n}),this.users=this.users.concat(this.room.getMembersWithMembership("invite")),this.users=Object(M.sortBy)(this.users,e=>1e20-t[e.userId]||1e20),this.matcher.setObjects(this.users)}onUserSpoke(e){this.users&&e&&e.userId!==Y.a.get().credentials.userId&&(this.users.splice(this.users.findIndex(t=>t.userId===e.userId),1),this.users=[e,...this.users],this.matcher.setObjects(this.users))}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"presentation","aria-label":Object(b.a)("User Autocomplete")},e)}shouldForceComplete(){return!0}},te,class extends L{constructor(e,t){super({commandRegex:de,renderingType:t}),s()(this,"matcher",void 0),s()(this,"nameMatcher",void 0),this.matcher=new F.a(ue,{keys:[],funcs:[e=>e.emoji.shortcodes.map(e=>`:${e}:`)],shouldMatchWordsOnly:!1}),this.nameMatcher=new F.a(ue,{keys:["emoji.label"],shouldMatchWordsOnly:!0})}async getCompletions(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;if(!ce.b.getValue("MessageComposerInput.suggestEmoji"))return[];let s=[];const{command:o,range:r}=this.getCurrentCommand(e,t);if(o&&o[0].length>2){const e=o[0];s=this.matcher.match(e,i),s=s.concat(this.nameMatcher.match(e));const t=[];t.push(t=>he(e,t.emoji.emoticon||"")),t.push(t=>he(e,t.emoji.shortcodes[0]));const n=e.replace(/^:(.*?):?$/,"$1");t.push(e=>Math.min(...e.emoji.shortcodes.map(e=>he(n,e)))),e.length>1&&t.push(e=>e.emoji.shortcodes[0].length),t.push(e=>e._orderBy),s=Object(M.sortBy)(Object(M.uniq)(s),t),s=s.map(e=>({completion:e.emoji.unicode,component:c.a.createElement(G,{title:`:${e.emoji.shortcodes[0]}:`,"aria-label":e.emoji.unicode},c.a.createElement("span",null,e.emoji.unicode)),range:r})).slice(0,20)}return s}getName(){return"😃 "+Object(b.a)("Emoji")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"presentation","aria-label":Object(b.a)("Emoji Autocomplete")},e)}},class extends L{constructor(e,t){super({commandRegex:me,renderingType:t}),this.room=e}async getCompletions(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=Y.a.get();if(!this.room.currentState.mayTriggerNotifOfType("room",i.credentials.userId))return[];const{command:s,range:o}=this.getCurrentCommand(e,t,n);return(null==s?void 0:s[0].length)>1&&["@room","@channel","@everyone","@here"].some(e=>e.startsWith(s[0]))?[{completion:"@room",completionId:"@room",type:"at-room",suffix:" ",component:c.a.createElement(G,{title:"@room",description:Object(b.a)("Notify the whole room")},c.a.createElement(X.a,{width:24,height:24,room:this.room})),range:o}]:[]}getName(){return"❗️ "+Object(b.a)("Room Notification")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"presentation","aria-label":Object(b.a)("Notification Autocomplete")},e)}},class extends L{constructor(e,t){super({commandRegex:J,renderingType:t}),s()(this,"matcher",void 0),this.matcher=new F.a(z.c,{keys:["command","args","description"],funcs:[e=>{let{aliases:t}=e;return t.join(" ")}],context:t})}async getCompletions(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;const{command:s,range:o}=this.getCurrentCommand(e,t);if(!s)return[];let r=[];if(s[0]!==s[1]){const e=s[1].slice(1);if(z.b.has(e)&&z.b.get(e).isEnabled()){if(z.b.get(e).hideCompletionAfterSpace)return[];r=[z.b.get(e)]}}else r="/"===e?z.c:this.matcher.match(s[1],i);return r.filter(e=>{const t=!e.renderingTypes||e.renderingTypes.includes(this.renderingType);return e.isEnabled()&&t}).map(e=>{let t=e.getCommand()+" ";const n=e.aliases.find(e=>"/"+e===s[1]);return(n||e.getCommand()===s[1])&&(t=s[0]),{completion:t,type:"command",component:c.a.createElement($,{title:"/"+(n||e.command),subtitle:e.args,description:Object(b.a)(e.description)}),range:o}})}getName(){return"*️⃣ "+Object(b.a)("Commands")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"presentation","aria-label":Object(b.a)("Command Autocomplete")},e)}},class extends te{getRooms(){return Y.a.get().getVisibleRooms().filter(e=>e.isSpaceRoom())}getName(){return Object(b.a)("Spaces")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(b.a)("Space Autocomplete")},e)}}];class fe{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:U.a.Room;s()(this,"room",void 0),s()(this,"providers",void 0),this.room=e,this.providers=ge.map(n=>new n(e,t))}destroy(){this.providers.forEach(e=>{e.destroy()})}async getCompletions(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;return(await Promise.all(this.providers.map(async s=>Object(pe.b)(s.getCompletions(e,t,n,i),null,3e3)))).map((i,s)=>{if(i&&i.length)return{completions:i,provider:this.providers[s],command:this.providers[s].getCurrentCommand(e,t,n)}}).filter(Boolean)}}const ve=e=>"mx_Autocomplete_Completion_"+e;class be extends c.a.PureComponent{constructor(e){super(e),s()(this,"autocompleter",void 0),s()(this,"queryRequested",void 0),s()(this,"debounceCompletionsRequest",void 0),s()(this,"containerRef",Object(a.createRef)()),s()(this,"hide",()=>{this.setState({hide:!0,selectionOffset:1,completions:[],completionList:[]})}),s()(this,"onConfirmCompletion",()=>{this.onCompletionClicked(this.state.selectionOffset)}),s()(this,"onCompletionClicked",e=>{const t=this.countCompletions();return!(0===t||e<1||e>t)&&(this.props.onConfirm(this.state.completionList[e-1]),this.hide(),!0)}),this.state={completions:[],completionList:[],selectionOffset:1,shouldShowCompletions:!0,hide:!1,forceComplete:!1}}componentDidMount(){this.autocompleter=new fe(this.props.room,this.context.timelineRenderingType),this.applyNewProps()}applyNewProps(e,t){t&&this.props.room.roomId!==t.roomId&&(this.autocompleter.destroy(),this.autocompleter=new fe(this.props.room)),e!==this.props.query&&this.complete(this.props.query,this.props.selection)}componentWillUnmount(){this.autocompleter.destroy()}complete(e,t){if(this.queryRequested=e,this.debounceCompletionsRequest&&clearTimeout(this.debounceCompletionsRequest),""===e)return this.setState({completions:[],completionList:[],selectionOffset:1,hide:!0}),Promise.resolve(null);let n=ce.b.getValue("autocompleteDelay");return(this.state.completions.length>0||this.state.forceComplete)&&(n=0),new Promise(i=>{this.debounceCompletionsRequest=setTimeout(()=>{i(this.processQuery(e,t))},n)})}processQuery(e,t){return this.autocompleter.getCompletions(e,t,this.state.forceComplete,20).then(t=>{e===this.queryRequested&&this.processCompletions(t)})}processCompletions(e){const t=Object(M.flatMap)(e,e=>e.completions);let n=1;if(t.length>0){const e=this.state.selectionOffset<=1?null:this.state.completionList[this.state.selectionOffset-1].completion;n=t.findIndex(t=>t.completion===e),-1===n?n=1:n++}let i=!0;e.some(e=>!!e.command.command)&&(i=!1,this.props.onSelectionChange&&this.props.onSelectionChange(n-1)),this.setState({completions:e,completionList:t,selectionOffset:n,hide:i,forceComplete:!1})}hasSelection(){return this.countCompletions()>0&&0!==this.state.selectionOffset}countCompletions(){return this.state.completionList.length}moveSelection(e){const t=this.countCompletions();if(0===t)return;const n=(this.state.selectionOffset+e+t-1)%t;this.setSelection(1+n)}onEscape(e){0!==this.countCompletions()&&(e.preventDefault(),this.hide())}forceComplete(){return new Promise(e=>{this.setState({forceComplete:!0,hide:!1},()=>{this.complete(this.props.query,this.props.selection).then(()=>{e(this.countCompletions())})})})}setSelection(e){this.setState({selectionOffset:e,hide:!1}),this.props.onSelectionChange&&this.props.onSelectionChange(e-1)}componentDidUpdate(e){this.applyNewProps(e.query,e.room);const t=this.refs["completion"+this.state.selectionOffset];t?t.scrollIntoView({behavior:"auto",block:"nearest"}):this.containerRef.current&&this.containerRef.current.scrollTo({top:0})}render(){let e=1;const t=this.state.completions.map((t,n)=>{const i=t.completions.map((t,n)=>{const i=e===this.state.selectionOffset,s=r()("mx_Autocomplete_Completion",{selected:i}),o=e;e++;return c.a.cloneElement(t.component,{key:n,ref:"completion"+o,id:ve(o-1),className:s,onClick:()=>{this.onCompletionClicked(o)},"aria-selected":i})});return i.length>0?c.a.createElement("div",{key:n,className:"mx_Autocomplete_ProviderSection",role:"presentation"},c.a.createElement("div",{className:"mx_Autocomplete_provider_name"},t.provider.getName()),t.provider.renderCompletions(i)):null}).filter(e=>!!e);return!this.state.hide&&t.length>0?c.a.createElement("div",{id:"mx_Autocomplete",className:"mx_Autocomplete",ref:this.containerRef,role:"listbox"},t):null}}s()(be,"contextType",U.b);var ye=n(755),Se=n(192),Ee=n(114),we=n(109),_e=n(358);const Ce=new RegExp("(?:^|\\s)("+d.a.source+")\\s|:^$"),Oe=new RegExp("(?:^|\\s)("+d.a.source+")$"),Re=['"',"_","`","'","*","~","$"],Ie=new Map([["(",")"],["[","]"],["{","}"],["<",">"]]);function ke(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(Se.a?"⌘":Object(b.a)(we.a[Se.b.CONTROL]))+(t?"+"+Object(b.a)(we.a[Se.b.SHIFT]):"")+(n?"+"+Object(b.a)(we.a[Se.b.ALT]):"")+"+"+e}function xe(e){return{anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,isCollapsed:e.isCollapsed,rangeCount:e.rangeCount,type:e.type}}class Te extends c.a.Component{constructor(e){super(e),s()(this,"editorRef",Object(a.createRef)()),s()(this,"autocompleteRef",Object(a.createRef)()),s()(this,"formatBarRef",Object(a.createRef)()),s()(this,"modifiedFlag",!1),s()(this,"isIMEComposing",!1),s()(this,"hasTextSelected",!1),s()(this,"_isCaretAtEnd",void 0),s()(this,"lastCaret",void 0),s()(this,"lastSelection",void 0),s()(this,"useMarkdownHandle",void 0),s()(this,"emoticonSettingHandle",void 0),s()(this,"shouldShowPillAvatarSettingHandle",void 0),s()(this,"surroundWithHandle",void 0),s()(this,"historyManager",new h),s()(this,"updateEditorState",(e,t,n)=>{if(Object(m.e)(this.editorRef.current,this.props.model),e){try{f(this.editorRef.current,this.props.model,e)}catch(e){u.a.error(e)}const t=e instanceof p.a?e.end:e;this.setLastCaretFromPosition(t)}const{isEmpty:i}=this.props.model;this.props.placeholder&&(i?this.showPlaceholder():this.hidePlaceholder()),i&&this.formatBarRef.current.hide(),this.setState({autoComplete:this.props.model.autoComplete,showVisualBell:!n&&this.state.showVisualBell}),this.historyManager.tryPush(this.props.model,e,t,n);let s=!this.props.model.isEmpty&&!!t;if(s&&"command"===this.props.model.parts[0].type){const{cmd:e}=Object(z.e)(this.props.model.parts[0].text),t=z.b.get(e);t&&t.isEnabled()&&t.category===z.a.messages||(s=!1)}ye.a.sharedInstance().setSelfTyping(this.props.room.roomId,this.props.threadId,s),this.props.onChange&&this.props.onChange()}),s()(this,"onCompositionStart",()=>{this.isIMEComposing=!0,this.hidePlaceholder()}),s()(this,"onCompositionEnd",()=>{this.isIMEComposing=!1;const e=navigator.userAgent.toLowerCase();e.includes("safari/")&&!e.includes("chrome/")?this.onInput({inputType:"insertCompositionText"}):Promise.resolve().then(()=>{this.onInput({inputType:"insertCompositionText"})})}),s()(this,"onCutCopy",(e,t)=>{const n=document.getSelection(),i=n.toString();if(i){const{model:s}=this.props,o=Object(A.b)(this.editorRef.current,s,n),r=o.parts.map(e=>e.serialize());e.clipboardData.setData("application/x-element-composer",JSON.stringify(r)),e.clipboardData.setData("text/plain",i),"cut"===t&&(this.modifiedFlag=!0,R(o,[])),e.preventDefault()}}),s()(this,"onCopy",e=>{this.onCutCopy(e,"copy")}),s()(this,"onCut",e=>{this.onCutCopy(e,"cut")}),s()(this,"onPaste",e=>{var t,n;if(e.preventDefault(),null!==(t=(n=this.props).onPaste)&&void 0!==t&&t.call(n,e,this.props.model))return!0;const{model:i}=this.props,{partCreator:s}=i,o=e.clipboardData.getData("text/plain"),r=e.clipboardData.getData("application/x-element-composer");let a;if(r){a=JSON.parse(r).map(e=>s.deserializePart(e))}else a=Object(_.c)(o,s,{shouldEscape:!1});this.modifiedFlag=!0;const c=Object(A.b)(this.editorRef.current,i,document.getSelection());o&&c.length>0&&_e.d.test(o)&&!_e.d.test(c.text)?j(c,o):R(c,a)}),s()(this,"onInput",e=>{if(this.isIMEComposing)return;this.modifiedFlag=!0;const t=document.getSelection(),{caret:n,text:i}=Object(A.a)(this.editorRef.current,t);this.props.model.update(i,e.inputType,n)}),s()(this,"onBlur",()=>{document.removeEventListener("selectionchange",this.onSelectionChange)}),s()(this,"onFocus",()=>{document.addEventListener("selectionchange",this.onSelectionChange),this.lastSelection=null,this.refreshLastCaretIfNeeded()}),s()(this,"onSelectionChange",()=>{const{isEmpty:e}=this.props.model;this.refreshLastCaretIfNeeded();const t=document.getSelection();var n;if(this.hasTextSelected&&t.isCollapsed)this.hasTextSelected=!1,null===(n=this.formatBarRef.current)||void 0===n||n.hide();else if(!t.isCollapsed&&!e){this.hasTextSelected=!0;const e=Object(A.b)(this.editorRef.current,this.props.model,t);if(this.formatBarRef.current&&this.state.useMarkdown&&e.text.trim()){const e=t.getRangeAt(0).getBoundingClientRect();this.formatBarRef.current.showAt(e)}}}),s()(this,"onKeyDown",e=>{var t;const n=this.props.model;let i=!1;if(this.state.surroundWith&&"Caret"!==document.getSelection().type){const t=Object(A.b)(this.editorRef.current,this.props.model,document.getSelection());t.trim(),[...Ie.keys(),...Re].includes(e.key)&&(this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,D(t,e.key,Ie.get(e.key)),i=!0)}const s=Object(Ee.a)().getAutocompleteAction(e),o=Object(Ee.a)().getAccessibilityAction(e);if(null!==(t=n.autoComplete)&&void 0!==t&&t.hasCompletions()){const t=n.autoComplete;switch(s){case we.h.ForceCompleteAutocomplete:case we.h.CompleteAutocomplete:this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,t.confirmCompletion(),i=!0;break;case we.h.PrevSelectionInAutocomplete:t.selectPreviousSelection(),i=!0;break;case we.h.NextSelectionInAutocomplete:t.selectNextSelection(),i=!0;break;case we.h.CancelAutocomplete:t.onEscape(e),i=!0;break;default:return}}else s!==we.h.ForceCompleteAutocomplete||this.state.showVisualBell?[we.h.Delete,we.h.Backspace].includes(o)&&this.formatBarRef.current.hide():(this.tabCompleteName(),i=!0);if(i)return e.preventDefault(),void e.stopPropagation();switch(Object(Ee.a)().getMessageComposerAction(e)){case we.h.FormatBold:this.onFormatAction(S.Bold),i=!0;break;case we.h.FormatItalics:this.onFormatAction(S.Italics),i=!0;break;case we.h.FormatCode:this.onFormatAction(S.Code),i=!0;break;case we.h.FormatQuote:this.onFormatAction(S.Quote),i=!0;break;case we.h.FormatLink:this.onFormatAction(S.InsertLink),i=!0;break;case we.h.EditRedo:if(this.historyManager.canRedo()){const{parts:e,caret:t}=this.historyManager.redo();n.reset(e,t,"historyRedo")}i=!0;break;case we.h.EditUndo:if(this.historyManager.canUndo()){const{parts:e,caret:t}=this.historyManager.undo(this.props.model);n.reset(e,t,"historyUndo")}i=!0;break;case we.h.NewLine:this.insertText("\n"),i=!0;break;case we.h.MoveCursorToStart:f(this.editorRef.current,n,{index:0,offset:0}),i=!0;break;case we.h.MoveCursorToEnd:f(this.editorRef.current,n,{index:n.parts.length-1,offset:n.parts[n.parts.length-1].text.length}),i=!0}i&&(e.preventDefault(),e.stopPropagation())}),s()(this,"onAutoCompleteConfirm",e=>{this.modifiedFlag=!0,this.props.model.autoComplete.onComponentConfirm(e)}),s()(this,"onAutoCompleteSelectionChange",e=>{this.modifiedFlag=!0,this.setState({completionIndex:e})}),s()(this,"configureUseMarkdown",()=>{const e=ce.b.getValue("MessageComposerInput.useMarkdown");this.setState({useMarkdown:e}),!e&&this.formatBarRef.current&&this.formatBarRef.current.hide()}),s()(this,"configureEmoticonAutoReplace",()=>{this.props.model.setTransformCallback(this.transform)}),s()(this,"configureShouldShowPillAvatar",()=>{const e=ce.b.getValue("Pill.shouldShowPillAvatar");this.setState({showPillAvatar:e})}),s()(this,"surroundWithSettingChanged",()=>{const e=ce.b.getValue("MessageComposerInput.surroundWith");this.setState({surroundWith:e})}),s()(this,"transform",e=>{ce.b.getValue("MessageComposerInput.autoReplaceEmoji")&&this.replaceEmoticon(e,Ce)}),s()(this,"onFormatAction",e=>{if(!this.state.useMarkdown)return;const t=Object(A.b)(this.editorRef.current,this.props.model,document.getSelection());this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,C(t,e)}),this.state={showPillAvatar:ce.b.getValue("Pill.shouldShowPillAvatar"),useMarkdown:ce.b.getValue("MessageComposerInput.useMarkdown"),surroundWith:ce.b.getValue("MessageComposerInput.surroundWith"),showVisualBell:!1},this.useMarkdownHandle=ce.b.watchSetting("MessageComposerInput.useMarkdown",null,this.configureUseMarkdown),this.emoticonSettingHandle=ce.b.watchSetting("MessageComposerInput.autoReplaceEmoji",null,this.configureEmoticonAutoReplace),this.configureEmoticonAutoReplace(),this.shouldShowPillAvatarSettingHandle=ce.b.watchSetting("Pill.shouldShowPillAvatar",null,this.configureShouldShowPillAvatar),this.surroundWithHandle=ce.b.watchSetting("MessageComposerInput.surroundWith",null,this.surroundWithSettingChanged)}componentDidUpdate(e){const t=this.props.disabled!==e.disabled,n=this.props.placeholder!==e.placeholder;if(this.props.placeholder&&(n||t)){const{isEmpty:e}=this.props.model;e?this.showPlaceholder():this.hidePlaceholder()}}replaceEmoticon(e,t){const{model:n}=this.props,i=n.startRange(e);let s=8;i.expandBackwardsWhile((e,t)=>{const i=n.parts[e];return s-=1,s>=0&&[g.b.Plain,g.b.PillCandidate,g.b.Newline].includes(i.type)});const o=t.exec(i.text);if(o){const e=o[1].replace("-",""),t=le.c.get(e)||le.c.get(e.toLowerCase());if(t){const{partCreator:e}=n,s=o[0],r=" "===s[0]?1:0;return i.moveStartForwards(o.index+r),["\n"," "].includes(s[s.length-1])&&i.moveEndBackwards(1),i.replace([e.emoji(t.unicode)])}}}showPlaceholder(){const e=this.props.placeholder.replace(/'/g,"\\'");this.editorRef.current.style.setProperty("--placeholder",`'${e}'`),this.editorRef.current.classList.add("mx_BasicMessageComposer_inputEmpty")}hidePlaceholder(){this.editorRef.current.classList.remove("mx_BasicMessageComposer_inputEmpty"),this.editorRef.current.style.removeProperty("--placeholder")}isComposing(e){return!!(this.isIMEComposing||e.nativeEvent&&e.nativeEvent.isComposing)}insertText(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"insertText";const n=document.getSelection(),{caret:i,text:s}=Object(A.a)(this.editorRef.current,n),o=s.slice(0,i.offset)+e+s.slice(i.offset);i.offset+=e.length,this.modifiedFlag=!0,this.props.model.update(o,t,i)}setLastCaretFromPosition(e){const{model:t}=this.props;this._isCaretAtEnd=e.isAtEnd(t),this.lastCaret=e.asOffset(t),this.lastSelection=xe(document.getSelection())}refreshLastCaretIfNeeded(){if(!this.editorRef.current)return;const e=document.getSelection();if(!this.lastSelection||(t=this.lastSelection,n=e,t.anchorNode!==n.anchorNode||t.anchorOffset!==n.anchorOffset||t.focusNode!==n.focusNode||t.focusOffset!==n.focusOffset||t.isCollapsed!==n.isCollapsed||t.rangeCount!==n.rangeCount||t.type!==n.type)){this.lastSelection=xe(e);const{caret:t,text:n}=Object(A.a)(this.editorRef.current,e);this.lastCaret=t,this._isCaretAtEnd=t.offset===n.length}var t,n;return this.lastCaret}clearUndoHistory(){this.historyManager.clear()}getCaret(){return this.lastCaret}isSelectionCollapsed(){return!this.lastSelection||this.lastSelection.isCollapsed}isCaretAtStart(){return 0===this.getCaret().offset}isCaretAtEnd(){return this._isCaretAtEnd}async tabCompleteName(){try{await new Promise(e=>this.setState({showVisualBell:!1},e));const{model:e}=this.props,t=this.getCaret(),n=e.positionForOffset(t.offset,t.atNodeEnd),i=e.startRange(n);i.expandBackwardsWhile((e,t,n)=>" "!==n.text[t]&&"+"!==n.text[t]&&(n.type===g.b.Plain||n.type===g.b.PillCandidate||n.type===g.b.Command));const{partCreator:s}=e;await e.transform(()=>{const n=i.replace([s.pillCandidate(i.text)]);return e.positionForOffset(t.offset+n,!0)}),e.autoComplete?(await e.autoComplete.startSelection(),e.autoComplete.hasSelection()||(this.setState({showVisualBell:!0}),e.autoComplete.close())):this.setState({showVisualBell:!0})}catch(e){u.a.error(e)}}isModified(){return this.modifiedFlag}componentWillUnmount(){document.removeEventListener("selectionchange",this.onSelectionChange),this.editorRef.current.removeEventListener("input",this.onInput,!0),this.editorRef.current.removeEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.removeEventListener("compositionend",this.onCompositionEnd,!0),ce.b.unwatchSetting(this.useMarkdownHandle),ce.b.unwatchSetting(this.emoticonSettingHandle),ce.b.unwatchSetting(this.shouldShowPillAvatarSettingHandle),ce.b.unwatchSetting(this.surroundWithHandle)}componentDidMount(){const e=this.props.model;e.setUpdateCallback(this.updateEditorState);e.partCreator.setAutoCompleteCreator(Object(g.c)(()=>this.autocompleteRef.current,e=>new Promise(t=>this.setState({query:e},t)))),this.updateEditorState(this.getInitialCaretPosition()),this.editorRef.current.addEventListener("input",this.onInput,!0),this.editorRef.current.addEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.addEventListener("compositionend",this.onCompositionEnd,!0),this.editorRef.current.focus()}getInitialCaretPosition(){let e;if(this.props.initialCaret){const t=this.props.initialCaret;e=this.props.model.positionForOffset(t.offset,t.atNodeEnd)}else e=this.props.model.getPositionAtEnd();return e}render(){let e;if(this.state.autoComplete){const t=this.state.query,n=t.length;e=c.a.createElement("div",{className:"mx_BasicMessageComposer_AutoCompleteWrapper"},c.a.createElement(be,{ref:this.autocompleteRef,query:t,onConfirm:this.onAutoCompleteConfirm,onSelectionChange:this.onAutoCompleteSelectionChange,selection:{beginning:!0,end:n,start:n},room:this.props.room}))}const t=r()("mx_BasicMessageComposer",{mx_BasicMessageComposer_input_error:this.state.showVisualBell}),n=r()("mx_BasicMessageComposer_input",{mx_BasicMessageComposer_input_shouldShowPillAvatar:this.state.showPillAvatar,mx_BasicMessageComposer_input_disabled:this.props.disabled}),i={[S.Bold]:ke("B"),[S.Italics]:ke("I"),[S.Code]:ke("E"),[S.Quote]:ke(">"),[S.InsertLink]:ke("L",!0)},{completionIndex:s}=this.state,o=Boolean(this.state.autoComplete);let a;return o&&s>=0&&(a=ve(s)),c.a.createElement("div",{className:t},e,c.a.createElement(E,{ref:this.formatBarRef,onAction:this.onFormatAction,shortcuts:i}),c.a.createElement("div",{className:n,contentEditable:!this.props.disabled||null,tabIndex:0,onBlur:this.onBlur,onFocus:this.onFocus,onCopy:this.onCopy,onCut:this.onCut,onPaste:this.onPaste,onKeyDown:this.onKeyDown,ref:this.editorRef,"aria-label":this.props.label,role:"textbox","aria-multiline":"true","aria-autocomplete":"list","aria-haspopup":"listbox","aria-expanded":o,"aria-owns":"mx_Autocomplete","aria-activedescendant":a,dir:"auto","aria-disabled":this.props.disabled}))}focus(){this.editorRef.current.focus()}insertMention(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:n}=t,i=this.props.room.getMember(e),s=i?i.rawDisplayName:e,o=this.getCaret(),r=t.positionForOffset(o.offset,o.atNodeEnd),a=n.createMentionParts(0===o.offset,s,e);t.transform(()=>{const e=t.insert(a,r);return t.positionForOffset(o.offset+e,!0)}),this.focus()}insertQuotedMessage(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:n}=t,i=Object(_.b)(e,n,{isQuotedMessage:!0});i.push(n.newline()),i.push(n.newline()),t.transform(()=>{const e=t.insert(i,t.positionForOffset(0));return t.positionForOffset(e,!0)}),this.focus()}insertPlaintext(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:n}=t,i=this.getCaret(),s=t.positionForOffset(i.offset,i.atNodeEnd);t.transform(()=>{const o=t.insert(n.plainWithEmoji(e),s);return t.positionForOffset(i.offset+o,!0)})}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return A})),n.d(t,"c",(function(){return M})),n.d(t,"b",(function(){return U}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(89),c=n(111),l=n(93),d=n(104);function u(){const e=JSON.parse(window.localStorage.mx_reaction_count||"{}"),t=Object.entries(e).sort((e,t)=>{let[,[n,i]]=e,[,[s,o]]=t;return o-i}).map(e=>{let[t,[n,i]]=e;return[t,n]});l.b.setValue("recent_emoji",null,d.a.ACCOUNT,t.slice(0,100))}function h(){return l.b.getValue("recent_emoji")||[]}var m=n(331),p=n(176),g=n(94),f=n.n(g),v=n(114),b=n(109);class y extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"onKeyDown",e=>{let t=!0;switch(Object(v.a)().getAccessibilityAction(e)){case b.h.ArrowLeft:this.changeCategoryRelative(-1);break;case b.h.ArrowRight:this.changeCategoryRelative(1);break;case b.h.Home:this.changeCategoryAbsolute(0);break;case b.h.End:this.changeCategoryAbsolute(this.props.categories.length-1,-1);break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())})}findNearestEnabled(e,t){e+=this.props.categories.length;const n=[...this.props.categories,...this.props.categories,...this.props.categories];for(;e<n.length&&e>=0;){if(n[e].enabled)return e%this.props.categories.length;e+=t>0?1:-1}}changeCategoryRelative(e){const t=this.props.categories.findIndex(e=>e.visible);this.changeCategoryAbsolute(t+e,e)}changeCategoryAbsolute(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const n=this.props.categories[this.findNearestEnabled(e,t)];n&&(this.props.onAnchorClick(n.id),n.ref.current.focus())}render(){return r.a.createElement("nav",{className:"mx_EmojiPicker_header",role:"tablist","aria-label":Object(a.a)("Categories"),onKeyDown:this.onKeyDown},this.props.categories.map(e=>{const t=f()("mx_EmojiPicker_anchor mx_EmojiPicker_anchor_"+e.id,{mx_EmojiPicker_anchor_visible:e.visible});return r.a.createElement("button",{disabled:!e.enabled,key:e.id,ref:e.ref,className:t,onClick:()=>this.props.onAnchorClick(e.id),title:e.name,role:"tab",tabIndex:e.visible?0:-1,"aria-selected":e.visible,"aria-controls":"mx_EmojiPicker_category_"+e.id})}))}}var S=y;class E extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"inputRef",r.a.createRef()),s()(this,"onKeyDown",e=>{switch(Object(v.a)().getAccessibilityAction(e)){case b.h.Enter:this.props.onEnter(),e.stopPropagation(),e.preventDefault()}})}componentDidMount(){setTimeout(()=>this.inputRef.current.focus(),0)}render(){let e;return e=this.props.query?r.a.createElement("button",{onClick:()=>this.props.onChange(""),className:"mx_EmojiPicker_search_icon mx_EmojiPicker_search_clear",title:Object(a.a)("Cancel search")}):r.a.createElement("span",{className:"mx_EmojiPicker_search_icon"}),r.a.createElement("div",{className:"mx_EmojiPicker_search"},r.a.createElement("input",{autoFocus:!0,type:"text",placeholder:Object(a.a)("Search"),value:this.props.query,onChange:e=>this.props.onChange(e.target.value),onKeyDown:this.onKeyDown,ref:this.inputRef}),e)}}var w=E;class _ extends r.a.PureComponent{render(){const{unicode:e,label:t,shortcodes:[n]}=this.props.emoji;return r.a.createElement("div",{className:"mx_EmojiPicker_footer mx_EmojiPicker_preview"},r.a.createElement("div",{className:"mx_EmojiPicker_preview_emoji"},e),r.a.createElement("div",{className:"mx_EmojiPicker_preview_text"},r.a.createElement("div",{className:"mx_EmojiPicker_name mx_EmojiPicker_preview_name"},t),r.a.createElement("div",{className:"mx_EmojiPicker_shortcode"},n)))}}var C=_,O=n(112);class R extends r.a.PureComponent{render(){const{onClick:e,onMouseEnter:t,onMouseLeave:n,emoji:i,selectedEmojis:s}=this.props,o=s&&s.has(i.unicode);return r.a.createElement(O.e,{element:"li",onClick:()=>e(i),onMouseEnter:()=>t(i),onMouseLeave:()=>n(i),className:"mx_EmojiPicker_item_wrapper",label:i.unicode},r.a.createElement("div",{className:"mx_EmojiPicker_item "+(o?"mx_EmojiPicker_item_selected":"")},i.unicode))}}var I=R;const k=["👍","👎","😄","🎉","😕","❤️","🚀","👀"].map(e=>{const t=Object(m.d)(e);if(!t)throw new Error(`Emoji ${e} doesn't exist in emojibase`);return t});class x extends r.a.Component{constructor(e){super(e),s()(this,"onMouseEnter",e=>{this.setState({hover:e})}),s()(this,"onMouseLeave",()=>{this.setState({hover:null})}),this.state={hover:null}}render(){return r.a.createElement("section",{className:"mx_EmojiPicker_footer mx_EmojiPicker_quick mx_EmojiPicker_category"},r.a.createElement("h2",{className:"mx_EmojiPicker_quick_header mx_EmojiPicker_category_label"},this.state.hover?r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_EmojiPicker_name"},this.state.hover.label),r.a.createElement("span",{className:"mx_EmojiPicker_shortcode"},this.state.hover.shortcodes[0])):Object(a.a)("Quick Reactions")),r.a.createElement("ul",{className:"mx_EmojiPicker_list","aria-label":Object(a.a)("Quick Reactions")},k.map(e=>r.a.createElement(I,{key:e.hexcode,emoji:e,onClick:this.props.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,selectedEmojis:this.props.selectedEmojis}))))}}var T=x,j=n(701);class N extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"renderEmojiRow",e=>{const{onClick:t,onMouseEnter:n,onMouseLeave:i,selectedEmojis:s,emojis:o}=this.props,a=o.slice(8*e,8*(e+1));return r.a.createElement("div",{key:e},a.map(e=>r.a.createElement(I,{key:e.hexcode,emoji:e,selectedEmojis:s,onClick:t,onMouseEnter:n,onMouseLeave:i})))})}render(){const{emojis:e,name:t,heightBefore:n,viewportHeight:i,scrollTop:s}=this.props;if(!e||0===e.length)return null;const o=new Array(Math.ceil(e.length/U));for(let e=0;e<o.length;++e)o[e]=e;const a=s,c=a+i,l=n+A,d=l+o.length*M,u=Math.max(a,l),h=Math.min(c,d),m=Math.max(0,h-u),p=Math.max(0,s-l);return r.a.createElement("section",{id:"mx_EmojiPicker_category_"+this.props.id,className:"mx_EmojiPicker_category","data-category-id":this.props.id,role:"tabpanel","aria-label":t},r.a.createElement("h2",{className:"mx_EmojiPicker_category_label"},t),r.a.createElement(j.a,{element:"ul",className:"mx_EmojiPicker_list",itemHeight:M,items:o,scrollTop:p,height:m,overflowItems:3,overflowMargin:0,renderItem:this.renderEmojiRow}))}}var P=N;function D(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const A=20,M=35,U=8;class L extends r.a.Component{constructor(e){super(e),s()(this,"recentlyUsed",void 0),s()(this,"memoizedDataByCategory",void 0),s()(this,"categories",void 0),s()(this,"scrollRef",r.a.createRef()),s()(this,"onScroll",()=>{var e;const t=null===(e=this.scrollRef.current)||void 0===e?void 0:e.containerRef.current;this.setState({scrollTop:t.scrollTop,viewportHeight:t.clientHeight}),this.updateVisibility()}),s()(this,"updateVisibility",()=>{var e;const t=null===(e=this.scrollRef.current)||void 0===e?void 0:e.containerRef.current,n=t.getBoundingClientRect();for(const e of this.categories){const i=t.querySelector(`[data-category-id="${e.id}"]`);if(!i){e.visible=!1,e.ref.current.classList.remove("mx_EmojiPicker_anchor_visible");continue}const s=i.getBoundingClientRect(),o=s.y-n.y,r=s.y+s.height-n.y;e.visible=o<n.height&&r>0,e.visible?(e.ref.current.classList.add("mx_EmojiPicker_anchor_visible"),e.ref.current.setAttribute("aria-selected","true"),e.ref.current.setAttribute("tabindex","0")):(e.ref.current.classList.remove("mx_EmojiPicker_anchor_visible"),e.ref.current.setAttribute("aria-selected","false"),e.ref.current.setAttribute("tabindex","-1"))}}),s()(this,"scrollToCategory",e=>{var t,n;null===(t=this.scrollRef.current)||void 0===t||null===(n=t.containerRef.current)||void 0===n||n.querySelector(`[data-category-id="${e}"]`).scrollIntoView()}),s()(this,"onChangeFilter",e=>{const t=e.toLowerCase().trim();for(const e of this.categories){let n;n=t.includes(this.state.filter)?this.memoizedDataByCategory[e.id]:"recent"===e.id?this.recentlyUsed:m.a[e.id],n=n.filter(e=>this.emojiMatchesFilter(e,t)),this.memoizedDataByCategory[e.id]=n,e.enabled=n.length>0,e.ref.current.disabled=!e.enabled}this.setState({filter:e}),setTimeout(this.updateVisibility,0)}),s()(this,"emojiMatchesFilter",(e,t)=>{var n;return e.label.toLowerCase().includes(t)||(Array.isArray(e.emoticon)?e.emoticon.some(e=>e.includes(t)):null===(n=e.emoticon)||void 0===n?void 0:n.includes(t))||e.shortcodes.some(e=>e.toLowerCase().includes(t))||e.unicode.split("‍").includes(t)}),s()(this,"onEnterFilter",()=>{var e,t;const n=null===(e=this.scrollRef.current)||void 0===e||null===(t=e.containerRef.current)||void 0===t?void 0:t.querySelector(".mx_EmojiPicker_item");n&&n.click()}),s()(this,"onHoverEmoji",e=>{this.setState({previewEmoji:e})}),s()(this,"onHoverEmojiEnd",e=>{this.setState({previewEmoji:null})}),s()(this,"onClickEmoji",e=>{!1!==this.props.onChoose(e.unicode)&&function(e){const t=h(),n=t.findIndex(t=>{let[n]=t;return n===e});let i;n>=0?([i]=t.splice(n,1),i[1]++):i=[e,1],l.b.setValue("recent_emoji",null,d.a.ACCOUNT,[i,...t].slice(0,100))}(e.unicode)}),this.state={filter:"",previewEmoji:null,scrollTop:0,viewportHeight:280},this.recentlyUsed=Array.from(new Set(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:24,t=h();t.length<1&&(u(),t=h());const n=Object(c.orderBy)(t,"1","desc");return n.slice(0,e).map(e=>{let[t]=e;return t})}().map(m.d).filter(Boolean))),this.memoizedDataByCategory=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?D(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):D(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({recent:this.recentlyUsed},m.a),this.categories=[{id:"recent",name:Object(a.a)("Frequently Used"),enabled:this.recentlyUsed.length>0,visible:this.recentlyUsed.length>0,ref:r.a.createRef()},{id:"people",name:Object(a.a)("Smileys & People"),enabled:!0,visible:!0,ref:r.a.createRef()},{id:"nature",name:Object(a.a)("Animals & Nature"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"foods",name:Object(a.a)("Food & Drink"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"activity",name:Object(a.a)("Activities"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"places",name:Object(a.a)("Travel & Places"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"objects",name:Object(a.a)("Objects"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"symbols",name:Object(a.a)("Symbols"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"flags",name:Object(a.a)("Flags"),enabled:!0,visible:!1,ref:r.a.createRef()}]}static categoryHeightForEmojiCount(e){return 0===e?0:A+Math.ceil(e/U)*M}render(){let e=0;return r.a.createElement("div",{className:"mx_EmojiPicker"},r.a.createElement(S,{categories:this.categories,onAnchorClick:this.scrollToCategory}),r.a.createElement(w,{query:this.state.filter,onChange:this.onChangeFilter,onEnter:this.onEnterFilter}),r.a.createElement(p.a,{className:"mx_EmojiPicker_body",ref:this.scrollRef,onScroll:this.onScroll},this.categories.map(t=>{const n=this.memoizedDataByCategory[t.id],i=r.a.createElement(P,{key:t.id,id:t.id,name:t.name,heightBefore:e,viewportHeight:this.state.viewportHeight,scrollTop:this.state.scrollTop,emojis:n,onClick:this.onClickEmoji,onMouseEnter:this.onHoverEmoji,onMouseLeave:this.onHoverEmojiEnd,selectedEmojis:this.props.selectedEmojis}),s=L.categoryHeightForEmojiCount(n.length);return e+=s,i})),this.state.previewEmoji||!this.props.showQuickReactions?r.a.createElement(C,{emoji:this.state.previewEmoji}):r.a.createElement(T,{onClick:this.onClickEmoji,selectedEmojis:this.props.selectedEmojis}))}}t.d=L},,function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(0),c=n(89),l=n(105),d=n(91);class u extends r.a.Component{constructor(){super(...arguments),s()(this,"state",{verifyRemove:!1}),s()(this,"onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),s()(this,"onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),s()(this,"onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),this.props.onRemove&&this.props.onRemove(this.props.index),this.setState({verifyRemove:!1})})}render(){return this.state.verifyRemove?r.a.createElement("div",{className:"mx_EditableItem"},r.a.createElement("span",{className:"mx_EditableItem_promptText"},Object(c.a)("Are you sure?")),r.a.createElement(d.a,{onClick:this.onActuallyRemove,kind:"primary_sm",className:"mx_EditableItem_confirmBtn"},Object(c.a)("Yes")),r.a.createElement(d.a,{onClick:this.onDontRemove,kind:"danger_sm",className:"mx_EditableItem_confirmBtn"},Object(c.a)("No"))):r.a.createElement("div",{className:"mx_EditableItem"},r.a.createElement("div",{onClick:this.onRemove,className:"mx_EditableItem_delete",title:Object(c.a)("Remove"),role:"button"}),r.a.createElement("span",{className:"mx_EditableItem_item"},this.props.value))}}class h extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"onItemAdded",e=>{e.stopPropagation(),e.preventDefault(),this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem)}),s()(this,"onItemRemoved",e=>{this.props.onItemRemoved&&this.props.onItemRemoved(e)}),s()(this,"onNewItemChanged",e=>{this.props.onNewItemChanged&&this.props.onNewItemChanged(e.target.value)})}renderNewItemField(){return r.a.createElement("form",{onSubmit:this.onItemAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},r.a.createElement(l.a,{label:this.props.placeholder,type:"text",autoComplete:"off",value:this.props.newItem||"",onChange:this.onNewItemChanged,list:this.props.suggestionsListId}),r.a.createElement(d.a,{onClick:this.onItemAdded,kind:"primary",type:"submit",disabled:!this.props.newItem},Object(c.a)("Add")))}render(){const e=this.props.items.map((e,t)=>this.props.canRemove?r.a.createElement(u,{key:e,index:t,value:e,onRemove:this.onItemRemoved}):r.a.createElement("li",{key:e},e)),t=this.props.canRemove?e:r.a.createElement("ul",null,e),n=this.props.items.length>0?this.props.itemsLabel:this.props.noItemsLabel;return r.a.createElement("div",{className:"mx_EditableItemList",id:this.props.id},r.a.createElement("div",{className:"mx_EditableItemList_label"},n),t,this.props.canEdit?this.renderNewItemField():r.a.createElement("div",null))}}var m=n(102),p=n(107),g=n(95),f=n(125),v=n(195),b=n(90);var y={};class S extends r.a.PureComponent{constructor(e,t){super(e,t),s()(this,"onRoomPublishChange",e=>{const t=this.state.isRoomPublished,n=!t;this.setState({isRoomPublished:n});b.a.get().setRoomDirectoryVisibility(this.props.roomId,n?f.f.Public:f.f.Private).catch(()=>{this.setState({isRoomPublished:t})})}),this.state={isRoomPublished:!1}}componentDidMount(){b.a.get().getRoomDirectoryVisibility(this.props.roomId).then(e=>{this.setState({isRoomPublished:"public"===e.visibility})})}render(){var e;const t=b.a.get(),n="invite"!==t.getRoom(this.props.roomId).getJoinRule(),i=(!1===(null===(e=y.requireCanonicalAliasAccessToPublish)||void 0===e?void 0:e.call(y))||this.props.canSetCanonicalAlias)&&(n||this.state.isRoomPublished);return r.a.createElement(v.a,{value:this.state.isRoomPublished,onChange:this.onRoomPublishChange,disabled:!i,label:Object(c.a)("Publish this room to the public in %(domain)s's room directory?",{domain:t.getDomain()})})}}var E=n(524),w=n(100),_=n(350);class C extends h{constructor(){super(...arguments),s()(this,"aliasField",Object(o.createRef)()),s()(this,"onAliasAdded",async e=>{e.preventDefault(),await this.aliasField.current.validate({allowEmpty:!1}),this.aliasField.current.isValid?this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem):(this.aliasField.current.focus(),this.aliasField.current.validate({allowEmpty:!1,focused:!0}))})}renderNewItemField(){return r.a.createElement("form",{onSubmit:this.onAliasAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},r.a.createElement(E.a,{ref:this.aliasField,onChange:e=>this.onNewItemChanged({target:{value:e}}),value:this.props.newItem||"",domain:this.props.domain,roomId:this.props.roomId}),r.a.createElement(d.a,{onClick:this.onAliasAdded,kind:"primary"},Object(c.a)("Add")))}}class O extends r.a.Component{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"onNewAliasChanged",e=>{this.setState({newAlias:e})}),s()(this,"onLocalAliasAdded",e=>{if(!e||0===e.length)return;const t=this.context.getDomain();e.includes(":")||(e+=":"+t),this.context.createAlias(e,this.props.roomId).then(()=>{this.setState({localAliases:this.state.localAliases.concat(e),newAlias:null}),this.state.canonicalAlias||this.changeCanonicalAlias(e)}).catch(e=>{a.a.error(e),g.a.createTrackedDialog("Error creating address","",p.a,{title:Object(c.a)("Error creating address"),description:Object(c.a)("There was an error creating that address. It may not be allowed by the server or a temporary failure occurred.")})})}),s()(this,"onLocalAliasDeleted",e=>{const t=this.state.localAliases[e];this.context.deleteAlias(t).then(()=>{const e=this.state.localAliases.filter(e=>e!==t);this.setState({localAliases:e}),this.state.canonicalAlias===t&&this.changeCanonicalAlias(null)}).catch(e=>{let t;a.a.error(e),t="M_FORBIDDEN"===e.errcode?Object(c.a)("You don't have permission to delete the address."):Object(c.a)("There was an error removing that address. It may no longer exist or a temporary error occurred."),g.a.createTrackedDialog("Error removing address","",p.a,{title:Object(c.a)("Error removing address"),description:t})})}),s()(this,"onLocalAliasesToggled",e=>{e.target.open&&(this.props.canSetCanonicalAlias||0!==this.state.localAliases.length||this.loadLocalAliases()),this.setState({detailsOpen:e.currentTarget.open})}),s()(this,"onCanonicalAliasChange",e=>{this.changeCanonicalAlias(e.target.value)}),s()(this,"onNewAltAliasChanged",e=>{this.setState({newAltAlias:e})}),s()(this,"onAltAliasAdded",e=>{const t=this.state.altAliases.slice();t.some(t=>t.trim()===e.trim())||(t.push(e.trim()),this.changeAltAliases(t),this.setState({newAltAlias:""}))}),s()(this,"onAltAliasDeleted",e=>{const t=this.state.altAliases.slice();t.splice(e,1),this.changeAltAliases(t)});const n={altAliases:[],localAliases:[],canonicalAlias:null,updatingCanonicalAlias:!1,localAliasesLoading:!1,detailsOpen:!1};if(e.canonicalAliasEvent){const t=e.canonicalAliasEvent.getContent(),i=t.alt_aliases;Array.isArray(i)&&(n.altAliases=i.slice()),n.canonicalAlias=t.alias}this.state=n}componentDidMount(){this.props.canSetCanonicalAlias&&this.loadLocalAliases()}async loadLocalAliases(){this.setState({localAliasesLoading:!0});try{const e=this.context;let t=[];const n=await e.getLocalAliases(this.props.roomId);Array.isArray(null==n?void 0:n.aliases)&&(t=n.aliases),this.setState({localAliases:t}),0===t.length&&this.setState({detailsOpen:!0})}finally{this.setState({localAliasesLoading:!1})}}changeCanonicalAlias(e){if(!this.props.canSetCanonicalAlias)return;const t=this.state.canonicalAlias;this.setState({canonicalAlias:e,updatingCanonicalAlias:!0});const n={alt_aliases:this.state.altAliases};e&&(n.alias=e),this.context.sendStateEvent(this.props.roomId,"m.room.canonical_alias",n,"").catch(e=>{a.a.error(e),g.a.createTrackedDialog("Error updating main address","",p.a,{title:Object(c.a)("Error updating main address"),description:Object(c.a)("There was an error updating the room's main address. It may not be allowed by the server or a temporary failure occurred.")}),this.setState({canonicalAlias:t})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}changeAltAliases(e){if(!this.props.canSetCanonicalAlias)return;this.setState({updatingCanonicalAlias:!0});const t={};this.state.canonicalAlias&&(t.alias=this.state.canonicalAlias),e&&(t.alt_aliases=e),this.context.sendStateEvent(this.props.roomId,"m.room.canonical_alias",t,"").then(()=>{this.setState({altAliases:e})}).catch(e=>{a.a.error(e),g.a.createTrackedDialog("Error updating alternative addresses","",p.a,{title:Object(c.a)("Error updating main address"),description:Object(c.a)("There was an error updating the room's alternative addresses. It may not be allowed by the server or a temporary failure occurred.")})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}getAliases(){return this.state.altAliases.concat(this.getLocalNonAltAliases())}getLocalNonAltAliases(){const{altAliases:e}=this.state;return this.state.localAliases.filter(t=>!e.includes(t))}render(){var e;const t=this.context,n=t.getDomain(),i=null===(e=t.getRoom(this.props.roomId))||void 0===e?void 0:e.isSpaceRoom();let s=!1;const o=this.state.canonicalAlias||"",a=r.a.createElement(l.a,{onChange:this.onCanonicalAliasChange,value:o,disabled:this.state.updatingCanonicalAlias||!this.props.canSetCanonicalAlias,element:"select",id:"canonicalAlias",label:Object(c.a)("Main address")},r.a.createElement("option",{value:"",key:"unset"},Object(c.a)("not specified")),this.getAliases().map((e,t)=>(e===this.state.canonicalAlias&&(s=!0),r.a.createElement("option",{value:e,key:t},e))),s||!this.state.canonicalAlias?"":r.a.createElement("option",{value:this.state.canonicalAlias,key:"arbitrary"},this.state.canonicalAlias));let d;return d=this.state.localAliasesLoading?r.a.createElement(m.a,null):r.a.createElement(C,{id:"roomAliases",items:this.state.localAliases,newItem:this.state.newAlias,onNewItemChanged:this.onNewAliasChanged,canRemove:this.props.canSetAliases,canEdit:this.props.canSetAliases,onItemAdded:this.onLocalAliasAdded,onItemRemoved:this.onLocalAliasDeleted,noItemsLabel:i?Object(c.a)("This space has no local addresses"):Object(c.a)("This room has no local addresses"),placeholder:Object(c.a)("Local address"),domain:n}),r.a.createElement("div",{className:"mx_AliasSettings"},r.a.createElement(_.a,{"data-test-id":"published-address-fieldset",legend:Object(c.a)("Published Addresses"),description:r.a.createElement(r.a.Fragment,null,i?Object(c.a)("Published addresses can be used by anyone on any server to join your space."):Object(c.a)("Published addresses can be used by anyone on any server to join your room.")," ",Object(c.a)("To publish an address, it needs to be set as a local address first."))},a,this.props.hidePublishSetting?null:r.a.createElement(S,{roomId:this.props.roomId,canSetCanonicalAlias:this.props.canSetCanonicalAlias}),r.a.createElement("datalist",{id:"mx_AliasSettings_altRecommendations"},this.getLocalNonAltAliases().map(e=>r.a.createElement("option",{value:e,key:e})),";"),r.a.createElement(C,{id:"roomAltAliases",items:this.state.altAliases,newItem:this.state.newAltAlias,onNewItemChanged:this.onNewAltAliasChanged,canRemove:this.props.canSetCanonicalAlias,canEdit:this.props.canSetCanonicalAlias,onItemAdded:this.onAltAliasAdded,onItemRemoved:this.onAltAliasDeleted,suggestionsListId:"mx_AliasSettings_altRecommendations",itemsLabel:Object(c.a)("Other published addresses:"),noItemsLabel:Object(c.a)("No other published addresses yet, add one below"),placeholder:Object(c.a)("New published address (e.g. #alias:server)"),roomId:this.props.roomId})),r.a.createElement(_.a,{"data-test-id":"local-address-fieldset",legend:Object(c.a)("Local Addresses"),description:i?Object(c.a)("Set addresses for this space so users can find this space through your homeserver (%(localDomain)s)",{localDomain:n}):Object(c.a)("Set addresses for this room so users can find this room through your homeserver (%(localDomain)s)",{localDomain:n})},r.a.createElement("details",{onToggle:this.onLocalAliasesToggled,open:this.state.detailsOpen},r.a.createElement("summary",null,this.state.detailsOpen?Object(c.a)("Show less"):Object(c.a)("Show more")),d)))}}s()(O,"contextType",w.a),s()(O,"defaultProps",{canSetAliases:!1,canSetCanonicalAlias:!1})},function(e,t,n){"use strict";n.d(t,"a",(function(){return j}));var i=n(99),s=n.n(i),o=n(88),r=n.n(o),a=n(87),c=n.n(a),l=n(0),d=n(170),u=n(89),h=n(768),m=n(175),p=n(410);class g extends c.a.PureComponent{constructor(e){super(e),r()(this,"onTimeUpdate",e=>{this.setState({durationSeconds:e[1]})}),this.state={durationSeconds:this.props.playback.clockInfo.durationSeconds},this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}render(){return c.a.createElement(p.a,{seconds:this.state.durationSeconds})}}var f=n(779),v=n(780),b=n(781);class y extends b.a{renderFileSize(){const e=this.props.playback.sizeBytes;return e?`(${Object(m.a)(e)})`:null}renderComponent(){return c.a.createElement("div",{className:"mx_MediaBody mx_AudioPlayer_container",tabIndex:0,onKeyDown:this.onKeyDown},c.a.createElement("div",{className:"mx_AudioPlayer_primaryContainer"},c.a.createElement(h.a,{playback:this.props.playback,playbackPhase:this.state.playbackPhase,tabIndex:-1,ref:this.playPauseRef}),c.a.createElement("div",{className:"mx_AudioPlayer_mediaInfo"},c.a.createElement("span",{className:"mx_AudioPlayer_mediaName"},this.props.mediaName||Object(u.a)("Unnamed audio")),c.a.createElement("div",{className:"mx_AudioPlayer_byline"},c.a.createElement(g,{playback:this.props.playback}),"  ",this.renderFileSize()))),c.a.createElement("div",{className:"mx_AudioPlayer_seek"},c.a.createElement(f.a,{playback:this.props.playback,tabIndex:-1,playbackPhase:this.state.playbackPhase,ref:this.seekRef}),c.a.createElement(v.a,{playback:this.props.playback,defaultDisplaySeconds:0})))}}var S=n(303),E=n(586),w=n(153),_=n(97),C=n(239),O=n(123),R=n(90),I=n(121),k=n(129);class x{constructor(e){this.room=e,r()(this,"playbacks",new Map),r()(this,"clockStates",new Map),r()(this,"playbackIdOrder",[]),r()(this,"currentPlaybackId",void 0),r()(this,"recentFullPlays",new Set),this.loadClocks(),k.a.instance.addRoomListener(this.room.roomId,e=>{e&&(this.currentPlaybackId=null,this.recentFullPlays=new Set,this.playbackIdOrder=[])})}static forRoom(e){const t=R.a.get().getRoom(e);if(!t)throw new Error("Unknown room");if(x.queues.has(t.roomId))return x.queues.get(t.roomId);const n=new x(t);return x.queues.set(t.roomId,n),n}persistClocks(){localStorage.setItem("mx_voice_message_clocks_"+this.room.roomId,JSON.stringify(Array.from(this.clockStates.entries())))}loadClocks(){const e=localStorage.getItem("mx_voice_message_clocks_"+this.room.roomId);e&&(this.clockStates=new Map(JSON.parse(e)))}unsortedEnqueue(e,t){this.playbacks.set(e.getId(),t),t.on(O.b,n=>this.onPlaybackStateChange(t,e,n)),t.clockInfo.liveData.onUpdate(n=>this.onPlaybackClock(t,e,n))}onPlaybackStateChange(e,t,n){const i=this.currentPlaybackId===t.getId();if(n===C.d.Stopped&&this.clockStates.has(t.getId())&&!i)e.skipTo(this.clockStates.get(t.getId()));else if(n===C.d.Stopped&&(this.clockStates.delete(t.getId()),i)){this.recentFullPlays.add(this.currentPlaybackId);const e=Object(I.b)(this.playbackIdOrder),n=e.pop();if(n===this.currentPlaybackId){const i=e.pop();if(i){const t=this.playbacks.get(i);t?(this.playbackIdOrder=e,E.a.instance.pauseAllExcept(t),t.play()):l.a.warn(`Voice message queue desync: Missing playback for next message: Current=${this.currentPlaybackId} Last=${n} Next=${i}`)}else{const n=Object(I.b)(this.room.getLiveTimeline().getEvents());let i,s=!1;for(const e of n){if(e.getId()===t.getId()){s=!0;continue}if(!s)continue;if(!Object(w.l)(e)){const t=e.getType();if(t!==_.b.RoomMessage&&t!==_.b.Sticker)continue;break}const n=this.playbacks.has(e.getId()),o=this.recentFullPlays.has(e.getId());if(n&&!o){i=e;break}}if(i){this.playbackIdOrder=e;const t=this.playbacks.get(i.getId());E.a.instance.pauseAllExcept(t),t.play()}else this.recentFullPlays=new Set,this.playbackIdOrder=[]}}else l.a.warn(`Voice message queue desync: Expected playback stop to be last in order. Current=${this.currentPlaybackId} Last=${n} EventID=${t.getId()}`)}if(n===C.d.Playing){const e=this.playbackIdOrder;if(this.currentPlaybackId!==t.getId()&&this.currentPlaybackId&&(0===e.length||e[e.length-1]!==this.currentPlaybackId)){const t=this.playbacks.get(this.currentPlaybackId);t.currentState!==C.d.Playing&&t.currentState!==C.d.Paused||e.push(this.currentPlaybackId)}this.currentPlaybackId=t.getId(),0!==e.length&&e[e.length-1]===this.currentPlaybackId||e.push(this.currentPlaybackId)}n!==C.d.Paused&&n!==C.d.Stopped||this.persistClocks()}onPlaybackClock(e,t,n){e.currentState!==C.d.Decoding&&e.currentState!==C.d.Stopped&&this.clockStates.set(t.getId(),n[0])}}r()(x,"queues",new Map);var T=n(106);class j extends c.a.PureComponent{constructor(e){super(e),r()(this,"context",void 0),this.state={}}async componentDidMount(){var e,t;let n;try{try{const e=await this.props.mediaEventHelper.sourceBlob.value;n=await e.arrayBuffer()}catch(e){return this.setState({error:e}),void l.a.warn("Unable to decrypt audio message",e)}}catch(e){return this.setState({error:e}),void l.a.warn("Unable to decrypt/download audio message",e)}const i=this.props.mxEvent.getContent(),s=null==i||null===(e=i["org.matrix.msc1767.audio"])||void 0===e||null===(t=e.waveform)||void 0===t?void 0:t.map(e=>e/1024),o=E.a.instance.createPlaybackInstance(n,s);o.clockInfo.populatePlaceholdersFrom(this.props.mxEvent),this.setState({playback:o}),Object(w.l)(this.props.mxEvent)&&x.forRoom(this.props.mxEvent.getRoomId()).unsortedEnqueue(this.props.mxEvent,o)}componentWillUnmount(){var e;null===(e=this.state.playback)||void 0===e||e.destroy()}get showFileBody(){return this.context.timelineRenderingType!==T.a.Room&&this.context.timelineRenderingType!==T.a.Pinned&&this.context.timelineRenderingType!==T.a.Search}render(){if(this.state.error)return c.a.createElement("span",{className:"mx_MAudioBody"},c.a.createElement("img",{src:n(304).default,width:"16",height:"16"}),Object(u.a)("Error processing audio message"));if(this.props.forExport){var e;const t=this.props.mxEvent.getContent(),n=(null===(e=t.file)||void 0===e?void 0:e.url)||t.url;return c.a.createElement("span",{className:"mx_MAudioBody"},c.a.createElement("audio",{src:n,controls:!0}))}return this.state.playback?c.a.createElement("span",{className:"mx_MAudioBody"},c.a.createElement(y,{playback:this.state.playback,mediaName:this.props.mxEvent.getContent().body}),this.showFileBody&&c.a.createElement(S.a,s()({},this.props,{showGenericPlaceholder:!1}))):c.a.createElement("span",{className:"mx_MAudioBody"},c.a.createElement(d.a,null))}}r()(j,"contextType",T.b)},function(e,t,n){"use strict";n.d(t,"c",(function(){return C})),n.d(t,"a",(function(){return O})),n.d(t,"d",(function(){return R})),n.d(t,"b",(function(){return k}));var i=n(145),s=n(90),o=n(92),r=n(95),a=n(146),c=n(214),l=n(87),d=n.n(l),u=n(89),h=n(269),m=n(91),p=n(101);var g=e=>{let t,n,{device:i,user:o,onFinished:r}=e;return s.a.get().getUserId()===o.userId?(n=Object(u.a)("You signed in to a new session without verifying it:"),t=Object(u.a)("Verify your other session using one of the options below.")):(n=Object(u.a)("%(name)s (%(userId)s) signed in to a new session without verifying it:",{name:o.displayName,userId:o.userId}),t=Object(u.a)("Ask this user to verify their session, or manually verify it below.")),d.a.createElement(p.a,{onFinished:r,className:"mx_UntrustedDeviceDialog",title:d.a.createElement(d.a.Fragment,null,d.a.createElement(h.b,{status:h.a.Warning,size:24,hideTooltip:!0}),Object(u.a)("Not Trusted"))},d.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},d.a.createElement("p",null,n),d.a.createElement("p",null,i.getDisplayName()," (",i.deviceId,")"),d.a.createElement("p",null,t)),d.a.createElement("div",{className:"mx_Dialog_buttons"},d.a.createElement(m.a,{kind:"primary_outline",onClick:()=>r("legacy")},Object(u.a)("Manually Verify by Text")),d.a.createElement(m.a,{kind:"primary_outline",onClick:()=>r("sas")},Object(u.a)("Interactively verify by Emoji")),d.a.createElement(m.a,{kind:"primary",onClick:()=>r(!1)},Object(u.a)("Done"))))},f=n(88),v=n.n(f),b=n(175),y=n(115);class S extends d.a.Component{constructor(){super(...arguments),v()(this,"onLegacyFinished",e=>{e&&s.a.get().setDeviceVerified(this.props.userId,this.props.device.deviceId,!0),this.props.onFinished(e)})}render(){let e;e=s.a.get().getUserId()===this.props.userId?Object(u.a)("Confirm by comparing the following with the User Settings in your other session:"):Object(u.a)("Confirm this user's session by comparing the following with their User Settings:");const t=b.e(this.props.device.getFingerprint()),n=d.a.createElement("div",null,d.a.createElement("p",null,e),d.a.createElement("div",{className:"mx_DeviceVerifyDialog_cryptoSection"},d.a.createElement("ul",null,d.a.createElement("li",null,d.a.createElement("label",null,Object(u.a)("Session name"),":")," ",d.a.createElement("span",null,this.props.device.getDisplayName())),d.a.createElement("li",null,d.a.createElement("label",null,Object(u.a)("Session ID"),":")," ",d.a.createElement("span",null,d.a.createElement("code",null,this.props.device.deviceId))),d.a.createElement("li",null,d.a.createElement("label",null,Object(u.a)("Session key"),":")," ",d.a.createElement("span",null,d.a.createElement("code",null,d.a.createElement("b",null,t)))))),d.a.createElement("p",null,Object(u.a)("If they don't match, the security of your communication may be compromised.")));return d.a.createElement(y.a,{title:Object(u.a)("Verify session"),description:n,button:Object(u.a)("Verify session"),onFinished:this.onLegacyFinished})}}var E=n(139),w=n(301);async function _(){const e=s.a.get();if(!e.isCryptoEnabled())return!1;return!!e.getCrossSigningId("user_signing")||(await Object(c.b)(),!1)}async function C(e,t){const n=s.a.get();n.isGuest()?o.a.dispatch({action:"require_registration"}):n.getCryptoTrustCrossSignedDevices()&&!await _()||r.a.createTrackedDialog("Verification warning","unverified session",g,{user:e,device:t,onFinished:async s=>{if("sas"===s){const s=n.legacyDeviceVerification(e.userId,t.deviceId,i.e.SAS);I({member:e,verificationRequestPromise:s})}else"legacy"===s&&r.a.createTrackedDialog("Legacy verify session","legacy verify session",S,{userId:e.userId,device:t})}})}async function O(e){const t=s.a.get();if(t.isGuest())return void o.a.dispatch({action:"require_registration"});if(t.getCryptoTrustCrossSignedDevices()&&!await _())return;I({member:e,verificationRequestPromise:t.requestVerification(e.userId)})}async function R(e){if(s.a.get().isGuest())return void o.a.dispatch({action:"require_registration"});if(!await _())return;I({member:e,verificationRequest:k(e)})}function I(e){E.a.instance.roomPhaseHistory.some(e=>e.phase==a.a.RoomSummary)?E.a.instance.pushCard({phase:a.a.EncryptionPanel,state:e}):E.a.instance.setCards([{phase:a.a.RoomSummary},{phase:a.a.RoomMemberInfo,state:{member:e.member}},{phase:a.a.EncryptionPanel,state:e}])}function k(e){const t=s.a.get(),n=Object(w.c)(t,e.userId);if(n)return t.findVerificationRequestDMInProgress(n.roomId)}},function(e,t,n){"use strict";n.d(t,"c",(function(){return c.d})),n.d(t,"a",(function(){return c.a})),n.d(t,"b",(function(){return c.c}));var i=n(17),s=n.n(i),o=n(0),r=n(161),a=n(366),c=n(367);const l=a.a.DeviceVerification;class d extends c.e{constructor(){super(...arguments),s()(this,"sessionPrepared",!1),s()(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then(()=>this.crypto.ensureOlmSessionsForUsers(e)).then(()=>{this.sessionPrepared=!0}).finally(()=>{this.prepPromise=null}),this.prepPromise)}async encryptMessage(e,t,n){const i=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));await this.ensureSession(i);const s={room_id:e.roomId,type:t,content:n},o={algorithm:r.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},a=[];for(let e=0;e<i.length;++e){const t=i[e],n=this.crypto.getStoredDevicesForUser(t);for(let e=0;e<n.length;++e){const i=n[e];i.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(i.verified!=l.BLOCKED&&a.push(r.encryptMessageForDevice(o.ciphertext,this.userId,this.deviceId,this.olmDevice,t,i,s)))}}return Promise.all(a).then(()=>o)}}class u extends c.b{async decryptEvent(e){const t=e.getWireContent(),n=t.sender_key,i=t.ciphertext;if(!i)throw new c.c("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in i))throw new c.c("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const s=i[this.olmDevice.deviceCurve25519Key];let o;try{o=await this.decryptMessage(n,s)}catch(e){throw new c.c("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:n,err:e})}const r=JSON.parse(o);if(r.recipient!=this.userId)throw new c.c("OLM_BAD_RECIPIENT","Message was intented for "+r.recipient);if(r.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new c.c("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:r.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});if(r.sender!=e.getSender())throw new c.c("OLM_FORWARDED_MESSAGE","Message forwarded from "+r.sender,{reported_sender:e.getSender()});if(r.room_id!==e.getRoomId())throw new c.c("OLM_BAD_ROOM","Message intended for room "+r.room_id,{reported_room:e.getRoomId()});return{clearEvent:r,senderCurve25519Key:n,claimedEd25519Key:(r.keys||{}).ed25519||null}}decryptMessage(e,t){if(0!==t.type)return this.reallyDecryptMessage(e,t);{const n=this.olmDevice.olmPrekeyPromise.then(()=>this.reallyDecryptMessage(e,t));return this.olmDevice.olmPrekeyPromise=n.catch(()=>{}),n}}async reallyDecryptMessage(e,t){const n=await this.olmDevice.getSessionIdsForDevice(e),i={};for(let s=0;s<n.length;s++){const r=n[s];try{const n=await this.olmDevice.decryptMessage(e,r,t.type,t.body);return o.a.log("Decrypted Olm message from "+e+" with session "+r),n}catch(n){if(await this.olmDevice.matchesSession(e,r,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+r+": "+n.message);i[r]=n.message}}if(0!==t.type){if(0===n.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(i))}let s;try{s=await this.olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw i["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(i))}return o.a.log("created new inbound Olm session ID "+s.session_id+" with "+e),s.payload}}Object(c.g)(r.OLM_ALGORITHM,d,u);n(601)},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(0);class r{constructor(e){this.tagId=e,s()(this,"_n",0),s()(this,"_previews",!1),s()(this,"_collapsed",!1);const t=localStorage.getItem(this.key);if(t){const e=JSON.parse(t);this._n=e.numTiles,this._previews=e.showPreviews,this._collapsed=e.collapsed}}get isCollapsed(){return this._collapsed}set isCollapsed(e){this._collapsed=e,this.save()}get showPreviews(){return this._previews}set showPreviews(e){this._previews=e,this.save()}get tileHeight(){return 44}get key(){return`mx_sublist_layout_${this.tagId}_boxed`}get visibleTiles(){return 0===this._n?this.defaultVisibleTiles:Math.max(this._n,this.minVisibleTiles)}set visibleTiles(e){this._n=e,this.save()}get minVisibleTiles(){return 1}get defaultVisibleTiles(){return 8}tilesWithPadding(e,t){return this.pixelsToTiles(this.tilesToPixelsWithPadding(e,t))}tilesToPixelsWithPadding(e,t){return this.tilesToPixels(e)+t}tilesToPixels(e){return e*this.tileHeight}pixelsToTiles(e){return e/this.tileHeight}reset(){localStorage.removeItem(this.key)}save(){localStorage.setItem(this.key,JSON.stringify(this.serialize()))}serialize(){return{numTiles:this.visibleTiles,showPreviews:this.showPreviews,collapsed:this.isCollapsed}}}var a=n(167),c=n(92);class l extends a.a{constructor(){super(c.a),s()(this,"layoutMap",new Map)}static get instance(){return l.internalInstance||(l.internalInstance=new l),l.internalInstance}ensureLayoutExists(e){this.layoutMap.has(e)||this.layoutMap.set(e,new r(e))}getLayoutFor(e){return this.layoutMap.has(e)||this.layoutMap.set(e,new r(e)),this.layoutMap.get(e)}async resetLayouts(){o.a.warn("Resetting layouts for room list");for(const e of this.layoutMap.values())e.reset()}async onNotReady(){this.layoutMap.clear()}async onAction(e){}}s()(l,"internalInstance",void 0),window.mxRoomListLayoutStore=l.instance},function(e,t,n){"use strict";n.d(t,"a",(function(){return B})),n.d(t,"b",(function(){return H}));var i=n(88),s=n.n(i),o=n(99),r=n.n(o),a=n(87),c=n.n(a),l=n(97),d=n(89),u=n(134),h=n(189),m=n(129),p=n(166),g=n(92),f=n(791),v=n(90),b=n(94),y=n.n(b),S=n(210);class E extends c.a.Component{constructor(e){super(e),s()(this,"onTileMouseEnter",()=>{this.setState({hover:!0})}),s()(this,"onTileMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){var e;const t=y()({mx_ExtraTile:!0,mx_RoomTile:!0,mx_RoomTile_selected:this.props.isSelected,mx_RoomTile_minimized:this.props.isMinimized});let n;this.props.notificationState&&(n=c.a.createElement(S.a,{notification:this.props.notificationState,forceCount:!1}));let i=this.props.displayName;"string"!=typeof i&&(i=""),i=i.replace(":",":​");const s=y()({mx_RoomTile_title:!0,mx_RoomTile_titleHasUnreadEvents:null===(e=this.props.notificationState)||void 0===e?void 0:e.isUnread});let o=c.a.createElement("div",{className:"mx_RoomTile_titleContainer"},c.a.createElement("div",{title:i,className:s,tabIndex:-1,dir:"auto"},i));this.props.isMinimized&&(o=null);let r=u.a;return this.props.isMinimized&&(r=u.b),c.a.createElement(c.a.Fragment,null,c.a.createElement(r,{className:t,onMouseEnter:this.onTileMouseEnter,onMouseLeave:this.onTileMouseLeave,onClick:this.props.onClick,role:"treeitem",title:this.props.isMinimized?i:void 0},c.a.createElement("div",{className:"mx_RoomTile_avatarContainer"},this.props.avatar),c.a.createElement("div",{className:"mx_RoomTile_details"},c.a.createElement("div",{className:"mx_RoomTile_primaryDetails"},o,c.a.createElement("div",{className:"mx_RoomTile_badgeContainer"},n)))))}}var w=n(96),_=n(172),C=n(121),O=n(164),R=n(154),I=n(91),k=n(131),x=n(171),T=n(213),j=n(130),N=n(185),P=n(122),D=n(117),A=n(118),M=n(112),U=n(100),L=n(93),F=n(127);const B=[p.a.Invite,p.a.Favourite,p.a.DM,p.a.Untagged,p.a.LowPriority,p.a.ServerNotice,p.a.Suggested,p.a.Archived],K=[p.a.DM,p.a.Untagged],V=e=>{const t=e.current.getBoundingClientRect();return{chevronFace:M.a.None,left:t.left-7,top:t.top+t.height}},W={[p.a.Invite]:{sectionLabel:Object(d.c)("Invites"),isInvite:!0,defaultHidden:!1},[p.a.Favourite]:{sectionLabel:Object(d.c)("Favourites"),isInvite:!1,defaultHidden:!1},[p.a.DM]:{sectionLabel:Object(d.c)("People"),isInvite:!1,defaultHidden:!1,AuxButtonComponent:e=>{let{tabIndex:t,dispatcher:n=g.a}=e;const[i,s,o,a]=Object(M.q)(),l=Object(A.b)(k.a.instance,x.d,()=>k.a.instance.activeSpaceRoom),u=Object(N.a)(P.a.CreateRooms),h=Object(N.a)(P.a.InviteUsers);if(l&&(u||h)){let e;if(i){const t=Object(T.c)(l);e=c.a.createElement(R.e,r()({},V(s),{onFinished:a,compact:!0}),c.a.createElement(R.c,{first:!0},u&&c.a.createElement(R.b,{label:Object(d.a)("Start new chat"),iconClassName:"mx_RoomList_iconStartChat",onClick:e=>{e.preventDefault(),e.stopPropagation(),a(),g.a.dispatch({action:"view_create_chat"}),F.b.trackInteraction("WebRoomListRoomsSublistPlusMenuCreateChatItem",e)}}),h&&c.a.createElement(R.b,{label:Object(d.a)("Invite to space"),iconClassName:"mx_RoomList_iconInvite",onClick:e=>{e.preventDefault(),e.stopPropagation(),a(),Object(T.i)(l)},disabled:!t,tooltip:t?void 0:Object(d.a)("You do not have permissions to invite people to this space")})))}return c.a.createElement(c.a.Fragment,null,c.a.createElement(M.c,{tabIndex:t,onClick:o,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":Object(d.a)("Add people"),title:Object(d.a)("Add people"),isExpanded:i,inputRef:s}),e)}return!l&&u?c.a.createElement(D.a,{tabIndex:t,onClick:e=>{n.dispatch({action:"view_create_chat"}),F.b.trackInteraction("WebRoomListRoomsSublistPlusMenuCreateChatItem",e)},className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":Object(d.a)("Start chat"),title:Object(d.a)("Start chat")}):null}},[p.a.Untagged]:{sectionLabel:Object(d.c)("Rooms"),isInvite:!1,defaultHidden:!1,AuxButtonComponent:e=>{let{tabIndex:t}=e;const[n,i,s,o]=Object(M.q)(),a=Object(A.b)(k.a.instance,x.d,()=>k.a.instance.activeSpaceRoom),u=Object(N.a)(P.a.CreateRooms);let h,m;if(n&&a){const e=a.currentState.maySendStateEvent(l.b.SpaceChild,v.a.get().getUserId());h=c.a.createElement(R.c,{first:!0},c.a.createElement(R.b,{label:Object(d.a)("Explore rooms"),iconClassName:"mx_RoomList_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),o(),g.a.dispatch({action:w.a.ViewRoom,room_id:a.roomId,metricsTrigger:void 0}),F.b.trackInteraction("WebRoomListRoomsSublistPlusMenuExploreRoomsItem",e)}}),u?c.a.createElement(c.a.Fragment,null,c.a.createElement(R.b,{label:Object(d.a)("New room"),iconClassName:"mx_RoomList_iconNewRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),o(),Object(T.g)(a),F.b.trackInteraction("WebRoomListRoomsSublistPlusMenuCreateRoomItem",e)},disabled:!e,tooltip:e?void 0:Object(d.a)("You do not have permissions to create new rooms in this space")}),L.b.getValue("feature_video_rooms")&&c.a.createElement(R.b,{label:Object(d.a)("New video room"),iconClassName:"mx_RoomList_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),o(),Object(T.g)(a,l.f.ElementVideo)},disabled:!e,tooltip:e?void 0:Object(d.a)("You do not have permissions to create new rooms in this space")}),c.a.createElement(R.b,{label:Object(d.a)("Add existing room"),iconClassName:"mx_RoomList_iconAddExistingRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),o(),Object(T.e)(a)},disabled:!e,tooltip:e?void 0:Object(d.a)("You do not have permissions to add rooms to this space")})):null)}else n&&(h=c.a.createElement(R.c,{first:!0},u&&c.a.createElement(c.a.Fragment,null,c.a.createElement(R.b,{label:Object(d.a)("New room"),iconClassName:"mx_RoomList_iconNewRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),o(),g.a.dispatch({action:"view_create_room"}),F.b.trackInteraction("WebRoomListRoomsSublistPlusMenuCreateRoomItem",e)}}),L.b.getValue("feature_video_rooms")&&c.a.createElement(R.b,{label:Object(d.a)("New video room"),iconClassName:"mx_RoomList_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),o(),g.a.dispatch({action:"view_create_room",type:l.f.ElementVideo})}})),c.a.createElement(R.b,{label:Object(d.a)("Explore public rooms"),iconClassName:"mx_RoomList_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),o(),F.b.trackInteraction("WebRoomListRoomsSublistPlusMenuExploreRoomsItem",e),g.a.fire(w.a.ViewRoomDirectory)}})));return n&&(m=c.a.createElement(R.e,r()({},V(i),{onFinished:o,compact:!0}),h)),c.a.createElement(c.a.Fragment,null,c.a.createElement(M.c,{tabIndex:t,onClick:s,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":Object(d.a)("Add room"),title:Object(d.a)("Add room"),isExpanded:n,inputRef:i}),m)}},[p.a.LowPriority]:{sectionLabel:Object(d.c)("Low priority"),isInvite:!1,defaultHidden:!1},[p.a.ServerNotice]:{sectionLabel:Object(d.c)("System Alerts"),isInvite:!1,defaultHidden:!1},[p.a.Archived]:{sectionLabel:Object(d.c)("Historical"),isInvite:!1,defaultHidden:!0},[p.a.Suggested]:{sectionLabel:Object(d.c)("Suggested Rooms"),isInvite:!1,defaultHidden:!1}};class H extends c.a.PureComponent{constructor(e){super(e),s()(this,"dispatcherRef",void 0),s()(this,"roomStoreToken",void 0),s()(this,"treeRef",Object(a.createRef)()),s()(this,"context",void 0),s()(this,"onRoomViewStoreUpdate",()=>{this.setState({currentRoomId:m.a.instance.getRoomId()})}),s()(this,"onAction",e=>{if(e.action===w.a.ViewRoomDelta){const t=e,n=m.a.instance.getRoomId(),i=this.getRoomDelta(n,t.delta,t.unread);i&&g.a.dispatch({action:w.a.ViewRoom,room_id:i.roomId,show_room_tile:!0,metricsTrigger:"WebKeyboardShortcut",metricsViaKeyboard:!0})}else e.action===w.a.PstnSupportUpdated&&this.updateLists()}),s()(this,"getRoomDelta",(function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=h.b.instance.orderedLists,s=[];B.forEach(t=>{let o=i[t];n&&(o=o.filter(t=>{const n=_.a.instance.getRoomState(t);return n.room.roomId===e||n.isUnread})),s.push(...o)});const o=s.findIndex(t=>t.roomId===e),[r]=s.slice((o+t)%s.length);return r})),s()(this,"updateSuggestedRooms",e=>{this.setState({suggestedRooms:e})}),s()(this,"updateLists",()=>{const e=h.b.instance.orderedLists,t=Object.keys(this.state.sublists),n=Object.keys(e),i=!!h.b.instance.getFirstNameFilterCondition();let s=this.state.isNameFiltering!==i||Object(C.d)(t,n);if(!s)for(const t of n){const n=this.state.sublists[t],i=e[t];if(n.length!==i.length){s=!0;break}}if(s){const t=Object(O.f)(e,n),s=Object(O.e)(t,(e,t)=>Object(C.b)(t));this.setState({sublists:s,isNameFiltering:i},()=>{this.props.onResize()})}}),s()(this,"onStartChat",e=>{var t;const n=null===(t=h.b.instance.getFirstNameFilterCondition())||void 0===t?void 0:t.search;g.a.dispatch({action:"view_create_chat",initialText:n}),F.b.trackInteraction("WebRoomListRoomsSublistPlusMenuCreateChatItem",e)}),s()(this,"onExplore",e=>{if(Object(x.h)(this.props.activeSpace)){var t;const n=null===(t=h.b.instance.getFirstNameFilterCondition())||void 0===t?void 0:t.search;g.a.dispatch({action:w.a.ViewRoomDirectory,initialText:n}),F.b.trackInteraction("WebRoomListRoomsSublistPlusMenuExploreRoomsItem",e)}else g.a.dispatch({action:w.a.ViewRoom,room_id:this.props.activeSpace,metricsTrigger:void 0}),F.b.trackInteraction("WebRoomListRoomsSublistPlusMenuExploreRoomsItem",e)}),this.state={sublists:{},isNameFiltering:!!h.b.instance.getFirstNameFilterCondition(),suggestedRooms:k.a.instance.suggestedRooms}}componentDidMount(){this.dispatcherRef=g.a.register(this.onAction),this.roomStoreToken=m.a.instance.addListener(this.onRoomViewStoreUpdate),k.a.instance.on(x.e,this.updateSuggestedRooms),h.b.instance.on(h.a,this.updateLists),this.updateLists()}componentWillUnmount(){k.a.instance.off(x.e,this.updateSuggestedRooms),h.b.instance.off(h.a,this.updateLists),g.a.unregister(this.dispatcherRef),this.roomStoreToken&&this.roomStoreToken.remove()}renderSuggestedRooms(){return this.state.suggestedRooms.map(e=>{var t;const n=e.name||e.canonical_alias||(null===(t=e.aliases)||void 0===t?void 0:t[0])||Object(d.a)("Empty room"),i=c.a.createElement(j.a,{oobData:{name:n,avatarUrl:e.avatar_url},width:32,height:32,resizeMethod:"crop"});return c.a.createElement(E,{isMinimized:this.props.isMinimized,isSelected:this.state.currentRoomId===e.room_id,displayName:n,avatar:i,onClick:t=>{var i;g.a.dispatch({action:w.a.ViewRoom,room_alias:e.canonical_alias||(null===(i=e.aliases)||void 0===i?void 0:i[0]),room_id:e.room_id,via_servers:e.viaServers,oob_data:{avatarUrl:e.avatar_url,name:n},metricsTrigger:"RoomList",metricsViaKeyboard:"click"!==t.type})},key:"suggestedRoomTile_"+e.room_id})})}renderSublists(){var e;const t=!this.state.isNameFiltering&&!(null!==(e=this.state.suggestedRooms)&&void 0!==e&&e.length)&&Object.values(h.b.instance.unfilteredLists).every(e=>!(null!=e&&e.length));return B.map(e=>{let n=null;e===p.a.Suggested&&(n=this.renderSuggestedRooms());const i=W[e];if(!i)throw new Error(`Tag ${e} does not have aesthetics`);let s=K.includes(e);(this.props.activeSpace===x.a.Favourites&&e!==p.a.Favourite||this.props.activeSpace===x.a.People&&e!==p.a.DM||this.props.activeSpace===x.a.Orphans&&e===p.a.DM||!Object(x.h)(this.props.activeSpace)&&e===p.a.DM&&!L.b.getValue("Spaces.showPeopleInSpace",this.props.activeSpace))&&(s=!1);let o=!1;return(this.props.activeSpace===x.a.Favourites&&e===p.a.Favourite||this.props.activeSpace===x.a.People&&e===p.a.DM)&&(o=!0),c.a.createElement(f.b,{key:"sublist-"+e,tagId:e,forRooms:!0,startAsHidden:i.defaultHidden,label:i.sectionLabelRaw?i.sectionLabelRaw:Object(d.a)(i.sectionLabel),AuxButtonComponent:i.AuxButtonComponent,isMinimized:this.props.isMinimized,showSkeleton:t,extraTiles:n,resizeNotifier:this.props.resizeNotifier,alwaysVisible:s,onListCollapse:this.props.onListCollapse,forceExpanded:o})})}focus(){var e,t;const n=null===(e=this.treeRef.current)||void 0===e?void 0:e.querySelectorAll('[role="treeitem"]');n&&(null===(t=[...n].find(e=>null!==e.offsetParent))||void 0===t||t.focus())}render(){let e;this.props.isMinimized||this.state.isNameFiltering&&(e=c.a.createElement("div",{className:"mx_RoomList_explorePrompt"},c.a.createElement("div",null,Object(d.a)("Can't see what you're looking for?")),c.a.createElement(I.a,{className:"mx_RoomList_explorePrompt_startChat",kind:"link",onClick:this.onStartChat},Object(d.a)("Start a new chat")),c.a.createElement(I.a,{className:"mx_RoomList_explorePrompt_explore",kind:"link",onClick:this.onExplore},Object(x.h)(this.props.activeSpace)?Object(d.a)("Explore all public rooms"):Object(d.a)("Explore rooms"))));const t=this.renderSublists();return c.a.createElement(u.d,{handleHomeEnd:!0,handleUpDown:!0,onKeyDown:this.props.onKeyDown},n=>{let{onKeyDownHandler:i}=n;return c.a.createElement("div",{onFocus:this.props.onFocus,onBlur:this.props.onBlur,onKeyDown:i,className:"mx_RoomList",role:"tree","aria-label":Object(d.a)("Rooms"),ref:this.treeRef},t,e)})}}s()(H,"contextType",U.a)},function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(125),r=n(97),a=n(302),c=n(89),l=n(91),d=n(130),u=n(131),h=n(90),m=n(95),p=n(113),g=n(101),f=n(300),v=n(176),b=n(141),y=n(100);const S=e=>{let{room:t,checked:n,onChange:i}=e;const o=t instanceof p.b;let r;if(o){r=Object(c.a)("%(count)s members",{count:t.getJoinedMemberCount()});const e=u.a.instance.getChildRooms(t.roomId).length;e>0&&(r+=" · "+Object(c.a)("%(count)s rooms",{count:e}))}return s.a.createElement("label",{className:"mx_ManageRestrictedJoinRuleDialog_entry"},s.a.createElement("div",null,s.a.createElement("div",null,o?s.a.createElement(d.a,{room:t,height:20,width:20}):s.a.createElement(d.a,{oobData:t,height:20,width:20}),s.a.createElement("span",{className:"mx_ManageRestrictedJoinRuleDialog_entry_name"},t.name)),r&&s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_entry_description"},r)),s.a.createElement(b.b,{onChange:i?e=>i(e.target.checked):null,checked:n,disabled:!i}))},E=(e,t)=>{const n=t.client;Array.from(u.a.instance.getKnownParents(t.roomId)).map(e=>n.getRoom(e)).forEach(t=>{e.has(t)||(e.add(t),E(e,t))})};var w=e=>{let{room:t,selected:n=[],onFinished:o}=e;const r=t.client,[a,d]=Object(i.useState)(new Set(n)),[u,h]=Object(i.useState)(""),m=u.toLowerCase().trim(),[p,b]=Object(i.useMemo)(()=>{const e=new Set;return E(e,t),[Array.from(e),n.map(e=>{const t=r.getRoom(e);return t?"join"===t.getMyMembership()&&t.isSpaceRoom()?void 0:t:{roomId:e,name:e}}).filter(Boolean)]},[r,n,t]),[w,_]=Object(i.useMemo)(()=>[p.filter(e=>e.name.toLowerCase().includes(m)),b.filter(e=>e.name.toLowerCase().includes(m))],[p,b,m]),C=(e,t)=>{e?a.add(t.roomId):a.delete(t.roomId),d(new Set(a))};let O;return a.size<1&&(O=s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section_info"},Object(c.a)("You're removing all spaces. Access will default to invite only"))),s.a.createElement(g.a,{title:Object(c.a)("Select spaces"),className:"mx_ManageRestrictedJoinRuleDialog",onFinished:o,fixedWidth:!1},s.a.createElement("p",null,Object(c.a)("Decide which spaces can access this room. If a space is selected, its members can find and join <RoomName/>.",{},{RoomName:()=>s.a.createElement("b",null,t.name)})),s.a.createElement(y.a.Provider,{value:r},s.a.createElement(f.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:Object(c.a)("Search spaces"),onSearch:h,autoFocus:!0}),s.a.createElement(v.a,{className:"mx_ManageRestrictedJoinRuleDialog_content"},w.length>0?s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section"},s.a.createElement("h3",null,t.isSpaceRoom()?Object(c.a)("Spaces you know that contain this space"):Object(c.a)("Spaces you know that contain this room")),w.map(e=>s.a.createElement(S,{key:e.roomId,room:e,checked:a.has(e.roomId),onChange:t=>{C(t,e)}}))):void 0,_.length>0?s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section"},s.a.createElement("h3",null,Object(c.a)("Other spaces or rooms you might not know")),s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section_info"},s.a.createElement("div",null,Object(c.a)("These are likely ones other room admins are a part of."))),_.map(e=>s.a.createElement(S,{key:e.roomId,room:e,checked:a.has(e.roomId),onChange:t=>{C(t,e)}}))):null,w.length+_.length<1?s.a.createElement("span",{className:"mx_ManageRestrictedJoinRuleDialog_noResults"},Object(c.a)("No results")):void 0),s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_footer"},O,s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_footer_buttons"},s.a.createElement(l.a,{kind:"primary_outline",onClick:()=>o()},Object(c.a)("Cancel")),s.a.createElement(l.a,{kind:"primary",onClick:()=>o(Array.from(a))},Object(c.a)("Confirm"))))))},_=n(752),C=n(407),O=n(121),R=n(800),I=n(92),k=n(356),x=n(96);t.a=e=>{var t;let{room:n,promptUpgrade:i,aliasWarning:p,onError:g,beforeChange:f,closeSettingsFn:v}=e;const b=n.client,y=u.a.instance.restrictedJoinRuleSupport,S=Array.isArray(null==y?void 0:y.support)&&y.support.includes(n.getVersion()),E=!S&&i?null==y?void 0:y.preferred:void 0,T=!n.currentState.mayClientSendStateEvent(r.b.RoomJoinRules,b),[j,N]=Object(R.a)(()=>{var e;return null===(e=n.currentState.getStateEvents(r.b.RoomJoinRules,""))||void 0===e?void 0:e.getContent()},e=>b.sendStateEvent(n.roomId,r.b.RoomJoinRules,e,""),g),{join_rule:P=o.c.Invite}=j||{},D=P===o.c.Restricted?null===(t=j.allow)||void 0===t?void 0:t.filter(e=>e.type===o.e.RoomMembership).map(e=>e.room_id):void 0,A=async()=>{var e;let t=D;null!==(e=t)&&void 0!==e&&e.length||!u.a.instance.activeSpaceRoom||(t=[u.a.instance.activeSpaceRoom.roomId]);const i=h.a.get(),{finished:s}=m.a.createTrackedDialog("Edit restricted","",w,{matrixClient:i,room:n,selected:t},"mx_ManageRestrictedJoinRuleDialog_wrapper"),[o]=await s;return o},M=[{value:o.c.Invite,label:Object(c.a)("Private (invite only)"),description:Object(c.a)("Only invited people can join."),checked:P===o.c.Invite||P===o.c.Restricted&&!(null!=D&&D.length)},{value:o.c.Public,label:Object(c.a)("Public"),description:s.a.createElement(s.a.Fragment,null,Object(c.a)("Anyone can find and join."),p)}];if(S||E||P===o.c.Restricted){let e,t;if(E&&(e=s.a.createElement("span",{className:"mx_JoinRuleSettings_upgradeRequired"},Object(c.a)("Upgrade required"))),P===o.c.Restricted&&null!=D&&D.length){const e=D.map(e=>b.getRoom(e)).filter(e=>null==e?void 0:e.isSpaceRoom()).slice(0,4);let n;e.length<D.length&&(n=e.length>0?Object(c.a)("& %(count)s more",{count:D.length-e.length}):Object(c.a)("Currently, %(count)s spaces have access",{count:D.length}));const i=e=>{Object(O.d)(D||[],e)&&(e.length?N({join_rule:o.c.Restricted,allow:e.map(e=>({type:o.e.RoomMembership,room_id:e}))}):N({join_rule:o.c.Invite}))},r=async()=>{const e=await A();Array.isArray(e)&&(e.length>0?i(e):U(o.c.Invite))};t=s.a.createElement("div",null,s.a.createElement("span",null,Object(c.a)("Anyone in a space can find and join. <a>Edit which spaces can access here.</a>",{},{a:e=>s.a.createElement(l.a,{disabled:T,onClick:r,kind:"link",className:"mx_JoinRuleSettings_linkButton"},e)})),s.a.createElement("div",{className:"mx_JoinRuleSettings_spacesWithAccess"},s.a.createElement("h4",null,Object(c.a)("Spaces with access")),e.map(e=>s.a.createElement("span",{key:e.roomId},s.a.createElement(d.a,{room:e,height:32,width:32}),e.name)),n&&s.a.createElement("span",null,n)))}else t=u.a.instance.activeSpaceRoom?Object(c.a)("Anyone in <spaceName/> can find and join. You can select other spaces too.",{},{spaceName:()=>s.a.createElement("b",null,u.a.instance.activeSpaceRoom.name)}):Object(c.a)("Anyone in a space can find and join. You can select multiple spaces.");M.splice(1,0,{value:o.c.Restricted,label:s.a.createElement(s.a.Fragment,null,Object(c.a)("Space members"),e),description:t,checked:P===o.c.Restricted&&!(null==D||!D.length)})}const U=async e=>{const t=j.join_rule;let i;if(e===o.c.Restricted){if(t===o.c.Restricted||S){if(i=await A(),!Array.isArray(i))return}else if(E){const e=E;let t;const i=b.getUserId();return Array.from(u.a.instance.getKnownParents(n.roomId)).some(e=>{var t;return!(null!==(t=b.getRoom(e))&&void 0!==t&&t.currentState.maySendStateEvent(r.b.SpaceChild,i))})&&(t=s.a.createElement("b",null,Object(c.a)("This room is in some spaces you're not an admin of. In those spaces, the old room will still be shown, but people will be prompted to join the new one."))),void m.a.createTrackedDialog("Restricted join rule upgrade","",_.a,{roomId:n.roomId,targetVersion:e,description:s.a.createElement(s.a.Fragment,null,Object(c.a)("This upgrade will allow members of selected spaces access to this room without an invite."),t),doUpgrade:async(t,i)=>{const s=await Object(C.b)(n,e,t.invite,!0,!0,!0,e=>{const t=2+e.updateSpacesTotal+e.inviteUsersTotal;e.roomUpgraded?e.roomSynced?e.inviteUsersProgress<e.inviteUsersTotal?i(Object(c.a)("Sending invites... (%(progress)s out of %(count)s)",{progress:e.inviteUsersProgress,count:e.inviteUsersTotal}),2+e.inviteUsersProgress,t):e.updateSpacesProgress<e.updateSpacesTotal&&i(Object(c.a)("Updating spaces... (%(progress)s out of %(count)s)",{progress:e.updateSpacesProgress,count:e.updateSpacesTotal}),2+e.inviteUsersProgress+e.updateSpacesProgress,t):i(Object(c.a)("Loading new room"),1,t):i(Object(c.a)("Upgrading room"),0,t)});v(),I.a.dispatch({action:x.a.ViewRoom,room_id:s,metricsTrigger:void 0}),I.a.dispatch({action:"open_room_settings",initial_tab_id:k.b})}})}i.length||(e=o.c.Invite)}if(t===e&&!i)return;if(f&&!await f(e))return;const a={join_rule:e};e===o.c.Restricted&&(a.allow=i.map(e=>({type:o.e.RoomMembership,room_id:e}))),N(a)};return s.a.createElement(a.a,{name:"joinRule",value:P,onChange:U,definitions:M,disabled:T,className:"mx_JoinRuleSettings_radioButton"})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return C}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(165),c=n(376),l=n.n(c),d=n(90),u=n(100),h=n(89),m=n(91),p=n(109),g=n(114);class f extends r.a.PureComponent{constructor(e){super(e),s()(this,"onKeyDown",e=>{switch(Object(g.a)().getAccessibilityAction(e)){case p.h.Escape:e.stopPropagation(),e.preventDefault(),this.cancel()}}),s()(this,"onCancel",()=>{this.cancel()}),s()(this,"onSubmit",e=>{e.stopPropagation(),e.preventDefault(),this.state.canSubmit&&this.submit()})}get matrixClient(){return d.a.get()}render(){return r.a.createElement(u.a.Provider,{value:this.matrixClient},r.a.createElement(l.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog","aria-labelledby":"mx_CompoundDialog_title","aria-describedby":"mx_CompoundDialog_content"},className:"mx_CompoundDialog mx_ScrollableBaseDialog"},r.a.createElement("div",{className:"mx_CompoundDialog_header"},r.a.createElement("h1",null,this.state.title),r.a.createElement(m.a,{onClick:this.onCancel,className:"mx_CompoundDialog_cancelButton","aria-label":Object(h.a)("Close dialog")})),r.a.createElement("form",{onSubmit:this.onSubmit},r.a.createElement("div",{className:"mx_CompoundDialog_content"},this.renderContent()),r.a.createElement("div",{className:"mx_CompoundDialog_footer"},r.a.createElement(m.a,{onClick:this.onCancel,kind:"primary_outline"},Object(h.a)("Cancel")),r.a.createElement(m.a,{onClick:this.onSubmit,kind:"primary",disabled:!this.state.canSubmit,type:"submit",element:"button",className:"mx_Dialog_nonDialogButton"},this.state.actionLabel)))))}}var v,b=n(115),y=n(95),S=n(121),E=n(105),w=n(102);!function(e){e[e.Topic=0]="Topic",e[e.NewOption=1]="NewOption"}(v||(v={}));function _(){return{title:Object(h.a)("Create poll"),actionLabel:Object(h.a)("Create Poll"),canSubmit:!1,question:"",options:Object(S.h)("",2),busy:!1,kind:a.M_POLL_KIND_DISCLOSED,autoFocusTarget:v.Topic}}class C extends f{constructor(e){super(e),s()(this,"addOptionRef",Object(o.createRef)()),s()(this,"onQuestionChange",e=>{this.setState({question:e.target.value},()=>this.checkCanSubmit())}),s()(this,"onOptionChange",(e,t)=>{const n=Object(S.b)(this.state.options);n[e]=t.target.value,this.setState({options:n},()=>this.checkCanSubmit())}),s()(this,"onOptionRemove",e=>{const t=Object(S.b)(this.state.options);t.splice(e,1),this.setState({options:t},()=>this.checkCanSubmit())}),s()(this,"onOptionAdd",()=>{const e=Object(S.b)(this.state.options);e.push(""),this.setState({options:e,autoFocusTarget:v.NewOption},()=>{var e,t;null===(e=this.addOptionRef.current)||void 0===e||null===(t=e.scrollIntoView)||void 0===t||t.call(e)})}),s()(this,"onPollTypeChange",e=>{this.setState({kind:a.M_POLL_KIND_DISCLOSED.matches(e.target.value)?a.M_POLL_KIND_DISCLOSED:a.M_POLL_KIND_UNDISCLOSED})}),this.state=e.editingMxEvent?function(e){const t=e.unstableExtensibleEvent;return null!=t&&t.isEquivalentTo(a.M_POLL_START)?{title:Object(h.a)("Edit poll"),actionLabel:Object(h.a)("Done"),canSubmit:!0,question:t.question.text,options:t.answers.map(e=>e.text),busy:!1,kind:t.kind,autoFocusTarget:v.Topic}:_()}(e.editingMxEvent):_()}checkCanSubmit(){this.setState({canSubmit:!this.state.busy&&this.state.question.trim().length>0&&this.state.options.filter(e=>e.trim().length>0).length>=2})}createEvent(){const e=a.PollStartEvent.from(this.state.question.trim(),this.state.options.map(e=>e.trim()).filter(e=>!!e),this.state.kind).serialize();return this.props.editingMxEvent?{content:{"m.new_content":e.content,"m.relates_to":{rel_type:"m.replace",event_id:this.props.editingMxEvent.getId()}},type:e.type}:e}submit(){this.setState({busy:!0,canSubmit:!1});const e=this.createEvent();this.matrixClient.sendEvent(this.props.room.roomId,this.props.threadId,e.type,e.content).then(()=>this.props.onFinished(!0)).catch(e=>{console.error("Failed to post poll:",e),y.a.createTrackedDialog("Failed to post poll","",b.a,{title:Object(h.a)("Failed to post poll"),description:Object(h.a)("Sorry, the poll you tried to create was not posted."),button:Object(h.a)("Try again"),cancelButton:Object(h.a)("Cancel"),onFinished:e=>{e?this.setState({busy:!1,canSubmit:!0}):this.cancel()}})})}cancel(){this.props.onFinished(!1)}renderContent(){return r.a.createElement("div",{className:"mx_PollCreateDialog"},r.a.createElement("h2",null,Object(h.a)("Poll type")),r.a.createElement(E.a,{element:"select",value:this.state.kind.name,onChange:this.onPollTypeChange},r.a.createElement("option",{key:a.M_POLL_KIND_DISCLOSED.name,value:a.M_POLL_KIND_DISCLOSED.name},Object(h.a)("Open poll")),r.a.createElement("option",{key:a.M_POLL_KIND_UNDISCLOSED.name,value:a.M_POLL_KIND_UNDISCLOSED.name},Object(h.a)("Closed poll"))),r.a.createElement("p",null,(e=this.state.kind,a.M_POLL_KIND_DISCLOSED.matches(e.name)?Object(h.a)("Voters see results as soon as they have voted"):Object(h.a)("Results are only revealed when you end the poll"))),r.a.createElement("h2",null,Object(h.a)("What is your poll question or topic?")),r.a.createElement(E.a,{id:"poll-topic-input",value:this.state.question,maxLength:340,label:Object(h.a)("Question or topic"),placeholder:Object(h.a)("Write something..."),onChange:this.onQuestionChange,usePlaceholderAsHint:!0,disabled:this.state.busy,autoFocus:this.state.autoFocusTarget===v.Topic}),r.a.createElement("h2",null,Object(h.a)("Create options")),this.state.options.map((e,t)=>r.a.createElement("div",{key:"option_"+t,className:"mx_PollCreateDialog_option"},r.a.createElement(E.a,{id:"pollcreate_option_"+t,value:e,maxLength:340,label:Object(h.a)("Option %(number)s",{number:t+1}),placeholder:Object(h.a)("Write an option"),onChange:e=>this.onOptionChange(t,e),usePlaceholderAsHint:!0,disabled:this.state.busy,autoFocus:this.state.autoFocusTarget===v.NewOption&&t===this.state.options.length-1}),r.a.createElement(m.a,{onClick:()=>this.onOptionRemove(t),className:"mx_PollCreateDialog_removeOption",disabled:this.state.busy}))),r.a.createElement(m.a,{onClick:this.onOptionAdd,disabled:this.state.busy||this.state.options.length>=20,kind:"secondary",className:"mx_PollCreateDialog_addOption",inputRef:this.addOptionRef},Object(h.a)("Add option")),this.state.busy&&r.a.createElement("div",{className:"mx_PollCreateDialog_busy"},r.a.createElement(w.a,null)));var e}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(0),s=n(606);var o=n(95),r=n(238),a=n(89),c=n(189),l=n(292),d=n(166),u=n(107);class h{static tagRoom(e,t,n,h,m,p){let g=null;const f=c.b.instance;if(h&&f.getTagSorting(h)===l.b.Manual){const e=[...f.orderedLists[h]];e.sort((e,t)=>e.tags[h].order-t.tags[h].order);const t=h===n&&m<p?1:0,i=t+p-1,s=t+p,o=i<=0?0:e[i].tags[h].order,r=s>=e.length?1:e[s].tags[h].order;g={order:(o+r)/2}}return v="RoomListActions.tagRoom",b=()=>{const s=[],c=t.roomId;if(void 0===n&&h===d.a.DM||n===d.a.DM&&void 0===h)return r.c(t,h===d.a.DM).catch(e=>{i.a.error("Failed to set DM tag "+e),o.a.createTrackedDialog("Failed to set direct message tag","",u.a,{title:Object(a.a)("Failed to set direct message tag"),description:e&&e.message?e.message:Object(a.a)("Operation failed")})});const l=n!==h;if(n&&n!==d.a.DM&&l){const t=e.deleteRoomTag(c,n).catch((function(e){i.a.error("Failed to remove tag "+n+" from room: "+e),o.a.createTrackedDialog("Failed to remove tag from room","",u.a,{title:Object(a.a)("Failed to remove tag %(tagName)s from room",{tagName:n}),description:e&&e.message?e.message:Object(a.a)("Operation failed")})}));s.push(t)}if(h&&h!==d.a.DM&&(l||g)){g=g||{};const t=e.setRoomTag(c,h,g).catch((function(e){throw i.a.error("Failed to add tag "+h+" to room: "+e),o.a.createTrackedDialog("Failed to add tag to room","",u.a,{title:Object(a.a)("Failed to add tag %(tagName)s to room",{tagName:h}),description:e&&e.message?e.message:Object(a.a)("Operation failed")}),e}));s.push(t)}return Promise.all(s)},y=()=>({room:t,oldTag:n,newTag:h,metaData:g}),new s.a(e=>{e({action:v+".pending",request:"function"==typeof y?y():void 0}),b().then(t=>{e({action:v+".success",result:t})}).catch(t=>{e({action:v+".failure",err:t})})});var v,b,y}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i);function o(e,t){const n=Math.min(e.length,t.length);for(let i=0;i<n;++i)if(e[i]!==t[i])return i;return n}function r(e,t,n){const i=n-(t.length-e.length);return function(e,t){const n=Math.min(e.length,t.length),i=e.slice(0,n)===t.slice(0,n);if(i&&e.length>t.length)return{removed:e.slice(n),at:n};if(i&&e.length<t.length)return{added:t.slice(n),at:n};{const n=o(e,t);return{removed:e.slice(n),added:t.slice(n),at:n}}}(e.substring(0,i),t.substring(0,n))}var a=n(715),c=n(508);class l{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.updateCallback=n,s()(this,"_parts",void 0),s()(this,"_partCreator",void 0),s()(this,"activePartIdx",null),s()(this,"_autoComplete",null),s()(this,"autoCompletePartIdx",null),s()(this,"autoCompletePartCount",0),s()(this,"transformCallback",null),s()(this,"onAutoComplete",e=>{let t,{replaceParts:n,close:i}=e;if(n){this._parts.splice(this.autoCompletePartIdx,this.autoCompletePartCount,...n),this.autoCompletePartCount=n.length;const e=n[n.length-1],i=this.autoCompletePartIdx+n.length-1;t=new a.a(i,e.text.length)}i&&(this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0),this.updateCallback(t)}),this._parts=e,this._partCreator=t,this.transformCallback=null}setTransformCallback(e){this.transformCallback=e}setUpdateCallback(e){this.updateCallback=e}get partCreator(){return this._partCreator}get isEmpty(){return 0===this._parts.reduce((e,t)=>e+t.text.length,0)}clone(){const e=this.parts.map(e=>this.partCreator.deserializePart(e.serialize()));return new l(e,this._partCreator,this.updateCallback)}insertPart(e,t){this._parts.splice(e,0,t),this.activePartIdx>=e&&++this.activePartIdx,this.autoCompletePartIdx>=e&&++this.autoCompletePartIdx}removePart(e){this._parts.splice(e,1),e===this.activePartIdx?this.activePartIdx=null:this.activePartIdx>e&&--this.activePartIdx,e===this.autoCompletePartIdx?this.autoCompletePartIdx=null:this.autoCompletePartIdx>e&&--this.autoCompletePartIdx}replacePart(e,t){this._parts.splice(e,1,t)}get parts(){return this._parts}get autoComplete(){return this.activePartIdx===this.autoCompletePartIdx?this._autoComplete:null}getPositionAtEnd(){if(this._parts.length){const e=this._parts.length-1,t=this._parts[e];return new a.a(e,t.text.length)}return new a.a(-1,0)}serializeParts(){return this._parts.map(e=>e.serialize())}diff(e,t,n){const i=this.parts.reduce((e,t)=>e+t.text,"");return"deleteByDrag"===t?function(e,t){if(e===t)return{};const n=o(e,t),i=e.length-t.length;return{at:n,removed:e.slice(n,n+i)}}(i,e):r(i,e,n.offset)}reset(e,t,n){this._parts=e.map(e=>this._partCreator.deserializePart(e)),t||(t=this.getPositionAtEnd()),this._autoComplete&&(this._autoComplete=null,this.autoCompletePartIdx=null),this.updateCallback(t,n)}insert(e,t){const n=this.splitAt(t);let i=0;for(let t=0;t<e.length;++t){const s=e[t];i+=s.text.length,this.insertPart(n+t,s)}return i}update(e,t,n){const i=this.diff(e,t,n),s=this.positionForOffset(i.at,n.atNodeEnd);let o=0;i.removed&&(o=this.removeText(s,i.removed.length));let r=0;i.added&&(r=this.addText(s,i.added,t)),this.mergeAdjacentParts();const a=i.at-o+r;let c=this.positionForOffset(a,!0);const l="insertFromPaste"!==t&&"insertFromDrop"!==t,d=this.setActivePart(c,l);if(this.transformCallback){const e=this.getTransformAddedLen(c,t,i);c=this.positionForOffset(a+e,!0)}return this.updateCallback(c,t,i),d}getTransformAddedLen(e,t,n){const i=this.transformCallback(e,t,n);return Number.isFinite(i)?i:0}setActivePart(e,t){const{index:n}=e,i=this._parts[n];if(i){if(n!==this.activePartIdx&&(this.activePartIdx=n,t&&this.activePartIdx!==this.autoCompletePartIdx)){const e=i.createAutoComplete(this.onAutoComplete);e&&(this._autoComplete=e,this.autoCompletePartIdx=n,this.autoCompletePartCount=1)}if(this.autoComplete)return this.autoComplete.onPartUpdate(i,e)}else this.activePartIdx=null,this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0;return Promise.resolve()}mergeAdjacentParts(){let e;for(let t=0;t<this._parts.length;++t){let n=this._parts[t];const i=!n.text.length,s=!i&&e&&e.merge(n);(i||s)&&(n=e,this.removePart(t),--t),e=n}}removeText(e,t){let{index:n,offset:i}=e,s=0;for(;t>0;){let e=this._parts[n];const o=Math.min(t,e.text.length-i);if(o)if(e.canEdit){const t=e.remove(i,o);"string"==typeof t&&this.replacePart(n,this._partCreator.createDefaultPart(t)),e=this._parts[n],e.text.length?n+=1:this.removePart(n)}else s+=i,this.removePart(n);else n+=1;t-=o,i=0}return s}splitAt(e){if(-1===e.index)return 0;if(0===e.offset)return e.index;const t=this._parts[e.index];if(e.offset>=t.text.length)return e.index+1;const n=t.split(e.offset);return this.insertPart(e.index+1,n),e.index+1}addText(e,t,n){let{index:i}=e;const{offset:s}=e;let o=t.length;const r=this._parts[i];if(r)if(r.canEdit)if(r.validateAndInsert(s,t,n))t=null;else{const e=r.split(s);i+=1,this.insertPart(i,e)}else 0!==s&&(o+=r.text.length-s,i+=1);else i<0&&(i=0);for(;t;){const e=this._partCreator.createPartForInput(t,i,n),s=t;if((t=e.appendUntilRejected(t,n))===s){console.error(`Failed to update model for input (str ${t}) (type ${n})`);break}this.insertPart(i,e),i+=1}return o}positionForOffset(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=0;const i=this._parts.findIndex(i=>{const s=i.text.length;return!!(t&&n+s>=e||!t&&n+s>e)||(n+=s,!1)});return-1===i?this.getPositionAtEnd():new a.a(i,e-n)}startRange(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;return new c.a(this,e,t)}replaceRange(e,t,n){const i=t.asOffset(this),s=this.splitAt(e);t=i.asPosition(this);for(let e=this.splitAt(t)-1;e>=s;--e)this.removePart(e);let o=s;for(const e of n)this.insertPart(o,e),o+=1;this.mergeAdjacentParts()}transform(e){const t=e();let n=null;return n=t instanceof c.a?Promise.resolve():this.setActivePart(t,!0),this.updateCallback(t),n}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var i=n(87),s=n.n(i),o=n(768),r=n(780),a=n(781),c=n(779),l=n(88),d=n.n(l),u=n(121),h=n(783),m=n(239),p=n(250);class g extends s.a.PureComponent{constructor(e){super(e),d()(this,"onWaveformUpdate",e=>{this.setState({heights:this.toHeights(e)})}),d()(this,"onTimeUpdate",e=>{const t=Number(Object(p.c)(e[0],0,e[1]).toFixed(3));this.setState({progress:t})}),this.state={heights:this.toHeights(this.props.playback.waveform),progress:0},this.props.playback.waveformData.onUpdate(this.onWaveformUpdate),this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}toHeights(e){const t=Object(u.h)(0,m.b);return Object(u.j)(e,m.b,t)}render(){return s.a.createElement(h.a,{relHeights:this.state.heights,progress:this.state.progress})}}class f extends a.a{renderWaveformLook(){return s.a.createElement(s.a.Fragment,null,s.a.createElement(r.a,{playback:this.props.playback}),s.a.createElement(g,{playback:this.props.playback}))}renderSeekableLook(){return s.a.createElement(s.a.Fragment,null,s.a.createElement(c.a,{playback:this.props.playback,tabIndex:-1,playbackPhase:this.state.playbackPhase,ref:this.seekRef}),s.a.createElement(r.a,{playback:this.props.playback}))}renderComponent(){return s.a.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer",onKeyDown:this.onKeyDown},s.a.createElement(o.a,{playback:this.props.playback,playbackPhase:this.state.playbackPhase,ref:this.playPauseRef}),this.props.withWaveform?this.renderWaveformLook():this.renderSeekableLook())}}},,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n(0);let s,o=0;const r=[];let a=Date.now;function c(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),s=2;s<n;s++)i[s-2]=arguments[s];(t=t||0)<0&&(t=0);const c=a()+t,l=o++,u={runAt:c,func:e,params:i,key:l},m=h(r,(function(e){return e.runAt-c}));return r.splice(m,0,u),d(),l}function l(e){if(0===r.length)return;let t;for(t=0;t<r.length;t++){if(r[t].key==e){r.splice(t,1);break}}0===t&&d()}function d(){s&&e.clearTimeout(s);const t=r[0];if(!t)return;const n=a(),i=Math.min(t.runAt-n,1e3);s=e.setTimeout(u,i)}function u(){let t;const n=a(),s=[];for(;;){const e=r[0];if(!e||e.runAt>n)break;t=r.shift(),t.key,s.push(t)}d();for(let n=0;n<s.length;n++){t=s[n];try{t.func.apply(e,t.params)}catch(e){i.a.error("Uncaught exception in callback function",e.stack||e)}}}function h(e,t){let n=0,i=e.length;for(;n<i;){const s=n+i>>1;t(e[s])>0?i=s:n=s+1}return n}}).call(this,n(30))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return r}));var i=n(273),s=n(224);function o(){console.log(...arguments)}function r(e,t){this.client=e,(t=t||{}).initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._websocket=null,this._syncState=null,this._running=!1,this.ws_timeout=2e4,this.ws_keepAliveTimer=null,this._notifEvents=[],this._awaiting_responses={},this._pendingSend=[],e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}r.prototype.reconnectNow=function(){return console.err("WebSocketApi.reconnectNow() not implemented"),!1},r.prototype.getSyncState=function(){return this._syncState},r.prototype.start=function(){const t=this.client,n=this;function s(){t.getPushRules().then(e=>{o("Got push rules"),t.pushRules=e,function e(){let s;n.opts.filter?s=n.opts.filter:(s=new i.a(t.credentials.userId),s.setTimelineLimit(n.opts.initialSyncLimit));t.getOrCreateFilter((o=t.credentials.userId,"FILTER_SYNC_"+o+(r?"_"+r:"")),s).then(e=>{t.resetNotifTimelineSet(),n._start({filterId:e})},(function(i){t.syncApi.startKeepAlives().then((function(){e()})),n._updateSyncState("ERROR",{error:i})}));var o,r}()},(function(e){t.syncApi.startKeepAlives().then((function(){s()})),n._updateSyncState("ERROR",{error:e})}))}this._running?console.log("WebSocketApi is already running. Do nothing"):(this._running=!0,this._websocket&&(o("Websocket already existing. Killing it"),this._websocket.close(),this._websocket=null),e.document&&(this._onOnlineBound=this._onOnline.bind(this),e.document.addEventListener("online",this._onOnlineBound,!1)),t.isGuest()?n._start({}):t.store.getSavedSync().then(e=>{if(e)return t.syncApi.syncFromCache(e)}).then(()=>{s()}))},r.prototype.ws_keepAlive=function(){o("WebSocketApi.ws_keepAlive"),this._websocket?(this._websocket&&this._websocket.readyState==this._websocket.OPEN&&this.sendPing(),this.ws_keepAliveTimer=setTimeout(this.ws_keepAlive.bind(this),this.ws_timeout)):console.error("this._websocket does not exist",this)},r.prototype._handleResponseTimeout=function(e){if(!this._awaiting_responses[e])return;o("Run MessageTimeout for message",e);const t=this._awaiting_responses[e];if("ping"!=t){if(null==this._websocket||this._websocket.readyState!=WebSocket.OPEN)return o("WebSocket is not ready. Postponing",t.message),void(t.pending||(this._awaiting_responses[e].pending=!0,this._pendingSend.push(t.message)));if(!t.retried)return this._websocket.send(JSON.stringify(t.message)),this._awaiting_responses[e].retried=!0,void setTimeout(this._handleResponseTimeout.bind(this,e),this._ws_timeout/2);t.defer.reject(new s.d({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:this.ws_timeout})),delete this._awaiting_responses[e]}else this._ping_failed_already&&this._websocket&&this._websocket.readyState==WebSocket.OPEN?(console.error("Timeout for sending ping-request. Try reconnecting"),this._websocket.close(),this._websocket=null):(this._ping_failed_already=!0,delete this._awaiting_responses[e],setTimeout(this.sendPing.bind(this),5))},r.prototype._init_keepalive=function(){this.ws_keepAliveTimer&&clearTimeout(this.ws_keepAliveTimer),this.ws_keepAliveTimer=setTimeout(this.ws_keepAlive.bind(this),this.ws_timeout)},r.prototype.stop=function(){o("WebSocketApi.stop"),e.document&&(e.document.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._websocket&&(this._websocket.close(),this._websocket=null),this._updateSyncState("STOPPED")},r.prototype._start=async function(e){const t=this.client;if(!this._running)return o("WebSocket no longer running: exiting."),void this._updateSyncState("STOPPED");let n=e.filterId;t.isGuest()&&!n&&(n=t.syncApi.getGuestFilter()),this.ws_syncToken=t.store.getSyncToken();const i={filter:n};let s;this.opts.disablePresence&&(i.set_presence="offline"),this.ws_syncOptions=e;try{const n=await t.store.getSavedSyncToken();o("Starting sync since="+n),this._currentSyncRequest=t.syncApi.doSyncRequest(e,n),s=await this._currentSyncRequest}catch(n){return void t.syncApi.startKeepAlives().then(()=>{o("Starting with initial sync failed (",n,"). Retries"),this._start(e)})}t.store.setSyncToken(s.next_batch),await t.store.setSyncData(s);const r={oldSyncToken:this.ws_syncToken,nextSyncToken:s.next_batch,catchingUp:this._catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(r);try{await t.syncApi.processSyncResponse(r,s)}catch(e){console.error("Caught /sync error",e.stack||e)}this.ws_syncOptions.hasSyncedBefore||(this._updateSyncState("PREPARED",r),this.ws_syncOptions.hasSyncedBefore=!0),this.ws_syncToken=s.next_batch,this.opts.crypto&&await this.opts.crypto.onSyncCompleted(r),this._updateSyncState("SYNCING",r),t.store.save(),this._start_websocket(i)},r.prototype._start_websocket=function(e){const t=this;e.since=this.ws_syncToken,this._websocket=this.client.http.generateWebSocket(e),this._websocket.onopen=function(e){o("Connected to WebSocket: ",e),t.ws_possible=!0,t._init_keepalive(),t._pendingSend.forEach(e=>{t._awaiting_responses[e.id]&&(o("Send postponed message via WebSocket",e),t._websocket.send(JSON.stringify(e)))}),t._pendingSend=[]},this._websocket.onclose=function(e){t.ws_keepAliveTimer&&(clearTimeout(t.ws_keepAliveTimer),t.ws_keepAliveTimer=null);e.wasClean?o("Socket closed"):o("Unclean close. Code: "+e.code+" reason: "+e.reason,"error");t._ping_failed_already=!1,t.ws_possible?(o("Reinit Connection via WebSocket"),t._updateSyncState("RECONNECTING"),t.client.syncApi.startKeepAlives().then((function(){o("Restart Websocket"),t._start(t.ws_syncOptions)}))):(o("Connection via WebSocket seems to be not available. Fallback to Long-Polling"),t.client.connectionFallback(t.opts,t.ws_syncOptions),t.ws_syncOptions=null,t.ws_syncToken=null)},this._websocket.onmessage=function(e){t._init_keepalive();const n=JSON.parse(e.data);if(n.method)switch(n.method){case"ping":t._websocket.send(JSON.stringify({id:n.id}));break;case"sync":t.handleSync(n.data);break;default:console.error('Received message with unknown method "'+n.method+'"',n)}else n.result||n.error?t.handleResponse(n):n.next_batch?t.handleSync(n):console.error("Unrecognised message format received via WebSocket",n)}},r.prototype.handleResponse=function(e){if(!e.id)return console.error("response id missing",e),!1;const t=e.id;return this._awaiting_responses[t]?"ping"==this._awaiting_responses[t]?(self._ping_failed_already=!1,delete this._awaiting_responses[t]):e.result?(this._awaiting_responses[t].defer.resolve(e.result),delete this._awaiting_responses[t]):e.error?(this._awaiting_responses[t].defer.reject(e.error),delete this._awaiting_responses[t]):(console.error("response does not contain result nor error",e),!1):(console.error("response id unknown",e),!1)},r.prototype.handleSync=async function(e){const t=this.client,n=this;t.store.setSyncToken(e.next_batch),await t.store.setSyncData(e);try{t.syncApi.processSyncResponse(n.ws_syncToken,e,!1)}catch(e){console.error("Caught /sync error (via WebSocket)",e.stack||e)}const i={oldSyncToken:n.ws_syncToken,nextSyncToken:e.next_batch};n._updateSyncState("SYNCING",i),t.store.save(),n.ws_syncToken=e.next_batch},r.prototype.sendObject=function(e){return new Promise((t,n)=>{if(!e.method)return n("No method in sending object");e.id=e.id||this.client.makeTxnId(),this._awaiting_responses[e.id]={message:e,defer:{resolve:t,reject:n}},null==this._websocket||this._websocket.readyState!=WebSocket.OPEN?(o("WebSocket is not ready. Postponing",e),this._pendingSend.push(e),this._awaiting_responses[e.id].pending=!0):this._websocket.send(JSON.stringify(e)),setTimeout(this._handleResponseTimeout.bind(this,e.id),this.ws_timeout/2)})},r.prototype.sendEvent=function(e){const t={id:e.txnId?e.txnId:this.client.makeTxnId(),method:"send",params:{room_id:e.getRoomId(),event_type:e.getWireType(),content:e.getWireContent()}};return e.isRedaction()&&(t.method="redact",t.params.redacts=e.event.redacts),e.isState()&&e.getStateKey()&&e.getStateKey().length>0&&(t.method="state",t.param.state_key=e.getStateKey()),this.sendObject(t)},r.prototype.sendPing=function(){const e=this.client.makeTxnId();this._websocket.send(JSON.stringify({id:e,method:"ping"})),this._awaiting_responses[e]="ping",setTimeout(this._handleResponseTimeout.bind(this,e),this.ws_timeout)},r.prototype.sendPresence=function(e){if(-1==["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);const t={id:this.client.makeTxnId(),method:"presence",params:{presence:e.presence}};return e.status_msg&&(t.params.status_msg=e.status_msg),this.sendObject(t)},r.prototype.sendReadMarkers=function(e,t,n,i){const s={id:this.client.makeTxnId(),method:"read_markers",params:{room_id:e,"m.fully_read":t,"m.read":n,"org.matrix.msc2285.read.private":i}};return this.sendObject(s)},r.prototype.sendTyping=function(e,t,n,i){const s={id:this.client.makeTxnId(),method:"typing",params:{room_id:e,typing:t}};return t&&(s.params.timeout=n||2e4),this.sendObject(s)},r.prototype._updateSyncState=function(e,t){void 0===t&&(t={});const n=this._syncState;this._syncState=e,this.client.emit("sync",this._syncState,n,t)},r.prototype._onOnline=function(){o("Browser thinks we are back online"),this.client.syncApi.startKeepAlives(0)}}).call(this,n(30))},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(17),s=n.n(i);class o{constructor(){s()(this,"accountData",{}),s()(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}storeEvents(e,t,n,i){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve({})}storeClientOptions(e){return Promise.resolve()}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(17),s=n.n(i),o=n(187);class r{constructor(e){this.cryptoStore=e,s()(this,"roomEncryption",{})}async init(){await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ROOMS],e=>{this.cryptoStore.getEndToEndRooms(e,e=>{this.roomEncryption=e})})}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ROOMS],n=>{this.cryptoStore.storeEndToEndRoom(e,t,n)})}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return c})),n.d(t,"c",(function(){return l}));var i=n(17),s=n.n(i),o=n(0),r=n(7);const a=10;class c{constructor(e){this.db=e,s()(this,"nextTxnId",0),e.onversionchange=()=>{o.a.log(`versionchange for indexeddb ${this.db.name}: closing`),e.close()}}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise((n,i)=>{const s=this.db.transaction("outgoingRoomKeyRequests","readwrite");s.onerror=i,this._getOutgoingRoomKeyRequest(s,t,i=>{if(i)return o.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void n(i);o.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),s.oncomplete=()=>{n(e)};s.objectStore("outgoingRoomKeyRequests").add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,n)=>{const i=this.db.transaction("outgoingRoomKeyRequests","readonly");i.onerror=n,this._getOutgoingRoomKeyRequest(i,e,e=>{t(e)})})}_getOutgoingRoomKeyRequest(e,t,n){const i=e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]);i.onsuccess=()=>{const e=i.result;if(!e)return void n(null);const s=e.value;r.i(s.requestBody,t)?n(s):e.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,n=0;const i=this.db.transaction("outgoingRoomKeyRequests","readonly"),s=i.objectStore("outgoingRoomKeyRequests"),o=e[n];return s.index("state").openCursor(o).onsuccess=function i(){const s=this.result;if(s)return void(t=s.value);if(n++,n>=e.length)return;const o=e[n];this.source.openCursor(o).onsuccess=i},u(i).then(()=>t)}getAllOutgoingRoomKeyRequestsByState(e){return new Promise((t,n)=>{const i=this.db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}getOutgoingRoomKeyRequestsByTarget(e,t,n){let i=0;const s=[];const o=this.db.transaction("outgoingRoomKeyRequests","readonly"),r=o.objectStore("outgoingRoomKeyRequests"),a=n[i];return r.index("state").openCursor(a).onsuccess=function o(){const r=this.result;if(r){const n=r.value;n.recipients.includes({userId:e,deviceId:t})&&s.push(n),r.continue()}else{if(i++,i>=n.length)return;const e=n[i];this.source.openCursor(e).onsuccess=o}},u(o).then(()=>s)}updateOutgoingRoomKeyRequest(e,t,n){let i=null;const s=this.db.transaction("outgoingRoomKeyRequests","readwrite");return s.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(){const e=this.result;if(!e)return;const s=e.value;s.state==t?(Object.assign(s,n),e.update(s),i=s):o.a.warn(`Cannot update room key request from ${t} as it was already updated to `+s.state)},u(s).then(()=>i)}deleteOutgoingRoomKeyRequest(e,t){const n=this.db.transaction("outgoingRoomKeyRequests","readwrite"),i=n.objectStore("outgoingRoomKeyRequests").openCursor(e);return i.onsuccess=()=>{const e=i.result;if(!e)return;const n=e.value;n.state==t?e.delete():o.a.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`)},u(n)}getAccount(e,t){const n=e.objectStore("account").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(t){d(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const n=e.objectStore("account").get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(t){d(e,t)}}}getSecretStorePrivateKey(e,t,n){const i=e.objectStore("account").get("ssss_cache:"+n);i.onsuccess=function(){try{t(i.result||null)}catch(t){d(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,n){e.objectStore("account").put(n,"ssss_cache:"+t)}countEndToEndSessions(e,t){const n=e.objectStore("sessions").count();n.onsuccess=function(){try{t(n.result)}catch(t){d(e,t)}}}getEndToEndSessions(e,t,n){const i=t.objectStore("sessions").index("deviceKey").openCursor(e),s={};i.onsuccess=function(){const e=i.result;if(e)s[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{n(s)}catch(e){d(t,e)}}}getEndToEndSession(e,t,n,i){const s=n.objectStore("sessions").get([e,t]);s.onsuccess=function(){try{s.result?i({session:s.result.session,lastReceivedMessageTs:s.result.lastReceivedMessageTs}):i(null)}catch(e){d(n,e)}}}getAllEndToEndSessions(e,t){const n=e.objectStore("sessions").openCursor();n.onsuccess=function(){try{const e=n.result;e?(t(e.value),e.continue()):t(null)}catch(t){d(e,t)}}}storeEndToEndSession(e,t,n,i){i.objectStore("sessions").put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,n){const i=this.db.transaction("session_problems","readwrite");return i.objectStore("session_problems").put({deviceKey:e,type:t,fixed:n,time:Date.now()}),u(i)}async getEndToEndSessionProblem(e,t){let n;const i=this.db.transaction("session_problems","readwrite"),s=i.objectStore("session_problems").index("deviceKey").getAll(e);return s.onsuccess=()=>{const e=s.result;if(!e.length)return void(n=null);e.sort((e,t)=>e.time-t.time);const i=e[e.length-1];for(const s of e)if(s.time>t)return void(n=Object.assign({},s,{fixed:i.fixed}));n=i.fixed?null:i},await u(i),n}async filterOutNotifiedErrorDevices(e){const t=this.db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),n=[];return await Promise.all(e.map(e=>new Promise(i=>{const{userId:s,deviceInfo:o}=e,r=t.get([s,o.deviceId]);r.onsuccess=function(){r.result||(t.put({userId:s,deviceId:o.deviceId}),n.push(e)),i()}}))),n}getEndToEndInboundGroupSession(e,t,n,i){let s=!1,o=!1;const r=n.objectStore("inbound_group_sessions").get([e,t]);r.onsuccess=function(){try{s=r.result?r.result.session:null,!1!==o&&i(s,o)}catch(e){d(n,e)}};const a=n.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{o=a.result?a.result.session:null,!1!==s&&i(s,o)}catch(e){d(n,e)}}}getAllEndToEndInboundGroupSessions(e,t){const n=e.objectStore("inbound_group_sessions").openCursor();n.onsuccess=function(){const i=n.result;if(i){try{t({senderKey:i.value.senderCurve25519Key,sessionId:i.value.sessionId,sessionData:i.value.session})}catch(t){d(e,t)}i.continue()}else try{t(null)}catch(t){d(e,t)}}}addEndToEndInboundGroupSession(e,t,n,i){const s=i.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:n});s.onerror=n=>{"ConstraintError"===s.error.name?(n.stopPropagation(),n.preventDefault(),o.a.log("Ignoring duplicate inbound group session: "+e+" / "+t)):d(i,new Error("Failed to add inbound group session: "+s.error))}}storeEndToEndInboundGroupSession(e,t,n,i){i.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:n})}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){i.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:n})}getEndToEndDeviceData(e,t){const n=e.objectStore("device_data").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(t){d(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,n){n.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const n={},i=e.objectStore("rooms").openCursor();i.onsuccess=function(){const s=i.result;if(s)n[s.key]=s.value,s.continue();else try{t(n)}catch(t){d(e,t)}}}getSessionsNeedingBackup(e){return new Promise((t,n)=>{const i=[],s=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");s.onerror=n,s.oncomplete=function(){t(i)};const o=s.objectStore("sessions_needing_backup"),r=s.objectStore("inbound_group_sessions"),a=o.openCursor();a.onsuccess=function(){const t=a.result;if(t){const n=r.get(t.key);n.onsuccess=function(){i.push({senderKey:n.result.senderCurve25519Key,sessionId:n.result.sessionId,sessionData:n.result.session})},(!e||i.length<e)&&t.continue()}}})}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise((e,n)=>{const i=t.count();i.onerror=n,i.onsuccess=()=>e(i.result)})}async unmarkSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");await Promise.all(e.map(e=>new Promise((t,i)=>{const s=n.delete([e.senderKey,e.sessionId]);s.onsuccess=t,s.onerror=i})))}async markSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");await Promise.all(e.map(e=>new Promise((t,i)=>{const s=n.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});s.onsuccess=t,s.onerror=i})))}addSharedHistoryInboundGroupSession(e,t,n,i){i||(i=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));const s=i.objectStore("shared_history_inbound_group_sessions"),o=s.get([e]);o.onsuccess=()=>{const{sessions:i}=o.result||{sessions:[]};i.push([t,n]),s.put({roomId:e,sessions:i})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));const n=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise((e,t)=>{n.onsuccess=()=>{const{sessions:t}=n.result||{sessions:[]};e(t)},n.onerror=t})}doTxn(e,t,n){arguments.length>3&&void 0!==arguments[3]||o.a;const i=this.db.transaction(t,e),s=u(i),r=n(i);return s.then(()=>r)}}function l(e,t){if(o.a.log("Upgrading IndexedDBCryptoStore from version "+t+" to "+a),t<1&&function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e),t<2&&e.createObjectStore("account"),t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}if(t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]}),t<5&&e.createObjectStore("device_data"),t<6&&e.createObjectStore("rooms"),t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]}),t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]}),t<9){e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}t<10&&e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})}function d(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function u(e){return new Promise((t,n)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&n(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(o.a.log("Error performing indexeddb txn",t),n(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(o.a.log("Error performing indexeddb txn",t),n(e.error))}})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(17),s=n.n(i),o=n(0),r=n(366),a=n(368),c=n(161),l=n(187),d=n(7),u=n(143),h=n(145);let m;!function(e){e[e.NotTracked=0]="NotTracked",e[e.PendingDownload=1]="PendingDownload",e[e.DownloadInProgress=2]="DownloadInProgress",e[e.UpToDate=3]="UpToDate"}(m||(m={}));class p extends u.b{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:250;super(),this.cryptoStore=t,this.keyDownloadChunkSize=i,s()(this,"devices",{}),s()(this,"crossSigningInfo",{}),s()(this,"userByIdentityKey",{}),s()(this,"deviceTrackingStatus",{}),s()(this,"syncToken",null),s()(this,"keyDownloadsInProgressByUser",{}),s()(this,"dirty",!1),s()(this,"savePromise",null),s()(this,"resolveSavePromise",null),s()(this,"savePromiseTime",null),s()(this,"saveTimer",null),s()(this,"hasFetched",null),s()(this,"serialiser",void 0),this.serialiser=new g(e,n,this)}async load(){await this.cryptoStore.doTxn("readonly",[l.a.STORE_DEVICE_DATA],e=>{this.cryptoStore.getEndToEndDeviceData(e,e=>{this.hasFetched=Boolean(e&&e.devices),this.devices=e?e.devices:{},this.crossSigningInfo=e&&e.crossSigningInfo||{},this.deviceTrackingStatus=e?e.trackingStatus:{},this.syncToken=e?e.syncToken:null,this.userByIdentityKey={};for(const e of Object.keys(this.devices)){const t=this.devices[e];for(const n of Object.keys(t)){const i=t[n].keys["curve25519:"+n];void 0!==i&&(this.userByIdentityKey[i]=e)}}})});for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]==m.DownloadInProgress&&(this.deviceTrackingStatus[e]=m.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;if(!this.dirty)return Promise.resolve(!1);const t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let n=this.savePromise;if(null===n&&(n=new Promise(e=>{this.resolveSavePromise=e}),this.savePromise=n),null===this.saveTimer){const n=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout(()=>{o.a.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[l.a.STORE_DEVICE_DATA],e=>{this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:this.syncToken},e)}).then(()=>{this.dirty=!1,n(!0)},e=>{o.a.error("Failed to save device tracking data",this.syncToken),o.a.error(e)})},e)}return n}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){const n=[],i=[];if(e.forEach(e=>{const s=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser[e]?(o.a.log("downloadKeys: already have a download in progress for "+e+": awaiting its result"),i.push(this.keyDownloadsInProgressByUser[e])):(t||s!=m.UpToDate)&&n.push(e)}),0!=n.length){o.a.log("downloadKeys: downloading for",n);const e=this.doKeyDownload(n);i.push(e)}return 0===i.length&&o.a.log("downloadKeys: already have all necessary keys"),Promise.all(i).then(()=>this.getDevicesFromStore(e))}getDevicesFromStore(e){const t={};return e.forEach(e=>{t[e]={};(this.getStoredDevicesForUser(e)||[]).forEach((function(n){t[e][n.deviceId]=n}))}),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){const t=this.devices[e];if(!t)return null;const n=[];for(const e in t)t.hasOwnProperty(e)&&n.push(r.a.fromStorage(t[e],e));return n}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?a.a.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){const n=this.devices[e];if(n&&n[t])return r.a.fromStorage(n[t],t)}getUserByIdentityKey(e,t){return e!==c.OLM_ALGORITHM&&e!==c.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const n=this.getUserByIdentityKey(e,t);if(!n)return null;const i=this.devices[n];if(!i)return null;for(const e in i){if(!i.hasOwnProperty(e))continue;const n=i[e];for(const i in n.keys){if(!n.keys.hasOwnProperty(i))continue;if(0!==i.indexOf("curve25519:"))continue;if(n.keys[i]==t)return r.a.fromStorage(n,e)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(o.a.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=m.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(o.a.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=m.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=m.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(o.a.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=m.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this.deviceTrackingStatus)){this.deviceTrackingStatus[t]==m.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(const[t,n]of Object.entries(this.devices[e])){const e=n.keys["curve25519:"+t];delete this.userByIdentityKey[e]}this.devices[e]=t;for(const[n,i]of Object.entries(t)){const t=i.keys["curve25519:"+n];this.userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then(()=>{n(!0)},t=>{throw o.a.error("Error downloading keys for "+e+":",t),n(!1),t});e.forEach(e=>{this.keyDownloadsInProgressByUser[e]=t;this.deviceTrackingStatus[e]==m.PendingDownload&&(this.deviceTrackingStatus[e]=m.DownloadInProgress)});const n=n=>{this.emit(h.b.WillUpdateDevices,e,!this.hasFetched),e.forEach(e=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser[e]!==t)return void o.a.log("Another update in the queue for",e,"- not marking up-to-date");delete this.keyDownloadsInProgressByUser[e];this.deviceTrackingStatus[e]==m.DownloadInProgress&&(n?(this.deviceTrackingStatus[e]=m.UpToDate,o.a.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=m.PendingDownload)}),this.saveIfDirty(),this.emit(h.b.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}class g{constructor(e,t,n){this.baseApis=e,this.olmDevice=t,this.deviceList=n,s()(this,"downloadInProgress",!1),s()(this,"keyDownloadsQueuedByUser",{}),s()(this,"queuedQueryDeferred",null),s()(this,"syncToken",null)}updateDevicesForUsers(e,t){return e.forEach(e=>{this.keyDownloadsQueuedByUser[e]=!0}),this.queuedQueryDeferred||(this.queuedQueryDeferred=Object(d.l)()),this.syncToken=t,this.downloadInProgress?(o.a.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const t=this.queuedQueryDeferred;this.queuedQueryDeferred=null,o.a.log("Starting key download for",e),this.downloadInProgress=!0;const n={};this.syncToken&&(n.token=this.syncToken);const i=[];for(let t=0;t<e.length;t+=this.deviceList.keyDownloadChunkSize){const s=e.slice(t,t+this.deviceList.keyDownloadChunkSize);i.push(()=>this.baseApis.downloadKeysForUsers(s,n))}return Object(d.f)(i,3).then(async t=>{const n=Object.assign({},...t.map(e=>e.device_keys||{})),i=Object.assign({},...t.map(e=>e.master_keys||{})),s=Object.assign({},...t.map(e=>e.self_signing_keys||{})),r=Object.assign({},...t.map(e=>e.user_signing_keys||{}));for(const t of e){await Object(d.G)(5);try{await this.processQueryResponseForUser(t,n[t],{master:i[t],self_signing:s[t],user_signing:r[t]})}catch(e){o.a.error(`Error processing keys for ${t}:`,e)}}}).then(()=>{o.a.log("Completed key download for "+e),this.downloadInProgress=!1,t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()},n=>{o.a.warn("Error downloading keys for "+e+":",n),this.downloadInProgress=!1,t.reject(n)}),t.promise}async processQueryResponseForUser(e,t,n){o.a.log("got device keys for "+e+":",t),o.a.log("got cross-signing keys for "+e+":",n);{const n={},i=this.deviceList.getRawStoredDevicesForUser(e);i&&Object.keys(i).forEach(e=>{const t=r.a.fromStorage(i[e],e);n[e]=t}),await async function(e,t,n,i,s,r){let a=!1;for(const e in n)if(n.hasOwnProperty(e)&&!(e in i)){if(t===s&&e===r){o.a.warn(`Local device ${e} missing from sync, skipping removal`);continue}o.a.log("Device "+t+":"+e+" has been removed"),delete n[e],a=!0}for(const s in i){if(!i.hasOwnProperty(s))continue;const r=i[s];r.user_id===t?r.device_id===s?await f(e,n,r)&&(a=!0):o.a.warn("Mismatched device_id "+r.device_id+" in keys from "+t+":"+s):o.a.warn("Mismatched user_id "+r.user_id+" in keys from "+t+":"+s)}return a}(this.olmDevice,e,n,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);const s={};Object.keys(n).forEach(e=>{s[e]=n[e].toStorage()}),this.deviceList.setRawStoredDevicesForUser(e,s)}if(n&&(n.master||n.self_signing||n.user_signing)){const t=this.deviceList.getStoredCrossSigningForUser(e)||new a.a(e);t.setKeys(n),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this.deviceList.emit(h.b.UserCrossSigningUpdated,e)}}}async function f(e,t,n){if(!n.keys)return!1;const i=n.device_id,s=n.user_id,a="ed25519:"+i,l=n.keys[a];if(!l)return o.a.warn("Device "+s+":"+i+" has no ed25519 key"),!1;const d=n.unsigned||{},u=n.signatures||{};try{await c.verifySignature(e,n,s,i,l)}catch(e){return o.a.warn("Unable to verify signature on device "+s+":"+i+":"+e),!1}let h;if(i in t){if(h=t[i],h.getFingerprint()!=l)return o.a.warn("Ed25519 key for device "+s+":"+i+" has changed"),!1}else t[i]=h=new r.a(i);return h.keys=n.keys||{},h.algorithms=n.algorithms||[],h.unsigned=d,h.signatures=u,!0}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(17),s=n.n(i),o=n(0),r=n(108),a=n(368),c=n(187),l=n(224),d=n(120),u=n(143);class h{constructor(e,t){s()(this,"accountDataClientAdapter",void 0),s()(this,"crossSigningCallbacks",void 0),s()(this,"ssssCryptoCallbacks",void 0),s()(this,"crossSigningKeys",null),s()(this,"keySignatures",null),s()(this,"keyBackupInfo",null),s()(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new p(e),this.crossSigningCallbacks=new g,this.ssssCryptoCallbacks=new f(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,n){this.keySignatures||(this.keySignatures={});const i=this.keySignatures[e]||{};this.keySignatures[e]=i,i[t]=n}async setAccountData(e,t){await this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter.values;return new m(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(e){if(this.crossSigningKeys){const t=Object(a.d)(e.cryptoStore,e.olmDevice);for(const e of["master","self_signing","user_signing"]){o.a.log(`Cache ${e} cross-signing private key locally`);const n=this.crossSigningCallbacks.privateKeys.get(e);await t.storeCrossSigningKeyCache(e,n)}await e.cryptoStore.doTxn("readwrite",[c.a.STORE_ACCOUNT],t=>{e.cryptoStore.storeCrossSigningKeys(t,this.crossSigningKeys.keys)})}this.sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}}class m{constructor(e,t,n,i){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=n,this.keySignatures=i}async apply(e){const t=e.baseApis;if(this.crossSigningKeys){const n={};for(const[e,t]of Object.entries(this.crossSigningKeys.keys))n[e+"_key"]=t;await this.crossSigningKeys.authUpload(e=>t.uploadDeviceSigningKeys(e,n)),e.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(const[e,n]of this.accountData)await t.setAccountData(e,n);this.keySignatures&&await t.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await t.http.authedRequest(void 0,l.f.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:l.k}):await t.http.authedRequest(void 0,l.f.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:l.k}))}}class p extends u.b{constructor(e){super(),this.existingValues=e,s()(this,"values",new Map)}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this.values.get(e);if(t)return t;const n=this.existingValues[e];return n?n.getContent():null}setAccountData(e,t){const n=this.values.get(e);return this.values.set(e,t),Promise.resolve().then(()=>{const i=new r.b({type:e,content:t});return this.emit(d.ClientEvent.AccountData,i,n),{}})}}class g{constructor(){s()(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){return Promise.resolve(this.privateKeys.get(e))}saveCrossSigningKeys(e){for(const[t,n]of Object.entries(e))this.privateKeys.set(t,n)}}class f{constructor(e){this.delegateCryptoCallbacks=e,s()(this,"privateKeys",new Map)}async getSecretStorageKey(e,t){var n;let{keys:i}=e;for(const e of Object.keys(i)){const t=this.privateKeys.get(e);if(t)return[e,t]}if(null!=this&&null!==(n=this.delegateCryptoCallbacks)&&void 0!==n&&n.getSecretStorageKey){const e=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:i},t);if(e){const[t,n]=e;this.privateKeys.set(t,n)}return e}return null}addPrivateKey(e,t,n){var i,s;this.privateKeys.set(e,n),null===(i=this.delegateCryptoCallbacks)||void 0===i||null===(s=i.cacheSecretStorageKey)||void 0===s||s.call(i,e,t,n)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(17),s=n.n(i),o=n(0),r=n(161),a=n(186),c=n(284),l=n(120);const d="m.secret_storage.v1.aes-hmac-sha2";class u{constructor(e,t,n){this.accountDataAdapter=e,this.cryptoCallbacks=t,this.baseApis=n,s()(this,"requests",new Map)}async getDefaultKeyId(){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise((t,n)=>{const i=n=>{"m.secret_storage.default_key"===n.getType()&&n.getContent().key===e&&(this.accountDataAdapter.removeListener(l.ClientEvent.AccountData,i),t())};this.accountDataAdapter.on(l.ClientEvent.AccountData,i),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch(e=>{this.accountDataAdapter.removeListener(l.ClientEvent.AccountData,i),n(e)})})}async addKey(e,t,n){const i={algorithm:e};if(t||(t={}),t.name&&(i.name=t.name),e!==d)throw new Error("Unknown key algorithm "+e);if(t.passphrase&&(i.passphrase=t.passphrase),t.key){const{iv:e,mac:n}=await Object(c.a)(t.key);i.iv=e,i.mac=n}if(!n)do{n=Object(a.b)(32)}while(await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+n));return await this.accountDataAdapter.setAccountData("m.secret_storage.key."+n,i),{keyId:n,keyInfo:i}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return Boolean(await this.getKey(e))}async checkKey(e,t){if(t.algorithm===d){if(t.mac){const{mac:n}=await Object(c.a)(e,t.iv);return t.mac.replace(/=+$/g,"")===n.replace(/=+$/g,"")}return!0}throw new Error("Unknown algorithm")}async store(e,t,n){const i={};if(!n){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");n=[e]}if(0===n.length)throw new Error("Zero keys given to encrypt with!");for(const s of n){const n=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+s);if(!n)throw new Error("Unknown key: "+s);if(n.algorithm===d){const o={[s]:n},[,r]=await this.getSecretStorageKey(o,e);i[s]=await r.encrypt(t)}else o.a.warn("unknown algorithm for secret storage key "+s+": "+n.algorithm)}await this.accountDataAdapter.setAccountData(e,{encrypted:i})}async get(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw new Error("Content is not encrypted!");const n={};for(const e of Object.keys(t.encrypted)){const i=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e),s=t.encrypted[e];i.algorithm===d&&s.iv&&s.ciphertext&&s.mac&&(n[e]=i)}if(0===Object.keys(n).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);let i,s;try{[i,s]=await this.getSecretStorageKey(n,e);const o=t.encrypted[i];return o.passthrough?Object(r.encodeBase64)(s.get_private_key()):s.decrypt(o)}finally{s&&s.free&&s.free()}}async isStored(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(null==t||!t.encrypted)return null;const n={};for(const e of Object.keys(t.encrypted)){const i=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);if(!i)continue;const s=t.encrypted[e];i.algorithm===d&&s.iv&&s.ciphertext&&s.mac&&(n[e]=i)}return Object.keys(n).length?n:null}request(e,t){const n=this.baseApis.makeTxnId();let i,s;const r=new Promise((e,t)=>{i=e,s=t});this.requests.set(n,{name:e,devices:t,resolve:i,reject:s});const a={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:n},c={};for(const e of t)c[e]=a;return o.a.info(`Request secret ${e} from ${t}, id ${n}`),this.baseApis.sendToDevice("m.secret.request",{[this.baseApis.getUserId()]:c}),{requestId:n,promise:r,cancel:e=>{const i={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:n},o={};for(const e of t)o[e]=i;this.baseApis.sendToDevice("m.secret.request",{[this.baseApis.getUserId()]:o}),s(new Error(e||"Cancelled"))}}}async onRequestReceived(e){const t=e.getSender(),n=e.getContent();if(t!==this.baseApis.getUserId()||!(n.name&&n.action&&n.requesting_device_id&&n.request_id))return;const i=n.requesting_device_id;if("request_cancellation"===n.action);else if("request"===n.action){if(i===this.baseApis.deviceId)return;if(o.a.info("received request for secret ("+t+", "+i+", "+n.request_id+")"),!this.cryptoCallbacks.onSecretRequested)return;const e=await this.cryptoCallbacks.onSecretRequested(t,i,n.request_id,n.name,this.baseApis.checkDeviceTrust(t,i));if(e){o.a.info(`Preparing ${n.name} secret for ${i}`);const s={type:"m.secret.send",content:{request_id:n.request_id,secret:e}},a={algorithm:r.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{}};await r.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,{[t]:[this.baseApis.getStoredDevice(t,i)]}),await r.encryptMessageForDevice(a.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,t,this.baseApis.getStoredDevice(t,i),s);const c={[t]:{[i]:a}};o.a.info(`Sending ${n.name} secret for ${i}`),this.baseApis.sendToDevice("m.room.encrypted",c)}else o.a.info(`Request denied for ${n.name} secret for ${i}`)}}onSecretReceived(e){if(e.getSender()!==this.baseApis.getUserId())return;const t=e.getContent();o.a.log("got secret share for request",t.request_id);const n=this.requests.get(t.request_id);if(n){const i=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(r.OLM_ALGORITHM,e.getSenderKey());if(!i)return void o.a.log("secret share from unknown device with key",e.getSenderKey());if(!n.devices.includes(i.deviceId))return void o.a.log("unsolicited secret share from device",i.deviceId);o.a.log(`Successfully received secret ${n.name} from `+i.deviceId),n.resolve(t.secret)}}async getSecretStorageKey(e,t){if(!this.cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const n=await this.cryptoCallbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[i,s]=n;if(!e[i])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[i].algorithm===d){return[i,{encrypt:function(e){return Object(c.c)(e,s,t)},decrypt:function(e){return Object(c.b)(e,s,t)}}]}throw new Error("Unknown key type: "+e[i].algorithm)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(17),s=n.n(i),o=n(0),r=n(97);let a;!function(e){e[e.Unsent=0]="Unsent",e[e.Sent=1]="Sent",e[e.CancellationPending=2]="CancellationPending",e[e.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend"}(a||(a={}));class c{constructor(e,t,n){this.baseApis=e,this.deviceId=t,this.cryptoStore=n,s()(this,"sendOutgoingRoomKeyRequestsTimer",null),s()(this,"sendOutgoingRoomKeyRequestsRunning",!1),s()(this,"clientRunning",!1)}start(){this.clientRunning=!0}stop(){o.a.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=await this.cryptoStore.getOutgoingRoomKeyRequest(e);if(i)switch(i.state){case a.CancellationPendingAndWillResend:case a.Unsent:return;case a.CancellationPending:{const e=n?a.CancellationPendingAndWillResend:a.Sent;await this.cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,a.CancellationPending,{state:e,cancellationTxnId:this.baseApis.makeTxnId()});break}case a.Sent:if(n){const s=a.CancellationPendingAndWillResend,r=await this.cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,a.Sent,{state:s,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!r)return this.queueRoomKeyRequest(e,t,n);try{await this.sendOutgoingRoomKeyRequestCancellation(r,!0)}catch(e){o.a.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+i.state)}else await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this.baseApis.makeTxnId(),state:a.Unsent})}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case a.CancellationPending:case a.CancellationPendingAndWillResend:return;case a.Unsent:return o.a.log("deleting unnecessary room key request for "+l(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,a.Unsent);case a.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,a.Sent,{state:a.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then(t=>{t?this.sendOutgoingRoomKeyRequestCancellation(t).catch(e=>{o.a.error("Error sending room key request cancellation; will retry later.",e),this.startTimer()}):o.a.log("Tried to cancel room key request for "+l(e)+" but it was already cancelled in another tab")});default:throw new Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[a.Sent])}async cancelAndResendAllOutgoingRequests(){const e=await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(a.Sent);return Promise.all(e.map(e=>{let{requestBody:t,recipients:n}=e;return this.queueRoomKeyRequest(t,n,!0)}))}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;this.sendOutgoingRoomKeyRequestsTimer=setTimeout(()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally(()=>{this.sendOutgoingRoomKeyRequestsRunning=!1}).catch(e=>{o.a.warn("error in OutgoingRoomKeyRequestManager: "+e)})},500)}sendOutgoingRoomKeyRequests(){return this.clientRunning?this.cryptoStore.getOutgoingRoomKeyRequestByState([a.CancellationPending,a.CancellationPendingAndWillResend,a.Unsent]).then(e=>{if(!e)return void(this.sendOutgoingRoomKeyRequestsTimer=null);let t;switch(e.state){case a.Unsent:t=this.sendOutgoingRoomKeyRequest(e);break;case a.CancellationPending:t=this.sendOutgoingRoomKeyRequestCancellation(e);break;case a.CancellationPendingAndWillResend:t=this.sendOutgoingRoomKeyRequestCancellation(e,!0)}return t.then(()=>this.sendOutgoingRoomKeyRequests()).catch(e=>{o.a.error("Error sending room key request; will retry later.",e),this.sendOutgoingRoomKeyRequestsTimer=null})}):(this.sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}sendOutgoingRoomKeyRequest(e){o.a.log("Requesting keys for "+l(e.requestBody)+" from "+d(e.recipients)+`(id ${e.requestId})`);const t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,a.Unsent,{state:a.Sent}))}sendOutgoingRoomKeyRequestCancellation(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];o.a.log("Sending cancellation for key request for "+l(e.requestBody)+" to "+d(e.recipients)+" "+`(cancellation id ${e.cancellationTxnId})`);const n={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(n,e.recipients,e.cancellationTxnId).then(()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,a.CancellationPendingAndWillResend,{state:a.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,a.CancellationPending))}sendMessageToDevices(e,t,n){const i={};for(const n of t)i[n.userId]||(i[n.userId]={}),i[n.userId][n.deviceId]=e;return this.baseApis.sendToDevice(r.b.RoomKeyRequest,i,n)}}function l(e){return e.room_id+" / "+e.session_id}function d(e){return"["+e.map(e=>`${e.userId}:${e.deviceId}`).join(",")+"]"}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return l}));var i=n(17),s=n.n(i),o=n(203),r=n(0);const a=n(97).b.RoomMessage;class c{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.client=e,this.roomId=t,this.userId=n,s()(this,"requestEventId",null)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){if(c.getEventType(e)!==o.j)return;const n=t.getUserId(),i=e.getSender(),s=e.getContent().to;return i===n?s:s===n?i:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===o.j}canCreateRequest(e){return c.canCreateRequest(e)}static getTransactionId(e){if(c.getEventType(e)===o.j)return e.getId();{const t=e.getRelation();if(t&&"m.reference"===t.rel_type)return t.event_id}}static validateEvent(e,t){const n=c.getTransactionId(e);if("string"!=typeof n||0===n.length)return!1;const i=c.getEventType(e),s=e.getContent();if(i===o.j){if(!s||"string"!=typeof s.to||!s.to.length)return r.a.log("InRoomChannel: validateEvent: no valid to "+(s&&s.to)),!1;if(!c.getOtherPartyUserId(e,t))return r.a.log("InRoomChannel: validateEvent: not directed to or sent by me: "+e.getSender()+", "+(s&&s.to)),!1}return o.l.validateEvent(i,e,t)}static getEventType(e){const t=e.getType();if(t===a){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===o.j)return o.j}}return t&&t!==o.j?t:""}handleEvent(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.hasEventId(e.getId()))return;const i=c.getEventType(e);if(e.getRoomId()!==this.roomId)return;if(null===this.userId){const t=c.getOtherPartyUserId(e,this.client);t&&(this.userId=t)}const s=this.client.getUserId(),o=e.getSender();if(null!==this.userId&&o!==s&&o!==this.userId)return void r.a.log("InRoomChannel: ignoring verification event from non-participating sender "+o);null===this.requestEventId&&(this.requestEventId=c.getTransactionId(e));const a=!!e.getUnsigned().transaction_id,l=e.getSender()===this.client.getUserId();return t.handleEvent(i,e,n,a,l)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t["m.relates_to"]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==o.j&&e!==o.i&&e!==o.k||(t.from_device=this.client.getDeviceId()),e===o.j?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:o.j,to:this.userId,from_device:t.from_device,methods:t.methods}:t["m.relates_to"]={rel_type:"m.reference",event_id:this.transactionId},t}send(e,t){const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n=e;e===o.j&&(n=a);const i=await this.client.sendEvent(this.roomId,n,t);e===o.j&&(this.requestEventId=i.event_id)}}class l{constructor(){s()(this,"requestsByRoomId",new Map)}getRequest(e){const t=e.getRoomId(),n=c.getTransactionId(e);return this.getRequestByTxnId(t,n)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){const n=this.requestsByRoomId.get(e);if(n)return n.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),c.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,n){let i=this.requestsByRoomId.get(e);i||(i=new Map,this.requestsByRoomId.set(e,i)),i.set(t,n)}removeRequest(e){const t=e.getRoomId(),n=this.requestsByRoomId.get(t);n&&(n.delete(c.getTransactionId(e)),0===n.size&&this.requestsByRoomId.delete(t))}findRequestInProgress(e){const t=this.requestsByRoomId.get(e);if(t)for(const e of t.values())if(e.pending)return e}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(17),s=n.n(i),o=n(186),r=n(0),a=n(203),c=n(316),l=n(108);class d{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this.client=e,this.userId=t,this.devices=n,this.transactionId=i,this.deviceId=o,s()(this,"request",void 0)}isToDevices(e){if(e.length===this.devices.length){for(const t of e)if(!this.devices.includes(t))return!1;return!0}return!1}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===a.j||e===a.k}canCreateRequest(e){return d.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return r.a.warn("Ignoring flagged verification request from "+e.getSender()),!1;const n=e.getContent();if(!n)return r.a.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!n.transaction_id)return r.a.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const i=e.getType();if(i===a.j){if(!Number.isFinite(n.timestamp))return r.a.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&n.from_device==t.getDeviceId())return r.a.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return a.l.validateEvent(i,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=e.getType(),s=e.getContent();if(i===a.j||i===a.i||i===a.k){this.transactionId||(this.transactionId=s.transaction_id);const e=s.from_device;if(!this.deviceId&&this.devices.includes(e)&&(this.deviceId=e),!this.deviceId||this.deviceId!==e){const t=this.completeContent(a.a,Object(c.b)(Object(c.f)()));return this.sendToDevices(a.a,t,[e])}}const o=t.phase===a.f||t.phase===a.d;await t.handleEvent(e.getType(),e,n,!1,!1);const r=t.phase===a.f||t.phase===a.d;if((i===a.k||i===a.i)&&!o&&r&&this.deviceId){const e=this.devices.filter(e=>e!==this.deviceId&&e!==this.client.getDeviceId());if(e.length){const t=this.completeContent(a.a,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices(a.a,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==a.j&&e!==a.i&&e!==a.k||(t.from_device=this.client.getDeviceId()),e===a.j&&(t.timestamp=Date.now()),t}send(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e!==a.j&&e!==a.k||this.transactionId||(this.transactionId=d.makeTransactionId());const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n;n=e===a.j||e===a.a&&!this.deviceId?await this.sendToDevices(e,t,this.devices):await this.sendToDevices(e,t,[this.deviceId]);const i=new l.b({sender:this.client.getUserId(),content:t,type:e});return await this.request.handleEvent(e,i,!0,!0,!0),n}async sendToDevices(e,t,n){if(n.length){const i={};for(const e of n)i[e]=t;await this.client.sendToDevice(e,{[this.userId]:i})}}static makeTransactionId(){return Object(o.b)(32)}}class u{constructor(){s()(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const n=this.requestsByUserId.get(e);if(n)return n.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,n){let i=this.requestsByUserId.get(e);i||(i=new Map,this.requestsByUserId.set(e,i)),i.set(t,n)}removeRequest(e){const t=e.getSender(),n=this.requestsByUserId.get(t);n&&(n.delete(d.getTransactionId(e)),0===n.size&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){const n=this.requestsByUserId.get(e);if(n)for(const e of n.values())if(e.pending&&e.channel.isToDevices(t))return e}getRequestsInProgress(e){const t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter(e=>e.pending):[]}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(17),s=n.n(i),o=n(370);class r extends o.b{constructor(){super(...arguments),s()(this,"doVerification",async()=>{throw new Error("Verification is not possible with this method")})}static factory(e,t,n,i,s,o){return new r(e,t,n,i,s,o)}static get NAME(){return"org.matrix.illegal_method"}}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(17),s=n.n(i),o=n(108);function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){let n=Boolean(t.preventReEmit);const i=!1!==t.decrypt;return function(t){const s=e.getRoom(t.room_id);let r;s&&void 0===t.state_key&&(r=s.findEventById(t.event_id)),!r||r.status?r=new o.b(t):(r.setUnsigned(a(a({},r.getUnsigned()),t.unsigned)),n=!0);const c=null==s?void 0:s.findThreadForEvent(r);return c&&r.setThread(c),r.isEncrypted()&&(n||e.reEmitter.reEmit(r,[o.c.Decrypted]),i&&e.decryptEventIfNeeded(r)),n||(e.reEmitter.reEmit(r,[o.c.Replaced,o.c.VisibilityChange]),null==s||s.reEmitter.reEmit(r,[o.c.BeforeRedaction])),r}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(17),s=n.n(i),o=n(0),r=n(152);class a{constructor(e){this.client=e,s()(this,"audioInput",void 0),s()(this,"videoInput",void 0),s()(this,"localUserMediaStream",void 0),s()(this,"userMediaStreams",[]),s()(this,"screensharingStreams",[])}async setAudioInput(e){o.a.info("LOG setting audio input to",e),this.audioInput!==e&&(this.audioInput=e,await this.updateLocalUsermediaStreams())}async setVideoInput(e){o.a.info("LOG setting video input to",e),this.videoInput!==e&&(this.videoInput=e,await this.updateLocalUsermediaStreams())}async updateLocalUsermediaStreams(){if(0===this.userMediaStreams.length)return;const e=new Map;for(const t of this.client.callEventHandler.calls.values())e.set(t.callId,{audio:t.hasLocalUserMediaAudioTrack,video:t.hasLocalUserMediaVideoTrack});for(const t of this.client.callEventHandler.calls.values()){if(t.state===r.e.Ended||!e.has(t.callId))continue;const{audio:n,video:i}=e.get(t.callId),s=await this.getUserMediaStream(n,i,!1);await t.updateLocalUsermediaStream(s)}}async hasAudioDevice(){return(await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind).length>0}async hasVideoDevice(){return(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind).length>0}async getUserMediaStream(e,t){var n,i,s,r;let a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const c=e&&await this.hasAudioDevice(),l=t&&await this.hasVideoDevice();let d;if(!this.localUserMediaStream||0===this.localUserMediaStream.getAudioTracks().length&&c||0===this.localUserMediaStream.getVideoTracks().length&&l||(null===(n=this.localUserMediaStream.getAudioTracks()[0])||void 0===n||null===(i=n.getSettings())||void 0===i?void 0:i.deviceId)!==this.audioInput||(null===(s=this.localUserMediaStream.getVideoTracks()[0])||void 0===s||null===(r=s.getSettings())||void 0===r?void 0:r.deviceId)!==this.videoInput){const e=this.getUserMediaContraints(c,l);o.a.log("Getting user media with constraints",e),d=await navigator.mediaDevices.getUserMedia(e);for(const e of d.getTracks()){const t=e.getSettings();"audio"===e.kind?this.audioInput=t.deviceId:"video"===e.kind&&(this.videoInput=t.deviceId)}a&&(this.localUserMediaStream=d)}else{if(d=this.localUserMediaStream.clone(),!c)for(const e of d.getAudioTracks())d.removeTrack(e);if(!l)for(const e of d.getVideoTracks())d.removeTrack(e)}return a&&this.userMediaStreams.push(d),d}stopUserMediaStream(e){o.a.debug("Stopping usermedia stream",e.id);for(const t of e.getTracks())t.stop();const t=this.userMediaStreams.indexOf(e);-1!==t&&(o.a.debug("Splicing usermedia stream out stream array",e.id),this.userMediaStreams.splice(t,1)),this.localUserMediaStream===e&&(this.localUserMediaStream=void 0)}async getScreensharingStream(e){let t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(0===this.screensharingStreams.length){const n=this.getScreenshareContraints(e);if(!n)return null;e?(o.a.debug("Getting screensharing stream using getUserMedia()",e),t=await navigator.mediaDevices.getUserMedia(n)):(o.a.debug("Getting screensharing stream using getDisplayMedia()"),t=await navigator.mediaDevices.getDisplayMedia(n))}else{const e=this.screensharingStreams[this.screensharingStreams.length-1];o.a.log("Cloning screensharing stream",e.id),t=e.clone()}return n&&this.screensharingStreams.push(t),t}stopScreensharingStream(e){o.a.debug("Stopping screensharing stream",e.id);for(const t of e.getTracks())t.stop();const t=this.screensharingStreams.indexOf(e);-1!==t&&(o.a.debug("Splicing screensharing stream out stream array",e.id),this.screensharingStreams.splice(t,1))}stopAllStreams(){for(const e of this.userMediaStreams)for(const t of e.getTracks())t.stop();for(const e of this.screensharingStreams)for(const t of e.getTracks())t.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0}getUserMediaContraints(e,t){const n=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){return e?(o.a.debug("Using desktop capturer source",e),{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e}}}):(o.a.debug("Not using desktop capturer source"),{audio:!1,video:!0})}}},function(e,t,n){e.exports=function(){return new Worker(n.p+"ea3a918c4fa61dda253f.worker.js")}},,,,function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return u}));var i,s,o,r,a,c,l=n(87);function d(){return(d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function u(e){return l.createElement("svg",d({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),i||(i=l.createElement("g",{filter:"url(#element-desktop-logo_svg__filter0_dd)"},l.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M16.144 2.344H7.856c-1.917 0-2.612.2-3.312.574-.701.375-1.251.925-1.626 1.626-.375.7-.574 1.395-.574 3.312v8.288c0 1.917.2 2.612.574 3.312.375.701.925 1.251 1.626 1.626.7.375 1.395.574 3.312.574h8.288c1.917 0 2.612-.2 3.312-.574.701-.375 1.251-.925 1.626-1.626.375-.7.574-1.395.574-3.312V7.856c0-1.917-.2-2.612-.574-3.312a3.907 3.907 0 00-1.626-1.626c-.7-.375-1.395-.574-3.312-.574z",fill:"url(#element-desktop-logo_svg__paint0_linear)"}))),s||(s=l.createElement("g",{filter:"url(#element-desktop-logo_svg__filter1_ddddi)"},l.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M10.097 6.019c0-.45.365-.816.816-.816a5.438 5.438 0 015.437 5.438.816.816 0 11-1.631 0 3.806 3.806 0 00-3.806-3.807.816.816 0 01-.816-.815z",fill:"#fff"}))),o||(o=l.createElement("g",{filter:"url(#element-desktop-logo_svg__filter2_ddddi)"},l.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M13.903 17.981c0 .45-.365.816-.816.816a5.438 5.438 0 01-5.437-5.438.816.816 0 111.631 0 3.806 3.806 0 003.806 3.807c.451 0 .816.365.816.815z",fill:"#fff"}))),r||(r=l.createElement("g",{filter:"url(#element-desktop-logo_svg__filter3_ddddi)"},l.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M6.019 13.903a.816.816 0 01-.816-.816 5.438 5.438 0 015.438-5.437.816.816 0 110 1.631 3.806 3.806 0 00-3.807 3.806c0 .451-.365.816-.815.816z",fill:"#fff"}))),a||(a=l.createElement("g",{filter:"url(#element-desktop-logo_svg__filter4_ddddi)"},l.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M17.981 10.097c.45 0 .816.365.816.816a5.438 5.438 0 01-5.438 5.437.816.816 0 110-1.631 3.806 3.806 0 003.807-3.806c0-.451.365-.816.815-.816z",fill:"#fff"}))),c||(c=l.createElement("defs",null,l.createElement("filter",{id:"element-desktop-logo_svg__filter0_dd",x:1.547,y:1.922,width:20.906,height:20.906,filterUnits:"userSpaceOnUse",colorInterpolationFilters:"sRGB"},l.createElement("feFlood",{floodOpacity:0,result:"BackgroundImageFix"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:.375}),l.createElement("feGaussianBlur",{stdDeviation:.398}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.09 0"}),l.createElement("feBlend",{in2:"BackgroundImageFix",result:"effect1_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:.234}),l.createElement("feGaussianBlur",{stdDeviation:.281}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"}),l.createElement("feBlend",{in2:"effect1_dropShadow",result:"effect2_dropShadow"}),l.createElement("feBlend",{in:"SourceGraphic",in2:"effect2_dropShadow",result:"shape"})),l.createElement("filter",{id:"element-desktop-logo_svg__filter1_ddddi",x:6.956,y:4.031,width:12.534,height:12.534,filterUnits:"userSpaceOnUse",colorInterpolationFilters:"sRGB"},l.createElement("feFlood",{floodOpacity:0,result:"BackgroundImageFix"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:.328}),l.createElement("feGaussianBlur",{stdDeviation:.516}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0"}),l.createElement("feBlend",{in2:"BackgroundImageFix",result:"effect1_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:1.266}),l.createElement("feGaussianBlur",{stdDeviation:.633}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0"}),l.createElement("feBlend",{in2:"effect1_dropShadow",result:"effect2_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:1.969}),l.createElement("feGaussianBlur",{stdDeviation:1.57}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"}),l.createElement("feBlend",{mode:"overlay",in2:"effect2_dropShadow",result:"effect3_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dx:-.188,dy:.422}),l.createElement("feGaussianBlur",{stdDeviation:.34}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"}),l.createElement("feBlend",{mode:"overlay",in2:"effect3_dropShadow",result:"effect4_dropShadow"}),l.createElement("feBlend",{in:"SourceGraphic",in2:"effect4_dropShadow",result:"shape"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0",result:"hardAlpha"}),l.createElement("feOffset",{dy:-.68}),l.createElement("feGaussianBlur",{stdDeviation:.27}),l.createElement("feComposite",{in2:"hardAlpha",operator:"arithmetic",k2:-1,k3:1}),l.createElement("feColorMatrix",{values:"0 0 0 0 0.678431 0 0 0 0 0.819608 0 0 0 0 0.726431 0 0 0 1 0"}),l.createElement("feBlend",{in2:"shape",result:"effect5_innerShadow"})),l.createElement("filter",{id:"element-desktop-logo_svg__filter2_ddddi",x:4.509,y:11.372,width:12.534,height:12.534,filterUnits:"userSpaceOnUse",colorInterpolationFilters:"sRGB"},l.createElement("feFlood",{floodOpacity:0,result:"BackgroundImageFix"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:.328}),l.createElement("feGaussianBlur",{stdDeviation:.516}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0"}),l.createElement("feBlend",{in2:"BackgroundImageFix",result:"effect1_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:1.266}),l.createElement("feGaussianBlur",{stdDeviation:.633}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0"}),l.createElement("feBlend",{in2:"effect1_dropShadow",result:"effect2_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:1.969}),l.createElement("feGaussianBlur",{stdDeviation:1.57}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"}),l.createElement("feBlend",{mode:"overlay",in2:"effect2_dropShadow",result:"effect3_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dx:-.188,dy:.422}),l.createElement("feGaussianBlur",{stdDeviation:.34}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"}),l.createElement("feBlend",{mode:"overlay",in2:"effect3_dropShadow",result:"effect4_dropShadow"}),l.createElement("feBlend",{in:"SourceGraphic",in2:"effect4_dropShadow",result:"shape"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0",result:"hardAlpha"}),l.createElement("feOffset",{dy:-.68}),l.createElement("feGaussianBlur",{stdDeviation:.27}),l.createElement("feComposite",{in2:"hardAlpha",operator:"arithmetic",k2:-1,k3:1}),l.createElement("feColorMatrix",{values:"0 0 0 0 0.678431 0 0 0 0 0.819608 0 0 0 0 0.726431 0 0 0 1 0"}),l.createElement("feBlend",{in2:"shape",result:"effect5_innerShadow"})),l.createElement("filter",{id:"element-desktop-logo_svg__filter3_ddddi",x:2.063,y:6.478,width:12.534,height:12.534,filterUnits:"userSpaceOnUse",colorInterpolationFilters:"sRGB"},l.createElement("feFlood",{floodOpacity:0,result:"BackgroundImageFix"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:.328}),l.createElement("feGaussianBlur",{stdDeviation:.516}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0"}),l.createElement("feBlend",{in2:"BackgroundImageFix",result:"effect1_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:1.266}),l.createElement("feGaussianBlur",{stdDeviation:.633}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0"}),l.createElement("feBlend",{in2:"effect1_dropShadow",result:"effect2_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:1.969}),l.createElement("feGaussianBlur",{stdDeviation:1.57}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"}),l.createElement("feBlend",{mode:"overlay",in2:"effect2_dropShadow",result:"effect3_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dx:-.188,dy:.422}),l.createElement("feGaussianBlur",{stdDeviation:.34}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"}),l.createElement("feBlend",{mode:"overlay",in2:"effect3_dropShadow",result:"effect4_dropShadow"}),l.createElement("feBlend",{in:"SourceGraphic",in2:"effect4_dropShadow",result:"shape"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0",result:"hardAlpha"}),l.createElement("feOffset",{dy:-.68}),l.createElement("feGaussianBlur",{stdDeviation:.27}),l.createElement("feComposite",{in2:"hardAlpha",operator:"arithmetic",k2:-1,k3:1}),l.createElement("feColorMatrix",{values:"0 0 0 0 0.678431 0 0 0 0 0.819608 0 0 0 0 0.726431 0 0 0 1 0"}),l.createElement("feBlend",{in2:"shape",result:"effect5_innerShadow"})),l.createElement("filter",{id:"element-desktop-logo_svg__filter4_ddddi",x:9.403,y:8.925,width:12.534,height:12.534,filterUnits:"userSpaceOnUse",colorInterpolationFilters:"sRGB"},l.createElement("feFlood",{floodOpacity:0,result:"BackgroundImageFix"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:.328}),l.createElement("feGaussianBlur",{stdDeviation:.516}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0"}),l.createElement("feBlend",{in2:"BackgroundImageFix",result:"effect1_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:1.266}),l.createElement("feGaussianBlur",{stdDeviation:.633}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0"}),l.createElement("feBlend",{in2:"effect1_dropShadow",result:"effect2_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dy:1.969}),l.createElement("feGaussianBlur",{stdDeviation:1.57}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"}),l.createElement("feBlend",{mode:"overlay",in2:"effect2_dropShadow",result:"effect3_dropShadow"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l.createElement("feOffset",{dx:-.188,dy:.422}),l.createElement("feGaussianBlur",{stdDeviation:.34}),l.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"}),l.createElement("feBlend",{mode:"overlay",in2:"effect3_dropShadow",result:"effect4_dropShadow"}),l.createElement("feBlend",{in:"SourceGraphic",in2:"effect4_dropShadow",result:"shape"}),l.createElement("feColorMatrix",{in:"SourceAlpha",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0",result:"hardAlpha"}),l.createElement("feOffset",{dy:-.68}),l.createElement("feGaussianBlur",{stdDeviation:.27}),l.createElement("feComposite",{in2:"hardAlpha",operator:"arithmetic",k2:-1,k3:1}),l.createElement("feColorMatrix",{values:"0 0 0 0 0.678431 0 0 0 0 0.819608 0 0 0 0 0.726431 0 0 0 1 0"}),l.createElement("feBlend",{in2:"shape",result:"effect5_innerShadow"})),l.createElement("linearGradient",{id:"element-desktop-logo_svg__paint0_linear",x1:12,y1:2.344,x2:12,y2:21.656,gradientUnits:"userSpaceOnUse"},l.createElement("stop",{stopColor:"#1ED9A3"}),l.createElement("stop",{offset:1,stopColor:"#0DBD8B"})))))}t.default="img/element-desktop-logo.93fc5eb.svg"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(0),c=n(89),l=n(101),d=n(110),u=n(102);class h extends r.a.Component{constructor(){super(...arguments),s()(this,"unmounted",!1),s()(this,"state",{component:null,error:null}),s()(this,"onWrapperCancelClick",()=>{this.props.onFinished(!1)})}componentDidMount(){a.a.log("Starting load of AsyncWrapper for modal"),this.props.prom.then(e=>{if(this.unmounted)return;const t=e.default?e.default:e;this.setState({component:t})}).catch(e=>{a.a.warn("AsyncWrapper promise failed",e),this.setState({error:e})})}componentWillUnmount(){this.unmounted=!0}render(){if(this.state.component){const e=this.state.component;return r.a.createElement(e,this.props)}return this.state.error?r.a.createElement(l.a,{onFinished:this.props.onFinished,title:Object(c.a)("Error")},Object(c.a)("Unable to load! Check your network connectivity and try again."),r.a.createElement(d.a,{primaryButton:Object(c.a)("Dismiss"),onPrimaryButtonClick:this.onWrapperCancelClick,hasCancel:!1})):r.a.createElement(u.a,null)}}},,,,,,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return l}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(0),c=n(89);class l extends r.a.Component{constructor(e){super(e),s()(this,"captchaWidgetId",void 0),s()(this,"recaptchaContainer",Object(o.createRef)()),this.state={errorText:void 0}}componentDidMount(){if(this.isRecaptchaReady())this.onCaptchaLoaded();else{a.a.log("Loading recaptcha script..."),window.mxOnRecaptchaLoaded=()=>{this.onCaptchaLoaded()};const e=document.createElement("script");e.setAttribute("src","https://www.recaptcha.net/recaptcha/api.js?onload=mxOnRecaptchaLoaded&render=explicit"),this.recaptchaContainer.current.appendChild(e)}}componentWillUnmount(){this.resetRecaptcha()}isRecaptchaReady(){return"undefined"!=typeof window&&void 0!==e.grecaptcha&&"function"==typeof e.grecaptcha.render}renderRecaptcha(t){if(!this.isRecaptchaReady())throw a.a.error("grecaptcha not loaded!"),new Error("Recaptcha did not load successfully");const n=this.props.sitePublicKey;if(!n)throw a.a.error("No public key for recaptcha!"),new Error("This server has not supplied enough information for Recaptcha authentication");a.a.info("Rendering to %s",t),this.captchaWidgetId=e.grecaptcha.render(t,{sitekey:n,callback:this.props.onCaptchaResponse})}resetRecaptcha(){var t,n;this.captchaWidgetId&&(null===(t=e)||void 0===t||null===(n=t.grecaptcha)||void 0===n||n.reset(this.captchaWidgetId))}onCaptchaLoaded(){a.a.log("Loaded recaptcha script.");try{this.renderRecaptcha("mx_recaptcha"),this.setState({errorText:null})}catch(e){this.setState({errorText:e.toString()})}}render(){let e=null;return this.state.errorText&&(e=r.a.createElement("div",{className:"error"},this.state.errorText)),r.a.createElement("div",{ref:this.recaptchaContainer},r.a.createElement("p",null,Object(c.a)("This homeserver would like to make sure you are not a robot.")),r.a.createElement("div",{id:"mx_recaptcha"}),e)}}s()(l,"defaultProps",{onCaptchaResponse:()=>{}})}).call(this,n(30))},,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return F}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(150),c=n.n(a),l=n(702),d=n.n(l),u=n(97),h=n(165),m=n(158),p=n(133),g=n(95),f=n(92),v=n(89),b=n(112),y=n(93),S=n(698),E=n(235),w=n(132),_=n(149),C=n(117),O=n(147),R=n(96),I=n(1261),k=n(1262),x=n(115),T=n(1487),j=n(1265),N=n(1489),P=n(106),D=n(91),A=n(358),M=n(219);function U(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function L(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?U(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):U(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class F extends r.a.Component{constructor(t){super(t),s()(this,"contentRef",Object(o.createRef)()),s()(this,"unmounted",!1),s()(this,"pills",[]),s()(this,"context",void 0),s()(this,"onCancelClick",()=>{this.setState({widgetHidden:!0}),e.localStorage&&e.localStorage.setItem("hide_preview_"+this.props.mxEvent.getId(),"1"),this.forceUpdate()}),s()(this,"onEmoteSenderClick",()=>{const e=this.props.mxEvent;f.a.dispatch({action:R.a.ComposerInsert,userId:e.getSender(),timelineRenderingType:this.context.timelineRenderingType})}),s()(this,"onBodyLinkClick",e=>{const t=e.target;if("A"!==t.nodeName||t.classList.contains(A.e.className))return;const{href:n}=t,i=Object(w.j)(n);i!==n&&(e.preventDefault(),window.location.hash=i)}),s()(this,"getEventTileOps",()=>({isWidgetHidden:()=>this.state.widgetHidden,unhideWidget:()=>{this.setState({widgetHidden:!1}),e.localStorage&&e.localStorage.removeItem("hide_preview_"+this.props.mxEvent.getId())}})),s()(this,"onStarterLinkClick",(e,t)=>{t.preventDefault();const n=E.a.sharedInstance();if(!n.hasManager())return void n.openNoManagerDialog();const i=n.getPrimaryManager(),s=i.getScalarClient();s.connect().then(()=>{const t=s.getStarterLink(e),n=i.uiUrl;g.a.createTrackedDialog("Add an integration","",x.a,{title:Object(v.a)("Add an Integration"),description:r.a.createElement("div",null,Object(v.a)("You are about to be taken to a third-party site so you can authenticate your account for use with %(integrationsUrl)s. Do you wish to continue?",{integrationsUrl:n})),button:Object(v.a)("Continue"),onFinished(e){if(!e)return;const n=window.screen.width>1024?1024:window.screen.width,i=window.screen.height>800?800:window.screen.height,s=(window.screen.width-n)/2,o=`height=${i}, width=${n}, top=${(window.screen.height-i)/2}, left=${s},`;window.open(t,"_blank",o).opener=null}})})}),s()(this,"openHistoryDialog",async()=>{g.a.createDialog(T.a,{mxEvent:this.props.mxEvent})}),this.state={links:[],widgetHidden:!1}}componentDidMount(){this.props.editState||this.applyFormatting()}applyFormatting(){const e=y.b.getValue("showCodeLineNumbers");if(this.activateSpoilers([this.contentRef.current]),Object(S.a)([this.contentRef.current],this.props.mxEvent,this.pills),m.g(this.contentRef.current),this.calculateUrlPreview(),"org.matrix.custom.html"===this.props.mxEvent.getContent().format){const t=c.a.findDOMNode(this).getElementsByTagName("pre");if(t.length>0)for(let n=0;n<t.length;n++){if("mx_EventTile_pre_container"==t[n].parentElement.className)continue;0==t[n].getElementsByTagName("code").length&&this.addCodeElement(t[n]);const i=this.wrapInDiv(t[n]);this.handleCodeBlockExpansion(t[n]),this.addCodeExpansionButton(i,t[n]),this.addCodeCopyButton(i),e&&this.addLineNumbers(t[n])}const n=c.a.findDOMNode(this).getElementsByTagName("code");n.length>0&&setTimeout(()=>{if(!this.unmounted)for(let e=0;e<n.length;e++)this.highlightCode(n[e])},10)}}addCodeElement(e){const t=document.createElement("code");t.append(...e.childNodes),e.appendChild(t)}addCodeExpansionButton(e,t){if(Math.round(t.offsetHeight/O.b.instance.windowHeight*100)<30)return;const n=document.createElement("span");n.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?n.className+="mx_EventTile_expandButton":n.className+="mx_EventTile_collapseButton",n.onclick=async()=>{n.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?(t.className="",n.className+="mx_EventTile_collapseButton"):(t.className="mx_EventTile_collapsedCodeBlock",n.className+="mx_EventTile_expandButton"),this.props.onHeightChanged()},e.appendChild(n)}addCodeCopyButton(e){const t=document.createElement("span");t.className="mx_EventTile_button mx_EventTile_copyButton ";e.getElementsByClassName("mx_EventTile_button").length>0&&(t.className+="mx_EventTile_buttonBottom"),t.onclick=async()=>{const e=t.parentElement.getElementsByTagName("code")[0],n=await Object(_.c)(e.textContent),i=t.getBoundingClientRect(),{close:s}=b.n(I.a,L(L({},Object(b.p)(i,0)),{},{chevronFace:b.a.None,message:n?Object(v.a)("Copied!"):Object(v.a)("Failed to copy")}));t.onmouseleave=s},e.appendChild(t)}wrapInDiv(e){const t=document.createElement("div");return t.className="mx_EventTile_pre_container",e.parentNode.replaceChild(t,e),t.appendChild(e),t}handleCodeBlockExpansion(e){y.b.getValue("expandCodeByDefault")||(e.className="mx_EventTile_collapsedCodeBlock")}addLineNumbers(e){const t=e.innerHTML.replace(/\n(<\/code>)?$/,"").split(/\n/).length,n=document.createElement("span");n.className="mx_EventTile_lineNumbers";for(let e=1;e<=t;e++){const t=document.createElement("span");t.textContent=e.toString(),n.appendChild(t)}e.prepend(n),e.append(document.createElement("span"))}highlightCode(e){if(e.textContent.length>4096)return void console.log("Code block is bigger than highlight limit ("+e.textContent.length+" > 4096): not highlighting");let t;for(const n of e.className.split(/\s+/))if(n.startsWith("language-")){const e=n.split("-",2)[1];if(d.a.getLanguage(e)){t=e;break}}t?e.innerHTML=d.a.highlight(t,e.textContent).value:y.b.getValue("enableSyntaxHighlightLanguageDetection")&&e.parentElement instanceof HTMLPreElement&&(e.innerHTML=d.a.highlightAuto(e.textContent).value)}componentDidUpdate(e){if(!this.props.editState){const t=e.editState&&!this.props.editState;(e.replacingEventId!==this.props.replacingEventId||t)&&this.applyFormatting()}}componentWillUnmount(){this.unmounted=!0,Object(S.b)(this.pills)}shouldComponentUpdate(e,t){return e.mxEvent.getId()!==this.props.mxEvent.getId()||e.highlights!==this.props.highlights||e.replacingEventId!==this.props.replacingEventId||e.highlightLink!==this.props.highlightLink||e.showUrlPreview!==this.props.showUrlPreview||e.editState!==this.props.editState||t.links!==this.state.links||t.widgetHidden!==this.state.widgetHidden||e.isSeeingThroughMessageHiddenForModeration!==this.props.isSeeingThroughMessageHiddenForModeration}calculateUrlPreview(){if(this.props.showUrlPreview){let e=this.findLinks([this.contentRef.current]);if(e.length){if(e=Array.from(new Set(e)),this.setState({links:e}),window.localStorage){const e=!!window.localStorage.getItem("hide_preview_"+this.props.mxEvent.getId());this.setState({widgetHidden:e})}}else this.state.links.length&&this.setState({links:[]})}}activateSpoilers(e){let t=e[0];for(;t;){if("SPAN"===t.tagName&&"string"==typeof t.getAttribute("data-mx-spoiler")){const e=document.createElement("span"),n=t.getAttribute("data-mx-spoiler");t.removeAttribute("data-mx-spoiler");const i=r.a.createElement(k.a,{reason:n,contentHtml:t.outerHTML});c.a.render(i,e),t.parentNode.replaceChild(e,t),t=e}t.childNodes&&t.childNodes.length&&this.activateSpoilers(t.childNodes),t=t.nextSibling}}findLinks(e){let t=[];for(let n=0;n<e.length;n++){const i=e[n];if("A"===i.tagName&&i.getAttribute("href"))this.isLinkPreviewable(i)&&t.push(i.getAttribute("href"));else{if("PRE"===i.tagName||"CODE"===i.tagName||"BLOCKQUOTE"===i.tagName)continue;i.children&&i.children.length&&(t=t.concat(this.findLinks(i.children)))}}return t}isLinkPreviewable(e){if(!e.getAttribute("href").startsWith("http://")&&!e.getAttribute("href").startsWith("https://"))return!1;if(e.textContent.indexOf("/")>-1)return!0;{const t=e.getAttribute("href").match(/^https?:\/\/(.*?)(\/|$)/)[1];return!Object(w.d)(t)&&!e.textContent.toLowerCase().trim().startsWith(t.toLowerCase())}}renderEditedMarker(){const e=this.props.mxEvent.replacingEventDate(),t=e&&Object(p.b)(e),n=r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Tooltip_title"},Object(v.a)("Edited at %(date)s",{date:t})),r.a.createElement("div",{className:"mx_Tooltip_sub"},Object(v.a)("Click to view edits")));return r.a.createElement(C.a,{className:"mx_EventTile_edited",onClick:this.openHistoryDialog,title:Object(v.a)("Edited at %(date)s. Click to view edits.",{date:t}),tooltip:n},r.a.createElement("span",null,`(${Object(v.a)("edited")})`))}renderPendingModerationMarker(){let e;const t=this.props.mxEvent.messageVisibility();switch(t.visible){case!0:throw new Error("renderPendingModerationMarker should only be applied to hidden messages");case!1:e=t.reason?Object(v.a)("Message pending moderation: %(reason)s",{reason:t.reason}):Object(v.a)("Message pending moderation")}return r.a.createElement("span",{className:"mx_EventTile_pendingModeration"},`(${e})`)}render(){if(this.props.editState)return r.a.createElement(j.a,{editState:this.props.editState,className:"mx_EventTile_content"});const e=this.props.mxEvent,t=e.getContent();let n=!1,i=!1;const s=!e.replacingEvent()&&!!Object(M.b)(e);let o,a;if(y.b.isEnabled("feature_extensible_events")){const e=this.props.mxEvent.unstableExtensibleEvent;null!=e&&e.isEquivalentTo(h.M_MESSAGE)&&(i=Object(h.isEventLike)(e.wireFormat,h.LegacyMsgType.Emote),n=Object(h.isEventLike)(e.wireFormat,h.LegacyMsgType.Notice),o=m.b({body:e.text,format:e.html?"org.matrix.custom.html":void 0,formatted_body:e.html,msgtype:u.c.Text},this.props.highlights,{disableBigEmoji:i||!y.b.getValue("TextualBody.enableBigEmoji"),stripReplyFallback:s,ref:this.contentRef,returnString:!1}))}return o||(i=t.msgtype===u.c.Emote,n=t.msgtype===u.c.Notice,o=m.b(t,this.props.highlights,{disableBigEmoji:i||!y.b.getValue("TextualBody.enableBigEmoji"),stripReplyFallback:s,ref:this.contentRef,returnString:!1})),this.props.replacingEventId&&(o=r.a.createElement(r.a.Fragment,null,o,this.renderEditedMarker())),this.props.isSeeingThroughMessageHiddenForModeration&&(o=r.a.createElement(r.a.Fragment,null,o,this.renderPendingModerationMarker())),this.props.highlightLink?o=r.a.createElement("a",{href:this.props.highlightLink},o):t.data&&"string"==typeof t.data["org.matrix.neb.starter_link"]&&(o=r.a.createElement(D.a,{kind:"link_inline",onClick:this.onStarterLinkClick.bind(this,t.data["org.matrix.neb.starter_link"])},o)),this.state.links.length&&!this.state.widgetHidden&&this.props.showUrlPreview&&(a=r.a.createElement(N.a,{links:this.state.links,mxEvent:this.props.mxEvent,onCancelClick:this.onCancelClick,onHeightChanged:this.props.onHeightChanged})),i?r.a.createElement("div",{className:"mx_MEmoteBody mx_EventTile_content",onClick:this.onBodyLinkClick},"* ",r.a.createElement("span",{className:"mx_MEmoteBody_sender",onClick:this.onEmoteSenderClick},e.sender?e.sender.name:e.getSender())," ",o,a):n?r.a.createElement("div",{className:"mx_MNoticeBody mx_EventTile_content",onClick:this.onBodyLinkClick},o,a):r.a.createElement("div",{className:"mx_MTextBody mx_EventTile_content",onClick:this.onBodyLinkClick},o,a)}}s()(F,"contextType",P.b)}).call(this,n(30))},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/social/facebook.d547f79.png"},function(e,t){e.exports="img/social/twitter-2.6517b36.png"},function(e,t){e.exports="img/social/linkedin.ab157f6.png"},function(e,t){e.exports="img/social/reddit.eeab8e6.png"},function(e,t){e.exports="img/social/email-1.1134895.png"},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(87),s=n.n(i);class o extends s.a.Component{render(){return s.a.createElement("div",{className:"mx_Tooltip mx_Tooltip_visible",style:{display:"block"}},this.props.message)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o);class a extends r.a.Component{constructor(e){super(e),s()(this,"toggleVisible",e=>{this.state.visible||(e.preventDefault(),e.stopPropagation()),this.setState({visible:!this.state.visible})}),this.state={visible:!1}}render(){const e=this.props.reason?r.a.createElement("span",{className:"mx_EventTile_spoiler_reason"},"("+this.props.reason+")"):null;return r.a.createElement("span",{className:"mx_EventTile_spoiler"+(this.state.visible?" visible":""),onClick:this.toggleVisible},e," ",r.a.createElement("span",{className:"mx_EventTile_spoiler_content",dangerouslySetInnerHTML:{__html:this.props.contentHtml}}))}}},,,function(e,t,n){"use strict";var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(94),c=n.n(a),l=n(108),d=n(97),u=n(0),h=n(89),m=n(92),p=n(856),g=n(717),f=n(718),v=n(153),b=n(510),y=n(223),S=n(844),E=n(360),w=n(96),_=n(114),C=n(756),O=n(91),R=n(497),I=n(93),k=n(100),x=n(106),T=n(408),j=n(757),N=n(109),P=n(173),D=n(758);function A(e,t){const n=Object(f.a)(e);n&&(e=Object(f.d)(e));const i=!!t.replyEventId;let s="",o="";i&&(s=function(e){const t=e.getContent().body.split("\n").map(e=>e.trim());return t.length>2&&t[0].startsWith("> ")&&0===t[1].length?t[0]+"\n\n":""}(t),o=function(e){const t=e.getContent().formatted_body;if(!t)return"";const n=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return n&&n.outerHTML||""}(t));const r=Object(f.f)(e),a={msgtype:n?d.c.Emote:d.c.Text,body:r},c={msgtype:a.msgtype,body:`${s} * ${r}`},l=Object(f.b)(e,{forceHTML:i,useMarkdown:I.b.getValue("MessageComposerInput.useMarkdown")});l&&(a.format="org.matrix.custom.html",a.formatted_body=l,c.format=a.format,c.formatted_body=`${o} * ${l}`);const u={"m.new_content":a,"m.relates_to":{rel_type:"m.replace",event_id:t.getId()}};return Object.assign(u,c)}class M extends r.a.Component{constructor(e,t){super(e),s()(this,"context",void 0),s()(this,"editorRef",Object(o.createRef)()),s()(this,"dispatcherRef",void 0),s()(this,"model",null),s()(this,"onKeyDown",e=>{var t;if(null!==(t=this.editorRef.current)&&void 0!==t&&t.isComposing(e))return;switch(Object(_.a)().getMessageComposerAction(e)){case N.h.SendMessage:this.sendEdit(),e.stopPropagation(),e.preventDefault();break;case N.h.CancelReplyOrEdit:e.stopPropagation(),this.cancelEdit();break;case N.h.EditPrevMessage:{var n,i;if(null!==(n=this.editorRef.current)&&void 0!==n&&n.isModified()||null===(i=this.editorRef.current)||void 0===i||!i.isCaretAtStart())return;const t=Object(v.g)({events:this.events,isForward:!1,fromEventId:this.props.editState.getEvent().getId()});t&&(m.a.dispatch({action:w.a.EditEvent,event:t,timelineRenderingType:this.context.timelineRenderingType}),e.preventDefault());break}case N.h.EditNextMessage:{var s,o;if(null!==(s=this.editorRef.current)&&void 0!==s&&s.isModified()||null===(o=this.editorRef.current)||void 0===o||!o.isCaretAtEnd())return;const t=Object(v.g)({events:this.events,isForward:!0,fromEventId:this.props.editState.getEvent().getId()});t?m.a.dispatch({action:w.a.EditEvent,event:t,timelineRenderingType:this.context.timelineRenderingType}):this.cancelEdit(),e.preventDefault();break}}}),s()(this,"cancelEdit",()=>{this.clearStoredEditorState(),this.endEdit()}),s()(this,"saveStoredEditorState",()=>{const e=C.a.createItem(this.model);this.clearPreviousEdit(),localStorage.setItem(this.editorRoomKey,this.props.editState.getEvent().getId()),localStorage.setItem(this.editorStateKey,JSON.stringify(e))}),s()(this,"sendEdit",async()=>{if(this.state.saveDisabled)return;const e=this.props.editState.getEvent();if(P.a.instance.trackEvent({eventName:"Composer",isEditing:!0,inThread:!(null==e||!e.getThread()),isReply:!!e.replyEventId}),I.b.getValue("MessageComposerInput.autoReplaceEmoji")){var t,n;const e=null===(t=this.editorRef.current)||void 0===t?void 0:t.getCaret(),i=this.model.positionForOffset(e.offset,e.atNodeEnd);null===(n=this.editorRef.current)||void 0===n||n.replaceEmoticon(i,S.a)}const i=A(this.model,e),s=i["m.new_content"];let o=!0;if(""===(null==s?void 0:s.body))return this.cancelPreviousPendingEdit(),void Object(R.a)({mxEvent:e,onCloseDialog:()=>{this.cancelEdit()}});if(this.isContentModified(s)){const t=e.getRoomId();if(!Object(f.a)(this.model)&&Object(j.b)(this.model)){const[n,s,a]=Object(j.a)(this.model);if(n){var r;const a=(null==e||null===(r=e.getThread())||void 0===r?void 0:r.id)||null;if(n.category===E.a.messages){if(i["m.new_content"]=await Object(j.c)(n,s,t,a),!i["m.new_content"])return}else Object(j.c)(n,s,t,a),o=!1}else if(!await Object(j.d)(a))return}if(o){this.cancelPreviousPendingEdit();const e=this.props.editState.getEvent().threadRootId||null;this.props.mxClient.sendMessage(t,e,i),this.clearStoredEditorState(),m.a.dispatch({action:"message_sent"})}}this.endEdit()}),s()(this,"onChange",()=>{var e;this.state.saveDisabled&&null!==(e=this.editorRef.current)&&void 0!==e&&e.isModified()&&this.setState({saveDisabled:!1})}),s()(this,"onAction",e=>{if(this.editorRef.current)if(e.action===w.a.ComposerInsert){if(e.timelineRenderingType!==this.context.timelineRenderingType)return;if(e.composerType!==T.a.Edit)return;var t;if(e.userId)null===(t=this.editorRef.current)||void 0===t||t.insertMention(e.userId);else if(e.event){var n;null===(n=this.editorRef.current)||void 0===n||n.insertQuotedMessage(e.event)}else if(e.text){var i;null===(i=this.editorRef.current)||void 0===i||i.insertPlaintext(e.text)}}else e.action===w.a.FocusEditMessageComposer&&this.editorRef.current.focus()}),this.context=t;const n=this.createEditorModel(),i=this.props.editState.getEvent(),r=A(this.model,i);this.state={saveDisabled:!n||!this.isContentModified(r["m.new_content"])},window.addEventListener("beforeunload",this.saveStoredEditorState),this.dispatcherRef=m.a.register(this.onAction)}getRoom(){return this.props.mxClient.getRoom(this.props.editState.getEvent().getRoomId())}endEdit(){m.a.dispatch({action:w.a.EditEvent,event:null,timelineRenderingType:this.context.timelineRenderingType}),m.a.dispatch({action:w.a.FocusSendMessageComposer,context:this.context.timelineRenderingType})}get editorRoomKey(){return Object(D.a)(this.props.editState.getEvent().getRoomId(),this.context.timelineRenderingType)}get editorStateKey(){return Object(D.b)(this.props.editState.getEvent().getId())}get events(){const e=this.context.liveTimeline.getEvents(),t=this.getRoom().getPendingEvents(),n=Boolean(this.props.editState.getEvent().getThread());return e.concat(n?[]:t)}get shouldSaveStoredEditorState(){return null!==localStorage.getItem(this.editorRoomKey)}restoreStoredEditorState(e){const t=localStorage.getItem(this.editorStateKey);if(t)try{const{parts:n}=JSON.parse(t);return n.map(t=>e.deserializePart(t))}catch(e){u.a.error("Error parsing editing state: ",e)}}clearStoredEditorState(){localStorage.removeItem(this.editorRoomKey),localStorage.removeItem(this.editorStateKey)}clearPreviousEdit(){localStorage.getItem(this.editorRoomKey)&&localStorage.removeItem("mx_edit_state_"+localStorage.getItem(this.editorRoomKey))}isContentModified(e){const t=this.props.editState.getEvent().getContent();return t.msgtype!==e.msgtype||t.body!==e.body||t.format!==e.format||t.formatted_body!==e.formatted_body}cancelPreviousPendingEdit(){const e=this.props.editState.getEvent().replacingEvent();!e||e.status!==l.a.QUEUED&&e.status!==l.a.NOT_SENT||this.props.mxClient.cancelPendingEvent(e)}componentWillUnmount(){const e=document.getSelection();let t;var n;e.focusNode&&(t=Object(g.a)(null===(n=this.editorRef.current)||void 0===n?void 0:n.editorRef.current,e).caret);const i=this.model.serializeParts();this.props.editState.setEditorState(t,i),window.removeEventListener("beforeunload",this.saveStoredEditorState),this.shouldSaveStoredEditorState&&this.saveStoredEditorState(),m.a.unregister(this.dispatcherRef)}createEditorModel(){const{editState:e}=this.props,t=this.getRoom(),n=new y.a(t,this.props.mxClient);let i,s=!1;if(e.hasEditorState())i=e.getSerializedParts().map(e=>n.deserializePart(e));else{const t=this.restoreStoredEditorState(n);i=t||Object(b.b)(e.getEvent(),n,{shouldEscape:I.b.getValue("MessageComposerInput.useMarkdown")}),s=!!t}return this.model=new p.a(i,n),this.saveStoredEditorState(),s}render(){var e,t,n;return r.a.createElement("div",{className:c()("mx_EditMessageComposer",this.props.className),onKeyDown:this.onKeyDown},r.a.createElement(S.b,{ref:this.editorRef,model:this.model,room:this.getRoom(),threadId:null===(e=this.props.editState)||void 0===e||null===(t=e.getEvent())||void 0===t||null===(n=t.getThread())||void 0===n?void 0:n.id,initialCaret:this.props.editState.getCaret(),label:Object(h.a)("Edit message"),onChange:this.onChange}),r.a.createElement("div",{className:"mx_EditMessageComposer_buttons"},r.a.createElement(O.a,{kind:"secondary",onClick:this.cancelEdit},Object(h.a)("Cancel")),r.a.createElement(O.a,{kind:"primary",onClick:this.sendEdit,disabled:this.state.saveDisabled},Object(h.a)("Save"))))}}s()(M,"contextType",x.b);const U=Object(k.b)(M);t.a=U},,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i=()=>{const e=new WeakSet;return(t,n)=>{if("object"==typeof n&&null!==n){if(e.has(n))return"<$ cycle-trimmed $>";e.add(n)}return n}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return r}));var i,s=n(87);function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function r(e){return s.createElement("svg",o({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 15 18",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("g",{stroke:"#B8BEC9",fill:"none",fillRule:"evenodd",strokeLinecap:"round",strokeLinejoin:"round"},s.createElement("path",{d:"M8.313 1H2.625C1.728 1 1 1.716 1 2.6v12.8c0 .884.728 1.6 1.625 1.6h9.75c.897 0 1.625-.716 1.625-1.6V6.6L8.312 1z"}),s.createElement("path",{d:"M8.313 1v5.6H14"}))))}t.default="img/feather-customised/files.d6a33b8.svg"},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return r}));var i,s=n(87);function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function r(e){return s.createElement("svg",o({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M18.002 1.033L16.868-.1 8.932 7.836l-7.9-7.9L-.1 1.07l7.9 7.9-7.9 7.898 1.134 1.134 7.9-7.899 7.936 7.938 1.134-1.134-7.937-7.937 7.936-7.937",opacity:.9,fill:"#454545",fillRule:"evenodd"})))}t.default="img/cancel.4b9715b.svg"},,,,,function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return r}));var i,s=n(87);function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function r(e){return s.createElement("svg",o({viewBox:"-1 -1 12 14",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M.574 6.473a.573.573 0 00-.406.98l4.38 4.379a.575.575 0 00.812 0L9.745 7.46a.575.575 0 00-.81-.814L5.524 10.05 5.52.574a.575.575 0 00-1.148 0l.001 9.46L.98 6.643a.57.57 0 00-.406-.169z",fill:"#76CFA6",fillRule:"evenodd"})))}t.default="img/download.4f331f0.svg"},function(e,t,n){e.exports=function(){return new Worker(n.p+"df68b9f4f43f094f5acf.worker.js")}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){e.exports=n.p+"recorder-worklet.3accbfe.js"},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return a}));var i,s,o=n(87);function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function a(e){return o.createElement("svg",r({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 500 500",role:"presentation","aria-hidden":!0},e),i||(i=o.createElement("path",{fill:"#76CFA6",d:"M250 500c138.571 0 250-111.43 250-250C500 111.429 388.571 0 250 0S0 111.429 0 250c0 138.57 111.429 250 250 250z",opacity:.15})),s||(s=o.createElement("path",{fill:"none",stroke:"#76CFA6",strokeWidth:12,strokeMiterlimit:10,d:"M249 430c-98.996 0-180-81.003-180-180 0-98.998 81.005-180 180-180 98.994 0 180 81.001 180 180 0 98.997-81.005 180-180 180zm72.8-200.8c17.685 0 31.201-13.518 31.201-31.2s-13.519-31.2-31.201-31.2c-17.682 0-31.2 13.518-31.2 31.2s13.518 31.2 31.2 31.2zm-145.6 0c17.682 0 31.2-13.518 31.2-31.2s-13.519-31.2-31.2-31.2c-17.683 0-31.201 13.518-31.201 31.2s13.519 31.2 31.201 31.2zM249 364.4c48.883 0 89.436-30.164 106.081-72.801H142.919C159.564 334.236 200.117 364.4 249 364.4z"})))}t.default="img/icons-show-stickers.4e420bf.svg"},function(e,t,n){"use strict";function i(){window.TouchEvent||(window.TouchEvent=class extends UIEvent{get altKey(){return!1}get changedTouches(){return[]}get ctrlKey(){return!1}get metaKey(){return!1}get shiftKey(){return!1}get targetTouches(){return[]}get touches(){return[]}get rotation(){return 0}get scale(){return 0}constructor(e,t){super(e,t)}})}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(88),s=n.n(i),o=n(1375),r=n(131),a=n(171);class c{constructor(e){var t=this;this.store=e,s()(this,"filter",new o.a),s()(this,"activeSpace",r.a.instance.activeSpace),s()(this,"allRoomsInHome",r.a.instance.allRoomsInHome),s()(this,"onSelectedSpaceUpdated",(function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.allRoomsInHome;if(e===t.activeSpace&&n===t.allRoomsInHome)return;const i=c.needsFilter(t.activeSpace,t.allRoomsInHome),s=c.needsFilter(e,n);t.activeSpace=e,t.allRoomsInHome=n,s&&t.updateFilter(),!i&&s?t.store.addFilter(t.filter):i&&!s&&t.store.removeFilter(t.filter)})),s()(this,"onHomeBehaviourUpdated",e=>{this.onSelectedSpaceUpdated(this.activeSpace,e)}),s()(this,"updateFilter",()=>{this.filter.updateSpace(this.activeSpace)}),c.needsFilter(this.activeSpace,this.allRoomsInHome)&&(this.updateFilter(),e.addFilter(this.filter)),r.a.instance.on(a.d,this.onSelectedSpaceUpdated),r.a.instance.on(a.b,this.onHomeBehaviourUpdated)}static needsFilter(e,t){return!(e===a.a.Home&&t)}}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return u}));var i=n(88),s=n.n(i),o=n(8),r=n(386),a=n(131),c=n(171),l=n(790),d=n(93);class u extends o.EventEmitter{constructor(){var t;super(...arguments),t=this,s()(this,"roomIds",new Set),s()(this,"userIds",new Set),s()(this,"showPeopleInSpace",!0),s()(this,"space",c.a.Home),s()(this,"onStoreUpdate",(async function(){let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const i=t.roomIds;t.roomIds=new Set(a.a.instance.getSpaceFilteredRoomIds(t.space));const s=t.userIds;t.userIds=new Set(a.a.instance.getSpaceFilteredUserIds(t.space));const o=t.showPeopleInSpace;t.showPeopleInSpace=Object(c.h)(t.space[0])||d.b.getValue("Spaces.showPeopleInSpace",t.space),(n||o!==t.showPeopleInSpace||Object(l.b)(i,t.roomIds)||Object(l.b)(s,t.userIds))&&(t.emit(r.a),e(()=>{t.emit(r.a)}))}))}get kind(){return r.b.Prefilter}isVisible(e){return a.a.instance.isRoomInSpace(this.space,e.roomId)}updateSpace(e){a.a.instance.off(this.space,this.onStoreUpdate),a.a.instance.on(this.space=e,this.onStoreUpdate),this.onStoreUpdate(!0)}destroy(){a.a.instance.off(this.space,this.onStoreUpdate)}}}).call(this,n(179).setImmediate)},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return a}));var i,s,o=n(87);function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function a(e){return o.createElement("svg",r({viewBox:"26 25 6 6",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),i||(i=o.createElement("defs",null,o.createElement("filter",{x:"-5.9%",y:"-7.9%",width:"111.8%",height:"115.8%",filterUnits:"objectBoundingBox",id:"icon-pill-remove_svg__a"},o.createElement("feOffset",{dy:2,in:"SourceAlpha",result:"shadowOffsetOuter1"}),o.createElement("feGaussianBlur",{stdDeviation:16,in:"shadowOffsetOuter1",result:"shadowBlurOuter1"}),o.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0.473684211 0 0 0 0 1 0 0 0 0.241258741 0",in:"shadowBlurOuter1",result:"shadowMatrixOuter1"}),o.createElement("feMerge",null,o.createElement("feMergeNode",{in:"shadowMatrixOuter1"}),o.createElement("feMergeNode",{in:"SourceGraphic"}))))),s||(s=o.createElement("g",{filter:"url(#icon-pill-remove_svg__a)",transform:"translate(-406 -215)",stroke:"#61708B"},o.createElement("path",{d:"M438 240l-6 6m0-6l6 6"}))))}t.default="img/icon-pill-remove.7719165.svg"},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return a}));var i,s,o=n(87);function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function a(e){return o.createElement("svg",r({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),i||(i=o.createElement("circle",{cx:10,cy:10,r:9.5,stroke:"#787878"})),s||(s=o.createElement("path",{d:"M9.792 14h1.415V8H9.791v6zm.711-6.852c.45 0 .817-.343.817-.765 0-.426-.367-.77-.817-.77-.453 0-.82.344-.82.77 0 .422.367.765.82.765z",fill:"#787878"})))}t.default="img/element-icons/info.dc07e19.svg"},function(e,t){e.exports="img/betas/threads.ec0f5bb.png"},function(e,t){e.exports="img/betas/new_search_experience.b8f51e0.gif"},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return c}));var i=n(351),s=n.n(i);function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const a={bgColor:"#d00",textColor:"#fff",fontFamily:"sans-serif",fontWeight:"bold",isUp:!1,isLeft:!1};class c{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s()(this,"browser",{ff:void 0!==window.InstallTrigger,opera:!!window.opera||navigator.userAgent.includes("Opera")}),s()(this,"params",void 0),s()(this,"canvas",void 0),s()(this,"baseImage",void 0),s()(this,"context",void 0),s()(this,"icons",void 0),s()(this,"isReady",!1),s()(this,"readyCb",()=>{}),this.params=r(r({},a),e),this.icons=c.getIcons(),this.canvas=document.createElement("canvas"),this.baseImage=document.createElement("img");const t=this.icons[this.icons.length-1];t.hasAttribute("href")?(this.baseImage.setAttribute("crossOrigin","anonymous"),this.baseImage.onload=()=>{this.canvas.height=this.baseImage.height>0?this.baseImage.height:32,this.canvas.width=this.baseImage.width>0?this.baseImage.width:32,this.context=this.canvas.getContext("2d"),this.ready()},this.baseImage.setAttribute("src",t.getAttribute("href"))):(this.canvas.height=this.baseImage.height=32,this.canvas.width=this.baseImage.width=32,this.context=this.canvas.getContext("2d"),this.ready())}reset(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height)}options(e,t){const n={n:"number"==typeof e?Math.abs(e):e,len:(""+e).length,x:.4,y:.4,w:.6,h:.6};return t.isUp&&(n.y<.6?n.y=n.y-.4:n.y=n.y-2*n.y+(1-n.w)),t.isLeft&&(n.x<.6?n.x=n.x-.4:n.x=n.x-2*n.x+(1-n.h)),n.x=this.canvas.width*n.x,n.y=this.canvas.height*n.y,n.w=this.canvas.width*n.w,n.h=this.canvas.height*n.h,n}circle(e,t){const n=r(r({},this.params),t),i=this.options(e,n);let s=!1;2===i.len?(i.x=i.x-.4*i.w,i.w=1.4*i.w,s=!0):i.len>=3&&(i.x=i.x-.65*i.w,i.w=1.65*i.w,s=!0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height),this.context.beginPath();const o=Math.floor(i.h*(i.n>99?.85:1))+"px";if(this.context.font=`${n.fontWeight} ${o} ${n.fontFamily}`,this.context.textAlign="center",s?(this.context.moveTo(i.x+i.w/2,i.y),this.context.lineTo(i.x+i.w-i.h/2,i.y),this.context.quadraticCurveTo(i.x+i.w,i.y,i.x+i.w,i.y+i.h/2),this.context.lineTo(i.x+i.w,i.y+i.h-i.h/2),this.context.quadraticCurveTo(i.x+i.w,i.y+i.h,i.x+i.w-i.h/2,i.y+i.h),this.context.lineTo(i.x+i.h/2,i.y+i.h),this.context.quadraticCurveTo(i.x,i.y+i.h,i.x,i.y+i.h-i.h/2),this.context.lineTo(i.x,i.y+i.h/2),this.context.quadraticCurveTo(i.x,i.y,i.x+i.h/2,i.y)):this.context.arc(i.x+i.w/2,i.y+i.h/2,i.h/2,0,2*Math.PI),this.context.fillStyle=n.bgColor,this.context.fill(),this.context.closePath(),this.context.beginPath(),this.context.stroke(),this.context.fillStyle=n.textColor,"number"==typeof i.n&&i.n>999){const e=(i.n>9999?9:Math.floor(i.n/1e3))+"k+";this.context.fillText(e,Math.floor(i.x+i.w/2),Math.floor(i.y+i.h-.2*i.h))}else this.context.fillText(""+i.n,Math.floor(i.x+i.w/2),Math.floor(i.y+i.h-.15*i.h));this.context.closePath()}ready(){this.isReady||(this.isReady=!0,this.readyCb())}setIcon(t){e(()=>{this.setIconSrc(t.toDataURL("image/png"))})}setIconSrc(e){if(this.browser.ff||this.browser.opera){const t=this.icons[this.icons.length-1],n=window.document.createElement("link");this.icons=[n],n.setAttribute("rel","icon"),n.setAttribute("type","image/png"),window.document.getElementsByTagName("head")[0].appendChild(n),n.setAttribute("href",e),t.parentNode&&t.parentNode.removeChild(t)}else this.icons.forEach(t=>{t.setAttribute("href",e)})}badge(e,t){this.isReady?("string"==typeof e||e>0?this.circle(e,t):this.reset(),this.setIcon(this.canvas)):this.readyCb=()=>{this.badge(e,t)}}static getLinks(){const e=[],t=window.document.getElementsByTagName("head")[0].getElementsByTagName("link");for(let n=0;n<t.length;n++)/(^|\s)icon(\s|$)/i.test(t[n].getAttribute("rel"))&&e.push(t[n]);return e}static getIcons(){let e=c.getLinks();return 0===e.length&&(e=[window.document.createElement("link")],e[0].setAttribute("rel","icon"),window.document.getElementsByTagName("head")[0].appendChild(e[0])),e.forEach(e=>{e.setAttribute("type","image/png")}),e}}}).call(this,n(179).setImmediate)},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return k})),n.d(t,"a",(function(){return T}));var i=n(88),s=n.n(i),o=n(7),r=n(8),a=n(0),c=n(135),l=n(121),d=n(166),u=n(386),h=n(217),m=n(292);var p=n(405),g=n(149);const f={[m.b.Recent]:new p.a,[m.b.Alphabetic]:new class{sortRooms(e,t){return e.sort((e,t)=>Object(g.a)(e.name,t.name))}},[m.b.Manual]:new class{sortRooms(e,t){const n=e=>e.tags[t].order||0;return e.sort((e,t)=>n(e)-n(t))}}};function v(e,t,n){return function(e){if(!f[e])throw new Error(e+" is not a known algorithm");return f[e]}(n).sortRooms(e,t)}class b{constructor(e,t){this.tagId=e,s()(this,"cachedOrderedRooms",void 0),s()(this,"sortingAlgorithm",void 0),this.setSortAlgorithm(t)}get orderedRooms(){return this.cachedOrderedRooms||[]}setSortAlgorithm(e){if(!e)throw new Error("A sorting algorithm must be defined");this.sortingAlgorithm=e,this.setRooms(this.orderedRooms)}getRoomIndex(e){let t=this.cachedOrderedRooms.indexOf(e);return-1===t&&(a.a.warn(`Degrading performance to find missing room in "${this.tagId}": ${e.roomId}`),t=this.cachedOrderedRooms.findIndex(t=>t.roomId===e.roomId)),t}}var y=n(168),S=n(172);const E=[y.a.Unsent,y.a.Red,y.a.Grey,y.a.Bold,y.a.None];class w extends b{constructor(e,t){super(e,t),s()(this,"indices",{})}categorizeRooms(e){const t={[y.a.Unsent]:[],[y.a.Red]:[],[y.a.Grey]:[],[y.a.Bold]:[],[y.a.None]:[]};for(const n of e){t[this.getRoomCategory(n)].push(n)}return t}getRoomCategory(e){return S.a.instance.getRoomState(e).color}setRooms(e){if(this.sortingAlgorithm===m.b.Manual)this.cachedOrderedRooms=v(e,this.tagId,this.sortingAlgorithm);else{const t=this.categorizeRooms(e);for(const e of Object.keys(t)){const n=t[e];t[e]=v(n,this.tagId,this.sortingAlgorithm)}const n=[],i={};for(const e of E)i[e]=n.length,n.push(...t[e]);this.indices=i,this.cachedOrderedRooms=n}}handleSplice(e,t){if(t===d.c.NewRoom){const t=this.getRoomCategory(e);this.alterCategoryPositionBy(t,1,this.indices),this.cachedOrderedRooms.splice(this.indices[t],0,e),this.sortCategory(t)}else{if(t!==d.c.RoomRemoved)throw new Error("Unhandled splice: "+t);{const t=this.getRoomIndex(e);if(-1===t)return a.a.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`),!1;const n=this.getCategoryFromIndices(t,this.indices);this.alterCategoryPositionBy(n,-1,this.indices),this.cachedOrderedRooms.splice(t,1)}}return!0}handleRoomUpdate(e,t){if(t===d.c.NewRoom||t===d.c.RoomRemoved)return this.handleSplice(e,t);if(t!==d.c.Timeline&&t!==d.c.ReadReceipt)throw new Error("Unsupported update cause: "+t);const n=this.getRoomCategory(e);if(this.sortingAlgorithm===m.b.Manual)return;const i=this.getRoomIndex(e);if(-1===i)throw new Error(`Room ${e.roomId} has no index in ${this.tagId}`);const s=this.getCategoryFromIndices(i,this.indices);return s!==n&&(this.moveRoomIndexes(1,s,n,this.indices),this.cachedOrderedRooms.splice(i,1),this.cachedOrderedRooms.splice(this.indices[n],0,e)),this.sortCategory(n),!0}sortCategory(e){const t=e===E[E.length-1]?Number.MAX_SAFE_INTEGER:this.indices[E[E.indexOf(e)+1]],n=this.indices[e],i=t-n,s=v(this.cachedOrderedRooms.splice(n,i),this.tagId,this.sortingAlgorithm);this.cachedOrderedRooms.splice(n,0,...s)}getCategoryFromIndices(e,t){for(let n=0;n<E.length;n++){const i=E[n],s=n===E.length-1,o=t[i],r=s?Number.MAX_SAFE_INTEGER:t[E[n+1]];if(e>=o&&e<r)return i}throw new Error("Programming error: somehow you've ended up with an index that isn't in a category")}moveRoomIndexes(e,t,n,i){this.alterCategoryPositionBy(t,-e,i),this.alterCategoryPositionBy(n,+e,i)}alterCategoryPositionBy(e,t,n){const i=E.indexOf(e)+1;if(t>0)for(let e=i;e<E.length;e++){n[E[e]]+=Math.abs(t)}else if(t<0)for(let e=i;e<E.length;e++){n[E[e]]-=Math.abs(t)}for(let e=1;e<=E.length;e++){const t=E[e-1],i=E[e];n[t]>n[i]&&a.a.warn(`!! Room list index corruption: ${t} (i:${n[t]}) is greater than ${i} (i:${n[i]}) - category indices are likely desynced from reality`)}}}class _ extends b{constructor(e,t){super(e,t)}setRooms(e){this.cachedOrderedRooms=v(e,this.tagId,this.sortingAlgorithm)}handleRoomUpdate(e,t){const n=t===d.c.NewRoom||t===d.c.RoomRemoved,i=t===d.c.Timeline||t===d.c.ReadReceipt;if(!n&&!i)throw new Error("Unsupported update cause: "+t);if(t===d.c.NewRoom)this.cachedOrderedRooms.push(e);else if(t===d.c.RoomRemoved){const t=this.getRoomIndex(e);t>=0?this.cachedOrderedRooms.splice(t,1):a.a.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`)}return this.cachedOrderedRooms=v(this.cachedOrderedRooms,this.tagId,this.sortingAlgorithm),!0}}const C={[m.a.Natural]:(e,t)=>new _(e,t),[m.a.Importance]:(e,t)=>new w(e,t)};function O(e,t,n){if(!C[e])throw new Error(e+" is not a known algorithm");return C[e](t,n)}var R=n(580),I=n(298);const k="list_updated_event",x=[d.c.Timeline,d.c.ReadReceipt];class T extends r.EventEmitter{constructor(){super(...arguments),s()(this,"_cachedRooms",{}),s()(this,"_cachedStickyRooms",{}),s()(this,"filteredRooms",{}),s()(this,"_stickyRoom",null),s()(this,"_lastStickyRoom",null),s()(this,"sortAlgorithms",void 0),s()(this,"listAlgorithms",void 0),s()(this,"algorithms",void 0),s()(this,"rooms",[]),s()(this,"roomIdsToTags",{}),s()(this,"allowedByFilter",new Map),s()(this,"allowedRoomsByFilters",new Set),s()(this,"updatesInhibited",!1),s()(this,"updateVideoRoom",()=>{this.recalculateFilteredRooms(),this.recalculateStickyRoom(),this.recalculateVideoRoom(),this.updatesInhibited||this.emit(k,!0)})}start(){I.b.instance.on(I.a.Connect,this.updateVideoRoom),I.b.instance.on(I.a.Disconnect,this.updateVideoRoom)}stop(){I.b.instance.off(I.a.Connect,this.updateVideoRoom),I.b.instance.off(I.a.Disconnect,this.updateVideoRoom)}get stickyRoom(){return this._stickyRoom?this._stickyRoom.room:null}get knownRooms(){return this.rooms}get hasTagSortingMap(){return!!this.sortAlgorithms}get hasFilters(){return this.allowedByFilter.size>0}set cachedRooms(e){this._cachedRooms=e,this.recalculateFilteredRooms(),this.recalculateStickyRoom(),this.recalculateVideoRoom()}get cachedRooms(){return this._cachedRooms}setStickyRoom(e){try{this.updateStickyRoom(e)}catch(e){a.a.warn("Failed to update sticky room",e)}}getTagSorting(e){return this.sortAlgorithms?this.sortAlgorithms[e]:null}setTagSorting(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.sortAlgorithms[e]=t;const n=this.algorithms[e];n.setSortAlgorithm(t),this._cachedRooms[e]=n.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e),this.recalculateVideoRoom(e)}getListOrdering(e){return this.listAlgorithms?this.listAlgorithms[e]:null}setListOrdering(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.listAlgorithms[e]=t;const n=O(t,e,this.sortAlgorithms[e]);this.algorithms[e]=n,n.setRooms(this._cachedRooms[e]),this._cachedRooms[e]=n.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e),this.recalculateVideoRoom(e)}addFilterCondition(e){this.allowedByFilter.set(e,this.rooms.filter(t=>e.isVisible(t))),this.recalculateFilteredRooms(),e.on(u.a,this.handleFilterChange.bind(this))}removeFilterCondition(e){e.off(u.a,this.handleFilterChange.bind(this)),this.allowedByFilter.has(e)&&(this.allowedByFilter.delete(e),this.recalculateFilteredRooms(),this.hasFilters||this.updatesInhibited||this.emit(k))}handleFilterChange(){this.recalculateFilteredRooms(),this.updatesInhibited||this.emit(u.a)}updateStickyRoom(e){this.doUpdateStickyRoom(e),this._lastStickyRoom=null}doUpdateStickyRoom(e){var t,n;if(null!==(t=e)&&void 0!==t&&t.isSpaceRoom()&&"invite"!==e.getMyMembership()&&(e=null),e&&!R.a.instance.isRoomVisible(e)&&(e=null),this._lastStickyRoom=this._stickyRoom||{},!e){if(this._stickyRoom){const e=this._stickyRoom.room;return this._stickyRoom=null,void this.handleRoomUpdate(e,d.c.NewRoom)}return}let i=null===(n=this.roomIdsToTags[e.roomId])||void 0===n?void 0:n[0];if(!i)throw new Error(e.roomId+" does not belong to a tag and cannot be sticky");let s=(this.getOrderedRoomsWithoutSticky()[i]||[]).indexOf(e);const o=!!this._lastStickyRoom.room&&this._lastStickyRoom.room.roomId===e.roomId;if(this._lastStickyRoom.tag&&i!==this._lastStickyRoom.tag&&o&&s<0&&(a.a.warn(`Sticky room ${e.roomId} changed tags during sticky room handling`),s=0),s<0)throw new Error(e.roomId+" does not appear to be known and cannot be sticky");const r=this._stickyRoom;if(this._stickyRoom=null,this.recalculateStickyRoom(),r&&r.room&&r.room.roomId!==e.roomId&&this.handleRoomUpdate(r.room,d.c.NewRoom),this.handleRoomUpdate(e,d.c.RoomRemoved),this._stickyRoom){if(this._stickyRoom.room!==e){if(this._stickyRoom.room.roomId!==e.roomId)throw new Error("Sticky room changed while the sticky room was changing");a.a.warn("Sticky room changed references")}a.a.warn(`Sticky room changed tag & position from ${i} / ${s} to ${this._stickyRoom.tag} / ${this._stickyRoom.position}`),i=this._stickyRoom.tag,s=this._stickyRoom.position}r&&r.tag===i&&r.position<=s&&s++,this._stickyRoom={room:e,position:s,tag:i},this.recalculateFilteredRoomsForTag(i),r&&r.tag!==i&&this.recalculateFilteredRoomsForTag(r.tag),this.recalculateStickyRoom(),this.recalculateVideoRoom(i),r&&r.tag!==i&&this.recalculateVideoRoom(r.tag),this.updatesInhibited||this.emit(k)}recalculateFilteredRooms(){if(!this.hasFilters)return;a.a.warn("Recalculating filtered room list");const e=Array.from(this.allowedByFilter.keys()),t={};for(const n of Object.keys(this.cachedRooms)){const i=this.cachedRooms[n].map(e=>e);this.tryInsertStickyRoomToFilterSet(i,n);const s=i.map(e=>e),o=[];for(const t of e){const e=s.filter(e=>t.isVisible(e));for(const t of e){const e=s.indexOf(t);e>=0&&s.splice(e,1),o.push(t)}}t[n]=o}const n=Object.values(t).reduce((e,t)=>(e.push(...t),e),[]);this.allowedRoomsByFilters=new Set(n),this.filteredRooms=t,this.updatesInhibited||this.emit(k)}recalculateFilteredRoomsForTag(e){if(!this.hasFilters)return;delete this.filteredRooms[e];const t=this.cachedRooms[e].map(e=>e);this.tryInsertStickyRoomToFilterSet(t,e);const n=t.filter(e=>this.allowedRoomsByFilters.has(e));n.length>0&&(this.filteredRooms[e]=n)}tryInsertStickyRoomToFilterSet(e,t){if(!this._stickyRoom||!this._stickyRoom.room||this._stickyRoom.tag!==t)return;const n=this._stickyRoom.position;n>=e.length?e.push(this._stickyRoom.room):e.splice(n,0,this._stickyRoom.room)}initCachedStickyRooms(){this._cachedStickyRooms={};for(const e of Object.keys(this.cachedRooms))this._cachedStickyRooms[e]=[...this.cachedRooms[e]]}recalculateStickyRoom(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this._stickyRoom){if(this._cachedStickyRooms){if(this._cachedStickyRooms=null,this.updatesInhibited)return;this.emit(k)}return}this._cachedStickyRooms&&e||this.initCachedStickyRooms(),e&&(this._cachedStickyRooms[e]=[...this.cachedRooms[e]]);const t=this._stickyRoom;e&&e!==t.tag||this._cachedStickyRooms[t.tag].splice(t.position,0,t.room),this.updatesInhibited||this.emit(k)}recalculateVideoRoom(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!e){for(const e of Object.keys(this.cachedRooms)){if(!e)throw new Error("Unexpected recursion: falsy tag");this.recalculateVideoRoom(e)}return}const t=I.b.instance.connected?I.b.instance.roomId:null;if(t){this._cachedStickyRooms||this.initCachedStickyRooms();const n=this._cachedStickyRooms[e],i=n.findIndex(e=>e.roomId===t);if(i<0)return;const s=n[i];n.splice(i,1),n.unshift(s),this._cachedStickyRooms[e]=n}}populateTags(e,t){if(!e)throw new Error("Sorting map cannot be null or empty");if(!t)throw new Error("Ordering ma cannot be null or empty");if(Object(l.d)(Object.keys(e),Object.keys(t)))throw new Error("Both maps must contain the exact same tags");this.sortAlgorithms=e,this.listAlgorithms=t,this.algorithms={};for(const t of Object.keys(e))this.algorithms[t]=O(this.listAlgorithms[t],t,this.sortAlgorithms[t]);return this.setKnownRooms(this.rooms)}getOrderedRooms(){return this.hasFilters?this.filteredRooms:this._cachedStickyRooms||this.cachedRooms}getUnfilteredRooms(){return this._cachedStickyRooms||this.cachedRooms}getOrderedRoomsWithoutSticky(){return this.hasFilters?this.filteredRooms:this.cachedRooms}setKnownRooms(e){if(Object(o.t)(e))throw new Error("Array of rooms cannot be null");if(!this.sortAlgorithms)throw new Error("Cannot set known rooms without a tag sorting map");this.updatesInhibited||a.a.warn("Resetting known rooms, initiating regeneration");const t=this._stickyRoom;t&&this.updateStickyRoom(null),this.rooms=e;const n={};for(const e in this.sortAlgorithms)n[e]=[];if(!e.length)return this.generateFreshTags(n),void(this.cachedRooms=n);const i=Object(h.d)(e);for(const e of i[h.a.Invite])n[d.a.Invite].push(e);for(const e of i[h.a.Leave])n[d.a.Archived].push(e);for(const e of i[h.a.Join]){const t=this.getTagsOfJoinedRoom(e);let i=!1;if(t.length>0)for(const s of t)Object(o.t)(n[s])||(n[s].push(e),i=!0);i||(c.a.shared().getUserIdForRoomId(e.roomId)?n[d.a.DM].push(e):n[d.a.Untagged].push(e))}this.generateFreshTags(n),this.cachedRooms=n,this.updateTagsFromCache(),t&&t.room&&(this.updateStickyRoom(t.room),this._stickyRoom&&this._stickyRoom.room&&this._stickyRoom.tag!==t.tag&&(this._stickyRoom.position=0,this.recalculateStickyRoom(this._stickyRoom.tag)))}getTagsForRoom(e){const t=[],n=Object(h.b)(e.getMyMembership());return n===h.a.Invite?t.push(d.a.Invite):n===h.a.Leave?t.push(d.a.Archived):t.push(...this.getTagsOfJoinedRoom(e)),t.length||t.push(d.a.Untagged),t}getTagsOfJoinedRoom(e){let t=Object.keys(e.tags||{});return 0===t.length&&c.a.shared().getUserIdForRoomId(e.roomId)&&(t=[d.a.DM]),t}updateTagsFromCache(){const e={},t=Object.keys(this.cachedRooms);for(const n of t){const t=this.cachedRooms[n];for(const i of t)e[i.roomId]||(e[i.roomId]=[]),e[i.roomId].push(n)}this.roomIdsToTags=e}generateFreshTags(e){if(!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");for(const t of Object.keys(e)){const n=this.algorithms[t];if(!n)throw new Error("No algorithm for "+t);n.setRooms(e[t]),e[t]=n.orderedRooms}}handleRoomUpdate(e,t){var n,i;if(!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");const s=(null===(n=this._stickyRoom)||void 0===n||null===(i=n.room)||void 0===i?void 0:i.roomId)===e.roomId;if(t===d.c.NewRoom){var r;const n=(null===(r=this._lastStickyRoom)||void 0===r?void 0:r.room)===e,i=this.roomIdsToTags[e.roomId],o=i&&i.length>0;o&&!n&&(a.a.warn(e.roomId+" is reportedly new but is already known - assuming TagChange instead"),t=d.c.PossibleTagChange);let c=this.rooms.includes(e);if(o&&!c&&(a.a.warn(e.roomId+" might be a reference change - attempting to update reference"),this.rooms=this.rooms.map(t=>t.roomId===e.roomId?e:t),c=this.rooms.includes(e),c||a.a.warn(e.roomId+" is still not referenced. It may be sticky.")),o&&!c&&!s)throw new Error(e.roomId+" is missing from room array but is known - trying to find duplicate");o&&s&&(this._stickyRoom.room=e),t!==d.c.NewRoom||s||c||this.rooms.push(e)}let c=!1;if(t===d.c.PossibleTagChange){const n=this.roomIdsToTags[e.roomId]||[],i=this.getTagsForRoom(e),o=Object(l.a)(n,i);if(!(o.removed.length>0||o.added.length>0))return!1;for(const t of o.removed){const n=this.algorithms[t];if(!n)throw new Error("No algorithm for "+t);n.handleRoomUpdate(e,d.c.RoomRemoved),this._cachedRooms[t]=n.orderedRooms,this.recalculateFilteredRoomsForTag(t),this.recalculateStickyRoom(t),this.recalculateVideoRoom(t)}for(const t of o.added){const n=this.algorithms[t];if(!n)throw new Error("No algorithm for "+t);n.handleRoomUpdate(e,d.c.NewRoom),this._cachedRooms[t]=n.orderedRooms}this.roomIdsToTags[e.roomId]=i,t=d.c.Timeline,c=!0,c&&s&&(this._lastStickyRoom?this._stickyRoom={room:e,tag:this.roomIdsToTags[e.roomId][0],position:0}:this.setStickyRoom(e))}if(t!==d.c.NewRoom&&t!==d.c.RoomRemoved&&this.stickyRoom===e)return!1;if(!this.roomIdsToTags[e.roomId]){if(x.includes(t))return!1;const n=this.getTagsForRoom(e).filter(e=>!Object(o.t)(this.cachedRooms[e]));if(!n.length)throw new Error("Tags cannot be determined for "+e.roomId);this.roomIdsToTags[e.roomId]=n}const u=this.roomIdsToTags[e.roomId];if(!u)return a.a.warn(`No tags known for "${e.name}" (${e.roomId})`),!1;let h=c;for(const n of u){const i=this.algorithms[n];if(!i)throw new Error("No algorithm for "+n);i.handleRoomUpdate(e,t),this._cachedRooms[n]=i.orderedRooms,this.recalculateFilteredRoomsForTag(n),this.recalculateStickyRoom(n),this.recalculateVideoRoom(n),h=!0}return h}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return $}));var i=n(88),s=n.n(i),o=n(87),r=n.n(o),a=n(97),c=n(7),l=n(0),d=n(90),u=n(89),h=n(133),m=n(93),p=n(101),g=n(401),f=n(102),v=n(108),b=n(94),y=n.n(b),S=n(158),E=n(1263),w=n(1264);const _=function(){let e=null;return function(t){return e||(e=document.createElement("textarea")),e.innerHTML=t,e.value}}();function C(e){const t={stripReplyFallback:!0,returnString:!0};return"org.matrix.custom.html"===e.format?Object(S.b)(e,null,t):function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(Object(S.b)(e,null,t))}function O(e){const t=document.createElement(Object(S.c)(e)?"div":"span");return t.className="mx_EditHistoryMessage_insertion",t.appendChild(e),t}function R(e){const t=document.createElement(Object(S.c)(e)?"div":"span");return t.className="mx_EditHistoryMessage_deletion",t.appendChild(e),t}function I(e){if("#text"===e.nodeName)return j(e.data);{const t=document.createElement(e.nodeName);if(e.attributes)for(const[n,i]of Object.entries(e.attributes))t.setAttribute(n,i);if(e.childNodes)for(const n of e.childNodes)t.appendChild(I(n));return t}}function k(e,t,n){t?e.insertBefore(n,t):e.appendChild(n)}function x(e,t){for(let n=0;n<e.length-1;++n)if(e[n]!==t[n])return!1;const n=e.length-1;return t[n]>=e[n]}function T(e,t){if("removeTextElement"===e.action||"removeElement"===e.action){const n=1;for(const i of t)x(e.route,i.route)&&(i.route[e.route.length-1]+=n)}}function j(e){return document.createTextNode(_(e))}function N(e,t,n){const{refNode:i,refParentNode:s}=function(e,t){let n,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=e;const o=i?t.length-1:t.length;for(let e=0;e<o;++e)n=s,s=s.childNodes[t[e]];return{refNode:s,refParentNode:n}}(e,t.route);switch(t.action){case"replaceElement":{const e=document.createElement("span"),n=R(I(t.oldValue)),s=O(I(t.newValue));e.appendChild(n),e.appendChild(s),i.parentNode.replaceChild(e,i);break}case"removeTextElement":{const e=R(j(t.value));i.parentNode.replaceChild(e,i);break}case"removeElement":{const e=R(I(t.element));i.parentNode.replaceChild(e,i);break}case"modifyTextElement":{const e=n.diff_main(t.oldValue,t.newValue);n.diff_cleanupSemantic(e);const s=document.createElement("span");for(const[t,n]of e){let e=j(n);t<0?e=R(e):t>0&&(e=O(e)),s.appendChild(e)}i.parentNode.replaceChild(s,i);break}case"addElement":k(s,i,O(I(t.element)));break;case"addTextElement":k(s,i,O(j("\n"!==t.value?t.value:"")));break;case"removeAttribute":case"addAttribute":case"modifyAttribute":{const e=R(i.cloneNode(!0)),n=i.cloneNode(!0);"addAttribute"===t.action||"modifyAttribute"===t.action?n.setAttribute(t.name,t.newValue):n.removeAttribute(t.name);const s=O(n),o=document.createElement(Object(S.c)(i)?"div":"span");o.appendChild(e),o.appendChild(s),i.parentNode.replaceChild(o,i);break}default:l.a.warn("MessageDiffUtils::editBodyDiffToHtml: diff action not supported atm",t)}}function P(e,t){return e.length===t.length&&!e.some((e,n)=>e!==t[n])}function D(e,t){const n=`<div>${C(e)}</div>`,i=`<div>${C(t)}</div>`,s=function(e){const t=e.slice();for(let e=0;e<t.length;++e){const n=t[e];if("removeTextElement"===n.action){const i=t[e+1];i&&"addTextElement"===i.action&&i.text===n.text&&P(i.route,n.route)&&t.splice(e,2)}}return t}((new w.DiffDOM).diff(n,i)),o=new E.diff_match_patch,a=(new DOMParser).parseFromString(n,"text/html").body.children[0];for(let e=0;e<s.length;++e){const t=s[e];N(a,t,o),T(t,s.slice(e+1))}const c=a.innerHTML,l=y()({mx_EventTile_body:!0,"markdown-body":!0});return r.a.createElement("span",{key:"body",className:l,dangerouslySetInnerHTML:{__html:c},dir:"auto"})}var A=n(698),M=n(95),U=n(460),L=n(91),F=n(497),B=n(107);class K extends r.a.PureComponent{constructor(e){super(e),s()(this,"onParentFinished",async e=>{if(e){this.setState({isRedacting:!0});try{await this.props.redact(),this.props.onFinished(!0)}catch(e){const t=e.errcode||e.statusCode;void 0!==t?this.setState({redactionErrorCode:t}):this.props.onFinished(!0)}}else this.props.onFinished(!1)}),this.state={isRedacting:!1,redactionErrorCode:null}}render(){if(this.state.isRedacting){if(this.state.redactionErrorCode){const e=this.state.redactionErrorCode;return r.a.createElement(B.a,{onFinished:this.props.onFinished,title:Object(u.a)("Error"),description:Object(u.a)("You cannot delete this message. (%(code)s)",{code:e})})}return r.a.createElement(p.a,{onFinished:this.props.onFinished,hasCancel:!1,title:Object(u.a)("Removing…")},r.a.createElement(f.a,null))}return r.a.createElement(F.b,{onFinished:this.onParentFinished})}}var V=n(492);function W(e){const t=e.getOriginalContent();return t["m.new_content"]||t}class H extends r.a.PureComponent{constructor(e){super(e),s()(this,"content",Object(o.createRef)()),s()(this,"pills",[]),s()(this,"onAssociatedStatusChanged",()=>{this.setState({sendStatus:this.props.mxEvent.getAssociatedStatus()})}),s()(this,"onRedactClick",async()=>{const e=this.props.mxEvent,t=d.a.get();M.a.createTrackedDialog("Confirm Redact Dialog","Edit history",K,{redact:()=>t.redactEvent(e.getRoomId(),e.getId())},"mx_Dialog_confirmredact")}),s()(this,"onViewSourceClick",()=>{M.a.createTrackedDialog("View Event Source","Edit history",V.a,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")});const t=d.a.get(),{userId:n}=t.credentials,i=this.props.mxEvent,r=t.getRoom(i.getRoomId());i.localRedactionEvent()&&i.localRedactionEvent().on(v.c.Status,this.onAssociatedStatusChanged);const a=r.currentState.maySendRedactionForEvent(i,n);this.state={canRedact:a,sendStatus:i.getAssociatedStatus()}}pillifyLinks(){this.content.current&&Object(A.a)(this.content.current.children,this.props.mxEvent,this.pills)}componentDidMount(){this.pillifyLinks()}componentWillUnmount(){Object(A.b)(this.pills);const e=this.props.mxEvent;e.localRedactionEvent()&&e.localRedactionEvent().off(v.c.Status,this.onAssociatedStatusChanged)}componentDidUpdate(){this.pillifyLinks()}renderActionBar(){let e,t;return this.props.mxEvent.isRedacted()||this.props.isBaseEvent||!this.state.canRedact||(e=r.a.createElement(L.a,{onClick:this.onRedactClick},Object(u.a)("Remove"))),m.b.getValue("developerMode")&&(t=r.a.createElement(L.a,{onClick:this.onViewSourceClick},Object(u.a)("View Source"))),r.a.createElement("div",{className:"mx_MessageActionBar"},e,t)}render(){const{mxEvent:e}=this.props,t=W(e);let n;if(e.isRedacted())n=r.a.createElement(U.a,{mxEvent:this.props.mxEvent});else{let i;if(i=this.props.previousEdit?D(W(this.props.previousEdit),t):S.b(t,null,{stripReplyFallback:!0,returnString:!1}),"m.emote"===e.getContent().msgtype){const t=e.sender?e.sender.name:e.getSender();n=r.a.createElement("div",{className:"mx_EventTile_content",ref:this.content},"* ",r.a.createElement("span",{className:"mx_MEmoteBody_sender"},t)," ",i)}else n=r.a.createElement("div",{className:"mx_EventTile_content",ref:this.content},i)}const i=Object(h.k)(new Date(e.getTs()),this.props.isTwelveHour),s=-1!==["sending","queued","encrypting"].indexOf(this.state.sendStatus),o=y()({mx_EventTile:!0,mx_EventTile_sending:s});return r.a.createElement("li",null,r.a.createElement("div",{className:o},r.a.createElement("div",{className:"mx_EventTile_line"},r.a.createElement("span",{className:"mx_MessageTimestamp"},i),n,this.renderActionBar())))}}var q=n(431);class $ extends r.a.PureComponent{constructor(e){super(e),s()(this,"loadMoreEdits",async e=>{if(e||!this.state.nextBatch&&!this.state.isLoading)return!1;const t={from:this.state.nextBatch},n=this.props.mxEvent.getRoomId(),i=this.props.mxEvent.getId(),s=d.a.get(),{resolve:o,reject:r,promise:u}=Object(c.l)();let h;try{h=await s.relations(n,i,a.d.Replace,a.b.RoomMessage,t)}catch(e){return e.errcode&&l.a.error("fetching /relations failed with error",e),this.setState({error:e},()=>r(e)),u}const m=h.events;return this.locallyRedactEventsIfNeeded(m),this.setState({originalEvent:this.state.originalEvent||h.originalEvent,events:this.state.events.concat(m),nextBatch:h.nextBatch,isLoading:!1},()=>{const e=!!this.state.nextBatch;o(e)}),u}),this.state={originalEvent:null,error:null,events:[],nextBatch:null,isLoading:!0,isTwelveHour:m.b.getValue("showTwelveHourTimestamps")}}locallyRedactEventsIfNeeded(e){const t=this.props.mxEvent.getRoomId(),n=d.a.get().getRoom(t).getPendingEvents();for(const t of e){const e=n.find(e=>e.getType()===a.b.RoomRedaction&&e.getAssociatedId()===t.getId());e&&t.markLocallyRedacted(e)}}componentDidMount(){this.loadMoreEdits()}renderEdits(){const e=[];let t,n=this.state.events;this.state.originalEvent&&!this.state.nextBatch&&(n=n.concat(this.state.originalEvent));const i=this.props.mxEvent.getId();return n.forEach((s,o)=>{t&&!Object(h.l)(t.getDate(),s.getDate())||e.push(r.a.createElement("li",{key:s.getTs()+"~"},r.a.createElement(q.a,{roomId:s.getRoomId(),ts:s.getTs()})));const a=s.getId()===i;e.push(r.a.createElement(H,{key:s.getId(),previousEdit:a?null:n[o+1],isBaseEvent:a,mxEvent:s,isTwelveHour:this.state.isTwelveHour})),t=s}),e}render(){let e;if(this.state.error){const{error:t}=this.state;e="M_UNRECOGNIZED"===t.errcode?r.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(u.a)("Your homeserver doesn't seem to support this feature.")):t.errcode?r.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(u.a)("Something went wrong!")):r.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(u.a)("Cannot reach homeserver"),r.a.createElement("br",null),Object(u.a)("Ensure you have a stable internet connection, or get in touch with the server admin"))}else e=this.state.isLoading?r.a.createElement(f.a,null):r.a.createElement(g.a,{className:"mx_MessageEditHistoryDialog_scrollPanel",onFillRequest:this.loadMoreEdits,stickyBottom:!1,startAtBottom:!1},r.a.createElement("ul",{className:"mx_MessageEditHistoryDialog_edits"},this.renderEdits()));return r.a.createElement(p.a,{className:"mx_MessageEditHistoryDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(u.a)("Message edits")},e)}}},,function(e,t,n){"use strict";var i=n(87),s=n.n(i),o=n(0),r=n(344),a=n(88),c=n.n(a),l=n(472),d=n(158),u=n(93),h=n(95);var m=n(128),p=n(359);class g extends s.a.Component{constructor(){super(...arguments),c()(this,"description",Object(i.createRef)()),c()(this,"image",Object(i.createRef)()),c()(this,"onImageClick",e=>{const t=this.props.preview;if(0!=e.button||e.metaKey)return;e.preventDefault();let n=t["og:image"];n&&n.startsWith("mxc://")&&(n=Object(m.b)(n).srcHttp);const i={src:n,width:t["og:image:width"],height:t["og:image:height"],name:t["og:title"]||t["og:description"]||this.props.link,fileSize:t["matrix:image:size"],link:this.props.link};if(this.image.current){const e=this.image.current.getBoundingClientRect();i.thumbnailInfo={width:e.width,height:e.height,positionX:e.x,positionY:e.y}}h.a.createDialog(p.a,i,"mx_Dialog_lightbox",null,!0)})}componentDidMount(){this.description.current&&Object(d.g)(this.description.current)}componentDidUpdate(){this.description.current&&Object(d.g)(this.description.current)}render(){const e=this.props.preview;if(!e||0===Object.keys(e).length)return s.a.createElement("div",null);let t=e["og:image"];u.b.getValue("showImages")||(t=null);t&&t.startsWith("mxc://")&&(t=Object(m.b)(t).getThumbnailOfSourceHttp(100,100,"scale"));let n,i=100;e["og:image:width"]&&e["og:image:height"]&&(i=function(e,t,n,i){if(!e||!t)return null;if(e<n&&t<i)return t;const s=n/e,o=i/t;return s<o?Math.floor(s*t):Math.floor(o*t)}(e["og:image:width"],e["og:image:height"],100,100)),t&&(n=s.a.createElement("div",{className:"mx_LinkPreviewWidget_image",style:{height:i}},s.a.createElement("img",{ref:this.image,style:{maxWidth:100,maxHeight:100},src:t,onClick:this.onImageClick})));const o=l.AllHtmlEntities.decode(e["og:description"]||"");return s.a.createElement("div",{className:"mx_LinkPreviewWidget"},n,s.a.createElement("div",{className:"mx_LinkPreviewWidget_caption"},s.a.createElement("div",{className:"mx_LinkPreviewWidget_title"},s.a.createElement("a",{href:this.props.link,target:"_blank",rel:"noreferrer noopener"},e["og:title"]),e["og:site_name"]&&s.a.createElement("span",{className:"mx_LinkPreviewWidget_siteName"}," - "+e["og:site_name"])),s.a.createElement("div",{className:"mx_LinkPreviewWidget_description",ref:this.description},o)),this.props.children)}}var f=n(91),v=n(89),b=n(100),y=n(266);const S=(e,t,n)=>Promise.all(t.map(async t=>{try{const i=await e.getUrlPreview(t,n);if(i&&Object.keys(i).length>0)return[t,i]}catch(e){o.a.error("Failed to get URL preview: "+e)}})).then(e=>e.filter(Boolean));t.a=e=>{let{links:t,mxEvent:o,onCancelClick:a,onHeightChanged:c}=e;const l=Object(i.useContext)(b.a),[d,u]=Object(r.a)(),h=o.getTs(),m=Object(y.a)(async()=>S(l,t,h),[t,h],[]);Object(i.useEffect)(()=>{c()},[c,d,m]);const p=d?m:m.slice(0,2);let E;return m.length>2&&(E=s.a.createElement(f.a,{onClick:u},d?Object(v.a)("Collapse"):Object(v.a)("Show %(count)s other previews",{count:m.length-p.length}))),s.a.createElement("div",{className:"mx_LinkPreviewGroup"},p.map((e,t)=>{let[i,r]=e;return s.a.createElement(g,{key:i,link:i,preview:r,mxEvent:o},0===t?s.a.createElement(f.a,{className:"mx_LinkPreviewGroup_hide",onClick:a,"aria-label":Object(v.a)("Close preview")},s.a.createElement("img",{className:"mx_filterFlipColor",alt:"",role:"presentation",src:n(1321).default,width:"18",height:"18"})):void 0)}),E)}},,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(17),s=n.n(i),o=n(144);class r{constructor(e){this.ourEvent=e,s()(this,"timeline",void 0),s()(this,"ourEventIndex",0),s()(this,"paginateTokens",{[o.a.Backward]:null,[o.a.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.paginateTokens[e?o.a.Backward:o.a.Forward]}setPaginateToken(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.paginateTokens[t?o.a.Backward:o.a.Forward]=e}addEvents(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class a{static fromJson(e,t){const n=e.context||{};let i=(n.events_before||[]).map(t),s=(n.events_after||[]).map(t);const o=new r(t(e.result)),c=o.ourEvent.threadRootId;return i=i.filter(e=>e.threadRootId===c),s=s.filter(e=>e.threadRootId===c),o.setPaginateToken(n.start,!0),o.addEvents(i,!0),o.addEvents(s,!1),o.setPaginateToken(n.end,!1),new a(e.rank,o)}constructor(e,t){this.rank=e,this.context=t}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return v})),n.d(t,"b",(function(){return y}));var i=n(17),s=n.n(i),o=n(20),r=n.n(o),a=n(97),c=n(0),l=n(7),d=n(144);function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class m{constructor(e,t,n){this.client=e,this.indexEvent=t,this.directory=n}get id(){const e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var e;return null!==(e=this.indexEvent.getContent().version)&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,a.j.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);const e=(await this.getVersionHistory())[1];e&&await e.delete()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}async setName(e){await this.client.sendStateEvent(this.roomId,a.j.name,h(h({},this.indexEvent.getContent()),{},{name:e}),this.id)}isLocked(){return this.indexEvent.getContent().locked||!1}async setLocked(e){await this.client.sendStateEvent(this.roomId,a.j.name,h(h({},this.indexEvent.getContent()),{},{locked:e}),this.id)}async getFileInfo(){const e=(await this.getFileEvent()).getOriginalContent().file,t=this.client.mxcUrlToHttp(e.url);if(!t)throw new Error("No HTTP URL available for "+e.url);return{info:e,httpUrl:t}}async getFileEvent(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");let t=e.getUnfilteredTimelineSet().findEventById(this.id);for(;!t&&e.getLiveTimeline().getState(d.b.BACKWARDS).paginationToken;)await this.client.scrollback(e,100),t=e.getUnfilteredTimelineSet().findEventById(this.id);if(!t)throw new Error("Failed to find event");return await this.client.decryptEventIfNeeded(t,{emit:!0,isRetry:!0}),t}async createNewVersion(e,t,n,i){const s=await this.directory.createFile(e,t,n,h(h({},null!=i?i:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:a.d.Replace,event_id:this.id}}));return await this.client.sendStateEvent(this.roomId,a.j.name,{active:!0,name:e,version:this.version+1},s.event_id),await this.client.sendStateEvent(this.roomId,a.j.name,h(h({},this.indexEvent.getContent()),{},{active:!1}),this.id),s}async getVersionHistory(){const e=[];e.push(this);const t=this.client.getRoom(this.roomId);if(!t)throw new Error("Invalid or unknown room");const n=[...t.getLiveTimeline().getEvents()].reverse();let i,s=await this.getFileEvent();do{if(i=n.find(e=>e.replacingEventId()===s.getId()),i){const t=this.directory.getFile(i.getId());if(!t)break;e.push(t),s=i}}while(i);return e}}var p=n(601);function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const v={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[a.b.RoomPowerLevels]:100,[a.b.RoomHistoryVisibility]:100,[a.b.RoomTombstone]:100,[a.b.RoomEncryption]:100,[a.b.RoomName]:50,[a.b.RoomMessage]:50,[a.b.RoomMessageEncrypted]:50,[a.b.Sticker]:50},users:{}};let b;!function(e){e.Viewer="viewer",e.Editor="editor",e.Owner="owner"}(b||(b={}));class y{constructor(e,t){if(this.client=e,this.roomId=t,s()(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(a.b.SpaceParent);return null==e||!e.length||e.every(e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t.via)})}async setName(e){await this.client.sendStateEvent(this.roomId,a.b.RoomName,{name:e},"")}async invite(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=[this.retryInvite(e)];return t&&i.push(...this.getDirectories().map(i=>i.invite(e,t,n))),Promise.all(i).then(()=>{n&&Object(p.a)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])})}retryInvite(e){return Object(l.F)(async()=>{await this.client.invite(this.roomId,e).catch(e=>{if("M_FORBIDDEN"===(null==e?void 0:e.errcode))throw new r.a.AbortError(e);throw e})})}async setPermissions(e,t){var n;const i=this.room.currentState.getStateEvents(a.b.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");const s=i.getContent()||{},o=s.users_default||0,r=s.events_default||50,c=(null===(n=s.events)||void 0===n?void 0:n[a.b.RoomPowerLevels])||100,l=s.users||{};switch(t){case b.Viewer:l[e]=o;break;case b.Editor:l[e]=r;break;case b.Owner:l[e]=c;break;default:throw new Error("Invalid role: "+t)}s.users=l,await this.client.sendStateEvent(this.roomId,a.b.RoomPowerLevels,s,"")}getPermissions(e){var t,n;const i=this.room.currentState.getStateEvents(a.b.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");const s=i.getContent()||{},o=s.users_default||0,r=s.events_default||50,c=(null===(t=s.events)||void 0===t?void 0:t[a.b.RoomPowerLevels])||100,l=(null===(n=s.users)||void 0===n?void 0:n[e])||o;return l>=c?b.Owner:l>=r?b.Editor:b.Viewer}async createDirectory(e){const t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,a.b.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,a.b.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(a.b.SpaceChild);for(const n of t)try{const t=n.getStateKey();if(t){const n=this.client.unstableGetFileTreeSpace(t);n&&e.push(n)}}catch(e){c.a.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}async delete(){const e=this.getDirectories();for(const t of e)await t.delete();const t=["invite","knock","join"],n=this.room.currentState.getStateEvents(a.b.RoomMember);for(const e of n){if(e.getStateKey()!==this.client.getUserId()&&t.includes(e.getContent().membership)){const t=e.getStateKey();if(!t)throw new Error("State key not found for branch");await this.client.kick(this.roomId,t,"Room deleted")}}await this.client.leave(this.roomId)}getOrderedChildren(e){const t=e.map(e=>({roomId:e.getStateKey(),order:e.getContent().order})).filter(e=>e.roomId);return t.sort((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return Object(l.v)(e.order,t.order);{var n,i,s,o;const r=this.client.getRoom(e.roomId),c=this.client.getRoom(t.roomId);if(!r||!c)return Object(l.v)(e.roomId,t.roomId);const d=null!==(n=null===(i=r.currentState.getStateEvents(a.b.RoomCreate,""))||void 0===i?void 0:i.getTs())&&void 0!==n?n:0,u=null!==(s=null===(o=c.currentState.getStateEvents(a.b.RoomCreate,""))||void 0===o?void 0:o.getTs())&&void 0!==s?s:0;return d===u?Object(l.v)(e.roomId,t.roomId):d-u}}),t}getParentRoom(){const e=this.room.currentState.getStateEvents(a.b.SpaceParent)[0];if(!e)throw new Error("Expected to have a parent in a non-top level space");const t=e.getStateKey();if(!t)throw new Error("No state key found for parent");const n=this.client.getRoom(t);if(!n)throw new Error("Unable to locate room for parent");return n}getOrder(){if(this.isTopLevel)return-1;const e=this.getParentRoom().currentState.getStateEvents(a.b.SpaceChild);return this.getOrderedChildren(e).findIndex(e=>e.roomId===this.roomId)}async setOrder(e){var t;if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const n=this.getParentRoom(),i=n.currentState.getStateEvents(a.b.SpaceChild),s=this.getOrderedChildren(i);e=Math.max(Math.min(e,s.length-1),0);const o=this.getOrder()<e;o&&e===s.length-1?e--:o||0!==e||e++;const r=s[o?e:e-1],c=s[o?e+1:e];let d=l.a[0],u=!1;if(r)if(e===s.length-1)null!=c&&c.order&&(d=Object(l.w)(c.order));else{const e=null==r?void 0:r.order,t=null==c?void 0:c.order;e&&t?d=e===t?Object(l.w)(e):Object(l.c)(e,t):e?d=Object(l.w)(e):t?d=Object(l.y)(t):u=!0}else null!=c&&c.order&&(d=Object(l.y)(c.order));if(u){let t;for(let i=0;i<=e;i++){const e=s[i];if(0===i&&(t=e.order),e.order)t=e.order;else{var h;t=t?Object(l.w)(t):l.a[0];const i=n.currentState.getStateEvents(a.b.SpaceChild,e.roomId),s=null!==(h=null==i?void 0:i.getContent())&&void 0!==h?h:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,a.b.SpaceChild,f(f({},s),{},{order:t}),e.roomId)}}t&&(d=Object(l.w)(t))}const m=n.currentState.getStateEvents(a.b.SpaceChild,this.roomId),p=null!==(t=null==m?void 0:m.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,a.b.SpaceChild,f(f({},p),{},{order:d}),this.roomId)}async createFile(e,t,n,i){var s;const o=await this.client.uploadContent(t,{includeFilename:!1,onlyContentUri:!0,rawResponse:!1});n.url=o;const r={msgtype:a.c.File,body:e,url:o,file:n};(i=null!==(s=i)&&void 0!==s?s:{})["m.new_content"]&&(i["m.new_content"]=r);const c=await this.client.sendMessage(this.roomId,f(f(f({},i),r),{},{[a.k.name]:{}}));return await this.client.sendStateEvent(this.roomId,a.j.name,{active:!0,name:e},c.event_id),c}getFile(e){const t=this.room.currentState.getStateEvents(a.j.name,e);return t?new m(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(a.j.name))&&void 0!==e?e:[]).map(e=>new m(this.client,e,this))}}}]]);
//# sourceMappingURL=init.js.map