(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{1383:function(e,t,a){"use strict";(function(e){var t=a(1384),n=a.n(t),i=a(1385),s=a.n(i),o=a(120);if(o.getRequest())throw new Error("Multiple matrix-js-sdk entrypoints detected!");let r;o.request((function(e,t){return e.qs=s.a.stringify(e.qs||{},e.qsStringifyOptions),n()(e,t)}));try{r=e.indexedDB}catch(e){}r&&o.setCryptoStoreFactory((function(){return new o.IndexedDBCryptoStore(r,"matrix-js-sdk:crypto")}));e.matrixcs=o}).call(this,a(30))},1395:function(e,t){},1397:function(e,t,a){"use strict";var n=a(88),i=a.n(n),s=a(0),o=a(90),r=a(92),c=a(297);var l;!function(e){e.Online="online",e.Offline="offline",e.Unavailable="unavailable"}(l||(l={}));t.a=new class{constructor(){i()(this,"unavailableTimer",null),i()(this,"dispatcherRef",null),i()(this,"state",null),i()(this,"onAction",e=>{"user_activity"===e.action&&(this.setState(l.Online),this.unavailableTimer.restart())})}async start(){for(this.unavailableTimer=new c.a(18e4),this.dispatcherRef=r.a.register(this.onAction);this.unavailableTimer;)try{await this.unavailableTimer.finished(),this.setState(l.Unavailable)}catch(e){}}stop(){this.dispatcherRef&&(r.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.unavailableTimer&&(this.unavailableTimer.abort(),this.unavailableTimer=null)}getState(){return this.state}async setState(e){if(e===this.state)return;const t=this.state;if(this.state=e,!o.a.get().isGuest())try{await o.a.get().setPresence({presence:this.state}),s.a.info("Presence:",e)}catch(e){s.a.error("Failed to set presence:",e),this.state=t}}}},1398:function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-colr.59b896a.woff2"},1399:function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-sbix.cebcdf9.woff2"},1400:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M2 3.05v6.22C2 15.63 9 17 9 17s7-1.37 7-7.73V3.05L9 1 2 3.05zm9.94 2.47c.19-.18.49-.17.67.02.16.18.16.45.02.63l-4.22 5.11-.03.04c-.28.34-.79.39-1.13.11a.29.29 0 01-.077-.067.912.912 0 00-.023-.023L5.34 9.26c-.2-.24-.18-.6.06-.8.2-.18.49-.18.7-.04l1.57 1.1 4.27-4z",fill:"#010101"})))}t.default="img/e2e/verified.5be6c9f.svg"},1401:function(e,t,a){"use strict";t.a={}},1402:function(e,t,a){"use strict";var n=a(87),i=a.n(n),s=a(115),o=a(89),r=a(98);t.a=e=>{const t=r.b.get().brand,a=Object(o.a)("%(brand)s now uses 3-5x less memory, by only loading information about other users when needed. Please wait whilst we resynchronise with the server!",{brand:t});return i.a.createElement(s.a,{hasCancelButton:!1,title:Object(o.a)("Updating %(brand)s",{brand:t}),description:i.a.createElement("div",null,a),button:Object(o.a)("OK"),onFinished:e.onFinished})}},1403:function(e,t,a){"use strict";var n=a(87),i=a.n(n),s=a(115),o=a(89),r=a(98);t.a=e=>{const t=r.b.get().brand,a=Object(o.a)("You've previously used %(brand)s on %(host)s with lazy loading of members enabled. In this version lazy loading is disabled. As the local cache is not compatible between these two settings, %(brand)s needs to resync your account.",{brand:t,host:e.host}),n=Object(o.a)("If the other version of %(brand)s is still open in another tab, please close it as using %(brand)s on the same host with both lazy loading enabled and disabled simultaneously will cause issues.",{brand:t});return i.a.createElement(s.a,{hasCancelButton:!1,title:Object(o.a)("Incompatible local cache"),description:i.a.createElement("div",null,i.a.createElement("p",null,a),i.a.createElement("p",null,n)),button:Object(o.a)("Clear cache and resync"),onFinished:e.onFinished})}},1404:function(e,t,a){"use strict";a.d(t,"a",(function(){return p}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(98),c=a(95),l=a(89),d=a(115),m=a(230),h=a(101),u=a(110);class p extends o.a.Component{constructor(){super(...arguments),i()(this,"sendBugReport",()=>{c.a.createTrackedDialog("Session Restore Error","Send Bug Report Dialog",m.a,{error:this.props.error})}),i()(this,"onClearStorageClick",()=>{c.a.createTrackedDialog("Session Restore Confirm Logout","",d.a,{title:Object(l.a)("Sign out"),description:o.a.createElement("div",null,Object(l.a)("Sign out and remove encryption keys?")),button:Object(l.a)("Sign out"),danger:!0,onFinished:this.props.onFinished})}),i()(this,"onRefreshClick",()=>{window.location.reload()})}render(){const e=r.b.get().brand,t=o.a.createElement("button",{onClick:this.onClearStorageClick,className:"danger"},Object(l.a)("Clear Storage and Sign Out"));let a;return a=r.b.get().bug_report_endpoint_url?o.a.createElement(u.a,{primaryButton:Object(l.a)("Send Logs"),onPrimaryButtonClick:this.sendBugReport,focus:!0,hasCancel:!1},t):o.a.createElement(u.a,{primaryButton:Object(l.a)("Refresh"),onPrimaryButtonClick:this.onRefreshClick,focus:!0,hasCancel:!1},t),o.a.createElement(h.a,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(l.a)("Unable to restore session"),contentId:"mx_Dialog_content",hasCancel:!1},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.a.createElement("p",null,Object(l.a)("We encountered an error trying to restore your previous session.")),o.a.createElement("p",null,Object(l.a)("If you have previously used a more recent version of %(brand)s, your session may be incompatible with this version. Close this window and return to the more recent version.",{brand:e})),o.a.createElement("p",null,Object(l.a)("Clearing your browser's storage may fix the problem, but will sign you out and cause any encrypted chat history to become unreadable."))),a)}}},1405:function(e,t,a){"use strict";a.d(t,"a",(function(){return p}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(98),c=a(95),l=a(89),d=a(101),m=a(110),h=a(230),u=a(91);class p extends o.a.Component{constructor(){super(...arguments),i()(this,"sendBugReport",e=>{e.preventDefault(),c.a.createTrackedDialog("Storage evicted","Send Bug Report Dialog",h.a,{})}),i()(this,"onSignOutClick",()=>{this.props.onFinished(!0)})}render(){let e;return r.b.get().bug_report_endpoint_url&&(e=Object(l.a)("To help us prevent this in future, please <a>send us logs</a>.",{},{a:e=>o.a.createElement(u.a,{kind:"link_inline",onClick:this.sendBugReport},e)})),o.a.createElement(d.a,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(l.a)("Missing session data"),contentId:"mx_Dialog_content",hasCancel:!1},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.a.createElement("p",null,Object(l.a)("Some session data, including encrypted message keys, is missing. Sign out and sign in to fix this, restoring keys from backup.")),o.a.createElement("p",null,Object(l.a)("Your browser likely removed this data when running low on disk space.")," ",e)),o.a.createElement(m.a,{primaryButton:Object(l.a)("Sign out"),onPrimaryButtonClick:this.onSignOutClick,focus:!0,hasCancel:!1}))}}},1406:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({viewBox:"-1 -1 13 13",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("g",{stroke:"#4A4A4A",strokeWidth:2.82,strokeLinecap:"square",fill:"none",fillRule:"evenodd"},i.createElement("path",{d:"M6 2.229V9.77M2.229 6H9.77"}))))}t.default="img/plus.53bc1d6.svg"},1407:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return Le}));var n=a(99),i=a.n(n),s=a(88),o=a.n(s),r=a(87),c=a.n(r),l=a(120),d=a(242),m=a(243),h=a(7),u=a(0),p=a(111),g=a(145),b=(a(1408),a(1409),a(127)),v=a(162),f=a(810),E=a(90),y=a(126),_=a(98),S=a(92),w=a(286),C=a(95),O=a(193),k=a(238),x=a(413),R=(a(1410),a(1411),a(446)),j=a(183),I=a(89),T=a(93),N=a(550),P=a(814),M=a(348),D=a(1412),A=a(309),U=a(135),L=a(412),F=a(551),B=a(387),V=a(160),W=a(381),H=a(1482),z=a(96),K=a(1459),q=a(548),G=a(107),Y=a(172),J=a(104),$=a(808),Q=a(122),X=a(1460),Z=a(1461),ee=a(563),te=a(189),ae=a(166),ne=a(249),ie=a(102),se=a(115),oe=a(1483),re=a(155),ce=a(523),le=a(846),de=a(1462),me=a(1488),he=a(1463),ue=a(1490),pe=a(1491),ge=a(1492),be=a(1493),ve=a(1494),fe=a(416),Ee=a(1471),ye=a(1495),_e=a(147),Se=a(1496),we=a(132),Ce=a(149),Oe=a(173),ke=a(513),xe=a(156),Re=a(213),je=a(91),Ie=a(197),Te=a(318),Ne=a(9),Pe=a(427),Me=a(298);function De(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}const Ae=["register","login","forgot_password","start_sso","start_cas","welcome"],Ue=[z.a.ViewUserSettings,"view_create_chat","view_create_room"];class Le extends c.a.PureComponent{constructor(t){if(super(t),o()(this,"firstSyncComplete",!1),o()(this,"firstSyncPromise",void 0),o()(this,"screenAfterLogin",void 0),o()(this,"tokenLogin",void 0),o()(this,"accountPassword",void 0),o()(this,"accountPasswordTimer",void 0),o()(this,"focusComposer",void 0),o()(this,"subTitleStatus",void 0),o()(this,"prevWindowWidth",void 0),o()(this,"loggedInView",void 0),o()(this,"dispatcherRef",void 0),o()(this,"themeWatcher",void 0),o()(this,"fontWatcher",void 0),o()(this,"onWindowResized",()=>{this.warnInConsole()}),o()(this,"warnInConsole",Object(p.throttle)(()=>{const t=Object(I.a)("Wait!"),a=Object(I.a)("If someone told you to copy/paste something here, there is a high likelihood you're being scammed!"),n=Object(I.a)("If you know what you're doing, Element is open-source, be sure to check out our GitHub (https://github.com/vector-im/element-web/) and contribute!");e.mx_rage_logger.bypassRageshake("log",`%c${t}\n%c${a}\n%c${n}`,"font-size:50px; color:blue;","font-size:15px; color:red;","font-size:15px;")},1e3)),o()(this,"onAction",e=>{var t;if(null!==(t=E.a.get())&&void 0!==t&&t.isGuest()&&Ue.includes(e.action))return S.a.dispatch({action:z.a.DoAfterSyncPrepared,deferred_action:e}),void S.a.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":if("m.identity_server"===e.event_type){const t=e.event_content?e.event_content.base_url:null;t?(E.a.get().setIdentityServerUrl(t),localStorage.removeItem("mx_is_access_token"),localStorage.setItem("mx_is_url",t)):(E.a.get().setIdentityServerUrl(null),localStorage.removeItem("mx_is_access_token"),localStorage.removeItem("mx_is_url")),S.a.dispatch({action:"id_server_changed"})}break;case"logout":xe.b.instance.hangupAllCalls(),Me.b.instance.connected&&Me.b.instance.setDisconnected(),x.i();break;case"require_registration":Object(P.b)(e);break;case"start_registration":if(x.g()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(x.g()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.viewLogin();break;case"start_password_recovery":this.setStateForNewView({view:Te.a.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":Object(j.b)({dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"copy_room":this.copyRoom(e.room_id);break;case"reject_invite":C.a.createTrackedDialog("Reject invitation","",se.a,{title:Object(I.a)("Reject invitation"),description:Object(I.a)("Are you sure you want to reject the invitation?"),onFinished:t=>{if(t){const t=C.a.createDialog(ie.a,null,"mx_Dialog_spinner");E.a.get().leave(e.room_id).then(()=>{t.close(),this.state.currentRoomId===e.room_id&&S.a.dispatch({action:z.a.ViewHomePage})},e=>{t.close(),C.a.createTrackedDialog("Failed to reject invitation","",G.a,{title:Object(I.a)("Failed to reject invitation"),description:e.toString()})})}}});break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case"MatrixActions.RoomState.events":{const t=e.event;t.getType()===l.EventType.RoomCanonicalAlias&&t.getRoomId()===this.state.currentRoomId&&this.viewRoom({action:z.a.ViewRoom,room_id:this.state.currentRoomId,metricsTrigger:void 0});break}case z.a.ViewRoom:{const t=this.viewRoom(e);e.deferred_action&&t.then(()=>{S.a.dispatch(e.deferred_action)});break}case"view_legacy_group":this.viewLegacyGroup(e.groupId);break;case z.a.ViewUserSettings:{const t=e;C.a.createTrackedDialog("User settings","",oe.a,{initialTabId:t.initialTabId},null,!1,!0),this.viewSomethingBehindModal();break}case"view_create_room":this.createRoom(e.public,e.defaultName,e.type),this.viewSomethingBehindModal();break;case z.a.ViewRoomDirectory:C.a.createTrackedDialog("Room directory","",le.a,{initialText:e.initialText},"mx_RoomDirectory_dialogWrapper",!1,!0),this.viewSomethingBehindModal();break;case"view_welcome_page":this.viewWelcome();break;case z.a.ViewHomePage:this.viewHome(e.justRegistered);break;case z.a.ViewStartChatOrReuse:this.chatCreateOrReuse(e.user_id);break;case"view_create_chat":Object(O.f)(e.initialText||""),this.viewSomethingBehindModal();break;case"view_invite":{const t=E.a.get().getRoom(e.roomId);null!=t&&t.isSpaceRoom()?Object(Re.i)(t):Object(O.e)(e.roomId);break}case"view_last_screen":this.showScreenAfterLogin();break;case"hide_left_panel":this.setState({collapseLhs:!0},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case"focus_room_filter":if(T.b.getValue("feature_spotlight"))break;case"show_left_panel":this.setState({collapseLhs:!1},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case z.a.OpenDialPad:C.a.createTrackedDialog("Dial pad","",X.a,{},"mx_Dialog_dialPadWrapper");break;case z.a.OnLoggedIn:this.tokenLogin||x.g()||this.state.view===Te.a.LOGIN||this.state.view===Te.a.REGISTER||this.state.view===Te.a.COMPLETE_SECURITY||this.state.view===Te.a.E2E_SETUP||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case z.a.OnLoggedOut:this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},()=>{this.onWillStartClient()});break;case"client_started":this.onClientStarted();break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case z.a.AnonymousAnalyticsAccept:Object(K.a)(),T.b.setValue("analyticsOptIn",null,J.a.DEVICE,!0),T.b.setValue("showCookieBar",null,J.a.DEVICE,!1),v.a.canEnable()&&v.a.enable();break;case z.a.AnonymousAnalyticsReject:Object(K.a)(),T.b.setValue("analyticsOptIn",null,J.a.DEVICE,!1),T.b.setValue("showCookieBar",null,J.a.DEVICE,!1);break;case z.a.PseudonymousAnalyticsAccept:Object(K.a)(),T.b.setValue("pseudonymousAnalyticsOptIn",null,J.a.ACCOUNT,!0);break;case z.a.PseudonymousAnalyticsReject:Object(K.a)(),T.b.setValue("pseudonymousAnalyticsOptIn",null,J.a.ACCOUNT,!1)}}),o()(this,"handleResize",()=>{const e=_e.b.instance.windowWidth;this.prevWindowWidth<1e3&&e>=1e3&&S.a.dispatch({action:"show_left_panel"}),this.prevWindowWidth>=1e3&&e<1e3&&S.a.dispatch({action:"hide_left_panel"}),this.prevWindowWidth=e,this.state.resizeNotifier.notifyWindowResized()}),o()(this,"onRegisterClick",()=>{this.showScreen("register")}),o()(this,"onLoginClick",()=>{this.showScreen("login")}),o()(this,"onForgotPasswordClick",()=>{this.showScreen("forgot_password")}),o()(this,"onRegisterFlowComplete",(e,t)=>this.onUserCompletedLoginFlow(e,t)),o()(this,"onUpdateStatusIndicator",(e,t)=>{const a=e.numUnreadStates;y.a.get()&&(y.a.get().setErrorStatus(t===d.b.Error),y.a.get().setNotificationCount(a)),this.subTitleStatus="",t===d.b.Error&&(this.subTitleStatus+=`[${Object(I.a)("Offline")}] `),a>0&&(this.subTitleStatus+=`[${a}]`),this.setPageSubtitle()}),o()(this,"onServerConfigChange",e=>{this.setState({serverConfig:e})}),o()(this,"makeRegistrationUrl",e=>(this.props.startingFragmentQueryParams.referrer&&(e.referrer=this.props.startingFragmentQueryParams.referrer),this.props.makeRegistrationUrl(e))),o()(this,"onUserCompletedLoginFlow",async(e,t)=>{this.accountPassword=t,null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer),this.accountPasswordTimer=setTimeout(()=>{this.accountPassword=null,this.accountPasswordTimer=null},3e5),await x.k(e),await this.postLoginSetup(),ye.b.instance.stop(ye.a.LOGIN),ye.b.instance.stop(ye.a.REGISTER)}),o()(this,"onCompleteSecurityE2eSetupFinished",()=>{this.onLoggedIn()}),this.state={view:Te.a.LOADING,collapseLhs:!1,hideToSRUsers:!1,syncError:null,resizeNotifier:new D.a,ready:!1},this.loggedInView=Object(r.createRef)(),_.b.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=Object(h.l)(),this.props.config.sync_timeline_limit&&(E.a.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.screenAfterLogin){const e=this.screenAfterLogin.params||{};if(this.screenAfterLogin.screen.startsWith("room/")&&e.signurl&&e.email){const t=this.screenAfterLogin.screen.substring("room/".length);$.a.instance.storeInvite(t,e)}}this.prevWindowWidth=_e.b.instance.windowWidth||1e3,_e.b.instance.on(_e.a.Resize,this.handleResize),this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),Y.a.instance.on(Y.b,this.onUpdateStatusIndicator),x.g()&&x.h(),this.accountPassword=null,this.accountPasswordTimer=null,this.dispatcherRef=S.a.register(this.onAction),this.themeWatcher=new L.a,this.fontWatcher=new F.a,this.themeWatcher.start(),this.fontWatcher.start(),this.focusComposer=!1,this.subTitleStatus="",x.g()||x.a(this.props.realQueryParams,this.props.defaultDeviceDisplayName,this.getFragmentAfterLogin()).then(async e=>{var t;if(null!==(t=this.props.realQueryParams)&&void 0!==t&&t.loginToken&&this.props.onTokenLoginCompleted(),e)return this.tokenLogin=!0,await x.j({ignoreGuest:!0}),this.postLoginSetup();const a=this.screenAfterLogin?this.screenAfterLogin.screen:null;if("login"!==a&&"register"!==a&&"forgot_password"!==a)return this.loadSession();this.showScreenAfterLogin()}),T.b.getValue("pseudonymousAnalyticsOptIn")&&v.a.enable(),Object(ke.a)(_.b.get("sentry"))}async postLoginSetup(){const e=E.a.get(),t=e.isCryptoEnabled();t||this.onLoggedIn();const a=[this.firstSyncPromise.promise];if(t&&a.push(e.downloadKeys([e.getUserId()])),this.setState({pendingInitialSync:!0}),await Promise.all(a),!t)return void this.setState({pendingInitialSync:!1});e.getStoredCrossSigningForUser(e.getUserId())?!1===ne.a.SHOW_ENCRYPTION_SETUP_UI?this.onLoggedIn():this.setStateForNewView({view:Te.a.COMPLETE_SECURITY}):await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")?this.setStateForNewView({view:Te.a.E2E_SETUP}):this.onLoggedIn(),this.setState({pendingInitialSync:!1})}UNSAFE_componentWillUpdate(e,t){this.shouldTrackPageChange(this.state,t)&&this.startPageChangeTimer()}componentDidMount(){window.addEventListener("resize",this.onWindowResized)}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();v.a.trackPageChange(e),b.b.instance.trackPageChange(this.state.view,this.state.page_type,e)}this.focusComposer&&(S.a.fire(z.a.FocusSendMessageComposer),this.focusComposer=!1)}componentWillUnmount(){x.m(),S.a.unregister(this.dispatcherRef),this.themeWatcher.stop(),this.fontWatcher.stop(),_e.b.destroy(),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),window.removeEventListener("resize",this.onWindowResized),null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer)}getFallbackHsUrl(){var e;return null!==(e=this.props.serverConfig)&&void 0!==e&&e.isDefault?this.props.config.fallback_hs_url:null}getServerProperties(){let e=this.state.serverConfig;return e||(e=this.props.serverConfig),e||(e=_.b.get("validated_server_config")),{serverConfig:e}}loadSession(){return Promise.resolve().then(()=>x.h({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:this.getServerProperties().serverConfig.hsUrl,guestIsUrl:this.getServerProperties().serverConfig.isUrl,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName})).then(e=>{e||($.a.instance.pickBestInvite()?S.a.dispatch({action:"start_registration"}):S.a.dispatch({action:"view_welcome_page"}))})}startPageChangeTimer(){ye.b.instance.start(ye.a.PAGE_CHANGE)}stopPageChangeTimer(){const e=ye.b.instance;e.stop(ye.a.PAGE_CHANGE);const t=e.getEntries({name:ye.a.PAGE_CHANGE}).pop();return t?t.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");const t={currentUserId:null,justRegistered:!1};Object.assign(t,e),this.setState(t)}setPage(e){this.setState({page_type:e})}async startRegistration(e){const t={view:Te.a.REGISTER};if(e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid){t.serverConfig=await A.a.validateServerConfigWithStaticUrls(e.hs_url,e.is_url);const a=_.b.get("validated_server_config");a&&a.hsUrl===t.serverConfig.hsUrl&&(t.serverConfig.hsName=a.hsName,t.serverConfig.hsNameIsDifferent=a.hsNameIsDifferent,t.serverConfig.isDefault=a.isDefault,t.serverConfig.isNameResolvable=a.isNameResolvable),t.register_client_secret=e.client_secret,t.register_session_id=e.session_id,t.register_id_sid=e.sid}this.setStateForNewView(t),N.a.isLogin=!0,this.themeWatcher.recheck(),this.notifyNewScreen("register")}async viewRoom(e){if(this.focusComposer=!0,e.room_alias?u.a.log(`Switching to room alias ${e.room_alias} at event ${e.event_id}`):u.a.log(`Switching to room id ${e.room_id} at event ${e.event_id}`),!this.firstSyncComplete){if(!this.firstSyncPromise)return void u.a.warn("Cannot view a room before first sync. room_id:",e.room_id);await this.firstSyncPromise.promise}let t=e.room_alias||e.room_id;const a=E.a.get().getRoom(e.room_id);if(a){var n;a.decryptAllEvents();const e=k.b(a);e&&(t=e,Object(B.b)(e,a.roomId)),null===(n=localStorage)||void 0===n||n.setItem("mx_last_room_id",a.roomId)}const i="#"===t[0]&&e.room_id===this.state.currentRoomId;var s,o,r,c;e.room_id===this.state.currentRoomId&&(e.threepid_invite=null!==(s=e.threepid_invite)&&void 0!==s?s:this.state.threepidInvite,e.oob_data=null!==(o=e.oob_data)&&void 0!==o?o:this.state.roomOobData,e.forceTimeline=null!==(r=e.forceTimeline)&&void 0!==r?r:this.state.forceTimeline,e.justCreatedOpts=null!==(c=e.justCreatedOpts)&&void 0!==c?c:this.state.roomJustCreatedOpts);e.event_id&&e.highlighted&&(t+="/"+e.event_id),this.setState({view:Te.a.LOGGED_IN,currentRoomId:e.room_id||null,page_type:R.a.RoomView,threepidInvite:e.threepid_invite,roomOobData:e.oob_data,forceTimeline:e.forceTimeline,ready:!0,roomJustCreatedOpts:e.justCreatedOpts},()=>{this.notifyNewScreen("room/"+t,i)})}viewSomethingBehindModal(){this.state.view===Te.a.LOGGED_IN?this.state.currentRoomId||this.state.currentUserId||this.viewHome():this.viewWelcome()}viewWelcome(){if(Object(ee.b)(_.b.get()))return this.viewLogin();this.setStateForNewView({view:Te.a.WELCOME}),this.notifyNewScreen("welcome"),N.a.isLogin=!0,this.themeWatcher.recheck()}viewLogin(e){this.setStateForNewView(function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?De(Object(a),!0).forEach((function(t){o()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):De(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({view:Te.a.LOGIN},e)),this.notifyNewScreen("login"),N.a.isLogin=!0,this.themeWatcher.recheck()}viewHome(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.setStateForNewView({view:Te.a.LOGGED_IN,justRegistered:e,currentRoomId:null}),this.setPage(R.a.HomePage),this.notifyNewScreen("home"),N.a.isLogin=!1,this.themeWatcher.recheck()}viewUser(e,t){(this.firstSyncPromise?this.firstSyncPromise.promise:Promise.resolve()).then(()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(R.a.UserView)):this.chatCreateOrReuse(e)})}viewLegacyGroup(e){this.setStateForNewView({view:Te.a.LOGGED_IN,currentRoomId:null,currentGroupId:e}),this.notifyNewScreen("group/"+e),this.setPage(R.a.LegacyGroupView)}async createRoom(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0,a=arguments.length>2?arguments[2]:void 0;const n=C.a.createTrackedDialog("Create Room","",ce.a,{type:a,defaultPublic:e,defaultName:t}),[i,s]=await n.finished;i&&Object(j.b)(s)}chatCreateOrReuse(e){const t=new Ne.a(this.props.config);if(E.a.get().isGuest())return e!==t.get("welcome_user_id")&&S.a.dispatch({action:z.a.DoAfterSyncPrepared,deferred_action:{action:z.a.ViewStartChatOrReuse,user_id:e}}),void S.a.dispatch({action:"require_registration",go_welcome_on_cancel:!0,screen_after:{screen:"user/"+t.get("welcome_user_id"),params:{action:"chat"}}});const a=E.a.get(),n=new U.a(a).getDMRoomsForUserId(e);n.length>0?S.a.dispatch({action:z.a.ViewRoom,room_id:n[0],metricsTrigger:"MessageUser"}):S.a.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=E.a.get().getRoom(e),a=null==t?void 0:t.isSpaceRoom(),n=[];if(1===t.currentState.getJoinedMemberCount())return n.push(c.a.createElement("span",{className:"warning",key:"only_member_warning"}," ",Object(I.a)("You are the only person here. If you leave, no one will be able to join in the future, including you."))),n;const i=t.currentState.getStateEvents("m.room.join_rules","");if(i){"public"!==i.getContent().join_rule&&n.push(c.a.createElement("span",{className:"warning",key:"non_public_warning"}," ",a?Object(I.a)("This space is not public. You will not be able to rejoin without an invite."):Object(I.a)("This room is not public. You will not be able to rejoin without an invite.")))}return n}leaveRoom(e){const t=E.a.get().getRoom(e),a=this.leaveRoomWarnings(e),n=null==t?void 0:t.isSpaceRoom();C.a.createTrackedDialog(n?"Leave space":"Leave room","",se.a,{title:n?Object(I.a)("Leave space"):Object(I.a)("Leave room"),description:c.a.createElement("span",null,n?Object(I.a)("Are you sure you want to leave the space '%(spaceName)s'?",{spaceName:t.name}):Object(I.a)("Are you sure you want to leave the room '%(roomName)s'?",{roomName:t.name}),a),button:Object(I.a)("Leave"),onFinished:t=>{t&&(Object(Pe.a)(e),S.a.dispatch({action:z.a.AfterLeaveRoom,room_id:e}))}})}forgetRoom(e){const t=E.a.get().getRoom(e);E.a.get().forget(e).then(()=>{this.state.currentRoomId===e&&S.a.dispatch({action:z.a.ViewHomePage}),te.b.instance.manualRoomUpdate(t,ae.c.RoomRemoved)}).catch(e=>{const t=e.errcode||Object(I.c)("unknown error code");C.a.createTrackedDialog("Failed to forget room","",G.a,{title:Object(I.a)("Failed to forget room %(errCode)s",{errCode:t}),description:e&&e.message?e.message:Object(I.a)("Operation failed")})})}async copyRoom(e){const t=Object(we.f)(e);await Object(Ce.c)(t)||C.a.createTrackedDialog("Unable to copy room link","",G.a,{title:Object(I.a)("Unable to copy room link"),description:Object(I.a)("Unable to copy a link to the room to the clipboard.")})}async startWelcomeUserChat(){let e;e=this.firstSyncComplete?Promise.resolve():this.firstSyncPromise.promise,await e;const t=new Ne.a(this.props.config);if(0===U.a.shared().getDMRoomsForUserId(t.get("welcome_user_id")).length){const e=await Object(j.b)({dmUserId:t.get("welcome_user_id"),andView:!this.state.currentRoomId,spinner:!1}),a=e=>{e.getType()===l.EventType.Direct&&e.getContent()[t.get("welcome_user_id")]&&(E.a.get().store.save(!0),E.a.get().removeListener(l.ClientEvent.AccountData,a))};return E.a.get().on(l.ClientEvent.AccountData,a),e}return null}async onLoggedIn(){if(N.a.isLogin=!1,this.themeWatcher.recheck(),this.setStateForNewView({view:Te.a.LOGGED_IN}),this.screenAfterLogin&&this.screenAfterLogin.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null;else if(E.a.currentUserIsJustRegistered()){E.a.setJustRegisteredUserId(null);if(new Ne.a(this.props.config).get("welcome_user_id")&&Object(I.e)().startsWith("en")){null===await this.startWelcomeUserChat()&&S.a.dispatch({action:z.a.ViewHomePage,justRegistered:!0})}else if($.a.instance.pickBestInvite()){const e=$.a.instance.pickBestInvite(),t=$.a.instance.translateToWireFormat(e);this.showScreen("room/"+e.roomId,t)}else S.a.dispatch({action:z.a.ViewHomePage,justRegistered:!0})}else this.showScreenAfterLogin();W.g(),Oe.a.instance.isEnabled()&&T.b.isLevelSupported(J.a.ACCOUNT)?this.initPosthogAnalyticsToast():v.a.canEnable()&&T.b.getValue("showCookieBar")&&Object(K.b)(),_.b.get("mobile_guide_toast")&&Object(Z.a)()}showPosthogToast(e){Object(K.c)(e)}initPosthogAnalyticsToast(){null===T.b.getValue("pseudonymousAnalyticsOptIn")&&this.showPosthogToast(T.b.getValue("analyticsOptIn",null,!0)),T.b.watchSetting("pseudonymousAnalyticsOptIn",null,(e,t,a,n,i)=>{null===i?this.showPosthogToast(T.b.getValue("analyticsOptIn",null,!0)):Object(K.a)()})}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null):localStorage&&localStorage.getItem("mx_last_room_id")?this.viewLastRoom():E.a.get().isGuest()?S.a.dispatch({action:"view_welcome_page"}):S.a.dispatch({action:z.a.ViewHomePage})}viewLastRoom(){S.a.dispatch({action:z.a.ViewRoom,room_id:localStorage.getItem("mx_last_room_id"),metricsTrigger:void 0})}onLoggedOut(){this.viewLogin({ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:Te.a.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){this.firstSyncComplete=!1,this.firstSyncPromise=Object(h.l)();const e=E.a.get();e.setCanResetTimelineCallback(e=>(u.a.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e)))),e.on(l.ClientEvent.Sync,(e,t,a)=>{e===d.b.Error||e===d.b.Reconnecting?(a.error instanceof m.b&&x.d(a.error),this.setState({syncError:a.error||{}})):this.state.syncError&&this.setState({syncError:null}),e===d.b.Syncing&&t===d.b.Syncing||(u.a.info("MatrixClient sync state => %s",e),e===d.b.Prepared&&(this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),w.default.shouldShowPrompt()&&!E.a.userRegisteredWithinLastHours(24)&&Object(q.b)(!1),localStorage.getItem("mx_seen_feature_spotlight_toast")||setTimeout(()=>{if(T.b.getValue("feature_spotlight")||null!==T.b.getValue("feature_spotlight",null,!0))return;const e="BETA_SPOTLIGHT_TOAST";V.a.sharedInstance().addOrReplaceToast({key:e,title:Object(I.a)("New search beta available"),props:{description:Object(I.a)("We're testing a new search to make finding what you want quicker.\n"),acceptLabel:Object(I.a)("Learn more"),onAccept:()=>{S.a.dispatch({action:z.a.ViewUserSettings,initialTabId:re.a.Labs}),localStorage.setItem("mx_seen_feature_spotlight_toast","true"),V.a.sharedInstance().dismissToast(e)},rejectLabel:Object(I.a)("Dismiss"),onReject:()=>{localStorage.setItem("mx_seen_feature_spotlight_toast","true"),V.a.sharedInstance().dismissToast(e)}},icon:"labs",component:Ie.a,priority:9})},3e5),S.a.fire(z.a.FocusSendMessageComposer),this.setState({ready:!0})))}),e.on(l.HttpApiEvent.SessionLoggedOut,(function(e){if(!x.f()){if(C.a.closeCurrentModal("Session.logged_out"),401===e.httpStatus&&e.data&&e.data.soft_logout)return u.a.warn("Soft logout issued by server - avoiding data deletion"),void x.l();C.a.createTrackedDialog("Signed out","",G.a,{title:Object(I.a)("Signed Out"),description:Object(I.a)("For security, this session has been signed out. Please sign in again.")}),S.a.dispatch({action:"logout"})}})),e.on(l.HttpApiEvent.NoConsent,(function(t,a){C.a.createTrackedDialog("No Consent Dialog","",se.a,{title:Object(I.a)("Terms and Conditions"),description:c.a.createElement("div",null,c.a.createElement("p",null," ",Object(I.a)("To continue using the %(homeserverDomain)s homeserver you must review and agree to our terms and conditions.",{homeserverDomain:e.getDomain()}))),button:Object(I.a)("Review terms and conditions"),cancelButton:Object(I.a)("Dismiss"),onFinished:e=>{if(e){window.open(a,"_blank").opener=null}}},null,!0)}));const t=f.a.instance;t.start(),e.on(l.HttpApiEvent.SessionLoggedOut,()=>t.stop()),e.on(l.MatrixEventEvent.Decrypted,(e,a)=>t.eventDecrypted(e,a)),e.on(l.ClientEvent.Room,e=>{if(E.a.get().isCryptoEnabled()){const t=T.b.getValueAt(J.a.ROOM_DEVICE,"blacklistUnverifiedDevices",e.roomId,!0);e.setBlacklistUnverifiedDevices(t)}}),e.on(g.b.Warning,e=>{switch(e){case"CRYPTO_WARNING_OLD_VERSION_DETECTED":C.a.createTrackedDialog("Crypto migrated","",G.a,{title:Object(I.a)("Old cryptography data detected"),description:Object(I.a)("Data from an older version of %(brand)s has been detected. This will have caused end-to-end cryptography to malfunction in the older version. End-to-end encrypted messages exchanged recently whilst using the older version may not be decryptable in this version. This may also cause messages exchanged with this version to fail. If you experience problems, log out and back in again. To retain message history, export and re-import your keys.",{brand:_.b.get().brand})})}}),e.on(g.b.KeyBackupFailed,async e=>{let t,n;if(E.a.get().getKeyBackupEnabled())t=!0;else try{n=await E.a.get().getKeyBackupVersion(),null!==n&&(t=!0)}catch(e){return void u.a.error("Saw key backup error but failed to check backup version!",e)}t?C.a.createTrackedDialogAsync("New Recovery Method","New Recovery Method",a.e(33).then(a.bind(null,1472)),{newVersionInfo:n}):C.a.createTrackedDialogAsync("Recovery Method Removed","Recovery Method Removed",a.e(34).then(a.bind(null,1473)))}),e.on(g.b.KeySignatureUploadFailure,(e,t,a)=>{C.a.createTrackedDialog("Failed to upload key signatures","Failed to upload key signatures",de.a,{failures:e,source:t,continuation:a})}),e.on(g.b.VerificationRequest,e=>{e.verifier?C.a.createTrackedDialog("Incoming Verification","",me.a,{verifier:e.verifier},null,!1,!0):e.pending&&V.a.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.channel.transactionId,title:Object(I.a)("Verification requested"),icon:"verification",props:{request:e},component:Ee.a,priority:90})})}onClientStarted(){const e=E.a.get();if(e.isCryptoEnabled()){const t=T.b.getValueAt(J.a.DEVICE,"blacklistUnverifiedDevices");e.setGlobalBlacklistUnverifiedDevices(t),e.setGlobalErrorOnUnknownDevices(!1)}}showScreen(e,t){const a=E.a.get();if(!a||a.isGuest()||!Ae.includes(e))if("register"===e)S.a.dispatch({action:"start_registration",params:t}),ye.b.instance.start(ye.a.REGISTER);else if("login"===e)S.a.dispatch({action:"start_login",params:t}),ye.b.instance.start(ye.a.LOGIN);else if("forgot_password"===e)S.a.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)a.getUserId()&&!x.g()?this.viewLastRoom():S.a.dispatch({action:"start_login",params:t});else if("new"===e)S.a.dispatch({action:"view_create_room"});else if("dm"===e)S.a.dispatch({action:"view_create_chat"});else if("settings"===e)S.a.fire(z.a.ViewUserSettings);else if("welcome"===e)S.a.dispatch({action:"view_welcome_page"});else if("home"===e)S.a.dispatch({action:z.a.ViewHomePage});else if("start"===e)this.showScreen("home"),S.a.dispatch({action:"require_registration"});else if("directory"===e)S.a.fire(z.a.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){let t=E.a.get();if(!t){const{hsUrl:e,isUrl:a}=this.props.serverConfig;t=Object(l.createClient)({baseUrl:e,idBaseUrl:a})}const a="start_sso"===e?"sso":"cas";y.a.get().startSingleSignOn(t,a,this.getFragmentAfterLogin())}else if(0===e.indexOf("room/")){var n,i,s;const a=e.substring(5),o=a.indexOf(":")+1;let r=a.length;a.substring(o).indexOf("/")>-1&&(r=o+a.substring(o).indexOf("/"));const c=a.substring(0,r);let l,d=a.substring(r+1);if(d||(d=void 0),t.signurl&&t.email&&(l=$.a.instance.storeInvite(c,t)),!l){l=$.a.instance.getInvites().find(e=>e.roomId===c)}let m=[];t.via&&(m="string"==typeof t.via?[t.via]:t.via);const h={action:z.a.ViewRoom,event_id:d,via_servers:m,highlighted:Boolean(d),threepid_invite:l,oob_data:{name:null===(n=l)||void 0===n?void 0:n.roomName,avatarUrl:null===(i=l)||void 0===i?void 0:i.roomAvatarUrl,inviterName:null===(s=l)||void 0===s?void 0:s.inviterName},room_alias:void 0,room_id:void 0,metricsTrigger:void 0};"#"===c[0]?h.room_alias=c:h.room_id=c,S.a.dispatch(h)}else if(0===e.indexOf("user/")){const a=e.substring(5);S.a.dispatch({action:"view_user_info",userId:a,subAction:t.action})}else if(0===e.indexOf("group/")){const t=e.substring(6);S.a.dispatch({action:"view_legacy_group",groupId:t})}else u.a.info("Ignoring showScreen for '%s'",e);else S.a.dispatch({action:z.a.ViewHomePage})}notifyNewScreen(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.props.onNewScreen&&this.props.onNewScreen(e,t),this.setPageSubtitle()}onLogoutClick(e){S.a.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){S.a.dispatch({action:"timeline_resize"})}onRegistered(e){return x.k(e)}onSendEvent(e,t){const a=E.a.get();a&&a.sendEvent(e,t.getType(),t.getContent()).then(()=>{S.a.dispatch({action:"message_sent"})})}setPageSubtitle(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(this.state.currentRoomId){const t=E.a.get(),a=t&&t.getRoom(this.state.currentRoomId);a&&(e=`${this.subTitleStatus} | ${a.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;const t=`${_.b.get().brand} ${e}`;document.title!==t&&(document.title=t)}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas"].includes(t.screen)&&(e="/"+t.screen),e}render(){const e=this.getFragmentAfterLogin();let t=null;if(this.state.view===Te.a.LOADING)t=c.a.createElement("div",{className:"mx_MatrixChat_splash"},c.a.createElement(ie.a,null));else if(this.state.view===Te.a.COMPLETE_SECURITY)t=c.a.createElement(he.a,{onFinished:this.onCompleteSecurityE2eSetupFinished});else if(this.state.view===Te.a.E2E_SETUP)t=c.a.createElement(ge.a,{onFinished:this.onCompleteSecurityE2eSetupFinished,accountPassword:this.accountPassword,tokenLogin:!!this.tokenLogin});else if(this.state.view===Te.a.LOGGED_IN){const e=this.state.syncError&&this.state.syncError instanceof m.b;if(this.state.ready&&this.state.page_type&&!e)t=c.a.createElement(H.a,i()({},this.props,this.state,{ref:this.loggedInView,matrixClient:E.a.get(),onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId}));else{let a;this.state.syncError&&!e&&(a=c.a.createElement("div",{className:"mx_MatrixChat_syncError"},Object(M.b)(this.state.syncError))),t=c.a.createElement("div",{className:"mx_MatrixChat_splash"},a,c.a.createElement(ie.a,null),c.a.createElement(je.a,{kind:"link_inline",className:"mx_MatrixChat_splashButtons",onClick:this.onLogoutClick},Object(I.a)("Logout")))}}else if(this.state.view===Te.a.WELCOME)t=c.a.createElement(ue.a,null);else if(this.state.view===Te.a.REGISTER&&T.b.getValue(Q.b.Registration)){var a;const n=null===(a=$.a.instance.pickBestInvite())||void 0===a?void 0:a.toEmail;t=c.a.createElement(be.a,i()({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:n,brand:this.props.config.brand,makeRegistrationUrl:this.makeRegistrationUrl,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,fragmentAfterLogin:e},this.getServerProperties()))}else if(this.state.view===Te.a.FORGOT_PASSWORD&&T.b.getValue(Q.b.PasswordReset))t=c.a.createElement(pe.a,i()({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange},this.getServerProperties()));else if(this.state.view===Te.a.LOGIN){const a=T.b.getValue(Q.b.PasswordReset);t=c.a.createElement(ve.a,i()({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:a?this.onForgotPasswordClick:void 0,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e,defaultUsername:this.props.startingFragmentQueryParams.defaultUsername},this.getServerProperties()))}else this.state.view===Te.a.SOFT_LOGOUT?t=c.a.createElement(Se.a,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e}):u.a.error("Unknown view "+this.state.view);return c.a.createElement(fe.a,null,t)}}o()(Le,"displayName","MatrixChat"),o()(Le,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}})}).call(this,a(30))},1410:function(e,t,a){"use strict";var n=a(88),i=a.n(n),s=a(635),o=a(96),r=a(92);const c={deferredAction:null};class l extends s.Store{constructor(){super(r.a),i()(this,"state",c)}setState(e){this.state=Object.assign(this.state,e),this.__emitChange()}__onDispatch(e){switch(e.action){case o.a.DoAfterSyncPrepared:this.setState({deferredAction:e.deferred_action});break;case"cancel_after_sync_prepared":this.setState({deferredAction:null});break;case"MatrixActions.sync":{if("PREPARED"!==e.state)break;if(!this.state.deferredAction)break;const t=Object.assign({},this.state.deferredAction);this.setState({deferredAction:null}),r.a.dispatch(t);break}case"on_client_not_viable":case o.a.OnLoggedOut:this.reset()}}reset(){this.state=Object.assign({},c)}}let d=null;d||(d=new l)},1411:function(e,t,a){"use strict";var n=a(88),i=a.n(n),s=a(120),o=a(7),r=a(98),c=a(338),l=a(92),d=a(167),m=a(93),h=a(96);function u(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function p(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?u(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):u(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class g extends d.a{constructor(){super(l.a,{reportedSessionIds:new Set,lastRageshakeTime:0,initialSyncCompleted:!1}),this.onDecryptionAttempt=this.onDecryptionAttempt.bind(this),this.onDeviceMessage=this.onDeviceMessage.bind(this),this.onSyncStateChange=this.onSyncStateChange.bind(this)}static get instance(){return g.internalInstance}async onAction(e){switch(e.action){case h.a.ReportKeyBackupNotEnabled:this.onReportKeyBackupNotEnabled()}}async onReady(){m.b.getValue("automaticDecryptionErrorReporting")&&this.matrixClient&&(this.matrixClient.on(s.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.on(s.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.on(s.ClientEvent.Sync,this.onSyncStateChange))}async onNotReady(){this.matrixClient&&(this.matrixClient.removeListener(s.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.removeListener(s.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.removeListener(s.ClientEvent.Sync,this.onSyncStateChange))}async onDecryptionAttempt(e){if(!this.state.initialSyncCompleted)return;const t=e.getWireContent(),a=t.session_id;if(e.isDecryptionFailure()&&!this.state.reportedSessionIds.has(a)){if(await Object(o.G)(5e3),!e.isDecryptionFailure())return;const n=new Set(this.state.reportedSessionIds);await this.updateState({reportedSessionIds:n.add(a)});const i=(new Date).getTime();if(i-this.state.lastRageshakeTime<6e4)return;await this.updateState({lastRageshakeTime:i});const s={event_id:e.getId(),room_id:e.getRoomId(),session_id:a,device_id:t.device_id,user_id:e.getSender(),sender_key:t.sender_key},l=await Object(c.a)(r.b.get().bug_report_endpoint_url,{userText:"Auto-reporting decryption error (recipient)",sendLogs:!0,labels:["Z-UISI","web","uisi-recipient"],customApp:r.b.get().uisi_autorageshake_app,customFields:{auto_uisi:JSON.stringify(s)}}),d=p(p({},s),{},{recipient_rageshake:l});this.matrixClient.sendToDevice("im.vector.auto_rs_request",{[d.user_id]:{[d.device_id]:d}})}}async onSyncStateChange(e,t,a){this.state.initialSyncCompleted||await this.updateState({initialSyncCompleted:!!a.nextSyncToken})}async onDeviceMessage(e){if("im.vector.auto_rs_request"!==e.getType())return;const t=e.getContent(),a=t.recipient_rageshake||"",n=(new Date).getTime();n-this.state.lastRageshakeTime>6e4&&(await this.updateState({lastRageshakeTime:n}),await Object(c.a)(r.b.get().bug_report_endpoint_url,{userText:"Auto-reporting decryption error (sender)\nRecipient rageshake: "+a,sendLogs:!0,labels:["Z-UISI","web","uisi-sender"],customApp:r.b.get().uisi_autorageshake_app,customFields:{recipient_rageshake:a,auto_uisi:JSON.stringify(t)}}))}async onReportKeyBackupNotEnabled(){m.b.getValue("automaticKeyBackNotEnabledReporting")&&await Object(c.a)(r.b.get().bug_report_endpoint_url,{userText:"Auto-reporting key backup not enabled",sendLogs:!0,labels:["web",h.a.ReportKeyBackupNotEnabled]})}}i()(g,"internalInstance",new g),window.mxAutoRageshakeStore=g.instance},1412:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n=a(88),i=a.n(n),s=a(8),o=a(111);class r extends s.EventEmitter{constructor(){super(...arguments),i()(this,"_isResizing",!1),i()(this,"throttledMiddlePanel",Object(o.throttle)(()=>this.emit("middlePanelResized"),200))}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0,this.emit("isResizing",!0)}stopResizing(){this._isResizing=!1,this.emit("isResizing",!1)}noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}updateMiddlePanel(){this.throttledMiddlePanel(),this.noisyMiddlePanel()}notifyLeftHandleResized(){this.updateMiddlePanel()}notifyRightHandleResized(){this.updateMiddlePanel()}notifyTimelineHeightChanged(){this.updateMiddlePanel()}notifyWindowResized(){this.updateMiddlePanel()}}},1413:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return w}));var n=a(88),i=a.n(n),s=a(87),o=a(94),r=a.n(o),c=a(92),l=a(89),d=a(91),m=a(96),h=a(189),u=a(792),p=a(114),g=a(131),b=a(171),v=a(192),f=a(93),E=a(95),y=a(817),_=a(109),S=a(160);class w extends s.PureComponent{constructor(t){super(t),i()(this,"dispatcherRef",void 0),i()(this,"betaRef",void 0),i()(this,"elementRef",Object(s.createRef)()),i()(this,"searchFilter",new u.a),i()(this,"onSpotlightChange",()=>{const e=f.b.getValue("feature_spotlight");this.state.spotlightBetaEnabled!==e&&this.setState({spotlightBetaEnabled:e,query:""}),S.a.sharedInstance().dismissToast("BETA_SPOTLIGHT_TOAST")}),i()(this,"onAction",e=>{e.action===m.a.ViewRoom&&e.clear_search?this.clearInput():"focus_room_filter"===e.action&&(this.state.spotlightBetaEnabled?this.openSpotlight():this.focus())}),i()(this,"clearInput",()=>{var e;"INPUT"===(null===(e=this.elementRef.current)||void 0===e?void 0:e.tagName)&&(this.elementRef.current.value="",this.onChange())}),i()(this,"openSearch",()=>{this.state.spotlightBetaEnabled?this.openSpotlight():c.a.dispatch({action:"focus_room_filter"})}),i()(this,"onChange",()=>{var e;"INPUT"===(null===(e=this.elementRef.current)||void 0===e?void 0:e.tagName)&&this.setState({query:this.elementRef.current.value})}),i()(this,"onFocus",e=>{this.setState({focused:!0}),e.target.select()}),i()(this,"onBlur",e=>{this.setState({focused:!1})}),i()(this,"onKeyDown",t=>{switch(Object(p.a)().getRoomListAction(t)){case _.h.ClearRoomFilter:this.clearInput(),c.a.fire(m.a.FocusSendMessageComposer);break;case _.h.SelectRoomInRoomList:this.props.onSelectRoom()&&e(()=>{this.clearInput()});break}}),i()(this,"focus",()=>{var e;null===(e=this.elementRef.current)||void 0===e||e.focus()}),this.state={query:"",focused:!1,spotlightBetaEnabled:f.b.getValue("feature_spotlight")},this.dispatcherRef=c.a.register(this.onAction),g.a.instance.on(b.d,this.clearInput),this.betaRef=f.b.watchSetting("feature_spotlight",null,this.onSpotlightChange)}componentDidUpdate(e,t){if(t.query!==this.state.query){const e=!!this.searchFilter.search.trim(),t=!!this.state.query.trim();this.searchFilter.search=this.state.query,!e&&t?h.b.instance.addFilter(this.searchFilter):e&&!t&&h.b.instance.removeFilter(this.searchFilter)}}componentWillUnmount(){c.a.unregister(this.dispatcherRef),g.a.instance.off(b.d,this.clearInput),f.b.unwatchSetting(this.betaRef)}openSpotlight(){E.a.createTrackedDialog("Spotlight","",y.a,{},"mx_SpotlightDialog_wrapper",!1,!0)}render(){const e=r()({mx_RoomSearch:!0,mx_RoomSearch_hasQuery:this.state.query,mx_RoomSearch_focused:this.state.focused,mx_RoomSearch_minimized:this.props.isMinimized,mx_RoomSearch_spotlightTrigger:this.state.spotlightBetaEnabled}),t=r()({mx_RoomSearch_input:!0,mx_RoomSearch_inputExpanded:this.state.query||this.state.focused}),a=s.createElement("div",{className:"mx_RoomSearch_icon"});let n=s.createElement("input",{type:"text",ref:this.elementRef,className:t,value:this.state.query,onFocus:this.onFocus,onBlur:this.onBlur,onChange:this.onChange,onKeyDown:this.onKeyDown,placeholder:Object(l.a)("Filter"),autoComplete:"off"}),i=s.createElement("div",{className:"mx_RoomSearch_shortcutPrompt"},v.a?"⌘ K":Object(l.a)(_.a[v.b.CONTROL])+" K");return this.props.isMinimized&&(n=null,i=null),this.state.spotlightBetaEnabled?s.createElement(d.a,{onClick:this.openSpotlight,className:e,inputRef:this.elementRef},a,n&&s.createElement("div",{className:"mx_RoomSearch_spotlightTriggerText"},Object(l.a)("Search")),i):this.props.isMinimized?s.createElement(d.a,{onClick:this.openSearch,className:"mx_RoomSearch mx_RoomSearch_minimized",title:Object(l.a)("Filter rooms and people"),inputRef:this.elementRef},a):s.createElement("div",{className:e,onClick:this.focus},a,n,i,s.createElement(d.a,{tabIndex:-1,title:Object(l.a)("Clear filter"),className:"mx_RoomSearch_clearButton",onClick:this.clearInput}))}appendChar(e){this.setState({query:this.state.query+e})}backspace(){this.setState({query:this.state.query.substring(0,this.state.query.length-1)})}}}).call(this,a(179).setImmediate)},1414:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M15 9a6 6 0 01-6 6v-2a4 4 0 000-8V3a6 6 0 016 6zM9 5a4 4 0 100 8V5zm8 4A8 8 0 111 9a8 8 0 0116 0z",fill:"#000"})))}t.default="img/element-icons/roomlist/dark-light-mode.f72b785.svg"},1442:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return c}));var n,i,s,o=a(87);function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function c(e){return o.createElement("svg",r({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),o.createElement("g",{clipPath:"url(#default_app_svg__clip0)"},n||(n=o.createElement("rect",{width:20,height:20,rx:4,fill:"url(#default_app_svg__paint0_linear)"})),o.createElement("path",{d:"M2.496 0v20M20 2.5H0M20 10H0M20 17.5H0M10 0v20M17.496 0v20",stroke:"#fff",strokeOpacity:.5,style:{mixBlendMode:"lighten"}}),i||(i=o.createElement("circle",{opacity:.8,cx:10,cy:10,r:7.5,stroke:"#fff"}))),s||(s=o.createElement("defs",null,o.createElement("linearGradient",{id:"default_app_svg__paint0_linear",x1:10,y1:0,x2:10,y2:20,gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#60A6FF"}),o.createElement("stop",{offset:1,stopColor:"#418DED"})),o.createElement("clipPath",{id:"default_app_svg__clip0"},o.createElement("rect",{width:20,height:20,rx:4,fill:"#fff"})))))}t.default="img/element-icons/room/default_app.2034d23.svg"},1443:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return r}));var n,i,s=a(87);function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),n||(n=s.createElement("rect",{width:20,height:20,rx:4,fill:"#5ABFF2"})),i||(i=s.createElement("path",{d:"M3 7.875C3 6.839 3.84 6 4.875 6h6.313c1.035 0 1.874.84 1.874 1.875v5c0 1.036-.839 1.875-1.874 1.875H4.875A1.875 1.875 0 013 12.875v-5zM14.375 8.446l1.746-1.336a.547.547 0 01.879.435v5.495c0 .48-.575.727-.923.396l-1.702-1.615V8.446z",fill:"#fff"})))}t.default="img/element-icons/room/default_video.66250a4.svg"},1444:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return l}));var n,i,s,o,r=a(87);function c(){return(c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function l(e){return r.createElement("svg",c({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),n||(n=r.createElement("rect",{width:20,height:20,rx:4,fill:"#FF5B55"})),i||(i=r.createElement("path",{d:"M2 7h16v9a2 2 0 01-2 2H4a2 2 0 01-2-2V7z",fill:"#fff"})),s||(s=r.createElement("rect",{x:3.968,y:9,width:2.997,height:3,rx:.25,fill:"#FF5B55"})),o||(o=r.createElement("rect",{x:10.961,y:13,width:2.997,height:3,rx:.25,fill:"#FF5B55"})))}t.default="img/element-icons/room/default_cal.13af0ea.svg"},1445:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return r}));var n,i,s=a(87);function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),n||(n=s.createElement("rect",{width:20,height:20,rx:4,fill:"#FCC639"})),i||(i=s.createElement("path",{d:"M2 7h16v9a2 2 0 01-2 2H4a2 2 0 01-2-2V7z",fill:"#fff"})))}t.default="img/element-icons/room/default_doc.02ee63f.svg"},1446:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return c}));var n,i,s,o=a(87);function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function c(e){return o.createElement("svg",r({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),n||(n=o.createElement("rect",{x:1,y:1,width:18,height:18,rx:3,fill:"#17191C",stroke:"#17191C",strokeWidth:2})),i||(i=o.createElement("path",{d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0z",fill:"#fff"})),s||(s=o.createElement("path",{d:"M10 6v3.813l2.5 1.687",stroke:"#000",strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})))}t.default="img/element-icons/room/default_clock.e3e0f9b.svg"},1447:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return I}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(150),c=a.n(r),l=a(108),d=a(1448),m=a(97),h=a(0),u=a(566),p=a(93),g=a(128),b=a(157),v=a(574),f=a(133),E=a(132),y=a(89),_=a(221),S=a(355),w=a(431),C=a(148),O=a(100),k=a(1451),x=a(287),R=a(198),j=a(1453);class I extends u.a{constructor(e,t,a,n){super(e,t,a,n),i()(this,"avatars",void 0),i()(this,"permalinkCreator",void 0),i()(this,"totalSize",void 0),i()(this,"mediaOmitText",void 0),i()(this,"threadsEnabled",void 0),this.avatars=new Map,this.permalinkCreator=new E.a(this.room),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?Object(y.a)("Media omitted - file size limit exceeded"):Object(y.a)("Media omitted"),this.threadsEnabled=p.b.getValue("feature_thread")}async getRoomAvatar(){let e;const t=_.b(this.room,32,32,"crop");if(t)try{const a=await fetch(t);e=await a.blob(),this.totalSize+=e.size,this.addFile("room.png",e)}catch(e){h.a.log("Failed to fetch room's avatar"+e)}const a=o.a.createElement(C.a,{width:32,height:32,name:this.room.name,title:this.room.name,url:e?"room.png":null,resizeMethod:"crop"});return Object(d.renderToStaticMarkup)(a)}async wrapHTML(e){var t,a,n,i,s,r,c;const l=await this.getRoomAvatar(),h=Object(f.f)(new Date),u=null===(t=this.room.currentState.getStateEvents(m.b.RoomCreate,""))||void 0===t?void 0:t.getSender(),p=(null===(a=this.room)||void 0===a||null===(n=a.getMember(u))||void 0===n?void 0:n.rawDisplayName)||u,g=this.client.getUserId(),b=null===(i=this.room)||void 0===i||null===(s=i.getMember(g))||void 0===s?void 0:s.rawDisplayName,v=(null===(r=this.room.currentState.getStateEvents(m.b.RoomTopic,""))||void 0===r||null===(c=r.getContent())||void 0===c?void 0:c.topic)||"",E=Object(y.a)("%(creatorName)s created this room.",{creatorName:p}),_=Object(d.renderToStaticMarkup)(o.a.createElement("p",null,Object(y.a)("This is the start of export of <roomName/>. Exported by <exporterDetails/> at %(exportDate)s.",{exportDate:h},{roomName:()=>o.a.createElement("b",null,this.room.name),exporterDetails:()=>o.a.createElement("a",{href:"https://matrix.to/#/"+g,target:"_blank",rel:"noopener noreferrer"},b?o.a.createElement(o.a.Fragment,null,o.a.createElement("b",null,b)," ("+g+")"):o.a.createElement("b",null,g))}))),S=v?Object(y.a)("Topic: %(topic)s",{topic:v}):"";return`\n          <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8" />\n                <meta http-equiv="X-UA-Compatible" content="IE=edge" />\n                <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n                <link href="css/style.css" rel="stylesheet" />\n                <script src="js/script.js"><\/script>\n                <title>Exported Data</title>\n            </head>\n            <body style="height: 100vh;">\n                <section\n                id="matrixchat"\n                style="height: 100%; overflow: auto"\n                class="notranslate"\n                >\n                <div class="mx_MatrixChat_wrapper" aria-hidden="false">\n                    <div class="mx_MatrixChat">\n                    <main class="mx_RoomView">\n                        <div class="mx_RoomHeader light-panel">\n                        <div class="mx_RoomHeader_wrapper" aria-owns="mx_RightPanel">\n                            <div class="mx_RoomHeader_avatar">\n                            <div class="mx_DecoratedRoomAvatar">\n                               ${l}\n                            </div>\n                            </div>\n                            <div class="mx_RoomHeader_name">\n                            <div\n                                dir="auto"\n                                class="mx_RoomHeader_nametext"\n                                title="${this.room.name}"\n                            >\n                                ${this.room.name}\n                            </div>\n                            </div>\n                            <div class="mx_RoomHeader_topic" dir="auto"> ${v} </div>\n                        </div>\n                        </div>\n                        <div class="mx_MainSplit">\n                        <div class="mx_RoomView_body">\n                            <div\n                            class="mx_RoomView_timeline mx_RoomView_timeline_rr_enabled"\n                            >\n                            <div\n                                class="\n                                mx_AutoHideScrollbar\n                                mx_ScrollPanel\n                                mx_RoomView_messagePanel\n                                mx_GroupLayout\n                                "\n                            >\n                                <div class="mx_RoomView_messageListWrapper">\n                                <ol\n                                    class="mx_RoomView_MessageList"\n                                    aria-live="polite"\n                                    role="list"\n                                >\n                                <div class="mx_NewRoomIntro">\n                                    ${l}\n                                    <h2> ${this.room.name} </h2>\n                                    <p> ${E} <br/><br/> ${_} </p>\n                                    <br/>\n                                    <p> ${S} </p>\n                                </div>\n                                ${e}\n                                </ol>\n                                </div>\n                            </div>\n                            </div>\n                            <div class="mx_RoomView_statusArea">\n                            <div class="mx_RoomView_statusAreaBox">\n                                <div class="mx_RoomView_statusAreaBox_line"></div>\n                            </div>\n                            </div>\n                        </div>\n                        </div>\n                    </main>\n                    </div>\n                </div>\n                </section>\n                <div id="snackbar"/>\n            </body>\n        </html>`}getAvatarURL(e){const t=e.sender;return t.getMxcAvatarUrl()&&Object(g.b)(t.getMxcAvatarUrl()).getThumbnailOfSourceHttp(30,30,"crop")}async saveAvatarIfNeeded(e){const t=e.sender;if(!this.avatars.has(t.userId))try{const a=this.getAvatarURL(e);this.avatars.set(t.userId,!0);const n=await fetch(a),i=await n.blob();this.addFile(`users/${t.userId.replace(/:/g,"-")}.png`,i)}catch(e){h.a.log("Failed to fetch user's avatar"+e)}}getDateSeparator(e){const t=e.getTs(),a=o.a.createElement("li",{key:t},o.a.createElement(w.a,{forExport:!0,key:t,roomId:e.getRoomId(),ts:t}));return Object(d.renderToStaticMarkup)(a)}needsDateSeparator(e,t){return null==t||Object(f.l)(t.getDate(),e.getDate())}getEventTile(e,t){return o.a.createElement("div",{className:"mx_Export_EventWrapper",id:e.getId()},o.a.createElement(O.a.Provider,{value:this.client},o.a.createElement(S.a,{mxEvent:e,continuation:t,isRedacted:e.isRedacted(),replacingEventId:e.replacingEventId(),forExport:!0,readReceipts:null,alwaysShowTimestamps:!0,readReceiptMap:null,showUrlPreview:!1,checkUnmounting:()=>!1,isTwelveHour:!1,last:!1,lastInSection:!1,permalinkCreator:this.permalinkCreator,lastSuccessful:!1,isSelectedEvent:!1,getRelationsForEvent:null,showReactions:!1,layout:b.a.Group,showReadReceipts:!1})))}async getEventTileMarkup(e,t,a){const n=!!this.getAvatarURL(e);n&&await this.saveAvatarIfNeeded(e);const i=this.getEventTile(e,t);let s;if(e.getContent().msgtype==m.c.Emote||e.getContent().msgtype==m.c.Notice||e.getContent().msgtype===m.c.Text){const e=document.createElement("div");c.a.render(i,e),s=e.innerHTML}else s=Object(d.renderToStaticMarkup)(i);if(a){var o;const t=e.getContent().url||(null===(o=e.getContent().file)||void 0===o?void 0:o.url);s=s.split(t).join(a)}return s=s.replace(/<span class="mx_MFileBody_info_icon".*?>.*?<\/span>/,""),n&&(s=s.replace(encodeURI(this.getAvatarURL(e)).replace(/&/g,"&amp;"),`users/${e.sender.userId.replace(/:/g,"-")}.png`)),s}createModifiedEvent(e,t){const a={msgtype:"m.text",body:""+e,format:"org.matrix.custom.html",formatted_body:""+e};(!(arguments.length>2&&void 0!==arguments[2])||arguments[2])&&(a.formatted_body="<em>"+a.formatted_body+"</em>",a.body="*"+a.body+"*");const n=new l.b;return n.event=t.event,n.sender=t.sender,n.event.type="m.room.message",n.event.content=a,n}async createMessageBody(e){let t,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const n=await this.getMediaBlob(e);if(this.totalSize+n.size>this.exportOptions.maxSize)t=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),a);else{this.totalSize+=n.size;const i=this.getFilePath(e);t=await this.getEventTileMarkup(e,a,i),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(i,n)}}catch(n){h.a.log("Error while fetching file"+n),t=await this.getEventTileMarkup(this.createModifiedEvent(Object(y.a)("Error fetching file"),e),a)}else t=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),a);else t=await this.getEventTileMarkup(e,a)}catch(n){h.a.error(n),t=await this.getEventTileMarkup(this.createModifiedEvent(Object(x.b)(e),e,!1),a)}return t}async createHTML(t,a){let n="",i=null;for(let s=a;s<Math.min(a+1e3,t.length);s++){const a=t[s];if(this.updateProgress(Object(y.a)("Processing event %(number)s out of %(total)s",{number:s+1,total:t.length}),!1,!0),this.cancelled)return this.cleanUp();if(!Object(R.c)(a,!1))continue;n+=this.needsDateSeparator(a,i)?this.getDateSeparator(a):"";const o=!this.needsDateSeparator(a,i)&&Object(v.b)(i,a,!1,this.threadsEnabled),r=await this.createMessageBody(a,o);this.totalSize+=e.byteLength(r),n+=r,i=a}return this.wrapHTML(n)}async export(){this.updateProgress(Object(y.a)("Starting export..."));const e=performance.now(),t=await this.getRequiredEvents(),a=performance.now();this.updateProgress(Object(y.a)("Fetched %(count)s events in %(seconds)ss",{count:t.length,seconds:(a-e)/1e3}),!0,!1),this.updateProgress(Object(y.a)("Creating HTML..."));const n=new Set;for(let e=0;e<t.length/1e3;e++){const a=await this.createHTML(t,1e3*e);(new DOMParser).parseFromString(a,"text/html").querySelectorAll("*").forEach(e=>{e.classList.forEach(e=>n.add(e))}),this.addFile(`messages${e?e+1:""}.html`,new Blob([a]))}const i=await Object(k.a)(n);this.addFile("css/style.css",new Blob([i])),this.addFile("js/script.js",new Blob([j.a])),await this.downloadZIP();const s=performance.now();this.cancelled?h.a.info("Export cancelled successfully"):(this.updateProgress(Object(y.a)("Export successful!")),this.updateProgress(Object(y.a)("Exported %(count)s events in %(seconds)s seconds",{count:t.length,seconds:(s-e)/1e3}))),this.cleanUp()}}}).call(this,a(31).Buffer)},1450:function(e,t,a){"use strict";(function(e){var n=a(87),i=a.n(n),s=a(97),o=a(100),r=a(106),c=a(135),l=a(89),d=a(91),m=a(815),h=a(130),u=a(92),p=a(96),g=a(131),b=a(213),v=a(268),f=a(356),E=a(90),y=a(185),_=a(122),S=a(264);t.a=()=>{const t=Object(n.useContext)(o.a),{room:a,roomId:w}=Object(n.useContext)(r.b),C=c.a.shared().getUserIdForRoomId(w);let O;if(C){let e;a.getJoinedMemberCount()+a.getInvitedMemberCount()===2&&(e=Object(l.a)("Only the two of you are in this conversation, unless either of you invites anyone to join."));const t=null==a?void 0:a.getMember(C),n=(null==t?void 0:t.rawDisplayName)||C;O=i.a.createElement(i.a.Fragment,null,i.a.createElement(h.a,{room:a,width:m.a,height:m.a,onClick:()=>{u.a.dispatch({action:p.a.ViewUser,member:t||{userId:C}})}}),i.a.createElement("h2",null,a.name),i.a.createElement("p",null,Object(l.a)("This is the beginning of your direct message history with <displayName/>.",{},{displayName:()=>i.a.createElement("b",null,n)})),e&&i.a.createElement("p",null,e))}else{var k,x,R,j,I,T,N;const n=a&&"join"===a.getMyMembership(),o=null===(k=a.currentState.getStateEvents(s.b.RoomTopic,""))||void 0===k||null===(x=k.getContent())||void 0===x?void 0:x.topic,r=n&&a.currentState.maySendStateEvent(s.b.RoomTopic,t.getUserId()),c=()=>{u.a.dispatch({action:"open_room_settings",room_id:w},!0),e(()=>{window.document.getElementById("profileTopic").focus()})};let p;r&&o?p=Object(l.a)("Topic: %(topic)s (<a>edit</a>)",{topic:o},{a:e=>i.a.createElement(d.a,{kind:"link",onClick:c},e)}):o?p=Object(l.a)("Topic: %(topic)s ",{topic:o}):r&&(p=Object(l.a)("<a>Add a topic</a> to help people know what it is about.",{},{a:e=>i.a.createElement(d.a,{kind:"link",element:"span",onClick:c},e)}));const v=null===(R=a.currentState.getStateEvents(s.b.RoomCreate,""))||void 0===R?void 0:R.getSender(),f=(null==a||null===(j=a.getMember(v))||void 0===j?void 0:j.rawDisplayName)||v;let E,S,C;E=v===t.getUserId()?Object(l.a)("You created this room."):Object(l.a)("%(displayName)s created this room.",{displayName:f}),null!==(I=g.a.instance.activeSpaceRoom)&&void 0!==I&&I.canInvite(t.getUserId())&&g.a.instance.isRoomInSpace(g.a.instance.activeSpace,a.roomId)&&(S=g.a.instance.activeSpaceRoom),S&&Object(y.a)(_.a.InviteUsers)?C=i.a.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{Object(b.i)(S)}},Object(l.a)("Invite to %(spaceName)s",{spaceName:S.name})),a.canInvite(t.getUserId())&&i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary_outline",onClick:()=>{u.a.dispatch({action:"view_invite",roomId:w})}},Object(l.a)("Invite to just this room"))):a.canInvite(t.getUserId())&&Object(y.a)(_.a.InviteUsers)&&(C=i.a.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{u.a.dispatch({action:"view_invite",roomId:w})}},Object(l.a)("Invite to this room"))));const P=null===(T=a.currentState.getStateEvents(s.b.RoomAvatar,""))||void 0===T||null===(N=T.getContent())||void 0===N?void 0:N.url;O=i.a.createElement(i.a.Fragment,null,i.a.createElement(m.b,{hasAvatar:!!P,noAvatarLabel:Object(l.a)("Add a photo, so people can easily spot your room."),setAvatarUrl:e=>t.sendStateEvent(w,s.b.RoomAvatar,{url:e},"")},i.a.createElement(h.a,{room:a,width:m.a,height:m.a,viewAvatarOnClick:!0})),i.a.createElement("h2",null,a.name),i.a.createElement("p",null,E," ",Object(l.a)("This is the start of <roomName/>.",{},{roomName:()=>i.a.createElement("b",null,a.name)})),i.a.createElement("p",null,p),C)}const P=Object(l.a)("Your private messages are normally encrypted, but this room isn't. Usually this is due to an unsupported device or method being used, like email invites.");let M;a.currentState.mayClientSendStateEvent(s.b.RoomEncryption,E.a.get())&&(M=i.a.createElement(d.a,{kind:"link_inline",onClick:function(e){e.preventDefault(),u.a.dispatch({action:"open_room_settings",initial_tab_id:f.b})}},Object(l.a)("Enable encryption in settings.")));const D=i.a.createElement("span",null," ",P," ",M," ");return i.a.createElement("div",{className:"mx_NewRoomIntro"},!function(e,t){const a=e.isRoomEncrypted(t.roomId);return"public"===t.getJoinRule()||!Object(S.c)()||a}(t,a)&&i.a.createElement(v.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon_warning",title:Object(l.a)("End-to-end encryption isn't enabled"),subtitle:D}),O)}}).call(this,a(179).setImmediate)},1451:function(e,t,a){"use strict";var n=a(1452);const i=/\.[\w-]+/g;function s(e){return e.replace(/font-family: ?(Inter|'Inter'|"Inter")/g,"font-family: -apple-system, BlinkMacSystemFont, avenir next,\n            avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif").replace(/font-family: ?Inconsolata/g,"font-family: Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace")}function o(e){var t;return"light"===(null===(t=e.ownerNode.dataset.mxTheme)||void 0===t?void 0:t.toLowerCase())}t.a=async e=>{const t=Array.from(document.styleSheets).filter(e=>{var t;return(null===(t=e.href)||void 0===t?void 0:t.endsWith("bundle.css"))||o(e)});if(!t.some(o)){const e=document.querySelector('link[rel="stylesheet"][href$="theme-light.css"]').href;t.push(await async function(e){const t=document.implementation.createHTMLDocument(""),a=document.createElement("style"),n=await fetch(e);return a.textContent=await n.text(),t.body.appendChild(a),a.sheet}(e))}let a="";for(const n of t)for(const t of n.cssRules){if(t instanceof CSSFontFaceRule)continue;const n=t.selectorText;null!=n&&n.split(",").every(t=>{const a=t.match(i);if(a&&!a.every(t=>e.has(t.substring(1))))return!0})||(a+=s(t.cssText)+"\n")}return a+n.a}},1453:function(e,t,a){"use strict";t.a='/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the "License");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\nhttp://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n// This file is raw-imported (imported as plain text) for the export bundle, which is why this is in JS\nfunction showToastIfNeeded(replyId) {\n    const el = document.getElementById(replyId);\n    if (!el) {\n        showToast("The message you\'re looking for wasn\'t exported");\n        return;\n    }\n}\n\nfunction showToast(text) {\n    const el = document.getElementById("snackbar");\n    el.innerHTML = text;\n    el.className = "mx_show";\n    setTimeout(() => {\n        el.className = el.className.replace("mx_show", "");\n    }, 2000);\n}\n\nwindow.onload = () => {\n    document.querySelectorAll(\'.mx_reply_anchor\').forEach(element => {\n        element.addEventListener(\'click\', event => {\n            showToastIfNeeded(event.target.getAttribute("scroll-to"));\n        });\n    });\n};\n\n'},1454:function(e,t,a){"use strict";(function(e){var n=a(87),i=a.n(n),s=a(0),o=a(144),r=a(97),c=a(89),l=a(92),d=a(96),m=a(101),h=a(212),u=a(110),p=a(141);t.a=t=>{const{matrixClient:a,room:g,member:b,onFinished:v}=t,[f,E]=Object(n.useState)(!0);let y=g.getLiveTimeline(),_=[];for(;y;)_=[..._,...y.getEvents().filter(e=>e.getSender()===b.userId&&!e.isRedacted()&&!e.isRedaction()&&e.getType()!==r.b.RoomCreate&&e.getType()!==r.b.RoomServerAcl&&e.getType()!==r.b.RoomEncryption)],y=y.getNeighbouringTimeline(o.b.BACKWARDS);if(0===_.length)return i.a.createElement(h.a,{onFinished:v,title:Object(c.a)("No recent messages by %(user)s found",{user:b.name}),description:i.a.createElement("div",null,i.a.createElement("p",null,Object(c.a)("Try scrolling up in the timeline to see if there are any earlier ones.")))});{_=_.filter(e=>!(f&&e.isState()));const t=_.length,n=b.name,o=async()=>{s.a.info(`Started redacting recent ${t} messages for ${b.userId} in ${g.roomId}`),l.a.dispatch({action:d.a.BulkRedactStart,room_id:g.roomId}),await Promise.resolve(),await Promise.all(_.reverse().map(async e=>{try{await a.redactEvent(g.roomId,e.getId())}catch(t){s.a.error("Could not redact",e.getId()),s.a.error(t)}})),s.a.info(`Finished redacting recent ${t} messages for ${b.userId} in ${g.roomId}`),l.a.dispatch({action:d.a.BulkRedactEnd,room_id:g.roomId})};return i.a.createElement(m.a,{className:"mx_BulkRedactDialog",onFinished:v,title:Object(c.a)("Remove recent messages by %(user)s",{user:n}),contentId:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.a.createElement("p",null,Object(c.a)("You are about to remove %(count)s messages by %(user)s. This will remove them permanently for everyone in the conversation. Do you wish to continue?",{count:t,user:n})),i.a.createElement("p",null,Object(c.a)("For a large amount of messages, this might take some time. Please don't refresh your client in the meantime.")),i.a.createElement(p.b,{checked:f,onChange:e=>E(e.target.checked)},Object(c.a)("Preserve system messages")),i.a.createElement("div",{className:"mx_BulkRedactDialog_checkboxMicrocopy"},Object(c.a)("Uncheck if you also want to remove system messages on this user (e.g. membership change, profile change…)"))),i.a.createElement(u.a,{primaryButton:Object(c.a)("Remove %(count)s messages",{count:t}),primaryButtonClass:"danger",primaryDisabled:0===t,onPrimaryButtonClick:()=>{e(o),v(!0)},onCancel:()=>v(!1)}))}}}).call(this,a(179).setImmediate)},1455:function(e,t){e.exports="img/stickerpack-placeholder.9c54c13.png"},1456:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return p}));var n,i,s,o,r,c,l,d,m,h=a(87);function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function p(e){return h.createElement("svg",u({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 31 31",role:"presentation","aria-hidden":!0},e),n||(n=h.createElement("path",{fill:"none",d:"M0 0h31v31H0z"})),i||(i=h.createElement("circle",{cx:15.5,cy:15.5,r:15.5,fill:"#A2A2A2"})),s||(s=h.createElement("path",{d:"M22.855 15.5a7.355 7.355 0 11-14.71 0 7.355 7.355 0 0114.71 0zM15.5 24.25a8.75 8.75 0 100-17.5 8.75 8.75 0 000 17.5z",fill:"#fff",stroke:"#fff",strokeWidth:.5})),o||(o=h.createElement("path",{fill:"#A2A2A2",d:"M16.266 30.503h-1.5L14.76 1.1h1.5z"})),r||(r=h.createElement("path",{fill:"#A2A2A2",d:"M8.894 28.844l-1.294-.76L22.605 2.503l1.294.759z"})),c||(c=h.createElement("path",{fill:"#A2A2A2",d:"M2.88 24.495l-.786-1.278L27.71 7.46l.786 1.277z"})),l||(l=h.createElement("path",{fill:"#A2A2A2",d:"M2.163 23.341L1.49 22l26.51-13.264.671 1.341z"})),d||(d=h.createElement("path",{fill:"#A2A2A2",d:"M1.551 22.134L1 20.74 28.433 9.887l.552 1.394z"})),m||(m=h.createElement("path",{d:"M9.5 17l-2 3-2-3h4zM21.5 15l2-3 2 3h-4z",fill:"#fff",stroke:"#fff"})))}t.default="img/room_replaced.80042bb.svg"},1457:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M16 0C7.163 0 0 7.163 0 16s7.163 16 16 16 16-7.163 16-16S24.837 0 16 0zm1.251 6.974a1.496 1.496 0 00-2.051-.129 1.495 1.495 0 00-.13.12l-6.274 6.589a1.5 1.5 0 102.173 2.069l3.688-3.873V23.06a1.5 1.5 0 103 0V11.75l3.688 3.873a1.5 1.5 0 102.173-2.07L17.25 6.975z",fill:"#0DBD8B"})))}t.default="img/upload-big.cdac3ea.svg"},1458:function(e,t,a){var n={"./":[232,9],"./ICanvasEffect":[839,7,8],"./ICanvasEffect.ts":[839,7,8],"./confetti":[419,9,0],"./confetti/":[419,9,0],"./confetti/index":[419,9,0],"./confetti/index.ts":[419,9,0],"./effect":[840,9,9],"./effect.ts":[840,9,9],"./fireworks":[420,9,1],"./fireworks/":[420,9,1],"./fireworks/index":[420,9,1],"./fireworks/index.ts":[420,9,1],"./hearts":[421,9,2],"./hearts/":[421,9,2],"./hearts/index":[421,9,2],"./hearts/index.ts":[421,9,2],"./index":[232,9],"./index.ts":[232,9],"./rainfall":[422,9,3],"./rainfall/":[422,9,3],"./rainfall/index":[422,9,3],"./rainfall/index.ts":[422,9,3],"./snowfall":[423,9,4],"./snowfall/":[423,9,4],"./snowfall/index":[423,9,4],"./snowfall/index.ts":[423,9,4],"./spaceinvaders":[424,9,5],"./spaceinvaders/":[424,9,5],"./spaceinvaders/index":[424,9,5],"./spaceinvaders/index.ts":[424,9,5],"./utils":[345,9],"./utils.ts":[345,9]};function i(e){if(!a.o(n,e))return Promise.resolve().then((function(){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=n[e],i=t[0];return Promise.all(t.slice(2).map(a.e)).then((function(){return a.t(i,t[1])}))}i.keys=function(){return Object.keys(n)},i.id=1458,e.exports=i},1459:function(e,t,a){"use strict";a.d(t,"c",(function(){return S})),a.d(t,"b",(function(){return w})),a.d(t,"a",(function(){return C}));var n=a(87),i=a.n(n),s=a(89),o=a(98),r=a(92),c=a(162),l=a(91),d=a(197),m=a(160),h=a(832),u=a(96),p=a(9);const g=()=>{r.a.dispatch({action:u.a.PseudonymousAnalyticsAccept})},b=()=>{r.a.dispatch({action:u.a.PseudonymousAnalyticsReject})},v=()=>{Object(h.b)({onFinished:e=>{e===h.a.Primary&&g()},primaryButton:Object(s.a)("Enable")})},f=()=>{Object(h.b)({onFinished:e=>{e===h.a.Primary?g():e===h.a.Cancel&&b()},primaryButton:Object(s.a)("That's fine"),cancelButton:Object(s.a)("Stop")})},E=()=>{c.a.showDetailsModal()},y=()=>{var e;const t=o.b.get().brand,a=o.b.get("piwik");let n;"object"==typeof a&&(n=new p.a(a));const r=null===(e=n)||void 0===e?void 0:e.get("policy_url");return Object(s.a)("Send <UsageDataLink>anonymous usage data</UsageDataLink> which helps us improve %(brand)s. This will use a <PolicyLink>cookie</PolicyLink>.",{brand:t},{UsageDataLink:e=>i.a.createElement(l.a,{kind:"link",onClick:E},e),PolicyLink:e=>r?i.a.createElement("a",{target:"_blank",href:r},e):e})},_=e=>{var t;const a=null!==(t=o.b.get("analytics_owner"))&&void 0!==t?t:o.b.get().brand;m.a.sharedInstance().addOrReplaceToast({key:"analytics",title:Object(s.a)("Help improve %(analyticsOwner)s",{analyticsOwner:a}),props:e,component:d.a,className:"mx_AnalyticsToast",priority:10})},S=e=>{let t;if(e)t={description:Object(s.a)("You previously consented to share anonymous usage data with us. We're updating how that works."),acceptLabel:Object(s.a)("That's fine"),onAccept:g,rejectLabel:Object(s.a)("Learn more"),onReject:f};else{if(null!=e)return;{const e=e=>i.a.createElement(l.a,{kind:"link",onClick:v},e);t={description:Object(s.a)("Share anonymous data to help us identify issues. Nothing personal. No third parties. <LearnMoreLink>Learn More</LearnMoreLink>",{},{LearnMoreLink:e}),acceptLabel:Object(s.a)("Yes"),onAccept:g,rejectLabel:Object(s.a)("No"),onReject:b}}}_(t)},w=()=>{const e={description:y(),acceptLabel:Object(s.a)("Yes"),onAccept:()=>r.a.dispatch({action:u.a.AnonymousAnalyticsAccept}),rejectLabel:Object(s.a)("No"),onReject:()=>r.a.dispatch({action:u.a.AnonymousAnalyticsReject})};_(e)},C=()=>{m.a.sharedInstance().dismissToast("analytics")}},1460:function(e,t,a){"use strict";a.d(t,"a",(function(){return m}));var n=a(88),i=a.n(n),s=a(87),o=a(91),r=a(105),c=a(547),l=a(793),d=a(156);class m extends s.PureComponent{constructor(e){super(e),i()(this,"numberEntryFieldRef",Object(s.createRef)()),i()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),i()(this,"onChange",e=>{this.setState({value:e.target.value})}),i()(this,"onFormSubmit",e=>{e.preventDefault(),this.onDialPress()}),i()(this,"onDigitPress",(e,t)=>{var a;(this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(a=this.numberEntryFieldRef.current)||void 0===a||a.focus())}),i()(this,"onDeletePress",e=>{var t;0!==this.state.value.length&&(this.setState({value:this.state.value.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))}),i()(this,"onDialPress",async()=>{d.b.instance.dialNumber(this.state.value),this.props.onFinished(!0)}),this.state={value:""}}render(){const e=s.createElement(l.a,{onBackspacePress:this.onDeletePress});let t;return t=0!==this.state.value.length?s.createElement(r.a,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange,postfixComponent:e}):s.createElement(r.a,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange}),s.createElement("div",{className:"mx_DialPadModal"},s.createElement("div",null,s.createElement(o.a,{className:"mx_DialPadModal_cancel",onClick:this.onCancelClick})),s.createElement("div",{className:"mx_DialPadModal_header"},s.createElement("form",{onSubmit:this.onFormSubmit},t)),s.createElement("div",{className:"mx_DialPadModal_dialPad"},s.createElement(c.a,{hasDial:!0,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress,onDialPress:this.onDialPress})))}}},1461:function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var n=a(89),i=a(197),s=a(160),o=a(98);const r=()=>{window.location.href="mobile_guide/"},c=()=>{document.cookie="element_mobile_redirect_to_guide=false;path=/;max-age=14400",d()},l=()=>{const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=/Android/.test(navigator.userAgent),a=o.b.get().brand;(e||t)&&(document.cookie.includes("element_mobile_redirect_to_guide=false")||s.a.sharedInstance().addOrReplaceToast({key:"mobileguide",title:Object(n.a)("Use app for a better experience"),props:{description:Object(n.a)("%(brand)s is experimental on a mobile web browser. For a better experience and the latest features, use our free native app.",{brand:a}),acceptLabel:Object(n.a)("Use app"),onAccept:r,rejectLabel:Object(n.a)("Dismiss"),onReject:c},component:i.a,priority:99}))},d=()=>{s.a.sharedInstance().dismissToast("mobileguide")}},1462:function(e,t,a){"use strict";var n=a(87),i=a.n(n),s=a(89),o=a(98),r=a(101),c=a(110),l=a(102);t.a=e=>{let{failures:t,source:a,continuation:d,onFinished:m}=e;const[h,u]=Object(n.useState)(2),[p,g]=Object(n.useState)(!1),[b,v]=Object(n.useState)(!1),[f,E]=Object(n.useState)(!1),y=Object(n.useRef)(m),_=new Map([["_afterCrossSigningLocalKeyChange",Object(s.a)("a new master key signature")],["checkOwnCrossSigningTrust",Object(s.a)("a new cross-signing key signature")],["setDeviceVerification",Object(s.a)("a device cross-signing signature")]]),S=Object(s.a)("a key signature"),w=Object(n.useCallback)(async()=>{try{v(!0);const e=new Promise((e,t)=>{y.current=t}).finally(()=>{g(!0)});await Promise.race([d(),e]),E(!0)}catch(e){u(e=>e-1)}finally{y.current=m,v(!1)}},[d,m]);let C;if(!f&&!p&&d&&h>0){const e=_.get(a)||S,n=o.b.get().brand;C=i.a.createElement("div",null,i.a.createElement("p",null,Object(s.a)("%(brand)s encountered an error during upload of:",{brand:n})),i.a.createElement("p",null,e),b&&i.a.createElement(l.a,null),i.a.createElement("pre",null,JSON.stringify(t,null,2)),i.a.createElement(c.a,{primaryButton:"Retry",hasCancel:!0,onPrimaryButtonClick:w,onCancel:y.current,primaryDisabled:b}))}else C=i.a.createElement("div",null,f?i.a.createElement("span",null,Object(s.a)("Upload completed")):p?i.a.createElement("span",null,Object(s.a)("Cancelled signature upload")):i.a.createElement("span",null,Object(s.a)("Unable to upload")),i.a.createElement(c.a,{primaryButton:Object(s.a)("OK"),hasCancel:!1,onPrimaryButtonClick:m}));return i.a.createElement(r.a,{title:f?Object(s.a)("Signature upload success"):Object(s.a)("Signature upload failed"),fixedWidth:!1,onFinished:()=>{}},C)}},1463:function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(89),c=a(557),l=a(803),d=a(91),m=a(836),h=a(275);class u extends o.a.Component{constructor(e){super(e),i()(this,"onStoreUpdate",()=>{const e=c.b.sharedInstance();this.setState({phase:e.phase,lostKeys:e.lostKeys()})}),i()(this,"onSkipClick",()=>{c.b.sharedInstance().skip()});const t=c.b.sharedInstance();t.on("update",this.onStoreUpdate),t.start(),this.state={phase:t.phase,lostKeys:t.lostKeys()}}componentWillUnmount(){const e=c.b.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const{phase:e,lostKeys:t}=this.state;let a,n,i;if(e===c.a.Loading)return null;if(e===c.a.Intro)t?(a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.a)("Unable to verify this device")):(a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.a)("Verify this device"));else if(e===c.a.Done)a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),n=Object(r.a)("Device verified");else if(e===c.a.ConfirmSkip)a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.a)("Are you sure?");else if(e===c.a.Busy)a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.a)("Verify this device");else if(e===c.a.ConfirmReset)a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.a)("Really reset verification keys?");else if(e!==c.a.Finished)throw new Error("Unknown phase "+e);return e!==c.a.Intro&&e!==c.a.ConfirmReset||(i=o.a.createElement(d.a,{onClick:this.onSkipClick,className:"mx_CompleteSecurity_skip","aria-label":Object(r.a)("Skip verification for now")})),o.a.createElement(h.a,null,o.a.createElement(m.a,null,o.a.createElement("h2",{className:"mx_CompleteSecurity_header"},a,n,i),o.a.createElement("div",{className:"mx_CompleteSecurity_body"},o.a.createElement(l.a,{onFinished:this.props.onFinished}))))}}},1464:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return g}));var n,i,s,o,r,c,l,d,m,h,u=a(87);function p(){return(p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function g(e){return u.createElement("svg",p({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 793.322 340.809",role:"presentation","aria-hidden":!0},e),n||(n=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M34.004 340.809H2a2 2 0 01-2-2V2a2 2 0 012-2h32.004a2 2 0 012 2v7.71a2 2 0 01-2 2h-21.13v317.386h21.13a2 2 0 012 2.001v7.712a2 2 0 01-2 2z"})),i||(i=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M10.875 9.711v321.386h23.13v7.711H1.999V2.001h32.006v7.71h-23.13zM252.402 233.711h-32.993a2 2 0 01-2-2v-68.073c0-3.949-.154-7.722-.457-11.213-.289-3.282-1.074-6.153-2.332-8.53-1.204-2.276-3.017-4.119-5.384-5.476-2.393-1.362-5.775-2.056-10.042-2.056-4.238 0-7.674.798-10.213 2.371-2.565 1.596-4.604 3.701-6.053 6.258-1.498 2.643-2.51 5.694-3.013 9.067a72.757 72.757 0 00-.793 10.741v66.91a2 2 0 01-2 2h-32.991a2 2 0 01-2-2v-67.373c0-3.435-.078-6.964-.228-10.485-.148-3.251-.767-6.278-1.841-8.995-1.018-2.571-2.667-4.584-5.047-6.153-2.372-1.552-6.029-2.341-10.865-2.341-1.372 0-3.265.328-5.629.976-2.28.624-4.536 1.826-6.705 3.577-2.152 1.732-4.036 4.306-5.605 7.655-1.569 3.356-2.367 7.877-2.367 13.438v69.701a2 2 0 01-2 2H68.857a2 2 0 01-2-2V111.594a2 2 0 012-1.999h31.13a2 2 0 012 1.999v11.007c3.834-4.499 8.248-8.152 13.173-10.896 6.396-3.559 13.799-5.362 22.002-5.362 7.846 0 15.127 1.548 21.642 4.604 5.794 2.722 10.424 7.26 13.791 13.52 3.449-4.362 7.833-8.306 13.071-11.752 6.422-4.228 14.102-6.371 22.824-6.371 6.499 0 12.625.807 18.209 2.399 5.686 1.628 10.635 4.271 14.712 7.857 4.088 3.605 7.318 8.357 9.601 14.123 2.25 5.719 3.391 12.649 3.391 20.604v80.384a2.002 2.002 0 01-2.001 2z"})),s||(s=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M99.988 111.595v16.264h.463c4.338-6.191 9.563-10.998 15.684-14.406 6.117-3.402 13.129-5.11 21.027-5.11 7.588 0 14.521 1.475 20.793 4.415 6.274 2.945 11.038 8.131 14.291 15.567 3.56-5.265 8.4-9.913 14.521-13.94 6.117-4.025 13.358-6.042 21.724-6.042 6.351 0 12.234.776 17.66 2.325 5.418 1.549 10.065 4.027 13.938 7.434 3.869 3.41 6.889 7.863 9.062 13.357 2.167 5.504 3.253 12.122 3.253 19.869v80.385H219.41v-68.074c0-4.025-.154-7.82-.465-11.385-.313-3.56-1.161-6.656-2.555-9.293-1.395-2.631-3.45-4.724-6.157-6.274-2.711-1.543-6.391-2.322-11.037-2.322s-8.403.896-11.269 2.671c-2.868 1.784-5.112 4.109-6.737 6.971-1.626 2.869-2.711 6.12-3.252 9.762a74.395 74.395 0 00-.814 11.035v66.91h-32.991v-67.375c0-3.562-.081-7.087-.23-10.57-.158-3.487-.814-6.7-1.978-9.645-1.162-2.94-3.099-5.304-5.809-7.088-2.711-1.775-6.699-2.671-11.965-2.671-1.551 0-3.603.349-6.156 1.048-2.556.697-5.036 2.016-7.435 3.949-2.404 1.938-4.454 4.726-6.158 8.363-1.705 3.642-2.556 8.402-2.556 14.287v69.701h-32.99V111.595h31.132zM304.909 236.733c-5.883 0-11.46-.729-16.574-2.163-5.192-1.464-9.806-3.774-13.713-6.871-3.944-3.117-7.068-7.111-9.282-11.871-2.205-4.733-3.324-10.412-3.324-16.876 0-7.13 1.293-13.117 3.846-17.797 2.542-4.674 5.877-8.464 9.912-11.263 3.97-2.752 8.556-4.842 13.63-6.209a142.954 142.954 0 0114.961-3.184 261.677 261.677 0 0114.754-1.872c4.679-.452 8.88-1.139 12.489-2.039 3.412-.854 6.118-2.09 8.042-3.672 1.666-1.37 2.416-3.384 2.292-6.151-.002-3.289-.502-5.816-1.492-7.595-.998-1.798-2.283-3.15-3.927-4.138-1.703-1.02-3.725-1.713-6.012-2.062-2.47-.37-5.146-.557-7.947-.557-6.034 0-10.789 1.271-14.135 3.783-3.233 2.424-5.155 6.64-5.714 12.527a2.003 2.003 0 01-1.992 1.812h-32.992a2.006 2.006 0 01-1.457-.629 2.013 2.013 0 01-.54-1.491c.485-8.073 2.55-14.894 6.142-20.272a41.725 41.725 0 0113.661-12.931c5.424-3.191 11.612-5.498 18.392-6.857a103.675 103.675 0 0120.26-2.013c6.096 0 12.365.437 18.626 1.296 6.377.88 12.285 2.622 17.562 5.177 5.376 2.604 9.845 6.29 13.282 10.951 3.498 4.744 5.271 11.048 5.271 18.731v62.494c0 5.307.306 10.462.915 15.319.576 4.64 1.572 8.116 2.963 10.338.385.616.407 1.395.055 2.031a2.002 2.002 0 01-1.75 1.03h-33.457c-.861 0-1.624-.55-1.898-1.367a49.145 49.145 0 01-1.572-5.936 49.182 49.182 0 01-.38-2.12 44.922 44.922 0 01-16.474 9.105 77.066 77.066 0 01-22.423 3.342zm37.032-60.072c-.809.409-1.676.768-2.596 1.074-2.161.72-4.511 1.326-6.988 1.807-2.442.475-5.033.872-7.699 1.186-2.631.311-5.251.697-7.784 1.146a56.995 56.995 0 00-7.051 1.792c-2.194.711-4.114 1.667-5.699 2.842-1.531 1.128-2.785 2.587-3.731 4.335-.917 1.709-1.385 3.97-1.385 6.719 0 2.598.465 4.778 1.385 6.481.928 1.722 2.142 3.035 3.716 4.018 1.644 1.026 3.601 1.757 5.816 2.17 2.344.439 4.799.663 7.297.663 6.105 0 10.836-.996 14.063-2.961 3.244-1.973 5.666-4.349 7.199-7.062 1.568-2.78 2.542-5.62 2.892-8.436.376-3.019.565-5.436.565-7.187v-8.587z"})),o||(o=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M273.544 129.255c3.405-5.113 7.744-9.215 13.012-12.316 5.264-3.097 11.186-5.303 17.771-6.621a101.17 101.17 0 0119.865-1.976c6.042 0 12.158.428 18.354 1.277 6.195.855 11.85 2.522 16.962 4.997 5.111 2.477 9.292 5.926 12.546 10.338 3.253 4.414 4.879 10.262 4.879 17.543v62.494c0 5.428.31 10.611.931 15.567.615 4.959 1.701 8.676 3.251 11.153H347.66a46.656 46.656 0 01-1.511-5.693 48.292 48.292 0 01-.813-5.923c-5.267 5.422-11.465 9.217-18.585 11.386a74.81 74.81 0 01-21.842 3.251c-5.733 0-11.077-.698-16.033-2.09-4.958-1.395-9.293-3.562-13.01-6.51-3.718-2.938-6.622-6.656-8.713-11.147s-3.138-9.84-3.138-16.033c0-6.813 1.199-12.43 3.604-16.84 2.399-4.417 5.495-7.939 9.295-10.575 3.793-2.632 8.129-4.607 13.01-5.923a140.326 140.326 0 0114.752-3.137 253.631 253.631 0 0114.638-1.857c4.801-.466 9.062-1.164 12.779-2.093 3.718-.929 6.658-2.282 8.829-4.065 2.165-1.781 3.172-4.375 3.02-7.785 0-3.56-.58-6.389-1.742-8.479-1.161-2.09-2.711-3.719-4.646-4.88-1.937-1.161-4.183-1.936-6.737-2.325-2.557-.382-5.309-.58-8.248-.58-6.506 0-11.617 1.395-15.335 4.183-3.716 2.788-5.889 7.437-6.506 13.94h-32.991c.462-7.742 2.395-14.173 5.807-19.281zm65.169 46.583a53.802 53.802 0 01-6.736 1.741c-2.402.465-4.918.853-7.551 1.161-2.635.313-5.268.698-7.899 1.163a59.302 59.302 0 00-7.317 1.857c-2.404.779-4.495 1.822-6.274 3.138-1.784 1.317-3.216 2.985-4.3 4.994-1.085 2.014-1.626 4.571-1.626 7.668 0 2.94.541 5.422 1.626 7.431 1.084 2.017 2.558 3.604 4.416 4.765s4.025 1.976 6.507 2.438c2.475.466 5.031.698 7.665.698 6.505 0 11.537-1.082 15.103-3.253 3.561-2.166 6.192-4.762 7.899-7.785 1.702-3.019 2.749-6.072 3.137-9.174.384-3.097.58-5.576.58-7.434V172.93c-1.396 1.243-3.138 2.21-5.23 2.908zM444.542 234.874c-5.187 0-10.173-.361-14.823-1.069-4.802-.732-9.104-2.183-12.779-4.313-3.789-2.185-6.821-5.341-9.006-9.375-2.163-3.986-3.26-9.232-3.26-15.59v-68.859h-17.981a2 2 0 01-2-1.999v-22.073a2 2 0 012-1.999h17.981V75.582a2 2 0 012-2h32.992a2 2 0 012 2v34.014h22.162a2 2 0 012 1.999v22.073a2 2 0 01-2 1.999h-22.162v57.479c0 6.229 1.198 8.731 2.202 9.733 1.004 1.007 3.506 2.205 9.738 2.205 1.804 0 3.542-.076 5.161-.225a44.198 44.198 0 004.669-.665 1.994 1.994 0 011.661.415c.463.379.73.946.73 1.546v25.555a2 2 0 01-1.672 1.974c-2.834.472-6.041.794-9.527.957-3.613.157-6.91.233-10.086.233z"})),r||(r=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M463.825 111.595v22.072h-24.161v59.479c0 5.573.928 9.292 2.788 11.149 1.856 1.859 5.576 2.788 11.152 2.788 1.859 0 3.638-.076 5.343-.232a45.912 45.912 0 004.878-.696v25.557c-2.788.465-5.887.773-9.293.931-3.407.149-6.737.23-9.99.23-5.111 0-9.953-.35-14.521-1.048-4.571-.695-8.597-2.047-12.081-4.063-3.486-2.011-6.236-4.88-8.248-8.597-2.016-3.714-3.021-8.595-3.021-14.639v-70.859h-19.98v-22.072h19.98V75.583h32.992v36.012h24.162zM512.613 233.711h-32.991a2 2 0 01-2-2V111.594a2 2 0 012-1.999h31.366a2 2 0 012 1.999v15.069a43.465 43.465 0 013.199-4.382 43.541 43.541 0 019.496-8.522 46.77 46.77 0 0111.415-5.462c4.056-1.298 8.327-1.954 12.691-1.954 2.341 0 4.953.418 7.766 1.243a2 2 0 011.437 1.92v30.67a2 2 0 01-2.395 1.96c-1.484-.3-3.299-.565-5.392-.787a57.416 57.416 0 00-6.062-.339c-5.706 0-10.572.95-14.467 2.823-3.862 1.86-7.012 4.428-9.361 7.629-2.389 3.263-4.115 7.12-5.127 11.47-1.043 4.479-1.574 9.409-1.574 14.647v54.132a2.002 2.002 0 01-2.001 2z"})),c||(c=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M510.988 111.595V133.9h.465c1.546-3.72 3.636-7.163 6.272-10.341a41.182 41.182 0 019.06-8.131 44.466 44.466 0 0110.923-5.228c3.868-1.237 7.898-1.859 12.081-1.859 2.168 0 4.566.39 7.202 1.163v30.67c-1.551-.312-3.41-.584-5.576-.814a58.79 58.79 0 00-6.274-.35c-6.041 0-11.152 1.01-15.332 3.021-4.182 2.014-7.55 4.761-10.107 8.247-2.555 3.487-4.379 7.55-5.462 12.198-1.083 4.645-1.625 9.682-1.625 15.102v54.133h-32.991V111.595h31.364zM603.923 233.711H570.93a2 2 0 01-2-2V111.594a2 2 0 012-1.999h32.994a2 2 0 012 1.999v120.117a2.002 2.002 0 01-2.001 2zm0-138.705H570.93a2 2 0 01-2-1.999V65.825a2 2 0 012-2h32.994a2 2 0 012 2v27.182a2.002 2.002 0 01-2.001 1.999z"})),l||(l=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M570.93 93.007V65.824h32.994v27.183H570.93zm32.994 18.588v120.117H570.93V111.595h32.994zM742.163 233.711h-37.64a1.995 1.995 0 01-1.667-.896l-23.426-35.352-23.426 35.352a1.992 1.992 0 01-1.667.896h-36.938a2.003 2.003 0 01-1.77-1.067 2.002 2.002 0 01.118-2.061l42.435-62.055-38.71-55.793a2.001 2.001 0 011.643-3.14h37.636c.665 0 1.287.33 1.658.882l19.477 28.893 19.255-28.884a2.004 2.004 0 011.665-.891h36.475c.746 0 1.43.415 1.776 1.078.343.66.289 1.46-.139 2.071l-38.69 55.082 43.578 62.744c.424.61.474 1.408.128 2.066a1.992 1.992 0 01-1.771 1.075z"})),d||(d=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M621.115 111.595h37.637l21.144 31.365 20.911-31.365h36.476l-39.496 56.226 44.377 63.892h-37.64l-25.093-37.87-25.094 37.87h-36.938l43.213-63.193-39.497-56.925zM791.322 340.809h-32.008a2 2 0 01-2-2v-7.712a2 2 0 012-2.001h21.13V11.71h-21.13a2 2 0 01-2-2V2a2 2 0 012-2h32.008a2 2 0 012 2v336.809a2 2 0 01-2 2z"})),m||(m=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M782.443 331.097V9.711h-23.13v-7.71h32.008v336.807h-32.008v-7.711h23.13z"})),h||(h=u.createElement("path",{d:"M10.875 9.711v321.386h23.13v7.711H1.999V2.001h32.006v7.71h-23.13zM99.988 111.595v16.264h.463c4.338-6.191 9.563-10.998 15.684-14.406 6.117-3.402 13.129-5.11 21.027-5.11 7.588 0 14.521 1.475 20.793 4.415 6.274 2.945 11.038 8.131 14.291 15.567 3.56-5.265 8.4-9.913 14.521-13.94 6.117-4.025 13.358-6.042 21.724-6.042 6.351 0 12.234.776 17.66 2.325 5.418 1.549 10.065 4.027 13.938 7.434 3.869 3.41 6.889 7.863 9.062 13.357 2.167 5.504 3.253 12.122 3.253 19.869v80.385H219.41v-68.074c0-4.025-.154-7.82-.465-11.385-.313-3.56-1.161-6.656-2.555-9.293-1.395-2.631-3.45-4.724-6.157-6.274-2.711-1.543-6.391-2.322-11.037-2.322s-8.403.896-11.269 2.671c-2.868 1.784-5.112 4.109-6.737 6.971-1.626 2.869-2.711 6.12-3.252 9.762a74.395 74.395 0 00-.814 11.035v66.91h-32.991v-67.375c0-3.562-.081-7.087-.23-10.57-.158-3.487-.814-6.7-1.978-9.645-1.162-2.94-3.099-5.304-5.809-7.088-2.711-1.775-6.699-2.671-11.965-2.671-1.551 0-3.603.349-6.156 1.048-2.556.697-5.036 2.016-7.435 3.949-2.404 1.938-4.454 4.726-6.158 8.363-1.705 3.642-2.556 8.402-2.556 14.287v69.701h-32.99V111.595h31.132zM273.544 129.255c3.405-5.113 7.744-9.215 13.012-12.316 5.264-3.097 11.186-5.303 17.771-6.621a101.17 101.17 0 0119.865-1.976c6.042 0 12.158.428 18.354 1.277 6.195.855 11.85 2.522 16.962 4.997 5.111 2.477 9.292 5.926 12.546 10.338 3.253 4.414 4.879 10.262 4.879 17.543v62.494c0 5.428.31 10.611.931 15.567.615 4.959 1.701 8.676 3.251 11.153H347.66a46.656 46.656 0 01-1.511-5.693 48.292 48.292 0 01-.813-5.923c-5.267 5.422-11.465 9.217-18.585 11.386a74.81 74.81 0 01-21.842 3.251c-5.733 0-11.077-.698-16.033-2.09-4.958-1.395-9.293-3.562-13.01-6.51-3.718-2.938-6.622-6.656-8.713-11.147s-3.138-9.84-3.138-16.033c0-6.813 1.199-12.43 3.604-16.84 2.399-4.417 5.495-7.939 9.295-10.575 3.793-2.632 8.129-4.607 13.01-5.923a140.326 140.326 0 0114.752-3.137 253.631 253.631 0 0114.638-1.857c4.801-.466 9.062-1.164 12.779-2.093 3.718-.929 6.658-2.282 8.829-4.065 2.165-1.781 3.172-4.375 3.02-7.785 0-3.56-.58-6.389-1.742-8.479-1.161-2.09-2.711-3.719-4.646-4.88-1.937-1.161-4.183-1.936-6.737-2.325-2.557-.382-5.309-.58-8.248-.58-6.506 0-11.617 1.395-15.335 4.183-3.716 2.788-5.889 7.437-6.506 13.94h-32.991c.462-7.742 2.395-14.173 5.807-19.281zm65.169 46.583a53.802 53.802 0 01-6.736 1.741c-2.402.465-4.918.853-7.551 1.161-2.635.313-5.268.698-7.899 1.163a59.302 59.302 0 00-7.317 1.857c-2.404.779-4.495 1.822-6.274 3.138-1.784 1.317-3.216 2.985-4.3 4.994-1.085 2.014-1.626 4.571-1.626 7.668 0 2.94.541 5.422 1.626 7.431 1.084 2.017 2.558 3.604 4.416 4.765s4.025 1.976 6.507 2.438c2.475.466 5.031.698 7.665.698 6.505 0 11.537-1.082 15.103-3.253 3.561-2.166 6.192-4.762 7.899-7.785 1.702-3.019 2.749-6.072 3.137-9.174.384-3.097.58-5.576.58-7.434V172.93c-1.396 1.243-3.138 2.21-5.23 2.908zM463.825 111.595v22.072h-24.161v59.479c0 5.573.928 9.292 2.788 11.149 1.856 1.859 5.576 2.788 11.152 2.788 1.859 0 3.638-.076 5.343-.232a45.912 45.912 0 004.878-.696v25.557c-2.788.465-5.887.773-9.293.931-3.407.149-6.737.23-9.99.23-5.111 0-9.953-.35-14.521-1.048-4.571-.695-8.597-2.047-12.081-4.063-3.486-2.011-6.236-4.88-8.248-8.597-2.016-3.714-3.021-8.595-3.021-14.639v-70.859h-19.98v-22.072h19.98V75.583h32.992v36.012h24.162zM510.988 111.595V133.9h.465c1.546-3.72 3.636-7.163 6.272-10.341a41.182 41.182 0 019.06-8.131 44.466 44.466 0 0110.923-5.228c3.868-1.237 7.898-1.859 12.081-1.859 2.168 0 4.566.39 7.202 1.163v30.67c-1.551-.312-3.41-.584-5.576-.814a58.79 58.79 0 00-6.274-.35c-6.041 0-11.152 1.01-15.332 3.021-4.182 2.014-7.55 4.761-10.107 8.247-2.555 3.487-4.379 7.55-5.462 12.198-1.083 4.645-1.625 9.682-1.625 15.102v54.133h-32.991V111.595h31.364zM570.93 93.007V65.824h32.994v27.183H570.93zm32.994 18.588v120.117H570.93V111.595h32.994zM621.115 111.595h37.637l21.144 31.365 20.911-31.365h36.476l-39.496 56.226 44.377 63.892h-37.64l-25.093-37.87-25.094 37.87h-36.938l43.213-63.193-39.497-56.925zM782.443 331.097V9.711h-23.13v-7.71h32.008v336.807h-32.008v-7.711h23.13z"})))}t.default="img/matrix.d12f502.svg"},1465:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M16.98 1.28a4.872 4.872 0 01-1.114 3.49 4.099 4.099 0 01-3.237 1.53 4.636 4.636 0 011.144-3.36 4.957 4.957 0 013.207-1.66zm3.974 7.428a4.949 4.949 0 00-2.357 4.152 4.782 4.782 0 002.92 4.4 10.963 10.963 0 01-1.519 3.092c-.894 1.338-1.832 2.645-3.32 2.669-.708.016-1.186-.187-1.684-.4-.52-.22-1.06-.451-1.907-.451-.899 0-1.464.238-2.01.467-.47.198-.927.39-1.57.417-1.417.053-2.5-1.428-3.427-2.753-1.853-2.707-3.296-7.628-1.362-10.976a5.315 5.315 0 014.473-2.728c.804-.017 1.576.293 2.252.565.517.208.979.393 1.357.393.332 0 .78-.178 1.304-.386.824-.326 1.832-.727 2.859-.619 1.596.05 3.075.85 3.99 2.158z",fill:"#17191C"})))}t.default="img/element-icons/brands/apple.5160971.svg"},1466:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return c}));var n,i,s,o=a(87);function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function c(e){return o.createElement("svg",r({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 24",role:"presentation","aria-hidden":!0},e),n||(n=o.createElement("mask",{id:"facebook_svg__a",maskUnits:"userSpaceOnUse",x:2,y:1,width:22,height:22},o.createElement("path",{d:"M2.102 1.5H23.1v20.872H2.102V1.5z",fill:"#fff"}))),i||(i=o.createElement("g",{mask:"url(#facebook_svg__a)"},o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M23.1 11.999c0-5.799-4.701-10.5-10.5-10.5S2.1 6.2 2.1 11.999c0 5.24 3.84 9.585 8.86 10.373v-7.338H8.292V12h2.666V9.686c0-2.632 1.568-4.085 3.966-4.085 1.15 0 2.35.205 2.35.205V8.39h-1.323c-1.305 0-1.711.809-1.711 1.64v1.969h2.912l-.466 3.035h-2.446v7.338c5.02-.788 8.859-5.132 8.859-10.373z",fill:"#1877F2"}))),s||(s=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M16.687 15.034L17.153 12H14.24v-1.97c0-.83.406-1.64 1.71-1.64h1.325V5.807s-1.202-.205-2.35-.205c-2.4 0-3.967 1.453-3.967 4.085v2.313H8.293v3.035h2.666v7.338a10.588 10.588 0 003.282 0v-7.338h2.446z",fill:"#fff"})))}t.default="img/element-icons/brands/facebook.c3243cf.svg"},1467:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{d:"M20.842 7.106a9.707 9.707 0 00-3.548-3.548C15.8 2.686 14.169 2.25 12.4 2.25c-1.769 0-3.4.436-4.894 1.308a9.707 9.707 0 00-3.548 3.548C3.086 8.6 2.65 10.23 2.65 12c0 2.124.62 4.035 1.86 5.732 1.24 1.696 2.841 2.87 4.805 3.522.228.043.398.013.508-.088a.497.497 0 00.165-.381l-.007-.686c-.004-.431-.006-.808-.006-1.13l-.292.051a3.725 3.725 0 01-.705.045 5.354 5.354 0 01-.882-.09 1.97 1.97 0 01-.85-.38 1.611 1.611 0 01-.56-.78l-.126-.293a3.174 3.174 0 00-.4-.647c-.182-.237-.366-.398-.552-.482l-.089-.064a.928.928 0 01-.165-.152.696.696 0 01-.114-.178c-.026-.06-.005-.108.063-.146.068-.039.19-.057.368-.057l.254.038c.17.034.379.135.629.304.25.17.454.39.615.66.195.348.43.612.705.794.275.182.552.273.831.273.28 0 .52-.021.724-.063.203-.043.393-.107.571-.191.076-.567.284-1.003.622-1.308a8.696 8.696 0 01-1.301-.228 5.18 5.18 0 01-1.193-.496 3.419 3.419 0 01-1.022-.85c-.271-.339-.493-.783-.667-1.333-.173-.55-.26-1.185-.26-1.904 0-1.025.335-1.896 1.003-2.616-.313-.77-.284-1.633.089-2.59.245-.076.61-.018 1.092.172.482.19.835.354 1.06.489.224.135.404.25.54.343.787-.22 1.599-.33 2.437-.33.838 0 1.65.11 2.438.33l.482-.305c.33-.203.72-.39 1.168-.559.448-.169.791-.215 1.028-.14.381.957.415 1.82.102 2.59.668.72 1.003 1.592 1.003 2.616 0 .72-.087 1.356-.26 1.91-.174.555-.398.999-.673 1.333a3.55 3.55 0 01-1.028.845c-.411.228-.809.393-1.194.495a8.69 8.69 0 01-1.301.229c.44.38.66.981.66 1.802v2.678c0 .153.053.28.159.381.105.102.273.131.501.089 1.964-.652 3.566-1.826 4.805-3.523 1.24-1.697 1.86-3.607 1.86-5.732 0-1.768-.436-3.4-1.308-4.893z",fill:"#000"})))}t.default="img/element-icons/brands/github.bf60283.svg"},1468:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return m}));var n,i,s,o,r,c,l=a(87);function d(){return(d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function m(e){return l.createElement("svg",d({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),n||(n=l.createElement("path",{d:"M12 20.33l3.317-10.2H8.689l3.312 10.2z",fill:"#E24329"})),i||(i=l.createElement("path",{d:"M4.043 10.13l-1.01 3.098a.687.687 0 00.25.768L12 20.33l-7.957-10.2z",fill:"#FCA326"})),s||(s=l.createElement("path",{d:"M4.042 10.129h4.645L6.688 3.986c-.102-.315-.548-.315-.654 0l-1.992 6.143z",fill:"#E24329"})),o||(o=l.createElement("path",{d:"M19.96 10.13l1.006 3.098a.687.687 0 01-.248.768l-8.719 6.334 7.961-10.2z",fill:"#FCA326"})),r||(r=l.createElement("path",{d:"M19.962 10.129h-4.645l1.995-6.143c.102-.315.548-.315.654 0l1.996 6.143z",fill:"#E24329"})),c||(c=l.createElement("path",{d:"M12 20.33l3.315-10.2h4.645L12 20.33zM11.998 20.33l-7.956-10.2h4.645L12 20.33z",fill:"#FC6D26"})))}t.default="img/element-icons/brands/gitlab.d4ee177.svg"},1469:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return l}));var n,i,s,o,r=a(87);function c(){return(c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function l(e){return r.createElement("svg",c({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),n||(n=r.createElement("path",{d:"M22.501 12.233c0-.863-.071-1.493-.226-2.146h-10.06v3.896h5.905c-.119.969-.762 2.427-2.19 3.407l-.02.13 3.18 2.415.22.022c2.024-1.832 3.191-4.527 3.191-7.724z",fill:"#4285F4"})),i||(i=r.createElement("path",{d:"M12.215 22.5c2.893 0 5.321-.933 7.095-2.543l-3.381-2.567c-.905.618-2.12 1.05-3.714 1.05a6.438 6.438 0 01-6.096-4.363l-.125.01-3.307 2.509-.044.117c1.762 3.43 5.381 5.787 9.572 5.787z",fill:"#34A853"})),s||(s=r.createElement("path",{d:"M6.12 14.077A6.347 6.347 0 015.763 12c0-.723.131-1.423.345-2.077l-.006-.139-3.348-2.548-.11.05A10.339 10.339 0 001.501 12c0 1.692.417 3.29 1.143 4.713l3.476-2.636z",fill:"#FBBC05"})),o||(o=r.createElement("path",{d:"M12.215 5.56c2.012 0 3.369.852 4.143 1.563L19.38 4.23c-1.857-1.692-4.273-2.73-7.166-2.73-4.19 0-7.81 2.357-9.572 5.787l3.465 2.636a6.465 6.465 0 016.107-4.363z",fill:"#EB4335"})))}t.default="img/element-icons/brands/google.04f5e48.svg"},1470:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{d:"M9.042 21c-2.427 0-4.688-.706-6.592-1.923 1.616.104 4.469-.146 6.243-1.838-2.67-.123-3.873-2.17-4.03-3.045.227.088 1.308.193 1.919-.052-3.07-.77-3.541-3.464-3.436-4.286.575.402 1.552.542 1.936.507-2.86-2.047-1.832-5.126-1.326-5.79 2.053 2.843 5.13 4.44 8.936 4.53a4.398 4.398 0 01-.11-.98 4.367 4.367 0 014.361-4.373c1.259 0 2.393.535 3.189 1.39.84-.197 2.106-.659 2.725-1.058-.312 1.12-1.283 2.054-1.87 2.4.005.012-.005-.012 0 0 .516-.078 1.912-.346 2.463-.72-.273.629-1.302 1.675-2.147 2.26C21.46 14.953 16.157 21 9.042 21z",fill:"#1D9BF0"})))}t.default="img/element-icons/brands/twitter.892d1c7.svg"},1471:function(e,t,a){"use strict";a.d(t,"a",(function(){return y}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(203),c=a(0),l=a(89),d=a(90),m=a(146),h=a(545),u=a(92),p=a(160),g=a(95),b=a(197),v=a(96),f=a(556),E=a(139);class y extends o.a.PureComponent{constructor(e){super(e),i()(this,"intervalHandle",void 0),i()(this,"checkRequestIsPending",()=>{const{request:e}=this.props;e.canAccept||p.a.sharedInstance().dismissToast(this.props.toastKey)}),i()(this,"cancel",()=>{p.a.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){c.a.error("Error while cancelling verification request",e)}}),i()(this,"accept",async()=>{p.a.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=d.a.get();try{if(e.channel.roomId){u.a.dispatch({action:v.a.ViewRoom,room_id:e.channel.roomId,should_peek:!1,metricsTrigger:"VerificationRequest"});const a=t.getUser(e.otherUserId);E.a.instance.setCards([{phase:m.a.RoomSummary},{phase:m.a.RoomMemberInfo,state:{member:a}},{phase:m.a.EncryptionPanel,state:{verificationRequest:e,member:a}}],void 0,e.channel.roomId)}else g.a.createTrackedDialog("Incoming Verification","",f.a,{verificationRequest:e,onFinished:()=>{e.cancel()}},null,!1,!0);await e.accept()}catch(e){c.a.error(e.message)}}),this.state={counter:Math.ceil(e.request.timeout/1e3)}}async componentDidMount(){const{request:e}=this.props;if(e.timeout&&e.timeout>0&&(this.intervalHandle=setInterval(()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})},1e3)),e.on(r.m.Change,this.checkRequestIsPending),this.checkRequestIsPending(),e.isSelfVerification){const t=d.a.get(),a=(await t.getDevice(e.channel.deviceId)).last_seen_ip;this.setState({device:t.getStoredDevice(t.getUserId(),e.channel.deviceId),ip:a})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off(r.m.Change,this.checkRequestIsPending)}render(){const{request:e}=this.props;let t,a;if(e.isSelfVerification)this.state.device&&(t=this.state.device.getDisplayName(),a=Object(l.a)("%(deviceId)s from %(ip)s",{deviceId:this.state.device.deviceId,ip:this.state.ip}));else{const a=e.otherUserId,n=e.channel.roomId;if(t=n?Object(h.b)(a,n):a,t===a){const e=d.a.get().getUser(a);e&&e.displayName&&(t=Object(l.a)("%(name)s (%(userId)s)",{name:e.displayName,userId:a}))}}const n=0===this.state.counter?Object(l.a)("Decline"):Object(l.a)("Decline (%(counter)s)",{counter:this.state.counter});return o.a.createElement(b.a,{description:t,detail:a,acceptLabel:Object(l.a)("Accept"),onAccept:this.accept,rejectLabel:n,onReject:this.cancel})}}},1482:function(e,t,a){"use strict";var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(119),c=a(94),l=a.n(c),d=a(242),m=a(116),h=a(192),u=a(446),p=a(267),g=a(806),b=a(92),v=a(93),f=a(104);var E=e=>{let{vertical:t,reverse:a,id:n,passRef:i}=e;const s=["mx_ResizeHandle"];return t?s.push("mx_ResizeHandle_vertical"):s.push("mx_ResizeHandle_horizontal"),a&&s.push("mx_ResizeHandle_reverse"),o.a.createElement("div",{ref:i,className:s.join(" "),"data-id":n},o.a.createElement("div",null))};class y{constructor(e,t,a,n){this.resizer=t,this.sizer=a,this.container=n,i()(this,"domNode",void 0),i()(this,"id",void 0),i()(this,"reverse",void 0),this.reverse=t.isReverseResizeHandle(e),this.domNode=n||(this.reverse?e.nextElementSibling:e.previousElementSibling),this.id=e.getAttribute("data-id")}copyWith(e,t,a,n){return new(0,this.constructor)(e,t,a,n)}advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const a=e!==this.reverse;do{t=a?t.nextElementSibling:t.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this.copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this.advance(!0)}previous(){return this.advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}start(){this.sizer.start(this.domNode)}finish(){this.sizer.finish(this.domNode)}getSize(){return this.sizer.getDesiredItemSize(this.domNode)}setRawSize(e){this.sizer.setItemSize(this.domNode,e)}setSize(e){this.setRawSize(Math.round(e)+"px");const t=this.resizer.config.onResized;t&&t(e,this.id,this.domNode)}clearSize(){this.sizer.clearItemSize(this.domNode);const e=this.resizer.config.onResized;e&&e(null,this.id,this.domNode)}first(){const e=Array.from(this.domNode.parentElement.children).find(e=>this.resizer.isResizeHandle(e));if(e)return this.copyWith(e,this.resizer,this.sizer)}last(){const e=Array.from(this.domNode.parentElement.children).reverse().find(e=>this.resizer.isResizeHandle(e));if(e)return this.copyWith(e,this.resizer,this.sizer)}}class _{constructor(e,t,a){this.container=e,this.vertical=t,this.reverse=a}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this.getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}getDesiredItemSize(e){return this.vertical?e.style.height:e.style.width}setItemSize(e,t){this.vertical?e.style.height=t:e.style.width=t}clearItemSize(e){this.vertical?e.style.height=null:e.style.width=null}start(e){}finish(e){}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this.getPageOffset()+this.getTotalSize()-t:t-this.getPageOffset()}}class S{static createItem(e,t,a){return new y(e,t,a)}static createSizer(e,t,a){return new _(e,t,a)}constructor(e){this.item=e,i()(this,"beforeOffset",void 0),this.beforeOffset=e.offset()}get size(){return this.item.getSize()}set size(e){this.item.setRawSize(e)}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){this.item.start()}finish(){this.item.finish()}}class w extends _{start(e){this.vertical?e.style.minHeight=null:e.style.minWidth=null}finish(e){const t=e.offsetParent;if(t)if(this.vertical){const a=(e.offsetHeight/t.offsetHeight*100).toFixed(2)+"%";e.style.minHeight=a,e.style.height=a}else{const a=(e.offsetWidth/t.offsetWidth*100).toFixed(2)+"%";e.style.minWidth=a,e.style.width=a}}}class C extends S{static createSizer(e,t,a){return new w(e,t,a)}}class O extends y{notifyCollapsed(e){const t=this.resizer.config.onCollapsed;t&&t(e,this.id,this.domNode)}get isCollapsed(){return(0,this.resizer.config.isItemCollapsed)(this.domNode)}}class k extends S{static createItem(e,t,a,n){return new O(e,t,a,n)}constructor(e){var t,a;super(e),i()(this,"toggleSize",void 0),i()(this,"isCollapsed",void 0),this.toggleSize=null===(t=e.resizer)||void 0===t||null===(a=t.config)||void 0===a?void 0:a.toggleSize,this.isCollapsed=e.isCollapsed}resize(e){const t=e<this.toggleSize;t!==this.isCollapsed&&(this.isCollapsed=t,this.item.notifyCollapsed(t)),t||super.resize(e)}}var x=a(111);class R{constructor(e,t,a){this.container=e,this.distributorCtor=t,this.config=a,i()(this,"classNames",void 0),i()(this,"onMouseDown",e=>{var t;const a=e.target&&e.target.closest("."+this.classNames.handle),n=null==this||null===(t=this.config)||void 0===t?void 0:t.handler;if(!a||!n&&a.parentElement!==this.container||n&&a!==n)return;var i,s;(e.preventDefault(),this.classNames.resizing)&&(null===(i=this.container)||void 0===i||null===(s=i.classList)||void 0===s||s.add(this.classNames.resizing));this.config.onResizeStart&&this.config.onResizeStart();const{sizer:o,distributor:r}=this.createSizerAndDistributor(a);r.start();const c=e=>{const t=o.offsetFromEvent(e);r.resizeFromContainerOffset(t)},l=document.body,d=()=>{var e,t;this.classNames.resizing&&(null===(e=this.container)||void 0===e||null===(t=e.classList)||void 0===t||t.remove(this.classNames.resizing));r.finish(),this.config.onResizeStop&&this.config.onResizeStop(),l.removeEventListener("mouseup",d,!1),document.removeEventListener("mouseleave",d,!1),l.removeEventListener("mousemove",c,!1)};l.addEventListener("mouseup",d,!1),document.addEventListener("mouseleave",d,!1),l.addEventListener("mousemove",c,!1)}),i()(this,"onResize",Object(x.throttle)(()=>{const e=this.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())},100,{trailing:!0,leading:!0})),i()(this,"getDistributors",()=>this.getResizeHandles().map(e=>{const{distributor:t}=this.createSizerAndDistributor(e);return t})),this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"}}setClassNames(e){this.classNames=e}attach(){var e,t,a;(null!==(e=null==this||null===(t=this.config)||void 0===t||null===(a=t.handler)||void 0===a?void 0:a.parentElement)&&void 0!==e?e:this.container).addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("resize",this.onResize)}detach(){var e,t,a;(null!==(e=null==this||null===(t=this.config)||void 0===t||null===(a=t.handler)||void 0===a?void 0:a.parentElement)&&void 0!==e?e:this.container).removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("resize",this.onResize)}forHandleAt(e){const t=this.getResizeHandles()[e];if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this.getResizeHandles().find(t=>t.getAttribute("data-id")===e);if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e&&e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e&&e.classList.contains(this.classNames.handle)}createSizerAndDistributor(e){const t=e.classList.contains(this.classNames.vertical),a=this.isReverseResizeHandle(e),n=this.distributorCtor,i=this.config&&this.config.handler?this.container:void 0,s=n.createSizer(this.container,t,a),o=n.createItem(e,this,s,i);return{sizer:s,distributor:new n(o)}}getResizeHandles(){var e,t;return null!=this&&null!==(e=this.config)&&void 0!==e&&e.handler?[this.config.handler]:null!==(t=this.container)&&void 0!==t&&t.children?Array.from(this.container.querySelectorAll("."+this.classNames.handle)):[]}}var j=a(100),I=a(176),T=a(563),N=a(89),P=a(98),M=a(96),D=a(148),A=a(196),U=a(91),L=a(123),F=a(118),B=a(815),V=a(162),W=a(127),H=a(816);const z=e=>{V.a.trackEvent("home_page","button","dm"),W.b.trackInteraction("WebHomeCreateChatButton",e),b.a.dispatch({action:"view_create_chat"})},K=e=>{V.a.trackEvent("home_page","button","room_directory"),W.b.trackInteraction("WebHomeExploreRoomsButton",e),b.a.fire(M.a.ViewRoomDirectory)},q=e=>{V.a.trackEvent("home_page","button","create_room"),W.b.trackInteraction("WebHomeCreateRoomButton",e),b.a.dispatch({action:"view_create_room"})},G=e=>({displayName:A.a.instance.displayName||e,avatarUrl:A.a.instance.getHttpAvatarUrl(B.a)}),Y=()=>{const e=Object(s.useContext)(j.a),t=e.getUserId(),[a,n]=Object(s.useState)(G(t));return Object(F.a)(A.a.instance,L.b,()=>{n(G(t))}),s.createElement("div",null,s.createElement(B.b,{hasAvatar:!!a.avatarUrl,hasAvatarLabel:Object(N.b)("Great, that'll help people know it's you"),noAvatarLabel:Object(N.b)("Add a photo so people know it's you."),setAvatarUrl:t=>e.setAvatarUrl(t),isUserAvatar:!0,onClick:e=>W.b.trackInteraction("WebHomeMiniAvatarUploadButton",e)},s.createElement(D.a,{idName:t,name:a.displayName,url:a.avatarUrl,width:B.a,height:B.a,resizeMethod:"crop"})),s.createElement("h1",null,Object(N.b)("Welcome %(name)s",{name:a.displayName})),s.createElement("h4",null,Object(N.b)("Now, let's help you get started")))};var J=e=>{let{justRegistered:t=!1}=e;const a=P.b.get(),n=Object(T.a)(a);if(n)return s.createElement(H.a,{className:"mx_HomePage",url:n,scrollbar:!0});let i;if(t||A.a.instance.getHttpAvatarUrl(B.a))i=s.createElement(Y,null);else{var o;const e=P.b.getObject("branding"),t=null!==(o=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==o?o:"themes/element/img/logos/element-logo.svg";i=s.createElement(s.Fragment,null,s.createElement("img",{src:t,alt:a.brand}),s.createElement("h1",null,Object(N.b)("Welcome to %(appName)s",{appName:a.brand})),s.createElement("h4",null,Object(N.b)("Own your conversations.")))}return s.createElement(I.a,{className:"mx_HomePage mx_HomePage_default"},s.createElement("div",{className:"mx_HomePage_default_wrapper"},i,s.createElement("div",{className:"mx_HomePage_default_buttons"},s.createElement(U.a,{onClick:z,className:"mx_HomePage_button_sendDm"},Object(N.b)("Send a Direct Message")),s.createElement(U.a,{onClick:K,className:"mx_HomePage_button_explore"},Object(N.b)("Explore Public Rooms")),s.createElement(U.a,{onClick:q,className:"mx_HomePage_button_createGroup"},Object(N.b)("Create a Group Chat")))))},$=a(126),Q=a(166),X=a(197),Z=a(160),ee=a(348);const te=()=>{Z.a.sharedInstance().dismissToast("serverlimit")};var ae=a(852),ne=a(156),ie=a(791),se=a(1413),oe=a(117),re=a(131),ce=a(171),le=a(114),de=a(147),me=a(134),he=a(99),ue=a.n(he),pe=a(113),ge=a(97),be=a(177),ve=a(112),fe=a(103),Ee=a.n(fe),ye=a(154),_e=a(213),Se=a(427),we=a(265),Ce=a(185),Oe=a(122);const ke=["space","hideHeader","onFinished"];var xe=e=>{let{space:t,hideHeader:a,onFinished:n}=e,i=Ee()(e,ke);const r=Object(s.useContext)(j.a).getUserId();let c,l,d,m;if("public"===t.getJoinRule()||t.canInvite(r)){const e=e=>{e.preventDefault(),e.stopPropagation(),Object(_e.i)(t),n()};c=o.a.createElement(ye.b,{"data-test-id":"invite-option",className:"mx_SpacePanel_contextMenu_inviteButton",iconClassName:"mx_SpacePanel_iconInvite",label:Object(N.a)("Invite"),onClick:e})}if(Object(_e.d)(t)){const e=e=>{e.preventDefault(),e.stopPropagation(),Object(_e.k)(t),n()};l=o.a.createElement(ye.b,{"data-test-id":"settings-option",iconClassName:"mx_SpacePanel_iconSettings",label:Object(N.a)("Settings"),onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),Object(Se.b)(t),n()};d=o.a.createElement(ye.b,{"data-test-id":"leave-option",iconClassName:"mx_SpacePanel_iconLeave",className:"mx_IconizedContextMenu_option_red",label:Object(N.a)("Leave space"),onClick:e})}if(v.b.getValue("developerMode")){const e=e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:M.a.ViewRoom,room_id:t.roomId,forceTimeline:!0,metricsTrigger:void 0}),n()};m=o.a.createElement(ye.b,{iconClassName:"mx_SpacePanel_iconSettings",label:Object(N.a)("See room timeline (devtools)"),onClick:e})}const h=t.currentState.maySendStateEvent(ge.b.SpaceChild,r),u=h&&Object(Ce.a)(Oe.a.CreateRooms),p=u&&v.b.getValue("feature_video_rooms"),g=h&&Object(Ce.a)(Oe.a.CreateSpaces);let f;if(u||g){const e=e=>{e.preventDefault(),e.stopPropagation(),W.b.trackInteraction("WebSpaceContextMenuNewRoomItem",e),Object(_e.g)(t),n()},a=e=>{e.preventDefault(),e.stopPropagation(),Object(_e.g)(t,ge.f.ElementVideo),n()},i=e=>{e.preventDefault(),e.stopPropagation(),Object(_e.h)(t),n()};f=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{"data-test-id":"add-to-space-header",className:"mx_SpacePanel_contextMenu_separatorLabel"},Object(N.a)("Add")),u&&o.a.createElement(ye.b,{"data-test-id":"new-room-option",iconClassName:"mx_SpacePanel_iconPlus",label:Object(N.a)("Room"),onClick:e}),p&&o.a.createElement(ye.b,{"data-test-id":"new-video-room-option",iconClassName:"mx_SpacePanel_iconPlus",label:Object(N.a)("Video room"),onClick:a}),g&&o.a.createElement(ye.b,{"data-test-id":"new-subspace-option",iconClassName:"mx_SpacePanel_iconPlus",label:Object(N.a)("Space"),onClick:i},o.a.createElement(we.a,null)))}const E=e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:M.a.ViewRoom,room_id:t.roomId,metricsTrigger:void 0}),n()};return o.a.createElement(ye.e,ue()({},i,{onFinished:n,className:"mx_SpacePanel_contextMenu",compact:!0}),!a&&o.a.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},t.name),o.a.createElement(ye.c,{first:!0},o.a.createElement(ye.b,{iconClassName:"mx_SpacePanel_iconHome",label:Object(N.a)("Space home"),onClick:e=>{W.b.trackInteraction("WebSpaceContextMenuHomeItem",e),E(e)}}),c,o.a.createElement(ye.b,{iconClassName:"mx_SpacePanel_iconExplore",label:u?Object(N.a)("Manage & explore rooms"):Object(N.a)("Explore rooms"),onClick:e=>{W.b.trackInteraction("WebSpaceContextMenuExploreRoomsItem",e),E(e)}}),o.a.createElement(ye.b,{iconClassName:"mx_SpacePanel_iconPreferences",label:Object(N.a)("Preferences"),onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(_e.j)(t),n()}}),l,d,m,f))},Re=a(1415),je=a(528),Ie=a(130);const Te=(e,t)=>{let a="";if(t)for(const e of t.entries())a+=e+"/";return"mx_space_collapsed_"+(a+e)};class Ne{static get instance(){return Ne.internalInstance||(Ne.internalInstance=new Ne),Ne.internalInstance}setSpaceCollapsedState(e,t,a){localStorage.setItem(Te(e,t),a.toString())}getSpaceCollapsedState(e,t,a){const n=localStorage.getItem(Te(e,t));return n?"true"===n:a}}i()(Ne,"internalInstance",void 0);var Pe=a(210),Me=a(334),De=a(349),Ae=a(168),Ue=a(109);const Le=["space","spaceKey","className","selected","label","contextMenuTooltip","notificationState","avatarSize","isNarrow","children","ContextMenuComponent"],Fe=["space","activeSpaces","isNested","isPanelCollapsed","onExpand","parents","innerRef","dragHandleProps"],Be=["tabIndex"],Ve=e=>{var t;let{space:a,spaceKey:n,className:i,selected:s,label:r,contextMenuTooltip:c,notificationState:d,avatarSize:m,isNarrow:h,children:u,ContextMenuComponent:p}=e,g=Ee()(e,Le);const[v,f,E,y]=Object(ve.q)(),[_,S,w]=Object(me.i)(f),C=S?0:-1;let O,k,x=o.a.createElement("div",{className:"mx_SpaceButton_avatarPlaceholder"},o.a.createElement("div",{className:"mx_SpaceButton_icon"}));if(a&&(x=o.a.createElement(Ie.a,{width:m,height:m,room:a})),d){let e=Object(N.a)("Jump to first unread room.");"invite"===(null==a?void 0:a.getMyMembership())&&(e=Object(N.a)("Jump to first invite."));const t=e=>{e.stopPropagation(),e.preventDefault(),re.a.instance.setActiveRoomInSpace(null!=n?n:a.roomId)};O=o.a.createElement("div",{className:"mx_SpacePanel_badgeContainer"},o.a.createElement(Pe.a,{onClick:t,forceCount:!1,notification:d,"aria-label":e,tabIndex:C,showUnsentTooltip:!0}))}var R;v&&p&&(k=o.a.createElement(p,ue()({},Object(ve.p)(null===(R=w.current)||void 0===R?void 0:R.getBoundingClientRect(),0),{space:a,onFinished:y})));const j=null!==(t=g.onClick)&&void 0!==t?t:s&&a?()=>b.a.dispatch({action:M.a.ViewRoom,room_id:a.roomId}):()=>re.a.instance.setActiveSpace(null!=n?n:a.roomId);return o.a.createElement(oe.a,ue()({},g,{className:l()("mx_SpaceButton",i,{mx_SpaceButton_active:s,mx_SpaceButton_hasMenuOpen:v,mx_SpaceButton_narrow:h}),title:r,onClick:j,onContextMenu:E,forceHide:!h||v,inputRef:w,tabIndex:C,onFocus:_}),u,o.a.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},o.a.createElement("div",{className:"mx_SpaceButton_avatarWrapper"},x,O),!h&&o.a.createElement("span",{className:"mx_SpaceButton_name"},r),p&&o.a.createElement(Me.a,{className:"mx_SpaceButton_menuButton",onClick:E,title:c,isExpanded:v}),k))};class We extends o.a.PureComponent{constructor(e){super(e),i()(this,"buttonRef",Object(s.createRef)()),i()(this,"onSpaceUpdate",()=>{this.setState({childSpaces:this.childSpaces})}),i()(this,"onRoomNameChange",()=>{this.setState({name:this.props.space.name})}),i()(this,"toggleCollapse",e=>{this.props.onExpand&&this.isCollapsed&&this.props.onExpand();const t=!this.isCollapsed;Ne.instance.setSpaceCollapsedState(this.props.space.roomId,this.props.parents,t),this.setState({collapsed:t}),e.stopPropagation()}),i()(this,"onKeyDown",e=>{var t;let a=!0;const n=Object(le.a)().getRoomListAction(e),i=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;switch(n){case Ue.h.CollapseRoomListSection:if(i&&!this.isCollapsed)this.toggleCollapse(e);else{var s,o,r;const e=null===(s=this.buttonRef)||void 0===s||null===(o=s.current)||void 0===o||null===(r=o.parentElement)||void 0===r?void 0:r.parentElement,t=null==e?void 0:e.previousElementSibling;null==t||t.focus()}break;case Ue.h.ExpandRoomListSection:if(i)if(this.isCollapsed)this.toggleCollapse(e);else{var c,l,d;const e=null===(c=this.buttonRef)||void 0===c||null===(l=c.current)||void 0===l?void 0:l.nextElementSibling,t=null==e?void 0:e.querySelector(".mx_SpaceItem");null==t||null===(d=t.querySelector(".mx_SpaceButton"))||void 0===d||d.focus()}break;default:a=!1}a&&(e.stopPropagation(),e.preventDefault())});const t=Ne.instance.getSpaceCollapsedState(e.space.roomId,this.props.parents,!e.isNested);this.state={name:this.props.space.name,collapsed:t,childSpaces:this.childSpaces},re.a.instance.on(this.props.space.roomId,this.onSpaceUpdate),this.props.space.on(pe.c.Name,this.onRoomNameChange)}componentWillUnmount(){re.a.instance.off(this.props.space.roomId,this.onSpaceUpdate),this.props.space.off(pe.c.Name,this.onRoomNameChange)}get childSpaces(){return re.a.instance.getChildSpaces(this.props.space.roomId).filter(e=>{var t;return!(null!==(t=this.props.parents)&&void 0!==t&&t.has(e.roomId))})}get isCollapsed(){return this.state.collapsed||this.props.isPanelCollapsed}render(){var e,t;const a=this.props,{space:n,activeSpaces:i,isNested:s,isPanelCollapsed:r,onExpand:c,parents:d,innerRef:m,dragHandleProps:h}=a,u=Ee()(a,Fe),p=this.isCollapsed,g=l()(this.props.className,{mx_SpaceItem:!0,mx_SpaceItem_narrow:r,collapsed:p,hasSubSpaces:null===(e=this.state.childSpaces)||void 0===e?void 0:e.length}),b="invite"===n.getMyMembership(),v=b?De.a.forSymbol("!",Ae.a.Red):re.a.instance.getNotificationState(n.roomId),f=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;let E;f&&!p&&(E=o.a.createElement(He,{spaces:this.state.childSpaces,activeSpaces:i,isNested:!0,parents:new Set(d).add(n.roomId)}));const y=f?o.a.createElement(U.a,{className:"mx_SpaceButton_toggleCollapse",onClick:this.toggleCollapse,tabIndex:-1,"aria-label":p?Object(N.a)("Expand"):Object(N.a)("Collapse")}):null,_=h||{},{tabIndex:S}=_,w=Ee()(_,Be);return o.a.createElement("li",ue()({},u,{className:g,ref:m,"aria-expanded":f?!p:void 0,role:"treeitem"}),o.a.createElement(Ve,ue()({},w,{space:n,className:b?"mx_SpaceButton_invite":void 0,selected:i.includes(n.roomId),label:this.state.name,contextMenuTooltip:Object(N.a)("Space options"),notificationState:v,isNarrow:r,avatarSize:s?24:32,onKeyDown:this.onKeyDown,ContextMenuComponent:"join"===this.props.space.getMyMembership()?xe:void 0}),y),E)}}i()(We,"contextType",j.a);const He=e=>{let{spaces:t,activeSpaces:a,isNested:n,parents:i}=e;return o.a.createElement("ul",{className:"mx_SpaceTreeLevel",role:"group"},t.map(e=>o.a.createElement(We,{key:e.roomId,activeSpaces:a,space:e,isNested:n,parents:i})))};var ze=a(172),Ke=a(141),qe=a(819),Ge=a(155),Ye=a(270),Je=a(263),$e=a(820);var Qe,Xe,Ze=e=>{let{requestClose:t}=e;const a=Object(s.useMemo)(Ye.f,[]),n=$e.a.calculateThemeState(),i=Object(Ye.d)(n.theme),r=i||n.theme,{useSystemTheme:c}=n,l=[{id:"MATCH_SYSTEM_THEME_ID",name:Object(N.a)("Match system")},...a],d=c?"MATCH_SYSTEM_THEME_ID":r;return o.a.createElement("div",{className:"mx_QuickThemeSwitcher"},o.a.createElement("h4",{className:"mx_QuickThemeSwitcher_heading"},Object(N.a)("Theme")),o.a.createElement(Je.a,{id:"mx_QuickSettingsButton_themePickerDropdown",onOptionChange:async e=>{W.b.trackInteraction("WebQuickSettingsThemeDropdown");try{"MATCH_SYSTEM_THEME_ID"===e?await v.b.setValue("use_system_theme",null,f.a.DEVICE,!0):(b.a.dispatch({action:M.a.RecheckTheme,forceTheme:e}),await Promise.all([v.b.setValue("theme",null,f.a.DEVICE,e),v.b.setValue("use_system_theme",null,f.a.DEVICE,!1)]))}catch(e){b.a.dispatch({action:M.a.RecheckTheme})}t()},value:d,label:Object(N.a)("Space selection")},l.map(e=>o.a.createElement("div",{key:e.id},e.name))))};function et(){return(et=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function tt(e){return s.createElement("svg",et({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),Qe||(Qe=s.createElement("path",{d:"M11 18.598V15h2v3.598C13 20.5 12.238 22 12 22s-1-1.5-1-3.402zM9.5 6c-.325-.167-1.714-.8-2.883-2s-.495-2 .513-2H12v4H9.5zM14.5 6c.325-.167 1.714-.8 2.883-2s.495-2-.513-2H12v4h2.5zM9.429 6h5.142L15 10H9l.429-4z",fill:"#000"})),Xe||(Xe=s.createElement("path",{d:"M12 9c-3.069 0-5.676 1.693-6.621 4.048C4.967 14.073 5.895 15 7 15h10c1.105 0 2.032-.927 1.621-1.952C17.677 10.693 15.07 9 12 9z",fill:"#000"})))}var at,nt,it;function st(){return(st=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function ot(e){return s.createElement("svg",st({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),at||(at=s.createElement("circle",{cx:15.5,cy:10,r:1.5,transform:"rotate(180 15.5 10)",fill:"#15191E"})),nt||(nt=s.createElement("circle",{cx:10,cy:10,r:1.5,transform:"rotate(180 10 10)",fill:"#15191E"})),it||(it=s.createElement("circle",{cx:4.5,cy:10,r:1.5,transform:"rotate(180 4.5 10)",fill:"#15191E"})))}var rt,ct,lt;function dt(){return(dt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function mt(e){return s.createElement("svg",dt({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),rt||(rt=s.createElement("mask",{id:"members_svg__a",fill:"#fff"},s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M17.591 20.292A9.954 9.954 0 0112 22a9.956 9.956 0 01-6-2 9.985 9.985 0 01-4-8C2 6.477 6.477 2 12 2s10 4.477 10 10a9.99 9.99 0 01-4.409 8.292zM12 12.5c1.657 0 3-1.455 3-3.25S13.657 6 12 6 9 7.455 9 9.25s1.343 3.25 3 3.25zm0 7.5a7.974 7.974 0 005.563-2.251 6.002 6.002 0 00-11.126 0A7.973 7.973 0 0012 20z"}))),ct||(ct=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M17.591 20.292A9.954 9.954 0 0112 22a9.956 9.956 0 01-6-2 9.985 9.985 0 01-4-8C2 6.477 6.477 2 12 2s10 4.477 10 10a9.99 9.99 0 01-4.409 8.292zM12 12.5c1.657 0 3-1.455 3-3.25S13.657 6 12 6 9 7.455 9 9.25s1.343 3.25 3 3.25zm0 7.5a7.974 7.974 0 005.563-2.251 6.002 6.002 0 00-11.126 0A7.973 7.973 0 0012 20z",fill:"#000"})),lt||(lt=s.createElement("path",{d:"M17.591 20.292l-1.12-1.657 1.12 1.657zM6 20.001L4.799 21.6 6 20zm11.563-2.252l1.391 1.437.97-.938-.507-1.25-1.854.75zm-11.126 0l-1.854-.751-.506 1.25.969.938 1.39-1.437zM12 24c2.482 0 4.794-.756 6.71-2.05l-2.239-3.315A7.954 7.954 0 0112 20v4zm-7.201-2.4A11.956 11.956 0 0012 24v-4a7.955 7.955 0 01-4.799-1.598L4.8 21.6zM0 12c0 3.927 1.889 7.414 4.799 9.6L7.2 18.402A7.985 7.985 0 014 12H0zM12 0C5.373 0 0 5.373 0 12h4a8 8 0 018-8V0zm12 12c0-6.627-5.373-12-12-12v4a8 8 0 018 8h4zm-5.29 9.95A11.99 11.99 0 0024 12h-4a7.99 7.99 0 01-3.529 6.635l2.24 3.314zM13 9.25c0 .844-.595 1.25-1 1.25v4c2.91 0 5-2.504 5-5.25h-4zM12 8c.405 0 1 .406 1 1.25h4C17 6.504 14.91 4 12 4v4zm-1 1.25c0-.844.595-1.25 1-1.25V4C9.09 4 7 6.504 7 9.25h4zm1 1.25c-.405 0-1-.406-1-1.25H7c0 2.746 2.09 5.25 5 5.25v-4zm4.172 5.812A5.974 5.974 0 0112 18v4a9.973 9.973 0 006.954-2.814l-2.782-2.874zM12 16a4.002 4.002 0 013.71 2.5l3.707-1.502A8.002 8.002 0 0012 12v4zm-3.71 2.5A4.002 4.002 0 0112 16v-4a8.002 8.002 0 00-7.417 4.998L8.29 18.5zM12 18a5.974 5.974 0 01-4.172-1.688l-2.782 2.874A9.973 9.973 0 0012 22v-4z",fill:"#000",mask:"url(#members_svg__a)"})))}var ht;function ut(){return(ut=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function pt(e){return s.createElement("svg",ut({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),ht||(ht=s.createElement("path",{d:"M8.414 1.432c.178-.576.994-.576 1.172 0l1.585 5.131h5.215c.586 0 .838.745.372 1.1l-4.244 3.243 1.604 5.194c.177.57-.483 1.03-.958.668L9 13.59l-4.16 3.178c-.475.363-1.135-.098-.959-.668l1.606-5.194-4.245-3.242c-.466-.356-.214-1.1.372-1.1H6.83l1.585-5.132z",fill:"#000"})))}var gt=a(95),bt=a(575),vt=a(129);var ft=e=>{let{isPanelCollapsed:t=!1}=e;const[a,n,i,s]=Object(ve.q)(),{[ce.a.Favourites]:r,[ce.a.People]:c}=Object(be.b)("Spaces.enabledMetaSpaces");let d;return a&&(d=o.a.createElement(ve.o,ue()({},Object(ve.m)(n.current.getBoundingClientRect(),ve.a.None,16),{wrapperClassName:"mx_QuickSettingsButton_ContextMenuWrapper",onFinished:s,managed:!1,focusLock:!0}),o.a.createElement("h2",null,Object(N.a)("Quick settings")),o.a.createElement(U.a,{onClick:()=>{s(),b.a.dispatch({action:M.a.ViewUserSettings})},kind:"primary_outline"},Object(N.a)("All settings")),v.b.getValue("developerMode")&&o.a.createElement(U.a,{onClick:()=>{s(),gt.a.createDialog(bt.a,{roomId:vt.a.instance.getRoomId()},"mx_DevtoolsDialog_wrapper")},kind:"danger_outline"},Object(N.a)("Developer tools")),o.a.createElement("h4",{className:"mx_QuickSettingsButton_pinToSidebarHeading"},o.a.createElement(tt,{className:"mx_QuickSettingsButton_icon"}),Object(N.a)("Pin to sidebar")),o.a.createElement(Ke.b,{className:"mx_QuickSettingsButton_favouritesCheckbox",checked:!!r,onChange:Object(qe.b)(ce.a.Favourites,"WebQuickSettingsPinToSidebarCheckbox")},o.a.createElement(pt,{className:"mx_QuickSettingsButton_icon"}),Object(N.a)("Favourites")),o.a.createElement(Ke.b,{className:"mx_QuickSettingsButton_peopleCheckbox",checked:!!c,onChange:Object(qe.b)(ce.a.People,"WebQuickSettingsPinToSidebarCheckbox")},o.a.createElement(mt,{className:"mx_QuickSettingsButton_icon"}),Object(N.a)("People")),o.a.createElement(U.a,{className:"mx_QuickSettingsButton_moreOptionsButton",onClick:()=>{s(),b.a.dispatch({action:M.a.ViewUserSettings,initialTabId:Ge.a.Sidebar})}},o.a.createElement(ot,{className:"mx_QuickSettingsButton_icon"}),Object(N.a)("More options")),o.a.createElement(Ze,{requestClose:s}))),o.a.createElement(o.a.Fragment,null,o.a.createElement(oe.a,{className:l()("mx_QuickSettingsButton",{expanded:!t}),onClick:i,title:Object(N.a)("Quick settings"),inputRef:n,forceHide:!t},t?null:Object(N.a)("Settings")),d)},Et=a(90),yt=a(115),_t=a(105),St=a(230),wt=a(212),Ct=a(338),Ot=a(344);var kt=e=>{const t=Object(s.useRef)(),[a,n]=Object(s.useState)(""),[i,r]=Object(Ot.a)(!1);Object(s.useEffect)(()=>{var e;null===(e=t.current)||void 0===e||e.focus()},[]);const c=()=>{e.onFinished(),gt.a.createTrackedDialog("Bug Report Dialog","",St.a,{})},l=P.b.get().bug_report_endpoint_url,d=!!l;let m;l&&(m=o.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_rateApp"},o.a.createElement("h3",null,Object(N.a)("Comment")),o.a.createElement("p",null,Object(N.a)("Your platform and username will be noted to help us use your feedback as much as we can.")),o.a.createElement(_t.a,{id:"feedbackComment",label:Object(N.a)("Feedback"),type:"text",autoComplete:"off",value:a,element:"textarea",onChange:e=>{n(e.target.value)},ref:t}),o.a.createElement(Ke.b,{checked:i,onChange:r},Object(N.a)("You may contact me if you want to follow up or to let me test out upcoming ideas"))));let h=null;return l&&(h=o.a.createElement("p",{className:"mx_FeedbackDialog_section_microcopy"},Object(N.a)("PRO TIP: If you start a bug, please submit <debugLogsLink>debug logs</debugLogsLink> to help us track down the problem.",{},{debugLogsLink:e=>o.a.createElement(U.a,{kind:"link",onClick:c},e)}))),o.a.createElement(yt.a,{className:"mx_FeedbackDialog",hasCancelButton:!!d,title:Object(N.a)("Feedback"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_reportBug"},o.a.createElement("h3",null,Object(N.a)("Report a bug")),o.a.createElement("p",null,Object(N.a)("Please view <existingIssuesLink>existing bugs on Github</existingIssuesLink> first. No match? <newIssueLink>Start a new one</newIssueLink>.",{},{existingIssuesLink:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/vector-im/element-web/issues?q=is%3Aopen+is%3Aissue+sort%3Areactions-%2B1-desc"},e),newIssueLink:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/vector-im/element-web/issues/new/choose"},e)})),h),m),button:d?Object(N.a)("Send feedback"):Object(N.a)("Go back"),buttonDisabled:d&&!a,onFinished:t=>{d&&t&&(l&&Object(Ct.c)(l,"feedback",a,i),gt.a.createTrackedDialog("Feedback sent","",wt.a,{title:Object(N.a)("Feedback sent"),description:Object(N.a)("Thank you!")})),e.onFinished()}})},xt=a(821);class Rt extends L.a{constructor(){super(b.a,{hostSignupActive:!1})}static get instance(){return Rt.internalInstance}get isHostSignupActive(){return this.state.hostSignupActive}async setHostSignupActive(e){return this.updateState({hostSignupActive:e})}onDispatch(e){}}i()(Rt,"internalInstance",new Rt);class jt extends o.a.PureComponent{constructor(){super(...arguments),i()(this,"openDialog",async()=>{var e,t;null===(e=(t=this.props).onClick)||void 0===e||e.call(t),await Rt.instance.setHostSignupActive(!0)})}render(){const e=P.b.getObject("host_signup");return null!=e&&e.get("brand")?o.a.createElement(ye.c,null,o.a.createElement(ye.b,{iconClassName:"mx_UserMenu_iconHosting",label:Object(N.a)("Upgrade to %(hostSignupBrand)s",{hostSignupBrand:e.get("brand")}),onClick:this.openDialog})):null}}var It=a(207);class Tt extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"themeWatcherRef",void 0),i()(this,"dndWatcherRef",void 0),i()(this,"buttonRef",Object(s.createRef)()),i()(this,"onProfileUpdate",async()=>{this.forceUpdate()}),i()(this,"onSelectedSpaceUpdate",async()=>{this.setState({selectedSpace:re.a.instance.activeSpaceRoom})}),i()(this,"onThemeChanged",()=>{this.setState({isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme()})}),i()(this,"onAction",e=>{switch(e.action){case M.a.ToggleUserMenu:this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click()}}),i()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:e.currentTarget.getBoundingClientRect()})}),i()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})}),i()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),i()(this,"onSwitchThemeClick",e=>{e.preventDefault(),e.stopPropagation(),W.b.trackInteraction("WebUserMenuThemeToggleButton",e),v.b.setValue("use_system_theme",null,f.a.DEVICE,!1);let t=this.state.isDarkTheme?"light":"dark";if(this.state.isHighContrast){const e=Object(Ye.c)(t);e&&(t=e)}v.b.setValue("theme",null,f.a.DEVICE,t)}),i()(this,"onSettingsOpen",(e,t)=>{e.preventDefault(),e.stopPropagation();const a={action:M.a.ViewUserSettings,initialTabId:t};b.a.dispatch(a),this.setState({contextMenuPosition:null})}),i()(this,"onProvideFeedback",e=>{e.preventDefault(),e.stopPropagation(),gt.a.createTrackedDialog("Feedback Dialog","",kt),this.setState({contextMenuPosition:null})}),i()(this,"onSignOutClick",async e=>{var t;e.preventDefault(),e.stopPropagation();const a=Et.a.get();a&&a.isCryptoEnabled()&&null!==(t=await a.exportRoomKeys())&&void 0!==t&&t.length?gt.a.createTrackedDialog("Logout from LeftPanel","",xt.a):b.a.dispatch({action:"logout"}),this.setState({contextMenuPosition:null})}),i()(this,"onSignInClick",()=>{b.a.dispatch({action:"start_login"}),this.setState({contextMenuPosition:null})}),i()(this,"onRegisterClick",()=>{b.a.dispatch({action:"start_registration"}),this.setState({contextMenuPosition:null})}),i()(this,"onHomeClick",e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:M.a.ViewHomePage}),this.setState({contextMenuPosition:null})}),i()(this,"renderContextMenu",()=>{if(!this.state.contextMenuPosition)return null;let e;const t=P.b.getObject("host_signup");if(Et.a.get().isGuest())e=o.a.createElement("div",{className:"mx_UserMenu_contextMenu_header mx_UserMenu_contextMenu_guestPrompts"},Object(N.a)("Got an account? <a>Sign in</a>",{},{a:e=>o.a.createElement(U.a,{kind:"link",onClick:this.onSignInClick},e)}),Object(N.a)("New here? <a>Create an account</a>",{},{a:e=>o.a.createElement(U.a,{kind:"link",onClick:this.onRegisterClick},e)}));else if(null!=t&&t.get("url")){const a=t.get("domains")||[],n=Et.a.get().getDomain(),i=a.filter(e=>e===n||n.endsWith("."+e));(!t.get("domains")||i.length>0)&&(e=o.a.createElement(jt,{onClick:this.onCloseMenu}))}let n,i=null;this.hasHomePage&&(i=o.a.createElement(ye.b,{iconClassName:"mx_UserMenu_iconHome",label:Object(N.a)("Home"),onClick:this.onHomeClick})),v.b.getValue(Oe.b.Feedback)&&(n=o.a.createElement(ye.b,{iconClassName:"mx_UserMenu_iconMessage",label:Object(N.a)("Feedback"),onClick:this.onProvideFeedback}));let s=o.a.createElement(ye.c,null,i,o.a.createElement(ye.b,{iconClassName:"mx_UserMenu_iconBell",label:Object(N.a)("Notifications"),onClick:e=>this.onSettingsOpen(e,Ge.a.Notifications)}),o.a.createElement(ye.b,{iconClassName:"mx_UserMenu_iconLock",label:Object(N.a)("Security & Privacy"),onClick:e=>this.onSettingsOpen(e,Ge.a.Security)}),o.a.createElement(ye.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(N.a)("All settings"),onClick:e=>this.onSettingsOpen(e,null)}),n,o.a.createElement(ye.b,{className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_UserMenu_iconSignOut",label:Object(N.a)("Sign out"),onClick:this.onSignOutClick}));Et.a.get().isGuest()&&(s=o.a.createElement(ye.c,null,i,o.a.createElement(ye.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(N.a)("Settings"),onClick:e=>this.onSettingsOpen(e,null)}),n));const r=this.props.isPanelCollapsed?{left:(c=this.state.contextMenuPosition).width+c.left+8,top:c.top,chevronFace:ve.a.None}:(e=>({left:e.left,top:e.top+e.height,chevronFace:ve.a.None}))(this.state.contextMenuPosition);var c;return o.a.createElement(ye.e,ue()({},r,{onFinished:this.onCloseMenu,className:"mx_UserMenu_contextMenu"}),o.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},o.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},o.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},A.a.instance.displayName),o.a.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},It.a.getDisplayUserIdentifier(Et.a.get().getUserId(),{withDisplayName:!0}))),o.a.createElement(me.b,{className:"mx_UserMenu_contextMenu_themeButton",onClick:this.onSwitchThemeClick,title:this.state.isDarkTheme?Object(N.a)("Switch to light mode"):Object(N.a)("Switch to dark mode")},o.a.createElement("img",{src:a(1414).default,alt:Object(N.a)("Switch theme"),width:16}))),e,s)}),this.state={contextMenuPosition:null,isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme(),selectedSpace:re.a.instance.activeSpaceRoom},A.a.instance.on(L.b,this.onProfileUpdate),re.a.instance.on(ce.d,this.onSelectedSpaceUpdate)}get hasHomePage(){return!!Object(T.a)(P.b.get())}componentDidMount(){this.dispatcherRef=b.a.register(this.onAction),this.themeWatcherRef=v.b.watchSetting("theme",null,this.onThemeChanged)}componentWillUnmount(){this.themeWatcherRef&&v.b.unwatchSetting(this.themeWatcherRef),this.dndWatcherRef&&v.b.unwatchSetting(this.dndWatcherRef),this.dispatcherRef&&b.a.unregister(this.dispatcherRef),A.a.instance.off(L.b,this.onProfileUpdate),re.a.instance.off(ce.d,this.onSelectedSpaceUpdate)}isUserOnDarkTheme(){if(v.b.getValue("use_system_theme"))return window.matchMedia("(prefers-color-scheme: dark)").matches;{const e=v.b.getValue("theme");return e.startsWith("custom-")?Object(Ye.e)(e.substring("custom-".length)).is_dark:"dark"===e}}isUserOnHighContrastTheme(){if(v.b.getValue("use_system_theme"))return window.matchMedia("(prefers-contrast: more)").matches;{const e=v.b.getValue("theme");return!e.startsWith("custom-")&&Object(Ye.g)(e)}}render(){const e=Et.a.get().getUserId(),t=A.a.instance.displayName||e,a=A.a.instance.getHttpAvatarUrl(32);let n;return this.props.isPanelCollapsed||(n=o.a.createElement("div",{className:"mx_UserMenu_name"},t)),o.a.createElement("div",{className:"mx_UserMenu"},o.a.createElement(ve.b,{onClick:this.onOpenMenuClick,inputRef:this.buttonRef,label:Object(N.a)("User menu"),isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},o.a.createElement("div",{className:"mx_UserMenu_userAvatar"},o.a.createElement(D.a,{idName:e,name:t,url:a,width:32,height:32,resizeMethod:"crop",className:"mx_UserMenu_userAvatar_BaseAvatar"})),n,this.renderContextMenu()),this.props.children)}}const Nt=["children","trackHorizontalOverflow","verticalScrollsHorizontally"];class Pt extends o.a.Component{constructor(e){super(e),i()(this,"autoHideScrollbar",Object(s.createRef)()),i()(this,"scrollElement",void 0),i()(this,"likelyTrackpadUser",null),i()(this,"checkAgainForTrackpad",0),i()(this,"collectScroller",e=>{var t,a;null===(t=(a=this.props).wrappedRef)||void 0===t||t.call(a,e),e&&!this.scrollElement&&(this.scrollElement=e,this.scrollElement.addEventListener("scroll",this.checkOverflow,{passive:!0}),this.checkOverflow())}),i()(this,"checkOverflow",()=>{const e=this.scrollElement.scrollTop>0,t=this.scrollElement.scrollHeight>this.scrollElement.scrollTop+this.scrollElement.clientHeight,a=this.scrollElement.scrollLeft>0,n=this.scrollElement.scrollWidth>this.scrollElement.scrollLeft+this.scrollElement.clientWidth;e?this.scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this.scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),a?this.scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),n?this.scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:a?this.scrollElement.scrollLeft+"px":"0",rightIndicatorOffset:n?`-${this.scrollElement.scrollLeft}px`:"0"})}),i()(this,"onMouseWheel",e=>{if(this.props.verticalScrollsHorizontally&&this.scrollElement){const t=0,a=1,n=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this.likelyTrackpadUser=!0,this.checkAgainForTrackpad=n+6e4):this.likelyTrackpadUser&&n>=this.checkAgainForTrackpad&&(this.likelyTrackpadUser=!1),this.likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,n=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this.scrollElement.scrollLeft+=n*a}}}),this.state={leftIndicatorOffset:"0",rightIndicatorOffset:"0"}}componentDidUpdate(e){o.a.Children.count(e.children)!==o.a.Children.count(this.props.children)&&this.checkOverflow()}componentDidMount(){this.checkOverflow(),de.b.instance.on(de.a.Resize,this.checkOverflow)}componentWillUnmount(){var e;null===(e=this.scrollElement)||void 0===e||e.removeEventListener("scroll",this.checkOverflow),de.b.instance.off(de.a.Resize,this.checkOverflow)}render(){const e=this.props,{children:t,trackHorizontalOverflow:a,verticalScrollsHorizontally:n}=e,i=Ee()(e,Nt),s={left:this.state.leftIndicatorOffset},r={right:this.state.rightIndicatorOffset},c=a?o.a.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:s}):null,l=a?o.a.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:r}):null;return o.a.createElement(I.a,ue()({},i,{ref:this.autoHideScrollbar,wrappedRef:this.collectScroller,onWheel:this.onMouseWheel}),c,t,l)}}var Mt=a(234);const Dt=["onFinished","hideHeader"],At=["selected","isPanelCollapsed"],Ut=["children","isPanelCollapsed","setPanelCollapsed","isDraggingOver","innerRef"],Lt=e=>{let{onFinished:t,hideHeader:a}=e,n=Ee()(e,Dt);const i=Object(be.b)("Spaces.allRoomsInHome");return o.a.createElement(ye.e,ue()({},n,{onFinished:t,className:"mx_SpacePanel_contextMenu",compact:!0}),!a&&o.a.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},Object(N.a)("Home")),o.a.createElement(ye.c,{first:!0},o.a.createElement(ye.a,{iconClassName:"mx_SpacePanel_noIcon",label:Object(N.a)("Show all rooms"),active:i,onClick:()=>{v.b.setValue("Spaces.allRoomsInHome",null,f.a.ACCOUNT,!i)}})))},Ft=e=>{let{selected:t,isPanelCollapsed:a}=e,n=Ee()(e,At);return o.a.createElement("li",{className:l()("mx_SpaceItem",{collapsed:a}),role:"treeitem"},o.a.createElement(Ve,ue()({},n,{selected:t,isNarrow:a})))},Bt=()=>re.a.instance.allRoomsInHome?ze.a.instance.globalState:re.a.instance.getNotificationState(ce.a.Home),Vt=e=>{let{isPanelCollapsed:t,setPanelCollapsed:a}=e;const[n,i,r,c]=Object(ve.q)();Object(s.useEffect)(()=>{!t&&n&&c()},[t]);let d=null;n&&(d=o.a.createElement(je.d,{onFinished:c}));const m=n?c:()=>{t||a(!0),r()};return o.a.createElement("li",{className:l()("mx_SpaceItem mx_SpaceItem_new",{collapsed:t}),role:"treeitem"},o.a.createElement(Ve,{"data-test-id":"create-space-button",className:l()("mx_SpaceButton_new",{mx_SpaceButton_newCancel:n}),label:n?Object(N.a)("Cancel"):Object(N.a)("Create a space"),onClick:m,isNarrow:t}),d)},Wt={[ce.a.Home]:e=>{let{selected:t,isPanelCollapsed:a}=e;const n=Object(F.b)(re.a.instance,ce.b,()=>re.a.instance.allRoomsInHome),[i,r]=Object(s.useState)(Bt()),c=Object(s.useCallback)(()=>{r(Bt())},[]);return Object(s.useEffect)(c,[c,n]),Object(F.a)(ze.a.instance,ze.b,c),o.a.createElement(Ft,{spaceKey:ce.a.Home,className:"mx_SpaceButton_home",selected:t,isPanelCollapsed:a,label:Object(ce.g)(ce.a.Home,n),notificationState:i,ContextMenuComponent:Lt,contextMenuTooltip:Object(N.a)("Options")})},[ce.a.Favourites]:e=>{let{selected:t,isPanelCollapsed:a}=e;return o.a.createElement(Ft,{spaceKey:ce.a.Favourites,className:"mx_SpaceButton_favourites",selected:t,isPanelCollapsed:a,label:Object(ce.g)(ce.a.Favourites),notificationState:re.a.instance.getNotificationState(ce.a.Favourites)})},[ce.a.People]:e=>{let{selected:t,isPanelCollapsed:a}=e;return o.a.createElement(Ft,{spaceKey:ce.a.People,className:"mx_SpaceButton_people",selected:t,isPanelCollapsed:a,label:Object(ce.g)(ce.a.People),notificationState:re.a.instance.getNotificationState(ce.a.People)})},[ce.a.Orphans]:e=>{let{selected:t,isPanelCollapsed:a}=e;return o.a.createElement(Ft,{spaceKey:ce.a.Orphans,className:"mx_SpaceButton_orphans",selected:t,isPanelCollapsed:a,label:Object(ce.g)(ce.a.Orphans),notificationState:re.a.instance.getNotificationState(ce.a.Orphans)})}},Ht=o.a.memo(e=>{let{children:t,isPanelCollapsed:a,setPanelCollapsed:n,isDraggingOver:i,innerRef:s}=e,r=Ee()(e,Ut);const[c,l,d,m]=(()=>{const e=Object(F.b)(re.a.instance,ce.c,()=>re.a.instance.invitedSpaces),[t,a]=Object(F.b)(re.a.instance,ce.f,()=>[re.a.instance.enabledMetaSpaces,re.a.instance.spacePanelSpaces]);return[e,t,a,Object(F.b)(re.a.instance,ce.d,()=>re.a.instance.activeSpace)]})(),h=m?[m]:[],u=l.map(e=>{const t=Wt[e];return o.a.createElement(t,{key:e,selected:m===e,isPanelCollapsed:a})});return o.a.createElement(Pt,ue()({},r,{wrappedRef:s,className:"mx_SpaceTreeLevel",style:i?{pointerEvents:"none"}:void 0}),u,c.map(e=>o.a.createElement(We,{key:e.roomId,space:e,activeSpaces:h,isPanelCollapsed:a,onExpand:()=>n(!1)})),d.map((e,t)=>o.a.createElement(Re.Draggable,{key:e.roomId,draggableId:e.roomId,index:t},(t,i)=>o.a.createElement(We,ue()({},t.draggableProps,{dragHandleProps:t.dragHandleProps,key:e.roomId,innerRef:t.innerRef,className:i.isDragging?"mx_SpaceItem_dragging":void 0,space:e,activeSpaces:h,isPanelCollapsed:a,onExpand:()=>n(!1)})))),t,Object(Ce.a)(Oe.a.CreateSpaces)&&o.a.createElement(Vt,{isPanelCollapsed:a,setPanelCollapsed:n}))});var zt=()=>{const[e,t]=Object(s.useState)(!0),a=Object(s.useRef)();return Object(s.useLayoutEffect)(()=>(de.b.instance.trackElementDimensions("SpacePanel",a.current),()=>de.b.instance.stopTrackingElementDimensions("SpacePanel")),[]),Object(Mt.a)(b.a,a=>{a.action===M.a.ToggleSpacePanel&&t(!e)}),o.a.createElement(Re.DragDropContext,{onDragEnd:e=>{e.destination&&re.a.instance.moveRootSpace(e.source.index,e.destination.index)}},o.a.createElement(me.d,{handleHomeEnd:!0,handleUpDown:!0},n=>{let{onKeyDownHandler:i}=n;return o.a.createElement("ul",{className:l()("mx_SpacePanel",{collapsed:e}),onKeyDown:i,role:"tree","aria-label":Object(N.a)("Spaces"),ref:a},o.a.createElement(Tt,{isPanelCollapsed:e},o.a.createElement(oe.a,{className:l()("mx_SpacePanel_toggleCollapse",{expanded:!e}),onClick:()=>t(!e),title:e?Object(N.a)("Expand"):Object(N.a)("Collapse"),tooltip:o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Tooltip_title"},e?Object(N.a)("Expand"):Object(N.a)("Collapse")),o.a.createElement("div",{className:"mx_Tooltip_sub"},h.a?"⌘ + ⇧ + D":Object(N.a)(Ue.a[h.b.CONTROL])+" + "+Object(N.a)(Ue.a[h.b.SHIFT])+" + D"))})),o.a.createElement(Re.Droppable,{droppableId:"top-level-spaces"},(a,n)=>o.a.createElement(Ht,ue()({},a.droppableProps,{isPanelCollapsed:e,setPanelCollapsed:t,isDraggingOver:n.isDraggingOver,innerRef:a.innerRef}),a.placeholder)),o.a.createElement(ft,{isPanelCollapsed:e}))}))},Kt=a(170),qt=a(189),Gt=a(236),Yt=a(817);const Jt=e=>({left:e.left+window.scrollX,top:e.bottom+window.scrollY+12,chevronFace:ve.a.None});var $t;!function(e){e[e.JoinRoom=0]="JoinRoom",e[e.BulkRedact=1]="BulkRedact"}($t||($t={}));var Qt=e=>{var t;let{onVisibilityChange:a}=e;const n=Object(s.useContext)(j.a),[i,c,l,d]=Object(ve.q)(),[m,h,u,p]=Object(ve.q)(),[g,v]=Object(F.b)(re.a.instance,ce.d,()=>[re.a.instance.activeSpace,re.a.instance.activeSpaceRoom]),f=Object(F.b)(re.a.instance,ce.b,()=>re.a.instance.allRoomsInHome),E=Object(be.a)("feature_video_rooms"),y=(()=>{const e=Object(s.useContext)(j.a),[t,a]=Object(s.useState)(new Map),n=(e,n)=>{const i=new Set(t.get(e));i.add(n),a(new Map(t).set(e,i))},i=(e,n)=>{const i=new Set(t.get(e));i.delete(n)&&a(new Map(t).set(e,i))};return Object(Mt.a)(b.a,e=>{switch(e.action){case M.a.JoinRoom:n($t.JoinRoom,e.roomId);break;case M.a.JoinRoomReady:case M.a.JoinRoomError:i($t.JoinRoom,e.roomId);break;case M.a.BulkRedactStart:n($t.BulkRedact,e.roomId);break;case M.a.BulkRedactEnd:i($t.BulkRedact,e.roomId)}}),Object(F.c)(e,r.b.Room,e=>i($t.JoinRoom,e.roomId)),t})(),_=qt.b.instance.getFirstNameFilterCondition(),S=Object(F.b)(qt.b.instance,qt.a,()=>_?Object.values(qt.b.instance.orderedLists).flat(1).length:null),w=v||g===ce.a.Home;Object(s.useEffect)(()=>{i&&!w&&d()},[d,w,i]),Object(Yt.b)(S,_?_.search.length:null,!1);const C=Object(F.d)(v,pe.c.Name,()=>null==v?void 0:v.name);if(Object(s.useEffect)(()=>{a&&a()},[S,a]),"number"==typeof S)return o.a.createElement("div",{className:"mx_LeftPanel_roomListFilterCount"},Object(N.a)("%(count)s results",{count:S}));const O=null==v||null===(t=v.currentState)||void 0===t?void 0:t.maySendStateEvent(ge.b.SpaceChild,n.getUserId()),k=Object(Ce.a)(Oe.a.CreateRooms),x=Object(Ce.a)(Oe.a.ExploreRooms),R=k||x||v;let I,T;if(i&&c.current){let e;e=v?xe:Lt,I=o.a.createElement(e,ue()({},Jt(c.current.getBoundingClientRect()),{space:v,onFinished:d,hideHeader:!0}))}else if(m&&v){let e,t;Object(_e.c)(v)&&(e=o.a.createElement(ye.b,{label:Object(N.a)("Invite"),iconClassName:"mx_RoomListHeader_iconInvite",onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(_e.i)(v),p()}})),null!=v&&v.currentState.maySendStateEvent(ge.b.RoomAvatar,n.getUserId())&&(t=o.a.createElement(o.a.Fragment,null,o.a.createElement(ye.b,{iconClassName:"mx_RoomListHeader_iconNewRoom",label:Object(N.a)("New room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(_e.g)(v),W.b.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),p()}}),E&&o.a.createElement(ye.b,{iconClassName:"mx_RoomListHeader_iconNewVideoRoom",label:Object(N.a)("New video room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(_e.g)(v,ge.f.ElementVideo),p()}}))),I=o.a.createElement(ye.e,ue()({},Jt(h.current.getBoundingClientRect()),{onFinished:p,compact:!0}),o.a.createElement(ye.c,{first:!0},e,t,o.a.createElement(ye.b,{label:Object(N.a)("Explore rooms"),iconClassName:"mx_RoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:M.a.ViewRoom,room_id:v.roomId,metricsTrigger:void 0}),p(),W.b.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e)}}),o.a.createElement(ye.b,{label:Object(N.a)("Add existing room"),iconClassName:"mx_RoomListHeader_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(_e.e)(v),p()},disabled:!O,tooltip:!O&&Object(N.a)("You do not have permissions to add rooms to this space")}),o.a.createElement(ye.b,{label:Object(N.a)("Add space"),iconClassName:"mx_RoomListHeader_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(_e.h)(v),p()},disabled:!O,tooltip:!O&&Object(N.a)("You do not have permissions to add spaces to this space")},o.a.createElement(we.a,null))))}else if(m){let e,t;k&&(e=o.a.createElement(o.a.Fragment,null,o.a.createElement(ye.b,{label:Object(N.a)("Start new chat"),iconClassName:"mx_RoomListHeader_iconStartChat",onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"view_create_chat"}),W.b.trackInteraction("WebRoomListHeaderPlusMenuCreateChatItem",e),p()}}),o.a.createElement(ye.b,{label:Object(N.a)("New room"),iconClassName:"mx_RoomListHeader_iconNewRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"view_create_room"}),W.b.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),p()}}),E&&o.a.createElement(ye.b,{label:Object(N.a)("New video room"),iconClassName:"mx_RoomListHeader_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"view_create_room",type:ge.f.ElementVideo}),p()}}))),x&&(t=o.a.createElement(ye.b,{label:Object(N.a)("Join public room"),iconClassName:"mx_RoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:M.a.ViewRoomDirectory}),W.b.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e),p()}})),I=o.a.createElement(ye.e,ue()({},Jt(h.current.getBoundingClientRect()),{onFinished:p,compact:!0}),o.a.createElement(ye.c,{first:!0},e,t))}T=v?C:Object(ce.g)(g,f);const P=[...y.entries()].filter(e=>{let[t,a]=e;return a.size>0}).map(e=>{let[t,a]=e;switch(t){case $t.JoinRoom:return Object(N.a)("Currently joining %(count)s rooms",{count:a.size});case $t.BulkRedact:return Object(N.a)("Currently removing messages in %(count)s rooms",{count:a.size})}}).join("\n");let D=o.a.createElement("div",{className:"mx_RoomListHeader_contextLessTitle"},T);return w&&(D=o.a.createElement(ve.c,{inputRef:c,onClick:l,isExpanded:i,className:"mx_RoomListHeader_contextMenuButton",title:v?Object(N.a)("%(spaceName)s menu",{spaceName:C}):Object(N.a)("Home options")},T)),o.a.createElement("div",{className:"mx_RoomListHeader"},D,P?o.a.createElement(Gt.a,{label:P},o.a.createElement(Kt.a,null)):null,R&&o.a.createElement(ve.c,{inputRef:h,onClick:u,isExpanded:m,className:"mx_RoomListHeader_plusButton",title:Object(N.a)("Add")}),I)},Xt=a(415),Zt=a(150),ea=a.n(Zt);function ta(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function aa(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ta(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ta(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function na(){let e=document.getElementById("mx_InteractiveTooltip_Container");return e||(e=document.createElement("div"),e.id="mx_InteractiveTooltip_Container",document.body.appendChild(e)),e}function ia(e,t,a){const{top:n,right:i,bottom:s,left:o}=a;return e>=o&&e<=i&&t>=n&&t<=s}function sa(e){const{top:t,right:a,bottom:n,left:i}=e;return(n-t)/(a-i)}function oa(e,t,a){const{bottom:n,left:i}=a,s=-1*sa(a);return ia(e,t,a)&&t<=n+s*(e-i)}function ra(e,t,a){const{bottom:n,left:i}=a,s=-1*sa(a);return ia(e,t,a)&&t>=n+s*(e-i)}function ca(e,t,a){const{top:n,left:i}=a,s=1*sa(a);return ia(e,t,a)&&t<=n+s*(e-i)}function la(e,t,a){const{top:n,left:i}=a,s=1*sa(a);return ia(e,t,a)&&t>=n+s*(e-i)}let da;!function(e){e[e.Top=0]="Top",e[e.Left=1]="Left",e[e.Bottom=2]="Bottom",e[e.Right=3]="Right"}(da||(da={}));class ma extends o.a.Component{constructor(e,t){super(e,t),i()(this,"target",void 0),i()(this,"collectContentRect",e=>{e&&this.setState({contentRect:e.getBoundingClientRect()})}),i()(this,"collectTarget",e=>{this.target=e}),i()(this,"onMouseMove",e=>{const{clientX:t,clientY:a}=e,{contentRect:n}=this.state,i=this.target.getBoundingClientRect();let s;s=this.isOnTheSide?this.onLeftOfTarget()?da.Left:da.Right:this.aboveTarget()?da.Top:da.Bottom,function(e,t,a,n,i){if(ia(e,t,n))return!0;switch(a){case da.Left:{const a={top:i.top-50,right:i.right,bottom:i.bottom+50,left:i.left-50},s={top:i.top-50,right:n.right,bottom:n.top,left:i.right},o={top:n.top,right:n.left,bottom:n.bottom,left:i.right},r={top:n.bottom,right:n.right,bottom:i.bottom+50,left:i.right};if(ia(e,t,a)||la(e,t,s)||ia(e,t,o)||oa(e,t,r))return!0;break}case da.Right:{const a={top:i.top-50,right:i.right+50,bottom:i.bottom+50,left:i.left},s={top:i.top-50,right:i.left,bottom:n.top,left:n.left},o={top:n.top,right:i.left,bottom:n.bottom,left:n.right},r={top:n.bottom,right:i.left,bottom:i.bottom+50,left:n.left};if(ia(e,t,a)||ra(e,t,s)||ia(e,t,o)||ca(e,t,r))return!0;break}case da.Top:{const a={top:i.top-50,right:i.right+50,bottom:i.bottom,left:i.left-50},s={top:i.bottom,right:n.left,bottom:n.bottom,left:i.left-50},o={top:i.bottom,right:n.right,bottom:n.top,left:n.left},r={top:i.bottom,right:i.right+50,bottom:n.bottom,left:n.right};if(ia(e,t,a)||ca(e,t,s)||ia(e,t,o)||oa(e,t,r))return!0;break}case da.Bottom:{const a={top:i.top,right:i.right+50,bottom:i.bottom+50,left:i.left-50},s={top:n.top,right:n.left,bottom:i.top,left:i.left-50},o={top:n.bottom,right:n.right,bottom:i.top,left:n.left},r={top:n.top,right:i.right+50,bottom:i.top,left:n.right};if(ia(e,t,a)||ra(e,t,s)||ia(e,t,o)||la(e,t,r))return!0;break}}return!1}(t,a,s,i,n)||this.hideTooltip()}),i()(this,"onTargetMouseOver",()=>{this.showTooltip()}),this.state={contentRect:null,visible:!1}}componentDidUpdate(){this.renderTooltip()}componentWillUnmount(){document.removeEventListener("mousemove",this.onMouseMove)}onLeftOfTarget(){const{contentRect:e}=this.state,t=this.target.getBoundingClientRect();if(this.props.direction===da.Left){const a=t.left+window.scrollX;return!e||a-e.width>20}{const a=t.right+window.scrollX,n=de.b.instance.windowWidth-a;return e&&n-e.width<20}}aboveTarget(){const{contentRect:e}=this.state,t=this.target.getBoundingClientRect();if(this.props.direction===da.Top){const a=t.top+window.scrollY;return!e||a-e.height>20}{const a=t.bottom+window.scrollY,n=de.b.instance.windowHeight-a;return e&&n-e.height<20}}get isOnTheSide(){return this.props.direction===da.Left||this.props.direction===da.Right}showTooltip(){var e,t;this.target&&(this.setState({visible:!0}),null===(e=(t=this.props).onVisibilityChange)||void 0===e||e.call(t,!0),document.addEventListener("mousemove",this.onMouseMove))}hideTooltip(){var e,t;this.setState({visible:!1}),null===(e=(t=this.props).onVisibilityChange)||void 0===e||e.call(t,!1),document.removeEventListener("mousemove",this.onMouseMove)}renderTooltip(){const{contentRect:e,visible:t}=this.state;if(!t)return ea.a.unmountComponentAtNode(na()),null;const a=this.target.getBoundingClientRect(),n=a.left+window.scrollX,i=a.right+window.scrollX,s=a.bottom+window.scrollY,r=a.top+window.scrollY,c={};let d=null;this.isOnTheSide?(this.onLeftOfTarget()?(c.left=n,d=ve.a.Right):(c.left=i,d=ve.a.Left),c.top=r):(this.aboveTarget()?(c.bottom=de.b.instance.windowHeight-r,d=ve.a.Bottom):(c.top=s,d=ve.a.Top),c.left=n+a.width/2);const m=o.a.createElement("div",{className:"mx_InteractiveTooltip_chevron_"+d}),h=l()({mx_InteractiveTooltip:!0,mx_InteractiveTooltip_withChevron_top:d===ve.a.Top,mx_InteractiveTooltip_withChevron_left:d===ve.a.Left,mx_InteractiveTooltip_withChevron_right:d===ve.a.Right,mx_InteractiveTooltip_withChevron_bottom:d===ve.a.Bottom}),u={};e&&!this.isOnTheSide&&(u.left=`-${e.width/2}px`);const p=o.a.createElement("div",{className:"mx_InteractiveTooltip_wrapper",style:aa({},c)},o.a.createElement("div",{className:h,style:u,ref:this.collectContentRect},m,this.props.content));ea.a.render(p,na())}render(){return this.props.children({ref:this.collectTarget,onMouseOver:this.onTargetMouseOver})}}i()(ma,"defaultProps",{side:da.Top});var ha=a(276),ua=a(562);var pa=()=>{const e=Object(s.useRef)(),t=Object(F.b)(Xt.a.instance,L.b,()=>Xt.a.instance.rooms),a=o.a.createElement("div",{className:"mx_RecentlyViewedButton_ContextMenu"},o.a.createElement("h4",null,Object(N.a)("Recently viewed")),o.a.createElement("div",null,t.map(t=>{const a=Object(ua.a)(t);return o.a.createElement(ve.e,{key:t.roomId,onClick:a=>{var n;b.a.dispatch({action:M.a.ViewRoom,room_id:t.roomId,metricsTrigger:"WebVerticalBreadcrumbs",metricsViaKeyboard:"click"!==a.type}),null===(n=e.current)||void 0===n||n.hideTooltip()}},t.isSpaceRoom()?o.a.createElement(Ie.a,{room:t,width:24,height:24}):o.a.createElement(ha.a,{room:t,avatarSize:24,tooltipProps:{tabIndex:-1}}),o.a.createElement("span",{className:"mx_RecentlyViewedButton_entry_label"},o.a.createElement("div",null,t.name),a&&o.a.createElement("div",{className:"mx_RecentlyViewedButton_entry_spaces"},a)))})));return o.a.createElement(ma,{content:a,direction:da.Right,ref:e},e=>{let{ref:t,onMouseOver:a}=e;return o.a.createElement("span",{className:"mx_LeftPanel_recentsButton",title:Object(N.a)("Recently viewed"),ref:t,onMouseOver:a})})},ga=a(764),ba=a(560);const va=e=>{let{room:t,onClick:a}=e;const[n,i,s]=Object(me.i)();return o.a.createElement(oe.a,{className:"mx_RoomBreadcrumbs_crumb",onClick:a,"aria-label":Object(N.a)("Room %(name)s",{name:t.name}),title:t.name,tooltipClassName:"mx_RoomBreadcrumbs_Tooltip",onFocus:n,inputRef:s,tabIndex:i?0:-1},o.a.createElement(ha.a,{room:t,avatarSize:32,displayBadge:!0,forceCount:!0,tooltipProps:{tabIndex:i?0:-1}}))};class fa extends o.a.PureComponent{constructor(e){super(e),i()(this,"isMounted",!0),i()(this,"onBreadcrumbsUpdate",()=>{this.isMounted&&(this.setState({doAnimation:!1,skipFirst:!0}),setTimeout(()=>this.setState({doAnimation:!0,skipFirst:!1}),0))}),i()(this,"viewRoom",(function(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];V.a.trackEvent("Breadcrumbs","click_node",String(t)),b.a.dispatch({action:M.a.ViewRoom,room_id:e.roomId,metricsTrigger:"WebHorizontalBreadcrumbs",metricsViaKeyboard:a})})),this.state={doAnimation:!0,skipFirst:!1},Xt.a.instance.on(L.b,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.isMounted=!1,Xt.a.instance.off(L.b,this.onBreadcrumbsUpdate)}render(){const e=Xt.a.instance.rooms.map((e,t)=>o.a.createElement(va,{key:e.roomId,room:e,onClick:a=>this.viewRoom(e,t,"click"!==a.type)}));return e.length>0?o.a.createElement(ga.CSSTransition,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs"},o.a.createElement(ba.a,{className:"mx_RoomBreadcrumbs","aria-label":Object(N.a)("Recently visited rooms")},e.slice(this.state.skipFirst?1:0))):o.a.createElement("div",{className:"mx_RoomBreadcrumbs"},o.a.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},Object(N.a)("No recently visited rooms")))}}var Ea;!function(e){e[e.Disabled=0]="Disabled",e[e.Legacy=1]="Legacy",e[e.Labs=2]="Labs"}(Ea||(Ea={}));class ya extends s.Component{constructor(e){super(e),i()(this,"listContainerRef",Object(s.createRef)()),i()(this,"roomSearchRef",Object(s.createRef)()),i()(this,"roomListRef",Object(s.createRef)()),i()(this,"focusedElement",null),i()(this,"isDoingStickyHeaders",!1),i()(this,"updateActiveSpace",e=>{this.setState({activeSpace:e})}),i()(this,"onDialPad",()=>{b.a.fire(M.a.OpenDialPad)}),i()(this,"onExplore",e=>{b.a.fire(M.a.ViewRoomDirectory),W.b.trackInteraction("WebLeftPanelExploreRoomsButton",e)}),i()(this,"refreshStickyHeaders",()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)}),i()(this,"onBreadcrumbsUpdate",()=>{const e=ya.breadcrumbsMode;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}}),i()(this,"onScroll",e=>{const t=e.target;this.handleStickyHeaders(t)}),i()(this,"onFocus",e=>{this.focusedElement=e.target}),i()(this,"onBlur",()=>{this.focusedElement=null}),i()(this,"onKeyDown",(e,t)=>{if(!this.focusedElement)return;switch(Object(le.a)().getRoomListAction(e)){case Ue.h.NextRoom:var a;if(!t)e.stopPropagation(),e.preventDefault(),null===(a=this.roomListRef.current)||void 0===a||a.focus();break;case Ue.h.PrevRoom:var n;if(t&&t.activeRef===Object(me.h)(t.refs,0))e.stopPropagation(),e.preventDefault(),null===(n=this.roomSearchRef.current)||void 0===n||n.focus()}}),i()(this,"onRoomListKeydown",e=>{if(e.altKey||e.ctrlKey||e.metaKey)return;if(v.b.getValue("feature_spotlight"))return;const t=Object(le.a)().getAccessibilityAction(e);var a;if(1===e.key.length)e.preventDefault(),e.stopPropagation(),null===(a=this.roomSearchRef.current)||void 0===a||a.appendChar(e.key);else if(t===Ue.h.Backspace){var n;e.preventDefault(),e.stopPropagation(),null===(n=this.roomSearchRef.current)||void 0===n||n.backspace()}}),i()(this,"selectRoom",()=>{const e=this.listContainerRef.current.querySelector(".mx_RoomTile");if(e)return e.click(),!0}),this.state={activeSpace:re.a.instance.activeSpace,showBreadcrumbs:ya.breadcrumbsMode},Xt.a.instance.on(L.b,this.onBreadcrumbsUpdate),qt.b.instance.on(qt.a,this.onBreadcrumbsUpdate),re.a.instance.on(ce.d,this.updateActiveSpace)}static get breadcrumbsMode(){return Xt.a.instance.visible?v.b.getValue("feature_breadcrumbs_v2")?Ea.Labs:Ea.Legacy:Ea.Disabled}componentDidMount(){var e;de.b.instance.trackElementDimensions("ListContainer",this.listContainerRef.current),de.b.instance.on("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.addEventListener("scroll",this.onScroll,{passive:!0})}componentWillUnmount(){var e;Xt.a.instance.off(L.b,this.onBreadcrumbsUpdate),qt.b.instance.off(qt.a,this.onBreadcrumbsUpdate),re.a.instance.off(ce.d,this.updateActiveSpace),de.b.instance.stopTrackingElementDimensions("ListContainer"),de.b.instance.removeListener("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.removeEventListener("scroll",this.onScroll)}componentDidUpdate(e,t){t.activeSpace!==this.state.activeSpace&&this.refreshStickyHeaders()}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame(()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1}))}doStickyHeaders(e){const t=e.scrollTop,a=e.offsetHeight+e.scrollTop,n=e.querySelectorAll(".mx_RoomSublist:not(.mx_RoomSublist_hidden)"),i=new Map;let s,o;for(const e of n){const r=e.querySelector(".mx_RoomSublist_stickable");r.style.removeProperty("display");const c=.4,l=e.offsetTop+c*ie.a<=t,d=e.offsetTop+c*ie.a>=a;l||e===n[0]?(i.set(r,{stickyTop:!0}),s&&(s.style.display="none",i.set(s,{makeInvisible:!0})),s=r):d&&!o?(i.set(r,{stickyBottom:!0}),o=r):i.set(r,{})}for(const t of i.keys()){const a=i.get(t);if(a.makeInvisible)t.style.display="none";else{if(a.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const a=e.parentElement.offsetTop+"px";t.style.top!==a&&(t.style.top=a)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(a.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom");const a=de.b.instance.windowHeight-(e.parentElement.offsetTop+e.parentElement.offsetHeight)+"px";t.style.bottom!==a&&(t.style.bottom=a)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),t.style.bottom&&t.style.removeProperty("bottom");if(a.stickyTop||a.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=de.b.instance.getElementDimensions("ListContainer");if(e){const a=15,n=e.width-a+"px";t.style.width!==n&&(t.style.width=n)}}else a.stickyTop||a.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const r=e.parentElement;s?r.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),o?r.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom")}renderBreadcrumbs(){if(this.state.showBreadcrumbs===Ea.Legacy&&!this.props.isMinimized)return s.createElement(Pt,{className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0},s.createElement(fa,null))}renderSearchDialExplore(){let e,t=null;return ne.b.instance.getSupportsPstnProtocol()&&(t=s.createElement(oe.a,{className:l()("mx_LeftPanel_dialPadButton",{}),onClick:this.onDialPad,title:Object(N.a)("Open dial pad")})),this.state.showBreadcrumbs===Ea.Labs?e=s.createElement(pa,null):this.state.activeSpace===ce.a.Home&&Object(Ce.a)(Oe.a.ExploreRooms)&&(e=s.createElement(oe.a,{className:"mx_LeftPanel_exploreButton",onClick:this.onExplore,title:Object(N.a)("Explore rooms")})),s.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown},s.createElement(se.a,{isMinimized:this.props.isMinimized,ref:this.roomSearchRef,onSelectRoom:this.selectRoom}),t,e)}render(){const e=s.createElement(ae.b,{onKeyDown:this.onKeyDown,resizeNotifier:this.props.resizeNotifier,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,activeSpace:this.state.activeSpace,onResize:this.refreshStickyHeaders,onListCollapse:this.refreshStickyHeaders,ref:this.roomListRef}),t=l()({mx_LeftPanel:!0,mx_LeftPanel_minimized:this.props.isMinimized}),a=l()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");return s.createElement("div",{className:t},s.createElement("aside",{className:"mx_LeftPanel_roomListContainer"},this.renderSearchDialExplore(),this.renderBreadcrumbs(),!this.props.isMinimized&&s.createElement(Qt,{onVisibilityChange:this.refreshStickyHeaders}),s.createElement("div",{className:"mx_LeftPanel_roomListWrapper"},s.createElement("div",{className:a,ref:this.listContainerRef,tabIndex:-1,onKeyDown:this.onRoomListKeydown},e))))}}var _a=a(152),Sa=a(0),wa=a(439),Ca=a(440),Oa=a(136);class ka extends o.a.PureComponent{constructor(e){super(e),i()(this,"element",void 0),i()(this,"setElementRef",e=>{var t;e?(this.element=e,e.addEventListener("resize",this.onResize)):null===(t=this.element)||void 0===t||t.removeEventListener("resize",this.onResize)}),i()(this,"onNewStream",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}),this.playMedia()}),i()(this,"onMuteStateChanged",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()})}),i()(this,"onResize",e=>{this.props.onResize&&!this.props.feed.isLocal()&&this.props.onResize(e)}),this.state={audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}}componentDidMount(){this.updateFeed(null,this.props.feed),this.playMedia()}componentWillUnmount(){this.updateFeed(this.props.feed,null)}componentDidUpdate(e,t){this.updateFeed(e.feed,this.props.feed),t.videoMuted===this.state.videoMuted&&e.feed.stream===this.props.feed.stream||this.playMedia()}static getDerivedStateFromProps(e){return{audioMuted:e.feed.isAudioMuted(),videoMuted:e.feed.isVideoMuted()}}updateFeed(e,t){e!==t&&(e&&(this.props.feed.removeListener(Ca.b.NewStream,this.onNewStream),this.props.feed.removeListener(Ca.b.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===wa.b.Usermedia&&this.props.feed.measureVolumeActivity(!1),this.stopMedia()),t&&(this.props.feed.addListener(Ca.b.NewStream,this.onNewStream),this.props.feed.addListener(Ca.b.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===wa.b.Usermedia&&this.props.feed.measureVolumeActivity(!0),this.playMedia()))}async playMedia(){const e=this.element;if(e){e.muted=!0,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.play()}catch(e){Sa.a.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element;e&&(e.pause(),e.src=null)}render(){const{pipMode:e,primary:t,secondary:a,feed:n}=this.props,i=l()("mx_VideoFeed",{mx_VideoFeed_primary:t,mx_VideoFeed_secondary:a,mx_VideoFeed_voice:this.state.videoMuted}),s=l()("mx_VideoFeed_mic",{mx_VideoFeed_mic_muted:this.state.audioMuted,mx_VideoFeed_mic_unmuted:!this.state.audioMuted});let r,c;if(n.purpose===wa.b.Screenshare||t||e||(r=o.a.createElement("div",{className:s})),this.state.videoMuted){const a=this.props.feed.getMember();let n;e&&t?n=76:e&&!t?n=16:!e&&t&&(n=160),c=o.a.createElement(Oa.a,{member:a,height:n,width:n})}else{const e=l()("mx_VideoFeed_video",{mx_VideoFeed_video_mirror:this.props.feed.isLocal()&&this.props.feed.purpose===wa.b.Usermedia&&v.b.getValue("VideoView.flipVideoHorizontally")});c=o.a.createElement("video",{className:e,ref:this.setElementRef})}return o.a.createElement("div",{className:i},r,c)}}var xa=a(221),Ra=a(101),ja=a(110),Ia=a(306);function Ta(){return $.a.get().getDesktopCapturerSources({thumbnailSize:{height:176,width:312},types:["screen","window"]})}let Na;!function(e){e.Screens="screen",e.Windows="window"}(Na||(Na={}));class Pa extends o.a.Component{constructor(e){super(e),i()(this,"onClick",()=>{this.props.onSelect(this.props.source)})}render(){const e=l()({mx_desktopCapturerSourcePicker_source_thumbnail:!0,mx_desktopCapturerSourcePicker_source_thumbnail_selected:this.props.selected});return o.a.createElement(U.a,{className:"mx_desktopCapturerSourcePicker_source",title:this.props.source.name,onClick:this.onClick},o.a.createElement("img",{className:e,src:this.props.source.thumbnailURL}),o.a.createElement("span",{className:"mx_desktopCapturerSourcePicker_source_name"},this.props.source.name))}}class Ma extends o.a.Component{constructor(e){super(e),i()(this,"interval",void 0),i()(this,"onSelect",e=>{this.setState({selectedSource:e})}),i()(this,"onShare",()=>{this.props.onFinished(this.state.selectedSource.id)}),i()(this,"onTabChange",()=>{this.setState({selectedSource:null})}),i()(this,"onCloseClick",()=>{this.props.onFinished(null)}),this.state={selectedTab:Na.Screens,sources:[],selectedSource:null}}async componentDidMount(){this.setState({sources:await Ta()}),this.interval=setInterval(async()=>{this.setState({sources:await Ta()})},500)}componentWillUnmount(){clearInterval(this.interval)}getTab(e,t){const a=this.state.sources.filter(t=>t.id.startsWith(e)).map(e=>{var t;return o.a.createElement(Pa,{selected:(null===(t=this.state.selectedSource)||void 0===t?void 0:t.id)===e.id,source:e,onSelect:this.onSelect,key:e.id})});return new Ia.a(e,t,null,o.a.createElement("div",{className:"mx_desktopCapturerSourcePicker_tab"},a))}render(){const e=[this.getTab("screen",Object(N.a)("Share entire screen")),this.getTab("window",Object(N.a)("Application window"))];return o.a.createElement(Ra.a,{className:"mx_desktopCapturerSourcePicker",onFinished:this.onCloseClick,title:Object(N.a)("Share content")},o.a.createElement(Ia.c,{tabs:e,tabLocation:Ia.b.TOP,onChange:this.onTabChange}),o.a.createElement(ja.a,{primaryButton:Object(N.a)("Share"),hasCancel:!0,onCancel:this.onCloseClick,onPrimaryButtonClick:this.onShare,primaryDisabled:!this.state.selectedSource}))}}class Da extends o.a.Component{render(){const e=this.props.feeds.map(e=>o.a.createElement(ka,{key:e.stream.id,feed:e,call:this.props.call,primary:!1,pipMode:this.props.pipMode})),t=l()("mx_CallViewSidebar",{mx_CallViewSidebar_pipMode:this.props.pipMode});return o.a.createElement("div",{className:t},e)}}const Aa=e=>{let{onExpand:t,onPin:a,onMaximize:n}=e;return o.a.createElement("div",{className:"mx_CallViewHeader_controls"},n&&o.a.createElement(oe.a,{className:"mx_CallViewHeader_button mx_CallViewHeader_button_fullscreen",onClick:n,title:Object(N.a)("Fill Screen")}),a&&o.a.createElement(oe.a,{className:"mx_CallViewHeader_button mx_CallViewHeader_button_pin",onClick:a,title:Object(N.a)("Pin")}),t&&o.a.createElement(oe.a,{className:"mx_CallViewHeader_button mx_CallViewHeader_button_expand",onClick:t,title:Object(N.a)("Return to call")}))},Ua=e=>{let{callRoom:t}=e;return o.a.createElement("span",{className:"mx_CallViewHeader_secondaryCallInfo"},o.a.createElement(Ie.a,{room:t,height:16,width:16}),o.a.createElement("span",{className:"mx_CallView_secondaryCall_roomName"},Object(N.a)("%(name)s on hold",{name:t.name})))};var La=e=>{let{pipMode:t=!1,callRooms:a=[],onPipMouseDown:n,onExpand:i,onPin:s,onMaximize:r}=e;const[c,l]=a,d=c.name;return t?o.a.createElement("div",{className:"mx_CallViewHeader mx_CallViewHeader_pip",onMouseDown:n},o.a.createElement(Ie.a,{room:c,height:32,width:32}),o.a.createElement("div",{className:"mx_CallViewHeader_callInfo"},o.a.createElement("div",{className:"mx_CallViewHeader_roomName"},d),l&&o.a.createElement(Ua,{callRoom:l})),o.a.createElement(Aa,{onExpand:i,onPin:s,onMaximize:r})):o.a.createElement("div",{className:"mx_CallViewHeader"},o.a.createElement("div",{className:"mx_CallViewHeader_icon"}),o.a.createElement("span",{className:"mx_CallViewHeader_text"},Object(N.a)("Call")),o.a.createElement(Aa,{onMaximize:r}))},Fa=a(163),Ba=a.n(Fa);class Va extends o.a.Component{constructor(e){super(e),i()(this,"onHoldClick",()=>{this.props.call.setRemoteOnHold(!0),this.props.onFinished()}),i()(this,"onUnholdClick",()=>{ne.b.instance.setActiveCallRoomId(this.props.call.roomId),this.props.onFinished()}),i()(this,"onTransferClick",()=>{ne.b.instance.showTransferDialog(this.props.call),this.props.onFinished()})}render(){const e=this.props.call.isRemoteOnHold()?Object(N.a)("Resume"):Object(N.a)("Hold"),t=this.props.call.isRemoteOnHold()?this.onUnholdClick:this.onHoldClick;let a;return this.props.call.opponentCanBeTransferred()&&(a=o.a.createElement(ve.e,{className:"mx_CallContextMenu_item",onClick:this.onTransferClick},Object(N.a)("Transfer"))),o.a.createElement(ve.o,this.props,o.a.createElement(ve.e,{className:"mx_CallContextMenu_item",onClick:t},e),a)}}i()(Va,"propTypes",{user:Ba.a.object});var Wa=a(547);class Ha extends s.Component{constructor(e){super(e),i()(this,"numberEntryFieldRef",Object(s.createRef)()),i()(this,"onDigitPress",(e,t)=>{var a;(this.props.call.sendDtmfDigit(e),this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(a=this.numberEntryFieldRef.current)||void 0===a||a.focus())}),i()(this,"onCancelClick",()=>{this.props.onFinished()}),i()(this,"onKeyDown",e=>{"Backspace"!==e.code&&"Delete"!==e.code||e.preventDefault()}),i()(this,"onChange",e=>{this.setState({value:e.target.value})}),this.state={value:""}}render(){return s.createElement(ve.o,this.props,s.createElement("div",{className:"mx_DialPadContextMenuWrapper"},s.createElement("div",null,s.createElement(U.a,{className:"mx_DialPadContextMenu_cancel",onClick:this.onCancelClick})),s.createElement("div",{className:"mx_DialPadContextMenu_header"},s.createElement(_t.a,{ref:this.numberEntryFieldRef,className:"mx_DialPadContextMenu_dialled",value:this.state.value,autoFocus:!0,onKeyDown:this.onKeyDown,onChange:this.onChange})),s.createElement("div",{className:"mx_DialPadContextMenu_dialPad"},s.createElement(Wa.a,{onDigitPress:this.onDigitPress,hasDial:!1}))))}}var za=a(140);const Ka=["deviceKinds"],qa={[p.b.AudioInput]:Object(N.c)("Input devices"),[p.b.AudioOutput]:Object(N.c)("Output devices"),[p.b.VideoInput]:Object(N.c)("Cameras")},Ga=e=>{let{label:t,selected:a,onClick:n}=e;return o.a.createElement(ye.d,{iconClassName:"mx_DeviceContextMenu_device_icon",label:t,active:a,onClick:n})},Ya=e=>{let{deviceKind:t}=e;const[a,n]=Object(s.useState)([]),[i,r]=Object(s.useState)(p.c.getDevice(t));Object(s.useEffect)(()=>{(async()=>{n((await p.c.getDevices())[t])})()},[t]);return o.a.createElement(ye.c,{label:Object(N.a)(qa[t])},a.map(e=>{let{label:a,deviceId:n}=e;return o.a.createElement(Ga,{key:n,label:a,selected:i===n,onClick:()=>(e=>{p.c.instance.setDevice(e,t),r(e)})(n)})}))};var Ja=e=>{let{deviceKinds:t}=e,a=Ee()(e,Ka);return o.a.createElement(ye.e,ue()({compact:!0,className:"mx_DeviceContextMenu"},a),t.map(e=>o.a.createElement(Ya,{key:e,deviceKind:e})))};const $a=["children","state","className","onLabel","offLabel"],Qa=["state","deviceKinds"],Xa=e=>{let{children:t,state:a,className:n,onLabel:i,offLabel:s}=e,r=Ee()(e,$a);const c=l()("mx_CallViewButtons_button",n,{mx_CallViewButtons_button_on:a,mx_CallViewButtons_button_off:!a});return o.a.createElement(oe.a,ue()({className:c,title:a?i:s,alignment:za.a.Top},r),t)},Za=e=>{var t;let{state:a,deviceKinds:n}=e,i=Ee()(e,Qa);const[r,c,d,m]=Object(ve.q)(),[h,u]=Object(s.useState)(!1),p=l()("mx_CallViewButtons_button","mx_CallViewButtons_dropdownButton",{mx_CallViewButtons_dropdownButton_collapsed:!r});return o.a.createElement(Xa,ue()({inputRef:c,forceHide:r||h,state:a},i),o.a.createElement(Xa,{className:p,onClick:e=>{e.stopPropagation(),d()},onHover:e=>u(e),state:a}),r&&o.a.createElement(Ja,ue()({},Object(ve.m)(null===(t=c.current)||void 0===t?void 0:t.getBoundingClientRect()),{onFinished:m,deviceKinds:n})))};class en extends o.a.Component{constructor(e){super(e),i()(this,"dialpadButton",Object(s.createRef)()),i()(this,"contextMenuButton",Object(s.createRef)()),i()(this,"controlsHideTimer",null),i()(this,"onControlsHideTimer",()=>{this.state.hoveringControls||this.state.showDialpad||this.state.showMoreMenu||(this.controlsHideTimer=null,this.setState({visible:!1}))}),i()(this,"onMouseEnter",()=>{this.setState({hoveringControls:!0})}),i()(this,"onMouseLeave",()=>{this.setState({hoveringControls:!1})}),i()(this,"onDialpadClick",()=>{this.state.showDialpad?this.setState({showDialpad:!1}):(this.setState({showDialpad:!0}),this.showControls())}),i()(this,"onMoreClick",()=>{this.setState({showMoreMenu:!0}),this.showControls()}),i()(this,"closeDialpad",()=>{this.setState({showDialpad:!1})}),i()(this,"closeContextMenu",()=>{this.setState({showMoreMenu:!1})}),this.state={showDialpad:!1,hoveringControls:!1,showMoreMenu:!1,visible:!0}}componentDidMount(){this.showControls()}showControls(){this.state.showMoreMenu||this.state.showDialpad||(this.state.visible||this.setState({visible:!0}),null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,2e3))}render(){const e=l()("mx_CallViewButtons",{mx_CallViewButtons_hidden:!this.state.visible});let t,a;return this.state.showDialpad&&(t=o.a.createElement(Ha,ue()({},Object(ve.l)(this.dialpadButton.current.getBoundingClientRect(),ve.a.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeDialpad,call:this.props.call}))),this.state.showMoreMenu&&(a=o.a.createElement(Va,ue()({},Object(ve.l)(this.contextMenuButton.current.getBoundingClientRect(),ve.a.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeContextMenu,call:this.props.call}))),o.a.createElement("div",{className:e,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave},t,a,this.props.buttonsVisibility.dialpad&&o.a.createElement(ve.c,{className:"mx_CallViewButtons_button mx_CallViewButtons_dialpad",inputRef:this.dialpadButton,onClick:this.onDialpadClick,isExpanded:this.state.showDialpad,title:Object(N.a)("Dialpad"),alignment:za.a.Top}),o.a.createElement(Za,{state:!this.props.buttonsState.micMuted,className:"mx_CallViewButtons_button_mic",onLabel:Object(N.a)("Mute the microphone"),offLabel:Object(N.a)("Unmute the microphone"),onClick:this.props.handlers.onMicMuteClick,deviceKinds:[p.b.AudioInput,p.b.AudioOutput]}),this.props.buttonsVisibility.vidMute&&o.a.createElement(Za,{state:!this.props.buttonsState.vidMuted,className:"mx_CallViewButtons_button_vid",onLabel:Object(N.a)("Stop the camera"),offLabel:Object(N.a)("Start the camera"),onClick:this.props.handlers.onVidMuteClick,deviceKinds:[p.b.VideoInput]}),this.props.buttonsVisibility.screensharing&&o.a.createElement(Xa,{state:this.props.buttonsState.screensharing,className:"mx_CallViewButtons_button_screensharing",onLabel:Object(N.a)("Stop sharing your screen"),offLabel:Object(N.a)("Start sharing your screen"),onClick:this.props.handlers.onScreenshareClick}),this.props.buttonsVisibility.sidebar&&o.a.createElement(Xa,{state:this.props.buttonsState.sidebarShown,className:"mx_CallViewButtons_button_sidebar",onLabel:Object(N.a)("Hide sidebar"),offLabel:Object(N.a)("Show sidebar"),onClick:this.props.handlers.onToggleSidebarClick}),this.props.buttonsVisibility.contextMenu&&o.a.createElement(ve.c,{className:"mx_CallViewButtons_button mx_CallViewButtons_button_more",onClick:this.onMoreClick,inputRef:this.contextMenuButton,isExpanded:this.state.showMoreMenu,title:Object(N.a)("More"),alignment:za.a.Top}),o.a.createElement(oe.a,{className:"mx_CallViewButtons_button mx_CallViewButtons_button_hangup",onClick:this.props.handlers.onHangupClick,title:Object(N.a)("Hangup"),alignment:za.a.Top}))}}function tn(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function an(){const e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}class nn extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"contentWrapperRef",Object(s.createRef)()),i()(this,"buttonsRef",Object(s.createRef)()),i()(this,"onAction",e=>{switch(e.action){case"video_fullscreen":if(!this.contentWrapperRef.current)return;e.fullscreen?function(e){const t=e.requestFullscreen||e.webkitRequestFullScreen||e.msRequestFullscreen;t&&t.call(e)}(this.contentWrapperRef.current):tn()&&an()}}),i()(this,"onCallState",e=>{this.setState({callState:e})}),i()(this,"onFeedsChanged",e=>{const{primary:t,secondary:a,sidebar:n}=nn.getOrderedFeeds(e);this.setState({primaryFeed:t,secondaryFeed:a,sidebarFeeds:n,micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted()})}),i()(this,"onCallLocalHoldUnhold",()=>{this.setState({isLocalOnHold:this.props.call.isLocalOnHold()})}),i()(this,"onCallRemoteHoldUnhold",()=>{this.setState({isRemoteOnHold:this.props.call.isRemoteOnHold(),isLocalOnHold:this.props.call.isLocalOnHold()})}),i()(this,"onMouseMove",()=>{var e;null===(e=this.buttonsRef.current)||void 0===e||e.showControls()}),i()(this,"onMaximizeClick",()=>{b.a.dispatch({action:"video_fullscreen",fullscreen:!0})}),i()(this,"onMicMuteClick",async()=>{const e=!this.state.micMuted;this.setState({micMuted:await this.props.call.setMicrophoneMuted(e)})}),i()(this,"onVidMuteClick",async()=>{const e=!this.state.vidMuted;this.setState({vidMuted:await this.props.call.setLocalVideoMuted(e)})}),i()(this,"onScreenshareClick",async()=>{let e;if(this.state.screensharing)e=await this.props.call.setScreensharingEnabled(!1);else if($.a.get().supportsDesktopCapturer()){const{finished:t}=gt.a.createDialog(Ma),[a]=await t;if(!a)return;e=await this.props.call.setScreensharingEnabled(!0,a)}else e=await this.props.call.setScreensharingEnabled(!0);this.setState({sidebarShown:!0,screensharing:e})}),i()(this,"onNativeKeyDown",e=>{var t,a;let n=!1;switch(Object(le.a)().getCallAction(e)){case Ue.h.ToggleMicInCall:this.onMicMuteClick(),null===(t=this.buttonsRef.current)||void 0===t||t.showControls(),n=!0;break;case Ue.h.ToggleWebcamInCall:this.onVidMuteClick(),null===(a=this.buttonsRef.current)||void 0===a||a.showControls(),n=!0}n&&(e.stopPropagation(),e.preventDefault())}),i()(this,"onCallResumeClick",()=>{const e=ne.b.instance.roomIdForCall(this.props.call);ne.b.instance.setActiveCallRoomId(e)}),i()(this,"onTransferClick",()=>{const e=ne.b.instance.getTransfereeForCallId(this.props.call.callId);this.props.call.transferToCall(e)}),i()(this,"onHangupClick",()=>{ne.b.instance.hangupOrReject(ne.b.instance.roomIdForCall(this.props.call))}),i()(this,"onToggleSidebar",()=>{this.setState({sidebarShown:!this.state.sidebarShown})});const{primary:t,secondary:a,sidebar:n}=nn.getOrderedFeeds(this.props.call.getFeeds());this.state={isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),screensharing:this.props.call.isScreensharing(),callState:this.props.call.state,primaryFeed:t,secondaryFeed:a,sidebarFeeds:n,sidebarShown:!0},this.updateCallListeners(null,this.props.call)}componentDidMount(){this.dispatcherRef=b.a.register(this.onAction),document.addEventListener("keydown",this.onNativeKeyDown)}componentWillUnmount(){tn()&&an(),document.removeEventListener("keydown",this.onNativeKeyDown),this.updateCallListeners(this.props.call,null),b.a.unregister(this.dispatcherRef)}static getDerivedStateFromProps(e){const{primary:t,secondary:a,sidebar:n}=nn.getOrderedFeeds(e.call.getFeeds());return{primaryFeed:t,secondaryFeed:a,sidebarFeeds:n}}componentDidUpdate(e){this.props.call!==e.call&&(this.setState({isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state}),this.updateCallListeners(null,this.props.call))}updateCallListeners(e,t){e!==t&&(e&&(e.removeListener(_a.c.State,this.onCallState),e.removeListener(_a.c.LocalHoldUnhold,this.onCallLocalHoldUnhold),e.removeListener(_a.c.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),e.removeListener(_a.c.FeedsChanged,this.onFeedsChanged)),t&&(t.on(_a.c.State,this.onCallState),t.on(_a.c.LocalHoldUnhold,this.onCallLocalHoldUnhold),t.on(_a.c.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),t.on(_a.c.FeedsChanged,this.onFeedsChanged)))}static getOrderedFeeds(e){if(e.length<=2)return{primary:e.find(e=>!e.isLocal()),secondary:e.find(e=>e.isLocal()),sidebar:[]};let t;const a=e.filter(e=>e.purpose===wa.b.Screenshare);t=a.find(e=>!e.isLocal())||a[0],t||(t=e.find(e=>!e.isLocal()));const n=[...e];return t&&n.splice(n.indexOf(t),1),n.sort((e,t)=>e.isLocal()&&!t.isLocal()?-1:!e.isLocal()&&t.isLocal()?1:0),{primary:t,sidebar:n}}renderCallControls(){const{call:e,pipMode:t}=this.props,{callState:a,micMuted:n,vidMuted:i,screensharing:s,sidebarShown:r,secondaryFeed:c,sidebarFeeds:l}=this.state,d=e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack,m=(e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack)&&e.state===_a.e.Connected,h=c&&!c.isVideoMuted()||l.length>0,u=a===_a.e.Connected,p=a===_a.e.Connected&&e.opponentSupportsDTMF();return o.a.createElement(en,{ref:this.buttonsRef,call:e,pipMode:t,handlers:{onToggleSidebarClick:this.onToggleSidebar,onScreenshareClick:this.onScreenshareClick,onHangupClick:this.onHangupClick,onMicMuteClick:this.onMicMuteClick,onVidMuteClick:this.onVidMuteClick},buttonsState:{micMuted:n,vidMuted:i,sidebarShown:r,screensharing:s},buttonsVisibility:{vidMute:d,screensharing:m,sidebar:h,contextMenu:u,dialpad:p}})}renderToast(){const{call:e}=this.props;if(!e.getFeeds().some(e=>e.purpose===wa.b.Screenshare))return null;const t=e.isScreensharing(),{primaryFeed:a,sidebarShown:n}=this.state,i=a.getMember().name;let s=t?Object(N.a)("You are presenting"):Object(N.a)("%(sharerName)s is presenting",{sharerName:i});return n||(s+=" • "+(e.isLocalVideoMuted()?Object(N.a)("Your camera is turned off"):Object(N.a)("Your camera is still enabled"))),o.a.createElement("div",{className:"mx_CallView_toast"},s)}renderContent(){const{pipMode:e,call:t,onResize:a}=this.props,{isLocalOnHold:n,isRemoteOnHold:i,sidebarShown:s,primaryFeed:r,secondaryFeed:c,sidebarFeeds:d}=this.state,m=Et.a.get().getRoom(t.roomId),h=e?76:160,u=ne.b.instance.getTransfereeForCallId(t.callId),p=n||i;let g;if(s&&c&&!c.isVideoMuted()&&(g=o.a.createElement(ka,{feed:c,call:t,pipMode:e,onResize:a,secondary:!0})),u||p){const e=l()("mx_CallView_content",{mx_CallView_content_hold:p}),a=Object(xa.a)(t.getOpponentMember(),1024,1024,"crop");let s;if(u){const e=Et.a.get().getRoom(ne.b.instance.roomIdForCall(t)),a=e?e.name:Object(N.a)("unknown person"),n=Et.a.get().getRoom(ne.b.instance.roomIdForCall(u)),i=n?n.name:Object(N.a)("unknown person");s=o.a.createElement("div",{className:"mx_CallView_status"},Object(N.a)("Consulting with %(transferTarget)s. <a>Transfer to %(transferee)s</a>",{transferTarget:a,transferee:i},{a:e=>o.a.createElement(U.a,{kind:"link",onClick:this.onTransferClick},e)}))}else{let e;i?e=Object(N.a)(ne.b.instance.hasAnyUnheldCall()?Object(N.c)("You held the call <a>Switch</a>"):Object(N.c)("You held the call <a>Resume</a>"),{},{a:e=>o.a.createElement(U.a,{kind:"link",onClick:this.onCallResumeClick},e)}):n&&(e=Object(N.a)("%(peerName)s held the call",{peerName:t.getOpponentMember().name})),s=o.a.createElement("div",{className:"mx_CallView_status"},e)}return o.a.createElement("div",{className:e,onMouseMove:this.onMouseMove},o.a.createElement("div",{className:"mx_CallView_holdBackground",style:{backgroundImage:"url("+a+")"}}),s)}return t.noIncomingFeeds()?o.a.createElement("div",{className:"mx_CallView_content",onMouseMove:this.onMouseMove},o.a.createElement("div",{className:"mx_CallView_avatarsContainer"},o.a.createElement("div",{className:"mx_CallView_avatarContainer",style:{width:h,height:h}},o.a.createElement(Ie.a,{room:m,height:h,width:h}))),o.a.createElement("div",{className:"mx_CallView_status"},Object(N.a)("Connecting")),g):e?o.a.createElement("div",{className:"mx_CallView_content",onMouseMove:this.onMouseMove},o.a.createElement(ka,{feed:r,call:t,pipMode:e,onResize:a,primary:!0})):c?o.a.createElement("div",{className:"mx_CallView_content",onMouseMove:this.onMouseMove},o.a.createElement(ka,{feed:r,call:t,pipMode:e,onResize:a,primary:!0}),g):o.a.createElement("div",{className:"mx_CallView_content",onMouseMove:this.onMouseMove},o.a.createElement(ka,{feed:r,call:t,pipMode:e,onResize:a,primary:!0}),s&&o.a.createElement(Da,{feeds:d,call:t,pipMode:e}))}render(){const{call:e,secondaryCall:t,pipMode:a,showApps:n,onMouseDownOnHeader:i}=this.props,{sidebarShown:s,sidebarFeeds:r}=this.state,c=Et.a.get(),d=ne.b.instance.roomIdForCall(e),m=ne.b.instance.roomIdForCall(t),h=c.getRoom(d),u=t?c.getRoom(m):null,p=l()({mx_CallView:!0,mx_CallView_pip:a,mx_CallView_large:!a,mx_CallView_sidebar:s&&0!==r.length&&!a,mx_CallView_belowWidget:n});return o.a.createElement("div",{className:p},o.a.createElement(La,{onPipMouseDown:i,pipMode:a,callRooms:[h,u],onMaximize:this.onMaximizeClick}),o.a.createElement("div",{className:"mx_CallView_content_wrapper",ref:this.contentWrapperRef},this.renderToast(),this.renderContent(),this.renderCallControls()))}}var sn=a(142),on=a(216),rn=a.n(on),cn=a(178),ln=a(211);function dn(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}class mn extends o.a.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),a=Et.a.get().getRoom(this.props.roomId);let n;a&&(n=a.getMember(this.props.creatorUserId)),this.state=function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?dn(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):dn(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({widgetDomain:null,isWrapped:null,roomMember:n},t)}parseWidgetUrl(){const e=rn.a.parse(this.props.url),t=new URLSearchParams(e.search);if(sn.a.isScalarUrl(this.props.url)&&t&&t.get("url")){const e=rn.a.parse(t.get("url"));return{widgetDomain:e.host||e.hostname,isWrapped:!0}}return{widgetDomain:e.host||e.hostname,isWrapped:!1}}render(){const e=P.b.get().brand,t=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,a=t===this.props.creatorUserId?null:this.props.creatorUserId,n=this.state.roomMember?o.a.createElement(Oa.a,{member:this.state.roomMember,width:38,height:38}):o.a.createElement(D.a,{name:this.props.creatorUserId,width:38,height:38}),i=o.a.createElement("div",null,Object(N.a)("Any of the following data may be shared:"),o.a.createElement("ul",null,o.a.createElement("li",null,Object(N.a)("Your display name")),o.a.createElement("li",null,Object(N.a)("Your avatar URL")),o.a.createElement("li",null,Object(N.a)("Your user ID")),o.a.createElement("li",null,Object(N.a)("Your theme")),o.a.createElement("li",null,Object(N.a)("%(brand)s URL",{brand:e})),o.a.createElement("li",null,Object(N.a)("Room ID")),o.a.createElement("li",null,Object(N.a)("Widget ID")))),s=o.a.createElement(ln.a,{tooltip:i,tooltipClass:"mx_AppPermissionWarning_tooltip mx_Tooltip_dark"},o.a.createElement("span",{className:"mx_AppPermissionWarning_helpIcon"})),r=this.state.isWrapped?Object(N.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s & your integration manager.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>s}):Object(N.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>s}),c=this.props.isRoomEncrypted?Object(N.a)("Widgets do not use message encryption."):null;return o.a.createElement("div",{className:"mx_AppPermissionWarning"},o.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_bolder mx_AppPermissionWarning_smallText"},Object(N.a)("Widget added by")),o.a.createElement("div",{className:"mx_AppPermissionWarning_row"},n,o.a.createElement("h4",{className:"mx_AppPermissionWarning_bolder"},t),o.a.createElement("div",{className:"mx_AppPermissionWarning_smallText"},a)),o.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},r),o.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},Object(N.a)("This widget may use cookies.")," ",c),o.a.createElement("div",{className:"mx_AppPermissionWarning_row"},o.a.createElement(U.a,{kind:"primary_sm",onClick:this.props.onPermissionGranted},Object(N.a)("Continue"))))}}i()(mn,"defaultProps",{onPermissionGranted:()=>{}});var hn=e=>o.a.createElement("div",{className:"mx_AppPermissionWarning"},o.a.createElement("div",{className:"mx_AppPermissionWarningImage"},o.a.createElement("img",{src:a(304).default,alt:""})),o.a.createElement("div",{className:"mx_AppPermissionWarningText"},o.a.createElement("span",{className:"mx_AppPermissionWarningTextLabel"},e.errorMsg||"Error"))),un=a(102),pn=a(337),gn=a(7);function bn(e){return document.getElementById(e)}class vn extends o.a.Component{constructor(e){super(e),i()(this,"resizeObserver",void 0),i()(this,"dispatcherRef",void 0),i()(this,"childContainer",void 0),i()(this,"child",void 0),i()(this,"collectChildContainer",e=>{this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)}),i()(this,"collectChild",e=>{this.child=e,this.updateChild()}),i()(this,"onAction",e=>{"timeline_resize"===e.action?this.repositionChild():"logout"===e.action&&vn.destroyElement(this.props.persistKey)}),i()(this,"repositionChild",()=>{this.updateChildPosition(this.child,this.childContainer)}),i()(this,"updateChildPosition",Object(x.throttle)((e,t)=>{if(!e||!t)return;const a=t.getBoundingClientRect();Object.assign(e.style,{zIndex:Object(gn.t)(this.props.zIndex)?9:this.props.zIndex,position:"absolute",top:a.top+"px",left:a.left+"px",width:a.width+"px",height:a.height+"px"})},16,{trailing:!0,leading:!0})),this.resizeObserver=new ResizeObserver(this.repositionChild),window.addEventListener("resize",this.repositionChild),this.dispatcherRef=b.a.register(this.onAction)}static destroyElement(e){const t=bn("mx_persistedElement_"+e);t&&t.remove()}static isMounted(e){return Boolean(bn("mx_persistedElement_"+e))}componentDidMount(){this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this.repositionChild),b.a.unregister(this.dispatcherRef)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=o.a.createElement(j.a.Provider,{value:Et.a.get()},o.a.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children));ea.a.render(e,function(e){let t=bn(e);return t||(t=document.createElement("div"),t.id=e,document.body.appendChild(t)),t}("mx_persistedElement_"+this.props.persistKey))}updateChildVisibility(e,t){e&&(e.style.display=t?"block":"none")}render(){return o.a.createElement("div",{ref:this.collectChildContainer})}}var fn=a(181),En=a(8),yn=a(108),_n=a(137),Sn=a(121);var wn=a(195);let Cn;!function(e){e[e.Allowed=0]="Allowed",e[e.Denied=1]="Denied",e[e.Unknown=2]="Unknown"}(Cn||(Cn={}));class On{constructor(){}static get instance(){return On.internalInstance||(On.internalInstance=new On),On.internalInstance}packSettingKey(e,t,a){let n=a;if(t!==cn.WidgetKind.Room&&(n=Et.a.get().getUserId()),t===cn.WidgetKind.Modal&&(n="*MODAL*-"+n),!n)throw new Error("Failed to determine a location to check the widget's OIDC state with");return encodeURIComponent(`${n}::${e.templateUrl}`)}getOIDCState(e,t,a){var n,i;const s=this.packSettingKey(e,t,a),o=v.b.getValue("widgetOpenIDPermissions");return null!=o&&null!==(n=o.deny)&&void 0!==n&&n.includes(s)?Cn.Denied:null!=o&&null!==(i=o.allow)&&void 0!==i&&i.includes(s)?Cn.Allowed:Cn.Unknown}setOIDCState(e,t,a,n){const i=this.packSettingKey(e,t,a),s=v.b.getValue("widgetOpenIDPermissions");s.allow||(s.allow=[]),s.deny||(s.deny=[]),n===Cn.Allowed?s.allow.push(i):n===Cn.Denied?s.deny.push(i):(s.allow=s.allow.filter(e=>e!==i),s.deny=s.deny.filter(e=>e!==i)),v.b.setValue("widgetOpenIDPermissions",null,f.a.DEVICE,s)}}i()(On,"internalInstance",void 0);class kn extends o.a.PureComponent{constructor(e){super(e),i()(this,"onAllow",()=>{this.onPermissionSelection(!0)}),i()(this,"onDeny",()=>{this.onPermissionSelection(!1)}),i()(this,"onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),this.state={rememberSelection:!1}}onPermissionSelection(e){this.state.rememberSelection&&(Sa.a.log(`Remembering ${this.props.widget.id} as allowed=${e} for OpenID`),On.instance.setOIDCState(this.props.widget,this.props.widgetKind,this.props.inRoomId,e?Cn.Allowed:Cn.Denied)),this.props.onFinished(e)}render(){return o.a.createElement(Ra.a,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(N.a)("Allow this widget to verify your identity")},o.a.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},o.a.createElement("p",null,Object(N.a)("The widget will verify your user ID, but won't be able to perform actions for you:")),o.a.createElement("p",{className:"text-muted"},this.props.widget.templateUrl.split("?")[0].split("#")[0])),o.a.createElement(ja.a,{primaryButton:Object(N.a)("Continue"),onPrimaryButtonClick:this.onAllow,onCancel:this.onDeny,additive:o.a.createElement(wn.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:Object(N.a)("Remember this")})}))}}var xn=a(164);let Rn;!function(e){e.CanChangeViewedRoom="io.element.view_room",e.RequiresClient="io.element.requires_client"}(Rn||(Rn={}));class jn{static bylineFor(e){return e.isState?e.keyStr?Object(N.a)("with state key %(stateKey)s",{stateKey:e.keyStr}):Object(N.a)("with an empty state key"):null}static for(e,t){if(jn.simpleCaps[e]){const a=jn.simpleCaps[e];if(a[t])return{primary:Object(N.a)(a[t])};if(a.generic)return{primary:Object(N.a)(a.generic)}}if(Object(cn.isTimelineCapability)(e)){if(Object(cn.isTimelineCapabilityFor)(e,cn.Symbols.AnyRoom))return{primary:Object(N.a)("The above, but in any room you are joined or invited to as well")};{const t=Object(cn.getTimelineRoomIDFromCapability)(e),a=Et.a.get().getRoom(t);return{primary:Object(N.a)("The above, but in <Room /> as well",{},{Room:()=>{var e;return a?o.a.createElement(ln.a,{tooltip:null!==(e=a.getCanonicalAlias())&&void 0!==e?e:t},o.a.createElement("b",null,a.name)):o.a.createElement("b",null,o.a.createElement("code",null,t))}})}}}const[a]=cn.WidgetEventCapability.findEventCapabilities([e]);if(a){if(!a.isState&&a.eventType===ge.b.RoomMessage)return jn.forRoomMessageCap(a,t);const e=a.isState?jn.stateSendRecvCaps:jn.nonStateSendRecvCaps;if(e[a.eventType]){const n=e[a.eventType],i=n[t]||n.generic;if(i&&i[a.direction])return{primary:Object(N.a)(i[a.direction])}}return t===cn.WidgetKind.Room?a.direction===cn.EventDirection.Send?{primary:Object(N.a)("Send <b>%(eventType)s</b> events as you in this room",{eventType:a.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:jn.bylineFor(a)}:{primary:Object(N.a)("See <b>%(eventType)s</b> events posted to this room",{eventType:a.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:jn.bylineFor(a)}:a.direction===cn.EventDirection.Send?{primary:Object(N.a)("Send <b>%(eventType)s</b> events as you in your active room",{eventType:a.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:jn.bylineFor(a)}:{primary:Object(N.a)("See <b>%(eventType)s</b> events posted to your active room",{eventType:a.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:jn.bylineFor(a)}}return{primary:Object(N.a)("The <b>%(capability)s</b> capability",{capability:e},{b:e=>o.a.createElement("b",null,e)})}}static forRoomMessageCap(e,t){if(!e.keyStr)return e.direction===cn.EventDirection.Send?{primary:t===cn.WidgetKind.Room?Object(N.a)("Send messages as you in this room"):Object(N.a)("Send messages as you in your active room")}:{primary:t===cn.WidgetKind.Room?Object(N.a)("See messages posted to this room"):Object(N.a)("See messages posted to your active room")};switch(e.keyStr){case ge.c.Text:return e.direction===cn.EventDirection.Send?{primary:t===cn.WidgetKind.Room?Object(N.a)("Send text messages as you in this room"):Object(N.a)("Send text messages as you in your active room")}:{primary:t===cn.WidgetKind.Room?Object(N.a)("See text messages posted to this room"):Object(N.a)("See text messages posted to your active room")};case ge.c.Emote:return e.direction===cn.EventDirection.Send?{primary:t===cn.WidgetKind.Room?Object(N.a)("Send emotes as you in this room"):Object(N.a)("Send emotes as you in your active room")}:{primary:t===cn.WidgetKind.Room?Object(N.a)("See emotes posted to this room"):Object(N.a)("See emotes posted to your active room")};case ge.c.Image:return e.direction===cn.EventDirection.Send?{primary:t===cn.WidgetKind.Room?Object(N.a)("Send images as you in this room"):Object(N.a)("Send images as you in your active room")}:{primary:t===cn.WidgetKind.Room?Object(N.a)("See images posted to this room"):Object(N.a)("See images posted to your active room")};case ge.c.Video:return e.direction===cn.EventDirection.Send?{primary:t===cn.WidgetKind.Room?Object(N.a)("Send videos as you in this room"):Object(N.a)("Send videos as you in your active room")}:{primary:t===cn.WidgetKind.Room?Object(N.a)("See videos posted to this room"):Object(N.a)("See videos posted to your active room")};case ge.c.File:return e.direction===cn.EventDirection.Send?{primary:t===cn.WidgetKind.Room?Object(N.a)("Send general files as you in this room"):Object(N.a)("Send general files as you in your active room")}:{primary:t===cn.WidgetKind.Room?Object(N.a)("See general files posted to this room"):Object(N.a)("See general files posted to your active room")};default:{let a;return a=e.direction===cn.EventDirection.Send?t===cn.WidgetKind.Room?Object(N.a)("Send <b>%(msgtype)s</b> messages as you in this room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):Object(N.a)("Send <b>%(msgtype)s</b> messages as you in your active room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):t===cn.WidgetKind.Room?Object(N.a)("See <b>%(msgtype)s</b> messages posted to this room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):Object(N.a)("See <b>%(msgtype)s</b> messages posted to your active room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}),{primary:a}}}}}i()(jn,"simpleCaps",{[cn.MatrixCapabilities.AlwaysOnScreen]:{[cn.WidgetKind.Room]:Object(N.c)("Remain on your screen when viewing another room, when running"),generic:Object(N.c)("Remain on your screen while running")},[cn.MatrixCapabilities.StickerSending]:{[cn.WidgetKind.Room]:Object(N.c)("Send stickers into this room"),generic:Object(N.c)("Send stickers into your active room")},[Rn.CanChangeViewedRoom]:{generic:Object(N.c)("Change which room you're viewing")},[cn.MatrixCapabilities.MSC2931Navigate]:{generic:Object(N.c)("Change which room, message, or user you're viewing")}}),i()(jn,"stateSendRecvCaps",{[ge.b.RoomTopic]:{[cn.WidgetKind.Room]:{[cn.EventDirection.Send]:Object(N.c)("Change the topic of this room"),[cn.EventDirection.Receive]:Object(N.c)("See when the topic changes in this room")},generic:{[cn.EventDirection.Send]:Object(N.c)("Change the topic of your active room"),[cn.EventDirection.Receive]:Object(N.c)("See when the topic changes in your active room")}},[ge.b.RoomName]:{[cn.WidgetKind.Room]:{[cn.EventDirection.Send]:Object(N.c)("Change the name of this room"),[cn.EventDirection.Receive]:Object(N.c)("See when the name changes in this room")},generic:{[cn.EventDirection.Send]:Object(N.c)("Change the name of your active room"),[cn.EventDirection.Receive]:Object(N.c)("See when the name changes in your active room")}},[ge.b.RoomAvatar]:{[cn.WidgetKind.Room]:{[cn.EventDirection.Send]:Object(N.c)("Change the avatar of this room"),[cn.EventDirection.Receive]:Object(N.c)("See when the avatar changes in this room")},generic:{[cn.EventDirection.Send]:Object(N.c)("Change the avatar of your active room"),[cn.EventDirection.Receive]:Object(N.c)("See when the avatar changes in your active room")}},[ge.b.RoomMember]:{[cn.WidgetKind.Room]:{[cn.EventDirection.Send]:Object(N.c)("Remove, ban, or invite people to this room, and make you leave"),[cn.EventDirection.Receive]:Object(N.c)("See when people join, leave, or are invited to this room")},generic:{[cn.EventDirection.Send]:Object(N.c)("Remove, ban, or invite people to your active room, and make you leave"),[cn.EventDirection.Receive]:Object(N.c)("See when people join, leave, or are invited to your active room")}}}),i()(jn,"nonStateSendRecvCaps",{[ge.b.Sticker]:{[cn.WidgetKind.Room]:{[cn.EventDirection.Send]:Object(N.c)("Send stickers to this room as you"),[cn.EventDirection.Receive]:Object(N.c)("See when a sticker is posted in this room")},generic:{[cn.EventDirection.Send]:Object(N.c)("Send stickers to your active room as you"),[cn.EventDirection.Receive]:Object(N.c)("See when anyone posts a sticker to your active room")}}});class In extends o.a.PureComponent{constructor(e){super(e),i()(this,"eventPermissionsMap",new Map),i()(this,"onToggle",e=>{const t=Object(xn.e)(this.state.booleanStates);t[e]=!t[e],this.setState({booleanStates:t})}),i()(this,"onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),i()(this,"onSubmit",async e=>{this.closeAndTryRemember(Object.entries(this.state.booleanStates).filter(e=>{let[t,a]=e;return a}).map(e=>{let[t]=e;return t}))}),i()(this,"onReject",async e=>{this.closeAndTryRemember([])});cn.WidgetEventCapability.findEventCapabilities(this.props.requestedCapabilities).forEach(e=>this.eventPermissionsMap.set(e.raw,e));const t={};this.props.requestedCapabilities.forEach(e=>t[e]=!0),this.state={booleanStates:t,rememberSelection:!0}}closeAndTryRemember(e){this.props.onFinished({approved:e,remember:this.state.rememberSelection})}render(){const e=Object.entries(this.state.booleanStates).sort((e,t)=>{let[a]=e,[n]=t;const i=Object(cn.isTimelineCapability)(a),s=Object(cn.isTimelineCapability)(n);return i||s?i&&!s?1:!i&&s?-1:i&&s?Object(gn.v)(a,n):0:Object(gn.v)(a,n)}).map((e,t)=>{let[a,n]=e;const i=jn.for(a,this.props.widgetKind),s=i.byline?o.a.createElement("span",{className:"mx_WidgetCapabilitiesPromptDialog_byline"},i.byline):null;return o.a.createElement("div",{className:"mx_WidgetCapabilitiesPromptDialog_cap",key:a+t},o.a.createElement(Ke.b,{checked:n,onChange:()=>this.onToggle(a)},i.primary),s)});return o.a.createElement(Ra.a,{className:"mx_WidgetCapabilitiesPromptDialog",onFinished:this.props.onFinished,title:Object(N.a)("Approve widget permissions")},o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"text-muted"},Object(N.a)("This widget would like to:")),e,o.a.createElement(ja.a,{primaryButton:Object(N.a)("Approve"),cancelButton:Object(N.a)("Decline All"),onPrimaryButtonClick:this.onSubmit,onCancel:this.onReject,additive:o.a.createElement(wn.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:Object(N.a)("Remember my selection for this widget")})}))))}}const Tn={};var Nn=a(232),Pn=a(345),Mn=a(132);class Dn extends cn.WidgetDriver{constructor(e,t,a,n){if(super(),this.forWidget=t,this.forWidgetKind=a,this.inRoomId=n,i()(this,"allowedCapabilities",void 0),this.allowedCapabilities=new Set([...e,cn.MatrixCapabilities.Screenshots,Rn.RequiresClient]),fn.a.JITSI.matches(this.forWidget.type)&&a===cn.WidgetKind.Room)this.allowedCapabilities.add(cn.MatrixCapabilities.AlwaysOnScreen);else if(fn.a.STICKERPICKER.matches(this.forWidget.type)&&a===cn.WidgetKind.Account){const e=cn.WidgetEventCapability.forRoomEvent(cn.EventDirection.Send,ge.b.Sticker).raw;this.allowedCapabilities.add(cn.MatrixCapabilities.StickerSending),this.allowedCapabilities.add(e),this.allowedCapabilities.add("visibility")}}async validateCapabilities(e){const t=(a=e,n=this.allowedCapabilities,Object(Sn.a)(Array.from(a),Array.from(n)));var a,n;const i=new Set(t.removed),s=new Set(this.allowedCapabilities);var o;if((o=this.forWidget,JSON.parse(localStorage.getItem(`widget_${o.id}_approved_caps`)||"[]")).forEach(e=>{s.add(e),i.delete(e)}),Tn.preapproveCapabilities){const t=await Tn.preapproveCapabilities(this.forWidget,e);t&&t.forEach(e=>{s.add(e),i.delete(e)})}let r=!1;if(i.size>0)try{const[e]=await gt.a.createTrackedDialog("Approve Widget Caps","",In,{requestedCapabilities:i,widget:this.forWidget,widgetKind:this.forWidgetKind}).finished;(e.approved||[]).forEach(e=>s.add(e)),r=e.remember}catch(e){Sa.a.error("Non-fatal error getting capabilities: ",e)}const c=new Set(function(e,t){return Object(Sn.f)(Array.from(e),Array.from(t))}(s,e));return r&&function(e,t){localStorage.setItem(`widget_${e.id}_approved_caps`,JSON.stringify(t))}(this.forWidget,Array.from(c)),c}async sendEvent(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const i=Et.a.get(),s=n||vt.a.instance.getRoomId();if(!i||!s)throw new Error("Not in a room or not attached to a client");let o=null;return null!==a?o=await i.sendStateEvent(s,e,t,a):e===ge.b.RoomRedaction?o=await i.redactEvent(s,t.redacts):(o=await i.sendEvent(s,e,t),e===ge.b.RoomMessage&&Nn.CHAT_EFFECTS.forEach(e=>{if(Object(Pn.containsEmoji)(t,e.emojis)){const a=t["m.relates_to"].rel_type!==_n.c.name;v.b.getValue("feature_thread")&&!a||b.a.dispatch({action:"effects."+e.command})}})),{roomId:s,eventId:o.event_id}}pickRooms(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const t=Et.a.get();if(!t)throw new Error("Not attached to a client");return(e?e.includes(cn.Symbols.AnyRoom)?t.getVisibleRooms():e.map(e=>t.getRoom(e)):[t.getRoom(vt.a.instance.getRoomId())]).filter(e=>!!e)}async readRoomEvents(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;a=a>0?Math.min(a,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const i=this.pickRooms(n),s=[];for(const n of i){const i=[],o=n.getLiveTimeline().getEvents();for(let n=o.length-1;n>0&&!(i.length>=a);n--){const a=o[n];a.getType()!==e||a.isState()||e===ge.b.RoomMessage&&t&&t!==a.getContent().msgtype||i.push(a)}i.forEach(e=>s.push(e.getEffectiveEvent()))}return s}async readStateEvents(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;a=a>0?Math.min(a,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const i=this.pickRooms(n),s=[];for(const n of i){const i=[],o=n.currentState.events.get(e);if(o)if(""===t||t){const e=o.get(t);e&&i.push(e)}else i.push(...Array.from(o.values()));i.slice(0,a).forEach(e=>s.push(e.getEffectiveEvent()))}return s}async askOpenID(e){const t=On.instance.getOIDCState(this.forWidget,this.forWidgetKind,this.inRoomId),a=()=>Et.a.get().getOpenIdToken();return t===Cn.Denied?e.update({state:cn.OpenIDRequestState.Blocked}):t===Cn.Allowed?e.update({state:cn.OpenIDRequestState.Allowed,token:await a()}):(e.update({state:cn.OpenIDRequestState.PendingUserConfirmation}),void gt.a.createTrackedDialog("OpenID widget permissions","",kn,{widget:this.forWidget,widgetKind:this.forWidgetKind,inRoomId:this.inRoomId,onFinished:async t=>t?e.update({state:cn.OpenIDRequestState.Allowed,token:await a()}):e.update({state:cn.OpenIDRequestState.Blocked})}))}async navigate(e){const t=Object(Mn.j)(e);if(!t||t===e)throw new Error("Failed to transform URI");window.location.hash=t}}var An=a(258),Un=a(235),Ln=a(2),Fn=a(167);function Bn(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Vn(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Bn(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Bn(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Wn extends s.PureComponent{constructor(e){super(e),i()(this,"widget",void 0),i()(this,"possibleButtons",void 0),i()(this,"appFrame",s.createRef()),i()(this,"state",{disabledButtonIds:(this.props.widgetDefinition.buttons||[]).filter(e=>e.disabled).map(e=>e.id)}),i()(this,"onReady",()=>{this.state.messaging.sendWidgetConfig(this.props.widgetDefinition)}),i()(this,"onLoad",()=>{this.state.messaging.once("ready",this.onReady),this.state.messaging.on("action:"+cn.WidgetApiFromWidgetAction.CloseModalWidget,this.onWidgetClose),this.state.messaging.on("action:"+cn.WidgetApiFromWidgetAction.SetModalButtonEnabled,this.onButtonEnableToggle)}),i()(this,"onWidgetClose",e=>{this.props.onFinished(!0,e.detail.data)}),i()(this,"onButtonEnableToggle",e=>{e.preventDefault();if(e.detail.data.button===cn.BuiltInModalButtonID.Close||!this.possibleButtons.includes(e.detail.data.button))return this.state.messaging.transport.reply(e.detail,{error:{message:"Invalid button"}});let t;if(e.detail.data.enabled)t=Object(Sn.b)(this.state.disabledButtonIds).filter(t=>t!==e.detail.data.button);else{const a=new Set(this.state.disabledButtonIds);a.add(e.detail.data.button),t=Array.from(a)}this.setState({disabledButtonIds:t}),this.state.messaging.transport.reply(e.detail,{})}),this.widget=new Qn(Vn(Vn({},this.props.widgetDefinition),{},{creatorUserId:Et.a.get().getUserId(),id:"modal_"+this.props.sourceWidgetId})),this.possibleButtons=(this.props.widgetDefinition.buttons||[]).map(e=>e.id)}componentDidMount(){const e=new Dn([],this.widget,cn.WidgetKind.Modal),t=new cn.ClientWidgetApi(this.widget,this.appFrame.current,e);this.setState({messaging:t})}componentWillUnmount(){this.state.messaging.off("ready",this.onReady),this.state.messaging.off("action:"+cn.WidgetApiFromWidgetAction.CloseModalWidget,this.onWidgetClose),this.state.messaging.stop()}render(){const e=this.widget.getCompleteUrl({widgetRoomId:this.props.widgetRoomId,currentUserId:Et.a.get().getUserId(),userDisplayName:A.a.instance.displayName,userHttpAvatarUrl:A.a.instance.getHttpAvatarUrl(),clientId:"io.element.web",clientTheme:v.b.getValue("theme"),clientLanguage:Object(N.h)()}),t=new URL(e);t.searchParams.set("widgetId",this.widget.id),t.searchParams.set("parentUrl",window.location.href.split("#",2)[0]);const n=t.toString().replace(/%24/g,"$");let i;return this.props.widgetDefinition.buttons&&(i=this.props.widgetDefinition.buttons.slice(0,3).reverse().map(e=>{let t="secondary";switch(e.kind){case cn.ModalButtonKind.Primary:t="primary";break;case cn.ModalButtonKind.Secondary:t="primary_outline";break;case cn.ModalButtonKind.Danger:t="danger"}const a=this.state.disabledButtonIds.includes(e.id);return s.createElement(U.a,{key:e.id,kind:t,onClick:()=>{this.state.messaging.notifyModalWidgetButtonClicked(e.id)},disabled:a},e.label)})),s.createElement(Ra.a,{title:this.props.widgetDefinition.name||Object(N.a)("Modal Widget"),className:"mx_ModalWidgetDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},s.createElement("div",{className:"mx_ModalWidgetDialog_warning"},s.createElement("img",{src:a(530).default,height:"16",width:"16",alt:""}),Object(N.a)("Data on this screen is shared with %(widgetDomain)s",{widgetDomain:t.hostname})),s.createElement("div",null,s.createElement("iframe",{title:this.widget.name,ref:this.appFrame,sandbox:"allow-forms allow-scripts allow-same-origin",src:n,onLoad:this.onLoad})),s.createElement("div",{className:"mx_ModalWidgetDialog_buttons"},i))}}function Hn(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function zn(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Hn(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Hn(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Kn extends Fn.a{constructor(){super(b.a,{}),i()(this,"modalInstance",null),i()(this,"openSourceWidgetId",null),i()(this,"openSourceWidgetRoomId",null),i()(this,"canOpenModalWidget",()=>!this.modalInstance),i()(this,"openModalWidget",(e,t,a)=>{this.modalInstance||(this.openSourceWidgetId=t.id,this.openSourceWidgetRoomId=a,this.modalInstance=gt.a.createTrackedDialog("Modal Widget","",Wn,{widgetDefinition:zn({},e),widgetRoomId:a,sourceWidgetId:t.id,onFinished:(e,n)=>{e?this.closeModalWidget(t,a,n):this.closeModalWidget(t,a,{"m.exited":!0}),this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance=null}},null,!1,!0))}),i()(this,"closeModalWidget",(e,t,a)=>{if(this.modalInstance&&this.openSourceWidgetId===e.id&&this.openSourceWidgetRoomId===t){this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance.close(),this.modalInstance=null;const n=An.a.instance.getMessaging(e,t);if(!n)return void Sa.a.error("No source widget messaging for modal widget");n.notifyModalWidgetClose(a)}})}static get instance(){return Kn.internalInstance}async onAction(e){}}i()(Kn,"internalInstance",new Kn),window.mxModalWidgetStore=Kn.instance;var qn=a(412);const Gn={};var Yn=a(107);function Jn(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function $n(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Jn(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Jn(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Qn extends cn.Widget{constructor(e){super(e),this.rawDefinition=e}get templateUrl(){var e;return fn.a.JITSI.matches(this.type)?sn.a.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):super.templateUrl}get popoutTemplateUrl(){var e;return fn.a.JITSI.matches(this.type)?sn.a.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):this.templateUrl}get rawData(){let e=super.rawData.conferenceId;if(void 0===e){e=new URL(super.templateUrl).searchParams.get("confId")}let t=super.rawData.domain;void 0===t&&(t="meet.element.io");let a=(new qn.a).getEffectiveTheme();if(a.startsWith("custom-")){const e=Object(Ye.e)(a.slice(7));a=e.is_dark?"dark":"light"}return a=a.includes("light")?"light":"dark",$n($n({},super.rawData),{},{theme:a,conferenceId:e,domain:t})}getCompleteUrl(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return Object(cn.runTemplate)(t?this.popoutTemplateUrl:this.templateUrl,$n($n({},this.rawDefinition),{},{data:this.rawData}),e)}}class Xn extends En.EventEmitter{constructor(e){var t;super(),this.appTileProps=e,i()(this,"messaging",void 0),i()(this,"mockWidget",void 0),i()(this,"scalarToken",void 0),i()(this,"roomId",void 0),i()(this,"kind",void 0),i()(this,"readUpToMap",{}),i()(this,"onOpenModal",async e=>{e.preventDefault(),Kn.instance.canOpenModalWidget()?(Kn.instance.openModalWidget(e.detail.data,this.mockWidget,this.roomId),this.messaging.transport.reply(e.detail,{})):this.messaging.transport.reply(e.detail,{error:{message:"Unable to open modal at this time"}})}),i()(this,"onEvent",e=>{Et.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure()||this.feedEvent(e)}),i()(this,"onEventDecrypted",e=>{e.isDecryptionFailure()||this.feedEvent(e)});let a=e.app;a.creatorUserId||(a=Object(xn.e)(a),a.creatorUserId=Et.a.get().getUserId()),this.mockWidget=new Qn(a),this.roomId=null===(t=e.room)||void 0===t?void 0:t.roomId,this.kind=e.userWidget?cn.WidgetKind.Account:cn.WidgetKind.Room}get eventListenerRoomId(){return this.roomId?this.roomId:vt.a.instance.getRoomId()}get widgetApi(){return this.messaging}get embedUrl(){return this.runUrlTemplate({asPopout:!1})}get popoutUrl(){return this.runUrlTemplate({asPopout:!0})}runUrlTemplate(){var e,t;let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{asPopout:!1};const n=null!==(e=null==Gn||null===(t=Gn.provideVariables)||void 0===t?void 0:t.call(Gn))&&void 0!==e?e:{},i={widgetRoomId:this.roomId,currentUserId:Et.a.get().getUserId(),userDisplayName:A.a.instance.displayName,userHttpAvatarUrl:A.a.instance.getHttpAvatarUrl(),clientId:"io.element.web",clientTheme:v.b.getValue("theme"),clientLanguage:Object(N.h)()},s=this.mockWidget.getCompleteUrl(Object.assign(i,n),null==a?void 0:a.asPopout),o=new URL(s);return null!=a&&a.asPopout||(o.searchParams.set("widgetId",this.mockWidget.id),o.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),this.scalarToken&&o.searchParams.set("scalar_token",this.scalarToken)),o.toString().replace(/%24/g,"$")}get isManagedByManager(){return!!this.scalarToken}get started(){return!!this.messaging}startMessaging(e){if(this.started)return;const t=this.appTileProps.whitelistCapabilities||[],a=new Dn(t,this.mockWidget,this.kind,this.roomId);this.messaging=new cn.ClientWidgetApi(this.mockWidget,e,a),this.messaging.on("preparing",()=>this.emit("preparing")),this.messaging.on("ready",()=>this.emit("ready")),this.messaging.on("capabilitiesNotified",()=>this.emit("capabilitiesNotified")),this.messaging.on("action:"+cn.WidgetApiFromWidgetAction.OpenModalWidget,this.onOpenModal),An.a.instance.storeMessaging(this.mockWidget,this.roomId,this.messaging),this.messaging.on("action:"+Ln.a.ViewRoom,e=>{e.preventDefault();const t=(e.detail.data||{}).room_id;return t?this.messaging.hasCapability(Rn.CanChangeViewedRoom)?(b.a.dispatch({action:M.a.ViewRoom,room_id:t,metricsTrigger:"Widget"}),void this.messaging.transport.reply(e.detail,{})):this.messaging.transport.reply(e.detail,{error:{message:"This widget does not have permission for this action (denied)."}}):this.messaging.transport.reply(e.detail,{error:{message:"Room ID not supplied."}})});for(const e of Et.a.get().getRooms()){var n;const t=(null===(n=e.getLiveTimeline())||void 0===n?void 0:n.getEvents())||[],a=t[t.length-1];a&&(this.readUpToMap[e.roomId]=a.getId())}Et.a.get().on(r.b.Event,this.onEvent),Et.a.get().on(yn.c.Decrypted,this.onEventDecrypted),this.messaging.on("action:"+cn.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,e=>{this.messaging.hasCapability(cn.MatrixCapabilities.AlwaysOnScreen)&&(pn.b.instance.setWidgetPersistence(this.mockWidget.id,this.roomId,e.detail.data.value),e.preventDefault(),this.messaging.transport.reply(e.detail,{}))}),this.messaging.on("action:"+cn.WidgetApiFromWidgetAction.SendSticker,e=>{this.messaging.hasCapability(cn.MatrixCapabilities.StickerSending)&&(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),b.a.dispatch({action:"m.sticker",data:e.detail.data,widgetId:this.mockWidget.id}))}),fn.a.STICKERPICKER.matches(this.mockWidget.type)&&this.messaging.on("action:"+Ln.a.OpenIntegrationManager,e=>{e.preventDefault(),this.messaging.transport.reply(e.detail,{}),b.a.dispatch({action:"stickerpicker_close"});const t=e.detail.data,a=null==t?void 0:t.integType,n=null==t?void 0:t.integId;Un.a.sharedInstance().getPrimaryManager().open(Et.a.get().getRoom(vt.a.instance.getRoomId()),"type_"+a,n)}),fn.a.JITSI.matches(this.mockWidget.type)&&this.messaging.on("action:"+Ln.a.HangupCall,e=>{var t;null!==(t=e.detail.data)&&void 0!==t&&t.errorMessage&&gt.a.createTrackedDialog("Connection lost","",Yn.a,{title:Object(N.a)("Connection lost"),description:Object(N.a)("You were disconnected from the call. (Error: %(message)s)",{message:e.detail.data.errorMessage})})})}async prepare(){var e,t;if(await(null!==(e=null==Gn||null===(t=Gn.isReady)||void 0===t?void 0:t.call(Gn))&&void 0!==e?e:Promise.resolve()),this.scalarToken)return;const a=An.a.instance.getMessaging(this.mockWidget,this.roomId);a&&(this.messaging=a);try{if(sn.a.isScalarUrl(this.mockWidget.templateUrl)){const e=Un.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();if(sn.a.isScalarUrl(t.apiUrl)){const e=t.getScalarClient();this.scalarToken=await e.getScalarToken()}}}}catch(e){Sa.a.error("Error preparing widget communications: ",e)}}stopMessaging(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{forceDestroy:!1};null!=e&&e.forceDestroy||!pn.b.instance.getWidgetPersistence(this.mockWidget.id,this.roomId)?this.started&&(An.a.instance.stopMessaging(this.mockWidget,this.roomId),this.messaging=null,Et.a.get()&&(Et.a.get().off(r.b.Event,this.onEvent),Et.a.get().off(yn.c.Decrypted,this.onEventDecrypted))):Sa.a.log("Skipping destroy - persistent widget")}feedEvent(e){if(!this.messaging)return;const t=this.readUpToMap[e.getRoomId()];if(t){if(t===e.getId())return;let a=!0;const n=Et.a.get().getRoom(e.getRoomId()).getLiveTimeline(),i=Object(Sn.b)(n.getEvents()).reverse().slice(0,100);for(const n of i){if(n.getId()===t)break;if(n.getId()===e.getId()){a=!1;break}}if(a)return}this.readUpToMap[e.getRoomId()]=e.getId();const a=e.getEffectiveEvent();this.messaging.feedEvent(a,this.eventListenerRoomId).catch(e=>{Sa.a.error("Error sending event to widget: ",e)})}}var Zn=a(106),ei=a(184);function ti(){return P.b.get("audio_stream_url")}async function ai(e,t){const a=await async function(e){const t=await Et.a.get().getOpenIdToken(),a=ti()+"/createStream",n=await window.fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:e,openid_token:t})});return(await n.json()).stream_id}(t);await e.transport.send(Ln.a.StartLiveStream,{rtmpStreamKey:"rtmp://audiostream.dummy/"+a})}const ni=["onFinished","app","userWidget","onDeleteClick","onEditClick","showUnpin"];var ii=e=>{let{onFinished:t,app:a,userWidget:n,onDeleteClick:i,onEditClick:r,showUnpin:c}=e,l=Ee()(e,ni);const d=Object(s.useContext)(j.a),{room:m,roomId:h}=Object(s.useContext)(Zn.b),u=An.a.instance.getMessagingForUid(sn.a.getWidgetUid(a)),p=n||sn.a.canUserModifyWidgets(h);let g;if(ti()&&fn.a.JITSI.matches(a.type)){const e=async()=>{try{await ai(u,h)}catch(e){Sa.a.error("Failed to start livestream",e);const t=e.message||Object(N.a)("Unable to start audio streaming.");gt.a.createTrackedDialog("WidgetContext Menu","Livestream failed",Yn.a,{title:Object(N.a)("Failed to start livestream"),description:t})}t()};g=o.a.createElement(ye.b,{onClick:e,label:Object(N.a)("Start audio stream")})}const f=ei.d.instance.getContainerWidgets(m,ei.a.Top),E=f.findIndex(e=>e.id===a.id);let y,_,S;if(c&&E>=0){const e=()=>{ei.d.instance.moveToContainer(m,a,ei.a.Right),t()};y=o.a.createElement(ye.b,{onClick:e,label:Object(N.a)("Unpin")})}if(p&&sn.a.isManagedByManager(a)){const e=()=>{r?r():sn.a.editWidget(m,a),t()};_=o.a.createElement(ye.b,{onClick:e,label:Object(N.a)("Edit")})}if(v.b.getValue("enableWidgetScreenshots")&&null!=u&&u.hasCapability(cn.MatrixCapabilities.Screenshots)){const e=()=>{null==u||u.takeScreenshot().then(e=>{b.a.dispatch({action:"picture_snapshot",file:e.screenshot})}).catch(e=>{Sa.a.error("Failed to take screenshot: ",e)}),t()};S=o.a.createElement(ye.b,{onClick:e,label:Object(N.a)("Take a picture")})}let w;if(i||p){const e=()=>{i?i():gt.a.createTrackedDialog("Delete Widget","",yt.a,{title:Object(N.a)("Delete Widget"),description:Object(N.a)("Deleting a widget removes it for all users in this room. Are you sure you want to delete this widget?"),button:Object(N.a)("Delete widget"),onFinished:e=>{e&&sn.a.setRoomWidget(h,a.id)}}),t()};w=o.a.createElement(ye.b,{onClick:e,label:n?Object(N.a)("Remove"):Object(N.a)("Remove for everyone")})}let C=v.b.getValue("allowedWidgets",h)[a.eventId];void 0===C&&(C=a.creatorUserId===d.getUserId());const O=fn.a.JITSI.matches(a.type);let k,x,R;if(!n&&!O&&C){const e=()=>{Sa.a.info("Revoking permission for widget to load: "+a.eventId);const e=v.b.getValue("allowedWidgets",h);e[a.eventId]=!1;const n=v.b.firstSupportedLevel("allowedWidgets");v.b.setValue("allowedWidgets",h,n,e).catch(e=>{Sa.a.error(e)}),t()};k=o.a.createElement(ye.b,{onClick:e,label:Object(N.a)("Revoke permissions")})}if(c&&E>0){const e=()=>{ei.d.instance.moveWithinContainer(m,ei.a.Top,a,-1),t()};x=o.a.createElement(ye.b,{onClick:e,label:Object(N.a)("Move left")})}if(c&&E<f.length-1){const e=()=>{ei.d.instance.moveWithinContainer(m,ei.a.Top,a,1),t()};R=o.a.createElement(ye.b,{onClick:e,label:Object(N.a)("Move right")})}return o.a.createElement(ye.e,ue()({},l,{chevronFace:ve.a.None,onFinished:t}),o.a.createElement(ye.c,null,g,_,k,w,S,x,R,y))},si=a(128);const oi=["app","className","width","height"];var ri=e=>{let{app:t,className:n,width:i=20,height:s=20}=e,r=Ee()(e,oi),c=[a(1442).default];return t.type.includes("jitsi")?c=[a(1443).default]:t.type.includes("meeting")||t.type.includes("calendar")?c=[a(1444).default]:t.type.includes("pad")||t.type.includes("doc")||t.type.includes("calc")?c=[a(1445).default]:t.type.includes("clock")&&(c=[a(1446).default]),o.a.createElement(D.a,ue()({},r,{name:t.id,className:l()("mx_WidgetAvatar",n),url:t.avatar_url?Object(si.b)(t.avatar_url).getSquareThumbnailHttp(20):void 0,urls:c,width:i,height:s}))};function ci(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function li(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ci(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ci(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class di extends o.a.Component{constructor(e){super(e),i()(this,"context",void 0),i()(this,"contextMenuButton",Object(s.createRef)()),i()(this,"iframe",void 0),i()(this,"allowedWidgetsWatchRef",void 0),i()(this,"persistKey",void 0),i()(this,"sgWidget",void 0),i()(this,"dispatcherRef",void 0),i()(this,"unmounted",void 0),i()(this,"watchUserReady",()=>{A.a.instance.isProfileInfoFetched||A.a.instance.once(L.b,this.onUserReady)}),i()(this,"onUserReady",()=>{this.setState({isUserProfileReady:!0})}),i()(this,"hasPermissionToLoad",e=>{if(this.usingLocalWidget())return!0;if(!e.room)return!0;const t=v.b.getValue("allowedWidgets",e.room.roomId);return void 0===t[e.app.eventId]?e.userId===e.creatorUserId:!!t[e.app.eventId]}),i()(this,"onMyMembership",(e,t)=>{var a;"leave"===t&&e.roomId===(null===(a=this.props.room)||void 0===a?void 0:a.roomId)&&this.onUserLeftRoom()}),i()(this,"onAllowedWidgetsChange",()=>{const e=this.hasPermissionToLoad(this.props);var t;this.state.hasPermissionToLoad&&!e&&(pn.b.instance.destroyPersistentWidget(this.props.app.id,this.props.app.roomId),vn.destroyElement(this.persistKey),null===(t=this.sgWidget)||void 0===t||t.stopMessaging());this.setState({hasPermissionToLoad:e})}),i()(this,"iframeRefChange",e=>{this.iframe=e,this.unmounted||(e?this.startMessaging():this.resetWidget(this.props))}),i()(this,"onWidgetPreparing",()=>{this.setState({loading:!1})}),i()(this,"onWidgetReady",()=>{fn.a.JITSI.matches(this.props.app.type)&&this.sgWidget.widgetApi.transport.send(Ln.a.ClientReady,{})}),i()(this,"onWidgetCapabilitiesNotified",()=>{this.setState({requiresClient:this.sgWidget.widgetApi.hasCapability(Rn.RequiresClient)})}),i()(this,"onAction",e=>{var t;switch(e.action){case"m.sticker":e.widgetId===this.props.app.id&&this.sgWidget.widgetApi.hasCapability(cn.MatrixCapabilities.StickerSending)?(b.a.dispatch({action:"post_sticker_message",data:li(li({},e.data),{},{threadId:this.props.threadId})}),b.a.dispatch({action:"stickerpicker_close"})):Sa.a.warn("Ignoring sticker message. Invalid capability");break;case M.a.AfterLeaveRoom:e.room_id===(null===(t=this.props.room)||void 0===t?void 0:t.roomId)&&this.onUserLeftRoom()}}),i()(this,"grantWidgetPermission",()=>{var e;const t=null===(e=this.props.room)||void 0===e?void 0:e.roomId;Sa.a.info("Granting permission for widget to load: "+this.props.app.eventId);const a=v.b.getValue("allowedWidgets",t);a[this.props.app.eventId]=!0;const n=v.b.firstSupportedLevel("allowedWidgets");v.b.setValue("allowedWidgets",t,n,a).then(()=>{this.setState({hasPermissionToLoad:!0}),this.startWidget()}).catch(e=>{Sa.a.error(e)})}),i()(this,"onPopoutWidgetClick",()=>{fn.a.JITSI.matches(this.props.app.type)&&this.reload(),Object.assign(document.createElement("a"),{target:"_blank",href:this.sgWidget.popoutUrl,rel:"noreferrer noopener"}).click()}),i()(this,"onToggleMaximisedClick",()=>{if(!this.props.room)return;const e=ei.d.instance.isInContainer(this.props.room,this.props.app,ei.a.Center)?ei.a.Right:ei.a.Center;ei.d.instance.moveToContainer(this.props.room,this.props.app,e)}),i()(this,"onTogglePinnedClick",()=>{if(!this.props.room)return;const e=ei.d.instance.isInContainer(this.props.room,this.props.app,ei.a.Top)?ei.a.Right:ei.a.Top;ei.d.instance.moveToContainer(this.props.room,this.props.app,e)}),i()(this,"onContextMenuClick",()=>{this.setState({menuDisplayed:!0})}),i()(this,"closeContextMenu",()=>{this.setState({menuDisplayed:!1})}),this.props.miniMode||pn.b.instance.dockWidget(this.props.app.id,this.props.app.roomId),this.persistKey="widget_"+sn.a.getWidgetUid(this.props.app);try{this.sgWidget=new Xn(this.props),this.setupSgListeners()}catch(e){Sa.a.log("Failed to construct widget",e),this.sgWidget=null}this.state=this.getNewState(e)}onUserLeftRoom(){pn.b.instance.getWidgetPersistence(this.props.app.id,this.props.app.roomId)&&(this.props.room&&vt.a.instance.getRoomId()!==this.props.room.roomId?this.endWidgetActions():fn.a.JITSI.matches(this.props.app.type)?this.reload():pn.b.instance.destroyPersistentWidget(this.props.app.id,this.props.app.roomId))}getNewState(e){return{initialising:!0,loading:this.props.waitForIframeLoad&&!vn.isMounted(this.persistKey),hasPermissionToLoad:this.hasPermissionToLoad(e),isUserProfileReady:A.a.instance.isProfileInfoFetched,error:null,menuDisplayed:!1,widgetPageTitle:this.props.widgetPageTitle,requiresClient:!0}}isMixedContent(){const e=window.location.protocol,t=rn.a.parse(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(Sa.a.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this.sgWidget&&this.state.hasPermissionToLoad&&this.startWidget(),this.watchUserReady(),this.props.room&&this.context.on(pe.c.MyMembership,this.onMyMembership),this.allowedWidgetsWatchRef=v.b.watchSetting("allowedWidgets",null,this.onAllowedWidgetsChange),this.dispatcherRef=b.a.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,this.props.miniMode||pn.b.instance.undockWidget(this.props.app.id,this.props.app.roomId),pn.b.instance.isLive(this.props.app.id,this.props.app.roomId)||this.endWidgetActions(),this.dispatcherRef&&b.a.unregister(this.dispatcherRef),this.props.room&&this.context.off(pe.c.MyMembership,this.onMyMembership),v.b.unwatchSetting(this.allowedWidgetsWatchRef),A.a.instance.removeListener(L.b,this.onUserReady)}setupSgListeners(){this.sgWidget.on("preparing",this.onWidgetPreparing),this.sgWidget.on("ready",this.onWidgetReady),this.sgWidget.on("capabilitiesNotified",this.onWidgetCapabilitiesNotified)}stopSgListeners(){this.sgWidget&&(this.sgWidget.off("preparing",this.onWidgetPreparing),this.sgWidget.off("ready",this.onWidgetReady),this.sgWidget.off("capabilitiesNotified",this.onWidgetCapabilitiesNotified))}resetWidget(e){var t;null===(t=this.sgWidget)||void 0===t||t.stopMessaging(),this.stopSgListeners();try{this.sgWidget=new Xn(e),this.setupSgListeners(),this.startWidget()}catch(e){Sa.a.error("Failed to construct widget",e),this.sgWidget=null}}startWidget(){this.sgWidget.prepare().then(()=>{this.unmounted||this.setState({initialising:!1})})}startMessaging(){try{var e;null===(e=this.sgWidget)||void 0===e||e.startMessaging(this.iframe)}catch(e){Sa.a.error("Failed to start widget",e)}}UNSAFE_componentWillReceiveProps(e){e.app.url!==this.props.app.url&&(this.getNewState(e),this.state.hasPermissionToLoad&&this.resetWidget(e)),e.widgetPageTitle!==this.props.widgetPageTitle&&this.setState({widgetPageTitle:e.widgetPageTitle})}async endWidgetActions(){var e;this.iframe&&(this.iframe.src="about:blank"),fn.a.JITSI.matches(this.props.app.type)&&this.props.room&&ne.b.instance.hangupCallApp(this.props.room.roomId),vn.destroyElement(this.persistKey),pn.b.instance.destroyPersistentWidget(this.props.app.id,this.props.app.roomId),null===(e=this.sgWidget)||void 0===e||e.stopMessaging({forceDestroy:!0})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}usingLocalWidget(){return fn.a.JITSI.matches(this.props.app.type)}getTileTitle(){const e=this.formatAppTileName(),t=o.a.createElement("span",null," - ");let a="";return this.state.widgetPageTitle&&this.state.widgetPageTitle!==this.formatAppTileName()&&(a=this.state.widgetPageTitle),o.a.createElement("span",null,o.a.createElement(ri,{app:this.props.app}),o.a.createElement("b",null,e),o.a.createElement("span",null,a?t:"",a))}reload(){this.endWidgetActions().then(()=>{this.resetWidget(this.props),this.startMessaging(),this.iframe&&(this.iframe.src=this.sgWidget.embedUrl)})}render(){let e;const t="mx_AppTileBody"+(this.props.miniMode?"_mini  ":" "),a={};this.props.pointerEvents&&(a.pointerEvents=this.props.pointerEvents);const n=o.a.createElement("div",{className:"mx_AppLoading_spinner_fadeIn"},o.a.createElement(un.a,{message:Object(N.a)("Loading...")})),i=sn.a.getWidgetName(this.props.app);if(null===this.sgWidget)e=o.a.createElement("div",{className:t,style:a},o.a.createElement(hn,{errorMsg:Object(N.a)("Error loading Widget")}));else if(this.state.hasPermissionToLoad){if(this.state.initialising||!this.state.isUserProfileReady)e=o.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":""),style:a},n);else if(this.isMixedContent())e=o.a.createElement("div",{className:t,style:a},o.a.createElement(hn,{errorMsg:Object(N.a)("Error - Mixed content")}));else if(e=o.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":""),style:a},this.state.loading&&n,o.a.createElement("iframe",{title:i,allow:"microphone; camera; encrypted-media; autoplay; display-capture; clipboard-write;",ref:this.iframeRefChange,src:this.sgWidget.embedUrl,allowFullScreen:!0,sandbox:"allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation allow-downloads"})),!this.props.userWidget){const t=101;e=o.a.createElement("div",{className:"mx_AppTile_persistedWrapper"},o.a.createElement(vn,{zIndex:this.props.miniMode?t:9,persistKey:this.persistKey},e))}}else{const n=this.context.isRoomEncrypted(this.props.room.roomId);e=o.a.createElement("div",{className:t,style:a},o.a.createElement(mn,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this.sgWidget.embedUrl,isRoomEncrypted:n,onPermissionGranted:this.grantWidgetPermission}))}let s,r;s=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},s=l()(s),this.state.menuDisplayed&&(r=o.a.createElement(ii,ue()({},Object(ve.j)(this.contextMenuButton.current.getBoundingClientRect(),null),{app:this.props.app,onFinished:this.closeContextMenu,showUnpin:!this.props.userWidget,userWidget:this.props.userWidget,onEditClick:this.props.onEditClick,onDeleteClick:this.props.onDeleteClick})));const c=[];if(this.props.showLayoutButtons){const e=ei.d.instance.isInContainer(this.props.room,this.props.app,ei.a.Center),t=l()({mx_AppTileMenuBar_iconButton:!0,mx_AppTileMenuBar_iconButton_close:e,mx_AppTileMenuBar_iconButton_maximise:!e});c.push(o.a.createElement(U.a,{key:"toggleMaximised",className:t,title:e?Object(N.a)("Close"):Object(N.a)("Maximise"),onClick:this.onToggleMaximisedClick}));const a=ei.d.instance.isInContainer(this.props.room,this.props.app,ei.a.Top),n=l()({mx_AppTileMenuBar_iconButton:!0,mx_AppTileMenuBar_iconButton_unpin:a,mx_AppTileMenuBar_iconButton_pin:!a});c.push(o.a.createElement(U.a,{key:"togglePinned",className:n,title:a?Object(N.a)("Unpin"):Object(N.a)("Pin"),onClick:this.onTogglePinnedClick}))}return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:s,id:this.props.app.id},this.props.showMenubar&&o.a.createElement("div",{className:"mx_AppTileMenuBar"},o.a.createElement("span",{className:"mx_AppTileMenuBarTitle",style:{pointerEvents:this.props.handleMinimisePointerEvents?"all":"none"}},this.props.showTitle&&this.getTileTitle()),o.a.createElement("span",{className:"mx_AppTileMenuBarWidgets"},c,this.props.showPopout&&!this.state.requiresClient&&o.a.createElement(U.a,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_popout",title:Object(N.a)("Popout widget"),onClick:this.onPopoutWidgetClick}),o.a.createElement(ve.b,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_menu",label:Object(N.a)("Options"),isExpanded:this.state.menuDisplayed,inputRef:this.contextMenuButton,onClick:this.onContextMenuClick}))),e),r)}}i()(di,"contextType",j.a),i()(di,"defaultProps",{waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showPopout:!0,handleMinimisePointerEvents:!1,userWidget:!1,miniMode:!1,threadId:null,showLayoutButtons:!0});class mi extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"room",void 0),this.room=t.getRoom(this.props.persistentRoomId)}get app(){const e=sn.a.getRoomWidgets(this.room).find(e=>e.getStateKey()===this.props.persistentWidgetId);return e?sn.a.makeAppConfig(e.getStateKey(),e.getContent(),e.getSender(),this.room.roomId,e.getId()):null}render(){const e=this.app;return e?o.a.createElement(di,{key:e.id,app:e,fullWidth:!0,room:this.room,userId:this.context.credentials.userId,creatorUserId:e.creatorUserId,widgetPageTitle:sn.a.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,miniMode:!0,showMenubar:!1,pointerEvents:this.props.pointerEvents}):null}}function hi(e,t,a){return(1-(a=Object(x.clamp)(a,0,1)))*e+a*t}i()(mi,"contextType",j.a);var ui=a(346);const pi=58,gi=58,bi=76,vi=8;class fi extends o.a.Component{constructor(e){var t;super(e),t=this,i()(this,"callViewWrapper",Object(s.createRef)()),i()(this,"initX",0),i()(this,"initY",0),i()(this,"desiredTranslationX",de.b.instance.windowWidth-vi-336),i()(this,"desiredTranslationY",de.b.instance.windowHeight-gi-232),i()(this,"moving",!1),i()(this,"scheduledUpdate",new ui.a(()=>this.animationCallback(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),i()(this,"animationCallback",()=>{if(!this.moving&&Math.abs(this.state.translationX-this.desiredTranslationX)<=1&&Math.abs(this.state.translationY-this.desiredTranslationY)<=1)return;const e=this.moving?.2:.1;this.setState({translationX:hi(this.state.translationX,this.desiredTranslationX,e),translationY:hi(this.state.translationY,this.desiredTranslationY,e)}),this.scheduledUpdate.mark()}),i()(this,"onResize",()=>{this.snap(!1)}),i()(this,"snap",(function(){var e,a;let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const i=t.desiredTranslationX,s=t.desiredTranslationY,o=de.b.instance.windowWidth-((null===(e=t.callViewWrapper.current)||void 0===e?void 0:e.clientWidth)||336),r=de.b.instance.windowHeight-((null===(a=t.callViewWrapper.current)||void 0===a?void 0:a.clientHeight)||232);i>=o/2&&s>=r/2?(t.desiredTranslationX=o-vi,t.desiredTranslationY=r-gi):i>=o/2&&s<=r/2?(t.desiredTranslationX=o-vi,t.desiredTranslationY=pi):i<=o/2&&s>=r/2?(t.desiredTranslationX=bi,t.desiredTranslationY=r-gi):(t.desiredTranslationX=bi,t.desiredTranslationY=pi),t.scheduledUpdate.mark(),n?t.scheduledUpdate.mark():t.setState({translationX:t.desiredTranslationX,translationY:t.desiredTranslationY})})),i()(this,"onStartMoving",e=>{e.preventDefault(),e.stopPropagation(),this.moving=!0,this.initX=e.pageX-this.desiredTranslationX,this.initY=e.pageY-this.desiredTranslationY,this.scheduledUpdate.mark()}),i()(this,"onMoving",e=>{this.moving&&(e.preventDefault(),e.stopPropagation(),this.setTranslation(e.pageX-this.initX,e.pageY-this.initY))}),i()(this,"onEndMoving",()=>{this.moving=!1,this.snap(!0)}),this.state={translationX:de.b.instance.windowWidth-vi-336,translationY:de.b.instance.windowHeight-gi-232}}componentDidMount(){document.addEventListener("mousemove",this.onMoving),document.addEventListener("mouseup",this.onEndMoving),window.addEventListener("resize",this.onResize)}componentWillUnmount(){document.removeEventListener("mousemove",this.onMoving),document.removeEventListener("mouseup",this.onEndMoving),window.removeEventListener("resize",this.onResize)}setTranslation(e,t){var a,n;const i=(null===(a=this.callViewWrapper.current)||void 0===a?void 0:a.clientWidth)||336,s=(null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientHeight)||232;e+i>=de.b.instance.windowWidth?this.desiredTranslationX=de.b.instance.windowWidth-i:this.desiredTranslationX=e<=0?0:e,t+s>=de.b.instance.windowHeight?this.desiredTranslationY=de.b.instance.windowHeight-s:this.desiredTranslationY=t<=0?0:t}render(){const e={transform:`translateX(${this.state.translationX+"px"})\n                        translateY(${this.state.translationY+"px"})`};return o.a.createElement("div",{className:this.props.className,style:this.props.draggable?e:void 0,ref:this.callViewWrapper,onDoubleClick:this.props.onDoubleClick},o.a.createElement(o.a.Fragment,null,this.props.children({onStartMoving:this.onStartMoving,onResize:this.onResize})))}}var Ei=a(209);const yi=[_a.e.Connected,_a.e.InviteSent,_a.e.Connecting,_a.e.CreateAnswer,_a.e.CreateOffer,_a.e.WaitLocalMedia],_i=(e,t)=>{if(!e)return;if(!t)return;return[Et.a.get().getRoom(t),Ei.a.instance.getApps(t).find(t=>t.id===e)]};function Si(e){const t=ne.b.instance.getAllActiveCallsForPip(e);let a=null,n=[];for(const e of t)yi.includes(e.state)&&(e.isRemoteOnHold()||null!==a?n.push(e):a=e);return null===a&&n.length>0&&(a=n[0],n=n.slice(1)),n.length>1&&Sa.a.log("Found more than 1 secondary call! Other calls will not be shown."),[a,n]}class wi extends o.a.Component{constructor(e){super(e),i()(this,"roomStoreToken",void 0),i()(this,"settingsWatcherRef",void 0),i()(this,"onRoomViewStoreUpdate",()=>{var e,t;const a=vt.a.instance.getRoomId(),n=this.state.viewedRoomId;if(a===n)return;const i=null===(e=Et.a.get())||void 0===e?void 0:e.getRoom(n);i&&ei.d.instance.off(ei.d.emissionForRoom(i),this.updateCalls);const s=null===(t=Et.a.get())||void 0===t?void 0:t.getRoom(a);if(s&&ei.d.instance.on(ei.d.emissionForRoom(s),this.updateCalls),!a)return;const[o,r]=Si(a);this.setState({viewedRoomId:a,primaryCall:o,secondaryCall:r[0]}),this.updateShowWidgetInPip()}),i()(this,"onWidgetPersistence",()=>{this.updateShowWidgetInPip(pn.b.instance.getPersistentWidgetId(),pn.b.instance.getPersistentRoomId())}),i()(this,"onWidgetDockChanges",()=>{this.updateShowWidgetInPip()}),i()(this,"updateCalls",()=>{if(!this.state.viewedRoomId)return;const[e,t]=Si(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]}),this.updateShowWidgetInPip()}),i()(this,"onCallRemoteHold",()=>{if(!this.state.viewedRoomId)return;const[e,t]=Si(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]})}),i()(this,"onDoubleClick",()=>{var e;const t=null===(e=this.state.primaryCall)||void 0===e?void 0:e.roomId;(null!=t?t:this.state.persistentRoomId)&&b.a.dispatch({action:M.a.ViewRoom,room_id:null!=t?t:this.state.persistentRoomId,metricsTrigger:"WebFloatingCallWindow"})}),i()(this,"onMaximize",()=>{const e=this.state.persistentWidgetId,t=this.state.persistentRoomId;if(this.state.showWidgetInPip&&e&&t){const[a,n]=_i(e,t);ei.d.instance.moveToContainer(a,n,ei.a.Center)}else b.a.dispatch({action:"video_fullscreen",fullscreen:!0})}),i()(this,"onPin",()=>{if(!this.state.showWidgetInPip)return;const[e,t]=_i(this.state.persistentWidgetId,this.state.persistentRoomId);ei.d.instance.moveToContainer(e,t,ei.a.Top)}),i()(this,"onExpand",()=>{this.state.persistentWidgetId&&this.state.showWidgetInPip&&b.a.dispatch({action:M.a.ViewRoom,room_id:this.state.persistentRoomId})});const t=vt.a.instance.getRoomId(),[a,n]=Si(t);this.state={moving:!1,viewedRoomId:t,primaryCall:a,secondaryCall:n[0],persistentWidgetId:pn.b.instance.getPersistentWidgetId(),persistentRoomId:pn.b.instance.getPersistentRoomId(),showWidgetInPip:!1}}componentDidMount(){var e;ne.b.instance.addListener(ne.a.CallChangeRoom,this.updateCalls),ne.b.instance.addListener(ne.a.CallState,this.updateCalls),this.roomStoreToken=vt.a.instance.addListener(this.onRoomViewStoreUpdate),Et.a.get().on(_a.c.RemoteHoldUnhold,this.onCallRemoteHold);const t=null===(e=Et.a.get())||void 0===e?void 0:e.getRoom(this.state.viewedRoomId);t&&ei.d.instance.on(ei.d.emissionForRoom(t),this.updateCalls),pn.b.instance.on(pn.a.Persistence,this.onWidgetPersistence),pn.b.instance.on(pn.a.Dock,this.onWidgetDockChanges),pn.b.instance.on(pn.a.Undock,this.onWidgetDockChanges),document.addEventListener("mouseup",this.onEndMoving.bind(this))}componentWillUnmount(){var e;ne.b.instance.removeListener(ne.a.CallChangeRoom,this.updateCalls),ne.b.instance.removeListener(ne.a.CallState,this.updateCalls),Et.a.get().removeListener(_a.c.RemoteHoldUnhold,this.onCallRemoteHold),null===(e=this.roomStoreToken)||void 0===e||e.remove(),v.b.unwatchSetting(this.settingsWatcherRef);const t=Et.a.get().getRoom(this.state.viewedRoomId);t&&ei.d.instance.off(ei.d.emissionForRoom(t),this.updateCalls),pn.b.instance.off(pn.a.Persistence,this.onWidgetPersistence),pn.b.instance.off(pn.a.Dock,this.onWidgetDockChanges),pn.b.instance.off(pn.a.Undock,this.onWidgetDockChanges),document.removeEventListener("mouseup",this.onEndMoving.bind(this))}onStartMoving(){this.setState({moving:!0})}onEndMoving(){this.setState({moving:!1})}updateShowWidgetInPip(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.state.persistentWidgetId,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.state.persistentRoomId,a=!1,n=!1;e&&Et.a.get().getRoom(t)&&(n=!pn.b.instance.isDocked(e,t),a=this.state.viewedRoomId!==t);const i=a||n;this.setState({showWidgetInPip:i,persistentWidgetId:e,persistentRoomId:t})}render(){let e;if(this.state.primaryCall&&(e=e=>{let{onStartMoving:t,onResize:a}=e;return o.a.createElement(nn,{onMouseDownOnHeader:t,call:this.state.primaryCall,secondaryCall:this.state.secondaryCall,pipMode:!0,onResize:a})}),this.state.showWidgetInPip){const t=l()({mx_CallView:!0,mx_CallView_pip:!0,mx_CallView_large:!1}),a=this.state.persistentRoomId,n=Et.a.get().getRoom(a),i=this.state.viewedRoomId===a;e=e=>{let{onStartMoving:s,_onResize:r}=e;return o.a.createElement("div",{className:t},o.a.createElement(La,{onPipMouseDown:e=>{s(e),this.onStartMoving.bind(this)()},pipMode:!0,callRooms:[n],onExpand:!i&&this.onExpand,onPin:i&&this.onPin,onMaximize:i&&this.onMaximize}),o.a.createElement(mi,{persistentWidgetId:this.state.persistentWidgetId,persistentRoomId:a,pointerEvents:this.state.moving?"none":void 0}))}}return e?o.a.createElement(fi,{className:"mx_CallPreview",draggable:!0,onDoubleClick:this.onDoubleClick},e):null}}class Ci extends o.a.PureComponent{render(){return o.a.createElement("div",{className:"mx_PiPContainer"},o.a.createElement(wi,null))}}var Oi=a(714);class ki extends s.PureComponent{constructor(e,t){super(e,t),i()(this,"onUpdateToasts",()=>{this.setState({toasts:Oi.a.instance.components})}),this.state={toasts:Oi.a.instance.components},Oi.a.instance.on(L.b,this.onUpdateToasts)}componentWillUnmount(){Oi.a.instance.off(L.b,this.onUpdateToasts)}render(){const e=this.state.toasts.map((e,t)=>s.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:"toast-"+t},s.createElement(e,{})));return s.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}}let xi;!function(e){e.CloseDialog="close_dialog",e.HostSignupAccountDetails="host_signup_account_details",e.HostSignupAccountDetailsRequest="host_signup_account_details_request",e.Minimize="host_signup_minimize",e.Maximize="host_signup_maximize",e.SetupComplete="setup_complete"}(xi||(xi={}));class Ri extends o.a.PureComponent{constructor(e){super(e),i()(this,"iframeRef",o.a.createRef()),i()(this,"config",void 0),i()(this,"messageHandler",async e=>{if(this.config.get("url").startsWith(e.origin))switch(e.data.action){case xi.HostSignupAccountDetailsRequest:this.onAccountDetailsRequest();break;case xi.Maximize:this.setState({minimized:!1});break;case xi.Minimize:this.setState({minimized:!0});break;case xi.SetupComplete:this.setState({completed:!0});break;case xi.CloseDialog:return this.closeDialog()}}),i()(this,"maximizeDialog",()=>{this.setState({minimized:!1}),this.sendMessage({action:xi.Maximize})}),i()(this,"minimizeDialog",()=>{this.setState({minimized:!0}),this.sendMessage({action:xi.Minimize})}),i()(this,"closeDialog",async()=>(window.removeEventListener("message",this.messageHandler),vn.destroyElement("host_signup"),Rt.instance.setHostSignupActive(!1))),i()(this,"onCloseClick",async()=>{if(this.state.completed)return this.closeDialog();gt.a.createDialog(yt.a,{title:Object(N.a)("Confirm abort of host creation"),description:Object(N.a)("Are you sure you wish to abort creation of the host? The process cannot be continued."),button:Object(N.a)("Abort"),onFinished:e=>{if(e)return this.closeDialog()}})}),i()(this,"sendMessage",e=>{this.iframeRef.current.contentWindow.postMessage(e,this.config.get("url"))}),i()(this,"onAccountDetailsDialogFinished",async e=>e?this.sendAccountDetails():this.closeDialog()),i()(this,"onAccountDetailsRequest",()=>{const e=this.config.get("cookie_policy_url"),t=this.config.get("privacy_policy_url"),a=this.config.get("terms_of_service_url"),n=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(N.a)("Continuing temporarily allows the %(hostSignupBrand)s setup process to access your account to fetch verified email addresses. This data is not stored.",{hostSignupBrand:this.config.get("brand")})),o.a.createElement("p",null,Object(N.a)("Learn more in our <privacyPolicyLink />, <termsOfServiceLink /> and <cookiePolicyLink />.",{},{cookiePolicyLink:()=>o.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},Object(N.a)("Cookie Policy")),privacyPolicyLink:()=>o.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},Object(N.a)("Privacy Policy")),termsOfServiceLink:()=>o.a.createElement("a",{href:a,target:"_blank",rel:"noreferrer noopener"},Object(N.a)("Terms of Service"))})));gt.a.createDialog(yt.a,{title:Object(N.a)("You should know"),description:n,button:Object(N.a)("Continue"),onFinished:this.onAccountDetailsDialogFinished})}),this.state={completed:!1,error:null,minimized:!1},this.config=P.b.getObject("host_signup")}async sendAccountDetails(){const e=await Et.a.get().getOpenIdToken();if(!e||!e.access_token)return Sa.a.warn("Failed to connect to homeserver for OpenID token."),void this.setState({completed:!0,error:Object(N.a)("Failed to connect to your homeserver. Please close this dialog and try again.")});this.sendMessage({action:xi.HostSignupAccountDetails,account:{accessToken:await Et.a.get().getAccessToken(),name:A.a.instance.displayName,openIdToken:e.access_token,serverName:await Et.a.get().getDomain(),userLocalpart:await Et.a.get().getUserIdLocalpart(),termsAccepted:!0}})}componentDidMount(){window.addEventListener("message",this.messageHandler)}componentWillUnmount(){if(Rt.instance.isHostSignupActive)return this.closeDialog()}render(){return o.a.createElement("div",{className:"mx_HostSignup_persisted"},o.a.createElement(vn,{key:"host_signup",persistKey:"host_signup"},o.a.createElement("div",{className:l()({mx_Dialog_wrapper:!this.state.minimized})},o.a.createElement("div",{className:l()("mx_Dialog",{mx_HostSignupDialog_minimized:this.state.minimized,mx_HostSignupDialog:!this.state.minimized})},this.state.minimized&&o.a.createElement("div",{className:"mx_Dialog_header mx_Dialog_headerWithButton"},o.a.createElement("div",{className:"mx_Dialog_title"},Object(N.a)("%(hostSignupBrand)s Setup",{hostSignupBrand:this.config.get("brand")})),o.a.createElement(U.a,{className:"mx_HostSignup_maximize_button",onClick:this.maximizeDialog,"aria-label":Object(N.a)("Maximise dialog"),title:Object(N.a)("Maximise dialog")})),!this.state.minimized&&o.a.createElement("div",{className:"mx_Dialog_header mx_Dialog_headerWithCancel"},o.a.createElement(U.a,{onClick:this.minimizeDialog,className:"mx_HostSignup_minimize_button","aria-label":Object(N.a)("Minimise dialog"),title:Object(N.a)("Minimise dialog")}),o.a.createElement(U.a,{onClick:this.onCloseClick,className:"mx_Dialog_cancelButton","aria-label":Object(N.a)("Close dialog"),title:Object(N.a)("Close dialog")})),this.state.error&&o.a.createElement("div",null,this.state.error),!this.state.error&&o.a.createElement("iframe",{title:Object(N.a)("Upgrade to %(hostSignupBrand)s",{hostSignupBrand:this.config.get("brand")}),src:this.config.get("url"),ref:this.iframeRef,sandbox:"allow-forms allow-scripts allow-same-origin allow-popups"})))))}}var ji=()=>{const[e,t]=Object(s.useState)(Rt.instance.isHostSignupActive);return Object(F.a)(Rt.instance,L.b,()=>{t(Rt.instance.isHostSignupActive)}),o.a.createElement("div",{className:"mx_HostSignupContainer"},e&&o.a.createElement(Ri,null))};class Ii extends o.a.Component{constructor(e){super(e),i()(this,"element",Object(s.createRef)()),i()(this,"onAudioOutputChanged",e=>{const t=this.element.current;if(e)try{t.setSinkId(e)}catch(e){Sa.a.error("Couldn't set requested audio output device: using default",e),Sa.a.warn("Couldn't set requested audio output device: using default",e)}}),i()(this,"onNewStream",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted()}),this.playMedia()}),this.state={audioMuted:this.props.feed.isAudioMuted()}}componentDidMount(){p.c.instance.addListener(p.a.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.addListener(Ca.b.NewStream,this.onNewStream),this.playMedia()}componentWillUnmount(){p.c.instance.removeListener(p.a.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.removeListener(Ca.b.NewStream,this.onNewStream),this.stopMedia()}async playMedia(){const e=this.element.current;if(e){this.onAudioOutputChanged(p.c.getAudioOutput()),e.muted=!1,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.load()}catch(e){Sa.a.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element.current;e&&(e.pause(),e.src=null)}render(){return this.state.audioMuted?null:o.a.createElement("audio",{ref:this.element})}}class Ti extends o.a.Component{constructor(e){super(e),i()(this,"onFeedsChanged",()=>{this.setState({feeds:this.props.call.getRemoteFeeds()})}),this.state={feeds:this.props.call.getRemoteFeeds()}}componentDidMount(){this.props.call.addListener(_a.c.FeedsChanged,this.onFeedsChanged)}componentWillUnmount(){this.props.call.removeListener(_a.c.FeedsChanged,this.onFeedsChanged)}render(){return this.state.feeds.map((e,t)=>o.a.createElement(Ii,{feed:e,key:t}))}}var Ni=a(145),Pi=a(125),Mi=a(327),Di=a(277),Ai=a(238),Ui=a(373),Li=a(274);async function Fi(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;const a=Et.a.get(),n={limit:10};void 0!==t&&(n.rooms=[t]);const i={search_categories:{room_events:{search_term:e,filter:n,order_by:Ui.a.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},s=await a.search({body:i});return{response:s,query:i}}async function Bi(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;const a=Et.a.get(),n=await Fi(e,t),i={_query:n.query,results:[],highlights:[]};return a.processRoomEventsSearch(i,n.response)}function Vi(e,t){const a=e.result,n=t.result;return a.origin_server_ts>n.origin_server_ts?-1:a.origin_server_ts<n.origin_server_ts?1:0}async function Wi(e){const t=Et.a.get(),a=Fi(e),n=Hi(e);await Promise.all([a,n]);const i=await n,s=await a,o=s.query,r=s.response,c=i.query,l=i.response,d={seshatQuery:c,_query:o,serverSideNextBatch:r.search_categories.room_events.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},m={search_categories:{room_events:Yi(d,l,r.search_categories.room_events)}},h=t.processRoomEventsSearch(d,m);return Ji(h.results),h}async function Hi(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;const a=Li.a.get(),n={search_term:e,before_limit:1,after_limit:1,limit:10,order_by_recency:!0,room_id:void 0};void 0!==t&&(n.room_id=t);const i=await a.search(n);n.next_batch=i.next_batch;const s={response:i,query:n};return s}async function zi(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;const a={results:[],highlights:[]};if(""===e)return a;const n=await Hi(e,t);a.seshatQuery=n.query;const i={search_categories:{room_events:n.response}},s=Et.a.get().processRoomEventsSearch(a,i);return Ji(s.results),s}function Ki(e,t){try{const a=e[e.length-1].result,n=t[t.length-1].result;return a.origin_server_ts<=n.origin_server_ts?-1:1}catch{return 0}}function qi(e,t,a,n){const i=a.concat(n).sort(Vi);t.results=i.slice(0,10),e.cachedEvents=i.slice(10)}function Gi(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;const n={},i=e.cachedEvents;let s=e.oldestEventFrom;return n.highlights=e.highlights,t&&a&&a.results?(Ki(t.results,a.results)<0&&(s="local"),qi(e,n,t.results,a.results),n.highlights=t.highlights.concat(a.highlights)):t?(Ki(t.results,i)<0&&(s="local"),qi(e,n,t.results,i)):a&&a.results?(Ki(a.results,i)<0&&(s="server"),qi(e,n,a.results,i)):(n.results=i,e.cachedEvents=[]),e.oldestEventFrom=s,n}function Yi(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;const n=Gi(e,t,a);return e.count?n.count=e.count:n.count=t.count+a.count,t&&(e.seshatQuery.next_batch=t.next_batch),a&&(e.serverSideNextBatch=a.next_batch),e.seshatQuery.next_batch?n.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(n.next_batch=e.serverSideNextBatch),!n.next_batch&&e.cachedEvents.length>0&&(n.next_batch="cached"),n}function Ji(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(let t=0;t<e.length;t++){const a=e[t].context.getTimeline();for(let e=0;e<a.length;e++){const t=a[e],n=t.event;n.curve25519Key&&(t.makeEncrypted(ge.b.RoomMessageEncrypted,{algorithm:n.algorithm},n.curve25519Key,n.ed25519Key),t.forwardingCurve25519KeyChain=n.forwardingCurve25519KeyChain,delete n.curve25519Key,delete n.ed25519Key,delete n.algorithm,delete n.forwardingCurve25519KeyChain)}}}function $i(e){let t,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return t=void 0!==a?Et.a.get().isRoomEncrypted(a)?zi(e,a):Bi(e,a):Wi(e),t}function Qi(e){const t=Et.a.get(),a=e.seshatQuery,n=e._query;if(a){if(n){const t=async function(e){const t=Li.a.get(),a=Et.a.get(),n=e.seshatQuery,i=e.oldestEventFrom;let s,o,r;if(!n.next_batch||e.serverSideNextBatch&&"server"!==i||(s=await t.search(n)),e.serverSideNextBatch&&("local"===i||!n.next_batch)){const t={body:e._query,next_batch:e.serverSideNextBatch};o=await a.search(t)}o&&(r=o.search_categories.room_events);const c={search_categories:{room_events:Yi(e,s,r)}},l=e.results?e.results.length:0,d=a.processRoomEventsSearch(e,c),m=d.results.length-l;return Ji(d.results.slice(Math.max(d.results.length-m,0))),e.pendingRequest=null,d}(e);return e.pendingRequest=t,t}{const t=async function(e){const t=Li.a.get(),a=e.seshatQuery,n=await t.search(a);e.seshatQuery.next_batch=n.next_batch;const i=n.results.length,s={search_categories:{room_events:n}},o=Et.a.get().processRoomEventsSearch(e,s);return Ji(o.results.slice(Math.max(o.results.length-i,0))),e.pendingRequest=null,o}(e);return e.pendingRequest=t,t}}return t.backPaginateRoomEventsSearch(e)}var Xi=a(411);class Zi extends o.a.Component{constructor(){super(...arguments),i()(this,"onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),i()(this,"onResize",()=>{this.props.resizeNotifier.notifyRightHandleResized()}),i()(this,"onResizeStop",(e,t,a,n)=>{this.props.resizeNotifier.stopResizing(),window.localStorage.setItem("mx_rhs_size",(this.loadSidePanelSize().width+n.width).toString())})}loadSidePanelSize(){let e=parseInt(window.localStorage.getItem("mx_rhs_size"),10);return isNaN(e)&&(e=350),{height:"100%",width:e}}render(){const e=o.a.Children.only(this.props.children),t=this.props.panel;let a;return!this.props.collapsedRhs&&t&&(a=o.a.createElement(Xi.Resizable,{defaultSize:this.loadSidePanelSize(),minWidth:264,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_ResizeHandle_horizontal"}},t)),o.a.createElement("div",{className:"mx_MainSplit"},e,a)}}var es=a(151),ts=a(146),as=a(139);function ns(e,t){const[a,n]=Object(s.useState)(t?e.isRoomEncrypted(t.roomId):void 0),i=Object(s.useCallback)(a=>{t&&a.getType()===ge.b.RoomEncryption&&n(e.isRoomEncrypted(t.roomId))},[e,t]);return Object(F.c)(null==t?void 0:t.currentState,m.b.Events,i),a}var is=a(395);const ss=e=>{let{className:t,title:a,children:n}=e;return o.a.createElement("div",{className:l()("mx_BaseCard_Group",t)},o.a.createElement("h1",null,a),n)};var os=Object(s.forwardRef)((e,t)=>{let a,{closeLabel:n,onClose:i,onBack:s,className:r,header:c,footer:d,withoutScrollContainer:m,children:h,onKeyDown:u}=e;const p=as.a.instance.roomPhaseHistory;if(p.length>1){var g;const e=p[p.length-2],t=e=>{null==s||s(e),as.a.instance.popCard()},n=null!==(g=Object(ts.b)(e.phase))&&void 0!==g?g:Object(N.a)("Back");a=o.a.createElement(U.a,{className:"mx_BaseCard_back",onClick:t,title:n})}let b;return i&&(b=o.a.createElement(U.a,{"data-test-id":"base-card-close-button",className:"mx_BaseCard_close",onClick:i,title:n||Object(N.a)("Close")})),m||(h=o.a.createElement(I.a,null,h)),o.a.createElement(is.a.Provider,{value:{isCard:!0}},o.a.createElement("div",{className:l()("mx_BaseCard",r),ref:t,onKeyDown:u},o.a.createElement("div",{className:"mx_BaseCard_header"},a,b,c),h,d&&o.a.createElement("div",{className:"mx_BaseCard_footer"},d)))}),rs=a(498),cs=a(135);let ls;!function(e){e.Warning="warning",e.Verified="verified",e.Normal="normal"}(ls||(ls={}));const ds=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250;const[a,n]=Object(s.useState)(e.getJoinedMemberCount());return Object(F.c)(e.currentState,m.b.Update,Object(x.throttle)(()=>{n(e.getJoinedMemberCount())},t,{leading:!0,trailing:!0})),a},ms=e=>{const[t,a]=Object(s.useState)(e.getMyMembership());return Object(F.c)(e,pe.c.MyMembership,()=>{a(e.getMyMembership())}),t};var hs=a(165);class us{static isPinnable(e){return!!e&&(!!this.pinnableEventTypes.includes(e.getType())&&!e.isRedacted())}}i()(us,"pinnableEventTypes",[ge.b.RoomMessage,hs.M_POLL_START.name,hs.M_POLL_START.altName]);var ps=a(266),gs=a(315),bs=a(843),vs=a(133),fs=a(175);class Es extends o.a.Component{constructor(){super(...arguments),i()(this,"onTileClicked",()=>{b.a.dispatch({action:M.a.ViewRoom,event_id:this.props.event.getId(),highlighted:!0,room_id:this.props.event.getRoomId(),metricsTrigger:void 0})}),i()(this,"relations",new Map),i()(this,"getRelationsForEvent",(e,t,a)=>{var n;if(e===this.props.event.getId())return null===(n=this.relations.get(t))||void 0===n?void 0:n.get(a)})}async componentDidMount(){if(hs.M_POLL_START.matches(this.props.event.getType())){const e=this.props.event.getId(),t=this.props.event.getRoomId(),a=this.context.getRoom(t);try{await Promise.all([hs.M_POLL_RESPONSE.name,hs.M_POLL_RESPONSE.altName,hs.M_POLL_END.name,hs.M_POLL_END.altName].map(async n=>{const i=new gs.a(ge.d.Reference,n,a);let s;i.setTargetEvent(this.props.event),this.relations.has(ge.d.Reference)||this.relations.set(ge.d.Reference,new Map),this.relations.get(ge.d.Reference).set(n,i);do{const a=await this.context.relations(t,e,ge.d.Reference,n,{from:s});s=a.nextBatch,a.events.forEach(e=>i.addEvent(e))}while(s)}))}catch(a){Sa.a.error(`Error fetching responses to pinned poll ${e} in room ${t}`),Sa.a.error(a)}}}render(){var e;const t=this.props.event.getSender();let a=null;return this.props.onUnpinClicked&&(a=o.a.createElement(oe.a,{onClick:this.props.onUnpinClicked,className:"mx_PinnedEventTile_unpinButton",title:Object(N.a)("Unpin")})),o.a.createElement("div",{className:"mx_PinnedEventTile"},o.a.createElement(Oa.a,{className:"mx_PinnedEventTile_senderAvatar",member:this.props.event.sender,width:24,height:24,fallbackUserId:t}),o.a.createElement("span",{className:"mx_PinnedEventTile_sender "+Object(fs.f)(t)},(null===(e=this.props.event.sender)||void 0===e?void 0:e.name)||t),a,o.a.createElement("div",{className:"mx_PinnedEventTile_message"},o.a.createElement(bs.a,{mxEvent:this.props.event,getRelationsForEvent:this.getRelationsForEvent,className:"mx_PinnedEventTile_body",maxImageHeight:150,onHeightChanged:()=>{}})),o.a.createElement("div",{className:"mx_PinnedEventTile_footer"},o.a.createElement("span",{className:"mx_PinnedEventTile_timestamp"},Object(vs.b)(new Date(this.props.event.getTs()))),o.a.createElement(U.a,{onClick:this.onTileClicked,kind:"link"},Object(N.a)("View message"))))}}i()(Es,"contextType",j.a);var ys=a(414),_s=a(700);function Ss(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function ws(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Ss(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Ss(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const Cs=e=>{const[t,a]=Object(s.useState)([]),n=Object(s.useCallback)(t=>{var n,i;e&&(t&&t.getType()!==ge.b.RoomPinnedEvents||a((null===(n=e.currentState.getStateEvents(ge.b.RoomPinnedEvents,""))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.pinned)||[]))},[e]);return Object(F.c)(null==e?void 0:e.currentState,m.b.Events,n),Object(s.useEffect)(()=>(n(),()=>{a([])}),[n]),t},Os=e=>{const[t,a]=Object(s.useState)(new Set),n=Object(s.useCallback)(t=>{var n,i;if(!e)return;if(t&&t.getType()!==_s.a)return;const s=null===(n=e.getAccountData(_s.a))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.event_ids;a(new Set(s||[]))},[e]);return Object(F.c)(e,pe.c.AccountData,n),Object(s.useEffect)(()=>(n(),()=>{a(new Set)}),[n]),t};var ks=e=>{let{room:t,onClose:a}=e;const n=Object(s.useContext)(j.a),i=Object(s.useContext)(Zn.b),r=Object(ys.a)(t,e=>e.mayClientSendStateEvent(ge.b.RoomPinnedEvents,n)),c=Cs(t),l=Os(t);Object(s.useEffect)(()=>{c.filter(e=>!l.has(e)).length>0&&n.setRoomAccountData(t.roomId,_s.a,{event_ids:c})},[n,t.roomId,c,l]);const d=Object(ps.a)(()=>{const e=c.map(async e=>{var a;const i=t.getUnfilteredTimelineSet(),s=null==i||null===(a=i.getTimelineForEvent(e))||void 0===a?void 0:a.getEvents().find(t=>t.getId()===e);if(s)return us.isPinnable(s)?s:null;try{const[a,{events:[i]}]=await Promise.all([n.fetchRoomEvent(t.roomId,e),n.relations(t.roomId,e,ge.d.Replace,null,{limit:1})]),s=new yn.b(a);if(s.isEncrypted()&&await n.decryptEventIfNeeded(s),s&&us.isPinnable(s))return s.sender=t.getMember(s.getSender()),i&&s.makeReplaced(i),s}catch(a){Sa.a.error("Error looking up pinned event "+e+" in room "+t.roomId),Sa.a.error(a)}return null});return Promise.all(e)},[n,t,c],null);let m;if(d)if(d.length>0){const e=async e=>{var a;const i=t.currentState.getStateEvents(ge.b.RoomPinnedEvents,"");if(null!=i&&null!==(a=i.getContent())&&void 0!==a&&a.pinned){const a=i.getContent().pinned,s=a.indexOf(e.getId());-1!==s&&(a.splice(s,1),await n.sendStateEvent(t.roomId,ge.b.RoomPinnedEvents,{pinned:a},""))}};m=d.filter(Boolean).reverse().map(t=>o.a.createElement(Es,{key:t.getId(),event:t,onUnpinClicked:r?()=>e(t):void 0}))}else m=o.a.createElement("div",{className:"mx_PinnedMessagesCard_empty"},o.a.createElement("div",null,o.a.createElement("div",{className:"mx_PinnedMessagesCard_MessageActionBar"},o.a.createElement("div",{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_reactButton"}),o.a.createElement("div",{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_replyButton"}),o.a.createElement("div",{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton"})),o.a.createElement("h2",null,Object(N.a)("Nothing pinned, yet")),Object(N.a)("If you have permissions, open the menu on any message and select <b>Pin</b> to stick them here.",{},{b:e=>o.a.createElement("b",null,e)})));else m=o.a.createElement(un.a,null);return o.a.createElement(os,{header:o.a.createElement("h2",null,Object(N.a)("Pinned messages")),className:"mx_PinnedMessagesCard",onClose:a},o.a.createElement(Zn.b.Provider,{value:ws(ws({},i),{},{timelineRenderingType:Zn.a.Pinned})},m))},xs=a(233),Rs=a(302),js=a(830),Is=a(169),Ts=a(1447),Ns=a(566),Ps=a(198);class Ms extends Ns.a{constructor(e,t,a,n){super(e,t,a,n),i()(this,"totalSize",0),i()(this,"messages",[])}createJSONString(){var e,t,a,n,i,s,o;const r=Object(vs.f)(new Date),c=null===(e=this.room.currentState.getStateEvents(ge.b.RoomCreate,""))||void 0===e?void 0:e.getSender(),l=(null===(t=this.room)||void 0===t||null===(a=t.getMember(c))||void 0===a?void 0:a.rawDisplayName)||c,d=(null===(n=this.room.currentState.getStateEvents(ge.b.RoomTopic,""))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.topic)||"",m=this.client.getUserId(),h=(null===(s=this.room)||void 0===s||null===(o=s.getMember(m))||void 0===o?void 0:o.rawDisplayName)||m,u={room_name:this.room.name,room_creator:l,topic:d,export_date:r,exported_by:h,messages:this.messages};return JSON.stringify(u,null,2)}async getJSONString(e){if(this.exportOptions.attachmentsIncluded&&this.isAttachment(e))try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size<this.exportOptions.maxSize){this.totalSize+=t.size;const a=this.getFilePath(e);this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(a,t)}}catch(e){Sa.a.log("Error fetching file: "+e)}const t=e.toJSON();return e.isEncrypted()?t.decrypted:t}async createOutput(e){for(let t=0;t<e.length;t++){const a=e[t];if(this.updateProgress(Object(N.a)("Processing event %(number)s out of %(total)s",{number:t+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();Object(Ps.c)(a,!1)&&this.messages.push(await this.getJSONString(a))}return this.createJSONString()}async export(){Sa.a.info("Starting export process..."),Sa.a.info("Fetching events...");const e=performance.now(),t=await this.getRequiredEvents(),a=performance.now();Sa.a.log(`Fetched ${t.length} events in ${(a-e)/1e3}s`),Sa.a.info("Creating output...");const n=await this.createOutput(t);if(this.files.length)this.addFile("export.json",new Blob([n])),await this.downloadZIP();else{const e=`matrix-export-${Object(vs.e)(new Date)}.json`;this.downloadPlainText(e,n)}const i=performance.now();this.cancelled?Sa.a.info("Export cancelled successfully"):(Sa.a.info("Export successful!"),Sa.a.log(`Exported ${t.length} events in ${(i-e)/1e3} seconds`)),this.cleanUp()}}var Ds=a(287);class As extends Ns.a{constructor(e,t,a,n){super(e,t,a,n),i()(this,"totalSize",void 0),i()(this,"mediaOmitText",void 0),i()(this,"textForReplyEvent",e=>{const t=/> <(.*?)>(.*?)\n\n(.*)/s.exec(e.body);if(!t)return e.body;let a;const n=t[1],i=t[3];a=t[2].substring(1);const s=a.split("\n").filter(e=>!/^\s*$/.test(e));return s.length>0?(a=s[0].substring(0,32),s[0].length>32&&(a+="..."),a=` "${a}"`):a="",`<${n}${a}> ${i}`}),i()(this,"plainTextForEvent",async e=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let a="";if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size>this.exportOptions.maxSize)a=` (${this.mediaOmitText})`;else{this.totalSize+=t.size;const n=this.getFilePath(e);a=" ("+Object(N.a)("File Attached")+")",this.addFile(n,t),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1)}}catch(e){a=" ("+Object(N.a)("Error fetching file")+")",Sa.a.log("Error fetching file "+e)}else a=` (${this.mediaOmitText})`;return this.isReply(e)?t+": "+this.textForReplyEvent(e.getContent())+a:Object(Ds.b)(e)+a}),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?Object(N.a)("Media omitted - file size limit exceeded"):Object(N.a)("Media omitted")}async createOutput(e){let t="";for(let a=0;a<e.length;a++){const n=e[a];if(this.updateProgress(Object(N.a)("Processing event %(number)s out of %(total)s",{number:a+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!Object(Ps.c)(n,!1))continue;const i=await this.plainTextForEvent(n);t+=i&&`${new Date(n.getTs()).toLocaleString()} - ${i}\n`}return t}async export(){this.updateProgress(Object(N.a)("Starting export process...")),this.updateProgress(Object(N.a)("Fetching events..."));const e=performance.now(),t=await this.getRequiredEvents(),a=performance.now();Sa.a.log(`Fetched ${t.length} events in ${(a-e)/1e3}s`),this.updateProgress(Object(N.a)("Creating output..."));const n=await this.createOutput(t);if(this.files.length)this.addFile("export.txt",new Blob([n])),await this.downloadZIP();else{const e=`matrix-export-${Object(vs.e)(new Date)}.txt`;this.downloadPlainText(e,n)}const i=performance.now();this.cancelled?Sa.a.info("Export cancelled successfully"):(Sa.a.info("Export successful!"),Sa.a.log(`Exported ${t.length} events in ${(i-e)/1e3} seconds`)),this.cleanUp()}}const Us=(e,t)=>{const[a,n]=Object(s.useState)(e);return[a,e=>{n(e),t(e)}]};var Ls=()=>({});const Fs=(e,t)=>a=>"number"==typeof a&&!(isNaN(a)||e>a||a>t);var Bs=e=>{let{room:t,onFinished:a}=e;const{exportFormat:n,exportType:i,includeAttachments:r,numberOfMessages:c,sizeLimit:l,setExportFormat:d,setExportType:m,setNumberOfMessages:h,setSizeLimit:u,setAttachments:p}=(()=>{var e,t,a,n,i;const o=Ls(),[r,c]=Object(s.useState)(null!==(e=o.format)&&void 0!==e?e:js.a.Html),[l,d]=Object(s.useState)(null!==(t=o.range)&&void 0!==t?t:js.b.Timeline),[m,h]=Object(s.useState)(null!==(a=o.includeAttachments)&&void 0!==a&&a),[u,p]=Object(s.useState)(null!==(n=o.numberOfMessages)&&void 0!==n?n:100),[g,b]=Object(s.useState)(null!==(i=o.sizeMb)&&void 0!==i?i:8);return{exportFormat:r,exportType:l,includeAttachments:m,numberOfMessages:u,sizeLimit:g,setExportFormat:o.format?void 0:c,setExportType:o.range?void 0:d,setNumberOfMessages:o.numberOfMessages?void 0:p,setSizeLimit:o.sizeMb?void 0:b,setAttachments:void 0===o.includeAttachments?h:void 0}})(),[g,b]=Object(s.useState)(!1),v=Object(s.useRef)(),f=Object(s.useRef)(),[E,y]=Object(s.useState)(Object(N.a)("Processing...")),[_,S]=Object(s.useState)(!1),[w,C]=Object(s.useState)(!1),[O,k]=Object(s.useState)(!1),[x,R]=Us(null,async e=>{await(null==e?void 0:e.export().then(()=>{w||k(!0)}))}),j=async()=>{if(!u||await v.current.validate({focused:!1})){if(i===js.b.LastNMessages){if(!await f.current.validate({focused:!1}))return void f.current.validate({focused:!0})}b(!0),await(async()=>{const e={numberOfMessages:c,attachmentsIncluded:r,maxSize:1024*l*1024};switch(n){case js.a.Html:R(new Ts.a(t,js.b[i],e,y));break;case js.a.Json:R(new Ms(t,js.b[i],e,y));break;case js.a.PlainText:R(new As(t,js.b[i],e,y));break;default:return void Sa.a.error("Unknown export format")}})()}else v.current.validate({focused:!0})},I=Object(Is.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(N.a)("Enter a number between %(min)s and %(max)s",{min:1,max:2e3})},{key:"number",test:e=>{let{value:t}=e;const a=parseInt(t,10);return Fs(1,2e3)(a)},invalid:()=>Object(N.a)("Size can only be a number between %(min)s MB and %(max)s MB",{min:1,max:2e3})}]}),T=async e=>await I(e),P=Object(Is.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(N.a)("Enter a number between %(min)s and %(max)s",{min:1,max:10**8})},{key:"number",test:e=>{let{value:t}=e;const a=parseInt(t,10);return Fs(1,10**8)(a)},invalid:()=>Object(N.a)("Number of messages can only be a number between %(min)s and %(max)s",{min:1,max:10**8})}]}),M=async e=>await P(e),D=async()=>{g?S(!0):a(!1)},A=async()=>{await(null==x?void 0:x.cancelExport()),C(!0),b(!1),R(null)},U=Object.keys(js.a).map(e=>({value:js.a[e],label:Object(js.c)(js.a[e])})),L=Object.keys(js.b).map(e=>o.a.createElement("option",{key:e,value:js.b[e]},Object(js.d)(js.b[e])));let F=null;i===js.b.LastNMessages&&h&&(F=o.a.createElement(_t.a,{id:"message-count",element:"input",type:"number",value:c.toString(),ref:f,onValidate:M,label:Object(N.a)("Number of messages"),onChange:e=>{h(parseInt(e.target.value))}}));const B=o.a.createElement("span",null,Object(N.a)("MB"));return w?o.a.createElement(wt.a,{title:Object(N.a)("Export Cancelled"),description:Object(N.a)("The export was cancelled successfully"),hasCloseButton:!0,onFinished:a}):O?o.a.createElement(wt.a,{title:Object(N.a)("Export Successful"),description:Object(N.a)("Your export was successful. Find it in your Downloads folder."),hasCloseButton:!0,onFinished:a}):_?o.a.createElement(Ra.a,{title:Object(N.a)("Warning"),className:"mx_ExportDialog",contentId:"mx_Dialog_content",onFinished:a,fixedWidth:!0},o.a.createElement("p",null,Object(N.a)("Are you sure you want to stop exporting your data? If you do, you'll need to start over.")),o.a.createElement(ja.a,{primaryButton:Object(N.a)("Stop"),primaryButtonClass:"danger",hasCancel:!0,cancelButton:Object(N.a)("Continue"),onCancel:()=>S(!1),onPrimaryButtonClick:A})):o.a.createElement(Ra.a,{title:g?Object(N.a)("Exporting your data"):Object(N.a)("Export Chat"),className:"mx_ExportDialog "+(g&&"mx_ExportDialog_Exporting"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:a,fixedWidth:!0},g?null:o.a.createElement("p",null,Object(N.a)("Select from the options below to export chats from your timeline")),o.a.createElement("div",{className:"mx_ExportDialog_options"},!!d&&o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"mx_ExportDialog_subheading"},Object(N.a)("Format")),o.a.createElement(Rs.a,{name:"exportFormat",value:n,onChange:e=>d(js.a[e]),definitions:U})),!!m&&o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"mx_ExportDialog_subheading"},Object(N.a)("Messages")),o.a.createElement(_t.a,{id:"export-type",element:"select",value:i,onChange:e=>{m(js.b[e.target.value])}},L),F),u&&o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"mx_ExportDialog_subheading"},Object(N.a)("Size Limit")),o.a.createElement(_t.a,{id:"size-limit",type:"number",autoComplete:"off",onValidate:T,element:"input",ref:v,value:l.toString(),postfixComponent:B,onChange:e=>u(parseInt(e.target.value))})),p&&o.a.createElement(o.a.Fragment,null,o.a.createElement(Ke.b,{className:"mx_ExportDialog_attachments-checkbox",id:"include-attachments",checked:r,onChange:e=>p(e.target.checked)},Object(N.a)("Include Attachments")))),g?o.a.createElement("div",{"data-test-id":"export-progress",className:"mx_ExportDialog_progress"},o.a.createElement(un.a,{w:24,h:24}),o.a.createElement("p",null,E),o.a.createElement(ja.a,{primaryButton:Object(N.a)("Cancel"),primaryButtonClass:"danger",hasCancel:!1,onPrimaryButtonClick:D})):o.a.createElement(ja.a,{primaryButton:Object(N.a)("Export"),onPrimaryButtonClick:j,onCancel:()=>a(!1)}))};const Vs=e=>{let{children:t,className:a,onClick:n}=e;return o.a.createElement(U.a,{className:l()("mx_BaseCard_Button mx_RoomSummaryCard_Button",a),onClick:n},t)},Ws=e=>{const[t,a]=Object(s.useState)(Ei.a.instance.getApps(e.roomId)),n=Object(s.useCallback)(()=>{a([...Ei.a.instance.getApps(e.roomId)])},[e]);return Object(s.useEffect)(n,[e,n]),Object(F.a)(Ei.a.instance,e.roomId,n),Object(F.a)(ei.d.instance,ei.d.emissionForRoom(e),n),t},Hs=e=>{let{app:t,room:a}=e;const n=sn.a.getWidgetName(t),i=sn.a.getWidgetDataTitle(t),r=i&&" - "+i,[c,d]=Object(s.useState)();Object(s.useEffect)(()=>{d(sn.a.canUserModifyWidgets(a.roomId))},[a.roomId]);const m=ei.d.instance.isInContainer(a,t,ei.a.Top),h=m?()=>{ei.d.instance.moveToContainer(a,t,ei.a.Right)}:()=>{ei.d.instance.moveToContainer(a,t,ei.a.Top)},[u,p,g,b]=Object(ve.q)();let v;if(u){const e=p.current.getBoundingClientRect();v=o.a.createElement(ii,{chevronFace:ve.a.None,right:de.b.instance.windowWidth-e.right,bottom:de.b.instance.windowHeight-e.top,onFinished:b,app:t})}const f=!m&&!ei.d.instance.canAddToContainer(a,ei.a.Top);let E;E=f?Object(N.a)("You can only pin up to %(count)s widgets",{count:ei.b}):m?Object(N.a)("Unpin"):Object(N.a)("Pin");const y=ei.d.instance.isInContainer(a,t,ei.a.Center),_=y?()=>{ei.d.instance.moveToContainer(a,t,ei.a.Right)}:()=>{ei.d.instance.moveToContainer(a,t,ei.a.Center)},S=y?Object(N.a)("Close"):Object(N.a)("Maximise");let w="";m?w=Object(N.a)("Unpin this widget to view it in this panel"):y&&(w=Object(N.a)("Close this widget to view it in this panel"));const C=l()("mx_BaseCard_Button mx_RoomSummaryCard_Button",{mx_RoomSummaryCard_Button_pinned:m,mx_RoomSummaryCard_Button_maximised:y});return o.a.createElement("div",{className:C,ref:p},o.a.createElement(oe.a,{className:"mx_RoomSummaryCard_icon_app",onClick:()=>{as.a.instance.pushCard({phase:ts.a.Widget,state:{widgetId:t.id}})},title:w,forceHide:!(m||y),disabled:m||y},o.a.createElement(ri,{app:t}),o.a.createElement("span",null,n),r),c&&o.a.createElement(ve.c,{className:"mx_RoomSummaryCard_app_options",isExpanded:u,onClick:g,title:Object(N.a)("Options")}),o.a.createElement(oe.a,{className:"mx_RoomSummaryCard_app_pinToggle",onClick:h,title:E,disabled:f}),o.a.createElement(oe.a,{className:"mx_RoomSummaryCard_app_maximiseToggle",onClick:_,title:S}),v)},zs=e=>{let{room:t}=e;const a=Ws(t);let n=null;return a.length>0&&ei.d.instance.canCopyLayoutToRoom(t)&&(n=o.a.createElement(U.a,{kind:"link",onClick:()=>ei.d.instance.copyLayoutToRoom(t)},Object(N.a)("Set my room layout for everyone"))),o.a.createElement(ss,{className:"mx_RoomSummaryCard_appsGroup",title:Object(N.a)("Widgets")},a.map(e=>o.a.createElement(Hs,{key:e.id,app:e,room:t})),n,o.a.createElement(U.a,{kind:"link",onClick:()=>{const e=Un.a.sharedInstance();e.hasManager()?e.getPrimaryManager().open(t):e.openNoManagerDialog()}},a.length>0?Object(N.a)("Edit widgets, bridges & bots"):Object(N.a)("Add widgets, bridges & bots")))},Ks=e=>{as.a.instance.pushCard({phase:ts.a.RoomMemberList},!0),W.b.trackInteraction("WebRightPanelRoomInfoPeopleButton",e)},qs=()=>{as.a.instance.pushCard({phase:ts.a.FilePanel},!0)},Gs=()=>{as.a.instance.pushCard({phase:ts.a.PinnedMessages},!0)},Ys=e=>{b.a.dispatch({action:"open_room_settings"}),W.b.trackInteraction("WebRightPanelRoomInfoSettingsButton",e)};var Js=e=>{var t;let{room:a,onClose:n}=e;const i=ns(Object(s.useContext)(j.a),a),r=Object(s.useContext)(Zn.b).e2eStatus,c=Object(be.a)("feature_video_rooms")&&a.isElementVideoRoom(),d=a.getCanonicalAlias()||a.getAltAliases()[0]||"",m=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_RoomSummaryCard_avatar",role:"presentation"},o.a.createElement(Ie.a,{room:a,height:54,width:54,viewAvatarOnClick:!0}),o.a.createElement(ln.a,{tooltip:i?Object(N.a)("Encrypted"):Object(N.a)("Not encrypted"),class:l()("mx_RoomSummaryCard_e2ee",{mx_RoomSummaryCard_e2ee_normal:i,mx_RoomSummaryCard_e2ee_warning:i&&r===ls.Warning,mx_RoomSummaryCard_e2ee_verified:i&&r===ls.Verified})})),o.a.createElement(xs.a,{room:a},e=>o.a.createElement("h2",{title:e},e)),o.a.createElement("div",{className:"mx_RoomSummaryCard_alias",title:d},d)),h=ds(a),u=Object(be.a)("feature_pinning"),p=null===(t=Cs(u&&a))||void 0===t?void 0:t.length;return o.a.createElement(os,{header:m,className:"mx_RoomSummaryCard",onClose:n},o.a.createElement(ss,{title:Object(N.a)("About"),className:"mx_RoomSummaryCard_aboutGroup"},o.a.createElement(Vs,{className:"mx_RoomSummaryCard_icon_people",onClick:Ks},Object(N.a)("People"),o.a.createElement("span",{className:"mx_BaseCard_Button_sublabel"},h)),!c&&o.a.createElement(Vs,{className:"mx_RoomSummaryCard_icon_files",onClick:qs},Object(N.a)("Files")),u&&!c&&o.a.createElement(Vs,{className:"mx_RoomSummaryCard_icon_pins",onClick:Gs},Object(N.a)("Pinned"),p>0&&o.a.createElement("span",{className:"mx_BaseCard_Button_sublabel"},p)),!c&&o.a.createElement(Vs,{className:"mx_RoomSummaryCard_icon_export",onClick:async()=>{gt.a.createTrackedDialog("export room dialog","",Bs,{room:a})}},Object(N.a)("Export chat")),o.a.createElement(Vs,{className:"mx_RoomSummaryCard_icon_share",onClick:()=>{gt.a.createTrackedDialog("share room dialog","",rs.a,{target:a})}},Object(N.a)("Share room")),o.a.createElement(Vs,{className:"mx_RoomSummaryCard_icon_settings",onClick:Ys},Object(N.a)("Room settings"))),v.b.getValue(Oe.b.Widgets)&&!c&&Object(Ce.a)(Oe.a.AddIntegrations)&&o.a.createElement(zs,{room:a}))};var $s=e=>{let{room:t,widgetId:a,onClose:n}=e;const i=Object(s.useContext)(j.a),r=Ws(t).find(e=>e.id===a),c=r&&ei.d.instance.isInContainer(t,r,ei.a.Right),[l,d,m,h]=Object(ve.q)();if(Object(s.useEffect)(()=>{r&&c||as.a.instance.popCard()},[r,c]),!r||!c)return null;let u;if(l){const e=d.current.getBoundingClientRect();u=o.a.createElement(ii,{chevronFace:ve.a.None,right:de.b.instance.windowWidth-e.right-12,top:e.bottom+12,onFinished:h,app:r})}const p=o.a.createElement(o.a.Fragment,null,o.a.createElement("h2",null,sn.a.getWidgetName(r)),o.a.createElement(ve.b,{kind:"secondary",className:"mx_WidgetCard_optionsButton",inputRef:d,onClick:m,isExpanded:l,label:Object(N.a)("Options")}),u);return o.a.createElement(os,{header:p,className:"mx_WidgetCard",onClose:n,withoutScrollContainer:!0},o.a.createElement(di,{app:r,fullWidth:!0,showMenubar:!1,room:t,userId:i.getUserId(),creatorUserId:r.creatorUserId,widgetPageTitle:sn.a.getWidgetDataTitle(r),waitForIframeLoad:r.waitForIframeLoad}))},Qs=a(200),Xs=a(193),Zs=a(496),eo=a(300),to=a(561),ao=a(809);class no extends o.a.Component{constructor(e){super(e),i()(this,"userLastModifiedTime",void 0),i()(this,"memberLastModifiedTime",void 0),i()(this,"onRoomStateEvents",e=>{if(e.getType()!==ge.b.RoomEncryption)return;const{roomId:t}=this.props.member;if(e.getRoomId()!==t)return;Et.a.get().removeListener(m.b.Events,this.onRoomStateEvents),this.setState({isRoomEncrypted:!0}),this.updateE2EStatus()}),i()(this,"onUserTrustStatusChanged",(e,t)=>{e===this.props.member.userId&&this.updateE2EStatus()}),i()(this,"onDeviceVerificationChanged",(e,t,a)=>{e===this.props.member.userId&&this.updateE2EStatus()}),i()(this,"onClick",()=>{b.a.dispatch({action:M.a.ViewUser,member:this.props.member,push:!0})}),this.state={isRoomEncrypted:!1,e2eStatus:null}}componentDidMount(){const e=Et.a.get(),{roomId:t}=this.props.member;if(t){const a=e.isRoomEncrypted(t);this.setState({isRoomEncrypted:a}),a?(e.on(Ni.b.UserTrustStatusChanged,this.onUserTrustStatusChanged),e.on(Ni.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),this.updateE2EStatus()):e.on(m.b.Events,this.onRoomStateEvents)}}componentWillUnmount(){const e=Et.a.get();e&&(e.removeListener(m.b.Events,this.onRoomStateEvents),e.removeListener(Ni.b.UserTrustStatusChanged,this.onUserTrustStatusChanged),e.removeListener(Ni.b.DeviceVerificationChanged,this.onDeviceVerificationChanged))}async updateE2EStatus(){const e=Et.a.get(),{userId:t}=this.props.member,a=t===e.getUserId(),n=e.checkUserTrust(t);if(!n.isCrossSigningVerified())return void this.setState({e2eStatus:n.wasCrossSigningVerified()?"warning":"normal"});const i=e.getStoredDevicesForUser(t).some(n=>{const{deviceId:i}=n,s=e.checkDeviceTrust(t,i);return a?!s.isCrossSigningVerified():!s.isVerified()});this.setState({e2eStatus:i?"warning":"verified"})}shouldComponentUpdate(e,t){return void 0===this.memberLastModifiedTime||this.memberLastModifiedTime<e.member.getLastModifiedTime()||(!(!e.member.user||!(void 0===this.userLastModifiedTime||this.userLastModifiedTime<e.member.user.getLastModifiedTime()))||(t.isRoomEncrypted!==this.state.isRoomEncrypted||t.e2eStatus!==this.state.e2eStatus))}getDisplayName(){return this.props.member.name}getPowerLabel(){return Object(N.a)("%(userName)s (power %(powerLevelNumber)s)",{userName:It.a.getDisplayUserIdentifier(this.props.member.userId,{roomId:this.props.member.roomId}),powerLevelNumber:this.props.member.powerLevel}).trim()}render(){const e=this.props.member,t=this.getDisplayName(),a=e.user?e.user.presence:null,n=o.a.createElement(Oa.a,{member:e,width:36,height:36,"aria-hidden":"true"});e.user&&(this.userLastModifiedTime=e.user.getLastModifiedTime()),this.memberLastModifiedTime=e.getLastModifiedTime();const i=new Map([[100,to.a.Admin],[50,to.a.Moderator]]);let s=this.props.member.powerLevel;for(const[e]of i)if(this.props.member.powerLevel>=e){s=e;break}const r=i.get(s);let c;this.state.isRoomEncrypted&&(c=this.state.e2eStatus);const l=o.a.createElement(ao.a,{member:e,fallbackName:t||""});return o.a.createElement(to.b,ue()({},this.props,{presenceState:a,presenceLastActiveAgo:e.user?e.user.lastActiveAgo:0,presenceLastTs:e.user?e.user.lastPresenceTs:0,presenceCurrentlyActive:!!e.user&&e.user.currentlyActive,avatarJsx:n,title:this.getPowerLabel(),name:t,nameJSX:l,powerStatus:r,showPresence:this.props.showPresence,e2eStatus:c,onClick:this.onClick}))}}i()(no,"defaultProps",{showPresence:!0});const io=/[\x21-\x2F\x3A-\x40\x5B-\x60\x7B-\x7E]+/g;class so extends o.a.Component{constructor(e){var t;super(e),i()(this,"showPresence",!0),i()(this,"mounted",!1),i()(this,"collator",void 0),i()(this,"sortNames",new Map),i()(this,"onUserPresenceChange",(e,t)=>{this.refs[t.userId]&&this.updateList()}),i()(this,"onRoom",e=>{e.roomId===this.props.roomId&&this.showMembersAccordingToMembershipWithLL()}),i()(this,"onMyMembership",(e,t,a)=>{e.roomId===this.props.roomId&&"join"===t&&this.showMembersAccordingToMembershipWithLL()}),i()(this,"onRoomStateUpdate",e=>{e.roomId===this.props.roomId&&this.updateList()}),i()(this,"onRoomMemberName",(e,t)=>{t.roomId===this.props.roomId&&this.updateList()}),i()(this,"onRoomStateEvent",e=>{e.getRoomId()===this.props.roomId&&e.getType()===ge.b.RoomThirdPartyInvite&&this.updateList(),this.canInvite!==this.state.canInvite&&this.setState({canInvite:this.canInvite})}),i()(this,"updateList",Object(x.throttle)(()=>{this.updateListNow()},500,{leading:!0,trailing:!0})),i()(this,"createOverflowTileJoined",(e,t)=>this.createOverflowTile(e,t,this.showMoreJoinedMemberList)),i()(this,"createOverflowTileInvited",(e,t)=>this.createOverflowTile(e,t,this.showMoreInvitedMemberList)),i()(this,"createOverflowTile",(e,t,n)=>{const i=Object(N.a)("and %(count)s others...",{count:e});return o.a.createElement(to.b,{className:"mx_EntityTile_ellipsis",avatarJsx:o.a.createElement(D.a,{url:a(812).default,name:"...",width:36,height:36}),name:i,presenceState:"online",suppressOnHover:!0,onClick:n})}),i()(this,"showMoreJoinedMemberList",()=>{this.setState({truncateAtJoined:this.state.truncateAtJoined+100})}),i()(this,"showMoreInvitedMemberList",()=>{this.setState({truncateAtInvited:this.state.truncateAtInvited+100})}),i()(this,"memberSort",(e,t)=>{const a=e.user,n=t.user;if(!a&&!n)return 0;if(a&&!n)return-1;if(!a&&n)return 1;if(this.showPresence){const e=e=>"unavailable"===e?"online":e,t=t=>{const a=["active","online","offline"],n=a.indexOf(e(t));return-1===n?a.length:n},i=t(a.currentlyActive?"active":a.presence),s=t(n.currentlyActive?"active":n.presence);if(i!==s)return i-s}return e.powerLevel!==t.powerLevel?t.powerLevel-e.powerLevel:this.showPresence&&a.getLastActiveTs()!==n.getLastActiveTs()?n.getLastActiveTs()-a.getLastActiveTs():this.collator.compare(this.sortNames.get(e),this.sortNames.get(t))}),i()(this,"onSearchQueryChanged",e=>{this.props.onSearchQueryChanged(e),this.setState({filteredJoinedMembers:this.filterMembers(this.state.members,"join",e),filteredInvitedMembers:this.filterMembers(this.state.members,"invite",e)})}),i()(this,"onPending3pidInviteClick",e=>{b.a.dispatch({action:"view_3pid_invite",event:e})}),i()(this,"getChildrenJoined",(e,t)=>this.makeMemberTiles(this.state.filteredJoinedMembers.slice(e,t))),i()(this,"getChildCountJoined",()=>this.state.filteredJoinedMembers.length),i()(this,"getChildrenInvited",(e,t)=>{let a=this.state.filteredInvitedMembers;return t>this.state.filteredInvitedMembers.length&&(a=a.concat(this.getPending3PidInvites())),this.makeMemberTiles(a.slice(e,t))}),i()(this,"getChildCountInvited",()=>this.state.filteredInvitedMembers.length+(this.getPending3PidInvites()||[]).length),i()(this,"onInviteButtonClick",e=>{W.b.trackInteraction("WebRightPanelMemberListInviteButton",e),Et.a.get().isGuest()?b.a.dispatch({action:"require_registration"}):b.a.dispatch({action:"view_invite",roomId:this.props.roomId})});const n=Et.a.get();n.hasLazyLoadMembersEnabled()?this.state=this.getMembersState([]):this.state=this.getMembersState(this.roomMembers()),n.on(r.b.Room,this.onRoom);const s=P.b.get("enable_presence_by_hs_url"),c=Et.a.get().baseUrl;this.showPresence=null===(t=null==s?void 0:s[c])||void 0===t||t}UNSAFE_componentWillMount(){const e=Et.a.get();this.mounted=!0,e.hasLazyLoadMembersEnabled()?(this.showMembersAccordingToMembershipWithLL(),e.on(pe.c.MyMembership,this.onMyMembership)):this.listenForMembersChanges()}listenForMembersChanges(){const e=Et.a.get();e.on(m.b.Update,this.onRoomStateUpdate),e.on(es.b.Name,this.onRoomMemberName),e.on(m.b.Events,this.onRoomStateEvent),e.on(Qs.b.LastPresenceTs,this.onUserPresenceChange),e.on(Qs.b.Presence,this.onUserPresenceChange),e.on(Qs.b.CurrentlyActive,this.onUserPresenceChange)}componentWillUnmount(){this.mounted=!1;const e=Et.a.get();e&&(e.removeListener(m.b.Update,this.onRoomStateUpdate),e.removeListener(es.b.Name,this.onRoomMemberName),e.removeListener(pe.c.MyMembership,this.onMyMembership),e.removeListener(m.b.Events,this.onRoomStateEvent),e.removeListener(r.b.Room,this.onRoom),e.removeListener(Qs.b.LastPresenceTs,this.onUserPresenceChange),e.removeListener(Qs.b.Presence,this.onUserPresenceChange),e.removeListener(Qs.b.CurrentlyActive,this.onUserPresenceChange)),this.updateList.cancel()}async showMembersAccordingToMembershipWithLL(){if(Et.a.get().hasLazyLoadMembersEnabled()){const e=Et.a.get().getRoom(this.props.roomId);if("join"===(e&&e.getMyMembership())){this.setState({loading:!0});try{await e.loadMembersIfNeeded()}catch(e){}this.mounted&&(this.setState(this.getMembersState(this.roomMembers())),this.listenForMembersChanges())}else this.setState(this.getMembersState(this.roomMembers()))}}get canInvite(){const e=Et.a.get(),t=e.getRoom(this.props.roomId);return(null==t?void 0:t.canInvite(e.getUserId()))||(null==t?void 0:t.isSpaceRoom())&&t.getJoinRule()===Pi.c.Public}getMembersState(e){return{loading:!1,members:e,filteredJoinedMembers:this.filterMembers(e,"join",this.props.searchQuery),filteredInvitedMembers:this.filterMembers(e,"invite",this.props.searchQuery),canInvite:this.canInvite,truncateAtJoined:30,truncateAtInvited:5}}updateListNow(){const e=this.roomMembers();this.setState({loading:!1,members:e,filteredJoinedMembers:this.filterMembers(e,"join",this.props.searchQuery),filteredInvitedMembers:this.filterMembers(e,"invite",this.props.searchQuery)})}getMembersWithUser(){if(!this.props.roomId)return[];const e=Et.a.get(),t=e.getRoom(this.props.roomId);if(!t)return[];const a=Object.values(t.currentState.members);return a.forEach(t=>{t.user||(t.user=e.getUser(t.userId)),this.sortNames.set(t,("@"===t.name[0]?t.name.slice(1):t.name).replace(io,""))}),a}roomMembers(){const e=this.getMembersWithUser().filter(e=>"join"===e.membership||"invite"===e.membership),t=v.b.getValue("language");return this.collator=new Intl.Collator(t,{sensitivity:"base",ignorePunctuation:!1}),e.sort(this.memberSort),e}memberString(e){if(e){const t=e.user;return"("+e.name+", "+e.powerLevel+", "+(t?t.lastActiveAgo:"<null>")+", "+(t?t.getLastActiveTs():"<null>")+", "+(t?t.currentlyActive:"<null>")+", "+(t?t.presence:"<null>")+")"}return"(null)"}filterMembers(e,t,a){return e.filter(e=>{if(a){a=a.toLowerCase();const t=-1!==e.name.toLowerCase().indexOf(a),n=-1!==e.userId.toLowerCase().indexOf(a);if(!t&&!n)return!1}return e.membership===t})}getPending3PidInvites(){const e=Et.a.get().getRoom(this.props.roomId);if(e)return e.currentState.getStateEvents("m.room.third_party_invite").filter((function(t){if(!Object(Xs.c)(t))return!1;return!e.currentState.getInviteForThreePidToken(t.getStateKey())}))}makeMemberTiles(e){return e.map(e=>e instanceof es.a?o.a.createElement(no,{key:e.userId,member:e,ref:e.userId,showPresence:this.showPresence}):o.a.createElement(to.b,{key:e.getStateKey(),name:e.getContent().display_name,suppressOnHover:!0,onClick:()=>this.onPending3pidInviteClick(e)}))}render(){if(this.state.loading)return o.a.createElement(os,{className:"mx_MemberList",onClose:this.props.onClose},o.a.createElement(un.a,null));const e=Et.a.get().getRoom(this.props.roomId);let t,a,n;if("join"===(null==e?void 0:e.getMyMembership())&&Object(Ce.a)(Oe.a.InviteUsers)){let a=Object(N.a)("Invite to this room");e.isSpaceRoom()&&(a=Object(N.a)("Invite to this space")),t=o.a.createElement(U.a,{className:"mx_MemberList_invite",onClick:this.onInviteButtonClick,disabled:!this.state.canInvite},o.a.createElement("span",null,a))}this.getChildCountInvited()>0&&(a=o.a.createElement("h2",null,Object(N.a)("Invited")),n=o.a.createElement(Zs.a,{className:"mx_MemberList_section mx_MemberList_invited",truncateAt:this.state.truncateAtInvited,createOverflowElement:this.createOverflowTileInvited,getChildren:this.getChildrenInvited,getChildCount:this.getChildCountInvited}));const i=o.a.createElement(eo.a,{className:"mx_MemberList_query mx_textinput_icon mx_textinput_search",placeholder:Object(N.a)("Filter room members"),onSearch:this.onSearchQueryChanged,initialValue:this.props.searchQuery});let s;return null!=e&&e.isSpaceRoom()&&(s=o.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},o.a.createElement(Ie.a,{room:e,height:32,width:32}),o.a.createElement(xs.a,{room:e}))),o.a.createElement(os,{className:"mx_MemberList",header:o.a.createElement(o.a.Fragment,null,s,t),footer:i,onClose:this.props.onClose},o.a.createElement("div",{className:"mx_MemberList_wrapper"},o.a.createElement(Zs.a,{className:"mx_MemberList_section mx_MemberList_joined",truncateAt:this.state.truncateAtJoined,createOverflowElement:this.createOverflowTileJoined,getChildren:this.getChildrenJoined,getChildCount:this.getChildCountJoined}),a,n))}}var oo=a(183),ro=a(579),co=a(269),lo=a(456),mo=a(577),ho=a(849),uo=a(359),po=a(798),go=a(811),bo=a(1454);class vo extends o.a.Component{constructor(e){super(e),i()(this,"onOk",e=>{e.preventDefault(),this.props.onFinished(!0,this.state.reason)}),i()(this,"onCancel",()=>{this.props.onFinished(!1)}),i()(this,"onReasonChange",e=>{this.setState({reason:e.target.value})}),this.state={reason:""}}render(){const e=this.props.danger?"danger":"";let t;this.props.askReason&&(t=o.a.createElement("form",{onSubmit:this.onOk},o.a.createElement(_t.a,{type:"text",onChange:this.onReasonChange,value:this.state.reason,className:"mx_ConfirmUserActionDialog_reasonField",label:Object(N.a)("Reason"),autoFocus:!0})));const a=o.a.createElement(Oa.a,{member:this.props.member,width:48,height:48}),n=this.props.member.name,i=this.props.member.userId,s=It.a.getDisplayUserIdentifier(i,{roomId:this.props.roomId,withDisplayName:!0});return o.a.createElement(Ra.a,{className:l()("mx_ConfirmUserActionDialog",this.props.className),onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content"},o.a.createElement("div",{id:"mx_Dialog_content",className:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_user"},o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_avatar"},a),o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_name"},n),o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_userId"},s)),t,this.props.children),o.a.createElement(ja.a,{primaryButton:this.props.action,onPrimaryButtonClick:this.onOk,primaryButtonClass:e,focus:!this.props.askReason,onCancel:this.onCancel}))}}i()(vo,"defaultProps",{danger:!1,askReason:!1});var fo=a(753);const Eo=["space","spaceChildFilter","allLabel","specificLabel","noneLabel","warningMessage","onFinished"];var yo=e=>{let{space:t,spaceChildFilter:a,allLabel:n,specificLabel:i,noneLabel:r,warningMessage:c,onFinished:l}=e,d=Ee()(e,Eo);const m=Object(s.useMemo)(()=>{const e=re.a.instance.getChildren(t.roomId);return a?e.filter(a):e},[t.roomId,a]),[h,u]=Object(s.useState)([]),p=Object(s.useMemo)(()=>new Set(h),[h]);let g;return c&&(g=o.a.createElement("div",{className:"mx_ConfirmSpaceUserActionDialog_warning"},c)),o.a.createElement(vo,ue()({},d,{onFinished:(e,t)=>{l(e,t,h)},className:"mx_ConfirmSpaceUserActionDialog",roomId:t.roomId}),g,o.a.createElement(fo.a,{space:t,spaceChildren:m,selected:p,allLabel:n,specificLabel:i,noneLabel:r,onChange:u}))},_o=a(301),So=a(264);const wo=["user","room","onClose","phase"];function Co(e){var t;let{userId:a,device:n}=e;const i=Object(s.useContext)(j.a),r=a===i.getUserId(),c=i.checkDeviceTrust(a,n.deviceId),d=i.checkUserTrust(a),m=r?c.isCrossSigningVerified():c.isVerified(),h=l()("mx_UserInfo_device",{mx_UserInfo_device_verified:m,mx_UserInfo_device_unverified:!m}),u=l()("mx_E2EIcon",{mx_E2EIcon_normal:!d.isVerified(),mx_E2EIcon_verified:m,mx_E2EIcon_warning:d.isVerified()&&!m}),p=()=>{Object(ho.c)(i.getUser(a),n)};let g;g=null!==(t=n.getDisplayName())&&void 0!==t&&t.trim()?n.ambiguous?n.getDisplayName()+" ("+n.deviceId+")":n.getDisplayName():n.deviceId;let b=null;return d.isVerified()&&(b=m?Object(N.a)("Trusted"):Object(N.a)("Not trusted")),m?o.a.createElement("div",{className:h,title:n.deviceId},o.a.createElement("div",{className:u}),o.a.createElement("div",{className:"mx_UserInfo_device_name"},g),o.a.createElement("div",{className:"mx_UserInfo_device_trusted"},b)):o.a.createElement(U.a,{className:h,title:n.deviceId,onClick:p},o.a.createElement("div",{className:u}),o.a.createElement("div",{className:"mx_UserInfo_device_name"},g),o.a.createElement("div",{className:"mx_UserInfo_device_trusted"},b))}function Oo(e){let{devices:t,userId:a,loading:n}=e;const i=Object(s.useContext)(j.a),r=i.checkUserTrust(a),[c,l]=Object(s.useState)(!1);if(n)return o.a.createElement(un.a,null);if(null===t)return o.a.createElement("p",null,Object(N.a)("Unable to load session list"));const d=a===i.getUserId(),m=t.map(e=>i.checkDeviceTrust(a,e.deviceId));let h=[];const u=[];let p,g,b,v="mx_E2EIcon";if(r.isVerified()){for(let e=0;e<t.length;++e){const a=t[e],n=m[e];(d?n.isCrossSigningVerified():n.isVerified())?h.push(a):u.push(a)}p=Object(N.a)("%(count)s verified sessions",{count:h.length}),g=Object(N.a)("Hide verified sessions"),v+=" mx_E2EIcon_verified"}else h=t,p=Object(N.a)("%(count)s sessions",{count:t.length}),g=Object(N.a)("Hide sessions"),v+=" mx_E2EIcon_normal";h.length&&(b=c?o.a.createElement(U.a,{kind:"link",className:"mx_UserInfo_expand",onClick:()=>l(!1)},o.a.createElement("div",null,g)):o.a.createElement(U.a,{kind:"link",className:"mx_UserInfo_expand",onClick:()=>l(!0)},o.a.createElement("div",{className:v}),o.a.createElement("div",null,p)));let f=u.map((e,t)=>o.a.createElement(Co,{key:t,userId:a,device:e}));if(c){const e=u.length;f=f.concat(h.map((t,n)=>o.a.createElement(Co,{key:n+e,userId:a,device:t})))}return o.a.createElement("div",{className:"mx_UserInfo_devices"},o.a.createElement("div",null,f),o.a.createElement("div",null,b))}const ko=e=>{let{userId:t}=e;const a=Object(s.useContext)(j.a),[n,i]=Object(s.useState)(!1);return o.a.createElement(U.a,{kind:"link",onClick:async e=>{n||(i(!0),await async function(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n=Object(_o.c)(e,t);if(n)return void b.a.dispatch({action:M.a.ViewRoom,room_id:n.roomId,metricsTrigger:"MessageUser",metricsViaKeyboard:a});const i={dmUserId:t,encryption:void 0};if(Object(So.c)()){const a=await e.downloadKeys([t]);Object.values(a).every(e=>Object.keys(e).length>0)&&(i.encryption=!0)}await Object(oo.b)(i)}(a,t,"click"!==e.type),i(!1))},className:"mx_UserInfo_field",disabled:n},Object(N.a)("Message"))},xo=e=>{let{member:t,isIgnored:a,canInvite:n,isSpace:i}=e;const r=Object(s.useContext)(j.a);let c=null,d=null,m=null,h=null;const u=t.userId===r.getUserId();if(!u){var p;const e=()=>{const e=r.getIgnoredUsers();if(a){const a=e.indexOf(t.userId);-1!==a&&e.splice(a,1)}else e.push(t.userId);r.setIgnoredUsers(e)};if(c=o.a.createElement(U.a,{kind:"link",onClick:e,className:l()("mx_UserInfo_field",{mx_UserInfo_destructive:!a})},a?Object(N.a)("Unignore"):Object(N.a)("Ignore")),t.roomId&&!i){const e=function(){const e=r.getRoom(t.roomId);b.a.dispatch({action:M.a.ViewRoom,highlighted:!0,event_id:e.getEventReadUpTo(t.userId),room_id:t.roomId,metricsTrigger:void 0})},a=function(){b.a.dispatch({action:M.a.ComposerInsert,userId:t.userId,timelineRenderingType:Zn.a.Room})},n=r.getRoom(t.roomId);null!=n&&n.getEventReadUpTo(t.userId)&&(h=o.a.createElement(U.a,{kind:"link",onClick:e,className:"mx_UserInfo_field"},Object(N.a)("Jump to read receipt"))),d=o.a.createElement(U.a,{kind:"link",onClick:a,className:"mx_UserInfo_field"},Object(N.a)("Mention"))}if(n&&"leave"===(null!==(p=null==t?void 0:t.membership)&&void 0!==p?p:"leave")&&Object(Ce.a)(Oe.a.InviteUsers)){const e=t&&t.roomId?t.roomId:vt.a.instance.getRoomId(),a=async a=>{try{const a=new ro.a(e);await a.invite([t.userId]).then(()=>{if("invited"!==a.getCompletionState(t.userId))throw new Error(a.getErrorText(t.userId))})}catch(e){gt.a.createTrackedDialog("Failed to invite","",Yn.a,{title:Object(N.a)("Failed to invite"),description:e&&e.message?e.message:Object(N.a)("Operation failed")})}W.b.trackInteraction("WebRightPanelRoomUserInfoInviteButton",a)};m=o.a.createElement(U.a,{kind:"link",onClick:a,className:"mx_UserInfo_field"},Object(N.a)("Invite"))}}const g=o.a.createElement(U.a,{kind:"link",onClick:()=>{gt.a.createTrackedDialog("share room member dialog","",rs.a,{target:t})},className:"mx_UserInfo_field"},Object(N.a)("Share Link to User"));let v;return u||(v=o.a.createElement(ko,{userId:t.userId})),o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(N.a)("Options")),o.a.createElement("div",null,v,h,g,d,m,c))},Ro=async e=>{const{finished:t}=gt.a.createTrackedDialog("Demoting Self","",yt.a,{title:Object(N.a)("Demote yourself?"),description:o.a.createElement("div",null,e?Object(N.a)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the space it will be impossible to regain privileges."):Object(N.a)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the room it will be impossible to regain privileges.")),button:Object(N.a)("Demote")}),[a]=await t;return a},jo=e=>{let{children:t}=e;return o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(N.a)("Admin Tools")),o.a.createElement("div",{className:"mx_UserInfo_buttons"},t))},Io=e=>{var t,a;return(null==e||null===(t=e.currentState)||void 0===t||null===(a=t.getStateEvents(ge.b.RoomPowerLevels,""))||void 0===a?void 0:a.getContent())||{}},To=e=>{let{room:t,member:a,startUpdating:n,stopUpdating:i}=e;const r=Object(s.useContext)(j.a);if("invite"!==a.membership&&"join"!==a.membership)return null;const c=t.isSpaceRoom()?"invite"===a.membership?Object(N.a)("Disinvite from space"):Object(N.a)("Remove from space"):"invite"===a.membership?Object(N.a)("Disinvite from room"):Object(N.a)("Remove from room");return o.a.createElement(U.a,{kind:"link",className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const{finished:e}=gt.a.createTrackedDialog("Confirm User Action Dialog","onKick",t.isSpaceRoom()?yo:vo,{member:a,action:t.isSpaceRoom()?"invite"===a.membership?Object(N.a)("Disinvite from space"):Object(N.a)("Remove from space"):"invite"===a.membership?Object(N.a)("Disinvite from room"):Object(N.a)("Remove from room"),title:"invite"===a.membership?Object(N.a)("Disinvite from %(roomName)s",{roomName:t.name}):Object(N.a)("Remove from %(roomName)s",{roomName:t.name}),askReason:"join"===a.membership,danger:!0,space:t,spaceChildFilter:e=>{const t=e.getMember(r.credentials.userId),n=e.getMember(a.userId);return t&&n&&n.membership===a.membership&&t.powerLevel>n.powerLevel&&e.currentState.hasSufficientPowerLevelFor("kick",t.powerLevel)},allLabel:Object(N.a)("Remove them from everything I'm able to"),specificLabel:Object(N.a)("Remove them from specific things I'm able to"),warningMessage:Object(N.a)("They'll still be able to access whatever you're not an admin of.")},t.isSpaceRoom()?"mx_ConfirmSpaceUserActionDialog_wrapper":void 0),[s,o,c=[]]=await e;s&&(n(),Object(_e.a)(t,c,e=>r.kick(e.roomId,a.userId,o||void 0)).then(()=>{Sa.a.log("Kick success")},(function(e){Sa.a.error("Kick error: "+e),gt.a.createTrackedDialog("Failed to kick","",Yn.a,{title:Object(N.a)("Failed to remove user"),description:e&&e.message?e.message:"Operation failed"})})).finally(()=>{i()}))}},c)},No=e=>{let{member:t}=e;const a=Object(s.useContext)(j.a);return o.a.createElement(U.a,{kind:"link",className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:()=>{const e=a.getRoom(t.roomId);e&&gt.a.createTrackedDialog("Bulk Redact Dialog","",bo.a,{matrixClient:a,room:e,member:t})}},Object(N.a)("Remove recent messages"))},Po=e=>{let{room:t,member:a,startUpdating:n,stopUpdating:i}=e;const r=Object(s.useContext)(j.a),c="ban"===a.membership;let d=t.isSpaceRoom()?Object(N.a)("Ban from space"):Object(N.a)("Ban from room");c&&(d=t.isSpaceRoom()?Object(N.a)("Unban from space"):Object(N.a)("Unban from room"));const m=l()("mx_UserInfo_field",{mx_UserInfo_destructive:!c});return o.a.createElement(U.a,{kind:"link",className:m,onClick:async()=>{const{finished:e}=gt.a.createTrackedDialog("Confirm User Action Dialog","onBanOrUnban",t.isSpaceRoom()?yo:vo,{member:a,action:t.isSpaceRoom()?c?Object(N.a)("Unban from space"):Object(N.a)("Ban from space"):c?Object(N.a)("Unban from room"):Object(N.a)("Ban from room"),title:c?Object(N.a)("Unban from %(roomName)s",{roomName:t.name}):Object(N.a)("Ban from %(roomName)s",{roomName:t.name}),askReason:!c,danger:!c,space:t,spaceChildFilter:c?e=>{const t=e.getMember(r.credentials.userId),n=e.getMember(a.userId);return t&&n&&"ban"===n.membership&&t.powerLevel>n.powerLevel&&e.currentState.hasSufficientPowerLevelFor("ban",t.powerLevel)}:e=>{const t=e.getMember(r.credentials.userId),n=e.getMember(a.userId);return t&&n&&"ban"!==n.membership&&t.powerLevel>n.powerLevel&&e.currentState.hasSufficientPowerLevelFor("ban",t.powerLevel)},allLabel:c?Object(N.a)("Unban them from everything I'm able to"):Object(N.a)("Ban them from everything I'm able to"),specificLabel:c?Object(N.a)("Unban them from specific things I'm able to"):Object(N.a)("Ban them from specific things I'm able to"),warningMessage:c?Object(N.a)("They won't be able to access whatever you're not an admin of."):Object(N.a)("They'll still be able to access whatever you're not an admin of.")},t.isSpaceRoom()?"mx_ConfirmSpaceUserActionDialog_wrapper":void 0),[s,o,l=[]]=await e;if(!s)return;n();Object(_e.a)(t,l,e=>{return t=e.roomId,c?r.unban(t,a.userId):r.ban(t,a.userId,o||void 0);var t}).then(()=>{Sa.a.log("Ban success")},(function(e){Sa.a.error("Ban error: "+e),gt.a.createTrackedDialog("Failed to ban user","",Yn.a,{title:Object(N.a)("Error"),description:Object(N.a)("Failed to ban user")})})).finally(()=>{i()})}},d)},Mo=e=>{let{member:t,room:a,powerLevels:n,startUpdating:i,stopUpdating:r}=e;const c=Object(s.useContext)(j.a);if("join"!==t.membership)return null;const d=((e,t)=>{if(!t||!e)return!1;const a=(t.events?t.events["m.room.message"]:null)||t.events_default;return e.powerLevel<a})(t,n),m=l()("mx_UserInfo_field",{mx_UserInfo_destructive:!d}),h=d?Object(N.a)("Unmute"):Object(N.a)("Mute");return o.a.createElement(U.a,{kind:"link",className:m,onClick:async()=>{const e=t.roomId,n=t.userId;if(n===c.getUserId())try{if(!await Ro(null==a?void 0:a.isSpaceRoom()))return}catch(e){return void Sa.a.error("Failed to warn about self demotion: ",e)}const s=a.currentState.getStateEvents("m.room.power_levels","");if(!s)return;const o=s.getContent(),l=(o.events?o.events["m.room.message"]:null)||o.events_default;let m;m=d?l:l-1,m=parseInt(m),isNaN(m)||(i(),c.setPowerLevel(e,n,m,s).then(()=>{Sa.a.log("Mute toggle success")},(function(e){Sa.a.error("Mute error: "+e),gt.a.createTrackedDialog("Failed to mute user","",Yn.a,{title:Object(N.a)("Error"),description:Object(N.a)("Failed to mute user")})})).finally(()=>{r()}))}},h)},Do=e=>{let{room:t,children:a,member:n,startUpdating:i,stopUpdating:r,powerLevels:c}=e;const l=Object(s.useContext)(j.a);let d,m,h,u;const p=(c.events?c.events["m.room.power_levels"]:null)||c.state_default,{ban:g=50,kick:b=50,redact:v=50}=c,f=t.getMember(l.getUserId());if(!f)return o.a.createElement("div",null);const E=f.userId===n.userId,y=n.powerLevel<f.powerLevel||E;return!E&&y&&f.powerLevel>=b&&(d=o.a.createElement(To,{room:t,member:n,startUpdating:i,stopUpdating:r})),f.powerLevel>=v&&!t.isSpaceRoom()&&(u=o.a.createElement(No,{member:n,startUpdating:i,stopUpdating:r})),!E&&y&&f.powerLevel>=g&&(m=o.a.createElement(Po,{room:t,member:n,startUpdating:i,stopUpdating:r})),!E&&y&&f.powerLevel>=p&&!t.isSpaceRoom()&&(h=o.a.createElement(Mo,{member:n,room:t,powerLevels:c,startUpdating:i,stopUpdating:r})),d||m||h||u||a?o.a.createElement(jo,null,h,d,m,u,a):o.a.createElement("div",null)};const Ao=e=>{let{user:t,room:a,roomPermissions:n,powerLevels:i}=e;if(n.canEdit)return o.a.createElement(Uo,{user:t,room:a,roomPermissions:n});{const e=i.users_default||0,a=t.powerLevel,n=Object(lo.b)(a,e);return o.a.createElement("div",{className:"mx_UserInfo_profileField"},o.a.createElement("div",{className:"mx_UserInfo_roleDescription"},n))}},Uo=e=>{let{user:t,room:a,roomPermissions:n}=e;const i=Object(s.useContext)(j.a),[r,c]=Object(s.useState)(t.powerLevel);Object(s.useEffect)(()=>{c(t.powerLevel)},[t]);const l=Object(s.useCallback)(async e=>{c(e);const n=t.roomId,s=t.userId,r=a.currentState.getStateEvents("m.room.power_levels","");if(!r)return;const l=i.getUserId(),d=r.getContent().users[l];if(d&&parseInt(d)<=e&&l!==s){const{finished:e}=gt.a.createTrackedDialog("Promote to PL100 Warning","",yt.a,{title:Object(N.a)("Warning!"),description:o.a.createElement("div",null,Object(N.a)("You will not be able to undo this change as you are promoting the user to have the same power level as yourself."),o.a.createElement("br",null),Object(N.a)("Are you sure?")),button:Object(N.a)("Continue")}),[t]=await e;if(!t)return}else if(l===s&&d&&parseInt(d)>e)try{if(!await Ro(null==a?void 0:a.isSpaceRoom()))return}catch(e){Sa.a.error("Failed to warn about self demotion: ",e)}await((e,t,a,n)=>i.setPowerLevel(e,t,parseInt(a),n).then((function(){Sa.a.log("Power change success")}),(function(e){Sa.a.error("Failed to change power level "+e),gt.a.createTrackedDialog("Failed to change power level","",Yn.a,{title:Object(N.a)("Error"),description:Object(N.a)("Failed to change power level")})})))(n,s,e,r)},[t.roomId,t.userId,i,a]),d=a.currentState.getStateEvents("m.room.power_levels",""),m=d?d.getContent().users_default:0;return o.a.createElement("div",{className:"mx_UserInfo_profileField"},o.a.createElement(po.a,{label:null,value:r,maxValue:n.modifyLevelMax,usersDefault:m,onChange:l}))},Lo=e=>{const t=Object(s.useContext)(j.a),[a,n]=Object(s.useState)(void 0);return Object(s.useEffect)(()=>{n(void 0);let a=!1;return async function(){try{await t.downloadKeys([e],!0);const i=t.getStoredDevicesForUser(e);if(a)return;(e=>{const t=Object.create(null);for(let a=0;a<e.length;a++){const n=e[a].getDisplayName(),i=t[n]||[];i.push(a),t[n]=i}for(const a in t)t[a].length>1&&t[a].forEach(t=>{e[t].ambiguous=!0})})(i),n(i)}catch(e){n(null)}}(),()=>{a=!0}},[t,e]),Object(s.useEffect)(()=>{let a=!1;const i=async()=>{const i=t.getStoredDevicesForUser(e);a||n(i)},s=t=>{t.includes(e)&&i()},o=(t,a)=>{t===e&&i()},r=(t,a)=>{t===e&&i()};return t.on(Ni.b.DevicesUpdated,s),t.on(Ni.b.DeviceVerificationChanged,o),t.on(Ni.b.UserTrustStatusChanged,r),()=>{a=!0,t.removeListener(Ni.b.DevicesUpdated,s),t.removeListener(Ni.b.DeviceVerificationChanged,o),t.removeListener(Ni.b.UserTrustStatusChanged,r)}},[t,e]),a},Fo=e=>{let{room:t,member:a,devices:n,isRoomEncrypted:i}=e;const c=Object(s.useContext)(j.a),l=((e,t)=>{const[a,n]=Object(s.useState)(Io(t)),i=Object(s.useCallback)(e=>{t&&(e&&e.getType()!==ge.b.RoomPowerLevels||n(Io(t)))},[t]);return Object(F.c)(e,m.b.Events,i),Object(s.useEffect)(()=>(i(),()=>{n({})}),[i]),a})(c,t),d=(e=>{const[t,a]=Object(s.useState)(!1);return Object(s.useEffect)(()=>{e.isSynapseAdministrator().then(e=>{a(e)},()=>{a(!1)})},[e]),t})(c),[h,u]=Object(s.useState)(c.isUserIgnored(a.userId));Object(s.useEffect)(()=>{u(c.isUserIgnored(a.userId))},[c,a.userId]);const p=Object(s.useCallback)(e=>{"m.ignored_user_list"===e.getType()&&u(c.isUserIgnored(a.userId))},[c,a.userId]);Object(F.c)(c,r.b.AccountData,p);const[g,v]=Object(s.useState)(0),f=Object(s.useCallback)(()=>{v(g+1)},[g]),E=Object(s.useCallback)(()=>{v(g-1)},[g]),y=function(e,t,a){const[n,i]=Object(s.useState)({modifyLevelMax:-1,canEdit:!1,canInvite:!1}),o=Object(s.useCallback)(()=>{var n,s;const o=null==t||null===(n=t.currentState.getStateEvents(ge.b.RoomPowerLevels,""))||void 0===n?void 0:n.getContent();if(!o)return;const r=t.getMember(e.getUserId());if(!r)return;const c=a,l=r.userId===c.userId;let d=-1;if(c.powerLevel<r.powerLevel||l){var m,h,u;const e=null!==(m=null!==(h=null===(u=o.events)||void 0===u?void 0:u[ge.b.RoomPowerLevels])&&void 0!==h?h:o.state_default)&&void 0!==m?m:50;r.powerLevel>=e&&(d=r.powerLevel)}i({canInvite:r.powerLevel>=(null!==(s=o.invite)&&void 0!==s?s:0),canEdit:d>=0,modifyLevelMax:d})},[e,a,t]);return Object(F.c)(e,m.b.Update,o),Object(s.useEffect)(()=>(o(),()=>{i({modifyLevelMax:-1,canEdit:!1,canInvite:!1})}),[o]),n}(c,t,a),_=Object(s.useCallback)(async()=>{const{finished:e}=gt.a.createTrackedDialog("Synapse User Deactivation","",yt.a,{title:Object(N.a)("Deactivate user?"),description:o.a.createElement("div",null,Object(N.a)("Deactivating this user will log them out and prevent them from logging back in. Additionally, they will leave all the rooms they are in. This action cannot be reversed. Are you sure you want to deactivate this user?")),button:Object(N.a)("Deactivate user"),danger:!0}),[t]=await e;if(t)try{await c.deactivateSynapseUser(a.userId)}catch(e){Sa.a.error("Failed to deactivate user"),Sa.a.error(e),gt.a.createTrackedDialog("Failed to deactivate Synapse user","",Yn.a,{title:Object(N.a)("Failed to deactivate user"),description:e&&e.message?e.message:Object(N.a)("Operation failed")})}},[c,a.userId]);let S,w,C,O;d&&a.userId.endsWith(":"+Et.a.getHomeserverName())&&(S=o.a.createElement(U.a,{kind:"link",className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:_},Object(N.a)("Deactivate user"))),t&&a.roomId?(cs.a.shared().getUserIdForRoomId(a.roomId)||(C=o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(N.a)("Role in <RoomName/>",{},{RoomName:()=>o.a.createElement("b",null,t.name)})),o.a.createElement(Ao,{powerLevels:l,user:a,room:t,roomPermissions:y}))),O=o.a.createElement(Do,{powerLevels:l,member:a,room:t,startUpdating:f,stopUpdating:E},S)):S&&(O=o.a.createElement(jo,null,S)),g>0&&(w=o.a.createElement(un.a,null));const k=c.isCryptoEnabled();let x,R;i?t.isSpaceRoom()||(x=Object(N.a)("Messages in this room are end-to-end encrypted.")):k?t&&!t.isSpaceRoom()&&(x=Object(N.a)("Messages in this room are not end-to-end encrypted.")):x=Object(N.a)("This client does not support end-to-end encryption.");const I=(e=>Object(ps.a)(async()=>e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),[e],!1))(c),T=k&&c.checkUserTrust(a.userId),P=k&&T.isCrossSigningVerified(),D=a.userId===c.getUserId(),A=k&&I&&!P&&!D&&n&&n.length>0,L=function(e,t,a,n){return Object(ps.a)(async()=>{if(a){n(!0);try{await e.downloadKeys([t.userId]);const a=e.getStoredCrossSigningForUser(t.userId);return!!(a&&a.getId())}finally{n(!1)}}},[e,t,a],void 0)}(c,a,A,e=>{v(t=>t+(e?1:-1))}),B=void 0===n;let V;A&&(void 0!==L?R=o.a.createElement("div",{className:"mx_UserInfo_container_verifyButton"},o.a.createElement(U.a,{kind:"link",className:"mx_UserInfo_field mx_UserInfo_verifyButton",onClick:()=>{L?Object(ho.d)(a):Object(ho.a)(a)}},Object(N.a)("Verify"))):B||(R=o.a.createElement(un.a,null))),a.userId==c.getUserId()&&(V=o.a.createElement("div",null,o.a.createElement(U.a,{kind:"link",className:"mx_UserInfo_field",onClick:()=>{b.a.dispatch({action:M.a.ViewUserSettings,initialTabId:Ge.a.Security})}},Object(N.a)("Edit devices"))));const W=o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(N.a)("Security")),o.a.createElement("p",null,x),R,k&&o.a.createElement(Oo,{loading:B,devices:n,userId:a.userId}),V);return o.a.createElement(o.a.Fragment,null,C,W,o.a.createElement(xo,{canInvite:y.canInvite,isIgnored:h,member:a,isSpace:null==t?void 0:t.isSpaceRoom()}),O,w)},Bo=e=>{let{member:t,e2eStatus:a,roomId:n}=e;const i=Object(s.useContext)(j.a),r=Object(s.useCallback)(()=>{const e=t.getMxcAvatarUrl?t.getMxcAvatarUrl():t.avatarUrl;if(!e)return;const a={src:Object(si.b)(e).srcHttp,name:t.name||t.displayName};gt.a.createDialog(uo.a,a,"mx_Dialog_lightbox",null,!0)},[t]),c=o.a.createElement("div",{className:"mx_UserInfo_avatar"},o.a.createElement("div",{className:"mx_UserInfo_avatar_transition"},o.a.createElement("div",{className:"mx_UserInfo_avatar_transition_child"},o.a.createElement(Oa.a,{key:t.userId,member:t,width:.6*de.b.instance.windowHeight,height:.6*de.b.instance.windowHeight,resizeMethod:"scale",fallbackUserId:t.userId,onClick:r,urls:t.avatarUrl?[t.avatarUrl]:void 0}))));let l,d,m;t instanceof es.a&&t.user&&(l=t.user.presence,d=t.user.lastActiveAgo,m=t.user.currentlyActive);const h=P.b.get("enable_presence_by_hs_url");let u=!0;h&&void 0!==h[i.baseUrl]&&(u=h[i.baseUrl]);let p,g=null;u&&(g=o.a.createElement(go.a,{activeAgo:d,currentlyActive:m,presenceState:l})),a&&(p=o.a.createElement(co.b,{size:18,status:a,isUser:!0}));const b=t.rawDisplayName;return o.a.createElement(o.a.Fragment,null,c,o.a.createElement("div",{className:"mx_UserInfo_container mx_UserInfo_separator"},o.a.createElement("div",{className:"mx_UserInfo_profile"},o.a.createElement("div",null,o.a.createElement("h2",null,p,o.a.createElement("span",{title:b,"aria-label":b,dir:"auto"},b))),o.a.createElement("div",null,It.a.getDisplayUserIdentifier(t.userId,{roomId:n,withDisplayName:!0})),o.a.createElement("div",{className:"mx_UserInfo_profileStatus"},g))))};var Vo=e=>{let{user:t,room:a,onClose:n,phase:i=ts.a.RoomMemberInfo}=e,r=Ee()(e,wo);const c=Object(s.useContext)(j.a),l=Object(s.useMemo)(()=>a&&a.getMember(t.userId)||t,[a,t]),d=ns(c,a),m=Lo(t.userId);let h;d&&m&&(h=((e,t,a)=>{const n=t===e.getUserId(),i=e.checkUserTrust(t);if(!i.isCrossSigningVerified())return i.wasCrossSigningVerified()?ls.Warning:ls.Normal;return a.some(a=>{const{deviceId:i}=a,s=e.checkDeviceTrust(t,i);return n?!s.isCrossSigningVerified():!s.isVerified()})?ls.Warning:ls.Verified})(c,t.userId,m));const u=["mx_UserInfo"];let p;a&&i===ts.a.EncryptionPanel?p={member:l}:null!=a&&a.isSpaceRoom()&&(p={spaceId:a.roomId});const g=()=>{as.a.instance.popCard()};let b;switch(i){case ts.a.RoomMemberInfo:case ts.a.SpaceMemberInfo:b=o.a.createElement(Fo,{room:a,member:l,devices:m,isRoomEncrypted:d});break;case ts.a.EncryptionPanel:u.push("mx_UserInfo_smallAvatar"),b=o.a.createElement(mo.a,ue()({},r,{member:l,onClose:g,isRoomEncrypted:d}))}let v,f=void 0;if(i===ts.a.EncryptionPanel){const e=r.verificationRequest;e&&e.pending&&(f=Object(N.a)("Cancel"))}null!=a&&a.isSpaceRoom()&&(v=o.a.createElement("div",{"data-test-id":"space-header",className:"mx_RightPanel_scopeHeader"},o.a.createElement(Ie.a,{room:a,height:32,width:32}),o.a.createElement(xs.a,{room:a})));const E=o.a.createElement(o.a.Fragment,null,v,o.a.createElement(Bo,{member:l,e2eStatus:h,roomId:null==a?void 0:a.roomId}));return o.a.createElement(os,{className:u.join(" "),header:E,onClose:n,closeLabel:f,cardState:p,onBack:e=>{as.a.instance.previousCard.phase===ts.a.RoomMemberList&&W.b.trackInteraction("WebRightPanelRoomUserInfoBackButton",e)}},b)};class Wo extends o.a.Component{constructor(e){super(e),i()(this,"room",void 0),i()(this,"onRoomStateEvents",e=>{if(e.getType()===ge.b.RoomThirdPartyInvite&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,a={invited:Object(Xs.c)(e)};t&&(a.displayName=t),this.setState(a)}}),i()(this,"onCancel",()=>{b.a.dispatch({action:"view_3pid_invite",event:null})}),i()(this,"onKickClick",()=>{Et.a.get().sendStateEvent(this.state.roomId,"m.room.third_party_invite",{},this.state.stateKey).catch(e=>{Sa.a.error(e),this.setState({invited:!0}),gt.a.createTrackedDialog("Revoke 3pid invite failed","",Yn.a,{title:Object(N.a)("Failed to revoke invite"),description:Object(N.a)("Could not revoke the invite. The server may be experiencing a temporary problem or you do not have sufficient permissions to revoke the invite.")})}),this.setState({invited:!1})}),this.room=Et.a.get().getRoom(this.props.event.getRoomId());const t=this.room.getMember(Et.a.get().getUserId()),a=this.room.currentState.getStateEvents("m.room.power_levels","");let n=a?a.getContent().kick:50;"number"!=typeof n&&(n=50);const s=this.room.getMember(this.props.event.getSender());this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!t&&t.powerLevel>n,senderName:s?s.name:this.props.event.getSender()}}componentDidMount(){Et.a.get().on(m.b.Events,this.onRoomStateEvents)}componentWillUnmount(){const e=Et.a.get();e&&e.removeListener(m.b.Events,this.onRoomStateEvents)}render(){let e,t=null;return this.state.canKick&&this.state.invited&&(t=o.a.createElement("div",{className:"mx_MemberInfo_container"},o.a.createElement("h3",null,Object(N.a)("Admin Tools")),o.a.createElement("div",{className:"mx_MemberInfo_buttons"},o.a.createElement(U.a,{className:"mx_MemberInfo_field",onClick:this.onKickClick},Object(N.a)("Revoke invite"))))),this.room.isSpaceRoom()&&(e=o.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},o.a.createElement(Ie.a,{room:this.room,height:32,width:32}),o.a.createElement(xs.a,{room:this.room}))),o.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},e,o.a.createElement("div",{className:"mx_MemberInfo_name"},o.a.createElement(U.a,{className:"mx_MemberInfo_cancel",onClick:this.onCancel,title:Object(N.a)("Close")}),o.a.createElement("h2",null,this.state.displayName)),o.a.createElement("div",{className:"mx_MemberInfo_container"},o.a.createElement("div",{className:"mx_MemberInfo_profile"},o.a.createElement("div",{className:"mx_MemberInfo_profileField"},Object(N.a)("Invited by %(sender)s",{sender:this.state.senderName})))),t)}}var Ho=a(273);let zo;function Ko(e){let{isRoomEncrypted:t,kind:a}=e;if(!t)return null;if(Li.a.get())return null;if(Li.a.error)return o.a.createElement("div",{className:"mx_SearchWarning"},Object(N.a)("Message search initialisation failed, check <a>your settings</a> for more information",{},{a:e=>o.a.createElement(U.a,{kind:"link_inline",onClick:e=>{e.preventDefault(),b.a.dispatch({action:M.a.ViewUserSettings,initialTabId:Ge.a.Security})}},e)}));const n=P.b.get("brand"),i=P.b.getObject("desktop_builds");let s=null,r=null;if(i.get("available")){r=o.a.createElement("img",{src:i.get("logo")});const e=i.get("url");switch(a){case zo.Files:s=Object(N.a)("Use the <a>Desktop app</a> to see all encrypted files",{},{a:t=>o.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)});break;case zo.Search:s=Object(N.a)("Use the <a>Desktop app</a> to search encrypted messages",{},{a:t=>o.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)})}}else switch(a){case zo.Files:s=Object(N.a)("This version of %(brand)s does not support viewing some encrypted files",{brand:n});break;case zo.Search:s=Object(N.a)("This version of %(brand)s does not support searching encrypted messages",{brand:n})}return s?o.a.createElement("div",{className:"mx_SearchWarning"},r,o.a.createElement("span",null,s)):(Sa.a.warn("Unknown desktop builds warning kind: ",a),null)}!function(e){e[e.Files=0]="Files",e[e.Search=1]="Search"}(zo||(zo={}));var qo=a(144),Go=a(444),Yo=a(285),Jo=a(549),$o=a(297),Qo=a(574),Xo=a(546);const Zo=function(){if(v.b.getValue("debug_timeline_panel")){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];Sa.a.log.call(console,"TimelinePanel debuglog:",...t)}};class er extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"lastRRSentEventId",void 0),i()(this,"lastRMSentEventId",void 0),i()(this,"messagePanel",Object(s.createRef)()),i()(this,"dispatcherRef",void 0),i()(this,"timelineWindow",void 0),i()(this,"unmounted",!1),i()(this,"readReceiptActivityTimer",void 0),i()(this,"readMarkerActivityTimer",void 0),i()(this,"callEventGroupers",new Map),i()(this,"onDumpDebugLogs",()=>{var e,t;const a=this.props.timelineSet.room,n=this.state.events.map(e=>e.getId());let i;const s=this.messagePanel.current;if(s){const e=ea.a.findDOMNode(s);if(e){i=[...e.querySelectorAll("[data-event-id]")].map(e=>e.getAttribute("data-event-id"))}}let o,r;const c={};if(a){const e=a.getTimelineSets(),t=a.threadsTimelineSets;o=tr(e),r=tr(t),a.getThreads().forEach(e=>{var t,a;c[e.id]={events:e.events.map(e=>e.getId()),numTimelines:e.timelineSet.getTimelines().length,liveTimeline:e.timelineSet.getLiveTimeline().getEvents().length,prevTimeline:null===(t=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(qo.a.Backward))||void 0===t?void 0:t.getEvents().length,nextTimeline:null===(a=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(qo.a.Forward))||void 0===a?void 0:a.getEvents().length}})}const l=this.timelineWindow.getEvents().map(e=>e.getId()),d=this.props.timelineSet.getPendingEvents().map(e=>e.getId());Sa.a.debug(`TimelinePanel(${this.context.timelineRenderingType}): Debugging info for ${null==a?void 0:a.roomId}\n\tevents(${n.length})=${JSON.stringify(n)}\n\trenderedEventIds(${null!==(e=null===(t=i)||void 0===t?void 0:t.length)&&void 0!==e?e:0})=`+JSON.stringify(i)+"\n"+`\tserializedEventIdsFromTimelineSets=${JSON.stringify(o)}\n\tserializedEventIdsFromThreadsTimelineSets=`+JSON.stringify(r)+"\n"+`\tserializedThreadsMap=${JSON.stringify(c)}\n`+`\ttimelineWindowEventIds(${l.length})=${JSON.stringify(l)}\n`+`\tpendingEvents(${d.length})=${JSON.stringify(d)}`)}),i()(this,"onMessageListUnfillRequest",(e,t)=>{const a=e?qo.b.BACKWARDS:qo.b.FORWARDS;Zo("unpaginating events in direction",a);const n=t,i=this.state.events.findIndex(e=>e.getId()===n),s=e?i+1:this.state.events.length-i;if(s>0){Zo("Unpaginating",s,"in direction",a),this.timelineWindow.unpaginate(s,e);const{events:t,liveEvents:n,firstVisibleEventIndex:i}=this.getEvents();this.buildCallEventGroupers(t);const o={events:t,liveEvents:n,firstVisibleEventIndex:i};e?o.canBackPaginate=!0:o.canForwardPaginate=!0,this.setState(o)}}),i()(this,"onPaginationRequest",(e,t,a)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,a):e.paginate(t,a)),i()(this,"onMessageListFillRequest",e=>{if(!this.shouldPaginate())return Promise.resolve(!1);const t=e?qo.b.BACKWARDS:qo.b.FORWARDS,a=e?"canBackPaginate":"canForwardPaginate",n=e?"backPaginating":"forwardPaginating";return this.state[a]?this.timelineWindow.canPaginate(t)?e&&0!==this.state.firstVisibleEventIndex?(Zo("won't",t,"paginate past first visible event"),Promise.resolve(!1)):(Zo("Initiating paginate; backwards:"+e),this.setState({[n]:!0}),this.onPaginationRequest(this.timelineWindow,t,20).then(t=>{if(this.unmounted)return;Zo("paginate complete backwards:"+e+"; success:"+t);const{events:i,liveEvents:s,firstVisibleEventIndex:o}=this.getEvents();this.buildCallEventGroupers(i);const r={[n]:!1,[a]:t,events:i,liveEvents:s,firstVisibleEventIndex:o},c=e?qo.b.FORWARDS:qo.b.BACKWARDS,l=e?"canForwardPaginate":"canBackPaginate";return!this.state[l]&&this.timelineWindow.canPaginate(c)&&(Zo("can now",c,"paginate again"),r[l]=!0),new Promise(a=>{this.setState(r,()=>{a(t&&(!e||0===o))})})})):(Zo("can't",t,"paginate any further"),this.setState({[a]:!1}),Promise.resolve(!1)):(Zo("have given up",t,"paginating this timeline"),Promise.resolve(!1))}),i()(this,"onMessageListScroll",e=>{var t,a;null===(t=(a=this.props).onScroll)||void 0===t||t.call(a,e),this.props.manageReadMarkers&&this.doManageReadMarkers()}),i()(this,"doManageReadMarkers",Object(x.debounce)(()=>{var e;const t=this.getReadMarkerPosition();t<0&&this.setState({readMarkerVisible:!0});const a=this.readMarkerTimeout(t);null===(e=this.readMarkerActivityTimer)||void 0===e||e.changeTimeout(a)},100,{leading:!1,trailing:!0})),i()(this,"onAction",e=>{switch(e.action){case"ignore_state_changed":this.forceUpdate();break;case M.a.DumpDebugLogs:this.onDumpDebugLogs()}}),i()(this,"onRoomTimeline",(e,t,a,n,i)=>{var s;i.timeline.getTimelineSet()===this.props.timelineSet&&(_n.d.hasServerSideSupport||this.context.timelineRenderingType!==Zn.a.Thread||(a&&!this.state.canBackPaginate&&this.setState({canBackPaginate:!0}),a||this.state.canForwardPaginate||this.setState({canForwardPaginate:!0})),!a&&i&&i.liveEvent&&null!==(s=this.messagePanel.current)&&void 0!==s&&s.getScrollState()&&(this.messagePanel.current.getScrollState().stuckAtBottom?this.timelineWindow.paginate(qo.b.FORWARDS,1,!1).then(()=>{if(this.unmounted)return;const{events:t,liveEvents:a,firstVisibleEventIndex:n}=this.getEvents();this.buildCallEventGroupers(t);const i=a[a.length-1],s={events:t,liveEvents:a,firstVisibleEventIndex:n};let o;if(this.props.manageReadMarkers){const t=Et.a.get().credentials.userId;o=!1,e.getSender()===t||Jo.a.sharedInstance().userActiveRecently()?i&&0===this.getReadMarkerPosition()&&(this.setReadMarker(i.getId(),i.getTs(),!0),s.readMarkerVisible=!1,s.readMarkerEventId=i.getId(),o=!0):s.readMarkerVisible=!0}this.setState(s,()=>{var e,t,a;(null===(e=this.messagePanel.current)||void 0===e||e.updateTimelineMinHeight(),o)&&(null===(t=(a=this.props).onReadMarkerUpdated)||void 0===t||t.call(a))})}):this.setState({canForwardPaginate:!0})))}),i()(this,"onRoomTimelineReset",(e,t)=>{t===this.props.timelineSet&&this.messagePanel.current&&this.messagePanel.current.isAtBottom()&&this.loadTimeline()}),i()(this,"canResetTimeline",()=>{var e;return null===(e=this.messagePanel)||void 0===e?void 0:e.current.isAtBottom()}),i()(this,"onRoomRedaction",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),i()(this,"onEventVisibilityChange",e=>{var t,a;if(this.unmounted)return;if(e.getRoomId()!==(null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId))return;const n=null===(a=this.messagePanel.current)||void 0===a?void 0:a.getTileForEventId(e.getId());n&&n.forceUpdate()}),i()(this,"onVisibilityPowerLevelChange",(e,t)=>{var a,n;if(!this.unmounted&&t.roomId===(null===(a=this.props.timelineSet.room)||void 0===a?void 0:a.roomId)&&t.userId==(null===(n=Et.a.get().credentials)||void 0===n?void 0:n.userId)){for(const e of this.state.events){var i;const t=null===(i=this.messagePanel.current)||void 0===i?void 0:i.getTileForEventId(e.getId());t&&t.forceUpdate()}this.forceUpdate()}}),i()(this,"onEventReplaced",e=>{this.unmounted||e.getRoomId()===this.props.timelineSet.room.roomId&&this.forceUpdate()}),i()(this,"onRoomReceipt",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),i()(this,"onLocalEchoUpdated",(e,t,a)=>{this.unmounted||t===this.props.timelineSet.room&&this.reloadEvents()}),i()(this,"onAccountData",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&e.getType()===ge.b.FullyRead&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)}),i()(this,"onEventDecrypted",e=>{this.props.timelineSet.room&&e.getRoomId()===this.props.timelineSet.room.roomId&&this.state.events.includes(e)&&(this.recheckFirstVisibleEventIndex(),this.buildCallEventGroupers(this.state.events),this.forceUpdate())}),i()(this,"onSync",(e,t,a)=>{this.unmounted||this.setState({clientSyncState:e})}),i()(this,"recheckFirstVisibleEventIndex",Object(x.throttle)(()=>{const e=this.checkForPreJoinUISI(this.state.events);e!==this.state.firstVisibleEventIndex&&this.setState({firstVisibleEventIndex:e})},500,{leading:!0,trailing:!0})),i()(this,"sendReadReceipt",()=>{if(v.b.getValue("lowBandwidth"))return;if(!this.messagePanel.current)return;if(!this.props.manageReadReceipts)return;const e=Et.a.get();if(!e||e.isGuest())return;let t=!0;const a=this.getCurrentReadReceipt(!0),n=this.indexForEventId(a);a&&null===n&&this.timelineWindow.canPaginate(qo.b.FORWARDS)&&(t=!1);const i=this.getLastDisplayedEventIndex({ignoreOwn:!0});null===i&&(t=!1);let s=this.state.events[i];t=t&&i>n&&this.lastRRSentEventId!=s.getId();const o=this.lastRMSentEventId!=this.state.readMarkerEventId;if(t||o){t?this.lastRRSentEventId=s.getId():s=null,this.lastRMSentEventId=this.state.readMarkerEventId;const e=this.props.timelineSet.room.roomId,a=v.b.getValue("feature_hidden_read_receipts",e);Zo("Sending Read Markers for ",this.props.timelineSet.room.roomId,"rm",this.state.readMarkerEventId,s?"rr "+s.getId():""," hidden:"+a),Et.a.get().setRoomReadMarkers(e,this.state.readMarkerEventId,a?null:s,s).catch(e=>{if("M_UNRECOGNIZED"===e.errcode&&s)return Et.a.get().sendReadReceipt(s,a?Yo.a.ReadPrivate:Yo.a.Read).catch(e=>{Sa.a.error(e),this.lastRRSentEventId=void 0});Sa.a.error(e),this.lastRRSentEventId=void 0,this.lastRMSentEventId=void 0}),this.isAtEndOfLiveTimeline()&&(this.props.timelineSet.room.setUnreadNotificationCount(pe.a.Total,0),this.props.timelineSet.room.setUnreadNotificationCount(pe.a.Highlight,0),b.a.dispatch({action:"on_room_read",roomId:this.props.timelineSet.room.roomId}))}}),i()(this,"updateReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this.getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];this.setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),this.sendReadReceipt()}),i()(this,"jumpToLiveTimeline",()=>{var e;this.timelineWindow.canPaginate(qo.b.FORWARDS)?this.loadTimeline():null===(e=this.messagePanel.current)||void 0===e||e.scrollToBottom()}),i()(this,"scrollToEventIfNeeded",e=>{var t;null===(t=this.messagePanel.current)||void 0===t||t.scrollToEventIfNeeded(e)}),i()(this,"jumpToReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(!this.messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this.messagePanel.current.getReadMarkerPosition()?this.loadTimeline(this.state.readMarkerEventId,0,1/3):this.messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)}),i()(this,"forgetReadMarker",()=>{if(!this.props.manageReadMarkers)return;const e=this.getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(e);let a;if(t){const n=t.getEvents().find(t=>t.getId()==e);n&&(a=n.getTs())}this.setReadMarker(e,a)}),i()(this,"isAtEndOfLiveTimeline",()=>{var e;return(null===(e=this.messagePanel.current)||void 0===e?void 0:e.isAtBottom())&&this.timelineWindow&&!this.timelineWindow.canPaginate(qo.b.FORWARDS)}),i()(this,"getScrollState",()=>this.messagePanel.current?this.messagePanel.current.getScrollState():null),i()(this,"getReadMarkerPosition",()=>{if(!this.props.manageReadMarkers)return null;if(!this.messagePanel.current)return null;const e=this.messagePanel.current.getReadMarkerPosition();if(null!==e)return e;const t=er.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return t&&this.state.events.length>0?t<this.state.events[0].getTs()?-1:1:null}),i()(this,"canJumpToReadMarker",()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(e<0||null===e)}),i()(this,"handleScrollKey",e=>{if(!this.messagePanel.current)return;Object(le.a)().getRoomAction(e)===Ue.h.JumpToLatestMessage?this.jumpToLiveTimeline():this.messagePanel.current.handleScrollKey(e)}),i()(this,"getRelationsForEvent",(e,t,a)=>this.props.timelineSet.getRelationsForEvent(e,t,a)),this.context=t,Zo("mounting");let a=null;if(this.props.manageReadMarkers){const e=this.props.timelineSet.room.getAccountData("m.fully_read");a=e?e.getContent().event_id:this.getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,firstVisibleEventIndex:0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:a,backPaginating:!1,forwardPaginating:!1,clientSyncState:Et.a.get().getSyncState(),isTwelveHour:v.b.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:v.b.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:v.b.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:v.b.getValue("readMarkerOutOfViewThresholdMs")},this.dispatcherRef=b.a.register(this.onAction);const n=Et.a.get();n.on(pe.c.Timeline,this.onRoomTimeline),n.on(pe.c.TimelineReset,this.onRoomTimelineReset),n.on(pe.c.Redaction,this.onRoomRedaction),v.b.getValue("feature_msc3531_hide_messages_pending_moderation")&&(n.on(yn.c.VisibilityChange,this.onEventVisibilityChange),n.on(es.b.PowerLevel,this.onVisibilityPowerLevelChange)),n.on(pe.c.RedactionCancelled,this.onRoomRedaction),n.on(pe.c.Receipt,this.onRoomReceipt),n.on(pe.c.LocalEchoUpdated,this.onLocalEchoUpdated),n.on(pe.c.AccountData,this.onAccountData),n.on(yn.c.Decrypted,this.onEventDecrypted),n.on(yn.c.Replaced,this.onEventReplaced),n.on(r.b.Sync,this.onSync)}UNSAFE_componentWillMount(){this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this.initTimeline(this.props)}UNSAFE_componentWillReceiveProps(e){e.timelineSet!==this.props.timelineSet&&Sa.a.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue");const t=e.eventId!=this.props.eventId,a=e.highlightedEventId!=this.props.highlightedEventId,n=e.eventScrollIntoView&&!this.props.eventScrollIntoView;if(t||a||n)return Sa.a.log("TimelinePanel switching to eventId "+e.eventId+" (was "+this.props.eventId+"), scrollIntoView: "+e.eventScrollIntoView+" (was "+this.props.eventScrollIntoView+")"),this.initTimeline(e)}componentWillUnmount(){this.unmounted=!0,this.readReceiptActivityTimer&&(this.readReceiptActivityTimer.abort(),this.readReceiptActivityTimer=null),this.readMarkerActivityTimer&&(this.readMarkerActivityTimer.abort(),this.readMarkerActivityTimer=null),b.a.unregister(this.dispatcherRef);const e=Et.a.get();e&&(e.removeListener(pe.c.Timeline,this.onRoomTimeline),e.removeListener(pe.c.TimelineReset,this.onRoomTimelineReset),e.removeListener(pe.c.Redaction,this.onRoomRedaction),e.removeListener(pe.c.RedactionCancelled,this.onRoomRedaction),e.removeListener(pe.c.Receipt,this.onRoomReceipt),e.removeListener(pe.c.LocalEchoUpdated,this.onLocalEchoUpdated),e.removeListener(pe.c.AccountData,this.onAccountData),e.removeListener(es.b.PowerLevel,this.onVisibilityPowerLevelChange),e.removeListener(yn.c.Decrypted,this.onEventDecrypted),e.removeListener(yn.c.Replaced,this.onEventReplaced),e.removeListener(yn.c.VisibilityChange,this.onEventVisibilityChange),e.removeListener(r.b.Sync,this.onSync))}readMarkerTimeout(e){var t,a,n,i;return 0===e?null!==(t=null===(a=this.context)||void 0===a?void 0:a.readMarkerInViewThresholdMs)&&void 0!==t?t:this.state.readMarkerInViewThresholdMs:null!==(n=null===(i=this.context)||void 0===i?void 0:i.readMarkerOutOfViewThresholdMs)&&void 0!==n?n:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this.readMarkerTimeout(this.getReadMarkerPosition());for(this.readMarkerActivityTimer=new $o.a(e);this.readMarkerActivityTimer;){Jo.a.sharedInstance().timeWhileActiveRecently(this.readMarkerActivityTimer);try{await this.readMarkerActivityTimer.finished()}catch(e){continue}this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this.readReceiptActivityTimer=new $o.a(500);this.readReceiptActivityTimer;){Jo.a.sharedInstance().timeWhileActiveNow(this.readReceiptActivityTimer);try{await this.readReceiptActivityTimer.finished()}catch(e){continue}this.sendReadReceipt()}}advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers)return;const e=this.timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const a=Et.a.get().credentials.userId;for(t++;t<e.length;t++){if(e[t].getSender()!==a)break}t--;const n=e[t];this.setReadMarker(n.getId(),n.getTs())}initTimeline(e){const t=e.eventId,a=e.eventPixelOffset;let n=1;return null==a&&(n=.5),this.loadTimeline(t,a,n,e.eventScrollIntoView)}scrollIntoView(e,t,a){var n,i;const s=()=>{this.messagePanel.current&&(e?(Zo("TimelinePanel scrolling to eventId "+e+" at position "+100*a+"% + "+t),this.messagePanel.current.scrollToEvent(e,t,a)):(Zo("TimelinePanel scrolling to bottom"),this.messagePanel.current.scrollToBottom()))};Zo("TimelinePanel scheduling scroll to event"),null===(n=(i=this.props).onEventScrolledIntoView)||void 0===n||n.call(i,e),s(),window.requestAnimationFrame(()=>{s()})}loadTimeline(e,t,a){let n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const i=Et.a.get();this.timelineWindow=new Go.b(i,this.props.timelineSet,{windowLimit:this.props.timelineCap});const s=()=>{var i;this.unmounted||(null===(i=this.messagePanel.current)||void 0===i||i.onTimelineReset(),this.reloadEvents(),this.advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:this.timelineWindow.canPaginate(qo.b.BACKWARDS),canForwardPaginate:this.timelineWindow.canPaginate(qo.b.FORWARDS),timelineLoading:!1},()=>{this.messagePanel.current?(n&&this.scrollIntoView(e,t,a),this.props.sendReadReceiptOnLoad&&this.sendReadReceipt()):Sa.a.log("can't initialise scroll state because messagePanel didn't load")}))},o=t=>{var a;if(this.unmounted)return;let n,i;this.setState({timelineLoading:!1}),Sa.a.error(`Error loading timeline panel at ${null===(a=this.props.timelineSet.room)||void 0===a?void 0:a.roomId}/${e}: ${t}`),e&&(n=()=>{b.a.dispatch({action:M.a.ViewRoom,room_id:this.props.timelineSet.room.roomId,metricsTrigger:void 0})}),i="M_FORBIDDEN"==t.errcode?Object(N.a)("Tried to load a specific point in this room's timeline, but you do not have permission to view the message in question."):Object(N.a)("Tried to load a specific point in this room's timeline, but was unable to find it."),gt.a.createTrackedDialog("Failed to load timeline position","",Yn.a,{title:Object(N.a)("Failed to load timeline position"),description:i,onFinished:n})};if(this.props.timelineSet.getTimelineForEvent(e))this.timelineWindow.load(e,20),s();else{const t=this.timelineWindow.load(e,20);this.buildCallEventGroupers(),this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),t.then(s,o)}}reloadEvents(){if(this.unmounted)return;const e=this.getEvents();this.buildCallEventGroupers(e.events),this.setState(e)}refreshTimeline(){this.loadTimeline(),this.reloadEvents()}getEvents(){const e=this.timelineWindow.getEvents();Object(Sn.b)(e).reverse().forEach(e=>{Et.a.get().decryptEventIfNeeded(e)});const t=this.checkForPreJoinUISI(e),a=[...e];if(!this.timelineWindow.canPaginate(qo.b.FORWARDS)){const t=this.props.timelineSet.getPendingEvents();this.context.timelineRenderingType===Zn.a.Thread?e.push(...t.filter(e=>e.threadRootId===this.context.threadId)):e.push(...t.filter(e=>{if(!e.getRelation())return!0;if(e.isThreadRelation)return!1;const t=this.props.timelineSet.findEventById(e.getAssociatedId());return!!t&&!t.isThreadRelation}))}return{events:e,liveEvents:a,firstVisibleEventIndex:t}}checkForPreJoinUISI(e){const t=Et.a.get(),a=this.props.timelineSet.room,n=[Zn.a.Thread,Zn.a.ThreadsList].includes(this.context.timelineRenderingType);if(0===e.length||!a||!t.isRoomEncrypted(a.roomId)||n)return Sa.a.info("checkForPreJoinUISI: showing all messages, skipping check"),0;const i=t.credentials.userId;let s=e.length-1,o="leave";for(;s>=0;s--){var r,c;const t=a.getTimelineForEvent(e[s].getId());if(!t){Sa.a.warn(`Event ${e[s].getId()} in room ${a.roomId} is live, but it does not have a timeline`);continue}o=null!==(r=null===(c=t.getState(qo.b.FORWARDS).getMember(i))||void 0===c?void 0:c.membership)&&void 0!==r?r:"leave";const n=t.getEvents();for(let t=n.length-1;t>=0;t--){const a=n[t];if(a.getId()===e[s].getId())break;a.getStateKey()===i&&a.getType()===ge.b.RoomMember&&(o=a.getPrevContent().membership||"leave")}break}for(;s>=0;s--){const t=e[s];if(t.getStateKey()===i&&t.getType()===ge.b.RoomMember)o=t.getPrevContent().membership||"leave";else if("leave"===o&&(t.isDecryptionFailure()||t.isBeingDecrypted()))return Sa.a.info("checkForPreJoinUISI: reached a pre-join UISI at index ",s),s+1}return Sa.a.info("checkForPreJoinUISI: did not find pre-join UISI"),0}indexForEventId(e){const t=this.context.timelineRenderingType===Zn.a.Thread;if(v.b.getValue("feature_thread")&&t)return 0;const a=this.state.events.findIndex(t=>t.getId()===e);return a>-1?a:null}getLastDisplayedEventIndex(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=e.ignoreOwn||!1,a=e.allowPartial||!1,n=this.messagePanel.current;if(!n)return null;const i=ea.a.findDOMNode(n);if(!i)return null;const s=i.getBoundingClientRect(),o=Et.a.get().credentials.userId,r=e=>{if(e){const t=e.getBoundingClientRect();if(a&&t.top<s.bottom||!a&&t.bottom<s.bottom)return!0}return!1};let c=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){var l;const a=this.state.liveEvents[e],i=n.getNodeForEventId(a.getId()),s=r(i);if(s&&0!==c)return e+c;i&&!s&&(c=0);const d=!!a.status||t&&a.getSender()===o;if(!(!Object(Ps.c)(a,null===(l=this.context)||void 0===l?void 0:l.showHiddenEvents)||Object(Mi.a)(a,this.context))&&i){if(!d&&s)return e}else(!d||d&&0!==c)&&++c}return null}getCurrentReadReceipt(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=Et.a.get();if(null==t)return null;const a=t.credentials.userId;return this.props.timelineSet.room.getEventReadUpTo(a,e)}setReadMarker(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n=this.props.timelineSet.room.roomId;e!==this.state.readMarkerEventId&&(er.roomReadMarkerTsMap[n]=t,a||this.setState({readMarkerEventId:e},this.props.onReadMarkerUpdated))}shouldPaginate(){return!this.state.events.some(e=>e.isBeingDecrypted())}buildCallEventGroupers(e){this.callEventGroupers=Object(Xo.c)(this.callEventGroupers,e)}render(){var e,t,a,n,i;if(this.state.timelineLoading)return o.a.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},o.a.createElement(un.a,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return o.a.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},o.a.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const s=!this.timelineWindow.canPaginate(qo.b.FORWARDS),r=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),c=this.state.firstVisibleEventIndex?this.state.events.slice(this.state.firstVisibleEventIndex):this.state.events;return o.a.createElement(Qo.a,{ref:this.messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:r,events:c,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,canBackPaginate:this.state.canBackPaginate&&0===this.state.firstVisibleEventIndex,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:Et.a.get().credentials.userId,stickyBottom:s,onScroll:this.onMessageListScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:null!==(e=null===(t=this.context)||void 0===t?void 0:t.showTwelveHourTimestamps)&&void 0!==e?e:this.state.isTwelveHour,alwaysShowTimestamps:null!==(a=null!==(n=this.props.alwaysShowTimestamps)&&void 0!==n?n:null===(i=this.context)||void 0===i?void 0:i.alwaysShowTimestamps)&&void 0!==a?a:this.state.alwaysShowTimestamps,className:this.props.className,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.props.editState,showReactions:this.props.showReactions,layout:this.props.layout,hideThreadedMessages:this.props.hideThreadedMessages,disableGrouping:this.props.disableGrouping,callEventGroupers:this.callEventGroupers})}}function tr(e){return e.map(e=>{const t={},a=e.getTimelines(),n=e.getLiveTimeline();return a.forEach((e,a)=>{t[e===n?"liveTimeline":""+a]=e.getEvents().map(e=>e.getId())}),t})}i()(er,"contextType",Zn.b),i()(er,"roomReadMarkerTsMap",{}),i()(er,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel",sendReadReceiptOnLoad:!0,hideThreadedMessages:!0,disableGrouping:!1});var ar=er,nr=a(157);class ir extends o.a.PureComponent{constructor(e){super(e),i()(this,"instanceId",void 0),i()(this,"onResize",(e,t)=>{e===de.a.Resize&&this.props.onMeasurement(t.contentRect.width<=this.props.breakpoint)}),this.instanceId=ir.instanceCount++}componentDidMount(){de.b.instance.on("Measured"+this.instanceId,this.onResize)}componentDidUpdate(e){const t=e.sensor,a=this.props.sensor;t!==a&&(t&&de.b.instance.stopTrackingElementDimensions("Measured"+this.instanceId),a&&de.b.instance.trackElementDimensions("Measured"+this.instanceId,this.props.sensor))}componentWillUnmount(){de.b.instance.off("Measured"+this.instanceId,this.onResize),de.b.instance.stopTrackingElementDimensions("Measured"+this.instanceId)}render(){return null}}function sr(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function or(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?sr(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):sr(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}i()(ir,"instanceCount",0),i()(ir,"defaultProps",{breakpoint:500});class rr extends o.a.Component{constructor(){super(...arguments),i()(this,"decryptingEvents",new Set),i()(this,"noRoom",void 0),i()(this,"card",Object(s.createRef)()),i()(this,"state",{timelineSet:null,narrow:!1}),i()(this,"onRoomTimeline",(e,t,a,n,i)=>{var s;if((null==t?void 0:t.roomId)!==(null===(s=this.props)||void 0===s?void 0:s.roomId))return;if(a||!i||!i.liveEvent||e.isRedacted())return;Et.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e)}),i()(this,"onEventDecrypted",(e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const a=e.getId();this.decryptingEvents.delete(a)&&(t||this.addEncryptedLiveEvent(e))}),i()(this,"onPaginationRequest",(e,t,a)=>{const n=Et.a.get(),i=Li.a.get(),s=this.props.roomId,o=n.getRoom(s);return n.isRoomEncrypted(s)&&null!==i?i.paginateTimelineWindow(o,e,t,a):e.paginate(t,a)}),i()(this,"onMeasurement",e=>{this.setState({narrow:e})})}addEncryptedLiveEvent(e){if(!this.state.timelineSet)return;const t=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&-1!=["m.file","m.image","m.video","m.audio"].indexOf(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,t,!1))}async componentDidMount(){const e=Et.a.get();await this.updateTimelineSet(this.props.roomId),Et.a.get().isRoomEncrypted(this.props.roomId)&&null!==Li.a.get()&&(e.on(pe.c.Timeline,this.onRoomTimeline),e.on(yn.c.Decrypted,this.onEventDecrypted))}componentWillUnmount(){const e=Et.a.get();null!==e&&Et.a.get().isRoomEncrypted(this.props.roomId)&&null!==Li.a.get()&&(e.removeListener(pe.c.Timeline,this.onRoomTimeline),e.removeListener(yn.c.Decrypted,this.onEventDecrypted))}async fetchFileEventsServer(e){const t=Et.a.get(),a=new Ho.a(t.credentials.userId);a.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}});const n=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,a);a.filterId=n;return e.getOrCreateFilteredTimelineSet(a)}async updateTimelineSet(e){const t=Et.a.get(),a=t.getRoom(e),n=Li.a.get();if(this.noRoom=!a,a){let i;try{if(i=await this.fetchFileEventsServer(a),t.isRoomEncrypted(e)&&null!==n){const e=i.getLiveTimeline();await n.populateFileTimeline(i,e,a,10)}this.setState({timelineSet:i})}catch(e){Sa.a.error("Failed to get or create file panel filter",e)}}else Sa.a.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(Et.a.get().isGuest())return o.a.createElement(os,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose},o.a.createElement("div",{className:"mx_RoomView_empty"},Object(N.a)("You must <a>register</a> to use this functionality",{},{a:e=>o.a.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return o.a.createElement(os,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose},o.a.createElement("div",{className:"mx_RoomView_empty"},Object(N.a)("You must join the room to see its files")));const e=o.a.createElement("div",{className:"mx_RightPanel_empty mx_FilePanel_empty"},o.a.createElement("h2",null,Object(N.a)("No files visible in this room")),o.a.createElement("p",null,Object(N.a)("Attach files from chat or just drag and drop them anywhere in a room."))),t=!this.noRoom&&Et.a.get().isRoomEncrypted(this.props.roomId);return this.state.timelineSet?o.a.createElement(Zn.b.Provider,{value:or(or({},this.context),{},{timelineRenderingType:Zn.a.File,narrow:this.state.narrow})},o.a.createElement(os,{className:"mx_FilePanel",onClose:this.props.onClose,withoutScrollContainer:!0,ref:this.card},o.a.createElement(ir,{sensor:this.card.current,onMeasurement:this.onMeasurement}),o.a.createElement(Ko,{isRoomEncrypted:t,kind:zo.Files}),o.a.createElement(ar,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,resizeNotifier:this.props.resizeNotifier,empty:e,layout:nr.a.Group}))):o.a.createElement(Zn.b.Provider,{value:or(or({},this.context),{},{timelineRenderingType:Zn.a.File})},o.a.createElement(os,{className:"mx_FilePanel",onClose:this.props.onClose},o.a.createElement(un.a,null)))}}i()(rr,"contextType",Zn.b);var cr=rr;class lr extends o.a.Component{constructor(e){super(e),i()(this,"resize",()=>{this.props.onResize&&this.props.onResize()})}componentDidMount(){window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}render(){return o.a.createElement("div",null,this.props.element)}}class dr extends o.a.PureComponent{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"prevSentVisibility",void 0),i()(this,"popoverWidth",300),i()(this,"popoverHeight",300),i()(this,"scalarClient",null),i()(this,"removeStickerpickerWidgets",async()=>{const e=await this.acquireScalarClient();Sa.a.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(fn.a.STICKERPICKER,this.state.widgetId).then(()=>{Sa.a.log("Assets disabled")}).catch(()=>{Sa.a.error("Failed to disable assets")}):Sa.a.error("Cannot disable assets: no scalar client"):Sa.a.warn("No widget ID specified, not disabling assets"),this.props.setStickerPickerOpen(!1),sn.a.removeStickerpickerWidgets().then(()=>{this.forceUpdate()}).catch(e=>{Sa.a.error("Failed to remove sticker picker widget",e)})}),i()(this,"updateWidget",()=>{const e=sn.a.getStickerpickerWidgets()[0];if(!e)return dr.currentWidget=null,void this.setState({stickerpickerWidget:null,widgetId:null});const t=dr.currentWidget;let a=null;t&&t.content&&t.content.url&&(a=t.content.url);let n=null;e&&e.content&&e.content.url&&(n=e.content.url),n!==a&&vn.destroyElement("stickerPicker"),dr.currentWidget=e,this.setState({stickerpickerWidget:e,widgetId:e?e.id:null})}),i()(this,"onAction",e=>{switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":this.props.setStickerPickerOpen(!1);break;case"show_left_panel":case"hide_left_panel":this.props.setStickerPickerOpen(!1)}}),i()(this,"onRightPanelStoreUpdate",()=>{this.props.setStickerPickerOpen(!1)}),i()(this,"onResize",()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)}),i()(this,"onFinished",()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)}),i()(this,"launchManageIntegrations",()=>{Un.a.sharedInstance().getPrimaryManager().open(this.props.room,"type_"+fn.a.STICKERPICKER.preferred,this.state.widgetId)}),this.state={imError:null,stickerpickerWidget:null,widgetId:null}}acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):Un.a.sharedInstance().hasManager()?(this.scalarClient=Un.a.sharedInstance().getPrimaryManager().getScalarClient(),this.scalarClient.connect().then(()=>(this.forceUpdate(),this.scalarClient)).catch(e=>{this.imError(Object(N.c)("Failed to connect to integration manager"),e)})):void Un.a.sharedInstance().openNoManagerDialog()}componentDidMount(){window.addEventListener("resize",this.onResize),this.dispatcherRef=b.a.register(this.onAction),Et.a.get().on(pe.c.AccountData,this.updateWidget),as.a.instance.on(L.b,this.onRightPanelStoreUpdate),this.updateWidget()}componentWillUnmount(){const e=Et.a.get();e&&e.removeListener(pe.c.AccountData,this.updateWidget),as.a.instance.off(L.b,this.onRightPanelStoreUpdate),window.removeEventListener("resize",this.onResize),this.dispatcherRef&&b.a.unregister(this.dispatcherRef)}componentDidUpdate(){this.sendVisibilityToWidget(this.props.isStickerPickerOpen)}imError(e,t){Sa.a.error(e,t),this.setState({imError:Object(N.a)(e)}),this.props.setStickerPickerOpen(!1)}defaultStickerpickerContent(){return o.a.createElement(U.a,{onClick:this.launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},o.a.createElement("p",null,Object(N.a)("You don't currently have any stickerpacks enabled")),o.a.createElement("p",{className:"mx_Stickers_addLink"},Object(N.a)("Add some now")),o.a.createElement("img",{src:a(1455),alt:""}))}errorStickerpickerContent(){return o.a.createElement("div",{style:{textAlign:"center"},className:"error"},o.a.createElement("p",null," ",this.state.imError," "))}sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=An.a.instance.getMessagingForUid(sn.a.calcWidgetUid(this.state.stickerpickerWidget.id,null));t&&e!==this.prevSentVisibility&&(t.updateVisibility(e).catch(e=>{Sa.a.error("Error updating widget visibility: ",e)}),this.prevSentVisibility=e)}getStickerpickerContent(){if(this.state.imError)return this.errorStickerpickerContent();const e=this.state.stickerpickerWidget;let t;if(e&&e.content&&e.content.url){e.content.name=e.content.name||Object(N.a)("Stickerpack");const a={id:e.id,url:e.content.url,name:e.content.name,type:e.content.type,data:e.content.data,roomId:e.content.roomId,eventId:e.content.eventId,avatar_url:e.content.avatar_url,creatorUserId:e.content.creatorUserId};t=o.a.createElement("div",{className:"mx_Stickers_content_container"},o.a.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},o.a.createElement(vn,{persistKey:"stickerPicker",zIndex:3500},o.a.createElement(di,{app:a,room:this.props.room,threadId:this.props.threadId,fullWidth:!0,userId:Et.a.get().credentials.userId,creatorUserId:e.sender||Et.a.get().credentials.userId,waitForIframeLoad:!0,showMenubar:!0,onEditClick:this.launchManageIntegrations,onDeleteClick:this.removeStickerpickerWidgets,showTitle:!1,showPopout:!1,handleMinimisePointerEvents:!0,userWidget:!0,showLayoutButtons:!1}))))}else t=this.defaultStickerpickerContent();return t}render(){return this.props.isStickerPickerOpen?o.a.createElement(ve.o,ue()({chevronFace:ve.a.Bottom,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this.onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500},this.props.menuPosition),o.a.createElement(lr,{element:this.getStickerpickerContent(),onResize:this.onFinished})):null}}i()(dr,"defaultProps",{threadId:null}),i()(dr,"currentWidget",void 0);var mr=a(858);class hr extends o.a.Component{render(){return this.props.replyToEvent?o.a.createElement("div",{className:"mx_ReplyPreview"},o.a.createElement("div",{className:"mx_ReplyPreview_section"},o.a.createElement("div",{className:"mx_ReplyPreview_header"},o.a.createElement("span",null,Object(N.a)("Replying")),o.a.createElement(U.a,{className:"mx_ReplyPreview_header_cancel",onClick:()=>{return e=this.context.timelineRenderingType,void b.a.dispatch({action:"reply_to_event",event:null,context:e});var e}})),o.a.createElement(mr.a,{mxEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}))):null}}i()(hr,"contextType",Zn.b);var ur=a(357),pr=a(783);class gr extends o.a.PureComponent{constructor(e){super(e),i()(this,"waveform",[]),i()(this,"scheduledUpdate",new ui.a(()=>this.updateWaveform(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),this.state={waveform:Object(Sn.h)(0,ur.a)}}componentDidMount(){this.props.recorder.liveData.onUpdate(e=>{this.waveform=Object(Sn.c)(Array.from(e.waveform),ur.a),this.scheduledUpdate.mark()})}updateWaveform(){this.setState({waveform:this.waveform})}render(){return o.a.createElement(pr.a,{relHeights:this.state.waveform})}}i()(gr,"defaultProps",{progress:1});var br=a(410);class vr extends o.a.PureComponent{constructor(e){super(e),i()(this,"seconds",0),i()(this,"scheduledUpdate",new ui.a(()=>this.updateClock(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),this.state={seconds:0}}componentDidMount(){this.props.recorder.liveData.onUpdate(e=>{this.seconds=e.timeSeconds,this.scheduledUpdate.mark()})}updateClock(){this.setState({seconds:this.seconds})}render(){return o.a.createElement(br.a,{seconds:this.state.seconds,"aria-live":"off"})}}function fr(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var n=a.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function Er(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function yr(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Er(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Er(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class _r extends Fn.a{constructor(){super(b.a,{})}static get instance(){return _r.internalInstance||(_r.internalInstance=new _r),_r.internalInstance}async onAction(e){}getActiveRecording(e){return this.state[e]}startRecording(e){if(!this.matrixClient)throw new Error("Cannot start a recording without a MatrixClient");if(!e)throw new Error("Recording must be associated with a room");if(this.state[e])throw new Error("A recording is already in progress");const t=new ur.d(this.matrixClient);return this.updateState(yr(yr({},this.state),{},{[e]:t})),t}disposeRecording(e){this.state[e]&&this.state[e].destroy();const t=this.state,{[e]:a}=t,n=Ee()(t,[e].map(fr));return this.reset(n)}}i()(_r,"internalInstance",void 0),window.mxVoiceRecordingStore=_r.instance;var Sr=a(857),wr=a(586);class Cr extends o.a.PureComponent{constructor(e){super(e),i()(this,"onCancel",async()=>{await this.disposeRecording()}),i()(this,"onRecordStartEndClick",async()=>{if(this.state.recorder)return void await this.state.recorder.stop();const e=()=>{gt.a.createTrackedDialog("Microphone Access Error","",Yn.a,{title:Object(N.a)("Unable to access your microphone"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(N.a)("We were unable to access your microphone. Please check your browser settings and try again.")))})};try{var t;const e=await p.c.getDevices();if(null==e||null===(t=e[p.b.AudioInput])||void 0===t||!t.length)return void gt.a.createTrackedDialog("No Microphone Error","",Yn.a,{title:Object(N.a)("No microphone found"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(N.a)("We didn't find a microphone on your device. Please check your settings and try again.")))})}catch(t){return Sa.a.error("Error getting devices: ",t),void e()}try{wr.a.instance.pauseAllExcept(null);const e=_r.instance.startRecording(this.props.room.roomId);await e.start(),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:ur.b.Started})}catch(t){Sa.a.error("Error starting recording: ",t),e(),_r.instance.disposeRecording(this.props.room.roomId)}}),i()(this,"onRecordingUpdate",e=>{e!==ur.b.EndingSoon&&this.setState({recordingPhase:e})}),this.state={recorder:null}}componentDidMount(){const e=_r.instance.getActiveRecording(this.props.room.roomId);e&&(!e.isRecording&&e.hasRecording||Sa.a.warn("Cached recording hasn't ended yet and might cause issues"),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:ur.b.Ended}))}async componentWillUnmount(){const e=_r.instance.getActiveRecording(this.props.room.roomId);await(null==e?void 0:e.stop()),this.bindNewRecorder(null)}async send(){if(!this.state.recorder)throw new Error("No recording started - cannot send anything");let e;await this.state.recorder.stop();try{e=await this.state.recorder.upload(this.props.room.roomId)}catch(e){return Sa.a.error("Error uploading voice message:",e),void this.setState({didUploadFail:!0})}try{Et.a.get().sendMessage(this.props.room.roomId,{body:"Voice message",msgtype:ge.c.Audio,url:e.mxc,file:e.encrypted,info:{duration:Math.round(1e3*this.state.recorder.durationSeconds),mimetype:this.state.recorder.contentType,size:this.state.recorder.contentLength},"org.matrix.msc1767.text":"Voice message","org.matrix.msc1767.file":{url:e.mxc,file:e.encrypted,name:"Voice message.ogg",mimetype:this.state.recorder.contentType,size:this.state.recorder.contentLength},"org.matrix.msc1767.audio":{duration:Math.round(1e3*this.state.recorder.durationSeconds),waveform:this.state.recorder.getPlayback().thumbnailWaveform.map(e=>Math.round(1024*e))},"org.matrix.msc3245.voice":{}})}catch(e){Sa.a.error("Error sending voice message:",e)}await this.disposeRecording()}async disposeRecording(){await _r.instance.disposeRecording(this.props.room.roomId),this.setState({recorder:null,recordingPhase:null,didUploadFail:!1})}bindNewRecorder(e){this.state.recorder&&this.state.recorder.off(L.b,this.onRecordingUpdate),e&&e.on(L.b,this.onRecordingUpdate)}renderWaveformArea(){return this.state.recorder?this.state.recordingPhase!==ur.b.Started?o.a.createElement(Sr.a,{playback:this.state.recorder.getPlayback(),withWaveform:!0}):o.a.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer mx_VoiceRecordComposerTile_recording"},o.a.createElement(vr,{recorder:this.state.recorder}),o.a.createElement(gr,{recorder:this.state.recorder})):null}render(){if(!this.state.recordingPhase)return null;let e,t,a;if(this.state.recordingPhase===ur.b.Started){var n;let t=Object(N.a)("Send voice message");this.state.recorder&&(t=Object(N.a)("Stop recording")),e=o.a.createElement(oe.a,{className:"mx_VoiceRecordComposerTile_stop",onClick:this.onRecordStartEndClick,title:t}),!this.state.recorder||null!==(n=this.state.recorder)&&void 0!==n&&n.isRecording||(e=null)}return this.state.recorder&&this.state.recordingPhase!==ur.b.Uploading&&(t=o.a.createElement(oe.a,{className:"mx_VoiceRecordComposerTile_delete",title:Object(N.a)("Delete"),onClick:this.onCancel})),this.state.recordingPhase===ur.b.Uploading?a=o.a.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadingState"},o.a.createElement(Kt.a,{w:16,h:16})):this.state.didUploadFail&&this.state.recordingPhase===ur.b.Ended&&(a=o.a.createElement("span",{className:"mx_VoiceRecordComposerTile_failedState"},o.a.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadState_badge"},o.a.createElement(Pe.a,{notification:De.a.forSymbol("!",Ae.a.Red)})),o.a.createElement("span",{className:"text-warning"},Object(N.a)("Failed to send")))),o.a.createElement(o.a.Fragment,null,a,t,e,this.renderWaveformArea())}}var Or=a(778);const kr=["title","children","className","iconClassName"],xr=e=>{let{title:t,children:a,className:n,iconClassName:i}=e,r=Ee()(e,kr);return!!Object(s.useContext)(uc)?o.a.createElement(ye.b,ue()({},r,{iconClassName:i,label:t})):o.a.createElement(oe.a,ue()({},r,{title:t,className:l()(n,i)}),a)};var Rr=a(845),jr=a(503),Ir=a.n(jr),Tr=a(205),Nr=a(222),Pr=a(199),Mr=a(530),Dr=a(317);const Ar=e=>{let{onFinished:t,error:a}=e;return o.a.createElement("div",{"data-test-id":"location-picker-error",className:"mx_MapError"},o.a.createElement(Mr.Icon,{className:"mx_MapError_icon"}),o.a.createElement(Dr.a,{className:"mx_MapError_heading",size:"h3"},Object(N.a)("Unable to load map")),o.a.createElement("p",null,Object(Pr.e)(a)),o.a.createElement(U.a,{element:"button",kind:"primary",onClick:t},Object(N.a)("OK")))},Ur={fifteenMins:9e5,oneHour:36e5,eightHours:288e5},Lr=Ur.fifteenMins,Fr=e=>Object(N.a)("Share for %(duration)s",{duration:Object(vs.c)(e)});var Br=e=>{let{timeout:t,onChange:a}=e;const n=Object.values(Ur).map(e=>({key:e.toString(),duration:e,label:Fr(e)}));Object.values(Ur).includes(t)||n.push({key:t.toString(),duration:t,label:Fr(t)});return o.a.createElement(Je.a,{id:"live-duration","data-test-id":"live-duration-dropdown",label:Fr(t),value:t.toString(),onOptionChange:e=>{a(+e)},className:"mx_LiveDurationDropdown"},n.map(e=>{let{key:t,label:a}=e;return o.a.createElement("div",{"data-test-id":"live-duration-option-"+t,key:t},a)}))},Vr=a(237),Wr=a(18),Hr=a(347);let zr;!function(e){e.Own="Own",e.Pin="Pin",e.Live="Live"}(zr||(zr={}));const Kr=(e,t,a)=>{const n=a===zr.Live?"We couldn't start sharing your live location":"We couldn't send your location";Sa.a.error(n,e);const i=n,s={title:Object(N.a)("We couldn't send your location"),description:Object(N.a)("%(brand)s could not send your location. Please try again later.",{brand:P.b.get().brand}),button:Object(N.a)("Try again"),cancelButton:Object(N.a)("Cancel"),onFinished:e=>{e&&t()}};gt.a.createTrackedDialog(i,"",yt.a,s)};var qr=a(784);const Gr=e=>e===zr.Own||e===zr.Live;class Yr extends o.a.Component{constructor(e){super(e),i()(this,"context",void 0),i()(this,"map",null),i()(this,"geolocate",null),i()(this,"marker",null),i()(this,"getMarkerId",()=>"mx_MLocationPicker_marker"),i()(this,"addMarkerToMap",()=>{this.marker=new Ir.a.Marker({element:document.getElementById(this.getMarkerId()),anchor:"bottom",offset:[0,-1]}).setLngLat(new Ir.a.LngLat(0,0)).addTo(this.map)}),i()(this,"updateStyleUrl",e=>{var t;const a=null===(t=Object(Tr.h)(e))||void 0===t?void 0:t.map_style_url;var n;a&&(null===(n=this.map)||void 0===n||n.setStyle(a))}),i()(this,"onGeolocate",e=>{var t;this.marker||this.addMarkerToMap(),this.setState({position:Object(Nr.b)(e)}),null===(t=this.marker)||void 0===t||t.setLngLat(new Ir.a.LngLat(e.coords.longitude,e.coords.latitude))}),i()(this,"onClick",e=>{var t;this.marker||this.addMarkerToMap(),null===(t=this.marker)||void 0===t||t.setLngLat(e.lngLat),this.setState({position:{timestamp:Date.now(),latitude:e.lngLat.lat,longitude:e.lngLat.lng}})}),i()(this,"onGeolocateError",e=>{var t;(Sa.a.error("Could not fetch location",e),Gr(this.props.shareType)&&(this.props.onFinished(),gt.a.createTrackedDialog("Could not fetch location","",Yn.a,{title:Object(N.a)("Could not fetch location"),description:Qr(e.code)})),this.geolocate)&&(null===(t=this.map)||void 0===t||t.removeControl(this.geolocate))}),i()(this,"onTimeoutChange",e=>{this.setState({timeout:e})}),i()(this,"onOk",()=>{const{timeout:e,position:t}=this.state;this.props.onChoose(t?{uri:Object(Nr.f)(t),timestamp:t.timestamp,timeout:e}:{timeout:e}),this.props.onFinished()}),this.state={position:void 0,timeout:Lr,error:void 0}}componentDidMount(){this.context.on(r.b.ClientWellKnown,this.updateStyleUrl);try{if(this.map=new Ir.a.Map({container:"mx_LocationPicker_map",style:Object(Pr.d)(),center:[0,0],zoom:1}),this.geolocate=new Ir.a.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!1}),this.map.addControl(this.geolocate),this.map.on("error",e=>{Sa.a.error("Failed to load map: check map_style_url in config.json has a valid URL and API key",e.error),this.setState({error:Pr.a.MapStyleUrlNotReachable})}),this.map.on("load",()=>{this.geolocate.trigger()}),this.geolocate.on("error",this.onGeolocateError),Gr(this.props.shareType)&&this.geolocate.on("geolocate",this.onGeolocate),this.props.shareType===zr.Pin){const e=new Ir.a.NavigationControl({showCompass:!1,showZoom:!0});this.map.addControl(e,"bottom-right"),this.map.on("click",this.onClick)}}catch(e){Sa.a.error("Failed to render map",e);const t=(null==e?void 0:e.message)===Pr.a.MapStyleUrlNotConfigured?Pr.a.MapStyleUrlNotConfigured:Pr.a.Default;this.setState({error:t})}}componentWillUnmount(){var e,t,a;null===(e=this.geolocate)||void 0===e||e.off("error",this.onGeolocateError),null===(t=this.geolocate)||void 0===t||t.off("geolocate",this.onGeolocate),null===(a=this.map)||void 0===a||a.off("click",this.onClick),this.context.off(r.b.ClientWellKnown,this.updateStyleUrl)}render(){return this.state.error?o.a.createElement("div",{className:"mx_LocationPicker mx_LocationPicker_hasError"},o.a.createElement(Ar,{error:this.state.error,onFinished:this.props.onFinished})):o.a.createElement("div",{className:"mx_LocationPicker"},o.a.createElement("div",{id:"mx_LocationPicker_map"}),this.props.shareType===zr.Pin&&o.a.createElement("div",{className:"mx_LocationPicker_pinText"},o.a.createElement("span",null,this.state.position?Object(N.a)("Click to move the pin"):Object(N.a)("Click to drop a pin"))),o.a.createElement("div",{className:"mx_LocationPicker_footer"},o.a.createElement("form",{onSubmit:this.onOk},this.props.shareType===zr.Live&&o.a.createElement(Br,{onChange:this.onTimeoutChange,timeout:this.state.timeout}),o.a.createElement(U.a,{"data-test-id":"location-picker-submit-button",type:"submit",element:"button",kind:"primary",className:"mx_LocationPicker_submitButton",disabled:!this.state.position,onClick:this.onOk},Object(N.a)("Share location")))),o.a.createElement("div",{id:this.getMarkerId()},!!this.marker&&o.a.createElement(qr.a,{roomMember:Gr(this.props.shareType)?this.props.sender:void 0,useMemberColor:this.props.shareType===zr.Live})))}}i()(Yr,"contextType",j.a);var Jr,$r=Yr;function Qr(e){const t=P.b.get().brand;switch(e){case 1:return Object(N.a)("%(brand)s was denied permission to fetch your location. Please allow location access in your browser settings.",{brand:t});case 2:return Object(N.a)("Failed to fetch your location. Please try again later.");case 3:return Object(N.a)("Timed out trying to fetch your location. Please try again later.");case 4:return Object(N.a)("Unknown error fetching location. Please try again later.")}}function Xr(){return(Xr=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function Zr(e){return s.createElement("svg",Xr({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 8 14",role:"presentation","aria-hidden":!0},e),Jr||(Jr=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.637.707c.39.39.391 1.025.002 1.417L2.705 7.089l4.95 4.95c.39.39.392 1.025.002 1.417a.996.996 0 01-1.412.002L.59 7.8a1.004 1.004 0 01-.003-1.416L6.225.709A.996.996 0 017.637.707z",fill:"currentColor"})))}var ec=a(831);var tc=e=>{let{onBack:t,onCancel:a,displayBack:n}=e;return o.a.createElement("div",{className:"mx_ShareDialogButtons"},n&&o.a.createElement(U.a,{className:"mx_ShareDialogButtons_button left","data-test-id":"share-dialog-buttons-back",onClick:t,element:"button"},o.a.createElement(Zr,{className:"mx_ShareDialogButtons_button-icon"})),o.a.createElement(U.a,{className:"mx_ShareDialogButtons_button right","data-test-id":"share-dialog-buttons-cancel",onClick:a,element:"button"},o.a.createElement(ec.a,{className:"mx_ShareDialogButtons_button-icon"})))},ac=a(542),nc=a(305);const ic=["onClick","label","shareType"],sc=()=>{const e=Object(s.useContext)(j.a).getUserId(),t=A.a.instance.displayName,a=A.a.instance.getHttpAvatarUrl(36);return o.a.createElement("div",{className:"mx_ShareType_option-icon "+zr.Own},o.a.createElement(D.a,{idName:e,name:t,url:a,width:36,height:36,resizeMethod:"crop",className:"mx_UserMenu_userAvatar_BaseAvatar"}))},oc=e=>{let{onClick:t,label:a,shareType:n}=e,i=Ee()(e,ic);return o.a.createElement(U.a,ue()({element:"button",className:"mx_ShareType_option",onClick:t},i),n===zr.Own&&o.a.createElement(sc,null),n===zr.Pin&&o.a.createElement(ac.a,{className:"mx_ShareType_option-icon "+zr.Pin}),n===zr.Live&&o.a.createElement(nc.a,{className:"mx_ShareType_option-icon "+zr.Live}),a)};var rc=e=>{let{setShareType:t,enabledShareTypes:a}=e;const n={[zr.Own]:Object(N.a)("My current location"),[zr.Live]:Object(N.a)("My live location"),[zr.Pin]:Object(N.a)("Drop a Pin")};return o.a.createElement("div",{className:"mx_ShareType"},o.a.createElement(ac.a,{className:"mx_ShareType_badge"}),o.a.createElement(Dr.a,{className:"mx_ShareType_heading",size:"h3"},Object(N.a)("What location type do you want to share?")),a.map(e=>o.a.createElement(oc,{key:e,onClick:()=>t(e),label:n[e],shareType:e,"data-test-id":"share-location-option-"+e})))};const cc=e=>{let{onSubmit:t}=e;const[a,n]=Object(s.useState)(!1);return o.a.createElement("div",{"data-test-id":"location-picker-enable-live-share",className:"mx_EnableLiveShare"},o.a.createElement(nc.a,{className:"mx_EnableLiveShare_icon"}),o.a.createElement(Dr.a,{className:"mx_EnableLiveShare_heading",size:"h3"},Object(N.a)("Live location sharing")),o.a.createElement("p",{className:"mx_EnableLiveShare_description"},Object(N.a)("Please note: this is a labs feature using a temporary implementation. This means you will not be able to delete your location history, and advanced users will be able to see your location history even after you stop sharing your live location with this room.")),o.a.createElement(wn.a,{"data-test-id":"enable-live-share-toggle",value:a,onChange:n,label:Object(N.a)("Enable live location sharing")}),o.a.createElement(U.a,{"data-test-id":"enable-live-share-submit",className:"mx_EnableLiveShare_button",element:"button",kind:"primary",onClick:t,disabled:!a},Object(N.a)("OK")))};var lc=e=>{let{menuPosition:t,onFinished:a,sender:n,roomId:i,openMenu:r,relation:c}=e;const l=Object(s.useContext)(j.a),d=(()=>{const e=[zr.Own,zr.Live];return v.b.getValue("feature_location_share_pin_drop")&&e.push(zr.Pin),e})(),m=Object(be.a)("feature_location_share_live"),h=d.length>1,[u,p]=Object(s.useState)(h?void 0:zr.Own),g=A.a.instance.displayName,b=u===zr.Live?((e,t,a,n)=>async e=>{let{timeout:i}=e;const s=Object(N.a)("%(displayName)s's live location",{displayName:a});try{await Hr.a.instance.createLiveBeacon(t,Object(Vr.makeBeaconInfoContent)(null!=i?i:3e5,!0,s,Wr.a.Self))}catch(e){Kr(e,n,zr.Live)}})(0,i,g,r):((e,t,a,n,i)=>async s=>{let{uri:o,timestamp:r}=s;if(o)try{const i=(null==n?void 0:n.rel_type)===_n.c.name?n.event_id:null,s=a===zr.Pin?Wr.a.Pin:Wr.a.Self;await e.sendMessage(t,i,Object(Vr.makeLocationContent)(void 0,o,r,void 0,s))}catch(e){Kr(e,i,a)}})(l,i,u,c,r),E=u===zr.Live&&!m;return o.a.createElement(ve.o,ue()({},t,{onFinished:a,managed:!1}),o.a.createElement("div",{className:"mx_LocationShareMenu"},E&&o.a.createElement(cc,{onSubmit:()=>{v.b.setValue("feature_location_share_live",void 0,f.a.DEVICE,!0)}}),!E&&!!u&&o.a.createElement($r,{sender:n,shareType:u,onChoose:b,onFinished:a}),!u&&o.a.createElement(rc,{setShareType:p,enabledShareTypes:d}),o.a.createElement(tc,{displayBack:!!u&&h,onBack:()=>p(void 0),onCancel:a})))};var dc=e=>{let{roomId:t,sender:a,menuPosition:n,relation:i}=e;const r=Object(s.useContext)(uc),[c,d,m,h]=Object(ve.q)(),u=e=>{h(e),null==r||r()};let p;if(c){const e=null!=n?n:Object(ve.j)(d.current.getBoundingClientRect());p=o.a.createElement(lc,{menuPosition:e,onFinished:u,sender:a,roomId:t,openMenu:m,relation:i})}const g=l()("mx_MessageComposer_button",{mx_MessageComposer_button_highlight:c});return o.a.createElement(o.a.Fragment,null,o.a.createElement(xr,{className:g,iconClassName:"mx_MessageComposer_location",onClick:m,title:Object(N.a)("Location")}),p)},mc=a(854),hc=a(248);const uc=Object(s.createContext)(null);function pc(e){return o.a.createElement(gc,{key:"emoji_button",addEmoji:e.addEmoji,menuPosition:e.menuPosition})}const gc=e=>{let{addEmoji:t,menuPosition:a}=e;const n=Object(s.useContext)(uc),[i,r,c,d]=Object(ve.q)();let m=null;if(i){const e=null!=a?a:Object(ve.j)(r.current.getBoundingClientRect());m=o.a.createElement(ve.o,ue()({},e,{onFinished:()=>{d(),null==n||n()},managed:!1}),o.a.createElement(Rr.d,{onChoose:t,showQuickReactions:!0}))}const h=l()("mx_MessageComposer_button",{mx_MessageComposer_button_highlight:i});return o.a.createElement(o.a.Fragment,null,o.a.createElement(xr,{className:h,iconClassName:"mx_MessageComposer_emoji",onClick:c,title:Object(N.a)("Emoji")}),m)};function bc(){return o.a.createElement(Ec,{key:"controls_upload"})}const vc=Object(s.createContext)(null),fc=e=>{let{roomId:t,relation:a,children:n}=e;const i=Object(s.useContext)(j.a),r=Object(s.useContext)(Zn.b),c=Object(s.useRef)(),l=()=>{var e;i.isGuest()?b.a.dispatch({action:"require_registration"}):null===(e=c.current)||void 0===e||e.click()};Object(Mt.a)(b.a,e=>{r.timelineRenderingType===e.context&&"upload_file"===e.action&&l()});return o.a.createElement(vc.Provider,{value:l},n,o.a.createElement("input",{ref:c,type:"file",style:{display:"none"},multiple:!0,onClick:hc.a,onChange:e=>{0!==e.target.files.length&&(Di.a.sharedInstance().sendContentListToRoom(Array.from(e.target.files),t,a,i,r.timelineRenderingType),e.target.value="")}}))},Ec=()=>{const e=Object(s.useContext)(uc),t=Object(s.useContext)(vc);return o.a.createElement(xr,{className:"mx_MessageComposer_button",iconClassName:"mx_MessageComposer_upload",onClick:()=>{null==t||t(),null==e||e()},title:Object(N.a)("Attachment")})};function yc(e){return e.showStickersButton?o.a.createElement(xr,{id:"stickersButton",key:"controls_stickers",className:"mx_MessageComposer_button",iconClassName:"mx_MessageComposer_stickers",onClick:()=>e.setStickerPickerOpen(!e.isStickerPickerOpen),title:e.isStickerPickerOpen?Object(N.a)("Hide stickers"):Object(N.a)("Sticker")}):null}function _c(e,t){return t?null:o.a.createElement(xr,{key:"voice_message_send",className:"mx_MessageComposer_button",iconClassName:"mx_MessageComposer_voiceMessage",onClick:e.onRecordStartEndClick,title:Object(N.a)("Voice Message")})}function Sc(e,t){return o.a.createElement(wc,{key:"polls",room:e,relation:t})}class wc extends o.a.PureComponent{constructor(){super(...arguments),i()(this,"context",void 0),i()(this,"onCreateClick",()=>{var e;null===(e=this.context)||void 0===e||e.call(this);if(this.props.room.currentState.maySendEvent(hs.M_POLL_START.name,Et.a.get().getUserId())){var t;const e=(null===(t=this.props.relation)||void 0===t?void 0:t.rel_type)===_n.c.name?this.props.relation.event_id:null;gt.a.createTrackedDialog("Polls","create",mc.a,{room:this.props.room,threadId:e},"mx_CompoundDialog",!1,!0)}else gt.a.createTrackedDialog("Polls","permissions error: cannot start",Yn.a,{title:Object(N.a)("Permission Required"),description:Object(N.a)("You do not have permission to start polls in this room.")})})}render(){var e;return(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===_n.c.name?null:o.a.createElement(xr,{className:"mx_MessageComposer_button",iconClassName:"mx_MessageComposer_poll",onClick:this.onCreateClick,title:Object(N.a)("Poll")})}}function Cc(e,t,a,n){return e.showLocationButton?o.a.createElement(dc,{key:"location",roomId:a,relation:e.relation,sender:t.getMember(n.getUserId()),menuPosition:e.menuPosition}):null}i()(wc,"contextType",uc);var Oc=e=>{const t=Object(s.useContext)(j.a),{room:a,roomId:n,narrow:i}=Object(s.useContext)(Zn.b);if(e.haveRecording)return null;let r,c;i?(r=[pc(e)],c=[bc(),yc(e),_c(e,i),e.showPollsButton&&Sc(a,e.relation),Cc(e,a,n,t)]):(r=[pc(e),bc()],c=[yc(e),_c(e,i),e.showPollsButton&&Sc(a,e.relation),Cc(e,a,n,t)]),r=r.filter(e=>e),c=c.filter(e=>e);const d=l()({mx_MessageComposer_button:!0,mx_MessageComposer_buttonMenu:!0,mx_MessageComposer_closeButtonMenu:e.isMenuOpen});return o.a.createElement(fc,{roomId:n,relation:e.relation},r,c.length>0&&o.a.createElement(oe.a,{className:d,onClick:e.toggleButtonMenu,title:Object(N.a)("More options")}),e.isMenuOpen&&o.a.createElement(ye.e,ue()({onFinished:e.toggleButtonMenu},e.menuPosition,{wrapperClassName:"mx_MessageComposer_Menu",compact:!0}),o.a.createElement(uc.Provider,{value:e.toggleButtonMenu},o.a.createElement(ye.c,null,c))))};let kc=0;function xc(e){var t;return o.a.createElement(oe.a,{className:"mx_MessageComposer_sendMessage",onClick:e.onClick,title:null!==(t=e.title)&&void 0!==t?t:Object(N.a)("Send message")})}class Rc extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"messageComposerInput",Object(s.createRef)()),i()(this,"voiceRecordingButton",Object(s.createRef)()),i()(this,"ref",Object(s.createRef)()),i()(this,"instanceId",void 0),i()(this,"_voiceRecording",void 0),i()(this,"context",void 0),i()(this,"onResize",(e,t)=>{if(e===de.a.Resize){const{narrow:e}=this.context;this.setState({isMenuOpen:!!e&&this.state.isMenuOpen,isStickerPickerOpen:!1})}}),i()(this,"onAction",e=>{switch(e.action){case"reply_to_event":e.context===this.context.timelineRenderingType&&setTimeout(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()},100);break;case M.a.SettingUpdated:switch(e.settingName){case"MessageComposerInput.showStickersButton":{const e=v.b.getValue("MessageComposerInput.showStickersButton");this.state.showStickersButton!==e&&this.setState({showStickersButton:e});break}case"MessageComposerInput.showPollsButton":{const e=v.b.getValue("MessageComposerInput.showPollsButton");this.state.showPollsButton!==e&&this.setState({showPollsButton:e});break}}}}),i()(this,"onTombstoneClick",e=>{e.preventDefault();const t=this.context.tombstone.getContent().replacement_room,a=Et.a.get().getRoom(t);let n=null;if(a){const e=a.currentState.getStateEvents(ge.b.RoomCreate,"");e&&e.getId()&&(n=e.getId())}const i=[this.context.tombstone.getSender().split(":").slice(1).join(":")];b.a.dispatch({action:M.a.ViewRoom,highlighted:!0,event_id:n,room_id:t,auto_join:!0,via_servers:i,metricsTrigger:"Tombstone",metricsViaKeyboard:"click"!==e.type})}),i()(this,"renderPlaceholderText",()=>{if(this.props.replyToEvent){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===_n.c.name;return t&&this.props.e2eStatus?Object(N.a)("Reply to encrypted thread…"):t?Object(N.a)("Reply to thread…"):this.props.e2eStatus?Object(N.a)("Send an encrypted reply…"):Object(N.a)("Send a reply…")}return this.props.e2eStatus?Object(N.a)("Send an encrypted message…"):Object(N.a)("Send a message…")}),i()(this,"addEmoji",e=>(b.a.dispatch({action:M.a.ComposerInsert,text:e,timelineRenderingType:this.context.timelineRenderingType}),!0)),i()(this,"sendMessage",async()=>{var e,t;this.state.haveRecording&&this.voiceRecordingButton.current?await(null===(t=this.voiceRecordingButton.current)||void 0===t?void 0:t.send()):null===(e=this.messageComposerInput.current)||void 0===e||e.sendMessage()}),i()(this,"onChange",e=>{this.setState({isComposerEmpty:e.isEmpty})}),i()(this,"onVoiceStoreUpdate",()=>{this.updateRecordingState()}),i()(this,"onRecordingStarted",()=>{this.voiceRecording=_r.instance.getActiveRecording(this.props.room.roomId),this.setState({haveRecording:!!this.voiceRecording})}),i()(this,"onRecordingEndingSoon",e=>{let{secondsLeft:t}=e;this.setState({recordingTimeLeftSeconds:t}),setTimeout(()=>this.setState({recordingTimeLeftSeconds:null}),3e3)}),i()(this,"setStickerPickerOpen",e=>{this.setState({isStickerPickerOpen:e,isMenuOpen:!1})}),i()(this,"toggleStickerPickerOpen",()=>{this.setStickerPickerOpen(!this.state.isStickerPickerOpen)}),i()(this,"toggleButtonMenu",()=>{this.setState({isMenuOpen:!this.state.isMenuOpen})}),_r.instance.on(L.b,this.onVoiceStoreUpdate),this.state={isComposerEmpty:!0,haveRecording:!1,recordingTimeLeftSeconds:null,isMenuOpen:!1,isStickerPickerOpen:!1,showStickersButton:v.b.getValue("MessageComposerInput.showStickersButton"),showPollsButton:v.b.getValue("MessageComposerInput.showPollsButton")},this.instanceId=kc++,v.b.monitorSetting("MessageComposerInput.showStickersButton",null),v.b.monitorSetting("MessageComposerInput.showPollsButton",null)}get voiceRecording(){return this._voiceRecording}set voiceRecording(e){this._voiceRecording&&(this._voiceRecording.off(ur.b.Started,this.onRecordingStarted),this._voiceRecording.off(ur.b.EndingSoon,this.onRecordingEndingSoon)),this._voiceRecording=e,e&&(e.on(ur.b.Started,this.onRecordingStarted),e.on(ur.b.EndingSoon,this.onRecordingEndingSoon))}componentDidMount(){this.dispatcherRef=b.a.register(this.onAction),this.waitForOwnMember(),de.b.instance.trackElementDimensions("MessageComposer"+this.instanceId,this.ref.current),de.b.instance.on("MessageComposer"+this.instanceId,this.onResize),this.updateRecordingState()}waitForOwnMember(){const e=this.props.room.getMember(Et.a.get().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then(()=>{const e=this.props.room.getMember(Et.a.get().getUserId());this.setState({me:e})})}componentWillUnmount(){_r.instance.off(L.b,this.onVoiceStoreUpdate),b.a.unregister(this.dispatcherRef),de.b.instance.stopTrackingElementDimensions("MessageComposer"+this.instanceId),de.b.instance.removeListener("MessageComposer"+this.instanceId,this.onResize),this.voiceRecording=null}updateRecordingState(){this.voiceRecording=_r.instance.getActiveRecording(this.props.room.roomId),this.voiceRecording?this.voiceRecording.hasRecording&&!this.voiceRecording.isRecording&&this.setState({haveRecording:!0}):this.setState({haveRecording:!1})}render(){var e;const t=[this.props.e2eStatus?o.a.createElement(co.b,{key:"e2eIcon",status:this.props.e2eStatus,className:"mx_MessageComposer_e2eIcon"}):null];let n;if(this.ref.current){const e=this.ref.current.getBoundingClientRect();n=Object(ve.j)(e)}const i=this.context.canSendMessages&&!this.context.tombstone;if(i)t.push(o.a.createElement(Or.b,{ref:this.messageComposerInput,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),permalinkCreator:this.props.permalinkCreator,relation:this.props.relation,replyToEvent:this.props.replyToEvent,onChange:this.onChange,disabled:this.state.haveRecording,toggleStickerPickerOpen:this.toggleStickerPickerOpen})),t.push(o.a.createElement(Cr,{key:"controls_voice_record",ref:this.voiceRecordingButton,room:this.props.room}));else if(this.context.tombstone){const e=this.context.tombstone.getContent().replacement_room,n=e?o.a.createElement("a",{href:Object(Mn.f)(e),className:"mx_MessageComposer_roomReplaced_link",onClick:this.onTombstoneClick},Object(N.a)("The conversation continues here.")):"";t.push(o.a.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},o.a.createElement("div",{className:"mx_MessageComposer_replaced_valign"},o.a.createElement("img",{className:"mx_MessageComposer_roomReplaced_icon",src:a(1456).default}),o.a.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},Object(N.a)("This room has been replaced and is no longer active.")),o.a.createElement("br",null),n)))}else t.push(o.a.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},Object(N.a)("You do not have permission to post to this room")));let s;const r=Math.round(this.state.recordingTimeLeftSeconds);r&&(s=o.a.createElement(za.b,{label:Object(N.a)("%(seconds)ss left",{seconds:r}),alignment:za.a.Top}));const c=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===_n.c.name?this.props.relation.event_id:null;t.push(o.a.createElement(dr,{room:this.props.room,threadId:c,isStickerPickerOpen:this.state.isStickerPickerOpen,setStickerPickerOpen:this.setStickerPickerOpen,menuPosition:n,key:"stickers"}));const d=!this.state.isComposerEmpty||this.state.haveRecording,m=l()({mx_MessageComposer:!0,mx_GroupLayout:!0,"mx_MessageComposer--compact":this.props.compact,mx_MessageComposer_e2eStatus:null!=this.props.e2eStatus});return o.a.createElement("div",{className:m,ref:this.ref},s,o.a.createElement("div",{className:"mx_MessageComposer_wrapper"},o.a.createElement(hr,{replyToEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}),o.a.createElement("div",{className:"mx_MessageComposer_row"},t,i&&o.a.createElement(Oc,{addEmoji:this.addEmoji,haveRecording:this.state.haveRecording,isMenuOpen:this.state.isMenuOpen,isStickerPickerOpen:this.state.isStickerPickerOpen,menuPosition:n,relation:this.props.relation,onRecordStartEndClick:()=>{var e;null===(e=this.voiceRecordingButton.current)||void 0===e||e.onRecordStartEndClick(),this.context.narrow&&this.toggleButtonMenu()},setStickerPickerOpen:this.setStickerPickerOpen,showLocationButton:!window.electron,showPollsButton:this.state.showPollsButton,showStickersButton:this.state.showStickersButton,toggleButtonMenu:this.toggleButtonMenu}),d&&o.a.createElement(xc,{key:"controls_send",onClick:this.sendMessage,title:this.state.haveRecording?Object(N.a)("Send voice message"):void 0}))))}}i()(Rc,"contextType",Zn.b),i()(Rc,"defaultProps",{compact:!1});class jc{constructor(e){this.event=e,i()(this,"serializedParts",null),i()(this,"caret",null)}setEditorState(e,t){this.caret=e,this.serializedParts=t}hasEditorState(){return!!this.serializedParts}getSerializedParts(){return this.serializedParts}getCaret(){return this.caret}getEvent(){return this.event}}var Ic=a(335),Tc=a.n(Ic),Nc=a(529);class Pc extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"mounted",void 0),i()(this,"onAction",e=>{switch(e.action){case M.a.UploadStarted:case M.a.UploadProgress:case M.a.UploadFinished:case M.a.UploadCanceled:case M.a.UploadFailed:{if(!this.mounted)return;const e=this.getUploadsInRoom();this.setState({currentUpload:e[0],uploadsHere:e});break}}}),i()(this,"onCancelClick",e=>{e.preventDefault(),Di.a.sharedInstance().cancelUpload(this.state.currentUpload.promise,this.context)});const t=this.getUploadsInRoom();this.state={currentUpload:t[0],uploadsHere:t}}componentDidMount(){this.dispatcherRef=b.a.register(this.onAction),this.mounted=!0}componentWillUnmount(){this.mounted=!1,b.a.unregister(this.dispatcherRef)}getUploadsInRoom(){return Di.a.sharedInstance().getCurrentUploads(this.props.relation).filter(e=>e.roomId===this.props.room.roomId)}render(){if(!this.state.currentUpload)return null;const e=Object(N.a)("Uploading %(filename)s and %(count)s others",{filename:this.state.currentUpload.fileName,count:this.state.uploadsHere.length-1}),t=Tc()(this.state.currentUpload.total);return o.a.createElement("div",{className:"mx_UploadBar"},o.a.createElement("div",{className:"mx_UploadBar_filename"},e," (",t,")"),o.a.createElement(U.a,{onClick:this.onCancelClick,className:"mx_UploadBar_cancel"}),o.a.createElement(Nc.a,{value:this.state.currentUpload.loaded,max:this.state.currentUpload.total}))}}i()(Pc,"contextType",j.a);var Mc=a(149);const Dc=["mxEvent","permalinkCreator","onMenuToggle"];var Ac=e=>{let{mxEvent:t,permalinkCreator:a,onMenuToggle:n}=e,i=Ee()(e,Dc);const[r,c,l,d]=Object(ve.q)(),m=Object(s.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:M.a.ViewRoom,event_id:t.getId(),highlighted:!0,room_id:t.getRoomId(),metricsTrigger:void 0}),d()},[t,d]),h=Object(s.useCallback)(async e=>{e.preventDefault(),e.stopPropagation();const n=a.forEvent(t.getId());await Object(Mc.c)(n),d()},[t,d,a]);Object(s.useEffect)(()=>{null==n||n(r)},[r,n]);const u=!ei.d.instance.hasMaximisedWidget(Et.a.get().getRoom(t.getRoomId()));return o.a.createElement(o.a.Fragment,null,o.a.createElement(ve.c,ue()({},i,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton",onClick:l,title:Object(N.a)("Thread options"),isExpanded:r,inputRef:c})),r&&o.a.createElement(ye.e,ue()({onFinished:d,className:"mx_RoomTile_contextMenu",compact:!0,rightAligned:!0},{left:(p=c.current.getBoundingClientRect()).left+window.scrollX+p.width,top:p.bottom+window.scrollY,chevronFace:ve.a.None}),o.a.createElement(ye.c,null,u&&o.a.createElement(ye.b,{onClick:e=>m(e),label:Object(N.a)("View in room"),iconClassName:"mx_ThreadPanel_viewInRoom"}),o.a.createElement(ye.b,{onClick:e=>h(e),label:Object(N.a)("Copy link to thread"),iconClassName:"mx_ThreadPanel_copyLinkToThread"}))));var p};var Uc=e=>{let{parent:t,onFileDrop:n}=e;const[i,r]=Object(s.useState)({dragging:!1,counter:0});return Object(s.useEffect)(()=>{if(!t||t.ondrop)return;const e=e=>{e.stopPropagation(),e.preventDefault(),r(t=>({counter:t.counter+1,dragging:!(!e.dataTransfer.types.includes("Files")&&!e.dataTransfer.types.includes("application/x-moz-file"))||t.dragging}))},a=e=>{e.stopPropagation(),e.preventDefault(),r(e=>({counter:e.counter-1,dragging:!(e.counter<=1)&&e.dragging}))},i=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="none",(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&(e.dataTransfer.dropEffect="copy")},s=e=>{e.stopPropagation(),e.preventDefault(),n(e.dataTransfer),r(e=>({dragging:!1,counter:e.counter-1}))};return t.addEventListener("drop",s),t.addEventListener("dragover",i),t.addEventListener("dragenter",e),t.addEventListener("dragleave",a),()=>{t.removeEventListener("drop",s),t.removeEventListener("dragover",i),t.removeEventListener("dragenter",e),t.removeEventListener("dragleave",a)}},[t,n]),i.dragging?o.a.createElement("div",{className:"mx_FileDropTarget"},o.a.createElement("img",{src:a(1457).default,className:"mx_FileDropTarget_image",alt:""}),Object(N.a)("Drop file here to upload")):null},Lc=a(408);function Fc(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Bc(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Fc(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Fc(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Vc extends o.a.Component{constructor(e){var t;super(e),t=this,i()(this,"context",void 0),i()(this,"dispatcherRef",void 0),i()(this,"layoutWatcherRef",void 0),i()(this,"timelinePanel",Object(s.createRef)()),i()(this,"card",Object(s.createRef)()),i()(this,"onAction",e=>{switch(e.phase==ts.a.ThreadView&&e.event&&this.setupThread(e.event),e.action){case M.a.ComposerInsert:if(e.composerType)break;if(e.timelineRenderingType!==Zn.a.Thread)break;b.a.dispatch(Bc(Bc({},e),{},{composerType:this.state.editState?Lc.a.Edit:Lc.a.Send}));break;case M.a.EditEvent:if(e.timelineRenderingType!==Zn.a.Thread)return;if(e.event&&!e.event.getThread())return;this.setState({editState:e.event?new jc(e.event):null},()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))});break;case"reply_to_event":e.context===Zn.a.Thread&&this.setState({replyToEvent:e.event})}}),i()(this,"setupThread",e=>{let t=this.props.room.getThread(e.getId());t||(t=this.props.room.createThread(e.getId(),e,[e],!0)),this.updateThread(t)}),i()(this,"onNewThread",e=>{e.id===this.props.mxEvent.getId()&&this.setupThread(this.props.mxEvent)}),i()(this,"updateThread",e=>{e&&this.state.thread!==e&&this.setState({thread:e},async()=>{var t;e.emit(_n.e.ViewThread),await e.fetchInitialEvents(),this.nextBatch=e.liveTimeline.getPaginationToken(qo.a.Backward),null===(t=this.timelinePanel.current)||void 0===t||t.refreshTimeline()})}),i()(this,"resetJumpToEvent",e=>{var t,a;this.props.initialEvent&&this.props.initialEventScrollIntoView&&e===(null===(t=this.props.initialEvent)||void 0===t?void 0:t.getId())&&b.a.dispatch({action:M.a.ViewRoom,room_id:this.props.room.roomId,event_id:null===(a=this.props.initialEvent)||void 0===a?void 0:a.getId(),highlighted:this.props.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0})}),i()(this,"onMeasurement",e=>{this.setState({narrow:e})}),i()(this,"onKeyDown",e=>{let t=!1;switch(Object(le.a)().getRoomAction(e)){case Ue.h.UploadFile:b.a.dispatch({action:"upload_file",context:Zn.a.Thread},!0),t=!0}t&&(e.stopPropagation(),e.preventDefault())}),i()(this,"nextBatch",void 0),i()(this,"onPaginationRequest",(async function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:qo.a.Backward,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;if(!_n.d.hasServerSideSupport)return e.extend(a,n),!0;const i={limit:n};t.nextBatch&&(i.from=t.nextBatch);const{nextBatch:s}=await t.state.thread.fetchEvents(i);return t.nextBatch=s,e.extend(a,n),!!s})),i()(this,"onFileDrop",e=>{Di.a.sharedInstance().sendContentListToRoom(Array.from(e.files),this.props.mxEvent.getRoomId(),this.threadRelation,Et.a.get(),Zn.a.Thread)}),i()(this,"renderThreadViewHeader",()=>o.a.createElement("div",{className:"mx_ThreadPanel__header"},o.a.createElement("span",null,Object(N.a)("Thread")),o.a.createElement(Ac,{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}))),this.state={layout:v.b.getValue("layout"),narrow:!1},this.layoutWatcherRef=v.b.watchSetting("layout",null,(function(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];let[,,,i]=a;return t.setState({layout:i})}))}componentDidMount(){this.setupThread(this.props.mxEvent),this.dispatcherRef=b.a.register(this.onAction);Et.a.get().getRoom(this.props.mxEvent.getRoomId()).on(_n.e.New,this.onNewThread)}componentWillUnmount(){this.dispatcherRef&&b.a.unregister(this.dispatcherRef);const e=this.props.mxEvent.getRoomId();Et.a.get().getRoom(e).removeListener(_n.e.New,this.onNewThread),v.b.unwatchSetting(this.layoutWatcherRef);const t=vt.a.instance.getRoomId()!==e;this.props.isInitialEventHighlighted&&!t&&b.a.dispatch({action:M.a.ViewRoom,room_id:this.props.room.roomId,metricsTrigger:void 0})}componentDidUpdate(e){e.mxEvent!==this.props.mxEvent&&this.setupThread(this.props.mxEvent),e.room!==this.props.room&&as.a.instance.setCard({phase:ts.a.RoomSummary})}get threadRelation(){var e,t,a,n;const i=null===(e=this.state.thread)||void 0===e?void 0:e.lastReply(e=>e.isRelation(_n.c.name)&&!e.status);return{rel_type:_n.c.name,event_id:null===(t=this.state.thread)||void 0===t?void 0:t.id,is_falling_back:!0,"m.in_reply_to":{event_id:null!==(a=null==i?void 0:i.getId())&&void 0!==a?a:null===(n=this.state.thread)||void 0===n?void 0:n.id}}}render(){var e,t,a,n,i,s;const r=this.props.isInitialEventHighlighted?null===(e=this.props.initialEvent)||void 0===e?void 0:e.getId():null,c=this.threadRelation,d=l()("mx_RoomView_messagePanel",{mx_GroupLayout:this.state.layout===nr.a.Group});let m;var h;this.state.thread?(this.props.initialEvent&&this.props.initialEvent.getRoomId()!==this.state.thread.roomId&&Sa.a.warn("ThreadView attempting to render TimelinePanel with mismatched initialEvent",this.state.thread.roomId,this.props.initialEvent.getRoomId(),this.props.initialEvent.getId()),m=o.a.createElement(o.a.Fragment,null,o.a.createElement(Uc,{parent:this.card.current,onFileDrop:this.onFileDrop}),o.a.createElement(ar,{key:this.state.thread.id,ref:this.timelinePanel,showReadReceipts:!1,manageReadReceipts:!0,manageReadMarkers:!0,sendReadReceiptOnLoad:!0,timelineSet:this.state.thread.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===nr.a.Bubble?nr.a.Bubble:nr.a.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:d,permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:null===(h=this.props.initialEvent)||void 0===h?void 0:h.getId(),highlightedEventId:r,eventScrollIntoView:this.props.initialEventScrollIntoView,onEventScrolledIntoView:this.resetJumpToEvent,onPaginationRequest:this.onPaginationRequest}))):m=o.a.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},o.a.createElement(un.a,null));return o.a.createElement(Zn.b.Provider,{value:Bc(Bc({},this.context),{},{timelineRenderingType:Zn.a.Thread,threadId:null===(t=this.state.thread)||void 0===t?void 0:t.id,liveTimeline:null===(a=this.state)||void 0===a||null===(n=a.thread)||void 0===n||null===(i=n.timelineSet)||void 0===i?void 0:i.getLiveTimeline(),narrow:this.state.narrow})},o.a.createElement(os,{className:"mx_ThreadView mx_ThreadPanel",onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderThreadViewHeader(),ref:this.card,onKeyDown:this.onKeyDown,onBack:e=>{W.b.trackInteraction("WebThreadViewBackButton",e)}},o.a.createElement(ir,{sensor:this.card.current,onMeasurement:this.onMeasurement}),o.a.createElement("div",{className:"mx_ThreadView_timelinePanelWrapper"},m),Di.a.sharedInstance().getCurrentUploads(c).length>0&&o.a.createElement(Pc,{room:this.props.room,relation:c}),(null===(s=this.state.thread)||void 0===s?void 0:s.timelineSet)&&o.a.createElement(Rc,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,relation:c,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}i()(Vc,"contextType",Zn.b);var Wc=a(488),Hc=a(527);function zc(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Kc(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?zc(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):zc(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}let qc;!function(e){e[e.My=0]="My",e[e.All=1]="All"}(qc||(qc={}));const Gc=e=>{let{label:t,description:a,onClick:n,isSelected:i}=e;return o.a.createElement(ve.g,{active:i,className:"mx_ThreadPanel_Header_FilterOptionItem",onClick:n},o.a.createElement("span",null,t),o.a.createElement("span",null,a))},Yc=e=>{let{filterOption:t,setFilterOption:a,empty:n}=e;const[i,s,r,c]=Object(ve.q)(),l=[{label:Object(N.a)("All threads"),description:Object(N.a)("Shows all threads from current room"),key:qc.All},{label:Object(N.a)("My threads"),description:Object(N.a)("Shows all threads you've participated in"),key:qc.My}],d=l.find(e=>e.key===t),m=l.map(e=>o.a.createElement(Gc,{key:e.key,label:e.label,description:e.description,onClick:()=>{a(e.key),c()},isSelected:e===d})),h=i?o.a.createElement(ve.o,{top:108,right:33,onFinished:c,chevronFace:ve.a.Top,wrapperClassName:"mx_ThreadPanel__header"},m):null;return o.a.createElement("div",{className:"mx_ThreadPanel__header"},o.a.createElement("span",null,Object(N.a)("Threads")),!n&&o.a.createElement(o.a.Fragment,null,o.a.createElement(Wc.a,{className:"mx_ThreadPanel_dropdown",inputRef:s,isExpanded:i,onClick:e=>{r(),W.b.trackInteraction("WebRightPanelThreadPanelFilterDropdown",e)}},`${Object(N.a)("Show:")} ${d.label}`),h))},Jc=e=>{let t,{hasThreads:a,filterOption:n,showAllThreadsCallback:i}=e;return t=a?o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(N.a)("Reply to an ongoing thread or use “%(replyInThread)s” when hovering over a message to start a new one.",{replyInThread:Object(N.a)("Reply in thread")})),o.a.createElement("p",null,n===qc.My?o.a.createElement("button",{onClick:i},Object(N.a)("Show all threads")):o.a.createElement(o.a.Fragment,null," "))):o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(N.a)("Threads help keep your conversations on-topic and easy to track.")),o.a.createElement("p",{className:"mx_ThreadPanel_empty_tip"},Object(N.a)("<b>Tip:</b> Use “%(replyInThread)s” when hovering over a message.",{replyInThread:Object(N.a)("Reply in thread")},{b:e=>o.a.createElement("b",null,e)}))),o.a.createElement("aside",{className:"mx_ThreadPanel_empty"},o.a.createElement("div",{className:"mx_ThreadPanel_largeIcon"}),o.a.createElement("h2",null,Object(N.a)("Keep discussions organised with threads")),t)};var $c=e=>{var t,a,n,i,r;let{roomId:c,onClose:l,permalinkCreator:d}=e;const m=Object(s.useContext)(j.a),h=Object(s.useContext)(Zn.b),u=Object(s.useRef)(),p=Object(s.useRef)(),[g,v]=Object(s.useState)(qc.All),[f,E]=Object(s.useState)(null),[y,_]=Object(s.useState)(null),[S,w]=Object(s.useState)(!1);Object(s.useEffect)(()=>{const e=m.getRoom(c);e.createThreadsTimelineSets().then(()=>e.fetchRoomThreads()).then(()=>{v(qc.All),E(e)})},[m,c]),Object(s.useEffect)(()=>{function e(){null==u||u.current.refreshTimeline()}return null==f||f.on(_n.e.Update,e),()=>{null==f||f.removeListener(_n.e.Update,e)}},[f,m,y]),Object(s.useEffect)(()=>{f&&(g===qc.My?_(f.threadsTimelineSets[1]):_(f.threadsTimelineSets[0]))},[f,g]),Object(s.useEffect)(()=>{y&&!_n.d.hasServerSideSupport&&u.current.refreshTimeline()},[y,u]);const C=P.b.get().bug_report_endpoint_url?()=>{gt.a.createTrackedDialog("Threads Feedback","feature_thread",Hc.a,{featureId:"feature_thread"})}:null;return o.a.createElement(Zn.b.Provider,{value:Kc(Kc({},h),{},{timelineRenderingType:Zn.a.ThreadsList,showHiddenEvents:!0,narrow:S})},o.a.createElement(os,{header:o.a.createElement(Yc,{filterOption:g,setFilterOption:v,empty:!(null!=y&&null!==(t=y.getLiveTimeline())&&void 0!==t&&t.getEvents().length)}),footer:o.a.createElement(o.a.Fragment,null,o.a.createElement(we.a,{tooltipTitle:Object(N.a)("Threads are a beta feature"),tooltipCaption:Object(N.a)("Click for more info"),onClick:()=>{b.a.dispatch({action:M.a.ViewUserSettings,initialTabId:Ge.a.Labs})}}),C&&Object(N.a)("<a>Give feedback</a>",{},{a:e=>o.a.createElement(U.a,{kind:"link_inline",onClick:C},e)})),className:"mx_ThreadPanel",onClose:l,withoutScrollContainer:!0,ref:p},o.a.createElement(ir,{sensor:p.current,onMeasurement:w}),y?o.a.createElement(ar,{key:null!==(a=null===(n=y.getFilter())||void 0===n?void 0:n.filterId)&&void 0!==a?a:c+":"+g,ref:u,showReadReceipts:!1,manageReadReceipts:!1,manageReadMarkers:!1,sendReadReceiptOnLoad:!1,timelineSet:y,showUrlPreview:!1,empty:o.a.createElement(Jc,{hasThreads:(null===(i=f.threadsTimelineSets)||void 0===i||null===(r=i[0])||void 0===r?void 0:r.getLiveTimeline().getEvents().length)>0,filterOption:g,showAllThreadsCallback:()=>v(qc.All)}),alwaysShowTimestamps:!0,layout:nr.a.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!1,className:"mx_RoomView_messagePanel mx_GroupLayout",membersLoaded:!0,permalinkCreator:d,disableGrouping:!0}):o.a.createElement("div",{className:"mx_AutoHideScrollbar"},o.a.createElement(un.a,null))))};function Qc(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Xc(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Qc(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Qc(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Zc extends o.a.PureComponent{constructor(e){super(e),i()(this,"card",o.a.createRef()),i()(this,"onMeasurement",e=>{this.setState({narrow:e})}),this.state={narrow:!1}}render(){const e=o.a.createElement("div",{className:"mx_RightPanel_empty mx_NotificationPanel_empty"},o.a.createElement("h2",null,Object(N.a)("You're all caught up")),o.a.createElement("p",null,Object(N.a)("You have no visible notifications.")));let t;const a=Et.a.get().getNotifTimelineSet();return a?t=o.a.createElement(ar,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:a,showUrlPreview:!1,empty:e,alwaysShowTimestamps:!0,layout:nr.a.Group}):(Sa.a.error("No notifTimelineSet available!"),t=o.a.createElement(un.a,null)),o.a.createElement(Zn.b.Provider,{value:Xc(Xc({},this.context),{},{timelineRenderingType:Zn.a.Notification,narrow:this.state.narrow})},o.a.createElement(os,{className:"mx_NotificationPanel",onClose:this.props.onClose,withoutScrollContainer:!0},o.a.createElement(ir,{sensor:this.card.current,onMeasurement:this.onMeasurement}),t))}}i()(Zc,"contextType",Zn.b);var el=e=>{const t=l()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let a;return e.numUnreadMessages&&(a=o.a.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),o.a.createElement("div",{className:t},o.a.createElement(U.a,{className:"mx_JumpToBottomButton_scrollDown",title:Object(N.a)("Scroll to most recent messages"),onClick:e.onScrollToBottomClick}),a)};function tl(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function al(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?tl(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):tl(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class nl extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"layoutWatcherRef",void 0),i()(this,"timelinePanel",o.a.createRef()),i()(this,"card",o.a.createRef()),i()(this,"roomStoreToken",void 0),i()(this,"readReceiptsSettingWatcher",void 0),i()(this,"onRoomViewStoreUpdate",async e=>{const t={initialEventId:vt.a.instance.getInitialEventId(),isInitialEventHighlighted:vt.a.instance.isInitialEventHighlighted(),replyToEvent:vt.a.instance.getQuotingEvent()};this.setState(t)}),i()(this,"onAction",e=>{switch(e.action){case M.a.EditEvent:this.setState({editState:e.event?new jc(e.event):null},()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))})}}),i()(this,"onScroll",()=>{const e=this.timelinePanel.current;e&&(e.isAtEndOfLiveTimeline()?this.setState({atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.state.initialEventId&&this.state.isInitialEventHighlighted&&b.a.dispatch({action:M.a.ViewRoom,room_id:this.props.room.roomId,event_id:this.state.initialEventId,highlighted:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))}),i()(this,"onMeasurement",e=>{this.setState({narrow:e})}),i()(this,"jumpToLiveTimeline",()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?b.a.dispatch({action:M.a.ViewRoom,room_id:this.props.room.roomId}):(null===(e=this.timelinePanel.current)||void 0===e||e.jumpToLiveTimeline(),b.a.fire(M.a.FocusSendMessageComposer))}),i()(this,"renderTimelineCardHeader",()=>o.a.createElement("div",{className:"mx_TimelineCard__header"},o.a.createElement("span",null,Object(N.a)("Chat")))),this.state={showReadReceipts:v.b.getValue("showReadReceipts",e.room.roomId),layout:v.b.getValue("layout"),atEndOfLiveTimeline:!0,narrow:!1},this.readReceiptsSettingWatcher=null}componentDidMount(){var e=this;this.roomStoreToken=vt.a.instance.addListener(this.onRoomViewStoreUpdate),this.dispatcherRef=b.a.register(this.onAction),this.readReceiptsSettingWatcher=v.b.watchSetting("showReadReceipts",null,(function(){for(var t=arguments.length,a=new Array(t),n=0;n<t;n++)a[n]=arguments[n];let[,,,i]=a;return e.setState({showReadReceipts:i})})),this.layoutWatcherRef=v.b.watchSetting("layout",null,(function(){for(var t=arguments.length,a=new Array(t),n=0;n<t;n++)a[n]=arguments[n];let[,,,i]=a;return e.setState({layout:i})}))}componentWillUnmount(){var e;null===(e=this.roomStoreToken)||void 0===e||e.remove(),this.readReceiptsSettingWatcher&&v.b.unwatchSetting(this.readReceiptsSettingWatcher),this.layoutWatcherRef&&v.b.unwatchSetting(this.layoutWatcherRef),b.a.unregister(this.dispatcherRef)}render(){var e;const t=this.state.isInitialEventHighlighted?this.state.initialEventId:null,a=l()({mx_RoomView_messagePanel:!0,mx_GroupLayout:this.state.layout===nr.a.Group});let n;this.state.atEndOfLiveTimeline||(n=o.a.createElement(el,{highlight:this.props.room.getUnreadNotificationCount(pe.a.Highlight)>0,onScrollToBottomClick:this.jumpToLiveTimeline}));const i=Di.a.sharedInstance().getCurrentUploads(this.props.composerRelation).length>0,s="join"===this.props.room.getMyMembership();return o.a.createElement(Zn.b.Provider,{value:al(al({},this.context),{},{timelineRenderingType:null!==(e=this.props.timelineRenderingType)&&void 0!==e?e:this.context.timelineRenderingType,liveTimeline:this.props.timelineSet.getLiveTimeline(),narrow:this.state.narrow})},o.a.createElement(os,{className:this.props.classNames,onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderTimelineCardHeader(),ref:this.card},o.a.createElement(ir,{sensor:this.card.current,onMeasurement:this.onMeasurement}),o.a.createElement("div",{className:"mx_TimelineCard_timeline"},n,o.a.createElement(ar,{ref:this.timelinePanel,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!1,sendReadReceiptOnLoad:!0,timelineSet:this.props.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===nr.a.Bubble?nr.a.Bubble:nr.a.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:a,permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:this.state.initialEventId,resizeNotifier:this.props.resizeNotifier,highlightedEventId:t,onScroll:this.onScroll})),i&&o.a.createElement(Pc,{room:this.props.room,relation:this.props.composerRelation}),s&&o.a.createElement(Rc,{room:this.props.room,relation:this.props.composerRelation,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}function il(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}i()(nl,"contextType",Zn.b);class sl extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"delayedUpdate",Object(x.throttle)(()=>{this.forceUpdate()},500,{leading:!0,trailing:!0})),i()(this,"onRoomStateMember",(e,t,a)=>{this.props.room&&a.roomId===this.props.room.roomId&&(this.state.phase===ts.a.RoomMemberList&&a.roomId===this.props.room.roomId||this.state.phase===ts.a.RoomMemberInfo&&a.roomId===this.props.room.roomId&&a.userId===this.state.cardState.member.userId)&&this.delayedUpdate()}),i()(this,"onRightPanelStoreUpdate",()=>{this.setState(function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?il(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):il(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({},sl.getDerivedStateFromProps(this.props)))}),i()(this,"onClose",()=>{var e,t,a;null!==(e=this.props.overwriteCard)&&void 0!==e&&null!==(t=e.state)&&void 0!==t&&t.member?b.a.dispatch({action:M.a.ViewHomePage}):this.state.phase===ts.a.EncryptionPanel&&null!==(a=this.state.cardState.verificationRequest)&&void 0!==a&&a.pending?this.state.cardState.verificationRequest.cancel():as.a.instance.togglePanel()}),i()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e})}),this.state={searchQuery:""}}componentDidMount(){this.context.on(m.b.Members,this.onRoomStateMember),as.a.instance.on(L.b,this.onRightPanelStoreUpdate)}componentWillUnmount(){var e;null===(e=this.context)||void 0===e||e.removeListener(m.b.Members,this.onRoomStateMember),as.a.instance.off(L.b,this.onRightPanelStoreUpdate)}static getDerivedStateFromProps(e){var t,a,n;let i;return e.room&&(i=as.a.instance.currentCardForRoom(e.room.roomId)),null!==(t=i)&&void 0!==t&&t.phase&&!as.a.instance.isPhaseValid(i.phase,!!e.room)?null:{cardState:null===(a=i)||void 0===a?void 0:a.state,phase:null===(n=i)||void 0===n?void 0:n.phase}}render(){var e,t,a,n,i;let s=o.a.createElement("div",null);const r=null===(e=this.props.room)||void 0===e?void 0:e.roomId,c=null!==(t=null===(a=this.props.overwriteCard)||void 0===a?void 0:a.phase)&&void 0!==t?t:this.state.phase,l=null!==(n=null===(i=this.props.overwriteCard)||void 0===i?void 0:i.state)&&void 0!==n?n:this.state.cardState;switch(c){case ts.a.RoomMemberList:r&&(s=o.a.createElement(so,{roomId:r,key:r,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged}));break;case ts.a.SpaceMemberList:s=o.a.createElement(so,{roomId:l.spaceId?l.spaceId:r,key:l.spaceId?l.spaceId:r,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged});break;case ts.a.RoomMemberInfo:case ts.a.SpaceMemberInfo:case ts.a.EncryptionPanel:{var d;const e=l.member instanceof es.a?l.member:void 0;s=o.a.createElement(Vo,{user:l.member,room:null!==(d=this.context.getRoom(null==e?void 0:e.roomId))&&void 0!==d?d:this.props.room,key:r||l.member.userId,onClose:this.onClose,phase:c,verificationRequest:l.verificationRequest,verificationRequestPromise:l.verificationRequestPromise});break}case ts.a.Room3pidMemberInfo:case ts.a.Space3pidMemberInfo:s=o.a.createElement(Wo,{event:l.memberInfoEvent,key:r});break;case ts.a.NotificationPanel:s=o.a.createElement(Zc,{onClose:this.onClose});break;case ts.a.PinnedMessages:v.b.getValue("feature_pinning")&&(s=o.a.createElement(ks,{room:this.props.room,onClose:this.onClose}));break;case ts.a.Timeline:s=o.a.createElement(nl,{classNames:"mx_ThreadPanel mx_TimelineCard",room:this.props.room,timelineSet:this.props.room.getUnfilteredTimelineSet(),resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus});break;case ts.a.FilePanel:s=o.a.createElement(cr,{roomId:r,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose});break;case ts.a.ThreadView:s=o.a.createElement(Vc,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,mxEvent:l.threadHeadEvent,initialEvent:l.initialEvent,isInitialEventHighlighted:l.isInitialEventHighlighted,initialEventScrollIntoView:l.initialEventScrollIntoView,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus});break;case ts.a.ThreadPanel:s=o.a.createElement($c,{roomId:r,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator});break;case ts.a.RoomSummary:s=o.a.createElement(Js,{room:this.props.room,onClose:this.onClose});break;case ts.a.Widget:s=o.a.createElement($s,{room:this.props.room,widgetId:l.widgetId,onClose:this.onClose})}return o.a.createElement("aside",{className:"mx_RightPanel dark-panel",id:"mx_RightPanel"},s)}}i()(sl,"contextType",j.a);class ol{constructor(){i()(this,"scrollStateMap",new Map)}getScrollState(e){return this.scrollStateMap.get(e)}setScrollState(e,t){this.scrollStateMap.set(e,t)}}void 0===window.mxRoomScrollStateStore&&(window.mxRoomScrollStateStore=new ol);var rl=window.mxRoomScrollStateStore,cl=a(336),ll=a(401),dl=a(416),ml=a(247),hl=a(158);class ul extends o.a.PureComponent{constructor(e){super(e),i()(this,"onViewClick",()=>{this.setState({hidden:!1})}),this.state={hidden:!0}}render(){const e=l()({mx_InviteReason:!0,mx_InviteReason_hidden:this.state.hidden});return o.a.createElement("div",{className:e},o.a.createElement("div",{className:"mx_InviteReason_reason"},this.props.htmlReason?Object(hl.h)(this.props.htmlReason):this.props.reason),o.a.createElement("div",{className:"mx_InviteReason_view",onClick:this.onViewClick},Object(N.a)("View message")))}}var pl;!function(e){e.NotLoggedIn="NotLoggedIn",e.Joining="Joining",e.Loading="Loading",e.Rejecting="Rejecting",e.Kicked="Kicked",e.Banned="Banned",e.OtherThreePIDError="OtherThreePIDError",e.InvitedEmailNotFoundInAccount="InvitedEmailNotFoundInAccount",e.InvitedEmailNoIdentityServer="InvitedEmailNoIdentityServer",e.InvitedEmailMismatch="InvitedEmailMismatch",e.Invite="Invite",e.ViewingRoom="ViewingRoom",e.RoomNotFound="RoomNotFound",e.OtherError="OtherError"}(pl||(pl={}));class gl extends o.a.Component{constructor(e){super(e),i()(this,"onLoginClick",()=>{b.a.dispatch({action:"start_login",screenAfterLogin:this.makeScreenAfterLogin()})}),i()(this,"onRegisterClick",()=>{b.a.dispatch({action:"start_registration",screenAfterLogin:this.makeScreenAfterLogin()})}),this.state={busy:!1}}componentDidMount(){this.checkInvitedEmail()}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this.checkInvitedEmail()}async checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await Et.a.get().getThreePids();if(this.setState({accountEmails:e.threepids.filter(e=>"email"===e.medium).map(e=>e.address)}),!Et.a.get().getIdentityServerUrl())return void this.setState({busy:!1});const t=new ml.a,a=await t.getAccessToken(),n=await Et.a.get().lookupThreePid("email",this.props.invitedEmail,void 0,a);this.setState({invitedEmailMxid:n.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}getMessageCase(){if(Et.a.get().isGuest())return pl.NotLoggedIn;const e=this.getMyMember();if(e){if(e.isKicked())return pl.Kicked;if("ban"===e.membership)return pl.Banned}if(this.props.joining)return pl.Joining;if(this.props.rejecting)return pl.Rejecting;if(this.props.loading||this.state.busy)return pl.Loading;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return pl.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return pl.InvitedEmailNotFoundInAccount;if(!Et.a.get().getIdentityServerUrl())return pl.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=Et.a.get().getUserId())return pl.InvitedEmailMismatch}return pl.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?pl.RoomNotFound:pl.OtherError:pl.ViewingRoom}getKickOrBanInfo(){const e=this.getMyMember();if(!e)return{};const t=this.props.room.currentState.getMember(e.events.member.getSender());return{memberName:t?t.name:e.events.member.getSender(),reason:e.events.member.getContent().reason}}joinRule(){var e,t;return null===(e=this.props.room)||void 0===e||null===(t=e.currentState.getStateEvents(ge.b.RoomJoinRules,""))||void 0===t?void 0:t.getContent().join_rule}getMyMember(){var e;return null===(e=this.props.room)||void 0===e?void 0:e.getMember(Et.a.get().getUserId())}getInviteMember(){const{room:e}=this.props;if(!e)return;const t=Et.a.get().getUserId(),a=e.currentState.getMember(t);if(!a)return;const n=a.events.member.getSender();return e.currentState.getMember(n)}isDMInvite(){const e=this.getMyMember();if(!e)return!1;const t=e.events.member.getContent();return"invite"===t.membership&&t.is_direct}makeScreenAfterLogin(){return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:this.props.oobData?this.props.oobData.room_name:null,room_avatar_url:this.props.oobData?this.props.oobData.avatarUrl:null,inviter_name:this.props.oobData?this.props.oobData.inviterName:null}}}render(){var e,t,a,n,i,s;const r=P.b.get().brand,c=null!==(e=null!==(t=null===(a=this.props.room)||void 0===a?void 0:a.name)&&void 0!==t?t:this.props.roomAlias)&&void 0!==e?e:"",d=null!==(n=null===(i=this.props.room)||void 0===i?void 0:i.isSpaceRoom())&&void 0!==n?n:(null===(s=this.props.oobData)||void 0===s?void 0:s.roomType)===ge.f.Space;let m,h,u,p,g,b,f,E,y=!1;const _=[],S=this.getMessageCase();switch(S){case pl.Joining:var w;m=null!==(w=this.props.oobData)&&void 0!==w&&w.roomType||d?d?Object(N.a)("Joining space …"):Object(N.a)("Joining room …"):Object(N.a)("Joining …"),y=!0;break;case pl.Loading:m=Object(N.a)("Loading …"),y=!0;break;case pl.Rejecting:m=Object(N.a)("Rejecting invite …"),y=!0;break;case pl.NotLoggedIn:m=Object(N.a)("Join the conversation with an account"),v.b.getValue(Oe.b.Registration)&&(g=Object(N.a)("Sign Up"),p=this.onRegisterClick),f=Object(N.a)("Sign In"),b=this.onLoginClick,this.props.previewLoading&&(E=o.a.createElement("div",null,o.a.createElement(un.a,{w:20,h:20}),Object(N.a)("Loading preview")));break;case pl.Kicked:{const{memberName:e,reason:t}=this.getKickOrBanInfo();m=c?Object(N.a)("You were removed from %(roomName)s by %(memberName)s",{memberName:e,roomName:c}):Object(N.a)("You were removed by %(memberName)s",{memberName:e}),h=t?Object(N.a)("Reason: %(reason)s",{reason:t}):null,g=d?Object(N.a)("Forget this space"):Object(N.a)("Forget this room"),p=this.props.onForgetClick,this.joinRule()!==Pi.c.Invite&&(f=g,b=p,g=Object(N.a)("Re-join"),p=this.props.onJoinClick);break}case pl.Banned:{const{memberName:e,reason:t}=this.getKickOrBanInfo();m=c?Object(N.a)("You were banned from %(roomName)s by %(memberName)s",{memberName:e,roomName:c}):Object(N.a)("You were banned by %(memberName)s",{memberName:e}),h=t?Object(N.a)("Reason: %(reason)s",{reason:t}):null,g=d?Object(N.a)("Forget this space"):Object(N.a)("Forget this room"),p=this.props.onForgetClick;break}case pl.OtherThreePIDError:{m=c?Object(N.a)("Something went wrong with your invite to %(roomName)s",{roomName:c}):Object(N.a)("Something went wrong with your invite.");const e=this.joinRule(),t=Object(N.a)("An error (%(errcode)s) was returned while trying to validate your invite. You could try to pass this information on to the person who invited you.",{errcode:this.state.threePidFetchError.errcode||Object(N.a)("unknown error code")});switch(e){case"invite":h=[Object(N.a)("You can only join it with a working invite."),t],g=Object(N.a)("Try to join anyway"),p=this.props.onJoinClick;break;case"public":h=Object(N.a)("You can still join here."),g=Object(N.a)("Join the discussion"),p=this.props.onJoinClick;break;default:h=t,g=Object(N.a)("Try to join anyway"),p=this.props.onJoinClick}break}case pl.InvitedEmailNotFoundInAccount:m=c?Object(N.a)("This invite to %(roomName)s was sent to %(email)s which is not associated with your account",{roomName:c,email:this.props.invitedEmail}):Object(N.a)("This invite was sent to %(email)s which is not associated with your account",{email:this.props.invitedEmail}),h=Object(N.a)("Link this email with your account in Settings to receive invites directly in %(brand)s.",{brand:r}),g=Object(N.a)("Join the discussion"),p=this.props.onJoinClick;break;case pl.InvitedEmailNoIdentityServer:m=c?Object(N.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:c,email:this.props.invitedEmail}):Object(N.a)("This invite was sent to %(email)s",{email:this.props.invitedEmail}),h=Object(N.a)("Use an identity server in Settings to receive invites directly in %(brand)s.",{brand:r}),g=Object(N.a)("Join the discussion"),p=this.props.onJoinClick;break;case pl.InvitedEmailMismatch:m=c?Object(N.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:c,email:this.props.invitedEmail}):Object(N.a)("This invite was sent to %(email)s",{email:this.props.invitedEmail}),h=Object(N.a)("Share this email in Settings to receive invites directly in %(brand)s.",{brand:r}),g=Object(N.a)("Join the discussion"),p=this.props.onJoinClick;break;case pl.Invite:{const e=o.a.createElement(Ie.a,{room:this.props.room,oobData:this.props.oobData}),t=this.getInviteMember();let a;a=t?o.a.createElement("span",null,o.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},t.rawDisplayName)," (",t.userId,")"):o.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},this.props.inviterName);this.isDMInvite()?(m=Object(N.a)("Do you want to chat with %(user)s?",{user:t.name}),h=[e,Object(N.a)("<userName/> wants to chat",{},{userName:()=>a})],g=Object(N.a)("Start chatting")):(m=Object(N.a)("Do you want to join %(roomName)s?",{roomName:c}),h=[e,Object(N.a)("<userName/> invited you",{},{userName:()=>a})],g=Object(N.a)("Accept"));const n=Et.a.get().getUserId(),i=this.props.room.currentState.getMember(n).events.member.getContent();i.reason&&(u=o.a.createElement(ul,{reason:i.reason,htmlReason:i["io.element.html_reason"]})),p=this.props.onJoinClick,f=Object(N.a)("Reject"),b=this.props.onRejectClick,this.props.onRejectAndIgnoreClick&&_.push(o.a.createElement(U.a,{kind:"secondary",onClick:this.props.onRejectAndIgnoreClick,key:"ignore"},Object(N.a)("Reject & Ignore user")));break}case pl.ViewingRoom:m=this.props.canPreview?Object(N.a)("You're previewing %(roomName)s. Want to join it?",{roomName:c}):c?Object(N.a)("%(roomName)s can't be previewed. Do you want to join it?",{roomName:c}):Object(N.a)("There's no preview, would you like to join?"),g=Object(N.a)("Join the discussion"),p=this.props.onJoinClick;break;case pl.RoomNotFound:m=c?Object(N.a)("%(roomName)s does not exist.",{roomName:c}):Object(N.a)("This room or space does not exist."),h=Object(N.a)("Are you sure you're at the right place?");break;case pl.OtherError:m=c?Object(N.a)("%(roomName)s is not accessible at this time.",{roomName:c}):Object(N.a)("This room or space is not accessible at this time."),h=[Object(N.a)("Try again later, or ask a room or space admin to check if you have access."),Object(N.a)("%(errcode)s was returned while trying to access the room or space. If you think you're seeing this message in error, please <issueLink>submit a bug report</issueLink>.",{errcode:this.props.error.errcode},{issueLink:e=>o.a.createElement("a",{href:"https://github.com/vector-im/element-web/issues/new/choose",target:"_blank",rel:"noreferrer noopener"},e)})]}let C,O,k,x;h&&(Array.isArray(h)||(h=[h]),C=h.map((e,t)=>o.a.createElement("p",{key:"subTitle"+t},e))),O=y?o.a.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},o.a.createElement(un.a,null),m):o.a.createElement("h3",null,m),p&&(k=o.a.createElement(U.a,{kind:"primary",onClick:p},g)),b&&(x=o.a.createElement(U.a,{kind:"secondary",onClick:b},f));const R=this.props.canPreview,j=l()("mx_RoomPreviewBar","dark-panel","mx_RoomPreviewBar_"+S,{mx_RoomPreviewBar_panel:R,mx_RoomPreviewBar_dialog:!R}),I=R?o.a.createElement(o.a.Fragment,null,x,_,k):o.a.createElement(o.a.Fragment,null,k,_,x);return o.a.createElement("div",{className:j},o.a.createElement("div",{className:"mx_RoomPreviewBar_message"},O,C),u,o.a.createElement("div",{className:"mx_RoomPreviewBar_actions"},I),o.a.createElement("div",{className:"mx_RoomPreviewBar_footer"},E))}}i()(gl,"defaultProps",{onJoinClick(){}});var bl=a(217),vl=a(813);function fl(e){let{as:t="div",children:a,onClick:n}=e;const i=Object(s.useRef)();return Object(s.useLayoutEffect)(()=>{Object(hl.g)(i.current)},[a]),o.a.createElement(t,{children:a,ref:i,onClick:n})}const El=["room"];function yl(e){let{room:t}=e,a=Ee()(e,El);const n=Object(s.useContext)(j.a),i=Object(s.useRef)(),r=Object(vl.b)(t),c=Object(s.useCallback)(e=>{var t;null===(t=a.onClick)||void 0===t||t.call(a,e);"A"!==e.target.tagName.toUpperCase()&&b.a.fire(M.a.ShowRoomTopic)},[a]);Object(Mt.a)(b.a,e=>{if(e.action===M.a.ShowRoomTopic){const e=t.currentState.maySendStateEvent(ge.b.RoomTopic,n.getUserId()),a=gt.a.createDialog(wt.a,{title:t.name,description:o.a.createElement("div",null,o.a.createElement(fl,{as:"p",onClick:e=>{"A"===e.target.tagName.toUpperCase()&&a.close()}},r),e&&o.a.createElement(U.a,{kind:"primary_outline",onClick:()=>{a.close(),b.a.dispatch({action:"open_room_settings"})}},Object(N.a)("Edit topic"))),hasCloseButton:!0,button:!1})}});const d=l()(a.className,"mx_RoomTopic");return o.a.createElement("div",ue()({},a,{ref:i,onClick:c,dir:"auto",className:d}),o.a.createElement(Gt.a,{label:Object(N.a)("Click to read topic"),alignment:za.a.Bottom,ignoreHover:e=>"A"===e.target.tagName.toUpperCase()},o.a.createElement(fl,null,r)))}const _l=["members","faceSize","overflow","tooltip","children"];var Sl=e=>{let{members:t,faceSize:a,overflow:n,tooltip:i,children:s}=e,r=Ee()(e,_l);const c=t.map(i?e=>o.a.createElement(Oa.a,{key:e.userId,member:e,width:a,height:a,hideTitle:!0}):e=>o.a.createElement(Gt.a,{key:e.userId,label:e.name},o.a.createElement(Oa.a,{member:e,width:a,height:a,viewUserOnClick:!r.onClick,hideTitle:!0}))),l=o.a.createElement(o.a.Fragment,null,n?o.a.createElement("span",{className:"mx_FacePile_more"}):null,c);return o.a.createElement("div",ue()({},r,{className:"mx_FacePile"}),i?o.a.createElement(ln.a,{class:"mx_FacePile_faces",tooltip:i},l):o.a.createElement("div",{className:"mx_FacePile_faces"},l),s)};const wl=["room","onlyKnownUsers","numShown"],Cl=5,Ol=e=>{var t;return!(null===(t=cs.a.shared().getDMRoomsForUserId(e.userId))||void 0===t||!t.length)};var kl=e=>{let{room:t,onlyKnownUsers:a=!0,numShown:n=Cl}=e,i=Ee()(e,wl);const r=Object(s.useContext)(j.a),c="join"===t.getMyMembership();let l=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250;const[a,n]=Object(s.useState)(e.getJoinedMembers());return Object(F.c)(e.currentState,m.b.Update,Object(x.throttle)(()=>{n(e.getJoinedMembers())},t,{leading:!0,trailing:!0})),a}(t);const d=l.length,h=[e=>e.getMxcAvatarUrl()?0:1];a?l=l.filter(Ol):h.unshift(e=>Ol(e)?0:1);const u=Object(x.sortBy)(l.filter(e=>e.userId!==r.getUserId()),h).slice(0,n);if(u.length<1)return null;const p=u.map(e=>e.name).reverse().join(", "),g=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Tooltip_title"},i.onClick?Object(N.a)("View all %(count)s members",{count:d}):Object(N.a)("%(count)s members",{count:d})),o.a.createElement("div",{className:"mx_Tooltip_sub"},c?Object(N.a)("Including you, %(commaSeparatedMembers)s",{commaSeparatedMembers:p}):Object(N.a)("Including %(commaSeparatedMembers)s",{commaSeparatedMembers:p})));return o.a.createElement(Sl,ue()({members:u,faceSize:28,overflow:l.length>n,tooltip:g},i),a&&o.a.createElement("span",{className:"mx_FacePile_summary"},Object(N.a)("%(count)s people you know have already joined",{count:l.length})))};var xl=e=>{let{room:t}=e;const a=Object(ps.a)(async()=>{if("invite"!==t.getMyMembership())return null;try{return t.client.getRoomSummary(t.roomId)}catch(e){return null}},[t]),n=Object(ys.a)(t,e=>e.getJoinRule()),i=ms(t),s=ds(t);let r,c,l;if(t.isElementVideoRoom()?(r="mx_RoomInfoLine_video",c=Object(N.a)("Video room")):n===Pi.c.Public?(r="mx_RoomInfoLine_public",c=t.isSpaceRoom()?Object(N.a)("Public space"):Object(N.a)("Public room")):(r="mx_RoomInfoLine_private",c=t.isSpaceRoom()?Object(N.a)("Private space"):Object(N.a)("Private room")),"invite"===i&&a)l=o.a.createElement("span",{className:"mx_RoomInfoLine_members"},Object(N.a)("%(count)s members",{count:a.num_joined_members}));else if(s&&void 0!==a){const e=()=>as.a.instance.setCard({phase:t.isSpaceRoom()?ts.a.SpaceMemberList:ts.a.RoomMemberList});l=o.a.createElement(U.a,{kind:"link",className:"mx_RoomInfoLine_members",onClick:e},Object(N.a)("%(count)s members",{count:s}))}return o.a.createElement("div",{className:"mx_RoomInfoLine "+r},c,l)};var Rl=e=>{let{room:t,onJoinButtonClicked:a,onRejectButtonClicked:n}=e;const i=Object(s.useContext)(j.a),r=Object(be.a)("feature_video_rooms"),c=ms(t);Object(Mt.a)(b.a,e=>{e.action===M.a.JoinRoomError&&e.roomId===t.roomId&&d(!1)});const[l,d]=Object(s.useState)(!1),m=Object(ys.a)(t,e=>e.getJoinRule()),h=Object(bl.b)(c)===bl.a.Leave&&m!==Pi.c.Public,u=()=>b.a.dispatch({action:M.a.ViewUserSettings,initialTabId:Ge.a.Labs});let p,g,v,f;if("join"===c)g=o.a.createElement(U.a,{kind:"danger_outline",onClick:()=>{b.a.dispatch({action:"leave_room",room_id:t.roomId})}},Object(N.a)("Leave"));else if("invite"===c){var E,y;const e=null===(E=t.getMember(i.getUserId()))||void 0===E||null===(y=E.events.member)||void 0===y?void 0:y.getSender(),s=e&&t.getMember(e);e&&(p=o.a.createElement("div",{className:"mx_RoomPreviewCard_inviter"},o.a.createElement(Oa.a,{member:s,fallbackUserId:e,width:32,height:32}),o.a.createElement("div",null,o.a.createElement("div",{className:"mx_RoomPreviewCard_inviter_name"},Object(N.a)("<inviter/> invites you",{},{inviter:()=>o.a.createElement("b",null,(null==s?void 0:s.name)||e)})),s?o.a.createElement("div",{className:"mx_RoomPreviewCard_inviter_mxid"},e):null))),g=o.a.createElement(o.a.Fragment,null,o.a.createElement(U.a,{kind:"secondary",onClick:()=>{d(!0),n()}},Object(N.a)("Reject")),o.a.createElement(U.a,{kind:"primary",onClick:()=>{d(!0),a()}},Object(N.a)("Accept")))}else g=o.a.createElement(U.a,{kind:"primary",onClick:()=>{a(),i.isGuest()||d(!0)},disabled:h},Object(N.a)("Join"));return l&&(g=o.a.createElement(Kt.a,null)),v=t.isElementVideoRoom()?o.a.createElement(o.a.Fragment,null,o.a.createElement(Ie.a,{room:t,height:50,width:50,viewAvatarOnClick:!0}),o.a.createElement("div",{className:"mx_RoomPreviewCard_video"})):t.isSpaceRoom()?o.a.createElement(Ie.a,{room:t,height:80,width:80,viewAvatarOnClick:!0}):o.a.createElement(Ie.a,{room:t,height:50,width:50,viewAvatarOnClick:!0}),h?f=Object(N.a)("To view %(roomName)s, you need an invite",{roomName:t.name}):t.isElementVideoRoom()&&!r&&(f="join"===c?Object(N.a)("To view, please enable video rooms in Labs first"):Object(N.a)("To join, please enable video rooms in Labs first"),g=o.a.createElement(U.a,{kind:"primary",onClick:u},Object(N.a)("Show Labs settings"))),o.a.createElement("div",{className:"mx_RoomPreviewCard"},p,o.a.createElement("div",{className:"mx_RoomPreviewCard_avatar"},v),o.a.createElement("h1",{className:"mx_RoomPreviewCard_name"},o.a.createElement(xs.a,{room:t})),o.a.createElement(xl,{room:t}),o.a.createElement(yl,{room:t,className:"mx_RoomPreviewCard_topic"}),"public"===t.getJoinRule()&&o.a.createElement(kl,{room:t}),f?o.a.createElement("div",{className:"mx_RoomPreviewCard_notice"},f):null,o.a.createElement("div",{className:"mx_RoomPreviewCard_joinButtons"},g))};let jl;!function(e){e.Room="Room",e.All="All"}(jl||(jl={}));class Il extends o.a.Component{constructor(e){super(e),i()(this,"searchTerm",Object(s.createRef)()),i()(this,"onThisRoomClick",()=>{this.setState({scope:jl.Room},()=>this.searchIfQuery())}),i()(this,"onAllRoomsClick",()=>{this.setState({scope:jl.All},()=>this.searchIfQuery())}),i()(this,"onSearchChange",e=>{switch(Object(le.a)().getAccessibilityAction(e)){case Ue.h.Enter:this.onSearch();break;case Ue.h.Escape:this.props.onCancelClick()}}),i()(this,"onSearch",()=>{this.searchTerm.current.value.trim()&&this.props.onSearch(this.searchTerm.current.value,this.state.scope)}),this.state={scope:jl.Room}}searchIfQuery(){this.searchTerm.current.value&&this.onSearch()}render(){const e=l()("mx_SearchBar_searchButton",{mx_SearchBar_searching:this.props.searchInProgress}),t=l()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==jl.Room}),a=l()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==jl.All});return o.a.createElement(o.a.Fragment,null,o.a.createElement(W.a,{screenName:"RoomSearch"}),o.a.createElement("div",{className:"mx_SearchBar"},o.a.createElement("div",{className:"mx_SearchBar_buttons",role:"radiogroup"},o.a.createElement(U.a,{className:t,onClick:this.onThisRoomClick,"aria-checked":this.state.scope===jl.Room,role:"radio"},Object(N.a)("This Room")),o.a.createElement(U.a,{className:a,onClick:this.onAllRoomsClick,"aria-checked":this.state.scope===jl.All,role:"radio"},Object(N.a)("All Rooms"))),o.a.createElement("div",{className:"mx_SearchBar_input mx_textinput"},o.a.createElement("input",{ref:this.searchTerm,type:"text",autoFocus:!0,placeholder:Object(N.a)("Search…"),onKeyDown:this.onSearchChange}),o.a.createElement(U.a,{className:e,onClick:this.onSearch})),o.a.createElement(U.a,{className:"mx_SearchBar_cancel",onClick:this.props.onCancelClick})),o.a.createElement(Ko,{isRoomEncrypted:this.props.isRoomEncrypted,kind:zo.Search}))}}var Tl,Nl=a(796);class Pl extends o.a.PureComponent{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"onStateEvents",e=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const t=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:t&&t.getContent().replacement_room})}),i()(this,"onUpgradeClick",()=>{gt.a.createTrackedDialog("Upgrade Room Version","",Nl.a,{room:this.props.room})});const a=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.state={upgraded:null==a?void 0:a.getContent().replacement_room}}componentDidMount(){this.context.on(m.b.Events,this.onStateEvents)}componentWillUnmount(){this.context.removeListener(m.b.Events,this.onStateEvents)}render(){let e=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.a.createElement("p",null,Object(N.a)("Upgrading this room will shut down the current instance of the room and create an upgraded room with the same name.")),o.a.createElement("p",null,Object(N.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>o.a.createElement("b",null,e),i:e=>o.a.createElement("i",null,e)}))),o.a.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},o.a.createElement(U.a,{onClick:this.onUpgradeClick},Object(N.a)("Upgrade this room to the recommended room version"))));return this.state.upgraded&&(e=o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.a.createElement("p",null,Object(N.a)("This room has already been upgraded.")))),o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar"},o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},Object(N.a)("This room is running room version <roomVersion />, which this homeserver has marked as <i>unstable</i>.",{},{roomVersion:()=>o.a.createElement("code",null,this.props.room.getVersion()),i:e=>o.a.createElement("i",null,e)})),e,o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},Object(N.a)("Only room administrators will see this warning"))))}}function Ml(e,t){const a=Object(xn.a)(e.data);a.response=t,e.source.postMessage(a,e.origin)}function Dl(e,t,a){Sa.a.error("Action:"+e.data.action+" failed with message: "+t);const n=Object(xn.a)(e.data);n.response={error:{message:t}},a&&(n.response.error._error=a),e.source.postMessage(n,e.origin)}function Al(e,t){const a=e.data.widget_id;let n=e.data.type;const i=e.data.url,s=e.data.name,o=e.data.data,r=e.data.avatar_url,c=e.data.userWidget;if(a&&void 0!==i){if(null!==i){if(void 0!==s&&"string"!=typeof s)return void Dl(e,Object(N.a)("Unable to create widget."),new Error("Optional field 'name' must be a string."));if(void 0!==o&&!(o instanceof Object))return void Dl(e,Object(N.a)("Unable to create widget."),new Error("Optional field 'data' must be an Object."));if(void 0!==r&&"string"!=typeof r)return void Dl(e,Object(N.a)("Unable to create widget."),new Error("Optional field 'avatar_url' must be a string."));if("string"!=typeof n)return void Dl(e,Object(N.a)("Unable to create widget."),new Error("Field 'type' must be a string."));if("string"!=typeof i)return void Dl(e,Object(N.a)("Unable to create widget."),new Error("Field 'url' must be a string or null."))}n=fn.a.fromString(n),c?sn.a.setUserWidget(a,n,i,s,o).then(()=>{Ml(e,{success:!0}),b.a.dispatch({action:"user_widget_updated"})}).catch(t=>{Dl(e,Object(N.a)("Unable to create widget."),t)}):(t||Dl(e,Object(N.a)("Missing roomId."),null),sn.a.setRoomWidget(t,a,n,i,s,o,r).then(()=>{Ml(e,{success:!0})},t=>{Dl(e,Object(N.a)("Failed to send request."),t)}))}else Dl(e,Object(N.a)("Unable to create widget."),new Error("Missing required widget fields."))}function Ul(e,t){const a=Et.a.get();if(!a)return void Dl(e,Object(N.a)("You need to be logged in."));let n=[];if(t){const i=a.getRoom(t);if(!i)return void Dl(e,Object(N.a)("This room is not recognised."));n=sn.a.getRoomWidgets(i).map(e=>e.event)}const i=sn.a.getUserWidgetsArray();n=n.concat(i),Ml(e,n)}function Ll(e,t,a,n){const i=Et.a.get();if(!i)return void Dl(e,Object(N.a)("You need to be logged in."));const s=i.getRoom(t);if(!s)return void Dl(e,Object(N.a)("This room is not recognised."));const o=s.currentState.getStateEvents(a,n);Ml(e,o?o.getContent():null)}i()(Pl,"contextType",j.a),function(e){e.CloseScalar="close_scalar",e.GetWidgets="get_widgets",e.SetWidget="set_widget",e.JoinRulesState="join_rules_state",e.SetPlumbingState="set_plumbing_state",e.GetMembershipCount="get_membership_count",e.GetRoomEncryptionState="get_room_enc_state",e.CanSendEvent="can_send_event",e.MembershipState="membership_state",e.invite="invite",e.BotOptions="bot_options",e.SetBotOptions="set_bot_options",e.SetBotPower="set_bot_power"}(Tl||(Tl={}));const Fl=function(e){let t,a;e.origin||(e.origin=e.originalEvent.origin);try{Vl||(Vl=Un.a.sharedInstance().getPrimaryManager().uiUrl),t=new URL(Vl)}catch(e){return}try{a=new URL(e.origin)}catch(e){return}if(t.origin!==a.origin||!e.data.action||e.data.api)return;if(e.data.action===Tl.CloseScalar)return b.a.dispatch({action:Tl.CloseScalar}),void Ml(e,null);const n=e.data.room_id,i=e.data.user_id;if(!n)return e.data.action===Tl.GetWidgets?void Ul(e,null):e.data.action===Tl.SetWidget?void Al(e,null):void Dl(e,Object(N.a)("Missing room_id in request"));if(n===vt.a.instance.getRoomId())if(e.data.action!==Tl.GetWidgets)if(e.data.action!==Tl.SetWidget)if(e.data.action!==Tl.JoinRulesState)if(e.data.action!==Tl.SetPlumbingState)if(e.data.action!==Tl.GetMembershipCount)if(e.data.action!==Tl.GetRoomEncryptionState)if(e.data.action!==Tl.CanSendEvent)if(i)switch(e.data.action){case Tl.MembershipState:!function(e,t,a){Sa.a.log(`membership_state of ${a} in room ${t} requested.`),Ll(e,t,"m.room.member",a)}(e,n,i);break;case Tl.invite:!function(e,t,a){Sa.a.log(`Received request to invite ${a} into room ${t}`);const n=Et.a.get();if(!n)return void Dl(e,Object(N.a)("You need to be logged in."));const i=n.getRoom(t);if(i){const t=i.getMember(a);if(t&&["join","invite"].includes(t.membership))return void Ml(e,{success:!0})}n.invite(t,a).then((function(){Ml(e,{success:!0})}),(function(t){Dl(e,Object(N.a)("You need to be able to invite users to do that."),t)}))}(e,n,i);break;case Tl.BotOptions:!function(e,t,a){Sa.a.log(`bot_options of ${a} in room ${t} requested.`),Ll(e,t,"m.room.bot.options","_"+a)}(e,n,i);break;case Tl.SetBotOptions:!function(e,t,a){Sa.a.log(`Received request to set options for bot ${a} in room ${t}`);const n=Et.a.get();n?n.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+a).then(()=>{Ml(e,{success:!0})},t=>{Dl(e,t.message?t.message:Object(N.a)("Failed to send request."),t)}):Dl(e,Object(N.a)("You need to be logged in."))}(e,n,i);break;case Tl.SetBotPower:!async function(e,t,a,n,i){if(!(Number.isInteger(n)&&n>=0))return void Dl(e,Object(N.a)("Power level must be positive integer."));Sa.a.log(`Received request to set power level to ${n} for bot ${a} in room ${t}.`);const s=Et.a.get();if(s)try{const l=await s.getStateEvent(t,"m.room.power_levels","");if(!0===i){var o,r,c;if((null!==(o=null!==(r=null===(c=l.users)||void 0===c?void 0:c[a])&&void 0!==r?r:l.users_default)&&void 0!==o?o:0)>=n)return Ml(e,{success:!0})}await s.setPowerLevel(t,a,n,new yn.b({type:"m.room.power_levels",content:l})),Ml(e,{success:!0})}catch(t){Dl(e,t.message?t.message:Object(N.a)("Failed to send request."),t)}else Dl(e,Object(N.a)("You need to be logged in."))}(e,n,i,e.data.level,e.data.ignoreIfGreater);break;default:Sa.a.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else Dl(e,Object(N.a)("Missing user_id in request"));else!function(e,t){const a=""+e.data.event_type,n=Boolean(e.data.is_state),i=Et.a.get();if(!i)return void Dl(e,Object(N.a)("You need to be logged in."));const s=i.getRoom(t);if(!s)return void Dl(e,Object(N.a)("This room is not recognised."));if("join"!==s.getMyMembership())return void Dl(e,Object(N.a)("You are not in this room."));const o=i.credentials.userId;let r=!1;r=n?s.currentState.maySendStateEvent(a,o):s.currentState.maySendEvent(a,o),r?Ml(e,!0):Dl(e,Object(N.a)("You do not have permission to do that in this room."))}(e,n);else!function(e,t){const a=Et.a.get();if(!a)return void Dl(e,Object(N.a)("You need to be logged in."));if(!a.getRoom(t))return void Dl(e,Object(N.a)("This room is not recognised."));Ml(e,Et.a.get().isRoomEncrypted(t))}(e,n);else!function(e,t){const a=Et.a.get();if(!a)return void Dl(e,Object(N.a)("You need to be logged in."));const n=a.getRoom(t);if(!n)return void Dl(e,Object(N.a)("This room is not recognised."));Ml(e,n.getJoinedMemberCount())}(e,n);else!function(e,t,a){if("string"!=typeof a)throw new Error("Plumbing state status should be a string");Sa.a.log(`Received request to set plumbing state to status "${a}" in room ${t}`);const n=Et.a.get();n?n.sendStateEvent(t,"m.room.plumbing",{status:a}).then(()=>{Ml(e,{success:!0})},t=>{Dl(e,t.message?t.message:Object(N.a)("Failed to send request."),t)}):Dl(e,Object(N.a)("You need to be logged in."))}(e,n,e.data.status);else!function(e,t){Sa.a.log(`join_rules of ${t} requested.`),Ll(e,t,"m.room.join_rules","")}(e,n);else Al(e,n);else Ul(e,n);else Dl(e,Object(N.a)("Room %(roomId)s not visible",{roomId:n}))};let Bl=0,Vl=null;var Wl=a(250);class Hl extends o.a.Component{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"resizeContainer",void 0),i()(this,"resizer",void 0),i()(this,"dispatcherRef",void 0),i()(this,"onIsResizing",e=>{this.setState({resizingVertical:e}),e||this.relaxResizer()}),i()(this,"collectResizer",e=>{this.resizeContainer&&this.resizer.detach(),e&&(this.resizer.container=e,this.resizer.attach()),this.resizeContainer=e,this.loadResizerPreferences()}),i()(this,"getAppsHash",e=>e.map(e=>e.id).join("~")),i()(this,"relaxResizer",()=>{const e=this.resizer.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())}),i()(this,"loadResizerPreferences",()=>{const e=ei.d.instance.getResizerDistributions(this.props.room,ei.a.Top);if(this.state.apps&&this.topApps().length-1===e.length)e.forEach((e,t)=>{const a=this.resizer.forHandleAt(t);a&&(a.size=e,a.finish())});else if(this.state.apps){const e=this.resizer.getDistributors();e.forEach(e=>e.item.clearSize()),e.forEach(e=>e.start()),e.forEach(e=>e.finish())}}),i()(this,"onAction",e=>{const t=this.props.room.roomId+"_hide_widget_drawer";switch(e.action){case"appsDrawer":e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")}}),i()(this,"getApps",()=>{const e={};return e[ei.a.Top]=ei.d.instance.getContainerWidgets(this.props.room,ei.a.Top),e[ei.a.Center]=ei.d.instance.getContainerWidgets(this.props.room,ei.a.Center),e}),i()(this,"topApps",()=>this.state.apps[ei.a.Top]),i()(this,"centerApps",()=>this.state.apps[ei.a.Center]),i()(this,"updateApps",()=>{this.unmounted||this.setState({apps:this.getApps()})}),this.state={apps:this.getApps(),resizingVertical:!1,resizingHorizontal:!1,resizing:!1},this.resizer=this.createResizer(),this.props.resizeNotifier.on("isResizing",this.onIsResizing)}componentDidMount(){0===Bl&&window.addEventListener("message",Fl,!1),Bl+=1,ei.d.instance.on(ei.d.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef=b.a.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,function(){if(Bl-=1,0===Bl&&window.removeEventListener("message",Fl),Bl<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");Sa.a.error(e)}}(),ei.d.instance.off(ei.d.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef&&b.a.unregister(this.dispatcherRef),this.resizeContainer&&this.resizer.detach(),this.props.resizeNotifier.off("isResizing",this.onIsResizing)}createResizer(){const e=new R(null,C,{onResizeStart:()=>{this.resizeContainer.classList.add("mx_AppsDrawer_resizing"),this.setState({resizingHorizontal:!0})},onResizeStop:()=>{this.resizeContainer.classList.remove("mx_AppsDrawer_resizing"),ei.d.instance.setResizerDistributions(this.props.room,ei.a.Top,this.topApps().slice(1).map((e,t)=>this.resizer.forHandleAt(t).size)),this.setState({resizingHorizontal:!1})}});return e.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),e}componentDidUpdate(e,t){e.userId!==this.props.userId||e.room!==this.props.room?this.updateApps():this.getAppsHash(this.topApps())!==this.getAppsHash(t.apps[ei.a.Top])&&this.loadResizerPreferences()}isResizing(){return this.state.resizingVertical||this.state.resizingHorizontal}render(){if(!this.props.showApps)return o.a.createElement("div",null);const e=this.centerApps().length>0,t=(e?this.centerApps():this.topApps()).map((e,t,a)=>o.a.createElement(di,{key:e.id,app:e,fullWidth:a.length<2,room:this.props.room,userId:this.props.userId,creatorUserId:e.creatorUserId,widgetPageTitle:sn.a.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,pointerEvents:this.isResizing()?"none":void 0}));if(0===t.length)return o.a.createElement("div",null);let a;0===t.length&&cl.a.roomHasPendingWidgets(this.props.room.roomId,sn.a.getRoomWidgets(this.props.room))&&(a=o.a.createElement(un.a,null));const n=l()({mx_AppsDrawer:!0,mx_AppsDrawer_maximise:e,mx_AppsDrawer_fullWidth:t.length<2,mx_AppsDrawer_resizing:this.state.resizing,mx_AppsDrawer_2apps:2===t.length,mx_AppsDrawer_3apps:3===t.length}),i=o.a.createElement("div",{className:"mx_AppsContainer",ref:this.collectResizer},t.map((e,a)=>a<1?e:o.a.createElement(o.a.Fragment,{key:e.key},o.a.createElement(E,{reverse:a>t.length/2}),e)));let s;return s=e?i:o.a.createElement(zl,{room:this.props.room,minHeight:100,maxHeight:this.props.maxHeight-50,handleClass:"mx_AppsContainer_resizerHandle",handleWrapperClass:"mx_AppsContainer_resizerHandleContainer",className:"mx_AppsContainer_resizer",resizeNotifier:this.props.resizeNotifier},i),o.a.createElement("div",{className:n},s,a)}}i()(Hl,"defaultProps",{showApps:!0});const zl=e=>{let{room:t,minHeight:a,maxHeight:n,className:i,handleWrapperClass:s,handleClass:r,resizeNotifier:c,children:l}=e,d=ei.d.instance.getContainerHeight(t,ei.a.Top);a||(a=100),n||(n=de.b.instance.windowHeight/4*3),d?(d=Object(Wl.a)(d,0,100),d=Object(Wl.d)(d/100,a,n)):d=280;const[m,h]=Us(d,e=>{e=100*Object(Wl.c)(e,a,n),ei.d.instance.setContainerHeight(t,ei.a.Top,e)});return o.a.createElement(Xi.Resizable,{size:{height:Math.min(m,n),width:void 0},minHeight:a,maxHeight:n,onResizeStart:()=>{c.startResizing()},onResize:()=>{c.notifyTimelineHeightChanged()},onResizeStop:(e,t,a,n)=>{h(m+n.height),c.stopResizing()},handleWrapperClass:s,handleClasses:{bottom:r},className:i,enable:{bottom:!0}},l)};class Kl extends o.a.Component{constructor(e){super(e),i()(this,"updateCall",()=>{const e=this.getCall();e!==this.state.call&&this.setState({call:e})}),i()(this,"onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),i()(this,"onResize",()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()}),i()(this,"onResizeStop",()=>{this.props.resizeNotifier.stopResizing()}),this.state={call:this.getCall()}}componentDidMount(){ne.b.instance.addListener(ne.a.CallState,this.updateCall),ne.b.instance.addListener(ne.a.CallChangeRoom,this.updateCall)}componentWillUnmount(){ne.b.instance.removeListener(ne.a.CallState,this.updateCall),ne.b.instance.removeListener(ne.a.CallChangeRoom,this.updateCall)}getCall(){const e=ne.b.instance.getCallForRoom(this.props.roomId);return e&&[_a.e.Ended,_a.e.Ringing].includes(e.state)?null:e}render(){return this.state.call?o.a.createElement("div",{className:"mx_CallViewForRoom"},o.a.createElement(Xi.Resizable,{minHeight:380,maxHeight:"80vh",enable:{top:!1,right:!1,bottom:!0,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_CallViewForRoom_ResizeWrapper",handleClasses:{bottom:"mx_CallViewForRoom_ResizeHandle"}},o.a.createElement(nn,{call:this.state.call,pipMode:!1,showApps:this.props.showApps}))):null}}class ql extends o.a.Component{constructor(e){super(e),i()(this,"onRoomStateEvents",e=>{"re.jki.counter"===e.getType()&&this.updateCounters()}),i()(this,"updateCounters",Object(x.throttle)(()=>{this.setState({counters:this.computeCounters()})},500,{leading:!0,trailing:!0})),this.state={counters:this.computeCounters()}}componentDidMount(){const e=Et.a.get();v.b.getValue("feature_state_counters")&&e.on(m.b.Events,this.onRoomStateEvents)}componentWillUnmount(){var e;v.b.getValue("feature_state_counters")&&(null===(e=Et.a.get())||void 0===e||e.removeListener(m.b.Events,this.onRoomStateEvents))}shouldComponentUpdate(e,t){return Object(xn.c)(this.props,e)||Object(xn.c)(this.state,t)}computeCounters(){const e=[];if(this.props.room&&v.b.getValue("feature_state_counters")){const t=this.props.room.currentState.getStateEvents("re.jki.counter");t.sort((e,t)=>Object(gn.v)(e.getStateKey(),t.getStateKey()));for(const a of t){const t=a.getContent().title,n=a.getContent().value,i=a.getContent().link,s=a.getContent().severity||"normal",o=a.getStateKey();t&&void 0!==n&&e.push({title:t,value:n,link:i,severity:s,stateKey:o})}}return e}render(){const e=o.a.createElement(Kl,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,showApps:this.props.showApps});let t;v.b.getValue(Oe.b.Widgets)&&(t=o.a.createElement(Hl,{room:this.props.room,userId:this.props.userId,showApps:this.props.showApps,resizeNotifier:this.props.resizeNotifier}));let a=null;if(this.state.counters&&v.b.getValue("feature_state_counters")){const e=[];this.state.counters.forEach((t,a)=>{const n=t.title,i=t.value,s=t.link,r=t.severity,c=t.stateKey;let l=o.a.createElement("span",null,n,": ",i);s&&(l=o.a.createElement("a",{href:s,target:"_blank",rel:"noreferrer noopener"},l)),l=o.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_span","data-severity":r,key:"x-"+c},l),e.push(l),e.push(o.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_delim",key:"delim"+a}," ─ "))}),e.length>0&&(e.pop(),a=o.a.createElement("div",{className:"m_RoomView_auxPanel_stateViews"},e))}return o.a.createElement(I.a,{className:"mx_RoomView_auxPanel"},a,this.props.children,t,e)}}i()(ql,"defaultProps",{showApps:!0});var Gl=a(120);const Yl=["isHighlighted","isUnread","onClick","analytics","name","title"];class Jl extends o.a.Component{constructor(){super(...arguments),i()(this,"onClick",e=>{V.a.trackEvent(...this.props.analytics),this.props.onClick(e)})}render(){const e=this.props,{isHighlighted:t,isUnread:a=!1,onClick:n,analytics:i,name:s,title:r}=e,c=Ee()(e,Yl),d=l()({mx_RightPanel_headerButton:!0,mx_RightPanel_headerButton_highlight:t,mx_RightPanel_headerButton_unread:a,["mx_RightPanel_"+s]:!0});return o.a.createElement(oe.a,ue()({},c,{"aria-selected":t,role:"tab",title:r,className:d,onClick:this.onClick}))}}let $l;!function(e){e.Room="room"}($l||($l={}));class Ql extends o.a.Component{constructor(e,t){super(e),i()(this,"unmounted",!1),i()(this,"dispatcherRef",void 0),i()(this,"onRightPanelStoreUpdate",()=>{this.unmounted||this.setState({phase:as.a.instance.currentCard.phase})});const a=as.a.instance;this.state={headerKind:t,phase:a.currentCard.phase,threadNotificationColor:Ae.a.None}}componentDidMount(){as.a.instance.on(L.b,this.onRightPanelStoreUpdate),this.dispatcherRef=b.a.register(this.onAction.bind(this))}componentWillUnmount(){this.unmounted=!0,as.a.instance.off(L.b,this.onRightPanelStoreUpdate),this.dispatcherRef&&b.a.unregister(this.dispatcherRef)}setPhase(e,t){const a=as.a.instance;a.currentCard.phase==e&&!t&&a.isOpen?a.togglePanel():(as.a.instance.setCard({phase:e,state:t}),a.isOpen||a.togglePanel())}isPhase(e){return!!as.a.instance.isOpen&&(Array.isArray(e)?e.includes(this.state.phase):e===this.state.phase)}render(){return o.a.createElement("div",{className:"mx_HeaderButtons"},this.renderButtons())}}var Xl=a(353),Zl=a(190);const ed=[ts.a.RoomSummary,ts.a.Widget,ts.a.FilePanel,ts.a.RoomMemberList,ts.a.RoomMemberInfo,ts.a.EncryptionPanel,ts.a.Room3pidMemberInfo],td=e=>{let{color:t}=e;if(t===Ae.a.None)return null;const a=l()({mx_Indicator:!0,mx_RightPanel_headerButton_unreadIndicator:!0,mx_Indicator_bold:t===Ae.a.Bold,mx_Indicator_gray:t===Ae.a.Grey,mx_Indicator_red:t===Ae.a.Red});return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_RightPanel_headerButton_unreadIndicator_bg"}),o.a.createElement("div",{className:a}))},ad=e=>{let{room:t,isHighlighted:a,onClick:n}=e;const i=Object(be.b)("feature_pinning"),s=Cs(i&&t),r=Os(i&&t);if(null==s||!s.length)return null;let c;return s.some(e=>!r.has(e))&&(c=o.a.createElement(td,null)),o.a.createElement(Jl,{name:"pinnedMessagesButton",title:Object(N.a)("Pinned messages"),isHighlighted:a,isUnread:!!c,onClick:n,analytics:["Right Panel","Pinned Messages Button","click"]},c)},nd=e=>{let t,{room:a,isHighlighted:n,onClick:i}=e;const s=ze.a.instance.getRoomState(a).color;switch(s){case Ae.a.Bold:case Ae.a.Grey:case Ae.a.Red:t=o.a.createElement(td,{color:s})}return o.a.createElement(Jl,{name:"timelineCardButton",title:Object(N.a)("Chat"),isHighlighted:n,onClick:i,analytics:["Right Panel","Timeline Panel Button","click"]},t)};class id extends Ql{constructor(e){super(e,$l.Room),i()(this,"threadNotificationState",void 0),i()(this,"onThreadNotification",()=>{this.setState({threadNotificationColor:this.threadNotificationState.color})}),i()(this,"onRoomSummaryClicked",()=>{const e=as.a.instance.currentCard.phase;ed.includes(e)?this.state.phase===e?this.setPhase(e):this.setPhase(e,as.a.instance.currentCard.state):this.setPhase(ts.a.RoomSummary)}),i()(this,"onNotificationsClicked",()=>{this.setPhase(ts.a.NotificationPanel)}),i()(this,"onPinnedMessagesClicked",()=>{this.setPhase(ts.a.PinnedMessages)}),i()(this,"onTimelineCardClicked",()=>{this.setPhase(ts.a.Timeline)}),i()(this,"onThreadsPanelClicked",e=>{id.THREAD_PHASES.includes(this.state.phase)?as.a.instance.togglePanel():(Object(Xl.b)(),W.b.trackInteraction("WebRoomHeaderButtonsThreadsButton",e))}),this.threadNotificationState=ze.a.instance.getThreadsRoomState(this.props.room)}componentDidMount(){super.componentDidMount(),this.threadNotificationState.on(Zl.b.Update,this.onThreadNotification)}componentWillUnmount(){super.componentWillUnmount(),this.threadNotificationState.off(Zl.b.Update,this.onThreadNotification)}onAction(e){e.action===M.a.ViewUser?e.member?e.push?as.a.instance.pushCard({phase:ts.a.RoomMemberInfo,state:{member:e.member}}):as.a.instance.setCards([{phase:ts.a.RoomSummary},{phase:ts.a.RoomMemberList},{phase:ts.a.RoomMemberInfo,state:{member:e.member}}]):this.setPhase(ts.a.RoomMemberList):"view_3pid_invite"===e.action&&(e.event?this.setPhase(ts.a.Room3pidMemberInfo,{memberInfoEvent:e.event}):this.setPhase(ts.a.RoomMemberList))}renderButtons(){const e=new Map;return e.set(ts.a.PinnedMessages,o.a.createElement(ad,{key:"pinnedMessagesButton",room:this.props.room,isHighlighted:this.isPhase(ts.a.PinnedMessages),onClick:this.onPinnedMessagesClicked})),e.set(ts.a.Timeline,o.a.createElement(nd,{key:"timelineButton",room:this.props.room,isHighlighted:this.isPhase(ts.a.Timeline),onClick:this.onTimelineCardClicked})),e.set(ts.a.ThreadPanel,v.b.getValue("feature_thread")?o.a.createElement(Jl,{key:ts.a.ThreadPanel,name:"threadsButton",title:Object(N.a)("Threads"),onClick:this.onThreadsPanelClicked,isHighlighted:this.isPhase(id.THREAD_PHASES),isUnread:this.threadNotificationState.color>0,analytics:["Right Panel","Threads List Button","click"]},o.a.createElement(td,{color:this.threadNotificationState.color})):null),e.set(ts.a.NotificationPanel,o.a.createElement(Jl,{key:"notifsButton",name:"notifsButton",title:Object(N.a)("Notifications"),isHighlighted:this.isPhase(ts.a.NotificationPanel),onClick:this.onNotificationsClicked,analytics:["Right Panel","Notification List Button","click"]})),e.set(ts.a.RoomSummary,o.a.createElement(Jl,{key:"roomSummaryButton",name:"roomSummaryButton",title:Object(N.a)("Room Info"),isHighlighted:this.isPhase(ed),onClick:this.onRoomSummaryClicked,analytics:["Right Panel","Room Summary Button","click"]})),o.a.createElement(o.a.Fragment,null,Array.from(e.keys()).map(t=>this.props.excludedRightPanelPhaseButtons.includes(t)?null:e.get(t)))}}i()(id,"THREAD_PHASES",[ts.a.ThreadPanel,ts.a.ThreadView]);var sd=a(855),od=a(576),rd=a(326),cd=a(356);const ld=["room","onFinished"];var dd=e=>{var t;let{room:a,onFinished:n}=e,i=Ee()(e,ld);const r=Object(s.useContext)(j.a),c=Object(F.b)(qt.b.instance,qt.a,()=>qt.b.instance.getTagsForRoom(a));let l;if(c.includes(Q.a.Archived)){const e=e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"forget_room",room_id:a.roomId}),n()};l=o.a.createElement(ye.b,{iconClassName:"mx_RoomTile_iconSignOut",label:Object(N.a)("Forget"),className:"mx_IconizedContextMenu_option_red",onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"leave_room",room_id:a.roomId}),n(),W.b.trackInteraction("WebRoomHeaderContextMenuLeaveItem",e)};l=o.a.createElement(ye.b,{onClick:e,label:Object(N.a)("Leave"),className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_RoomTile_iconSignOut"})}const d=cs.a.shared().getUserIdForRoomId(a.roomId),m=Object(be.a)("feature_video_rooms")&&a.isElementVideoRoom();let h,u,p,g,f,E,y;if(a.canInvite(r.getUserId())&&!d){const e=e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"view_invite",roomId:a.roomId}),n(),W.b.trackInteraction("WebRoomHeaderContextMenuInviteItem",e)};h=o.a.createElement(ye.b,{onClick:e,label:Object(N.a)("Invite"),iconClassName:"mx_RoomTile_iconInvite"})}if("join"===a.getMyMembership()){const e=c.includes(Q.a.Favourite);u=o.a.createElement(ye.a,{onClick:e=>{k(e,Q.a.Favourite),W.b.trackInteraction("WebRoomHeaderContextMenuFavouriteToggle",e)},active:e,label:e?Object(N.a)("Favourited"):Object(N.a)("Favourite"),iconClassName:"mx_RoomTile_iconStar"});const t=c.includes(Q.a.LowPriority);p=o.a.createElement(ye.a,{onClick:e=>k(e,Q.a.LowPriority),active:t,label:Object(N.a)("Low priority"),iconClassName:"mx_RoomTile_iconArrowDown"});let i,s;switch(od.a.forRoom(a).notificationVolume){case rd.a.AllMessages:i=Object(N.a)("Default"),s="mx_RoomTile_iconNotificationsDefault";break;case rd.a.AllMessagesLoud:i=Object(N.a)("All messages"),s="mx_RoomTile_iconNotificationsAllMessages";break;case rd.a.MentionsOnly:i=Object(N.a)("Mentions only"),s="mx_RoomTile_iconNotificationsMentionsKeywords";break;case rd.a.Mute:i=Object(N.a)("Mute"),s="mx_RoomTile_iconNotificationsNone"}g=o.a.createElement(ye.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"open_room_settings",room_id:a.roomId,initial_tab_id:cd.a}),n(),W.b.trackInteraction("WebRoomHeaderContextMenuNotificationsItem",e)},label:Object(N.a)("Notifications"),iconClassName:s},o.a.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},i))}d||(f=o.a.createElement(ye.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),x(e),as.a.instance.pushCard({phase:ts.a.RoomMemberList},!1),n(),W.b.trackInteraction("WebRoomHeaderContextMenuPeopleItem",e)},label:Object(N.a)("People"),iconClassName:"mx_RoomTile_iconPeople"},o.a.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},a.getJoinedMemberCount())),E=o.a.createElement(ye.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"copy_room",room_id:a.roomId}),n()},label:Object(N.a)("Copy room link"),iconClassName:"mx_RoomTile_iconCopyLink"})),m||(y=o.a.createElement(ye.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),x(e),as.a.instance.pushCard({phase:ts.a.FilePanel},!1),n()},label:Object(N.a)("Files"),iconClassName:"mx_RoomTile_iconFiles"}));const _=Object(be.a)("feature_pinning"),S=null===(t=Cs(_&&a))||void 0===t?void 0:t.length;let w,C,O;_&&!m&&(w=o.a.createElement(ye.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),x(e),as.a.instance.pushCard({phase:ts.a.PinnedMessages},!1),n()},label:Object(N.a)("Pinned"),iconClassName:"mx_RoomTile_iconPins"},S>0&&o.a.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},S))),m||(C=o.a.createElement(ye.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),x(e),as.a.instance.setCard({phase:ts.a.RoomSummary},!1),n()},label:Object(N.a)("Widgets"),iconClassName:"mx_RoomTile_iconWidgets"})),m||(O=o.a.createElement(ye.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),gt.a.createTrackedDialog("Export room dialog","",Bs,{room:a}),n()},label:Object(N.a)("Export chat"),iconClassName:"mx_RoomTile_iconExport"}));const k=(e,t)=>{if(e.preventDefault(),e.stopPropagation(),t===Q.a.Favourite||t===Q.a.LowPriority){const e=t===Q.a.Favourite?Q.a.LowPriority:Q.a.Favourite,n=qt.b.instance.getTagsForRoom(a).includes(t),i=n?t:e,s=n?null:t;b.a.dispatch(sd.a.tagRoom(r,a,i,s,void 0,0))}else Sa.a.warn(`Unexpected tag ${t} applied to ${a.roomId}`);switch(Object(le.a)().getAccessibilityAction(e)){case Ue.h.Enter:n()}},x=e=>{vt.a.instance.getRoomId()!==a.roomId&&b.a.dispatch({action:M.a.ViewRoom,room_id:a.roomId,metricsTrigger:"RoomList",metricsViaKeyboard:"click"!==e.type},!0)};return o.a.createElement(ye.e,ue()({},i,{onFinished:n,className:"mx_RoomTile_contextMenu",compact:!0}),o.a.createElement(ye.c,null,h,g,u,f,y,w,C,p,E,o.a.createElement(ye.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"open_room_settings",room_id:a.roomId}),n(),W.b.trackInteraction("WebRoomHeaderContextMenuSettingsItem",e)},label:Object(N.a)("Settings"),iconClassName:"mx_RoomTile_iconSettings"}),O,v.b.getValue("developerMode")&&o.a.createElement(ye.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),gt.a.createDialog(bt.a,{roomId:vt.a.instance.getRoomId()},"mx_DevtoolsDialog_wrapper"),n()},label:Object(N.a)("Developer tools"),iconClassName:"mx_RoomTile_iconDeveloperTools"}),l))},md=a(506),hd=a(786),ud=a(785);const pd=e=>{let{liveBeaconIds:t,roomId:a}=e;const{onStopSharing:n,onResetLocationPublishError:i,beacon:s,stoppingInProgress:r,hasStopSharingError:c,hasLocationPublishError:l}=Object(Nr.j)(t);if(!s)return null;const d=c||l;return o.a.createElement("div",{className:"mx_RoomLiveShareWarning"},o.a.createElement(nc.a,{className:"mx_RoomLiveShareWarning_icon",withError:d}),o.a.createElement("span",{className:"mx_RoomLiveShareWarning_label"},((e,t)=>e?Object(N.a)("An error occurred whilst sharing your live location, please try again"):t?Object(N.a)("An error occurred while stopping your live location, please try again"):Object(N.a)("You are sharing your live location"))(l,c)),r&&o.a.createElement("span",{className:"mx_RoomLiveShareWarning_spinner"},o.a.createElement(un.a,{h:16,w:16})),!r&&!d&&o.a.createElement(ud.a,{beacon:s}),o.a.createElement(U.a,{className:"mx_RoomLiveShareWarning_stopButton","data-test-id":"room-live-share-primary-button",onClick:()=>{l?i():n()},kind:"danger",element:"button",disabled:r},d?Object(N.a)("Retry"):Object(N.a)("Stop sharing")),l&&o.a.createElement(U.a,{"data-test-id":"room-live-share-wire-error-close-button",title:Object(N.a)("Stop sharing and close"),element:"button",className:"mx_RoomLiveShareWarning_closeButton",onClick:n},o.a.createElement(hd.a,{className:"mx_RoomLiveShareWarning_closeButtonIcon"})))};var gd=e=>{let{roomId:t}=e;const a=Object(F.b)(Hr.a.instance,Hr.b.MonitoringLivePosition,()=>Hr.a.instance.isMonitoringLiveLocation),n=Object(F.b)(Hr.a.instance,Hr.b.LivenessChange,()=>Hr.a.instance.getLiveBeaconIds(t));return a&&n.length?o.a.createElement(pd,{liveBeaconIds:n,roomId:t}):null};class bd extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"onRoomStateEvents",e=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&this.rateLimitedUpdate()}),i()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),i()(this,"rateLimitedUpdate",Object(x.throttle)(()=>{this.forceUpdate()},500,{leading:!0,trailing:!0})),i()(this,"onContextMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),i()(this,"onContextMenuCloseClick",()=>{this.setState({contextMenuPosition:null})});ze.a.instance.getRoomState(e.room).on(Zl.b.Update,this.onNotificationUpdate),this.state={}}componentDidMount(){Et.a.get().on(Gl.RoomStateEvent.Events,this.onRoomStateEvents)}componentWillUnmount(){const e=Et.a.get();e&&e.removeListener(Gl.RoomStateEvent.Events,this.onRoomStateEvents);ze.a.instance.getRoomState(this.props.room).removeListener(Zl.b.Update,this.onNotificationUpdate)}render(){let e=null;this.props.searchInfo&&void 0!==this.props.searchInfo.searchCount&&null!==this.props.searchInfo.searchCount&&(e=o.a.createElement("div",{className:"mx_RoomHeader_searchStatus"}," ",Object(N.a)("(~%(count)s results)",{count:this.props.searchInfo.searchCount})));let t=!1;const a=this.props.room?this.props.room.getJoinedMembers():void 0;if(a&&1===a.length&&a[0].userId===Et.a.get().credentials.userId){const e=this.props.room.currentState.getStateEvents("m.room.name","");e&&e.getContent().name||(t=!0)}let n,i=Object(N.a)("Join Room");this.props.oobData&&this.props.oobData.name&&(i=this.props.oobData.name),this.state.contextMenuPosition&&this.props.room&&(n=o.a.createElement(dd,ue()({},Object(md.a)(this.state.contextMenuPosition),{room:this.props.room,onFinished:this.onContextMenuCloseClick})));const s=l()("mx_RoomHeader_nametext",{mx_RoomHeader_settingsHint:t}),r=o.a.createElement(ve.c,{className:"mx_RoomHeader_name",onClick:this.onContextMenuOpenClick,isExpanded:!!this.state.contextMenuPosition,title:Object(N.a)("Room options")},o.a.createElement(xs.a,{room:this.props.room},e=>{const t=e||i;return o.a.createElement("div",{dir:"auto",className:s,title:t},t)}),this.props.room&&o.a.createElement("div",{className:"mx_RoomHeader_chevron"}),n),c=o.a.createElement(yl,{room:this.props.room,className:"mx_RoomHeader_topic"});let d;this.props.room&&(d=o.a.createElement(ha.a,{room:this.props.room,avatarSize:24,oobData:this.props.oobData,viewAvatarOnClick:!0}));const m=[];if(this.props.inRoom&&this.props.onCallPlaced&&!this.context.tombstone&&v.b.getValue("showCallButtonsInComposer")){const e=o.a.createElement(oe.a,{className:"mx_RoomHeader_button mx_RoomHeader_voiceCallButton",onClick:()=>this.props.onCallPlaced(_a.f.Voice),title:Object(N.a)("Voice call"),key:"voice"}),t=o.a.createElement(oe.a,{className:"mx_RoomHeader_button mx_RoomHeader_videoCallButton",onClick:()=>this.props.onCallPlaced(_a.f.Video),title:Object(N.a)("Video call"),key:"video"});m.push(e,t)}if(this.props.onForgetClick){const e=o.a.createElement(oe.a,{className:"mx_RoomHeader_button mx_RoomHeader_forgetButton",onClick:this.props.onForgetClick,title:Object(N.a)("Forget room"),key:"forget"});m.push(e)}if(this.props.onAppsClick){const e=o.a.createElement(oe.a,{className:l()("mx_RoomHeader_button mx_RoomHeader_appsButton",{mx_RoomHeader_appsButton_highlight:this.props.appsShown}),onClick:this.props.onAppsClick,title:this.props.appsShown?Object(N.a)("Hide Widgets"):Object(N.a)("Show Widgets"),key:"apps"});m.push(e)}if(this.props.onSearchClick&&this.props.inRoom){const e=o.a.createElement(oe.a,{className:"mx_RoomHeader_button mx_RoomHeader_searchButton",onClick:this.props.onSearchClick,title:Object(N.a)("Search"),key:"search"});m.push(e)}if(this.props.onInviteClick&&this.props.inRoom){const e=o.a.createElement(oe.a,{className:"mx_RoomHeader_button mx_RoomHeader_inviteButton",onClick:this.props.onInviteClick,title:Object(N.a)("Invite"),key:"invite"});m.push(e)}const h=o.a.createElement("div",{className:"mx_RoomHeader_buttons"},m),u=this.props.e2eStatus?o.a.createElement(co.b,{status:this.props.e2eStatus}):void 0;return o.a.createElement("div",{className:"mx_RoomHeader light-panel"},o.a.createElement("div",{className:"mx_RoomHeader_wrapper","aria-owns":"mx_RightPanel"},o.a.createElement("div",{className:"mx_RoomHeader_avatar"},d),o.a.createElement("div",{className:"mx_RoomHeader_e2eIcon"},u),r,e,c,h,o.a.createElement(id,{room:this.props.room,excludedRightPanelPhaseButtons:this.props.excludedRightPanelPhaseButtons})),o.a.createElement(gd,{roomId:this.props.room.roomId}))}}i()(bd,"defaultProps",{editing:!1,inRoom:!1,excludedRightPanelPhaseButtons:[]}),i()(bd,"contextType",Zn.b);var vd=e=>{let{roomWidth:t}=e;const n=Object(s.useRef)(null),i=Object(s.useRef)(new Map);return Object(s.useEffect)(()=>{const e=()=>{var e;n.current&&(null===(e=n.current)||void 0===e?void 0:e.height)!==de.b.instance.windowHeight&&(n.current.height=de.b.instance.windowHeight)},t=b.a.register(e=>{if(0===e.action.indexOf("effects.")){(async e=>{if(!e)return null;let t=i.current[e]||null;if(null===t){var n;const s=null===(n=Nn.CHAT_EFFECTS.find(t=>t.command===e))||void 0===n?void 0:n.options;try{const{default:n}=await a(1458)("./"+e);t=new n(s),i.current[e]=t}catch(t){Sa.a.warn(`Unable to load effect module at '../../../effects/${e}.`,t)}}return t})(e.action.slice("effects.".length)).then(e=>null==e?void 0:e.start(n.current))}});return n.current.height=de.b.instance.windowHeight,de.b.instance.on(de.a.Resize,e),()=>{b.a.unregister(t),de.b.instance.off(de.a.Resize,e);const a=i.current;for(const e in a){const t=a[e];t&&t.isRunning&&t.stop()}}},[]),o.a.createElement("canvas",{ref:n,width:t,style:{display:"block",zIndex:999999,pointerEvents:"none",position:"fixed",top:0,right:0}})},fd=a(257),Ed=a(298);const yd=e=>{let{kind:t,devices:a,setDevice:n,deviceListLabel:i,active:r,disabled:c,toggle:d,activeTitle:m,inactiveTitle:h}=e;const u=Object(s.useMemo)(()=>a.filter(e=>e.label.length),[a]),[p,g,b,v]=Object(ve.q)();let f;if(p){const e=e=>{n(e),v()},t=g.current.getBoundingClientRect();f=o.a.createElement(ye.e,ue()({},Object(ve.j)(t),{onFinished:v}),o.a.createElement(ye.c,null,u.map(t=>o.a.createElement(ye.b,{key:t.deviceId,label:t.label,onClick:()=>e(t)}))))}return a.length?o.a.createElement("div",{className:l()({mx_VideoLobby_deviceButtonWrapper:!0,mx_VideoLobby_deviceButtonWrapper_active:r})},o.a.createElement(oe.a,{className:"mx_VideoLobby_deviceButton mx_VideoLobby_deviceButton_"+t,title:r?m:h,alignment:za.a.Top,onClick:d,disabled:c}),u.length>1?o.a.createElement(ve.b,{className:"mx_VideoLobby_deviceListButton",inputRef:g,onClick:b,isExpanded:p,label:i,disabled:c}):null,f):null};var _d=e=>{let{room:t}=e;const a=Ed.b.instance,[n,i]=Object(s.useState)(!1),r=Object(s.useMemo)(()=>t.getMember(t.myUserId),[t]),c=Object(fd.i)(t,!1),l=Object(s.useRef)(),d=Object(ps.a)(async()=>{try{return await navigator.mediaDevices.enumerateDevices()}catch(e){return Sa.a.warn("Failed to get media device list: "+e),[]}},[],[]),m=Object(s.useMemo)(()=>d.filter(e=>"audioinput"===e.kind),[d]),h=Object(s.useMemo)(()=>d.filter(e=>"videoinput"===e.kind),[d]),[u,p]=Object(s.useState)(null),[g,b]=Object(s.useState)(null),v=null!=u?u:m[0],f=null!=g?g:h[0],[E,y]=Object(s.useState)(!a.audioMuted),[_,S]=Object(s.useState)(!a.videoMuted),w=Object(ps.a)(async()=>{if(f&&_)try{return await navigator.mediaDevices.getUserMedia({video:{deviceId:f.deviceId}})}catch(e){Sa.a.error(`Failed to get stream for device ${f.deviceId}: ${e}`)}return null},[f,_]);Object(s.useEffect)(()=>{if(w){const e=l.current;return e.srcObject=w,e.play(),()=>{null==w||w.getTracks().forEach(e=>e.stop()),e.srcObject=null}}},[w]);let C;if(c.size){const e=[...c].slice(0,8),t=c.size>e.length;C=o.a.createElement("div",{className:"mx_VideoLobby_connectedMembers"},Object(N.a)("%(count)s people joined",{count:c.size}),o.a.createElement(Sl,{members:e,faceSize:24,overflow:t}))}return o.a.createElement("div",{className:"mx_VideoLobby"},C,o.a.createElement("div",{className:"mx_VideoLobby_preview"},o.a.createElement(Oa.a,{key:r.userId,member:r,width:200,height:200,resizeMethod:"scale"}),o.a.createElement("video",{ref:l,style:{visibility:_?null:"hidden"},muted:!0,playsInline:!0,disablePictureInPicture:!0}),o.a.createElement("div",{className:"mx_VideoLobby_controls"},o.a.createElement(yd,{kind:"audio",devices:m,setDevice:p,deviceListLabel:Object(N.a)("Audio devices"),active:E,disabled:n,toggle:()=>{a.audioMuted=E,y(!E)},activeTitle:Object(N.a)("Mute microphone"),inactiveTitle:Object(N.a)("Unmute microphone")}),o.a.createElement(yd,{kind:"video",devices:h,setDevice:b,deviceListLabel:Object(N.a)("Video devices"),active:_,disabled:n,toggle:()=>{a.videoMuted=_,S(!_)},activeTitle:Object(N.a)("Turn off camera"),inactiveTitle:Object(N.a)("Turn on camera")}))),o.a.createElement(U.a,{className:"mx_VideoLobby_joinButton",kind:"primary",disabled:n,onClick:async()=>{i(!0);try{await a.connect(t.roomId,E?v:null,_?f:null)}catch(e){Sa.a.error(e),i(!1)}}},Object(N.a)("Join")))};var Sd=e=>{let{room:t,resizing:a}=e;const n=Object(s.useContext)(j.a),i=Ed.b.instance,[r,c]=Object(s.useState)(Boolean(Ei.a.instance.matrixClient)),[l,d]=Object(s.useState)(!1);Object(F.a)(Ei.a.instance,L.b,e=>{null===e&&c(!0),null!==e&&e!==t.roomId||d(Boolean(Object(fd.g)(t.roomId)))});const m=Object(s.useMemo)(()=>{if(r){const e=Object(fd.g)(t.roomId);return e||(Sa.a.warn("No video channel for room "+t.roomId),sn.a.canUserModifyWidgets(t.roomId)&&Object(fd.d)(t.roomId,t.name)),e}},[t,r,l]);Object(s.useEffect)(()=>{Object(fd.e)(t,i.connected)},[t]);const[h,u]=Object(s.useState)(i.connected&&i.roomId===t.roomId);return Object(F.a)(i,Ed.a.Connect,()=>u(i.roomId===t.roomId)),Object(F.a)(i,Ed.a.Disconnect,()=>u(!1)),m?o.a.createElement("div",{className:"mx_VideoRoomView"},h?null:o.a.createElement(_d,{room:t}),o.a.createElement(di,{app:m,room:t,userId:n.credentials.userId,creatorUserId:m.creatorUserId,waitForIframeLoad:m.waitForIframeLoad,showMenubar:!1,pointerEvents:a?"none":null})):null},wd=a(286),Cd=a(548),Od=a(291);const kd=(e,t)=>{const[a,n]=Object(s.useState)(()=>Array.isArray(t)?t:new Array(e).fill(t));return[a,(e,t)=>n(a=>{const n=[...a];return n[e]=t,n})]};var xd=a(343),Rd=a(748),jd=a(818),Id=a(787),Td=a(846),Nd=a(407);function Pd(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Md(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Pd(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Pd(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const Dd=e=>{var t,a,n,i;let{room:r,suggested:c,selected:d,hasPermissions:m,onToggleClick:h,onViewRoomClick:u,onJoinRoomClick:p,numChildRooms:g,children:b}=e;const v=Object(s.useContext)(j.a),[f,E]=Object(s.useState)(()=>{const e=v.getRoom(r.room_id);return"join"===(null==e?void 0:e.getMyMembership())?e:null}),y=Object(F.d)(f,pe.c.Name,e=>null==e?void 0:e.name)||r.name||r.canonical_alias||(null===(t=r.aliases)||void 0===t?void 0:t[0])||(r.room_type===ge.f.Space?Object(N.a)("Unnamed Space"):Object(N.a)("Unnamed Room")),[_,S]=Object(Ot.a)(!0),[w,C,O]=Object(me.i)(),[k,x]=Object(s.useState)(!1),R=e=>{e.preventDefault(),e.stopPropagation(),u()},I=async e=>{x(!0),e.preventDefault(),e.stopPropagation(),p().then(()=>Object(Nd.a)(v,r.room_id)).then(E).finally(()=>{x(!1)})};let T,P,M;T=k?o.a.createElement(oe.a,{disabled:!0,onClick:I,kind:"primary_outline",onFocus:w,tabIndex:C?0:-1,title:Object(N.a)("Joining")},o.a.createElement(un.a,{w:24,h:24})):f?o.a.createElement(U.a,{onClick:R,kind:"primary_outline",onFocus:w,tabIndex:C?0:-1},Object(N.a)("View")):o.a.createElement(U.a,{onClick:I,kind:"primary",onFocus:w,tabIndex:C?0:-1},Object(N.a)("Join")),h&&(P=m?o.a.createElement(Ke.b,{checked:!!d,onChange:h,tabIndex:C?0:-1}):o.a.createElement(ln.a,{tooltip:Object(N.a)("You don't have permission"),onClick:e=>{e.stopPropagation()}},o.a.createElement(Ke.b,{disabled:!0,tabIndex:C?0:-1}))),M=f?o.a.createElement(Ie.a,{room:f,width:20,height:20}):o.a.createElement(D.a,{name:y,idName:r.room_id,url:r.avatar_url?Object(si.b)(r.avatar_url).getSquareThumbnailHttp(20):null,width:20,height:20});let A=Object(N.a)("%(count)s members",{count:r.num_joined_members});void 0!==g&&(A+=" · "+Object(N.a)("%(count)s rooms",{count:g}));const L=(null==f||null===(a=f.currentState)||void 0===a||null===(n=a.getStateEvents(ge.b.RoomTopic,""))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.topic)||r.topic;let B,V;L&&(A+=" · "+L),f&&(B=o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_joined"},Object(N.a)("Joined"))),!c||f&&!m||(V=o.a.createElement(Id.b,{tooltip:Object(N.a)("This room is suggested as a good one to join")},Object(N.a)("Suggested")));const W=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_item"},o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_avatar"},M),o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_name"},y,B,V),o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_info",ref:e=>e&&Object(hl.g)(e),onClick:e=>{"A"===e.target.tagName&&e.stopPropagation()}},A)),o.a.createElement("div",{className:"mx_SpaceHierarchy_actions"},T,P));let H,z,K;if(b){if(H=o.a.createElement("div",{className:l()("mx_SpaceHierarchy_subspace_toggle",{mx_SpaceHierarchy_subspace_toggle_shown:_}),onClick:e=>{e.stopPropagation(),S()}}),_){const e=e=>{var t;switch(Object(le.a)().getAccessibilityAction(e)){case Ue.h.ArrowLeft:e.preventDefault(),e.stopPropagation(),null===(t=O.current)||void 0===t||t.focus()}};z=o.a.createElement("div",{className:"mx_SpaceHierarchy_subspace_children",onKeyDown:e,role:"group"},b)}K=e=>{let t=!1;switch(Object(le.a)().getAccessibilityAction(e)){case Ue.h.ArrowLeft:_&&(t=!0,S());break;case Ue.h.ArrowRight:if(t=!0,_){var a,n;const e=null===(a=O.current)||void 0===a?void 0:a.nextElementSibling;null==e||null===(n=e.querySelector(".mx_SpaceHierarchy_roomTile"))||void 0===n||n.focus()}else S()}t&&(e.preventDefault(),e.stopPropagation())}}return o.a.createElement("li",{className:"mx_SpaceHierarchy_roomTileWrapper",role:"treeitem","aria-expanded":b?_:void 0},o.a.createElement(U.a,{className:l()("mx_SpaceHierarchy_roomTile",{mx_SpaceHierarchy_subspace:r.room_type===ge.f.Space,mx_SpaceHierarchy_joining:k}),onClick:m&&h?h:R,onKeyDown:K,inputRef:O,onFocus:w,tabIndex:C?0:-1},W,H),z)},Ad=(e,t,a,n)=>{const i=t.roomMap.get(a);if(e.isGuest()&&!i.world_readable&&!i.guest_can_join)return void b.a.dispatch({action:"require_registration"});const s=Object(Td.b)(i)||void 0;b.a.dispatch({action:M.a.ViewRoom,should_peek:!0,room_alias:s,room_id:i.room_id,via_servers:Array.from(t.viaMap.get(a)||[]),oob_data:{avatarUrl:i.avatar_url,name:i.name||s||Object(N.a)("Unnamed room"),roomType:n},metricsTrigger:"RoomDirectory"})},Ud=e=>{let{root:t,roomSet:a,hierarchy:n,parents:i,selectedMap:r,onViewRoomClick:c,onJoinRoomClick:l,onToggleClick:d}=e;const m=Object(s.useContext)(j.a),h=m.getRoom(t.room_id),u=null==h?void 0:h.currentState.maySendStateEvent(ge.b.SpaceChild,m.getUserId()),p=Object(x.sortBy)(t.children_state,e=>Object(re.b)(e.content.order,e.origin_server_ts,e.state_key)),[g,b]=p.reduce((e,t)=>{const i=n.roomMap.get(t.state_key);return i&&a.has(i)&&e[i.room_type===ge.f.Space?0:1].push(((e,t)=>{const a=e.getRoomUpgradeHistory(t.room_id,!0),n=a[a.length-1];var i,s,o;return n?Md(Md({},t),{},{room_id:n.roomId,room_type:n.getType(),name:n.name,topic:null===(i=n.currentState.getStateEvents(ge.b.RoomTopic,""))||void 0===i?void 0:i.getContent().topic,avatar_url:n.getMxcAvatarUrl(),canonical_alias:n.getCanonicalAlias(),aliases:n.getAltAliases(),world_readable:(null===(s=n.currentState.getStateEvents(ge.b.RoomHistoryVisibility,""))||void 0===s?void 0:s.getContent().history_visibility)===Pi.b.WorldReadable,guest_can_join:(null===(o=n.currentState.getStateEvents(ge.b.RoomGuestAccess,""))||void 0===o?void 0:o.getContent().guest_access)===Pi.a.CanJoin,num_joined_members:n.getJoinedMemberCount()}):t})(m,i)),e},[[],[]]),v=new Set(i).add(t.room_id);return o.a.createElement(o.a.Fragment,null,Object(x.uniqBy)(b,"room_id").map(e=>{var a;return o.a.createElement(Dd,{key:e.room_id,room:e,suggested:n.isSuggested(t.room_id,e.room_id),selected:null==r||null===(a=r.get(t.room_id))||void 0===a?void 0:a.has(e.room_id),onViewRoomClick:()=>c(e.room_id,e.room_type),onJoinRoomClick:()=>l(e.room_id),hasPermissions:u,onToggleClick:d?()=>d(t.room_id,e.room_id):void 0})}),g.filter(e=>!v.has(e.room_id)).map(e=>{var i;return o.a.createElement(Dd,{key:e.room_id,room:e,numChildRooms:e.children_state.filter(e=>{const t=n.roomMap.get(e.state_key);return t&&a.has(t)&&!t.room_type}).length,suggested:n.isSuggested(t.room_id,e.room_id),selected:null==r||null===(i=r.get(t.room_id))||void 0===i?void 0:i.has(e.room_id),onViewRoomClick:()=>c(e.room_id,ge.f.Space),onJoinRoomClick:()=>l(e.room_id),hasPermissions:u,onToggleClick:d?()=>d(t.room_id,e.room_id):void 0},o.a.createElement(Ud,{root:e,roomSet:a,hierarchy:n,parents:v,selectedMap:r,onViewRoomClick:c,onJoinRoomClick:l,onToggleClick:d}))}))},Ld=e=>{let{hierarchy:t,selected:a,setSelected:n,setError:i}=e;const r=Object(s.useContext)(j.a),[c,l]=Object(s.useState)(!1),[d,m]=Object(s.useState)(!1),h=Array.from(a.keys()).flatMap(e=>[...a.get(e).values()].map(t=>[e,t])),u=h.every(e=>{let[a,n]=e;return t.isSuggested(a,n)}),p=!h.length||c||d;let g=U.a,b={};return h.length||(g=oe.a,b={tooltip:Object(N.a)("Select a room below first"),alignment:za.a.Top}),o.a.createElement(o.a.Fragment,null,o.a.createElement(g,ue()({},b,{onClick:async()=>{l(!0);try{const e=r.getUserId();for(const[a,n]of h){await r.sendStateEvent(a,ge.b.SpaceChild,{},n);const i=r.getRoom(n),s=null==i?void 0:i.currentState.getStateEvents(ge.b.SpaceParent,a);null!=i&&i.currentState.maySendStateEvent(ge.b.SpaceParent,e)&&Array.isArray(null==s?void 0:s.getContent().via)&&await r.sendStateEvent(n,ge.b.SpaceParent,{},a),t.removeRelation(a,n)}}catch(e){i(Object(N.a)("Failed to remove some rooms. Try again later"))}l(!1),n(new Map)},kind:"danger_outline",disabled:p}),c?Object(N.a)("Removing..."):Object(N.a)("Remove")),o.a.createElement(g,ue()({},b,{onClick:async()=>{m(!0);try{for(const[a,n]of h){var e;const i=!u,s=null===(e=t.getRelation(a,n))||void 0===e?void 0:e.content;if(!s||s.suggested===i)continue;const o=Md(Md({},s),{},{suggested:!u});await r.sendStateEvent(a,ge.b.SpaceChild,o,n),s.suggested=o.suggested}}catch(e){i("Failed to update some suggestions. Try again later")}m(!1),n(new Map)},kind:"primary_outline",disabled:p}),d?Object(N.a)("Saving..."):u?Object(N.a)("Mark as not suggested"):Object(N.a)("Mark as suggested")))};var Fd,Bd=e=>{let{space:t,initialText:a="",showRoom:n,additionalButtons:i}=e;const r=Object(s.useContext)(j.a),[c,l]=Object(s.useState)(a),[d,m]=Object(s.useState)(new Map),{loading:h,rooms:u,hierarchy:p,loadMore:g,error:v}=(e=>{var t;const[a,n]=Object(s.useState)([]),[i,o]=Object(s.useState)(),[r,c]=Object(s.useState)(),l=Object(s.useCallback)(()=>{c(void 0);const t=new jd.a(e,20);t.load().then(()=>{e===t.root&&n(t.rooms)},c),o(t)},[e]);Object(s.useEffect)(l,[l]),Object(Mt.a)(b.a,e=>{e.action===M.a.UpdateSpaceHierarchy&&(n([]),l())});const d=Object(s.useCallback)(async e=>{i.loading||!i.canLoadMore||i.noSupport||r||(await i.load(e).catch(c),n(i.rooms))},[r,i]);return{loading:null===(t=null==i?void 0:i.loading)||void 0===t||t,rooms:a,hierarchy:(null==i?void 0:i.root)===e?i:void 0,loadMore:d,error:r}})(t),f=Object(s.useMemo)(()=>{if(null==u||!u.length)return new Set;const e=c.toLowerCase().trim();if(!e)return new Set(u);const t=u.filter(t=>{var a,n;return(null===(a=t.name)||void 0===a?void 0:a.toLowerCase().includes(e))||(null===(n=t.topic)||void 0===n?void 0:n.toLowerCase().includes(e))}),a=new Set,n=[...t.map(e=>e.room_id)];for(;n.length;){var i;const e=n.pop();a.add(e),null===(i=p.backRefs.get(e))||void 0===i||i.forEach(e=>{a.has(e)||n.push(e)})}return new Set(u.filter(e=>a.has(e.room_id)))},[u,p,c]),[E,y]=Object(s.useState)("");let _=E;!E&&v&&(_=Object(N.a)("Failed to load list of rooms."));const S=(e=>{const t=t=>{t[0].isIntersecting&&e()},a=Object(s.useRef)();return e=>{a.current?a.current.disconnect():e&&(a.current=new IntersectionObserver(t,{root:e.parentElement,rootMargin:"0px 0px 600px 0px"})),a.current&&e&&a.current.observe(e)}})(g);if(!h&&p.noSupport)return o.a.createElement("p",null,Object(N.a)("Your server does not support showing space hierarchies."));const w=(e,t)=>{if(y(""),!d.has(e))return void m(new Map(d.set(e,new Set([t]))));const a=d.get(e);a.has(t)?(a.delete(t),m(new Map(d.set(e,new Set(a))))):m(new Map(d.set(e,new Set([...a,t]))))};return o.a.createElement(me.d,{onKeyDown:(e,t)=>{var a,n;Object(le.a)().getAccessibilityAction(e)===Ue.h.ArrowDown&&e.currentTarget.classList.contains("mx_SpaceHierarchy_search")&&(null===(a=t.refs[0])||void 0===a||null===(n=a.current)||void 0===n||n.focus())},handleHomeEnd:!0,handleUpDown:!0},e=>{let s,{onKeyDownHandler:g}=e;if(!h||null!=u&&u.length){const e="join"===(null==t?void 0:t.getMyMembership())&&t.currentState.maySendStateEvent(ge.b.SpaceChild,r.getUserId());let a,l;f.size?a=o.a.createElement(o.a.Fragment,null,o.a.createElement(Ud,{root:p.roomMap.get(t.roomId),roomSet:f,hierarchy:p,parents:new Set,selectedMap:d,onToggleClick:e?w:void 0,onViewRoomClick:(e,t)=>n(r,p,e,t),onJoinRoomClick:e=>((e,t,a)=>{if(e.isGuest())return void b.a.dispatch({action:"require_registration"});const n=e.joinRoom(a,{viaServers:Array.from(t.viaMap.get(a)||[])});return n.then(()=>{b.a.dispatch({action:M.a.JoinRoomReady,roomId:a,metricsTrigger:"SpaceHierarchy"})},e=>{vt.a.instance.showJoinRoomError(e,a)}),n})(r,p,e)})):p.canLoadMore||(a=o.a.createElement("div",{className:"mx_SpaceHierarchy_noResults"},o.a.createElement("h3",null,Object(N.a)("No results found")),o.a.createElement("div",null,Object(N.a)("You may want to try a different search or check for typos.")))),p.canLoadMore&&(l=o.a.createElement("div",{ref:S},o.a.createElement(un.a,null))),s=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SpaceHierarchy_listHeader"},o.a.createElement("h4",{className:"mx_SpaceHierarchy_listHeader_header"},c.trim()?Object(N.a)("Results"):Object(N.a)("Rooms and spaces")),o.a.createElement("div",{className:"mx_SpaceHierarchy_listHeader_buttons"},i,e&&o.a.createElement(Ld,{hierarchy:p,selected:d,setSelected:m,setError:y}))),_&&o.a.createElement("div",{className:"mx_SpaceHierarchy_error"},_),o.a.createElement("ul",{className:"mx_SpaceHierarchy_list",onKeyDown:g,role:"tree","aria-label":Object(N.a)("Space")},a),l)}else s=o.a.createElement(un.a,null);return o.a.createElement(o.a.Fragment,null,o.a.createElement(eo.a,{className:"mx_SpaceHierarchy_search mx_textinput_icon mx_textinput_search",placeholder:Object(N.a)("Search names and descriptions"),onSearch:l,autoFocus:!0,initialValue:a,onKeyDown:g}),s)})};!function(e){e[e.Landing=0]="Landing",e[e.PublicCreateRooms=1]="PublicCreateRooms",e[e.PublicShare=2]="PublicShare",e[e.PrivateScope=3]="PrivateScope",e[e.PrivateInvite=4]="PrivateInvite",e[e.PrivateCreateRooms=5]="PrivateCreateRooms",e[e.PrivateExistingRooms=6]="PrivateExistingRooms"}(Fd||(Fd={}));const Vd=e=>{let{space:t}=e;const[a,n,i,s]=Object(ve.q)(),r=Object(Ce.a)(Oe.a.CreateRooms),c=Object(Ce.a)(Oe.a.CreateSpaces),l=Object(be.a)("feature_video_rooms");let d;if(a){const e=n.current.getBoundingClientRect();d=o.a.createElement(ye.e,{left:e.left+window.scrollX+0,top:e.bottom+window.scrollY+8,chevronFace:ve.a.None,onFinished:s,className:"mx_RoomTile_contextMenu",compact:!0},o.a.createElement(ye.c,{first:!0},r&&o.a.createElement(o.a.Fragment,null,o.a.createElement(ye.b,{label:Object(N.a)("New room"),iconClassName:"mx_RoomList_iconPlus",onClick:async e=>{e.preventDefault(),e.stopPropagation(),s(),W.b.trackInteraction("WebSpaceHomeCreateRoomButton",e),await Object(_e.g)(t)&&b.a.fire(M.a.UpdateSpaceHierarchy)}}),l&&o.a.createElement(ye.b,{label:Object(N.a)("New video room"),iconClassName:"mx_RoomList_iconNewVideoRoom",onClick:async e=>{e.preventDefault(),e.stopPropagation(),s(),await Object(_e.g)(t,ge.f.ElementVideo)&&b.a.fire(M.a.UpdateSpaceHierarchy)}})),o.a.createElement(ye.b,{label:Object(N.a)("Add existing room"),iconClassName:"mx_RoomList_iconAddExistingRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),s(),Object(_e.e)(t)}}),c&&o.a.createElement(ye.b,{label:Object(N.a)("Add space"),iconClassName:"mx_RoomList_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),s(),Object(_e.h)(t)}},o.a.createElement(we.a,null))))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(ve.b,{kind:"primary",inputRef:n,onClick:i,isExpanded:a,label:Object(N.a)("Add")},Object(N.a)("Add")),d)},Wd=e=>{let{space:t}=e;const a=Object(s.useContext)(j.a),n=ms(t),i=a.getUserId(),r=Object(s.useCallback)(()=>{var e;return as.a.instance.isOpenForRoom(t.roomId)&&(null===(e=as.a.instance.currentCardForRoom(t.roomId))||void 0===e?void 0:e.phase)===ts.a.SpaceMemberList},[t.roomId]),c=Object(F.b)(as.a.instance,L.b,r);let l;Object(_e.c)(t)&&Object(Ce.a)(Oe.a.InviteUsers)&&(l=o.a.createElement(U.a,{kind:"primary",className:"mx_SpaceRoomView_landing_inviteButton",onClick:()=>{Object(_e.i)(t)}},Object(N.a)("Invite")));let d,m;"join"===n&&t.currentState.maySendStateEvent(ge.b.SpaceChild,i)&&(d=o.a.createElement(Vd,{space:t})),Object(_e.d)(t)&&(m=o.a.createElement(oe.a,{className:"mx_SpaceRoomView_landing_settingsButton",onClick:()=>{Object(_e.k)(t)},title:Object(N.a)("Settings")}));return o.a.createElement("div",{className:"mx_SpaceRoomView_landing"},o.a.createElement("div",{className:"mx_SpaceRoomView_landing_header"},o.a.createElement(Ie.a,{room:t,height:80,width:80,viewAvatarOnClick:!0}),o.a.createElement(je.b,null)),o.a.createElement("div",{className:"mx_SpaceRoomView_landing_name"},o.a.createElement(xs.a,{room:t},e=>{const t={name:()=>o.a.createElement("h1",null,e)};return Object(N.a)("Welcome to <name/>",{},t)})),o.a.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar"},o.a.createElement(xl,{room:t}),o.a.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar_interactive"},o.a.createElement(kl,{room:t,onlyKnownUsers:!1,numShown:7,onClick:c?void 0:()=>{as.a.instance.setCard({phase:ts.a.SpaceMemberList})}}),l,m)),o.a.createElement(yl,{room:t,className:"mx_SpaceRoomView_landing_topic"}),o.a.createElement(Bd,{space:t,showRoom:Ad,additionalButtons:d}))},Hd=e=>{let{space:t,title:a,description:n,onFinished:i}=e;const[r,c]=Object(s.useState)(!1),[l,d]=Object(s.useState)(""),m=[Object(N.a)("General"),Object(N.a)("Random"),Object(N.a)("Support")],[h,u]=kd(3,[Object(N.a)("General"),Object(N.a)("Random"),""]),p=new Array(3).fill(0).map((e,t)=>{const a="roomName"+t;return o.a.createElement(_t.a,{key:a,name:a,type:"text",label:Object(N.a)("Room name"),placeholder:m[t],value:h[t],onChange:e=>u(t,e.target.value),autoFocus:2===t,disabled:r,autoComplete:"off"})}),g=async e=>{if(e.preventDefault(),!r){d(""),c(!0);try{const e=t.getJoinRule()===Pi.c.Public,a=h.map(e=>e.trim()).filter(Boolean),n=await Promise.all(a.map(a=>Object(oo.b)({createOpts:{preset:e?Pi.d.PublicChat:Pi.d.PrivateChat,name:a},spinner:!1,encryption:!1,andView:!1,inlineErrors:!0,parentSpace:t,joinRule:e?void 0:Pi.c.Restricted,suggested:!0})));i(n[0])}catch(e){Sa.a.error("Failed to create initial space rooms",e),d(Object(N.a)("Failed to create initial space rooms"))}c(!1)}};let b=e=>{e.preventDefault(),i()},v=Object(N.a)("Skip for now");return h.some(e=>e.trim())&&(b=g,v=r?Object(N.a)("Creating rooms..."):Object(N.a)("Continue")),o.a.createElement("div",null,o.a.createElement("h1",null,a),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},n),l&&o.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},l),o.a.createElement("form",{onSubmit:b,id:"mx_SpaceSetupFirstRooms"},p),o.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.a.createElement(U.a,{kind:"primary",disabled:r,onClick:b,element:"input",type:"submit",form:"mx_SpaceSetupFirstRooms",value:v})))},zd=e=>{let{space:t,onFinished:a}=e;return o.a.createElement("div",null,o.a.createElement("h1",null,Object(N.a)("What do you want to organise?")),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(N.a)("Pick rooms or conversations to add. This is just a space for you, no one will be informed. You can add more later.")),o.a.createElement(xd.a,{space:t,emptySelectionButton:o.a.createElement(U.a,{kind:"primary",onClick:a},Object(N.a)("Skip for now")),filterPlaceholder:Object(N.a)("Search for rooms or spaces"),onFinished:a,roomsRenderer:xd.f,dmsRenderer:xd.e}))},Kd=e=>{var t;let{justCreatedOpts:a,space:n,onFinished:i,firstRoomId:s}=e;return o.a.createElement("div",{className:"mx_SpaceRoomView_publicShare"},o.a.createElement("h1",null,Object(N.a)("Share %(name)s",{name:(null==a||null===(t=a.createOpts)||void 0===t?void 0:t.name)||n.name})),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(N.a)("It's just you at the moment, it will be even better with others.")),o.a.createElement(Rd.a,{space:n}),o.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.a.createElement(U.a,{kind:"primary",onClick:i},s?Object(N.a)("Go to my first room"):Object(N.a)("Go to my space"))))},qd=e=>{var t;let{space:a,justCreatedOpts:n,onFinished:i}=e;return o.a.createElement("div",{className:"mx_SpaceRoomView_privateScope"},o.a.createElement("h1",null,Object(N.a)("Who are you working with?")),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(N.a)("Make sure the right people have access to %(name)s",{name:(null==n||null===(t=n.createOpts)||void 0===t?void 0:t.name)||a.name})),o.a.createElement(U.a,{className:"mx_SpaceRoomView_privateScope_justMeButton",onClick:()=>{i(!1)}},o.a.createElement("h3",null,Object(N.a)("Just me")),o.a.createElement("div",null,Object(N.a)("A private space to organise your rooms"))),o.a.createElement(U.a,{className:"mx_SpaceRoomView_privateScope_meAndMyTeammatesButton",onClick:()=>{i(!0)}},o.a.createElement("h3",null,Object(N.a)("Me and my teammates")),o.a.createElement("div",null,Object(N.a)("A private space for you and your teammates"))))},Gd=Object(Is.a)({rules:[{key:"email",test:e=>{let{value:t}=e;return!t||Od.a(t)},invalid:()=>Object(N.a)("Doesn't look like a valid email address")}]}),Yd=e=>{let{space:t,onFinished:a}=e;const[n,i]=Object(s.useState)(!1),[r,c]=Object(s.useState)(""),l=[Object(s.useRef)(),Object(s.useRef)(),Object(s.useRef)()],[d,m]=kd(3,""),h=new Array(3).fill(0).map((e,t)=>{const a="emailAddress"+t;return o.a.createElement(_t.a,{key:a,name:a,type:"text",label:Object(N.a)("Email address"),placeholder:Object(N.a)("Email"),value:d[t],onChange:e=>m(t,e.target.value),ref:l[t],onValidate:Gd,autoFocus:0===t,disabled:n})}),u=async e=>{if(e.preventDefault(),n)return;c("");for(let e=0;e<l.length;e++){const t=l[e];if(!1===await t.current.validate({allowEmpty:!0}))return t.current.focus(),void t.current.validate({allowEmpty:!0,focused:!0})}i(!0);const s=d.map(e=>e.trim()).filter(Boolean);try{const e=await Object(Xs.a)(t.roomId,s),n=Object.keys(e.states).filter(t=>"error"===e.states[t]);n.length>0?(Sa.a.log("Failed to invite users to space: ",e),c(Object(N.a)("Failed to invite the following users to your space: %(csvUsers)s",{csvUsers:n.join(", ")}))):a()}catch(e){Sa.a.error("Failed to invite users to space: ",e),c(Object(N.a)("We couldn't invite those users. Please check the users you want to invite and try again."))}i(!1)};let p=e=>{e.preventDefault(),a()},g=Object(N.a)("Skip for now");return d.some(e=>e.trim())&&(p=u,g=n?Object(N.a)("Inviting..."):Object(N.a)("Continue")),o.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates"},o.a.createElement("h1",null,Object(N.a)("Invite your teammates")),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(N.a)("Make sure the right people have access. You can invite more later.")),o.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_betaDisclaimer"},Object(N.a)("<b>This is an experimental feature.</b> For now, new users receiving an invite will have to open the invite on <link/> to actually join.",{},{b:e=>o.a.createElement("b",null,e),link:()=>o.a.createElement("a",{href:"https://app.element.io/",rel:"noreferrer noopener",target:"_blank"},"app.element.io")})),r&&o.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},r),o.a.createElement("form",{onSubmit:p,id:"mx_SpaceSetupPrivateInvite"},h),o.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_buttons"},o.a.createElement(U.a,{className:"mx_SpaceRoomView_inviteTeammates_inviteDialogButton",onClick:()=>Object(Xs.e)(t.roomId)},Object(N.a)("Invite by username"))),o.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.a.createElement(U.a,{kind:"primary",disabled:n,onClick:p,element:"input",type:"submit",form:"mx_SpaceSetupPrivateInvite",value:g})))};class Jd extends o.a.PureComponent{constructor(e,t){var a;super(e,t),i()(this,"context",void 0),i()(this,"creator",void 0),i()(this,"dispatcherRef",void 0),i()(this,"onMyMembership",(e,t)=>{e.roomId===this.props.space.roomId&&this.setState({myMembership:t})}),i()(this,"onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:as.a.instance.isOpenForRoom(this.props.space.roomId)})}),i()(this,"onAction",e=>{e.action!==M.a.ViewRoom||e.room_id!==this.props.space.roomId?e.action!==M.a.ViewUser&&"view_3pid_invite"!==e.action||(e.action===M.a.ViewUser&&e.member?as.a.instance.setCard({phase:ts.a.SpaceMemberInfo,state:{spaceId:this.props.space.roomId,member:e.member}}):"view_3pid_invite"===e.action&&e.event?as.a.instance.setCard({phase:ts.a.Space3pidMemberInfo,state:{spaceId:this.props.space.roomId,memberInfoEvent:e.event}}):as.a.instance.setCard({phase:ts.a.SpaceMemberList,state:{spaceId:this.props.space.roomId}})):this.setState({phase:Fd.Landing})}),i()(this,"goToFirstRoom",async()=>{this.state.firstRoomId?b.a.dispatch({action:M.a.ViewRoom,room_id:this.state.firstRoomId,metricsTrigger:void 0}):this.setState({phase:Fd.Landing})});let n=Fd.Landing;this.creator=null===(a=this.props.space.currentState.getStateEvents(ge.b.RoomCreate,""))||void 0===a?void 0:a.getSender();this.props.justCreatedOpts&&t.getUserId()===this.creator&&(n=this.props.justCreatedOpts.createOpts.preset===Pi.d.PublicChat?Fd.PublicCreateRooms:Fd.PrivateScope),this.state={phase:n,showRightPanel:as.a.instance.isOpenForRoom(this.props.space.roomId),myMembership:this.props.space.getMyMembership()},this.dispatcherRef=b.a.register(this.onAction),as.a.instance.on(L.b,this.onRightPanelStoreUpdate)}componentDidMount(){this.context.on(pe.c.MyMembership,this.onMyMembership)}componentWillUnmount(){b.a.unregister(this.dispatcherRef),as.a.instance.off(L.b,this.onRightPanelStoreUpdate),this.context.off(pe.c.MyMembership,this.onMyMembership)}renderBody(){var e,t;switch(this.state.phase){case Fd.Landing:return"join"===this.state.myMembership?o.a.createElement(Wd,{space:this.props.space}):o.a.createElement(Rl,{room:this.props.space,onJoinButtonClicked:this.props.onJoinButtonClicked,onRejectButtonClicked:this.props.onRejectButtonClicked});case Fd.PublicCreateRooms:return o.a.createElement(Hd,{space:this.props.space,title:Object(N.a)("What are some things you want to discuss in %(spaceName)s?",{spaceName:(null===(e=this.props.justCreatedOpts)||void 0===e||null===(t=e.createOpts)||void 0===t?void 0:t.name)||this.props.space.name}),description:o.a.createElement(o.a.Fragment,null,Object(N.a)("Let's create a room for each of them."),o.a.createElement("br",null),Object(N.a)("You can add more later too, including already existing ones.")),onFinished:e=>this.setState({phase:Fd.PublicShare,firstRoomId:e})});case Fd.PublicShare:return o.a.createElement(Kd,{justCreatedOpts:this.props.justCreatedOpts,space:this.props.space,onFinished:this.goToFirstRoom,firstRoomId:this.state.firstRoomId});case Fd.PrivateScope:return o.a.createElement(qd,{space:this.props.space,justCreatedOpts:this.props.justCreatedOpts,onFinished:e=>{this.setState({phase:e?Fd.PrivateCreateRooms:Fd.PrivateExistingRooms})}});case Fd.PrivateInvite:return o.a.createElement(Yd,{space:this.props.space,onFinished:()=>this.setState({phase:Fd.Landing})});case Fd.PrivateCreateRooms:return o.a.createElement(Hd,{space:this.props.space,title:Object(N.a)("What projects are your team working on?"),description:o.a.createElement(o.a.Fragment,null,Object(N.a)("We'll create rooms for each of them."),o.a.createElement("br",null),Object(N.a)("You can add more later too, including already existing ones.")),onFinished:e=>this.setState({phase:Fd.PrivateInvite,firstRoomId:e})});case Fd.PrivateExistingRooms:return o.a.createElement(zd,{space:this.props.space,onFinished:()=>this.setState({phase:Fd.Landing})})}}render(){const e=this.state.showRightPanel&&this.state.phase===Fd.Landing?o.a.createElement(sl,{room:this.props.space,resizeNotifier:this.props.resizeNotifier}):null;return o.a.createElement("main",{className:"mx_SpaceRoomView"},o.a.createElement(dl.a,null,o.a.createElement(Zi,{panel:e,resizeNotifier:this.props.resizeNotifier},this.renderBody())))}}i()(Jd,"contextType",j.a);var $d=a(431),Qd=a(355);class Xd extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"callEventGroupers",new Map),this.buildCallEventGroupers(this.props.searchResult.context.getTimeline())}buildCallEventGroupers(e){this.callEventGroupers=Object(Xo.c)(this.callEventGroupers,e)}render(){const e=this.props.searchResult,t=e.context.getEvent(),a=t.getId(),n=t.getTs(),i=[o.a.createElement($d.a,{key:n+"-search",roomId:t.getRoomId(),ts:n})],s=v.b.getValue("layout"),r=v.b.getValue("showTwelveHourTimestamps"),c=v.b.getValue("alwaysShowTimestamps"),l=v.b.getValue("feature_thread"),d=e.context.getTimeline();for(let t=0;t<d.length;t++){var m;const n=d[t];let p;const g=t!=e.context.getOurEventIndex();if(g||(p=this.props.searchHighlights),Object(Ps.c)(n,null===(m=this.context)||void 0===m?void 0:m.showHiddenEvents)){var h;const e=d[t-1],m=e&&!Object(vs.l)(e.getDate(),n.getDate())&&Object(Qo.b)(e,n,null===(h=this.context)||void 0===h?void 0:h.showHiddenEvents,l,Zn.a.Search);let b=!0;const v=d[t+1];if(v){var u;b=Object(vs.l)(n.getDate(),v.getDate())||n.getSender()!==v.getSender()||!Object(Qo.b)(n,v,null===(u=this.context)||void 0===u?void 0:u.showHiddenEvents,l,Zn.a.Search)}i.push(o.a.createElement(Qd.a,{key:`${a}+${t}`,mxEvent:n,layout:s,contextual:g,highlights:p,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,onHeightChanged:this.props.onHeightChanged,isTwelveHour:r,alwaysShowTimestamps:c,lastInSection:b,continuation:m,callEventGrouper:this.callEventGroupers.get(n.getContent().call_id)}))}}return o.a.createElement("li",{"data-scroll-tokens":a},o.a.createElement("ol",null,i))}}i()(Xd,"contextType",Zn.b);var Zd=a(788);class em extends o.a.PureComponent{render(){return o.a.createElement("div",{className:"mx_TopUnreadMessagesBar"},o.a.createElement(U.a,{className:"mx_TopUnreadMessagesBar_scrollUp",title:Object(N.a)("Jump to first unread message."),onClick:this.props.onScrollUpClick}),o.a.createElement(U.a,{className:"mx_TopUnreadMessagesBar_markAsRead",title:Object(N.a)("Mark all as read"),onClick:this.props.onCloseClick}))}}var tm=a(153);const am=["upgradeRecommendation"],nm=["upgradeRecommendation"];function im(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function sm(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?im(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):im(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}let om=function(e){};const rm="sandbox"in document.createElement("iframe");var cm;(function(e){e[e.Timeline=0]="Timeline",e[e.MaximisedWidget=1]="MaximisedWidget",e[e.Video=2]="Video"})(cm||(cm={}));class lm extends o.a.Component{constructor(e,t){var a;super(e,t),a=this,i()(this,"dispatcherRef",void 0),i()(this,"roomStoreToken",void 0),i()(this,"settingWatchers",void 0),i()(this,"unmounted",!1),i()(this,"permalinkCreators",{}),i()(this,"searchId",void 0),i()(this,"roomView",Object(s.createRef)()),i()(this,"searchResultsPanel",Object(s.createRef)()),i()(this,"messagePanel",void 0),i()(this,"roomViewBody",Object(s.createRef)()),i()(this,"context",void 0),i()(this,"onIsResizing",e=>{this.setState({resizing:e})}),i()(this,"onWidgetStoreUpdate",()=>{this.state.room&&this.checkWidgets(this.state.room)}),i()(this,"onWidgetEchoStoreUpdate",()=>{this.state.room&&this.checkWidgets(this.state.room)}),i()(this,"onWidgetLayoutChange",()=>{this.state.room&&(b.a.dispatch({action:"appsDrawer",show:!0}),ei.d.instance.hasMaximisedWidget(this.state.room)?as.a.instance.setCard({phase:ts.a.Timeline}):as.a.instance.isOpen&&as.a.instance.roomPhaseHistory.some(e=>e.phase===ts.a.Timeline)&&(as.a.instance.setCard({phase:ts.a.RoomSummary}),as.a.instance.togglePanel()),this.checkWidgets(this.state.room))}),i()(this,"checkWidgets",e=>{this.setState({hasPinnedWidgets:ei.d.instance.hasPinnedWidgets(e),mainSplitContentType:this.getMainSplitContentType(e),showApps:this.shouldShowApps(e)})}),i()(this,"getMainSplitContentType",e=>v.b.getValue("feature_video_rooms")&&e.isElementVideoRoom()?cm.Video:ei.d.instance.hasMaximisedWidget(e)?cm.MaximisedWidget:cm.Timeline),i()(this,"onRoomViewStoreUpdate",async e=>{if(this.unmounted)return;if(!e&&this.state.roomId!==vt.a.instance.getRoomId())return;const t=vt.a.instance.getRoomId(),n={roomId:t,roomAlias:vt.a.instance.getRoomAlias(),roomLoading:vt.a.instance.isRoomLoading(),roomLoadError:vt.a.instance.getRoomLoadError(),joining:vt.a.instance.isJoining(),replyToEvent:vt.a.instance.getQuotingEvent(),shouldPeek:this.state.matrixClientIsReady&&vt.a.instance.shouldPeek(),showReadReceipts:v.b.getValue("showReadReceipts",t),showRedactions:v.b.getValue("showRedactions",t),showJoinLeaves:v.b.getValue("showJoinLeaves",t),showAvatarChanges:v.b.getValue("showAvatarChanges",t),showDisplaynameChanges:v.b.getValue("showDisplaynameChanges",t),wasContextSwitch:vt.a.instance.getWasContextSwitch(),initialEventId:null,showRightPanel:as.a.instance.isOpenForRoom(t)},i=vt.a.instance.getInitialEventId();if(i){var s,o;const e=this.context.getRoom(t);let a=null==e?void 0:e.findEventById(i);a||(a=await Object(tm.f)(this.context,t,i)),n.initialEventPixelOffset=null;const c=null===(s=a)||void 0===s?void 0:s.getThread();var r;if(!c||null!==(o=a)&&void 0!==o&&o.isThreadRoot)n.initialEventId=i,n.isInitialEventHighlighted=vt.a.instance.isInitialEventHighlighted(),n.initialEventScrollIntoView=vt.a.instance.initialEventScrollIntoView(),c&&null!==(r=a)&&void 0!==r&&r.isThreadRoot&&Object(Xl.a)({rootEvent:c.rootEvent,initialEvent:a,highlighted:vt.a.instance.isInitialEventHighlighted(),scroll_into_view:vt.a.instance.initialEventScrollIntoView()});else Object(Xl.a)({rootEvent:c.rootEvent,initialEvent:a,highlighted:vt.a.instance.isInitialEventHighlighted(),scroll_into_view:vt.a.instance.initialEventScrollIntoView()})}if(this.settingWatchers=this.settingWatchers.concat([v.b.watchSetting("showReadReceipts",t,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showReadReceipts:i})})),v.b.watchSetting("showRedactions",t,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showRedactions:i})})),v.b.watchSetting("showJoinLeaves",t,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showJoinLeaves:i})})),v.b.watchSetting("showAvatarChanges",t,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showAvatarChanges:i})})),v.b.watchSetting("showDisplaynameChanges",t,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showDisplaynameChanges:i})}))]),e||!this.state.shouldPeek||n.shouldPeek||this.context.stopPeeking(),Sa.a.log("RVS update:",n.roomId,n.roomAlias,"loading?",n.roomLoading,"joining?",n.joining,"initial?",e,"shouldPeek?",n.shouldPeek),e&&(n.room=this.context.getRoom(n.roomId),n.room&&(n.showApps=this.shouldShowApps(n.room),this.onRoomLoaded(n.room))),null===this.state.roomId&&null!==n.roomId&&!n.initialEventId){const e=rl.getScrollState(n.roomId);e&&(n.initialEventId=e.focussedEvent,n.initialEventPixelOffset=e.pixelOffset)}this.state.initialEventId!==n.initialEventId&&(n.searchResults=null),this.setState(n),e&&this.setupRoom(n.room,n.roomId,n.joining,n.shouldPeek)}),i()(this,"getRoomId",()=>this.state.room?this.state.room.roomId:this.state.roomId),i()(this,"onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:as.a.instance.isOpenForRoom(this.state.roomId)})}),i()(this,"onPageUnload",e=>Di.a.sharedInstance().getCurrentUploads().length>0?e.returnValue=Object(N.a)("You seem to be uploading files, are you sure you want to quit?"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=Object(N.a)("You seem to be in a call, are you sure you want to quit?"):void 0),i()(this,"onReactKeyDown",e=>{let t=!1;switch(Object(le.a)().getRoomAction(e)){case Ue.h.DismissReadMarker:this.messagePanel.forgetReadMarker(),this.jumpToLiveTimeline(),t=!0;break;case Ue.h.JumpToOldestUnread:this.jumpToReadMarker(),t=!0;break;case Ue.h.UploadFile:b.a.dispatch({action:"upload_file",context:Zn.a.Room},!0),t=!0}t&&(e.stopPropagation(),e.preventDefault())}),i()(this,"onCallState",e=>{if(!e)return;const t=this.getCallForRoom();this.setState({callState:t?t.state:null})}),i()(this,"onAction",async e=>{var t;switch(e.action){case"message_sent":this.checkDesktopNotifications();break;case"post_sticker_message":this.injectSticker(e.data.content.url,e.data.content.info,e.data.description||e.data.name,e.data.threadId);break;case"picture_snapshot":Di.a.sharedInstance().sendContentListToRoom([e.file],this.state.room.roomId,null,this.context);break;case"notifier_enabled":case M.a.UploadStarted:case M.a.UploadFinished:case M.a.UploadCanceled:this.forceUpdate();break;case"appsDrawer":this.setState({showApps:e.show});break;case"reply_to_event":!this.unmounted&&this.state.searchResults&&(null===(t=e.event)||void 0===t?void 0:t.getRoomId())===this.state.roomId&&e.context===Zn.a.Search&&this.onCancelSearchClick();break;case"MatrixActions.sync":var a;if(!this.state.matrixClientIsReady)this.setState({matrixClientIsReady:null===(a=this.context)||void 0===a?void 0:a.isInitialSyncComplete()},()=>{this.onRoomViewStoreUpdate(!0)});break;case"focus_search":this.onSearchClick();break;case M.a.EditEvent:{if(e.timelineRenderingType!==this.state.timelineRenderingType)return;const t=e.event?new jc(e.event):null;this.setState({editState:t},()=>{var t;e.event&&(null===(t=this.messagePanel)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))});break}case M.a.ComposerInsert:{if(e.composerType)break;let t=e.timelineRenderingType;if(t===Zn.a.Thread)break;this.state.timelineRenderingType===Zn.a.Search&&e.timelineRenderingType===Zn.a.Search&&(await this.onCancelSearchClick(),t=Zn.a.Room),b.a.dispatch(sm(sm({},e),{},{timelineRenderingType:t,composerType:this.state.editState?Lc.a.Edit:Lc.a.Send}));break}case M.a.FocusAComposer:b.a.dispatch(sm(sm({},e),{},{action:this.state.editState?M.a.FocusEditMessageComposer:M.a.FocusSendMessageComposer}));break;case"scroll_to_bottom":var n;if(e.timelineRenderingType===Zn.a.Room)null===(n=this.messagePanel)||void 0===n||n.jumpToLiveTimeline()}}),i()(this,"onRoomTimeline",(e,t,a,n,i)=>{var s;this.unmounted||t&&t.roomId===(null===(s=this.state.room)||void 0===s?void 0:s.roomId)&&i.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&(this.updateE2EStatus(t),this.updatePreviewUrlVisibility(t)),!a&&i&&i.liveEvent&&(this.state.joining||(e.isBeingDecrypted()||e.isDecryptionFailure()||this.handleEffects(e),e.getSender()!==this.context.credentials.userId&&(!this.state.searchResults&&this.state.atEndOfLiveTimeline||Object(Mi.a)(e,this.state)||this.setState((e,t)=>({numUnreadMessages:e.numUnreadMessages+1}))))))}),i()(this,"onEventDecrypted",e=>{this.state.room&&this.state.matrixClientIsReady&&e.getRoomId()===this.state.room.roomId&&(e.isDecryptionFailure()||this.handleEffects(e))}),i()(this,"handleEffects",e=>{ze.a.instance.getRoomState(this.state.room).isUnread&&Nn.CHAT_EFFECTS.forEach(t=>{(Object(Pn.containsEmoji)(e.getContent(),t.emojis)||e.getContent().msgtype===t.msgType)&&(v.b.getValue("feature_thread")&&e.isThreadRelation||b.a.dispatch({action:"effects."+t.command}))})}),i()(this,"onRoomName",e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()}),i()(this,"onKeyBackupStatus",()=>{this.forceUpdate()}),i()(this,"canResetTimeline",()=>!this.messagePanel||this.messagePanel.canResetTimeline()),i()(this,"onRoomLoaded",e=>{this.unmounted||(ei.d.instance.on(ei.d.emissionForRoom(e),this.onWidgetLayoutChange),this.calculatePeekRules(e),this.updatePreviewUrlVisibility(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updateE2EStatus(e),this.updatePermissions(e),this.checkWidgets(e),this.setState({tombstone:this.getRoomTombstone(e),liveTimeline:e.getLiveTimeline()}))}),i()(this,"onRoom",e=>{e&&e.roomId===this.state.roomId&&(this.state.room&&ei.d.instance.off(ei.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.setState({room:e},()=>{this.onRoomLoaded(e)}))}),i()(this,"onDeviceVerificationChanged",e=>{const t=this.state.room;t.currentState.getMember(e)&&this.updateE2EStatus(t)}),i()(this,"onUserVerificationChanged",e=>{const t=this.state.room;t&&t.currentState.getMember(e)&&this.updateE2EStatus(t)}),i()(this,"onCrossSigningKeysChanged",()=>{const e=this.state.room;e&&this.updateE2EStatus(e)}),i()(this,"onUrlPreviewsEnabledChange",()=>{this.state.room&&this.updatePreviewUrlVisibility(this.state.room)}),i()(this,"onRoomStateEvents",(e,t)=>{if(this.state.room&&this.state.room.roomId===t.roomId)switch(e.getType()){case ge.b.RoomTombstone:this.setState({tombstone:this.getRoomTombstone()});break;default:this.updatePermissions(this.state.room)}}),i()(this,"onRoomStateUpdate",e=>{var t;e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&this.updateRoomMembers()}),i()(this,"onMyMembership",(e,t,a)=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))}),i()(this,"updateRoomMembers",Object(x.throttle)(()=>{this.updateDMState(),this.updateE2EStatus(this.state.room)},500,{leading:!0,trailing:!0})),i()(this,"onSearchResultsFillRequest",e=>{if(!e)return Promise.resolve(!1);if(this.state.searchResults.next_batch){om("requesting more search results");const e=function(e){const t=Li.a.get(),a=Et.a.get();return e.pendingRequest?e.pendingRequest:null===t?a.backPaginateRoomEventsSearch(e):Qi(e)}(this.state.searchResults);return this.handleSearchResult(e)}return om("no more search results"),Promise.resolve(!1)}),i()(this,"onInviteClick",()=>{b.a.dispatch({action:"view_invite",roomId:this.state.room.roomId})}),i()(this,"onJoinButtonClicked",()=>{var e;null!==(e=this.context)&&void 0!==e&&e.isGuest()?(b.a.dispatch({action:M.a.DoAfterSyncPrepared,deferred_action:{action:M.a.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}}),b.a.dispatch({action:"require_registration"})):Promise.resolve().then(()=>{var e,t;const a=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.signUrl;return b.a.dispatch({action:M.a.JoinRoom,roomId:this.getRoomId(),opts:{inviteSignUrl:a},metricsTrigger:"invite"===(null===(t=this.state.room)||void 0===t?void 0:t.getMyMembership())?"Invite":"RoomPreview"}),Promise.resolve()})}),i()(this,"onMessageListScroll",e=>{this.messagePanel.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar()}),i()(this,"resetJumpToEvent",e=>{this.state.initialEventId&&this.state.initialEventScrollIntoView&&this.state.initialEventId===e&&(om("Removing scroll_into_view flag from initial event"),b.a.dispatch({action:M.a.ViewRoom,room_id:this.state.room.roomId,event_id:this.state.initialEventId,highlighted:this.state.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))}),i()(this,"onSearch",(e,t)=>{let a;this.setState({searchTerm:e,searchScope:t,searchResults:{},searchHighlights:[]}),this.searchResultsPanel.current&&this.searchResultsPanel.current.resetScrollState(),this.searchId=(new Date).getTime(),t===jl.Room&&(a=this.state.room.roomId),om("sending search request");const n=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;const a=Li.a.get();return null===a?Bi(e,t):$i(e,t)}(e,a);this.handleSearchResult(n)}),i()(this,"onCallPlaced",e=>{var t;ne.b.instance.placeCall(null===(t=this.state.room)||void 0===t?void 0:t.roomId,e)}),i()(this,"onAppsClick",()=>{b.a.dispatch({action:"appsDrawer",show:!this.state.showApps})}),i()(this,"onForgetClick",()=>{b.a.dispatch({action:"forget_room",room_id:this.state.room.roomId})}),i()(this,"onRejectButtonClicked",()=>{this.setState({rejecting:!0}),this.context.leave(this.state.roomId).then(()=>{b.a.dispatch({action:M.a.ViewHomePage}),this.setState({rejecting:!1})},e=>{Sa.a.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e);gt.a.createTrackedDialog("Failed to reject invite","",Yn.a,{title:Object(N.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})})}),i()(this,"onRejectAndIgnoreClick",async()=>{this.setState({rejecting:!0});try{const e=this.state.room.getMember(this.context.getUserId()).events.member,t=this.context.getIgnoredUsers();t.push(e.getSender()),await this.context.setIgnoredUsers(t),await this.context.leave(this.state.roomId),b.a.dispatch({action:M.a.ViewHomePage}),this.setState({rejecting:!1})}catch(e){Sa.a.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e);gt.a.createTrackedDialog("Failed to reject invite","",Yn.a,{title:Object(N.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})}}),i()(this,"onRejectThreepidInviteButtonClicked",()=>{b.a.fire(M.a.ViewRoomDirectory)}),i()(this,"onSearchClick",()=>{this.setState({timelineRenderingType:this.state.timelineRenderingType===Zn.a.Search?Zn.a.Room:Zn.a.Search})}),i()(this,"onCancelSearchClick",()=>new Promise(e=>{this.setState({timelineRenderingType:Zn.a.Room,searchResults:null},e)})),i()(this,"jumpToLiveTimeline",()=>{this.state.initialEventId&&this.state.isInitialEventHighlighted?b.a.dispatch({action:M.a.ViewRoom,room_id:this.state.room.roomId,metricsTrigger:void 0}):(this.messagePanel.jumpToLiveTimeline(),b.a.fire(M.a.FocusSendMessageComposer))}),i()(this,"jumpToReadMarker",()=>{this.messagePanel.jumpToReadMarker()}),i()(this,"forgetReadMarker",e=>{e.stopPropagation(),this.messagePanel.forgetReadMarker()}),i()(this,"updateTopUnreadMessagesBar",()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})}),i()(this,"onStatusBarVisible",()=>{this.unmounted||this.state.statusBarVisible||this.setState({statusBarVisible:!0})}),i()(this,"onStatusBarHidden",()=>{!this.unmounted&&this.state.statusBarVisible&&this.setState({statusBarVisible:!1})}),i()(this,"handleScrollKey",e=>{let t;this.searchResultsPanel.current?t=this.searchResultsPanel.current:this.messagePanel&&(t=this.messagePanel),t&&t.handleScrollKey(e)}),i()(this,"gatherTimelinePanelRef",e=>{this.messagePanel=e}),i()(this,"onHiddenHighlightsClick",()=>{const e=this.getOldRoom();e&&b.a.dispatch({action:M.a.ViewRoom,room_id:e.roomId,metricsTrigger:"Predecessor"})}),i()(this,"onFileDrop",e=>{var t,a;return Di.a.sharedInstance().sendContentListToRoom(Array.from(e.files),null!==(t=null===(a=this.state.room)||void 0===a?void 0:a.roomId)&&void 0!==t?t:this.state.roomId,null,this.context,Zn.a.Room)}),i()(this,"onMeasurement",e=>{this.setState({narrow:e})});const n=t.hasLazyLoadMembersEnabled();this.state={roomId:null,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!n,numUnreadMessages:0,searchResults:null,callState:null,canPeek:!1,showApps:!1,isPeeking:!1,showRightPanel:!1,joining:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canSendMessages:!1,resizing:!1,layout:v.b.getValue("layout"),lowBandwidth:v.b.getValue("lowBandwidth"),alwaysShowTimestamps:v.b.getValue("alwaysShowTimestamps"),showTwelveHourTimestamps:v.b.getValue("showTwelveHourTimestamps"),readMarkerInViewThresholdMs:v.b.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:v.b.getValue("readMarkerOutOfViewThresholdMs"),showHiddenEvents:v.b.getValue("showHiddenEventsInTimeline"),showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:null==t?void 0:t.isInitialSyncComplete(),mainSplitContentType:cm.Timeline,timelineRenderingType:Zn.a.Room,liveTimeline:void 0,narrow:!1},this.dispatcherRef=b.a.register(this.onAction),t.on(r.b.Room,this.onRoom),t.on(pe.c.Timeline,this.onRoomTimeline),t.on(pe.c.Name,this.onRoomName),t.on(m.b.Events,this.onRoomStateEvents),t.on(m.b.Update,this.onRoomStateUpdate),t.on(pe.c.MyMembership,this.onMyMembership),t.on(Ni.b.KeyBackupStatus,this.onKeyBackupStatus),t.on(Ni.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),t.on(Ni.b.UserTrustStatusChanged,this.onUserVerificationChanged),t.on(Ni.b.KeysChanged,this.onCrossSigningKeysChanged),t.on(yn.c.Decrypted,this.onEventDecrypted),this.roomStoreToken=vt.a.instance.addListener(this.onRoomViewStoreUpdate),as.a.instance.on(L.b,this.onRightPanelStoreUpdate),cl.a.on(L.b,this.onWidgetEchoStoreUpdate),Ei.a.instance.on(L.b,this.onWidgetStoreUpdate),this.props.resizeNotifier.on("isResizing",this.onIsResizing),this.settingWatchers=[v.b.watchSetting("layout",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({layout:i})})),v.b.watchSetting("lowBandwidth",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({lowBandwidth:i})})),v.b.watchSetting("alwaysShowTimestamps",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({alwaysShowTimestamps:i})})),v.b.watchSetting("showTwelveHourTimestamps",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showTwelveHourTimestamps:i})})),v.b.watchSetting("readMarkerInViewThresholdMs",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({readMarkerInViewThresholdMs:i})})),v.b.watchSetting("readMarkerOutOfViewThresholdMs",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({readMarkerOutOfViewThresholdMs:i})})),v.b.watchSetting("showHiddenEventsInTimeline",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showHiddenEvents:i})})),v.b.watchSetting("urlPreviewsEnabled",null,this.onUrlPreviewsEnabledChange),v.b.watchSetting("urlPreviewsEnabled_e2ee",null,this.onUrlPreviewsEnabledChange)]}getPermalinkCreatorForRoom(e){return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new Mn.a(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,a,n){!a&&t&&(!e&&n?(Sa.a.info("Attempting to peek into room %s",t),this.setState({peekLoading:!0,isPeeking:!0}),this.context.peekInRoom(t).then(e=>{this.unmounted||(this.setState({room:e,peekLoading:!1}),this.onRoomLoaded(e))}).catch(e=>{if(!this.unmounted){if(this.setState({isPeeking:!1}),"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode&&"M_FORBIDDEN"!==e.errcode)throw e;this.setState({peekLoading:!1})}})):e&&(this.context.stopPeeking(),this.setState({isPeeking:!1})))}shouldShowApps(e){if(!rm||!e)return!1;const t=e.roomId+"_hide_widget_drawer",a=localStorage.getItem(t),n=!a||"false"===a,i=ei.d.instance.getContainerWidgets(e,ei.a.Top);return n&&i.length>0}componentDidMount(){this.onRoomViewStoreUpdate(!0);const e=this.getCallForRoom(),t=e?e.state:null;this.setState({callState:t}),ne.b.instance.on(ne.a.CallState,this.onCallState),window.addEventListener("beforeunload",this.onPageUnload)}shouldComponentUpdate(e,t){const a=Object(xn.c)(this.props,e),n=this.state,{upgradeRecommendation:i}=n,s=Ee()(n,am),{upgradeRecommendation:o}=t,r=Ee()(t,nm),c=(null==o?void 0:o.needsUpgrade)!==(null==i?void 0:i.needsUpgrade)||Object(xn.c)(s,r);return a||c}componentDidUpdate(){this.messagePanel&&void 0===this.state.atEndOfLiveTimeline&&this.setState({atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()})}componentWillUnmount(){this.unmounted=!0,ne.b.instance.removeListener(ne.a.CallState,this.onCallState),this.state.roomId&&rl.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek&&this.context.stopPeeking(),this.stopAllPermalinkCreators(),b.a.unregister(this.dispatcherRef),this.context&&(this.context.removeListener(r.b.Room,this.onRoom),this.context.removeListener(pe.c.Timeline,this.onRoomTimeline),this.context.removeListener(pe.c.Name,this.onRoomName),this.context.removeListener(m.b.Events,this.onRoomStateEvents),this.context.removeListener(pe.c.MyMembership,this.onMyMembership),this.context.removeListener(m.b.Update,this.onRoomStateUpdate),this.context.removeListener(Ni.b.KeyBackupStatus,this.onKeyBackupStatus),this.context.removeListener(Ni.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),this.context.removeListener(Ni.b.UserTrustStatusChanged,this.onUserVerificationChanged),this.context.removeListener(Ni.b.KeysChanged,this.onCrossSigningKeysChanged),this.context.removeListener(yn.c.Decrypted,this.onEventDecrypted)),window.removeEventListener("beforeunload",this.onPageUnload),this.roomStoreToken&&this.roomStoreToken.remove(),as.a.instance.off(L.b,this.onRightPanelStoreUpdate),cl.a.removeListener(L.b,this.onWidgetEchoStoreUpdate),Ei.a.instance.removeListener(L.b,this.onWidgetStoreUpdate),this.props.resizeNotifier.off("isResizing",this.onIsResizing),this.state.room&&ei.d.instance.off(ei.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),ne.b.instance.off(ne.a.CallState,this.onCallState),this.updateRoomMembers.cancel();for(const e of this.settingWatchers)v.b.unwatchSetting(e)}getRoomTombstone(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.state.room;return null==e?void 0:e.currentState.getStateEvents(ge.b.RoomTombstone,"")}async calculateRecommendedVersion(e){const t=await e.getRecommendedVersion();this.unmounted||this.setState({upgradeRecommendation:t})}async loadMembersIfJoined(e){if(this.context.hasLazyLoadMembersEnabled()&&e&&"join"===e.getMyMembership())try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const a=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;Sa.a.error(a),Sa.a.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents(ge.b.RoomHistoryVisibility,"");this.setState({canPeek:(null==t?void 0:t.getContent().history_visibility)===Pi.b.WorldReadable})}updatePreviewUrlVisibility(e){let{roomId:t}=e;const a=this.context.isRoomEncrypted(t)?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";this.setState({showUrlPreview:v.b.getValue(a,t)})}async updateE2EStatus(e){if(!this.context.isRoomEncrypted(e.roomId))return;let t=ls.Warning;this.context.isCryptoEnabled()&&(t=await async function(e,t){const a=(await t.getEncryptionTargetMembers()).map(e=>{let{userId:t}=e;return t}),n=!!cs.a.shared().getUserIdForRoomId(t.roomId),i=[],s=[];a.filter(t=>t!==e.getUserId()).forEach(t=>{(e.checkUserTrust(t).isCrossSigningVerified()?i:s).push(t)});for(const t of s)if(e.checkUserTrust(t).wasCrossSigningVerified())return ls.Warning;const o=i.length>0&&!n&&2!==a.length||1===a.length?[...i,e.getUserId()]:i;for(const t of o){if(e.getStoredDevicesForUser(t).some(a=>{let{deviceId:n}=a;return!e.checkDeviceTrust(t,n).isVerified()}))return ls.Warning}return 0===s.length?ls.Verified:ls.Normal}(this.context,e)),this.unmounted||this.setState({e2eStatus:t})}updatePermissions(e){if(e){const t=this.context.getUserId(),a="join"===e.getMyMembership()&&e.currentState.maySendEvent("m.reaction",t),n=e.maySendMessage();this.setState({canReact:a,canSendMessages:n})}}checkDesktopNotifications(){this.state.room.getJoinedMemberCount()+this.state.room.getInvitedMemberCount()>1&&wd.default.shouldShowPrompt()&&Object(Cd.b)(!0)}updateDMState(){const e=this.state.room;if("join"!=e.getMyMembership())return;const t=e.getDMInviter();t&&Ai.d(e.roomId,t)}injectSticker(e,t,a,n){this.context.isGuest()?b.a.dispatch({action:"require_registration"}):Di.a.sharedInstance().sendStickerContentToRoom(e,this.state.room.roomId,n,t,a,this.context).then(void 0,e=>{e.name})}handleSearchResult(e){const t=this.searchId;return this.setState({searchInProgress:!0}),e.then(async e=>{if(om("search complete"),this.unmounted||this.state.timelineRenderingType!==Zn.a.Search||this.searchId!=t)return Sa.a.error("Discarding stale search results"),!1;let a=e.highlights;if(a.indexOf(this.state.searchTerm)<0&&(a=a.concat(this.state.searchTerm)),a=a.sort((function(e,t){return t.length-e.length})),this.context.supportsExperimentalThreads())for(const t of e.results)for(const e of t.context.getTimeline()){if(!e.getServerAggregatedRelation(_n.c.name)||e.getThread())continue;const t=this.context.getRoom(e.getRoomId()),a=t.findThreadForEvent(e);a?e.setThread(a):t.createThread(e.getId(),e,[],!0)}this.setState({searchHighlights:a,searchResults:e})},e=>(Sa.a.error("Search failed",e),gt.a.createTrackedDialog("Search failed","",Yn.a,{title:Object(N.a)("Search failed"),description:e&&e.message?e.message:Object(N.a)("Server may be unavailable, overloaded, or search timed out :(")}),!1)).finally(()=>{this.setState({searchInProgress:!1})})}getSearchResultTiles(){const e=[];var t,a;(this.state.searchInProgress&&e.push(o.a.createElement("li",{key:"search-spinner"},o.a.createElement(un.a,null))),this.state.searchResults.next_batch)||(null!==(t=this.state.searchResults)&&void 0!==t&&null!==(a=t.results)&&void 0!==a&&a.length?e.push(o.a.createElement("li",{key:"search-top-marker"},o.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(N.a)("No more results")))):e.push(o.a.createElement("li",{key:"search-top-marker"},o.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(N.a)("No results")))));const n=()=>{const e=this.searchResultsPanel.current;e&&e.checkScroll()};let i;for(let t=((null===(s=this.state.searchResults)||void 0===s||null===(r=s.results)||void 0===r?void 0:r.length)||0)-1;t>=0;t--){var s,r;const a=this.state.searchResults.results[t],c=a.context.getEvent(),l=c.getRoomId(),d=this.context.getRoom(l);if(!d){Sa.a.log("Hiding search result from an unknown room",l);continue}if(!Object(Ps.c)(c,this.state.showHiddenEvents))continue;"All"===this.state.searchScope&&l!==i&&(e.push(o.a.createElement("li",{key:c.getId()+"-room"},o.a.createElement("h2",null,Object(N.a)("Room"),": ",d.name))),i=l);const m="#/room/"+l+"/"+c.getId();e.push(o.a.createElement(Xd,{key:c.getId(),searchResult:a,searchHighlights:this.state.searchHighlights,resultLink:m,permalinkCreator:this.getPermalinkCreatorForRoom(d),onHeightChanged:n}))}return e}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?ne.b.instance.getCallForRoom(this.state.room.roomId):null}getOldRoom(){const e=this.state.room.currentState.getStateEvents(ge.b.RoomCreate,"");return e&&e.getContent().predecessor?this.context.getRoom(e.getContent().predecessor.room_id):null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount(pe.a.Highlight):0}get messagePanelClassNames(){return l()("mx_RoomView_messagePanel",{mx_IRCLayout:this.state.layout===nr.a.IRC,mx_GroupLayout:this.state.layout===nr.a.Group})}render(){var e;if(!this.state.room){const e=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(e){const t=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return o.a.createElement("div",{className:"mx_RoomView"},o.a.createElement(dl.a,null,o.a.createElement(gl,{canPreview:!1,previewLoading:t&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:e,joining:this.state.joining,oobData:this.props.oobData})))}{var t,a;let e=void 0;this.props.oobData&&(e=this.props.oobData.inviterName);const n=null===(t=this.props.threepidInvite)||void 0===t?void 0:t.toEmail,i=this.state.roomAlias;return o.a.createElement("div",{className:"mx_RoomView"},o.a.createElement(dl.a,null,o.a.createElement(gl,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:i,joining:this.state.joining,inviterName:e,invitedEmail:n,oobData:this.props.oobData,signUrl:null===(a=this.props.threepidInvite)||void 0===a?void 0:a.signUrl,room:this.state.room})))}}const n=this.state.room.getMyMembership();if(this.state.room.isElementVideoRoom()&&(!v.b.getValue("feature_video_rooms")||"join"!==n))return o.a.createElement(dl.a,null,o.a.createElement("div",{className:"mx_MainSplit"},o.a.createElement(Rl,{room:this.state.room,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.onRejectButtonClicked})),";");if("invite"===n&&!this.state.room.isSpaceRoom()){if(this.state.joining||this.state.rejecting)return o.a.createElement(dl.a,null,o.a.createElement(gl,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting}));{const e=this.context.credentials.userId,t=this.state.room.getMember(e),a=t?t.events.member:null;let n=Object(N.a)("Unknown");return a&&(n=a.sender?a.sender.name:a.getSender()),o.a.createElement("div",{className:"mx_RoomView"},o.a.createElement(dl.a,null,o.a.createElement(gl,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectButtonClicked,onRejectAndIgnoreClick:this.onRejectAndIgnoreClick,inviterName:n,canPreview:!1,joining:this.state.joining,room:this.state.room})))}}let i=null;{const e=this.getCallForRoom();e&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(i=e)}const s=l()({mx_RoomView_scrollheader:!0});let r,c=!0;Di.a.sharedInstance().getCurrentUploads().length>0?r=o.a.createElement(Pc,{room:this.state.room}):this.state.searchResults||(c=this.state.statusBarVisible,r=o.a.createElement(Zd.a,{room:this.state.room,isPeeking:"join"!==n,onInviteClick:this.onInviteClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden}));const d=l()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:c}),m=r&&o.a.createElement("div",{className:d},o.a.createElement("div",{className:"mx_RoomView_statusAreaBox"},o.a.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),r)),h=this.state.upgradeRecommendation,u=h&&h.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.credentials.userId),p=this.getHiddenHighlightCount();let g,b=null;if(this.state.timelineRenderingType===Zn.a.Search)b=o.a.createElement(Il,{searchInProgress:this.state.searchInProgress,onCancelClick:this.onCancelSearchClick,onSearch:this.onSearch,isRoomEncrypted:this.context.isRoomEncrypted(this.state.room.roomId)});else if(u)b=o.a.createElement(Pl,{room:this.state.room});else if("join"!==n){var f,E;let e=void 0;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(f=this.props.threepidInvite)||void 0===f?void 0:f.toEmail;if(g=o.a.createElement(gl,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room}),!(this.state.canPeek||null!==(E=this.state.room)&&void 0!==E&&E.isSpaceRoom()))return o.a.createElement("div",{className:"mx_RoomView"},g)}else p>0&&(b=o.a.createElement(U.a,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},Object(N.a)("You have %(count)s unread notifications in a prior version of this room.",{count:p})));if(null!==(e=this.state.room)&&void 0!==e&&e.isSpaceRoom()&&!this.props.forceTimeline)return o.a.createElement(Jd,{space:this.state.room,justCreatedOpts:this.props.justCreatedOpts,resizeNotifier:this.props.resizeNotifier,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.props.threepidInvite?this.onRejectThreepidInviteButtonClicked:this.onRejectButtonClicked});const y=o.a.createElement(ql,{room:this.state.room,userId:this.context.credentials.userId,showApps:this.state.showApps,resizeNotifier:this.props.resizeNotifier},b);let _,S;let w;"join"===n&&!this.state.searchResults&&(_=o.a.createElement(Rc,{room:this.state.room,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room)})),this.state.searchResults&&(S={searchTerm:this.state.searchTerm,searchScope:this.state.searchScope,searchCount:this.state.searchResults.count});let C=!1;this.state.searchResults&&(w=void 0===this.state.searchResults.count?o.a.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner"}):o.a.createElement(ll.a,{ref:this.searchResultsPanel,className:"mx_RoomView_searchResultsPanel "+this.messagePanelClassNames,onFillRequest:this.onSearchResultsFillRequest,resizeNotifier:this.props.resizeNotifier},o.a.createElement("li",{className:s}),this.getSearchResultTiles()),C=!0);let O=null;this.state.isInitialEventHighlighted&&(O=this.state.initialEventId);const k=o.a.createElement(ar,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,sendReadReceiptOnLoad:!this.state.wasContextSwitch,manageReadMarkers:!this.state.isPeeking,hidden:C,highlightedEventId:O,eventId:this.state.initialEventId,eventScrollIntoView:this.state.initialEventScrollIntoView,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onEventScrolledIntoView:this.resetJumpToEvent,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:this.messagePanelClassNames,membersLoaded:this.state.membersLoaded,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room),resizeNotifier:this.props.resizeNotifier,showReactions:!0,layout:this.state.layout,editState:this.state.editState});let x,R=null;this.state.showTopUnreadMessagesBar&&!this.state.searchResults&&(R=o.a.createElement(em,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})),!1!==this.state.atEndOfLiveTimeline||this.state.searchResults||(x=o.a.createElement(el,{highlight:this.state.room.getUnreadNotificationCount(pe.a.Highlight)>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline}));const j=this.state.room&&this.state.showRightPanel?o.a.createElement(sl,{room:this.state.room,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room),e2eStatus:this.state.e2eStatus}):null,I=l()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts}),T=l()("mx_RoomView",{mx_RoomView_inCall:Boolean(i),mx_RoomView_immersive:this.state.mainSplitContentType===cm.Video}),P=v.b.getValue("showChatEffects");let M,D;switch(this.state.mainSplitContentType){case cm.Timeline:D="mx_MainSplit_timeline",M=o.a.createElement(o.a.Fragment,null,o.a.createElement(ir,{sensor:this.roomViewBody.current,onMeasurement:this.onMeasurement}),y,o.a.createElement("div",{className:I},o.a.createElement(Uc,{parent:this.roomView.current,onFileDrop:this.onFileDrop}),R,x,k,w),m,g,_);break;case cm.MaximisedWidget:D="mx_MainSplit_maximisedWidget",M=o.a.createElement(o.a.Fragment,null,o.a.createElement(Hl,{room:this.state.room,userId:this.context.credentials.userId,resizeNotifier:this.props.resizeNotifier,showApps:!0}),g);break;case cm.Video:D="mx_MainSplit_video",M=o.a.createElement(o.a.Fragment,null,o.a.createElement(Sd,{room:this.state.room,resizing:this.state.resizing}),g)}const A=l()("mx_RoomView_body",D);let L=[ts.a.Timeline],F=this.onCallPlaced,B=this.onAppsClick,V=this.onForgetClick,W=this.onSearchClick,H=null;switch(this.state.mainSplitContentType){case cm.MaximisedWidget:L=[ts.a.ThreadPanel,ts.a.PinnedMessages],B=null,V=null,W=null;break;case cm.Video:L=[ts.a.ThreadPanel,ts.a.PinnedMessages,ts.a.NotificationPanel],F=null,B=null,V=null,W=null,this.state.room.canInvite(this.context.credentials.userId)&&(H=this.onInviteClick)}return o.a.createElement(Zn.b.Provider,{value:this.state},o.a.createElement("main",{className:T,ref:this.roomView,onKeyDown:this.onReactKeyDown},P&&this.roomView.current&&o.a.createElement(vd,{roomWidth:this.roomView.current.offsetWidth}),o.a.createElement(dl.a,null,o.a.createElement(bd,{room:this.state.room,searchInfo:S,oobData:this.props.oobData,inRoom:"join"===n,onSearchClick:W,onInviteClick:H,onForgetClick:"leave"===n?V:null,e2eStatus:this.state.e2eStatus,onAppsClick:this.state.hasPinnedWidgets?B:null,appsShown:this.state.showApps,onCallPlaced:F,excludedRightPanelPhaseButtons:L}),o.a.createElement(Zi,{panel:j,resizeNotifier:this.props.resizeNotifier},o.a.createElement("div",{className:A,ref:this.roomViewBody,"data-layout":this.state.layout},M)))))}}i()(lm,"contextType",j.a);var dm=Object(j.b)(lm);class mm extends s.Component{constructor(e,t){super(e,t),i()(this,"onToastStoreUpdate",()=>{this.setState({toasts:Z.a.sharedInstance().getToasts(),countSeen:Z.a.sharedInstance().getCountSeen()})}),this.state={toasts:Z.a.sharedInstance().getToasts(),countSeen:Z.a.sharedInstance().getCountSeen()},Z.a.sharedInstance().on("update",this.onToastStoreUpdate)}componentWillUnmount(){Z.a.sharedInstance().removeListener("update",this.onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let a,n;if(0!==e){const i=this.state.toasts[0],{title:o,icon:r,key:c,component:d,className:m,bodyClassName:h,props:u}=i,p=l()("mx_Toast_body",h),g=l()("mx_Toast_toast",m,{mx_Toast_hasIcon:r,["mx_Toast_icon_"+r]:r}),b=Object.assign({},u,{key:c,toastKey:c}),v=s.createElement(d,b);let f,E;(o&&t||this.state.countSeen>0)&&(f=` (${this.state.countSeen+1}/${this.state.countSeen+e})`),o&&(E=s.createElement("div",{className:"mx_Toast_title"},s.createElement("h2",null,o),s.createElement("span",{className:"mx_Toast_title_countIndicator"},f))),a=s.createElement("div",{className:g},E,s.createElement("div",{className:p},v)),n=l()("mx_ToastContainer",{mx_ToastContainer_stacked:t})}return a?s.createElement("div",{className:n,role:"alert"},a):null}}class hm extends o.a.Component{constructor(e){super(e),this.state={loading:!0}}componentDidMount(){this.props.userId&&this.loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this.loadProfileInfo()}async loadProfileInfo(){const e=Et.a.get();let t;this.setState({loading:!0});try{t=await e.getProfileInfo(this.props.userId)}catch(e){return gt.a.createTrackedDialog(Object(N.a)("Could not load user profile"),"",Yn.a,{title:Object(N.a)("Could not load user profile"),description:e&&e.message?e.message:Object(N.a)("Operation failed")}),void this.setState({loading:!1})}const a=new yn.b({type:"m.room.member",content:t}),n=new es.a(null,this.props.userId);n.setMembershipEvent(a),this.setState({member:n,loading:!1})}render(){if(this.state.loading)return o.a.createElement(un.a,null);if(this.state.member){const e=o.a.createElement(sl,{overwriteCard:{phase:ts.a.RoomMemberInfo,state:{member:this.state.member}},resizeNotifier:this.props.resizeNotifier});return o.a.createElement(Zi,{panel:e,resizeNotifier:this.props.resizeNotifier},o.a.createElement(J,null))}return o.a.createElement("div",null)}}var um=e=>{let{backgroundImage:t,blurMultiplier:a}=e;if(!t)return null;const n={};if(a){const e=getComputedStyle(document.documentElement).getPropertyValue("--lp-background-blur").replace("px",""),t=parseInt(e,10);isNaN(t)||(n.filter=`blur(${t*a}px)`)}return o.a.createElement("div",{className:"mx_BackdropPanel"},o.a.createElement("img",{style:n,className:"mx_BackdropPanel--image",src:t}))};var pm=e=>{var t;let{groupId:a}=e;const n=null!==(t=P.b.get().spaces_learn_more_url)&&void 0!==t?t:P.a.spaces_learn_more_url;return s.createElement(I.a,{className:"mx_HomePage mx_HomePage_default"},s.createElement("div",{className:"mx_HomePage_default_wrapper"},s.createElement("h1",{style:{fontSize:"24px"}},Object(N.a)("That link is no longer supported")),s.createElement("p",null,Object(N.a)("You're trying to access a community link (%(groupId)s).<br/>Communities are no longer supported and have been replaced by spaces.<br2/><a>Learn more about spaces here.</a>",{groupId:a},{br:()=>s.createElement("br",null),br2:()=>s.createElement("br",null),a:e=>s.createElement("a",{href:n,rel:"noreferrer noopener",target:"_blank"},e)}))))},gm=a(543);var bm=e=>{let{isMinimized:t}=e;const a=Object(F.b)(Hr.a.instance,Hr.b.MonitoringLivePosition,()=>Hr.a.instance.isMonitoringLiveLocation),n=Object(F.b)(Hr.a.instance,Hr.b.LocationPublishError,()=>Hr.a.instance.getLiveBeaconIdsWithLocationPublishError()),i=Object(F.b)(Hr.a.instance,Hr.b.BeaconUpdateError,()=>Hr.a.instance.getLiveBeaconIds().filter(e=>Hr.a.instance.beaconUpdateErrors.has(e))),r=Object(F.b)(Hr.a.instance,Hr.b.LivenessChange,()=>Hr.a.instance.getLiveBeaconIds()),c=!!n.length,d=!!i.length;if(((e,t)=>{Object(s.useEffect)(()=>{const a=()=>{"visible"===document.visibilityState&&e.forEach(e=>{var a;return null===(a=t.get(e))||void 0===a?void 0:a.monitorLiveness()})};return e.length&&document.addEventListener("visibilitychange",a),()=>{document.removeEventListener("visibilitychange",a)}},[e,t])})(r,Hr.a.instance.beacons),!a)return null;const m=((e,t,a)=>{var n,i;const s=null!==(n=null!==(i=null==t?void 0:t[0])&&void 0!==i?i:null==a?void 0:a[0])&&void 0!==n?n:null==e?void 0:e[0];if(!s)return;const o=Hr.a.instance.getBeaconById(s);return null==o?void 0:o.roomId})(r,i,n),h=m?()=>{b.a.dispatch({action:M.a.ViewRoom,room_id:m,metricsTrigger:void 0})}:void 0,u=((e,t)=>e?Object(N.a)("An error occurred while stopping your live location"):t?Object(N.a)("An error occurred whilst sharing your live location"):Object(N.a)("You are sharing your live location"))(d,c);return o.a.createElement(U.a,{className:l()("mx_LeftPanelLiveShareWarning",{mx_LeftPanelLiveShareWarning__minimized:t,mx_LeftPanelLiveShareWarning__error:c||d}),title:t?u:void 0,onClick:h},t?o.a.createElement(gm.a,{height:10}):u)};function vm(e){return e.closest("input, textarea, select, [contenteditable=true]")}class fm extends o.a.Component{constructor(e,t){super(e,t),i()(this,"_matrixClient",void 0),i()(this,"_roomView",void 0),i()(this,"_resizeContainer",void 0),i()(this,"resizeHandler",void 0),i()(this,"layoutWatcherRef",void 0),i()(this,"compactLayoutWatcherRef",void 0),i()(this,"backgroundImageWatcherRef",void 0),i()(this,"resizer",void 0),i()(this,"onCallState",()=>{const e=ne.b.instance.getAllActiveCalls();e!==this.state.activeCalls&&this.setState({activeCalls:e})}),i()(this,"refreshBackgroundImage",async()=>{let e=v.b.getValue("RoomList.backgroundImage");e=e?Object(si.b)(e).srcHttp:A.a.instance.getHttpAvatarUrl(),this.setState({backgroundImage:e})}),i()(this,"canResetTimelineInRoom",e=>!this._roomView.current||this._roomView.current.canResetTimeline()),i()(this,"onAccountData",e=>{"m.ignored_user_list"===e.getType()&&b.a.dispatch({action:"ignore_state_changed"})}),i()(this,"onCompactLayoutChanged",()=>{this.setState({useCompactLayout:v.b.getValue("useCompactLayout")})}),i()(this,"onSync",(e,t,a)=>{var n,i;const s=null===(n=this.state.syncErrorData)||void 0===n||null===(i=n.error)||void 0===i?void 0:i.errcode,o=a&&a.error&&a.error.errcode;e===t&&s===o||(this.setState({syncErrorData:e===d.b.Error?a:null}),t===d.b.Prepared&&e===d.b.Syncing?this.updateServerNoticeEvents():this.calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))}),i()(this,"onRoomStateEvents",e=>{const t=qt.b.instance.orderedLists[Q.a.ServerNotice];null!=t&&t.some(t=>t.roomId===e.getRoomId())&&this.updateServerNoticeEvents()}),i()(this,"onUsageLimitDismissed",()=>{this.setState({usageLimitDismissed:!0})}),i()(this,"updateServerNoticeEvents",async()=>{const e=qt.b.instance.orderedLists[Q.a.ServerNotice];if(!e)return[];const t=[];let a=0;for(const n of e){const e=n.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;a=e.getTs();const i=e.getContent().pinned.slice(0,2);for(const e of i){const a=(await this._matrixClient.getEventTimeline(n.getUnfilteredTimelineSet(),e)).getEvents().find(t=>t.getId()===e);a&&t.push(a)}}if(a&&this.state.usageLimitEventTs>a)return;const n=t.find(e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type),i=n&&n.getContent();this.calculateServerLimitToast(this.state.syncErrorData,i),this.setState({usageLimitEventContent:i,usageLimitEventTs:a,usageLimitDismissed:!1})}),i()(this,"onPaste",e=>{const t=vm(e.target);if(t!==document.activeElement)if(null!=t&&t.focus)t.focus();else{const e=!!document.activeElement.closest(".mx_ThreadView");b.a.dispatch({action:M.a.FocusSendMessageComposer,context:e?Zn.a.Thread:Zn.a.Room},!0)}}),i()(this,"onReactKeyDown",e=>{this.onKeyDown(e)}),i()(this,"onNativeKeyDown",e=>{e.target===document.body&&this.onKeyDown(e)}),i()(this,"onKeyDown",e=>{let t=!1;switch(Object(le.a)().getRoomAction(e)){case Ue.h.ScrollUp:case Ue.h.ScrollDown:case Ue.h.JumpToFirstMessage:case Ue.h.JumpToLatestMessage:this.onScrollKeyPressed(e),t=!0;break;case Ue.h.SearchInRoom:b.a.dispatch({action:"focus_search"}),t=!0}if(t)return e.stopPropagation(),void e.preventDefault();switch(Object(le.a)().getNavigationAction(e)){case Ue.h.FilterRooms:b.a.dispatch({action:"focus_room_filter"}),t=!0;break;case Ue.h.ToggleUserMenu:b.a.fire(M.a.ToggleUserMenu),t=!0;break;case Ue.h.ShowKeyboardSettings:b.a.dispatch({action:M.a.ViewUserSettings,initialTabId:Ge.a.Keyboard}),t=!0;break;case Ue.h.GoToHome:b.a.dispatch({action:M.a.ViewHomePage}),gt.a.closeCurrentModal("homeKeyboardShortcut"),t=!0;break;case Ue.h.ToggleSpacePanel:b.a.fire(M.a.ToggleSpacePanel),t=!0;break;case Ue.h.ToggleRoomSidePanel:"room_view"===this.props.page_type&&(as.a.instance.togglePanel(),t=!0);break;case Ue.h.SelectPrevRoom:b.a.dispatch({action:M.a.ViewRoomDelta,delta:-1,unread:!1}),t=!0;break;case Ue.h.SelectNextRoom:b.a.dispatch({action:M.a.ViewRoomDelta,delta:1,unread:!1}),t=!0;break;case Ue.h.SelectPrevUnreadRoom:b.a.dispatch({action:M.a.ViewRoomDelta,delta:-1,unread:!0});break;case Ue.h.SelectNextUnreadRoom:b.a.dispatch({action:M.a.ViewRoomDelta,delta:1,unread:!0});break;case Ue.h.PreviousVisitedRoomOrSpace:$.a.get().navigateForwardBack(!0),t=!0;break;case Ue.h.NextVisitedRoomOrSpace:$.a.get().navigateForwardBack(!1),t=!0}if(!t){switch(Object(le.a)().getLabsAction(e)){case Ue.h.ToggleHiddenEventVisibility:{const e=v.b.getValueAt(f.a.DEVICE,"showHiddenEventsInTimeline",void 0,!1);v.b.setValue("showHiddenEventsInTimeline",void 0,f.a.DEVICE,!e),t=!0;break}}}if(!t&&$.a.get().overrideBrowserShortcuts()&&e.code.startsWith("Digit")&&"Digit0"!==e.code&&Object(h.c)(e)&&(b.a.dispatch({action:M.a.SwitchSpace,num:e.code.slice(5)}),t=!0),t)return e.stopPropagation(),void e.preventDefault();if(!(e.key===h.b.ALT||e.key===h.b.CONTROL||e.key===h.b.META||e.key===h.b.SHIFT)&&!e.ctrlKey&&!e.metaKey){const t=e.target!==document.body&&(e.key===h.b.SPACE||e.key===h.b.ENTER),a=1===e.key.length||"Dead"===e.key;if(!t&&a&&!vm(e.target)){const t=!!document.activeElement.closest(".mx_ThreadView");b.a.dispatch({action:M.a.FocusSendMessageComposer,context:t?Zn.a.Thread:Zn.a.Room},!0),e.stopPropagation()}}}),i()(this,"onScrollKeyPressed",e=>{this._roomView.current&&this._roomView.current.handleScrollKey(e)}),this.state={syncErrorData:void 0,useCompactLayout:v.b.getValue("useCompactLayout"),usageLimitDismissed:!1,activeCalls:ne.b.instance.getAllActiveCalls()},this._matrixClient=this.props.matrixClient,p.c.loadDevices(),Object(g.a)(),this._roomView=o.a.createRef(),this._resizeContainer=o.a.createRef(),this.resizeHandler=o.a.createRef()}componentDidMount(){document.addEventListener("keydown",this.onNativeKeyDown,!1),ne.b.instance.addListener(ne.a.CallState,this.onCallState),this.updateServerNoticeEvents(),this._matrixClient.on(r.b.AccountData,this.onAccountData),this._matrixClient.on(r.b.Sync,this.onSync),this.onSync(this._matrixClient.getSyncState(),null,this._matrixClient.getSyncStateData()),this._matrixClient.on(m.b.Events,this.onRoomStateEvents),this.layoutWatcherRef=v.b.watchSetting("layout",null,this.onCompactLayoutChanged),this.compactLayoutWatcherRef=v.b.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),this.backgroundImageWatcherRef=v.b.watchSetting("RoomList.backgroundImage",null,this.refreshBackgroundImage),this.resizer=this.createResizer(),this.resizer.attach(),A.a.instance.on(L.b,this.refreshBackgroundImage),this.loadResizerPreferences(),this.refreshBackgroundImage()}componentWillUnmount(){document.removeEventListener("keydown",this.onNativeKeyDown,!1),ne.b.instance.removeListener(ne.a.CallState,this.onCallState),this._matrixClient.removeListener(r.b.AccountData,this.onAccountData),this._matrixClient.removeListener(r.b.Sync,this.onSync),this._matrixClient.removeListener(m.b.Events,this.onRoomStateEvents),A.a.instance.off(L.b,this.refreshBackgroundImage),v.b.unwatchSetting(this.layoutWatcherRef),v.b.unwatchSetting(this.compactLayoutWatcherRef),v.b.unwatchSetting(this.backgroundImageWatcherRef),this.resizer.detach()}createResizer(){let e,t;const a={toggleSize:156,onCollapsed:e=>{t=e,e?(b.a.dispatch({action:"hide_left_panel"}),window.localStorage.setItem("mx_lhs_size","0")):b.a.dispatch({action:"show_left_panel"})},onResized:t=>{e=t,this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{t||window.localStorage.setItem("mx_lhs_size",""+e),this.props.resizeNotifier.stopResizing()},isItemCollapsed:e=>e.classList.contains("mx_LeftPanel_minimized"),handler:this.resizeHandler.current},n=new R(this._resizeContainer.current,k,a);return n.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),n}loadResizerPreferences(){let e=parseInt(window.localStorage.getItem("mx_lhs_size"),10);isNaN(e)&&(e=350),this.resizer.forHandleWithId("lp-resizer").resize(e)}calculateServerLimitToast(e,t){const a=e&&e.error&&"M_RESOURCE_LIMIT_EXCEEDED"===e.error.errcode;a&&(t=e.error.data),t&&this.state.usageLimitDismissed?((e,t,a,n)=>{const i=Object(ee.a)(e,a,{monthly_active_user:Object(N.c)("Your homeserver has exceeded its user limit."),hs_blocked:Object(N.c)("This homeserver has been blocked by its administrator."),"":Object(N.c)("Your homeserver has exceeded one of its resource limits.")}),s=Object(ee.a)(e,a,{"":Object(N.c)("Contact your <a>server admin</a>.")});Z.a.sharedInstance().addOrReplaceToast({key:"serverlimit",title:Object(N.a)("Warning"),props:{description:o.a.createElement(o.a.Fragment,null,i," ",s),acceptLabel:Object(N.a)("Ok"),onAccept:()=>{te(),t&&t()}},component:X.a,priority:70})})(t.limit_type,this.onUsageLimitDismissed,t.admin_contact):te()}render(){let e;switch(this.props.page_type){case u.a.RoomView:e=o.a.createElement(dm,{ref:this._roomView,onRegistered:this.props.onRegistered,threepidInvite:this.props.threepidInvite,oobData:this.props.roomOobData,key:this.props.currentRoomId||"roomview",resizeNotifier:this.props.resizeNotifier,justCreatedOpts:this.props.roomJustCreatedOpts,forceTimeline:this.props.forceTimeline});break;case u.a.HomePage:e=o.a.createElement(J,{justRegistered:this.props.justRegistered});break;case u.a.UserView:e=o.a.createElement(hm,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier});break;case u.a.LegacyGroupView:e=o.a.createElement(pm,{groupId:this.props.currentGroupId})}const t=l()({mx_MatrixChat_wrapper:!0,mx_MatrixChat_useCompactLayout:this.state.useCompactLayout}),a=l()({mx_MatrixChat:!0,"mx_MatrixChat--with-avatar":this.state.backgroundImage}),n=this.state.activeCalls.map(e=>o.a.createElement(Ti,{call:e,key:e.callId}));return o.a.createElement(j.a.Provider,{value:this._matrixClient},o.a.createElement("div",{onPaste:this.onPaste,onKeyDown:this.onReactKeyDown,className:t,"aria-hidden":this.props.hideToSRUsers},o.a.createElement(mm,null),o.a.createElement("div",{className:a},o.a.createElement("div",{className:"mx_LeftPanel_outerWrapper"},o.a.createElement(bm,{isMinimized:this.props.collapseLhs||!1}),o.a.createElement("div",{className:"mx_LeftPanel_wrapper"},o.a.createElement(um,{blurMultiplier:.5,backgroundImage:this.state.backgroundImage}),o.a.createElement(zt,null),o.a.createElement(um,{backgroundImage:this.state.backgroundImage}),o.a.createElement("div",{className:"mx_LeftPanel_wrapper--user",ref:this._resizeContainer,"data-collapsed":!!this.props.collapseLhs||void 0},o.a.createElement(ya,{isMinimized:this.props.collapseLhs||!1,resizeNotifier:this.props.resizeNotifier})))),o.a.createElement(E,{passRef:this.resizeHandler,id:"lp-resizer"}),o.a.createElement("div",{className:"mx_RoomView_wrapper"},e))),o.a.createElement(Ci,null),o.a.createElement(ki,null),o.a.createElement(ji,null),n)}}i()(fm,"displayName","LoggedInView");t.a=fm},1483:function(e,t,a){"use strict";a.d(t,"a",(function(){return ka}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(306),c=a(89),l=a(225),d=a(0),m=a(90),h=a(105),u=a(98);var p=a(196),g=a(95),b=a(107),v=a(128),f=a(91),E=a(799),y=a(801),_=a(207),S=a(248);class w extends o.a.Component{constructor(e){super(e),i()(this,"avatarUpload",Object(s.createRef)()),i()(this,"uploadAvatar",()=>{this.avatarUpload.current.click()}),i()(this,"removeAvatar",()=>{this.avatarUpload.current.value="",this.setState({avatarUrl:null,avatarFile:null,enableProfileSave:!0})}),i()(this,"cancelProfileChanges",async e=>{e.stopPropagation(),e.preventDefault(),this.state.enableProfileSave&&this.setState({enableProfileSave:!1,displayName:this.state.originalDisplayName,avatarUrl:this.state.originalAvatarUrl,avatarFile:null})}),i()(this,"saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t=m.a.get(),a={},n=this.state.displayName.trim();try{if(this.state.originalDisplayName!==this.state.displayName&&(await t.setDisplayName(n),a.originalDisplayName=n,a.displayName=n),this.state.avatarFile){d.a.log(`Uploading new avatar, ${this.state.avatarFile.name} of type ${this.state.avatarFile.type}, (${this.state.avatarFile.size}) bytes`);const e=await t.uploadContent(this.state.avatarFile);await t.setAvatarUrl(e),a.avatarUrl=Object(v.b)(e).getSquareThumbnailHttp(96),a.originalAvatarUrl=a.avatarUrl,a.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.setAvatarUrl("")}catch(e){d.a.log("Failed to save profile",e),g.a.createTrackedDialog("Failed to save profile","",b.a,{title:Object(c.a)("Failed to save your profile"),description:e&&e.message?e.message:Object(c.a)("The operation could not be completed")})}this.setState(a)}),i()(this,"onDisplayNameChanged",e=>{this.setState({displayName:e.target.value,enableProfileSave:!0})}),i()(this,"onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,enableProfileSave:!1});const t=e.target.files[0],a=new FileReader;a.onload=e=>{this.setState({avatarUrl:e.target.result,avatarFile:t,enableProfileSave:!0})},a.readAsDataURL(t)});const t=m.a.get();let a=p.a.instance.avatarMxc;a&&(a=Object(v.b)(a).getSquareThumbnailHttp(96)),this.state={userId:t.getUserId(),originalDisplayName:p.a.instance.displayName,displayName:p.a.instance.displayName,originalAvatarUrl:a,avatarUrl:a,avatarFile:null,enableProfileSave:!1}}render(){var e;const t=function(e){const t=u.b.get().hosting_signup_link;if(!t)return null;if(!e)return t;if("matrix.org"!==m.a.get().getDomain())return null;try{const a=new URL(t);return a.searchParams.set("utm_campaign",e),a.toString()}catch(e){return t}}("user-settings");let a=null;t&&(a=o.a.createElement("span",null,Object(c.a)("<a>Upgrade</a> to your own domain",{},{a:e=>o.a.createElement(y.a,{href:t,target:"_blank",rel:"noreferrer noopener"},e)})));const n=_.a.getDisplayUserIdentifier(this.state.userId,{withDisplayName:!0});return o.a.createElement("form",{onSubmit:this.saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings_profileForm"},o.a.createElement("input",{type:"file",ref:this.avatarUpload,className:"mx_ProfileSettings_avatarUpload",onClick:S.a,onChange:this.onAvatarChanged,accept:"image/*"}),o.a.createElement("div",{className:"mx_ProfileSettings_profile"},o.a.createElement("div",{className:"mx_ProfileSettings_controls"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Profile")),o.a.createElement(h.a,{label:Object(c.a)("Display Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onDisplayNameChanged}),o.a.createElement("p",null,n&&o.a.createElement("span",{className:"mx_ProfileSettings_userId"},n),a)),o.a.createElement(E.a,{avatarUrl:null===(e=this.state.avatarUrl)||void 0===e?void 0:e.toString(),avatarName:this.state.displayName||this.state.userId,avatarAltText:Object(c.a)("Profile picture"),uploadAvatar:this.uploadAvatar,removeAvatar:this.removeAvatar})),o.a.createElement("div",{className:"mx_ProfileSettings_buttons"},o.a.createElement(f.a,{onClick:this.cancelProfileChanges,kind:"link",disabled:!this.state.enableProfileSave},Object(c.a)("Cancel")),o.a.createElement(f.a,{onClick:this.saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},Object(c.a)("Save"))))}}var C=a(93),O=a(833),k=a(263),x=a(126),R=a(102);class j extends o.a.Component{constructor(e){super(e),this.onSearchChange=this.onSearchChange.bind(this),this.state={searchQuery:"",languages:null}}componentDidMount(){const e=x.a.get();e&&e.getAvailableSpellCheckLanguages().then(e=>{e.sort((function(e,t){return e<t?-1:e>t?1:0}));const t=[];e.forEach(e=>{t.push({label:e,value:e})}),this.setState({languages:t})}).catch(e=>{this.setState({languages:["en"]})})}onSearchChange(e){this.setState({searchQuery:e})}render(){if(null===this.state.languages)return o.a.createElement(R.a,null);let e;e=this.state.searchQuery?this.state.languages.filter(e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e)):this.state.languages;const t=e.map(e=>o.a.createElement("div",{key:e.value},e.label));let a=C.b.getValue("language",null,!0),n=null;return a||(a=navigator.language||navigator.userLanguage),n=this.props.value||a,o.a.createElement(k.a,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:n,label:Object(c.a)("Language Dropdown")},t)}}class I extends o.a.Component{constructor(){super(...arguments),i()(this,"onRemove",e=>(e.stopPropagation(),e.preventDefault(),this.props.onRemoved(this.props.language)))}render(){return o.a.createElement("div",{className:"mx_ExistingSpellCheckLanguage"},o.a.createElement("span",{className:"mx_ExistingSpellCheckLanguage_language"},this.props.language),o.a.createElement(f.a,{onClick:this.onRemove,kind:"danger_sm"},Object(c.a)("Remove")))}}class T extends o.a.Component{constructor(e){super(e),i()(this,"onRemoved",e=>{const t=this.props.languages.filter(t=>t!==e);this.props.onLanguagesChange(t)}),i()(this,"onAddClick",e=>{e.stopPropagation(),e.preventDefault();const t=this.state.newLanguage;t&&(this.props.languages.includes(t)||(this.props.languages.push(t),this.props.onLanguagesChange(this.props.languages)))}),i()(this,"onNewLanguageChange",e=>{this.state.newLanguage!==e&&this.setState({newLanguage:e})}),this.state={newLanguage:""}}render(){const e=this.props.languages.map(e=>o.a.createElement(I,{language:e,onRemoved:this.onRemoved,key:e})),t=o.a.createElement(f.a,{onClick:this.onAddClick,kind:"primary"},Object(c.a)("Add"));return o.a.createElement("div",{className:"mx_SpellCheckLanguages"},e,o.a.createElement("form",{onSubmit:this.onAddClick,noValidate:!0},o.a.createElement(j,{className:"mx_GeneralUserSettingsTab_spellCheckLanguageInput",value:this.state.newLanguage,onOptionChange:this.onNewLanguageChange}),t))}}var N=a(162),P=a(450),M=a(272),D=a(141),A=a(101),U=a(92),L=a(96);class F extends o.a.Component{constructor(e){super(e),i()(this,"onStagePhaseChange",(e,t)=>{const a={[M.c.PHASE_PREAUTH]:{body:Object(c.a)("Confirm your account deactivation by using Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"danger"},[M.c.PHASE_POSTAUTH]:{body:Object(c.a)("Are you sure you want to deactivate your account? This is irreversible."),continueText:Object(c.a)("Confirm account deactivation"),continueKind:"danger"}},n={[M.c.LOGIN_TYPE]:a,[M.c.UNSTABLE_LOGIN_TYPE]:a,[M.b.LOGIN_TYPE]:{[M.a]:{body:Object(c.a)("To continue, please enter your account password:")}}}[e];let i=null,s=null,o=null;if(n){const e=n[t];e&&e.body&&(i=e.body),e&&e.continueText&&(s=e.continueText),e&&e.continueKind&&(o=e.continueKind)}this.setState({bodyText:i,continueText:s,continueKind:o})}),i()(this,"onUIAuthFinished",(e,t)=>{e||(t!==P.a?(d.a.error("Error during UI Auth:",{result:t}),this.setState({errStr:Object(c.a)("There was a problem communicating with the server. Please try again.")})):this.onCancel())}),i()(this,"onUIAuthComplete",e=>{m.a.get().deactivateAccount(e,this.state.shouldErase).then(e=>{N.a.trackEvent("Account","Deactivate Account"),U.a.fire(L.a.TriggerLogout),this.props.onFinished(!0)}).catch(e=>{d.a.error(e),this.setState({errStr:Object(c.a)("There was a problem communicating with the server. Please try again.")})})}),i()(this,"onEraseFieldChange",e=>{this.setState({shouldErase:e.currentTarget.checked,authEnabled:!1}),this.initAuth(e.currentTarget.checked)}),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0,bodyText:null,continueText:null,continueKind:null},this.initAuth(!1)}onCancel(){this.props.onFinished(!1)}initAuth(e){m.a.get().deactivateAccount(null,e).then(e=>{d.a.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:Object(c.a)("Server did not require any authentication")})}).catch(e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:Object(c.a)("Server did not return valid authentication information.")})})}render(){let e=null;this.state.errStr&&(e=o.a.createElement("div",{className:"error"},this.state.errStr));let t=o.a.createElement("div",null,Object(c.a)("Loading..."));return this.state.authData&&this.state.authEnabled&&(t=o.a.createElement("div",null,this.state.bodyText,o.a.createElement(P.b,{matrixClient:m.a.get(),authData:this.state.authData,makeRequest:this.onUIAuthComplete,onAuthFinished:this.onUIAuthFinished,onStagePhaseChange:this.onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),o.a.createElement(A.a,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:Object(c.a)("Deactivate Account"),screenName:"DeactivateAccount"},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.a)("Confirm that you would like to deactivate your account. If you proceed:")),o.a.createElement("ul",null,o.a.createElement("li",null,Object(c.a)("You will not be able to reactivate your account")),o.a.createElement("li",null,Object(c.a)("You will no longer be able to log in")),o.a.createElement("li",null,Object(c.a)("No one will be able to reuse your username (MXID), including you: this username will remain unavailable")),o.a.createElement("li",null,Object(c.a)("You will leave all rooms and DMs that you are in")),o.a.createElement("li",null,Object(c.a)("You will be removed from the identity server: your friends will no longer be able to find you with your email or phone number"))),o.a.createElement("p",null,Object(c.a)("Your old messages will still be visible to people who received them, just like emails you sent in the past. Would you like to hide your sent messages from people who join rooms in the future?")),o.a.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},o.a.createElement("p",null,o.a.createElement(D.b,{checked:this.state.shouldErase,onChange:this.onEraseFieldChange},Object(c.a)("Hide my messages from new joiners"))),e,t)))}}var B=a(429),V=a(247),W=a(322);async function H(e,t){const a=e.getUserId();let{threepids:n}=await e.getThreePids();if(t&&(n=n.filter(e=>e.medium===t)),n.length>0&&e.getIdentityServerUrl())try{const i=new V.a,s=await i.getAccessToken({check:!1}),o=n.map(e=>{let{medium:t,address:a}=e;return[t,a]}),r=await e.bulkLookupThreePids(o,s);for(const[e,i,s]of r.threepids){if(s!==a)continue;if(t&&e!==t)continue;const o=n.find(t=>t.medium===e&&t.address===i);o&&(o.bound=!0)}}catch(e){if("M_TERMS_NOT_SIGNED"!==e.errcode)throw e}return n}var z=a(104),K=a(122);let q;!function(e){e.Email="email",e.Phone="msisdn"}(q||(q={}));var G=a(227);function Y(){return m.a.get().idBaseUrl.split("://")[1]}class J{constructor(){i()(this,"sessionId",void 0),i()(this,"submitUrl",void 0),i()(this,"clientSecret",void 0),i()(this,"bind",void 0),i()(this,"makeAddThreepidOnlyRequest",e=>m.a.get().addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:e})),this.clientSecret=m.a.get().generateClientSecret()}addEmailAddress(e){return m.a.get().requestAdd3pidEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindEmailAddress(e){if(this.bind=!0,await m.a.get().doesServerSupportSeparateAddAndBind()){const t=new V.a,a=await t.getAccessToken();return m.a.get().requestEmailToken(e,this.clientSecret,1,void 0,void 0,a).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addEmailAddress(e)}addMsisdn(e,t){return m.a.get().requestAdd3pidMsisdnToken(e,t,this.clientSecret,1).then(e=>(this.sessionId=e.sid,this.submitUrl=e.submit_url,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindMsisdn(e,t){if(this.bind=!0,await m.a.get().doesServerSupportSeparateAddAndBind()){const a=new V.a,n=await a.getAccessToken();return m.a.get().requestMsisdnToken(e,t,this.clientSecret,1,void 0,void 0,n).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addMsisdn(e,t)}async checkEmailLinkClicked(){try{if(await m.a.get().doesServerSupportSeparateAddAndBind())if(this.bind){const e=new V.a,t=await e.getAccessToken();await m.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:Y(),id_access_token:t})}else try{return void await this.makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t={[M.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("Confirm adding this email address by using Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[M.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm adding email"),body:Object(c.a)("Click the button below to confirm adding this email address."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}},{finished:a}=g.a.createTrackedDialog("Add Email","",G.a,{title:Object(c.a)("Add Email Address"),matrixClient:m.a.get(),authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[M.c.LOGIN_TYPE]:t,[M.c.UNSTABLE_LOGIN_TYPE]:t}});return a}else await m.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:Y()},this.bind)}catch(e){throw 401===e.httpStatus?e.message=Object(c.a)("Failed to verify email address: make sure you clicked the link in the email"):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}async haveMsisdnToken(e){const t=new V.a,a=await m.a.get().doesServerSupportSeparateAddAndBind();let n;if(this.submitUrl)n=await m.a.get().submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind&&a)throw new Error("The add / bind with MSISDN flow is misconfigured");n=await m.a.get().submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(n.errcode)throw n;if(a)if(this.bind)await m.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:Y(),id_access_token:await t.getAccessToken()});else try{return void await this.makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t={[M.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("Confirm adding this phone number by using Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[M.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm adding phone number"),body:Object(c.a)("Click the button below to confirm adding this phone number."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}},{finished:a}=g.a.createTrackedDialog("Add MSISDN","",G.a,{title:Object(c.a)("Add Phone Number"),matrixClient:m.a.get(),authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[M.c.LOGIN_TYPE]:t,[M.c.UNSTABLE_LOGIN_TYPE]:t}});return a}else await m.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:Y()},this.bind)}}var $=a(567);class Q extends o.a.Component{constructor(e){super(e),i()(this,"onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),i()(this,"onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),i()(this,"onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),m.a.get().deleteThreePid(this.props.msisdn.medium,this.props.msisdn.address).then(()=>this.props.onRemoved(this.props.msisdn)).catch(e=>{d.a.error("Unable to remove contact information: "+e),g.a.createTrackedDialog("Remove 3pid failed","",b.a,{title:Object(c.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?o.a.createElement("div",{className:"mx_ExistingPhoneNumber"},o.a.createElement("span",{className:"mx_ExistingPhoneNumber_promptText"},Object(c.a)("Remove %(phone)s?",{phone:this.props.msisdn.address})),o.a.createElement(f.a,{onClick:this.onActuallyRemove,kind:"danger_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(c.a)("Remove")),o.a.createElement(f.a,{onClick:this.onDontRemove,kind:"link_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(c.a)("Cancel"))):o.a.createElement("div",{className:"mx_ExistingPhoneNumber"},o.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",this.props.msisdn.address),o.a.createElement(f.a,{onClick:this.onRemove,kind:"danger_sm"},Object(c.a)("Remove")))}}class X extends o.a.Component{constructor(e){super(e),i()(this,"onRemoved",e=>{const t=this.props.msisdns.filter(t=>t!==e);this.props.onMsisdnsChange(t)}),i()(this,"onChangeNewPhoneNumber",e=>{this.setState({newPhoneNumber:e.target.value})}),i()(this,"onChangeNewPhoneNumberCode",e=>{this.setState({newPhoneNumberCode:e.target.value})}),i()(this,"onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newPhoneNumber)return;const t=this.state.newPhoneNumber,a=this.state.phoneCountry,n=new J;this.setState({verifying:!0,continueDisabled:!0,addTask:n}),n.addMsisdn(a,t).then(e=>{this.setState({continueDisabled:!1,verifyMsisdn:e.msisdn})}).catch(e=>{d.a.error("Unable to add phone number "+t+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.a.createTrackedDialog("Add Phone Number Error","",b.a,{title:Object(c.a)("Error"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),i()(this,"onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.newPhoneNumberCode,a=this.state.verifyMsisdn;this.state.addTask.haveMsisdnToken(t).then(e=>{let[t]=e,n=this.state.newPhoneNumber;if(t){const e=[...this.props.msisdns,{address:a,medium:q.Phone}];this.props.onMsisdnsChange(e),n=""}this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyMsisdn:"",verifyError:null,newPhoneNumber:n,newPhoneNumberCode:""})}).catch(e=>{this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode?(d.a.error("Unable to verify phone number: "+e),g.a.createTrackedDialog("Unable to verify phone number","",b.a,{title:Object(c.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})):this.setState({verifyError:Object(c.a)("Incorrect verification code")})})}),i()(this,"onCountryChanged",e=>{this.setState({phoneCountry:e.iso2})}),this.state={verifying:!1,verifyError:null,verifyMsisdn:"",addTask:null,continueDisabled:!1,phoneCountry:"",newPhoneNumber:"",newPhoneNumberCode:""}}render(){const e=this.props.msisdns.map(e=>o.a.createElement(Q,{msisdn:e,onRemoved:this.onRemoved,key:e.address}));let t=o.a.createElement(f.a,{onClick:this.onAddClick,kind:"primary"},Object(c.a)("Add"));if(this.state.verifying){const e=this.state.verifyMsisdn;t=o.a.createElement("div",null,o.a.createElement("div",null,Object(c.a)("A text message has been sent to +%(msisdn)s. Please enter the verification code it contains.",{msisdn:e}),o.a.createElement("br",null),this.state.verifyError),o.a.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},o.a.createElement(h.a,{type:"text",label:Object(c.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.newPhoneNumberCode,onChange:this.onChangeNewPhoneNumberCode}),o.a.createElement(f.a,{onClick:this.onContinueClick,kind:"primary",disabled:this.state.continueDisabled||0===this.state.newPhoneNumberCode.length},Object(c.a)("Continue"))))}const a=o.a.createElement($.a,{onOptionChange:this.onCountryChanged,className:"mx_PhoneNumbers_country",value:this.state.phoneCountry,disabled:this.state.verifying,isSmall:!0,showPrefix:!0});return o.a.createElement("div",{className:"mx_PhoneNumbers"},e,o.a.createElement("form",{onSubmit:this.onAddClick,autoComplete:"off",noValidate:!0,className:"mx_PhoneNumbers_new"},o.a.createElement("div",{className:"mx_PhoneNumbers_input"},o.a.createElement(h.a,{type:"text",label:Object(c.a)("Phone Number"),autoComplete:"off",disabled:this.state.verifying,prefixComponent:a,value:this.state.newPhoneNumber,onChange:this.onChangeNewPhoneNumber}))),t)}}var Z=a(291);class ee extends o.a.Component{constructor(e){super(e),i()(this,"onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),i()(this,"onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),i()(this,"onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),m.a.get().deleteThreePid(this.props.email.medium,this.props.email.address).then(()=>this.props.onRemoved(this.props.email)).catch(e=>{d.a.error("Unable to remove contact information: "+e),g.a.createTrackedDialog("Remove 3pid failed","",b.a,{title:Object(c.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?o.a.createElement("div",{className:"mx_ExistingEmailAddress"},o.a.createElement("span",{className:"mx_ExistingEmailAddress_promptText"},Object(c.a)("Remove %(email)s?",{email:this.props.email.address})),o.a.createElement(f.a,{onClick:this.onActuallyRemove,kind:"danger_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(c.a)("Remove")),o.a.createElement(f.a,{onClick:this.onDontRemove,kind:"link_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(c.a)("Cancel"))):o.a.createElement("div",{className:"mx_ExistingEmailAddress"},o.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},this.props.email.address),o.a.createElement(f.a,{onClick:this.onRemove,kind:"danger_sm"},Object(c.a)("Remove")))}}class te extends o.a.Component{constructor(e){super(e),i()(this,"onRemoved",e=>{const t=this.props.emails.filter(t=>t!==e);this.props.onEmailsChange(t)}),i()(this,"onChangeNewEmailAddress",e=>{this.setState({newEmailAddress:e.target.value})}),i()(this,"onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newEmailAddress)return;const t=this.state.newEmailAddress;if(!Z.a(t))return void g.a.createTrackedDialog("Invalid email address","",b.a,{title:Object(c.a)("Invalid Email Address"),description:Object(c.a)("This doesn't appear to be a valid email address")});const a=new J;this.setState({verifying:!0,continueDisabled:!0,addTask:a}),a.addEmailAddress(t).then(()=>{this.setState({continueDisabled:!1})}).catch(e=>{d.a.error("Unable to add email address "+t+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.a.createTrackedDialog("Unable to add email address","",b.a,{title:Object(c.a)("Unable to add email address"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),i()(this,"onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0}),this.state.addTask.checkEmailLinkClicked().then(e=>{let[t]=e,a=this.state.newEmailAddress;if(t){const e=this.state.newEmailAddress,t=[...this.props.emails,{address:e,medium:q.Email}];this.props.onEmailsChange(t),a=""}this.setState({addTask:null,continueDisabled:!1,verifying:!1,newEmailAddress:a})}).catch(e=>{this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"===e.errcode?g.a.createTrackedDialog("Email hasn't been verified yet","",b.a,{title:Object(c.a)("Your email address hasn't been verified yet"),description:Object(c.a)("Click the link in the email you received to verify and then click continue again.")}):(d.a.error("Unable to verify email address: ",e),g.a.createTrackedDialog("Unable to verify email address","",b.a,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")}))})}),this.state={verifying:!1,addTask:null,continueDisabled:!1,newEmailAddress:""}}render(){const e=this.props.emails.map(e=>o.a.createElement(ee,{email:e,onRemoved:this.onRemoved,key:e.address}));let t=o.a.createElement(f.a,{onClick:this.onAddClick,kind:"primary"},Object(c.a)("Add"));return this.state.verifying&&(t=o.a.createElement("div",null,o.a.createElement("div",null,Object(c.a)("We've sent you an email to verify your address. Please follow the instructions there and then click the button below.")),o.a.createElement(f.a,{onClick:this.onContinueClick,kind:"primary",disabled:this.state.continueDisabled},Object(c.a)("Continue")))),o.a.createElement("div",{className:"mx_EmailAddresses"},e,o.a.createElement("form",{onSubmit:this.onAddClick,autoComplete:"off",noValidate:!0,className:"mx_EmailAddresses_new"},o.a.createElement(h.a,{type:"text",label:Object(c.a)("Email Address"),autoComplete:"off",disabled:this.state.verifying,value:this.state.newEmailAddress,onChange:this.onChangeNewEmailAddress}),t))}}class ae extends o.a.Component{constructor(e){super(e),i()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(c.a)("Unable to revoke sharing for email address")})}),i()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(c.a)("Unable to share email address")})}),i()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});try{await this.state.addTask.checkEmailLinkClicked(),this.setState({addTask:null,continueDisabled:!1,verifying:!1})}catch(e){this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"===e.errcode?g.a.createTrackedDialog("E-mail hasn't been verified yet","",b.a,{title:Object(c.a)("Your email address hasn't been verified yet"),description:Object(c.a)("Click the link in the email you received to verify and then click continue again.")}):(d.a.error("Unable to verify email address: "+e),g.a.createTrackedDialog("Unable to verify email address","",b.a,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")}))}});const{bound:t}=e.email;this.state={verifying:!1,addTask:null,continueDisabled:!1,bound:t}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.email;this.setState({bound:t})}async changeBinding(e){let{bind:t,label:a,errorTitle:n}=e;if(!await m.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:t,label:a,errorTitle:n});const{medium:i,address:s}=this.props.email;try{if(t){const e=new J;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindEmailAddress(s),this.setState({continueDisabled:!1})}else await m.a.get().unbindThreePid(i,s);this.setState({bound:t})}catch(e){d.a.error(`Unable to ${a} email address ${s} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.a.createTrackedDialog(`Unable to ${a} email address`,"",b.a,{title:n,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}async changeBindingTangledAddBind(e){let{bind:t,label:a,errorTitle:n}=e;const{medium:i,address:s}=this.props.email,o=new J;this.setState({verifying:!0,continueDisabled:!0,addTask:o});try{await m.a.get().deleteThreePid(i,s),t?await o.bindEmailAddress(s):await o.addEmailAddress(s),this.setState({continueDisabled:!1,bound:t})}catch(e){d.a.error(`Unable to ${a} email address ${s} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.a.createTrackedDialog(`Unable to ${a} email address`,"",b.a,{title:n,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}render(){const{address:e}=this.props.email,{verifying:t,bound:a}=this.state;let n;return n=t?o.a.createElement("span",null,Object(c.a)("Verify the link in your inbox"),o.a.createElement(f.a,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onContinueClick,disabled:this.state.continueDisabled},Object(c.a)("Complete"))):a?o.a.createElement(f.a,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(c.a)("Revoke")):o.a.createElement(f.a,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(c.a)("Share")),o.a.createElement("div",{className:"mx_ExistingEmailAddress"},o.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},e),n)}}class ne extends o.a.Component{render(){let e;return e=this.props.emails.length>0?this.props.emails.map(e=>o.a.createElement(ae,{email:e,key:e.address})):o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Discovery options will appear once you have added an email above.")),o.a.createElement("div",{className:"mx_EmailAddresses"},e)}}class ie extends o.a.Component{constructor(e){super(e),i()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(c.a)("Unable to revoke sharing for phone number")})}),i()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(c.a)("Unable to share phone number")})}),i()(this,"onVerificationCodeChange",e=>{this.setState({verificationCode:e.target.value})}),i()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.verificationCode;try{await this.state.addTask.haveMsisdnToken(t),this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyError:null,verificationCode:""})}catch(e){this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode?(d.a.error("Unable to verify phone number: "+e),g.a.createTrackedDialog("Unable to verify phone number","",b.a,{title:Object(c.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})):this.setState({verifyError:Object(c.a)("Incorrect verification code")})}});const{bound:t}=e.msisdn;this.state={verifying:!1,verificationCode:"",addTask:null,continueDisabled:!1,bound:t,verifyError:null}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.msisdn;this.setState({bound:t})}async changeBinding(e){let{bind:t,label:a,errorTitle:n}=e;if(!await m.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:t,label:a,errorTitle:n});const{medium:i,address:s}=this.props.msisdn;try{if(t){const e=new J;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindMsisdn(null,"+"+s),this.setState({continueDisabled:!1})}else await m.a.get().unbindThreePid(i,s);this.setState({bound:t})}catch(e){d.a.error(`Unable to ${a} phone number ${s} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.a.createTrackedDialog(`Unable to ${a} phone number`,"",b.a,{title:n,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}async changeBindingTangledAddBind(e){let{bind:t,label:a,errorTitle:n}=e;const{medium:i,address:s}=this.props.msisdn,o=new J;this.setState({verifying:!0,continueDisabled:!0,addTask:o});try{await m.a.get().deleteThreePid(i,s),t?await o.bindMsisdn(null,"+"+s):await o.addMsisdn(null,"+"+s),this.setState({continueDisabled:!1,bound:t})}catch(e){d.a.error(`Unable to ${a} phone number ${s} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.a.createTrackedDialog(`Unable to ${a} phone number`,"",b.a,{title:n,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}render(){const{address:e}=this.props.msisdn,{verifying:t,bound:a}=this.state;let n;return n=t?o.a.createElement("span",{className:"mx_ExistingPhoneNumber_verification"},o.a.createElement("span",null,Object(c.a)("Please enter verification code sent via text."),o.a.createElement("br",null),this.state.verifyError),o.a.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},o.a.createElement(h.a,{type:"text",label:Object(c.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.verificationCode,onChange:this.onVerificationCodeChange}))):a?o.a.createElement(f.a,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(c.a)("Revoke")):o.a.createElement(f.a,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(c.a)("Share")),o.a.createElement("div",{className:"mx_ExistingPhoneNumber"},o.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",e),n)}}class se extends o.a.Component{render(){let e;return e=this.props.msisdns.length>0?this.props.msisdns.map(e=>o.a.createElement(ie,{msisdn:e,key:e.address})):o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Discovery options will appear once you have added a phone number above.")),o.a.createElement("div",{className:"mx_PhoneNumbers"},e)}}var oe,re=a(169),ce=a(308),le=a(581),de=a(115),me=a(109),he=a(114);!function(e){e.Display="display",e.Edit="edit"}(oe||(oe={}));class ue extends o.a.Component{constructor(e){super(e),i()(this,"value",""),i()(this,"placeholder",!1),i()(this,"editableDiv",Object(s.createRef)()),i()(this,"showPlaceholder",e=>{e?(this.editableDiv.current.textContent=this.props.placeholder,this.editableDiv.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this.editableDiv.current.textContent=this.value,this.editableDiv.current.setAttribute("class",this.props.className),this.placeholder=!1)}),i()(this,"cancelEdit",()=>{this.setState({phase:oe.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),this.editableDiv.current.blur()}),i()(this,"onValueChanged",e=>{this.props.onValueChanged(this.value,e)}),i()(this,"onKeyDown",e=>{this.placeholder&&this.showPlaceholder(!1);switch(Object(he.a)().getAccessibilityAction(e)){case me.h.Enter:e.stopPropagation(),e.preventDefault()}}),i()(this,"onKeyUp",e=>{e.target.textContent?this.placeholder||(this.value=e.target.textContent):this.showPlaceholder(!0);switch(Object(he.a)().getAccessibilityAction(e)){case me.h.Escape:this.cancelEdit();break;case me.h.Enter:this.onFinish(e)}}),i()(this,"onClickDiv",()=>{this.props.editable&&this.setState({phase:oe.Edit})}),i()(this,"onFocus",e=>{const t=e.target.childNodes[0];if(t){const a=document.createRange();a.setStart(t,0),a.setEnd(t,e.target.childNodes.length);const n=window.getSelection();n.removeAllRanges(),n.addRange(a)}}),i()(this,"onFinish",(e,t)=>{const a=this,n=Object(he.a)().getAccessibilityAction(e)===me.h.Enter||t;this.setState({phase:oe.Display},()=>{this.value!==this.props.initialValue&&a.onValueChanged(n)})}),i()(this,"onBlur",e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)}),this.state={phase:oe.Display}}UNSAFE_componentWillReceiveProps(e){e.initialValue!==this.props.initialValue&&(this.value=e.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value)}render(){const{className:e,editable:t,initialValue:a,label:n,labelClassName:i}=this.props;let s;return s=!t||this.state.phase===oe.Display&&(n||i)&&!this.value?o.a.createElement("div",{className:e+" "+i,onClick:this.onClickDiv},n||a):o.a.createElement("div",{ref:this.editableDiv,contentEditable:!0,className:e,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),s}}i()(ue,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1});class pe extends o.a.Component{constructor(e){super(e),i()(this,"addThreepid",void 0),i()(this,"onEmailAddressChanged",e=>{this.setState({emailAddress:e})}),i()(this,"onSubmit",()=>{const e=this.state.emailAddress;Z.a(e)?(this.addThreepid=new J,this.addThreepid.addEmailAddress(e).then(()=>{g.a.createTrackedDialog("Verification Pending","",de.a,{title:Object(c.a)("Verification Pending"),description:Object(c.a)("Please check your email and click on the link it contains. Once this is done, click continue."),button:Object(c.a)("Continue"),onFinished:this.onEmailDialogFinished})},t=>{this.setState({emailBusy:!1}),d.a.error("Unable to add email address "+e+" "+t),g.a.createTrackedDialog("Unable to add email address","",b.a,{title:Object(c.a)("Unable to add email address"),description:t&&t.message?t.message:Object(c.a)("Operation failed")})}),this.setState({emailBusy:!0})):g.a.createTrackedDialog("Invalid Email Address","",b.a,{title:Object(c.a)("Invalid Email Address"),description:Object(c.a)("This doesn't appear to be a valid email address")})}),i()(this,"onCancelled",()=>{this.props.onFinished(!1)}),i()(this,"onEmailDialogFinished",e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})}),this.state={emailAddress:"",emailBusy:!1}}verifyEmailAddress(){this.addThreepid.checkEmailLinkClicked().then(()=>{this.props.onFinished(!0)},e=>{if(this.setState({emailBusy:!1}),"M_THREEPID_AUTH_FAILED"==e.errcode){const e=Object(c.a)("Unable to verify email address.")+" "+Object(c.a)("Please check your email and click on the link it contains. Once this is done, click continue.");g.a.createTrackedDialog("Verification Pending","3pid Auth Failed",de.a,{title:Object(c.a)("Verification Pending"),description:e,button:Object(c.a)("Continue"),onFinished:this.onEmailDialogFinished})}else d.a.error("Unable to verify email address: "+e),g.a.createTrackedDialog("Unable to verify email address","",b.a,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}render(){const e=this.state.emailBusy?o.a.createElement(R.a,null):o.a.createElement(ue,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",placeholder:Object(c.a)("Email address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return o.a.createElement(A.a,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",{id:"mx_Dialog_content"},Object(c.a)("This will allow you to reset your password and receive notifications.")),e),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(c.a)("Continue"),onClick:this.onSubmit}),o.a.createElement("input",{type:"submit",value:Object(c.a)("Skip"),onClick:this.onCancelled})))}}var ge;!function(e){e.Edit="edit",e.Uploading="uploading",e.Error="error"}(ge||(ge={}));class be extends o.a.Component{constructor(e){super(e),i()(this,"onExportE2eKeysClicked",()=>{g.a.createTrackedDialogAsync("Export E2E Keys","Change Password",a.e(6).then(a.bind(null,1474)),{matrixClient:m.a.get()})}),i()(this,"onChangeOldPassword",e=>{this.setState({oldPassword:e.target.value})}),i()(this,"onOldPasswordValidate",async e=>{const t=await this.validateOldPasswordRules(e);return this.markFieldValid("field_old_password",t.valid),t}),i()(this,"validateOldPasswordRules",Object(re.a)({rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(c.a)("Passwords can't be empty")}]})),i()(this,"onChangeNewPassword",e=>{this.setState({newPassword:e.target.value})}),i()(this,"onNewPasswordValidate",e=>{this.markFieldValid("field_new_password",e.valid)}),i()(this,"onChangeNewPasswordConfirm",e=>{this.setState({newPasswordConfirm:e.target.value})}),i()(this,"onNewPasswordConfirmValidate",async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid("field_new_password_confirm",t.valid),t}),i()(this,"validatePasswordConfirmRules",Object(re.a)({rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(c.a)("Confirm password")},{key:"match",test(e){let{value:t}=e;return!t||t===this.state.newPassword},invalid:()=>Object(c.a)("Passwords don't match")}]})),i()(this,"onClickChange",async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return;const t=this.state.oldPassword,a=this.state.newPassword,n=this.state.newPasswordConfirm,i=this.checkPassword(t,a,n);if(!i)return this.onChangePassword(t,a);this.props.onError(i)}),this.state={fieldValid:{},phase:ge.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""}}async onChangePassword(e,t){const a=m.a.get(),n=await a.doesServerSupportLogoutDevices(),i=(await a.getDevices()).devices.length>1;if(i&&!n&&this.props.confirm){const{finished:e}=g.a.createTrackedDialog("Change Password","",de.a,{title:Object(c.a)("Warning!"),description:o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Changing your password on this homeserver will cause all of your other devices to be signed out. This will delete the message encryption keys stored on them, and may make encrypted chat history unreadable.")),o.a.createElement("p",null,Object(c.a)("If you want to retain access to your chat history in encrypted rooms you should first export your room keys and re-import them afterwards.")),o.a.createElement("p",null,Object(c.a)("You can also ask your homeserver admin to upgrade the server to change this behaviour."))),button:Object(c.a)("Continue"),extraButtons:[o.a.createElement("button",{key:"exportRoomKeys",className:"mx_Dialog_primary",onClick:this.onExportE2eKeysClicked},Object(c.a)("Export E2E room keys"))]}),[t]=await e;if(!t)return}this.changePassword(a,e,t,n,i)}changePassword(e,t,a,n,i){const s={type:"m.login.password",identifier:{type:"m.id.user",user:e.credentials.userId},user:e.credentials.userId,password:t};this.setState({phase:ge.Uploading});const o=!n&&void 0,r=!n&&i;e.setPassword(s,a,o).then(()=>{if(this.props.shouldAskForEmail)return this.optionallySetEmail().then(e=>{this.props.onFinished({didSetEmail:e,didLogoutOutOtherDevices:r})});this.props.onFinished({didLogoutOutOtherDevices:r})},e=>{this.props.onError(e)}).finally(()=>{this.setState({phase:ge.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})})}checkPassword(e,t,a){return t!==a?{error:Object(c.a)("New passwords don't match")}:t&&0!==t.length?void 0:{error:Object(c.a)("Passwords can't be empty")}}optionallySetEmail(){return g.a.createTrackedDialog("Do you want to set an email address?","",pe,{title:Object(c.a)("Do you want to set an email address?")}).finished.then(e=>{let[t]=e;return t})}markFieldValid(e,t){const{fieldValid:a}=this.state;a[e]=t,this.setState({fieldValid:a})}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=["field_old_password","field_new_password","field_new_password_confirm"];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const a=this.findFirstInvalidField(t);return!a||(a.focus(),a.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}render(){const e=this.props.rowClassName,t=this.props.buttonClassName;switch(this.state.phase){case ge.Edit:return o.a.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},o.a.createElement("div",{className:e},o.a.createElement(h.a,{ref:e=>this.field_old_password=e,type:"password",label:Object(c.a)("Current password"),value:this.state.oldPassword,onChange:this.onChangeOldPassword,onValidate:this.onOldPasswordValidate})),o.a.createElement("div",{className:e},o.a.createElement(ce.a,{fieldRef:e=>this.field_new_password=e,type:"password",label:Object(c.c)("New Password"),minScore:le.a,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,onValidate:this.onNewPasswordValidate,autoComplete:"new-password"})),o.a.createElement("div",{className:e},o.a.createElement(h.a,{ref:e=>this.field_new_password_confirm=e,type:"password",label:Object(c.a)("Confirm password"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,onValidate:this.onNewPasswordConfirmValidate,autoComplete:"new-password"})),o.a.createElement(f.a,{className:t,kind:this.props.buttonKind,onClick:this.onClickChange},this.props.buttonLabel||Object(c.a)("Change Password")));case ge.Uploading:return o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement(R.a,null))}}}i()(be,"defaultProps",{onFinished(){},onError(){},confirm:!0});var ve=a(164);class fe extends o.a.Component{constructor(e){super(e),i()(this,"togglePolicy",e=>{const t=Object(ve.a)(this.state.policies);t[e].checked=!t[e].checked,this.setState({policies:t})}),i()(this,"onContinue",()=>{!!this.state.policies.some(e=>!e.checked)||(this.setState({busy:!0}),this.props.onFinished(this.state.policies.map(e=>e.url)))}),this.state={policies:[],busy:!1}}componentDidMount(){const e=[];for(const t of this.props.policiesAndServicePairs){const a=Object.values(t.policies);for(const t of a){const a=Object(c.j)(Object.keys(t).filter(e=>"version"!==e)),n={checked:!1,url:t[a].url,name:t[a].name};e.push(n)}}this.setState({policies:e})}renderCheckboxes(){const e=[];for(let t=0;t<this.state.policies.length;t++){const a=this.state.policies[t],n=Object(c.a)("Accept <policyLink /> to continue:",{},{policyLink:()=>o.a.createElement("a",{href:a.url,rel:"noreferrer noopener",target:"_blank"},a.name,o.a.createElement("span",{className:"mx_InlineTermsAgreement_link"}))});e.push(o.a.createElement("div",{key:t,className:"mx_InlineTermsAgreement_cbContainer"},o.a.createElement("div",null,n),o.a.createElement("div",{className:"mx_InlineTermsAgreement_checkbox"},o.a.createElement(D.b,{onChange:()=>this.togglePolicy(t),checked:a.checked},Object(c.a)("Accept")))))}return e}render(){const e=!!this.state.policies.some(e=>!e.checked);return o.a.createElement("div",null,this.props.introElement,this.renderCheckboxes(),o.a.createElement(f.a,{onClick:this.onContinue,disabled:e||this.state.busy,kind:"primary_sm"},Object(c.a)("Continue")))}}var Ee=a(216),ye=a.n(Ee),_e=a(383),Se=a(325),we=a(170);class Ce extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"onAction",e=>{"id_server_changed"===e.action&&this.setState({currentClientIdServer:m.a.get().getIdentityServerUrl()})}),i()(this,"onIdentityServerChanged",e=>{const t=e.target.value;this.setState({idServer:t})}),i()(this,"getTooltip",()=>this.state.checking?o.a.createElement("div",null,o.a.createElement(we.a,null),Object(c.a)("Checking server")):this.state.error?o.a.createElement("span",{className:"warning"},this.state.error):null),i()(this,"idServerChangeEnabled",()=>!!this.state.idServer&&!this.state.busy),i()(this,"saveIdServer",e=>{m.a.get().setAccountData("m.identity_server",{base_url:e}),this.setState({busy:!1,error:null,currentClientIdServer:e,idServer:""})}),i()(this,"checkIdServer",async e=>{e.preventDefault();const{idServer:t,currentClientIdServer:a}=this.state;this.setState({busy:!0,checking:!0,error:null});const n=Object(W.b)(t);let i=await async function(e){if("https:"!==ye.a.parse(e).protocol)return Object(c.a)("Identity server URL must be HTTPS");try{const t=await fetch(e+"/_matrix/identity/api/v1");return t.ok?null:t.status<200||t.status>=300?Object(c.a)("Not a valid identity server (status code %(code)s)",{code:t.status}):Object(c.a)("Could not connect to identity server")}catch(e){return Object(c.a)("Could not connect to identity server")}}(n);if(!i)try{this.setState({checking:!1});const e=new V.a(n);await e.getAccessToken();let i=!0;if(!await Object(_e.b)(n)){const[e]=await this.showNoTermsWarning(n);i=e}if(i&&a&&n!==a){const[e]=await this.showServerChangeWarning({title:Object(c.a)("Change identity server"),unboundMessage:Object(c.a)("Disconnect from the identity server <current /> and connect to <new /> instead?",{},{current:e=>o.a.createElement("b",null,Object(W.a)(a)),new:e=>o.a.createElement("b",null,Object(W.a)(t))}),button:Object(c.a)("Continue")});i=e}i&&this.saveIdServer(n)}catch(e){d.a.error(e),i=Object(c.a)("Terms of service not accepted or the identity server is invalid.")}this.setState({busy:!1,checking:!1,error:i,currentClientIdServer:m.a.get().getIdentityServerUrl()})}),i()(this,"onDisconnectClicked",async()=>{this.setState({disconnectBusy:!0});try{const[e]=await this.showServerChangeWarning({title:Object(c.a)("Disconnect identity server"),unboundMessage:Object(c.a)("Disconnect from the identity server <idserver />?",{},{idserver:e=>o.a.createElement("b",null,Object(W.a)(this.state.currentClientIdServer))}),button:Object(c.a)("Disconnect")});e&&this.disconnectIdServer()}finally{this.setState({disconnectBusy:!1})}}),i()(this,"disconnectIdServer",()=>{m.a.get().setAccountData("m.identity_server",{base_url:null});let e="";Object(_e.c)()&&(e=Object(W.a)(Object(_e.c)())),this.setState({busy:!1,error:null,currentClientIdServer:m.a.get().getIdentityServerUrl(),idServer:e})});let t="";!m.a.get().getIdentityServerUrl()&&Object(_e.c)()&&(t=Object(W.a)(Object(_e.c)())),this.state={defaultIdServer:t,currentClientIdServer:m.a.get().getIdentityServerUrl(),idServer:"",error:null,busy:!1,disconnectBusy:!1,checking:!1}}componentDidMount(){this.dispatcherRef=U.a.register(this.onAction)}componentWillUnmount(){U.a.unregister(this.dispatcherRef)}showNoTermsWarning(e){const{finished:t}=g.a.createTrackedDialog("No Terms Warning","",de.a,{title:Object(c.a)("Identity server has no terms of service"),description:o.a.createElement("div",null,o.a.createElement("span",{className:"warning"},Object(c.a)("The identity server you have chosen does not have any terms of service.")),o.a.createElement("span",null," ",Object(c.a)("Only continue if you trust the owner of the server."))),button:Object(c.a)("Continue")});return t}async showServerChangeWarning(e){let{title:t,unboundMessage:a,button:n}=e;const{currentClientIdServer:i}=this.state;let s=[],r=!0;try{s=await Object(Se.b)(H(m.a.get()),Promise.reject(new Error("Timeout attempting to reach identity server")),1e4)}catch(e){r=!1,d.a.warn(`Unable to reach identity server at ${i} to check for 3PIDs during IS change flow`),d.a.warn(e)}const l=s.filter(e=>e.bound);let h,u=!1;const p={idserver:e=>o.a.createElement("b",null,Object(W.a)(i)),b:e=>o.a.createElement("b",null,e)};r?l.length?(h=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You are still <b>sharing your personal data</b> on the identity server <idserver />.",{},p)),o.a.createElement("p",null,Object(c.a)("We recommend that you remove your email addresses and phone numbers from the identity server before disconnecting."))),u=!0,n=Object(c.a)("Disconnect anyway")):h=a:(h=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You should <b>remove your personal data</b> from identity server <idserver /> before disconnecting. Unfortunately, identity server <idserver /> is currently offline or cannot be reached.",{},p)),o.a.createElement("p",null,Object(c.a)("You should:")),o.a.createElement("ul",null,o.a.createElement("li",null,Object(c.a)("check your browser plugins for anything that might block the identity server (such as Privacy Badger)")),o.a.createElement("li",null,Object(c.a)("contact the administrators of identity server <idserver />",{},{idserver:p.idserver})),o.a.createElement("li",null,Object(c.a)("wait and try again later")))),u=!0,n=Object(c.a)("Disconnect anyway"));const{finished:b}=g.a.createTrackedDialog("Identity Server Bound Warning","",de.a,{title:t,description:h,button:n,cancelButton:Object(c.a)("Go back"),danger:u});return b}render(){const e=this.state.currentClientIdServer;let t,a,n;if(e?(t=Object(c.a)("Identity server (%(server)s)",{server:Object(W.a)(e)}),a=Object(c.a)("You are currently using <server></server> to discover and be discoverable by existing contacts you know. You can change your identity server below.",{},{server:t=>o.a.createElement("b",null,Object(W.a)(e))}),this.props.missingTerms&&(a=Object(c.a)("If you don't want to use <server /> to discover and be discoverable by existing contacts you know, enter another identity server below.",{},{server:t=>o.a.createElement("b",null,Object(W.a)(e))}))):(t=Object(c.a)("Identity server"),a=Object(c.a)("You are not currently using an identity server. To discover and be discoverable by existing contacts you know, add one below.")),e){let e=Object(c.a)("Disconnect"),t=Object(c.a)("Disconnecting from your identity server will mean you won't be discoverable by other users and you won't be able to invite others by email or phone.");this.props.missingTerms&&(t=Object(c.a)("Using an identity server is optional. If you choose not to use an identity server, you won't be discoverable by other users and you won't be able to invite others by email or phone."),e=Object(c.a)("Do not use an identity server")),this.state.disconnectBusy&&(e=o.a.createElement(we.a,null)),n=o.a.createElement("div",null,o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},t),o.a.createElement(f.a,{onClick:this.onDisconnectClicked,kind:"danger_sm"},e))}return o.a.createElement("form",{className:"mx_SettingsTab_section mx_SetIdServer",onSubmit:this.checkIdServer},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},t),o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},a),o.a.createElement(h.a,{label:Object(c.a)("Enter a new identity server"),type:"text",autoComplete:"off",placeholder:this.state.defaultIdServer,value:this.state.idServer,onChange:this.onIdentityServerChanged,tooltipContent:this.getTooltip(),tooltipClassName:"mx_SetIdServer_tooltip",disabled:this.state.busy,forceValidity:!this.state.error&&null}),o.a.createElement(f.a,{type:"submit",kind:"primary_sm",onClick:this.checkIdServer,disabled:!this.idServerChangeEnabled()},Object(c.a)("Change")),n)}}var Oe=a(235),ke=a(525);class xe extends o.a.Component{constructor(e){super(e),i()(this,"onProvisioningToggled",()=>{const e=this.state.provisioningEnabled;C.b.setValue("integrationProvisioning",null,z.a.ACCOUNT,!e).catch(t=>{d.a.error("Error changing integration manager provisioning"),d.a.error(t),this.setState({provisioningEnabled:e})}),this.setState({provisioningEnabled:!e})});const t=Oe.a.sharedInstance().getPrimaryManager();this.state={currentManager:t,provisioningEnabled:C.b.getValue("integrationProvisioning")}}render(){const e=this.state.currentManager;let t,a;return e?(t=`(${e.name})`,a=Object(c.a)("Use an integration manager <b>(%(serverName)s)</b> to manage bots, widgets, and sticker packs.",{serverName:e.name},{b:e=>o.a.createElement("b",null,e)})):a=Object(c.a)("Use an integration manager to manage bots, widgets, and sticker packs."),o.a.createElement("div",{className:"mx_SetIntegrationManager"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},o.a.createElement("span",null,Object(c.a)("Manage integrations")),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},t),o.a.createElement(ke.a,{checked:this.state.provisioningEnabled,disabled:!1,onChange:this.onProvisioningToggled})),o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},a,o.a.createElement("br",null),o.a.createElement("br",null),Object(c.a)("Integration managers receive configuration data, and can modify widgets, send room invites, and set power levels on your behalf.")))}}function Re(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function je(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Re(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Re(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Ie extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"onAction",e=>{"id_server_changed"===e.action&&(this.setState({haveIdServer:Boolean(m.a.get().getIdentityServerUrl())}),this.getThreepidState())}),i()(this,"onEmailsChange",e=>{this.setState({emails:e})}),i()(this,"onMsisdnsChange",e=>{this.setState({msisdns:e})}),i()(this,"onLanguageChange",e=>{if(this.state.language===e)return;C.b.setValue("language",null,z.a.DEVICE,e),this.setState({language:e});const t=x.a.get();t&&(t.setLanguage([e]),t.reload())}),i()(this,"onSpellCheckLanguagesChange",e=>{this.setState({spellCheckLanguages:e});const t=x.a.get();t&&t.setSpellCheckLanguages(e)}),i()(this,"onPasswordChangeError",e=>{let t=e.error||e.message||"";403===e.httpStatus?t=Object(c.a)("Failed to change password. Is your password correct?"):t||(t+=` (HTTP status ${e.httpStatus})`),d.a.error("Failed to change password: "+t),g.a.createTrackedDialog("Failed to change password","",b.a,{title:Object(c.a)("Error"),description:t})}),i()(this,"onPasswordChanged",e=>{let{didLogoutOutOtherDevices:t}=e,a=Object(c.a)("Your password was successfully changed.");t&&(a+=" "+Object(c.a)("You will not receive push notifications on other devices until you sign back in to them.")),g.a.createTrackedDialog("Password changed","",b.a,{title:Object(c.a)("Success"),description:a})}),i()(this,"onDeactivateClicked",()=>{g.a.createTrackedDialog("Deactivate Account","",F,{onFinished:e=>{e&&this.props.closeSettingsFn()}})}),this.state={language:c.e(),spellCheckLanguages:[],haveIdServer:Boolean(m.a.get().getIdentityServerUrl()),serverSupportsSeparateAddAndBind:null,idServerHasUnsignedTerms:!1,requiredPolicyInfo:{hasTerms:!1,policiesAndServices:null,agreedUrls:null,resolve:null},emails:[],msisdns:[],loading3pids:!0,canChangePassword:!1,idServerName:null},this.dispatcherRef=U.a.register(this.onAction)}async UNSAFE_componentWillMount(){const e=m.a.get(),t=await e.doesServerSupportSeparateAddAndBind(),a=(await e.getCapabilities())["m.change_password"],n=!a||!1!==a.enabled;this.setState({serverSupportsSeparateAddAndBind:t,canChangePassword:n}),this.getThreepidState()}async componentDidMount(){const e=x.a.get();e&&this.setState({spellCheckLanguages:await e.getSpellCheckLanguages()})}componentWillUnmount(){U.a.unregister(this.dispatcherRef)}async getThreepidState(){const e=m.a.get();this.checkTerms();let t=[];try{t=await H(e)}catch(e){const t=m.a.get().getIdentityServerUrl();d.a.warn(`Unable to reach identity server at ${t} to check for 3PIDs bindings in Settings`),d.a.warn(e)}this.setState({emails:t.filter(e=>"email"===e.medium),msisdns:t.filter(e=>"msisdn"===e.medium),loading3pids:!1})}async checkTerms(){if(!this.state.haveIdServer)return void this.setState({idServerHasUnsignedTerms:!1});const e=m.a.get().getIdentityServerUrl(),t=new V.a;try{const a=await t.getAccessToken({check:!1});await Object(B.d)([new B.a(l.a.IS,e,a)],(t,a,n)=>new Promise((n,i)=>{this.setState({idServerName:Object(W.a)(e),requiredPolicyInfo:{hasTerms:!0,policiesAndServices:t,agreedUrls:a,resolve:n}})})),this.setState({requiredPolicyInfo:je(je({},this.state.requiredPolicyInfo),{},{hasTerms:!1})})}catch(t){d.a.warn(`Unable to reach identity server at ${e} to check for terms in Settings`),d.a.warn(t)}}renderProfileSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(w,null))}renderAccountSection(){let e=o.a.createElement(be,{className:"mx_GeneralUserSettingsTab_changePassword",rowClassName:"",buttonKind:"primary",onError:this.onPasswordChangeError,onFinished:this.onPasswordChanged}),t=null;if(C.b.getValue(K.b.ThirdPartyID)&&(this.state.haveIdServer||!0===this.state.serverSupportsSeparateAddAndBind)){const e=this.state.loading3pids?o.a.createElement(R.a,null):o.a.createElement(te,{emails:this.state.emails,onEmailsChange:this.onEmailsChange}),a=this.state.loading3pids?o.a.createElement(R.a,null):o.a.createElement(X,{msisdns:this.state.msisdns,onMsisdnsChange:this.onMsisdnsChange});t=o.a.createElement("div",null,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Email addresses")),e,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Phone numbers")),a)}else null===this.state.serverSupportsSeparateAddAndBind&&(t=o.a.createElement(R.a,null));let a=Object(c.a)("Set a new account password...");return this.state.canChangePassword||(a=null,e=null),o.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralUserSettingsTab_accountSection"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Account")),o.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},a),e,t)}renderLanguageSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Language and region")),o.a.createElement(O.a,{className:"mx_GeneralUserSettingsTab_languageInput",onOptionChange:this.onLanguageChange,value:this.state.language}))}renderSpellCheckSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Spell check dictionaries")),o.a.createElement(T,{languages:this.state.spellCheckLanguages,onLanguagesChange:this.onSpellCheckLanguagesChange}))}renderDiscoverySection(){if(this.state.requiredPolicyInfo.hasTerms){const e=o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Agree to the identity server (%(serverName)s) Terms of Service to allow yourself to be discoverable by email address or phone number.",{serverName:this.state.idServerName}));return o.a.createElement("div",null,o.a.createElement(fe,{policiesAndServicePairs:this.state.requiredPolicyInfo.policiesAndServices,agreedUrls:this.state.requiredPolicyInfo.agreedUrls,onFinished:this.state.requiredPolicyInfo.resolve,introElement:e}),o.a.createElement(Ce,{missingTerms:!0}))}const e=this.state.loading3pids?o.a.createElement(R.a,null):o.a.createElement(ne,{emails:this.state.emails}),t=this.state.loading3pids?o.a.createElement(R.a,null):o.a.createElement(se,{msisdns:this.state.msisdns}),a=this.state.haveIdServer?o.a.createElement("div",{className:"mx_GeneralUserSettingsTab_discovery"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Email addresses")),e,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Phone numbers")),t):null;return o.a.createElement("div",{className:"mx_SettingsTab_section"},a,o.a.createElement(Ce,{missingTerms:!1}))}renderManagementSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Account management")),o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Deactivating your account is a permanent action — be careful!")),o.a.createElement(f.a,{onClick:this.onDeactivateClicked,kind:"danger"},Object(c.a)("Deactivate Account")))}renderIntegrationManagerSection(){return C.b.getValue(K.b.Widgets)?o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(xe,null)):null}render(){const e=x.a.get().supportsMultiLanguageSpellCheck(),t=this.state.requiredPolicyInfo.hasTerms?o.a.createElement("img",{className:"mx_GeneralUserSettingsTab_warningIcon",src:a(789).default,width:"18",height:"18",alt:Object(c.a)("Warning")}):null;let n,i;return C.b.getValue(K.b.Deactivate)&&(n=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Deactivate account")),this.renderManagementSection())),C.b.getValue(K.b.IdentityServer)&&(i=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},t," ",Object(c.a)("Discovery")),this.renderDiscoverySection())),o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("General")),this.renderProfileSection(),this.renderAccountSection(),this.renderLanguageSection(),e?this.renderSpellCheckSection():null,i,this.renderIntegrationManagerSection(),n)}}var Te=a(111),Ne=a(195),Pe=a(265),Me=a(191),De=a(572),Ae=a(400);class Ue extends o.a.Component{constructor(){super(...arguments),i()(this,"onChange",async e=>{await C.b.setValue(this.props.featureId,null,z.a.DEVICE,e),this.forceUpdate()})}render(){const e=C.b.getDisplayName(this.props.featureId),t=C.b.getValue(this.props.featureId),a=C.b.canSetValue(this.props.featureId,null,z.a.DEVICE);return o.a.createElement(Ne.a,{value:t,label:e,onChange:this.onChange,disabled:!a})}}class Le extends o.a.Component{constructor(e){super(e),m.a.get().doesServerSupportUnstableFeature("org.matrix.msc2285").then(e=>{this.setState({showHiddenReadReceipts:e})}),m.a.get().doesServerSupportUnstableFeature("org.matrix.msc3030").then(e=>{this.setState({showJumpToDate:e})}),this.state={showHiddenReadReceipts:!1,showJumpToDate:!1}}render(){const e=C.b.getFeatureSettingNames(),[t,a]=e.reduce((e,t)=>(e[C.b.getBetaInfo(t)?1:0].push(t),e),[[],[]]);let n,i;if(a.length&&(n=o.a.createElement("div",{className:"mx_SettingsTab_section"},a.map(e=>o.a.createElement(Pe.b,{key:e,featureId:e})))),u.b.get("show_labs_settings")){const e=new Ae.a;t.forEach(t=>{e.getOrCreate(C.b.getLabGroup(t),[]).push(o.a.createElement(Ue,{featureId:t,key:t}))}),e.getOrCreate(De.a.Experimental,[]).push(o.a.createElement(Me.a,{key:"lowBandwidth",name:"lowBandwidth",level:z.a.DEVICE})),e.getOrCreate(De.a.Analytics,[]).push(o.a.createElement(Me.a,{key:"automaticErrorReporting",name:"automaticErrorReporting",level:z.a.DEVICE}),o.a.createElement(Me.a,{key:"automaticDecryptionErrorReporting",name:"automaticDecryptionErrorReporting",level:z.a.DEVICE})),this.state.showHiddenReadReceipts&&e.getOrCreate(De.a.Messaging,[]).push(o.a.createElement(Me.a,{key:"feature_hidden_read_receipts",name:"feature_hidden_read_receipts",level:z.a.DEVICE})),this.state.showJumpToDate&&e.getOrCreate(De.a.Messaging,[]).push(o.a.createElement(Me.a,{key:"feature_jump_to_date",name:"feature_jump_to_date",level:z.a.DEVICE})),i=o.a.createElement(o.a.Fragment,null,Object(Te.sortBy)(Array.from(e.entries()),"0").map(e=>{let[t,a]=e;return o.a.createElement("div",{className:"mx_SettingsTab_section",key:t},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)(De.c[t])),a)}))}return o.a.createElement("div",{className:"mx_SettingsTab mx_LabsUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Labs")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Feeling experimental? Labs are the best way to get things early, test out new features and help shape them before they actually launch. <a>Learn more</a>.",{},{a:e=>o.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),n,i)}}var Fe=a(94),Be=a.n(Fe),Ve=a(108),We=a(221),He=a(355),ze=a(157);class Ke extends o.a.Component{constructor(e){super(e),this.state={message:e.message}}fakeEvent(e){var t=this;let{message:a}=e;const n={type:"m.room.message",sender:this.props.userId,content:{"m.new_content":{msgtype:"m.text",body:a,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},msgtype:"m.text",body:a,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:"!999999999999999999:example.org"},i=new Ve.b(n);return i.sender={name:this.props.displayName||this.props.userId,rawDisplayName:this.props.displayName,userId:this.props.userId,getAvatarUrl:function(){return We.c({avatarUrl:t.props.avatarUrl},32,32,"crop")},getMxcAvatarUrl:()=>this.props.avatarUrl},i}render(){const e=Be()(this.props.className,{mx_IRCLayout:this.props.layout==ze.a.IRC,mx_GroupLayout:this.props.layout==ze.a.Group,mx_EventTilePreview_loader:!this.props.userId});if(!this.props.userId)return o.a.createElement("div",{className:e},o.a.createElement(R.a,null));const t=this.fakeEvent(this.state);return o.a.createElement("div",{className:e},o.a.createElement(He.a,{mxEvent:t,layout:this.props.layout,as:"div"}))}}var qe=a(220);class Ge extends o.a.Component{constructor(e){super(e),i()(this,"onLayoutChange",e=>{const t=e.target.value;this.setState({layout:t}),C.b.setValue("layout",null,z.a.DEVICE,t),this.props.onLayoutChanged(t)}),this.state={layout:C.b.getValue("layout")}}render(){const e=Be()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout==ze.a.IRC}),t=Be()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout==ze.a.Group}),a=Be()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout===ze.a.Bubble});return o.a.createElement("div",{className:"mx_SettingsTab_section mx_LayoutSwitcher"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Message layout")),o.a.createElement("div",{className:"mx_LayoutSwitcher_RadioButtons"},o.a.createElement("label",{className:e},o.a.createElement(Ke,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:ze.a.IRC,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.a.createElement(qe.a,{name:"layout",value:ze.a.IRC,checked:this.state.layout===ze.a.IRC,onChange:this.onLayoutChange},Object(c.a)("IRC (Experimental)"))),o.a.createElement("label",{className:t},o.a.createElement(Ke,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:ze.a.Group,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.a.createElement(qe.a,{name:"layout",value:ze.a.Group,checked:this.state.layout==ze.a.Group,onChange:this.onLayoutChange},Object(c.a)("Modern"))),o.a.createElement("label",{className:a},o.a.createElement(Ke,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:ze.a.Bubble,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.a.createElement(qe.a,{name:"layout",value:ze.a.Bubble,checked:this.state.layout==ze.a.Bubble,onChange:this.onLayoutChange},Object(c.a)("Message bubbles")))))}}class Ye extends s.Component{offset(e,t){const a=e.reduce((e,a)=>t>a?e+1:e,0);if(0===a)return 0;if(a===e.length)return 100;const n=e[a-1],i=e[a],s=1/(e.length-1);return 100*(a-1+(t-n)/(i-n))*s}render(){const e=this.props.values.map(e=>s.createElement(Je,{active:e<=this.props.value,label:this.props.displayFunc(e),onClick:this.props.disabled?()=>{}:()=>this.props.onSelectionChange(e),key:e,disabled:this.props.disabled}));let t=null;if(!this.props.disabled){const e=this.offset(this.props.values,this.props.value);t=s.createElement("div",{className:"mx_Slider_selection"},s.createElement("div",{className:"mx_Slider_selectionDot",style:{left:"calc(-1.195em + "+e+"%)"}},s.createElement("div",{className:"mx_Slider_selectionText"},this.props.value)),s.createElement("hr",{style:{width:e+"%"}}))}return s.createElement("div",{className:"mx_Slider"},s.createElement("div",null,s.createElement("div",{className:"mx_Slider_bar"},s.createElement("hr",{onClick:this.props.disabled?()=>{}:this.onClick.bind(this)}),t),s.createElement("div",{className:"mx_Slider_dotContainer"},e)))}onClick(e){const t=e.target.clientWidth,a=e.nativeEvent.offsetX/t,n=this.props.values[Math.round(a*(this.props.values.length-1))];this.props.onSelectionChange(n)}}class Je extends s.PureComponent{render(){let e="mx_Slider_dot";return!this.props.disabled&&this.props.active&&(e+=" mx_Slider_dotActive"),s.createElement("span",{onClick:this.props.onClick,className:"mx_Slider_dotValue"},s.createElement("div",{className:e}),s.createElement("div",{className:"mx_Slider_labelContainer"},s.createElement("div",{className:"mx_Slider_label"},this.props.label)))}}var $e=a(551);class Qe extends o.a.Component{constructor(e){super(e),i()(this,"MESSAGE_PREVIEW_TEXT",Object(c.a)("Hey you. You're the best!")),i()(this,"unmounted",!1),i()(this,"onFontSizeChanged",e=>{this.setState({fontSize:e.toString()}),C.b.setValue("baseFontSize",null,z.a.DEVICE,e-$e.a.SIZE_DIFF)}),i()(this,"onValidateFontSize",async e=>{let{value:t}=e;const a=parseFloat(t),n=$e.a.MIN_SIZE+$e.a.SIZE_DIFF,i=$e.a.MAX_SIZE+$e.a.SIZE_DIFF;return isNaN(a)?{valid:!1,feedback:Object(c.a)("Size must be a number")}:n<=a&&a<=i?(C.b.setValue("baseFontSize",null,z.a.DEVICE,parseInt(t,10)-$e.a.SIZE_DIFF),{valid:!0,feedback:Object(c.a)("Use between %(min)s pt and %(max)s pt",{min:n,max:i})}):{valid:!1,feedback:Object(c.a)("Custom font size can only be between %(min)s pt and %(max)s pt",{min:n,max:i})}}),this.state={fontSize:(C.b.getValue("baseFontSize",null)+$e.a.SIZE_DIFF).toString(),useCustomFontSize:C.b.getValue("useCustomFontSize"),layout:C.b.getValue("layout"),userId:null,displayName:null,avatarUrl:null}}async componentDidMount(){const e=m.a.get(),t=e.getUserId(),a=await e.getProfileInfo(t);this.unmounted||this.setState({userId:t,displayName:a.displayname,avatarUrl:a.avatar_url})}componentWillUnmount(){this.unmounted=!0}render(){return o.a.createElement("div",{className:"mx_SettingsTab_section mx_FontScalingPanel"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Font size")),o.a.createElement(Ke,{className:"mx_FontScalingPanel_fontSlider_preview",message:this.MESSAGE_PREVIEW_TEXT,layout:this.state.layout,userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl}),o.a.createElement("div",{className:"mx_FontScalingPanel_fontSlider"},o.a.createElement("div",{className:"mx_FontScalingPanel_fontSlider_smallText"},"Aa"),o.a.createElement(Ye,{values:[13,14,15,16,18],value:parseInt(this.state.fontSize,10),onSelectionChange:this.onFontSizeChanged,displayFunc:e=>"",disabled:this.state.useCustomFontSize}),o.a.createElement("div",{className:"mx_FontScalingPanel_fontSlider_largeText"},"Aa")),o.a.createElement(Me.a,{name:"useCustomFontSize",level:z.a.ACCOUNT,onChange:e=>this.setState({useCustomFontSize:e}),useCheckbox:!0}),o.a.createElement(h.a,{type:"number",label:Object(c.a)("Font size"),autoComplete:"off",placeholder:this.state.fontSize.toString(),value:this.state.fontSize.toString(),id:"font_size_field",onValidate:this.onValidateFontSize,onChange:e=>this.setState({fontSize:e.target.value}),disabled:!this.state.useCustomFontSize,className:"mx_FontScalingPanel_customFontSizeField"}))}}var Xe=a(820),Ze=a(409);class et extends o.a.Component{constructor(e){super(e),i()(this,"onSizeChange",e=>{const t=e.target.value;this.setState({size:t}),C.b.setValue("Images.size",null,z.a.ACCOUNT,t)}),this.state={size:C.b.getValue("Images.size")}}render(){return o.a.createElement("div",{className:"mx_SettingsTab_section mx_ImageSizePanel"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Image size in the timeline")),o.a.createElement("div",{className:"mx_ImageSizePanel_radios"},o.a.createElement("label",null,o.a.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeDefault"}),o.a.createElement(qe.a,{name:"image_size",value:Ze.a.Normal,checked:this.state.size===Ze.a.Normal,onChange:this.onSizeChange},Object(c.a)("Default"))),o.a.createElement("label",null,o.a.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeLarge"}),o.a.createElement(qe.a,{name:"image_size",value:Ze.a.Large,checked:this.state.size===Ze.a.Large,onChange:this.onSizeChange},Object(c.a)("Large")))))}}class tt extends o.a.Component{constructor(e){super(e),i()(this,"MESSAGE_PREVIEW_TEXT",Object(c.a)("Hey you. You're the best!")),i()(this,"unmounted",!1),i()(this,"onLayoutChanged",e=>{this.setState({layout:e})}),this.state={useSystemFont:C.b.getValue("useSystemFont"),systemFont:C.b.getValue("systemFont"),showAdvanced:!1,layout:C.b.getValue("layout"),userId:null,displayName:null,avatarUrl:null}}async componentDidMount(){const e=m.a.get(),t=e.getUserId(),a=await e.getProfileInfo(t);this.unmounted||this.setState({userId:t,displayName:a.displayname,avatarUrl:a.avatar_url})}componentWillUnmount(){this.unmounted=!0}renderAdvancedSection(){if(!C.b.getValue(K.b.AdvancedSettings))return null;const e=u.b.get().brand,t=o.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_AdvancedToggle",onClick:()=>this.setState({showAdvanced:!this.state.showAdvanced})},this.state.showAdvanced?Object(c.a)("Hide advanced"):Object(c.a)("Show advanced"));let a;if(this.state.showAdvanced){const t=Object(c.a)("Set the name of a font installed on your system & %(brand)s will attempt to use it.",{brand:e});a=o.a.createElement(o.a.Fragment,null,o.a.createElement(Me.a,{name:"useCompactLayout",level:z.a.DEVICE,useCheckbox:!0}),o.a.createElement(Me.a,{name:"useSystemFont",level:z.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useSystemFont:e})}),o.a.createElement(h.a,{className:"mx_AppearanceUserSettingsTab_systemFont",label:C.b.getDisplayName("systemFont"),onChange:e=>{this.setState({systemFont:e.target.value}),C.b.setValue("systemFont",null,z.a.DEVICE,e.target.value)},tooltipContent:t,forceTooltipVisible:!0,disabled:!this.state.useSystemFont,value:this.state.systemFont}))}return o.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_Advanced"},t,a)}render(){const e=u.b.get().brand;return o.a.createElement("div",{className:"mx_SettingsTab mx_AppearanceUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Customise your appearance")),o.a.createElement("div",{className:"mx_SettingsTab_SubHeading"},Object(c.a)("Appearance Settings only affect this %(brand)s session.",{brand:e})),o.a.createElement(Xe.a,null),o.a.createElement(Ge,{userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl,messagePreviewText:this.MESSAGE_PREVIEW_TEXT,onLayoutChanged:this.onLayoutChanged}),o.a.createElement(Qe,null),this.renderAdvancedSection(),o.a.createElement(et,null))}}var at=a(7),nt=a(113),it=a(145),st=a(205),ot=a(323),rt=a(214);class ct extends o.a.PureComponent{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"onKeyBackupSessionsRemaining",e=>{this.setState({sessionsRemaining:e})}),i()(this,"onKeyBackupStatus",()=>{this.loadBackupStatus()}),i()(this,"startNewBackup",()=>{g.a.createTrackedDialogAsync("Key Backup","Key Backup",a.e(7).then(a.bind(null,838)),{onFinished:()=>{this.loadBackupStatus()}},null,!1,!0)}),i()(this,"deleteBackup",()=>{g.a.createTrackedDialog("Delete Backup","",de.a,{title:Object(c.a)("Delete Backup"),description:Object(c.a)("Are you sure? You will lose your encrypted messages if your keys are not backed up properly."),button:Object(c.a)("Delete Backup"),danger:!0,onFinished:e=>{e&&(this.setState({loading:!0}),m.a.get().deleteKeyBackupVersion(this.state.backupInfo.version).then(()=>{this.loadBackupStatus()}))}})}),i()(this,"restoreBackup",async()=>{g.a.createTrackedDialog("Restore Backup","",ot.a,null,null,!1,!0)}),i()(this,"resetSecretStorage",async()=>{this.setState({error:null});try{await Object(rt.b)(async()=>{},!0)}catch(e){if(d.a.error("Error resetting secret storage",e),this.unmounted)return;this.setState({error:e})}this.unmounted||this.loadBackupStatus()}),this.state={loading:!0,error:null,backupKeyStored:null,backupKeyCached:null,backupKeyWellFormed:null,secretStorageKeyInAccount:null,secretStorageReady:null,backupInfo:null,backupSigStatus:null,sessionsRemaining:0}}componentDidMount(){this.checkKeyBackupStatus(),m.a.get().on(it.b.KeyBackupStatus,this.onKeyBackupStatus),m.a.get().on(it.b.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining)}componentWillUnmount(){this.unmounted=!0,m.a.get()&&(m.a.get().removeListener(it.b.KeyBackupStatus,this.onKeyBackupStatus),m.a.get().removeListener(it.b.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining))}async checkKeyBackupStatus(){this.getUpdatedDiagnostics();try{const{backupInfo:e,trustInfo:t}=await m.a.get().checkKeyBackup();this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(d.a.log("Unable to fetch check backup status",e),this.unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async loadBackupStatus(){this.setState({loading:!0}),this.getUpdatedDiagnostics();try{const e=await m.a.get().getKeyBackupVersion(),t=await m.a.get().isKeyBackupTrusted(e);if(this.unmounted)return;this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(d.a.log("Unable to fetch key backup status",e),this.unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async getUpdatedDiagnostics(){const e=m.a.get(),t=e.crypto.secretStorage,a=!!await e.isKeyBackupKeyStored(),n=await e.crypto.getSessionBackupPrivateKey(),i=!!n,s=n instanceof Uint8Array,o=await t.hasKey(),r=await e.isSecretStorageReady();this.unmounted||this.setState({backupKeyStored:a,backupKeyCached:i,backupKeyWellFormed:s,secretStorageKeyInAccount:o,secretStorageReady:r})}render(){const{loading:e,error:t,backupKeyStored:a,backupKeyCached:n,backupKeyWellFormed:i,secretStorageKeyInAccount:s,secretStorageReady:r,backupInfo:l,backupSigStatus:d,sessionsRemaining:h}=this.state;let u,p,g;const b=[];if(t)u=o.a.createElement("div",{className:"error"},Object(c.a)("Unable to load key backup status"));else if(e)u=o.a.createElement(R.a,null);else if(l){let e,t=Object(c.a)("Restore from Backup");m.a.get().getKeyBackupEnabled()?u=o.a.createElement("p",null,"✅ ",Object(c.a)("This session is backing up your keys. ")):(u=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(c.a)("This session is <b>not backing up your keys</b>, but you do have an existing backup you can restore from and add to going forward.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,Object(c.a)("Connect this session to key backup before signing out to avoid losing any keys that may only be on this session."))),t=Object(c.a)("Connect this session to Key Backup")),e=m.a.get().getKeyBackupEnabled()?h>0?o.a.createElement("div",null,Object(c.a)("Backing up %(sessionsRemaining)s keys...",{sessionsRemaining:h})," ",o.a.createElement("br",null)):o.a.createElement("div",null,Object(c.a)("All keys backed up")," ",o.a.createElement("br",null)):"";let a,n=d.sigs.map((e,t)=>{const a=e.device?e.device.getDisplayName()||e.device.deviceId:null,n=t=>o.a.createElement("span",{className:e.valid?"mx_SecureBackupPanel_sigValid":"mx_SecureBackupPanel_sigInvalid"},t),i=t=>o.a.createElement("span",{className:e.device&&e.deviceTrust.isVerified()?"mx_SecureBackupPanel_deviceVerified":"mx_SecureBackupPanel_deviceNotVerified"},t),s=e=>o.a.createElement("span",{className:"mx_SecureBackupPanel_deviceName"},a),r=e.device&&e.device.getFingerprint()===m.a.get().getDeviceEd25519Key(),l=e.crossSigningId&&e.deviceId===m.a.get().getCrossSigningId();let d;return e.valid&&l?d=Object(c.a)("Backup has a <validity>valid</validity> signature from this user",{},{validity:n}):!e.valid&&l?d=Object(c.a)("Backup has a <validity>invalid</validity> signature from this user",{},{validity:n}):e.crossSigningId?d=Object(c.a)("Backup has a signature from <verify>unknown</verify> user with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}):e.device?e.valid&&r?d=Object(c.a)("Backup has a <validity>valid</validity> signature from this session",{},{validity:n}):!e.valid&&r?d=Object(c.a)("Backup has an <validity>invalid</validity> signature from this session",{},{validity:n}):e.valid&&e.deviceTrust.isVerified()?d=Object(c.a)("Backup has a <validity>valid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:s}):e.valid&&!e.deviceTrust.isVerified()?d=Object(c.a)("Backup has a <validity>valid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:s}):!e.valid&&e.deviceTrust.isVerified()?d=Object(c.a)("Backup has an <validity>invalid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:s}):e.valid||e.deviceTrust.isVerified()||(d=Object(c.a)("Backup has an <validity>invalid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:s})):d=Object(c.a)("Backup has a signature from <verify>unknown</verify> session with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}),o.a.createElement("div",{key:t},d)});0===d.sigs.length&&(n=Object(c.a)("Backup is not signed by any of your sessions")),d.trusted_locally&&(a=Object(c.a)("This backup is trusted because it has been restored on this session")),p=o.a.createElement(o.a.Fragment,null,o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Backup version:")),o.a.createElement("td",null,l.version)),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Algorithm:")),o.a.createElement("td",null,l.algorithm))),g=o.a.createElement(o.a.Fragment,null,e,o.a.createElement("div",null,n),o.a.createElement("div",null,a)),b.push(o.a.createElement(f.a,{key:"restore",kind:"primary",onClick:this.restoreBackup},t)),Object(st.g)()||b.push(o.a.createElement(f.a,{key:"delete",kind:"danger",onClick:this.deleteBackup},Object(c.a)("Delete Backup")))}else u=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(c.a)("Your keys are <b>not being backed up from this session</b>.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,Object(c.a)("Back up your keys before signing out to avoid losing them."))),b.push(o.a.createElement(f.a,{key:"setup",kind:"primary",onClick:this.startNewBackup},Object(c.a)("Set up")));s&&b.push(o.a.createElement(f.a,{key:"reset",kind:"danger",onClick:this.resetSecretStorage},Object(c.a)("Reset")));let v,E="";return n&&(E=", ",E+=i?Object(c.a)("well formed"):Object(c.a)("unexpected type")),b.length&&(v=o.a.createElement("div",{className:"mx_SecureBackupPanel_buttonRow"},b)),o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Back up your encryption keys with your account data in case you lose access to your sessions. Your keys will be secured with a unique Security Key.")),u,o.a.createElement("details",null,o.a.createElement("summary",null,Object(c.a)("Advanced")),o.a.createElement("table",{className:"mx_SecureBackupPanel_statusList"},o.a.createElement("tbody",null,o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Backup key stored:")),o.a.createElement("td",null,!0===a?Object(c.a)("in secret storage"):Object(c.a)("not stored"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Backup key cached:")),o.a.createElement("td",null,n?Object(c.a)("cached locally"):Object(c.a)("not found locally"),E)),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Secret storage public key:")),o.a.createElement("td",null,s?Object(c.a)("in account data"):Object(c.a)("not found"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Secret storage:")),o.a.createElement("td",null,r?Object(c.a)("ready"):Object(c.a)("not ready"))),p)),g),v)}}var lt=e=>o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Encryption")),o.a.createElement(Me.a,{name:"e2ee.manuallyVerifyAllSessions",level:z.a.DEVICE}),o.a.createElement("div",{className:"mx_E2eAdvancedPanel_settingLongDescription"},Object(c.a)("Individually verify each session used by a user to mark it as trusted, not trusting cross-signed devices.")));var dt=a(175);class mt extends o.a.Component{constructor(e){super(e),i()(this,"onExportE2eKeysClicked",()=>{g.a.createTrackedDialogAsync("Export E2E Keys","",a.e(6).then(a.bind(null,1474)),{matrixClient:m.a.get()})}),i()(this,"onImportE2eKeysClicked",()=>{g.a.createTrackedDialogAsync("Import E2E Keys","",a.e(30).then(a.bind(null,1502)),{matrixClient:m.a.get()})}),i()(this,"updateBlacklistDevicesFlag",e=>{m.a.get().setGlobalBlacklistUnverifiedDevices(e)})}render(){const e=m.a.get(),t=e.deviceId;let a=e.getDeviceEd25519Key();a=a?dt.e(a):Object(c.a)("<not supported>");let n,i=null;return e.isCryptoEnabled()&&(i=o.a.createElement("div",{className:"mx_CryptographyPanel_importExportButtons"},o.a.createElement(f.a,{kind:"primary",onClick:this.onExportE2eKeysClicked},Object(c.a)("Export E2E room keys")),o.a.createElement(f.a,{kind:"primary",onClick:this.onImportE2eKeysClicked},Object(c.a)("Import E2E room keys")))),C.b.isEnabled("blacklistUnverifiedDevices")&&(n=o.a.createElement(Me.a,{name:"blacklistUnverifiedDevices",level:z.a.DEVICE,onChange:this.updateBlacklistDevicesFlag})),o.a.createElement("div",{className:"mx_SettingsTab_section mx_CryptographyPanel"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Cryptography")),o.a.createElement("table",{className:"mx_SettingsTab_subsectionText mx_CryptographyPanel_sessionInfo"},o.a.createElement("tbody",null,o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Session ID:")),o.a.createElement("td",null,o.a.createElement("code",null,t))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Session key:")),o.a.createElement("td",null,o.a.createElement("code",null,o.a.createElement("b",null,a)))))),i,n)}}var ht=a(133),ut=a(211),pt=a(555),gt=a(556),bt=a(821);class vt extends o.a.Component{constructor(e){super(e),i()(this,"onDeviceToggled",()=>{this.props.onDeviceToggled(this.props.device)}),i()(this,"onRename",()=>{this.setState({renaming:!0})}),i()(this,"onChangeDisplayName",e=>{this.setState({displayName:e.target.value})}),i()(this,"onRenameSubmit",async()=>{this.setState({renaming:!1}),await m.a.get().setDeviceDetails(this.props.device.device_id,{display_name:this.state.displayName}).catch(e=>{throw d.a.error("Error setting session display name",e),new Error(Object(c.a)("Failed to set display name"))}),this.props.onDeviceChange()}),i()(this,"onRenameCancel",()=>{this.setState({renaming:!1})}),i()(this,"onOwnDeviceSignOut",()=>{g.a.createTrackedDialog("Logout from device list","",bt.a,{},null,!1,!0)}),i()(this,"verify",async()=>{if(this.props.isOwnDevice)g.a.createTrackedDialog("Verify session","Verify session",pt.a,{onFinished:this.props.onDeviceChange});else{const e=m.a.get(),t=e.getUserId(),a=e.requestVerification(t,[this.props.device.device_id]);g.a.createTrackedDialog("New Session Verification","Starting dialog",gt.a,{verificationRequestPromise:a,member:e.getUser(t),onFinished:async()=>{(await a).cancel(),this.props.onDeviceChange()}})}}),this.state={renaming:!1,displayName:e.device.display_name}}render(){const e=this.props.device;let t="";if(e.last_seen_ts){const a=new Date(e.last_seen_ts);t=Object(c.a)("Last seen %(date)s at %(ip)s",{date:Object(ht.b)(a),ip:e.last_seen_ip})}const a=this.props.isOwnDevice?" mx_DevicesPanel_myDevice":"";let n,i,s="";null!==this.props.verified&&(s=this.props.verified?"mx_E2EIcon_verified":"mx_E2EIcon_warning",!this.props.verified&&this.props.canBeVerified&&(n=o.a.createElement(f.a,{kind:"primary",onClick:this.verify},Object(c.a)("Verify")))),this.props.isOwnDevice&&(i=o.a.createElement(f.a,{kind:"danger_outline",onClick:this.onOwnDeviceSignOut},Object(c.a)("Sign Out")));const r=this.props.isOwnDevice?o.a.createElement("div",{className:"mx_DevicesPanel_deviceTrust"},o.a.createElement("span",{className:"mx_DevicesPanel_icon mx_E2EIcon "+s})):o.a.createElement("div",{className:"mx_DevicesPanel_checkbox"},o.a.createElement(D.b,{kind:D.a.Outline,onChange:this.onDeviceToggled,checked:this.props.selected})),l=e.display_name?o.a.createElement(o.a.Fragment,null,o.a.createElement(ut.a,{tooltip:e.display_name+" ("+e.device_id+")"},e.display_name)):o.a.createElement(o.a.Fragment,null,e.device_id),d=this.state.renaming?o.a.createElement("form",{className:"mx_DevicesPanel_renameForm",onSubmit:this.onRenameSubmit},o.a.createElement(h.a,{label:Object(c.a)("Display Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onChangeDisplayName,autoFocus:!0}),o.a.createElement(f.a,{onClick:this.onRenameSubmit,kind:"confirm_sm"}),o.a.createElement(f.a,{onClick:this.onRenameCancel,kind:"cancel_sm"})):o.a.createElement(o.a.Fragment,null,i,n,o.a.createElement(f.a,{kind:"primary_outline",onClick:this.onRename},Object(c.a)("Rename")));return o.a.createElement("div",{className:"mx_DevicesPanel_device"+a},r,o.a.createElement("div",{className:"mx_DevicesPanel_deviceInfo"},o.a.createElement("div",{className:"mx_DevicesPanel_deviceName"},l),o.a.createElement("div",{className:"mx_DevicesPanel_lastSeen"},t)),o.a.createElement("div",{className:"mx_DevicesPanel_deviceButtons"},d))}}class ft extends o.a.Component{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"onDeviceSelectionToggled",e=>{if(this.unmounted)return;const t=e.device_id;this.setState((e,a)=>{const n=e.selectedDevices.slice(),i=n.indexOf(t);return-1===i?n.push(t):n.splice(i,1),{selectedDevices:n}})}),i()(this,"selectAll",e=>{this.setState((t,a)=>{const n=t.selectedDevices.slice();for(const t of e){const e=t.device_id;n.includes(e)||n.push(e)}return{selectedDevices:n}})}),i()(this,"deselectAll",e=>{this.setState((t,a)=>{const n=t.selectedDevices.slice();for(const t of e){const e=t.device_id,a=n.indexOf(e);-1!==a&&n.splice(a,1)}return{selectedDevices:n}})}),i()(this,"onDeleteClick",()=>{0!==this.state.selectedDevices.length&&(this.setState({deleting:!0}),this.makeDeleteRequest(null).catch(e=>{if(this.unmounted)return;if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=this.state.selectedDevices.length,a={[M.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("Confirm logging out these devices by using Single Sign On to prove your identity.",{count:t}),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[M.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm signing out these devices",{count:t}),body:Object(c.a)("Click the button below to confirm signing out these devices.",{count:t}),continueText:Object(c.a)("Sign out devices",{count:t}),continueKind:"danger"}};g.a.createTrackedDialog("Delete Device Dialog","",G.a,{title:Object(c.a)("Authentication"),matrixClient:m.a.get(),authData:e.data,makeRequest:this.makeDeleteRequest.bind(this),aestheticsForStagePhases:{[M.c.LOGIN_TYPE]:a,[M.c.UNSTABLE_LOGIN_TYPE]:a}})}).catch(e=>{d.a.error("Error deleting sessions",e),this.unmounted}).finally(()=>{this.setState({deleting:!1})}))}),i()(this,"renderDevice",e=>{const t=m.a.get().getDeviceId(),a=this.state.devices.find(e=>e.device_id===t),n=e.device_id===t,i=a&&this.isDeviceVerified(a)||n;return o.a.createElement(vt,{key:e.device_id,device:e,selected:this.state.selectedDevices.includes(e.device_id),isOwnDevice:n,verified:this.isDeviceVerified(e),canBeVerified:i,onDeviceChange:this.loadDevices,onDeviceToggled:this.onDeviceSelectionToggled})}),this.state={devices:[],selectedDevices:[]},this.loadDevices=this.loadDevices.bind(this)}componentDidMount(){this.loadDevices()}componentWillUnmount(){this.unmounted=!0}loadDevices(){const e=m.a.get();e.getDevices().then(t=>{if(this.unmounted)return;const a=e.getStoredCrossSigningForUser(e.getUserId());this.setState((e,n)=>{const i=t.devices.map(e=>e.device_id),s=e.selectedDevices.filter(e=>i.includes(e));return{devices:t.devices||[],selectedDevices:s,crossSigningInfo:a}}),console.log(this.state)},e=>{if(this.unmounted)return;let t;404==e.httpStatus?t=Object(c.a)("Your homeserver does not support device management."):(d.a.error("Error loading sessions:",e),t=Object(c.a)("Unable to load device list")),this.setState({deviceLoadError:t})})}deviceCompare(e,t){const a=(t.last_seen_ts||0)-(e.last_seen_ts||0);if(0!==a)return a;const n=e.device_id,i=t.device_id;return n<i?-1:n>i?1:0}isDeviceVerified(e){try{const t=m.a.get(),a=t.getStoredDevice(t.getUserId(),e.device_id);return this.state.crossSigningInfo.checkDeviceTrust(this.state.crossSigningInfo,a,!1,!0).isCrossSigningVerified()}catch(e){return console.error("Error getting device cross-signing info",e),null}}makeDeleteRequest(e){return m.a.get().deleteMultipleDevices(this.state.selectedDevices,e).then(()=>{this.setState({selectedDevices:[]}),this.loadDevices()})}render(){const e=o.a.createElement("div",{className:Be()(this.props.className,"error")},this.state.deviceLoadError);if(void 0!==this.state.deviceLoadError)return e;const t=this.state.devices;if(void 0===t)return o.a.createElement(R.a,null);const a=m.a.get().getDeviceId(),n=t.find(e=>e.device_id===a);if(!n)return e;const i=t.filter(e=>e.device_id!==a);i.sort(this.deviceCompare);const s=[],r=[],l=[];for(const e of i){const t=this.isDeviceVerified(e);!0===t?s.push(e):!1===t?r.push(e):l.push(e)}const d=(e,t,a)=>{if(0===a.length)return o.a.createElement(o.a.Fragment,null);let n;if(a.length>1){const e=a.some(e=>this.state.selectedDevices.includes(e.device_id)),t=e?()=>{this.deselectAll(a)}:()=>{this.selectAll(a)},i=e?Object(c.a)("Deselect all"):Object(c.a)("Select all");n=o.a.createElement("div",{className:"mx_DevicesPanel_header_button"},o.a.createElement(f.a,{className:"mx_DevicesPanel_selectButton",kind:"secondary",onClick:t},i))}return o.a.createElement(o.a.Fragment,null,o.a.createElement("hr",null),o.a.createElement("div",{className:"mx_DevicesPanel_header"},o.a.createElement("div",{className:"mx_DevicesPanel_header_trust"},e),o.a.createElement("div",{className:"mx_DevicesPanel_header_title"},t),n),a.map(this.renderDevice))},h=d(o.a.createElement("span",{className:"mx_DevicesPanel_header_icon mx_E2EIcon mx_E2EIcon_verified"}),Object(c.a)("Verified devices"),s),u=d(o.a.createElement("span",{className:"mx_DevicesPanel_header_icon mx_E2EIcon mx_E2EIcon_warning"}),Object(c.a)("Unverified devices"),r),p=d(o.a.createElement(o.a.Fragment,null),Object(c.a)("Devices without encryption support"),l),g=this.state.deleting?o.a.createElement(R.a,{w:22,h:22}):o.a.createElement(f.a,{className:"mx_DevicesPanel_deleteButton",onClick:this.onDeleteClick,kind:"danger_outline",disabled:0===this.state.selectedDevices.length},Object(c.a)("Sign out %(count)s selected devices",{count:this.state.selectedDevices.length})),b=i.length>0?o.a.createElement(o.a.Fragment,null,h,u,p,g):o.a.createElement(o.a.Fragment,null,o.a.createElement("hr",null),o.a.createElement("div",{className:"mx_DevicesPanel_noOtherDevices"},Object(c.a)("You aren't signed into any other devices."))),v=Be()(this.props.className,"mx_DevicesPanel");return o.a.createElement("div",{className:v},o.a.createElement("div",{className:"mx_DevicesPanel_header"},o.a.createElement("div",{className:"mx_DevicesPanel_header_title"},Object(c.a)("This device"))),this.renderDevice(n),b)}}var Et=a(120),yt=a(110);class _t extends o.a.Component{constructor(){super(...arguments),i()(this,"onConfirm",()=>{this.props.onFinished(!0)}),i()(this,"onDecline",()=>{this.props.onFinished(!1)})}render(){return o.a.createElement(A.a,{className:"mx_ConfirmDestroyCrossSigningDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Destroy cross-signing keys?")},o.a.createElement("div",{className:"mx_ConfirmDestroyCrossSigningDialog_content"},o.a.createElement("p",null,Object(c.a)("Deleting cross-signing keys is permanent. Anyone you have verified with will see security alerts. You almost certainly don't want to do this, unless you've lost every device you can cross-sign from."))),o.a.createElement(yt.a,{primaryButton:Object(c.a)("Clear cross-signing keys"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this.onDecline}))}}class St extends o.a.PureComponent{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"onAccountData",e=>{const t=e.getType();(t.startsWith("m.cross_signing")||t.startsWith("m.secret_storage"))&&this.getUpdatedStatus()}),i()(this,"onBootstrapClick",()=>{this.state.crossSigningPrivateKeysInStorage?g.a.createTrackedDialog("Verify session","Verify session",pt.a,{},null,!1,!0):Object(rt.b)()}),i()(this,"onStatusChanged",()=>{this.getUpdatedStatus()}),i()(this,"bootstrapCrossSigning",async e=>{let{forceReset:t=!1}=e;this.setState({error:void 0});try{const e=m.a.get();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:a}=g.a.createTrackedDialog("Cross-signing keys dialog","",G.a,{title:Object(c.a)("Setting up keys"),matrixClient:e,makeRequest:t}),[n]=await a;if(!n)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:t})}catch(e){this.setState({error:e}),d.a.error("Error bootstrapping cross-signing",e)}this.unmounted||this.getUpdatedStatus()}),i()(this,"resetCrossSigning",()=>{g.a.createDialog(_t,{onFinished:e=>{e&&this.bootstrapCrossSigning({forceReset:!0})}})}),this.state={}}componentDidMount(){const e=m.a.get();e.on(Et.ClientEvent.AccountData,this.onAccountData),e.on(it.b.UserTrustStatusChanged,this.onStatusChanged),e.on(it.b.KeysChanged,this.onStatusChanged),this.getUpdatedStatus()}componentWillUnmount(){this.unmounted=!0;const e=m.a.get();e&&(e.removeListener(Et.ClientEvent.AccountData,this.onAccountData),e.removeListener(it.b.UserTrustStatusChanged,this.onStatusChanged),e.removeListener(it.b.KeysChanged,this.onStatusChanged))}async getUpdatedStatus(){const e=m.a.get(),t=e.getCrossSigningCacheCallbacks(),a=e.crypto.crossSigningInfo,n=e.crypto.secretStorage,i=Boolean(a.getId()),s=Boolean(await a.isStoredInSecretStorage(n)),o=!(!t||!await t.getCrossSigningKeyCache("master")),r=!(!t||!await t.getCrossSigningKeyCache("self_signing")),c=!(!t||!await t.getCrossSigningKeyCache("user_signing")),l=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),d=await e.isCrossSigningReady();this.setState({crossSigningPublicKeysOnDevice:i,crossSigningPrivateKeysInStorage:s,masterPrivateKeyCached:o,selfSigningPrivateKeyCached:r,userSigningPrivateKeyCached:c,homeserverSupportsCrossSigning:l,crossSigningReady:d})}render(){const{error:e,crossSigningPublicKeysOnDevice:t,crossSigningPrivateKeysInStorage:a,masterPrivateKeyCached:n,selfSigningPrivateKeyCached:i,userSigningPrivateKeyCached:s,homeserverSupportsCrossSigning:r,crossSigningReady:l}=this.state;let d,m;e&&(d=o.a.createElement("div",{className:"error"},e.toString())),m=void 0===r?o.a.createElement(R.a,null):r?l&&a?o.a.createElement("p",null,"✅ ",Object(c.a)("Cross-signing is ready for use.")):l&&!a?o.a.createElement("p",null,"⚠️ ",Object(c.a)("Cross-signing is ready but keys are not backed up.")):a?o.a.createElement("p",null,Object(c.a)("Your account has a cross-signing identity in secret storage, but it is not yet trusted by this session.")):o.a.createElement("p",null,Object(c.a)("Cross-signing is not set up.")):o.a.createElement("p",null,Object(c.a)("Your homeserver does not support cross-signing."));const h=t||a||n||i||s,u=[];if(!(t&&a&&n&&i&&s)&&r){let e=Object(c.a)("Set up Secure Backup");a&&(e=Object(c.a)("Verify this session")),u.push(o.a.createElement(f.a,{key:"setup",kind:"primary",onClick:this.onBootstrapClick},e))}let p;return h&&u.push(o.a.createElement(f.a,{key:"reset",kind:"danger",onClick:this.resetCrossSigning},Object(c.a)("Reset"))),u.length&&(p=o.a.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},u)),o.a.createElement("div",null,m,o.a.createElement("details",null,o.a.createElement("summary",null,Object(c.a)("Advanced")),o.a.createElement("table",{className:"mx_CrossSigningPanel_statusList"},o.a.createElement("tbody",null,o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Cross-signing public keys:")),o.a.createElement("td",null,t?Object(c.a)("in memory"):Object(c.a)("not found"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Cross-signing private keys:")),o.a.createElement("td",null,a?Object(c.a)("in secret storage"):Object(c.a)("not found in storage"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Master private key:")),o.a.createElement("td",null,n?Object(c.a)("cached locally"):Object(c.a)("not found locally"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Self signing private key:")),o.a.createElement("td",null,i?Object(c.a)("cached locally"):Object(c.a)("not found locally"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("User signing private key:")),o.a.createElement("td",null,s?Object(c.a)("cached locally"):Object(c.a)("not found locally"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Homeserver feature support:")),o.a.createElement("td",null,r?Object(c.a)("exists"):Object(c.a)("not found")))))),d,p)}}var wt=a(274);class Ct extends o.a.PureComponent{render(){return o.a.createElement(A.a,{hasCancel:!0,onFinished:this.props.onFinished.bind(null,!1),title:Object(c.a)("Reset event store?")},o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You most likely do not want to reset your event index store"),o.a.createElement("br",null),Object(c.a)("If you do, please note that none of your messages will be deleted, but the search experience might be degraded for a few moments whilst the index is recreated"))),o.a.createElement(yt.a,{primaryButton:Object(c.a)("Reset event store"),onPrimaryButtonClick:this.props.onFinished.bind(null,!0),primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this.props.onFinished.bind(null,!1)}))}}class Ot extends o.a.Component{constructor(e){super(e),i()(this,"updateCurrentRoom",async e=>{const t=wt.a.get();let a;try{a=await t.getStats()}catch{return}this.setState({eventIndexSize:a.size,roomCount:a.roomCount})}),i()(this,"onManage",async()=>{g.a.createTrackedDialogAsync("Message search","Message search",a.e(32).then(a.bind(null,1503)),{onFinished:()=>{}},null,!1,!0)}),i()(this,"onEnable",async()=>{this.setState({enabling:!0}),await wt.a.initEventIndex(),await wt.a.get().addInitialCheckpoints(),wt.a.get().startCrawler(),await C.b.setValue("enableEventIndexing",null,z.a.DEVICE,!0),await this.updateState()}),i()(this,"confirmEventStoreReset",()=>{const{close:e}=g.a.createDialog(Ct,{onFinished:async t=>{t&&(await C.b.setValue("enableEventIndexing",null,z.a.DEVICE,!1),await wt.a.deleteEventIndex(),await this.onEnable(),e())}})}),this.state={enabling:!1,eventIndexSize:0,roomCount:0,eventIndexingEnabled:C.b.getValueAt(z.a.DEVICE,"enableEventIndexing")}}componentWillUnmount(){const e=wt.a.get();null!==e&&e.removeListener("changedCheckpoint",this.updateCurrentRoom)}componentDidMount(){this.updateState()}async updateState(){const e=wt.a.get(),t=C.b.getValueAt(z.a.DEVICE,"enableEventIndexing");let a=0,n=0;if(null!==e){e.on("changedCheckpoint",this.updateCurrentRoom);try{const t=await e.getStats();a=t.size,n=t.roomCount}catch{}}this.setState({enabling:!1,eventIndexSize:a,roomCount:n,eventIndexingEnabled:t})}render(){let e=null;const t=u.b.get().brand;if(null!==wt.a.get())e=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Securely cache encrypted messages locally for them to appear in search results, using %(size)s to store messages from %(rooms)s rooms.",{size:Object(dt.a)(this.state.eventIndexSize,0),count:this.state.roomCount,rooms:Object(dt.d)(this.state.roomCount)})),o.a.createElement("div",null,o.a.createElement(f.a,{kind:"primary",onClick:this.onManage},Object(c.a)("Manage"))));else if(!this.state.eventIndexingEnabled&&wt.a.supportIsInstalled())e=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Securely cache encrypted messages locally for them to appear in search results.")),o.a.createElement("div",null,o.a.createElement(f.a,{kind:"primary",disabled:this.state.enabling,onClick:this.onEnable},Object(c.a)("Enable")),this.state.enabling?o.a.createElement(we.a,null):o.a.createElement("div",null)));else if(wt.a.platformHasSupport()&&!wt.a.supportIsInstalled()){const a="https://github.com/vector-im/element-desktop/blob/develop/docs/native-node-modules.md#adding-seshat-for-search-in-e2e-encrypted-rooms";e=o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s is missing some components required for securely caching encrypted messages locally. If you'd like to experiment with this feature, build a custom %(brand)s Desktop with <nativeLink>search components added</nativeLink>.",{brand:t},{nativeLink:e=>o.a.createElement("a",{href:a,target:"_blank",rel:"noreferrer noopener"},e)}))}else e=wt.a.platformHasSupport()?o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("p",null,this.state.enabling?o.a.createElement(we.a,null):Object(c.a)("Message search initialisation failed")),wt.a.error&&o.a.createElement("details",null,o.a.createElement("summary",null,Object(c.a)("Advanced")),o.a.createElement("code",null,wt.a.error.message),o.a.createElement("p",null,o.a.createElement(f.a,{key:"delete",kind:"danger",onClick:this.confirmEventStoreReset},Object(c.a)("Reset"))))):o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s can't securely cache encrypted messages locally while running in a web browser. Use <desktopLink>%(brand)s Desktop</desktopLink> for encrypted messages to appear in search results.",{brand:t},{desktopLink:e=>o.a.createElement("a",{href:"https://element.io/get-started",target:"_blank",rel:"noreferrer noopener"},e)}));return e}}var kt=a(173),xt=a(832),Rt=a(264);class jt extends o.a.Component{constructor(){super(...arguments),i()(this,"onUnignoreClicked",()=>{this.props.onUnignored(this.props.userId)})}render(){const e="mx_SecurityUserSettingsTab_ignoredUser_"+this.props.userId;return o.a.createElement("div",{className:"mx_SecurityUserSettingsTab_ignoredUser"},o.a.createElement(f.a,{onClick:this.onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},Object(c.a)("Unignore")),o.a.createElement("span",{id:e},this.props.userId))}}class It extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"onAction",e=>{let{action:t}=e;if("ignore_state_changed"===t){const e=m.a.get().getIgnoredUsers(),t=this.state.waitingUnignored.filter(t=>e.includes(t));this.setState({ignoredUserIds:e,waitingUnignored:t})}}),i()(this,"updateAnalytics",e=>{e?N.a.enable():N.a.disable()}),i()(this,"onMyMembership",(e,t)=>{e.isSpaceRoom()||("invite"===t?this.addInvitedRoom(e):this.state.invitedRoomIds.has(e.roomId)&&this.removeInvitedRoom(e.roomId))}),i()(this,"addInvitedRoom",e=>{this.setState(t=>{let{invitedRoomIds:a}=t;return{invitedRoomIds:new Set(a).add(e.roomId)}})}),i()(this,"removeInvitedRoom",e=>{this.setState(t=>{let{invitedRoomIds:a}=t;const n=new Set(a);return n.delete(e),{invitedRoomIds:n}})}),i()(this,"onUserUnignored",async e=>{const{ignoredUserIds:t,waitingUnignored:a}=this.state,n=t.filter(e=>!a.includes(e)),i=n.indexOf(e);-1!==i&&(n.splice(i,1),this.setState(t=>{let{waitingUnignored:a}=t;return{waitingUnignored:[...a,e]}}),m.a.get().setIgnoredUsers(n))}),i()(this,"getInvitedRooms",()=>m.a.get().getRooms().filter(e=>e.hasMembershipState(m.a.get().getUserId(),"invite"))),i()(this,"manageInvites",async e=>{this.setState({managingInvites:!0});const t=Array.from(this.state.invitedRoomIds),a=m.a.get(),n=e?a.joinRoom.bind(a):a.leave.bind(a);for(let e=0;e<t.length;e++){const a=t[e];await n(a).then(()=>{this.removeInvitedRoom(a)},async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await Object(at.G)(t.retry_after_ms||2500),e--):d.a.warn(t)})}this.setState({managingInvites:!1})}),i()(this,"onAcceptAllInvitesClicked",()=>{this.manageInvites(!0)}),i()(this,"onRejectAllInvitesClicked",()=>{this.manageInvites(!1)});const t=new Set(this.getInvitedRooms().map(e=>e.roomId));this.state={ignoredUserIds:m.a.get().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomIds:t}}componentDidMount(){this.dispatcherRef=U.a.register(this.onAction),m.a.get().on(nt.c.MyMembership,this.onMyMembership)}componentWillUnmount(){U.a.unregister(this.dispatcherRef),m.a.get().removeListener(nt.c.MyMembership,this.onMyMembership)}renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state,a=null!=t&&t.length?t.map(t=>o.a.createElement(jt,{userId:t,onUnignored:this.onUserUnignored,key:t,inProgress:e.includes(t)})):Object(c.a)("You have no ignored users.");return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Ignored users")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},a))}renderManageInvites(){const{invitedRoomIds:e}=this.state;return 0===e.size?null:o.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityUserSettingsTab_bulkOptions"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Bulk options")),o.a.createElement(f.a,{onClick:this.onAcceptAllInvitesClicked,kind:"primary",disabled:this.state.managingInvites},Object(c.a)("Accept all %(invitedRooms)s invites",{invitedRooms:e.size})),o.a.createElement(f.a,{onClick:this.onRejectAllInvitesClicked,kind:"danger",disabled:this.state.managingInvites},Object(c.a)("Reject all %(invitedRooms)s invites",{invitedRooms:e.size})),this.state.managingInvites?o.a.createElement(we.a,null):o.a.createElement("div",null))}render(){const e=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Secure Backup")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement(ct,null))),t=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Message search")),o.a.createElement(Ot,null)),a=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Cross-signing")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement(St,null)));let n,i,s;if(Object(Rt.c)()||(n=o.a.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},Object(c.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."))),N.a.canEnable()||kt.a.instance.isEnabled()){const e=()=>{kt.a.instance.isEnabled()?Object(xt.b)({primaryButton:Object(c.a)("Okay"),hasCancel:!1}):N.a.showDetailsModal()};i=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Privacy")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Analytics")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("p",null,Object(c.a)("Share anonymous data to help us identify issues. Nothing personal. No third parties.")),o.a.createElement("p",null,o.a.createElement(f.a,{className:"mx_SettingsTab_linkBtn",onClick:e},Object(c.a)("Learn more")))),kt.a.instance.isEnabled()?o.a.createElement(Me.a,{name:"pseudonymousAnalyticsOptIn",level:z.a.ACCOUNT,onChange:this.updateAnalytics}):o.a.createElement(Me.a,{name:"analyticsOptIn",level:z.a.DEVICE,onChange:this.updateAnalytics})))}if(C.b.getValue(K.b.AdvancedSettings)){const e=this.renderIgnoredUsers(),t=this.renderManageInvites(),a=C.b.isEnabled("e2ee.manuallyVerifyAllSessions")?o.a.createElement(lt,null):null;(e||t||a)&&(s=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Advanced")),o.a.createElement("div",{className:"mx_SettingsTab_section"},e,t,a)))}return o.a.createElement("div",{className:"mx_SettingsTab mx_SecurityUserSettingsTab"},n,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Where you're signed in")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",null,Object(c.a)("Manage your signed-in devices below. A device's name is visible to people you communicate with.")),o.a.createElement(ft,null)),o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Encryption")),o.a.createElement("div",{className:"mx_SettingsTab_section"},e,t,a,o.a.createElement(mt,null)),i,s)}}var Tt=a(202);class Nt{static encodeActions(e){const t=e.notify,a=e.sound,n=e.highlight;if(t){const e=[Tt.d.Notify];return a&&e.push({set_tweak:"sound",value:a}),n?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[Tt.d.DontNotify]}static decodeActions(e){let t=!1,a=null,n=!1;for(let i=0;i<e.length;++i){const s=e[i];if(s===Tt.d.Notify)t=!0;else if(s===Tt.d.DontNotify)t=!1;else{if("object"!=typeof s)return null;if("sound"===s.set_tweak)a=s.value;else{if("highlight"!==s.set_tweak)return null;n=s.value}}}void 0===n&&(n=!0);const i={notify:t,highlight:n};return null!==a&&(i.sound=a),i}}const Pt=Nt.encodeActions;class Mt{}let Dt;i()(Mt,"ACTION_NOTIFY",Pt({notify:!0})),i()(Mt,"ACTION_NOTIFY_DEFAULT_SOUND",Pt({notify:!0,sound:"default"})),i()(Mt,"ACTION_NOTIFY_RING_SOUND",Pt({notify:!0,sound:"ring"})),i()(Mt,"ACTION_HIGHLIGHT",Pt({notify:!0,highlight:!0})),i()(Mt,"ACTION_HIGHLIGHT_DEFAULT_SOUND",Pt({notify:!0,sound:"default",highlight:!0})),i()(Mt,"ACTION_DONT_NOTIFY",Pt({notify:!1})),i()(Mt,"ACTION_DISABLED",null),function(e){e.Off="off",e.On="on",e.Loud="loud"}(Dt||(Dt={}));class At{static actionsFor(e){return e===Dt.On?Mt.ACTION_NOTIFY:e===Dt.Loud?Mt.ACTION_HIGHLIGHT_DEFAULT_SOUND:void 0}static contentRuleVectorStateKind(e){const t=Nt.decodeActions(e.actions);if(!t)return null;let a=0;t.sound&&a++,t.highlight&&a++;let n=null;switch(a){case 0:n=Dt.On;break;case 2:n=Dt.Loud}return n}}i()(At,"OFF",Dt.Off),i()(At,"ON",Dt.On),i()(At,"LOUD",Dt.Loud),i()(At,"states",Dt);class Ut{constructor(e){i()(this,"description",void 0),i()(this,"vectorStateToActions",void 0),this.description=e.description,this.vectorStateToActions=e.vectorStateToActions}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const a in At.states){const n=At.states[a],i=this.vectorStateToActions[n];if(i){if(t&&JSON.stringify(Nt.decodeActions(e.actions))===JSON.stringify(Nt.decodeActions(i)))return n}else if(!t)return n}d.a.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: `+JSON.stringify(this.vectorStateToActions))}}const Lt={".m.rule.contains_display_name":new Ut({description:Object(c.c)("Messages containing my display name"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_HIGHLIGHT_DEFAULT_SOUND,[Dt.Off]:Mt.ACTION_DISABLED}}),".m.rule.contains_user_name":new Ut({description:Object(c.c)("Messages containing my username"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_HIGHLIGHT_DEFAULT_SOUND,[Dt.Off]:Mt.ACTION_DISABLED}}),".m.rule.roomnotif":new Ut({description:Object(c.c)("Messages containing @room"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_HIGHLIGHT,[Dt.Off]:Mt.ACTION_DISABLED}}),".m.rule.room_one_to_one":new Ut({description:Object(c.c)("Messages in one-to-one chats"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_NOTIFY_DEFAULT_SOUND,[Dt.Off]:Mt.ACTION_DONT_NOTIFY}}),".m.rule.encrypted_room_one_to_one":new Ut({description:Object(c.c)("Encrypted messages in one-to-one chats"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_NOTIFY_DEFAULT_SOUND,[Dt.Off]:Mt.ACTION_DONT_NOTIFY}}),".m.rule.message":new Ut({description:Object(c.c)("Messages in group chats"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_NOTIFY_DEFAULT_SOUND,[Dt.Off]:Mt.ACTION_DONT_NOTIFY}}),".m.rule.encrypted":new Ut({description:Object(c.c)("Encrypted messages in group chats"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_NOTIFY_DEFAULT_SOUND,[Dt.Off]:Mt.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new Ut({description:Object(c.c)("When I'm invited to a room"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_NOTIFY_DEFAULT_SOUND,[Dt.Off]:Mt.ACTION_DISABLED}}),".m.rule.call":new Ut({description:Object(c.c)("Call invitation"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_NOTIFY_RING_SOUND,[Dt.Off]:Mt.ACTION_DISABLED}}),".m.rule.suppress_notices":new Ut({description:Object(c.c)("Messages sent by bot"),vectorStateToActions:{[Dt.On]:Mt.ACTION_DISABLED,[Dt.Loud]:Mt.ACTION_NOTIFY_DEFAULT_SOUND,[Dt.Off]:Mt.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new Ut({description:Object(c.c)("When rooms are upgraded"),vectorStateToActions:{[Dt.On]:Mt.ACTION_NOTIFY,[Dt.Loud]:Mt.ACTION_HIGHLIGHT,[Dt.Off]:Mt.ACTION_DISABLED}})};class Ft{static parseContentRules(e){const t=Ft.categoriseContentRules(e);return t.loud.length?{vectorState:Dt.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:Dt.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:Dt.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:Dt.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:Dt.On,rules:[],externalRules:t.other}}static categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const a in e.global)for(let n=0;n<Object.keys(e.global[a]).length;++n){const i=e.global[a][n];if("."!==i.rule_id[0]&&a===Tt.e.ContentSpecific)switch(i.kind=a,At.contentRuleVectorStateKind(i)){case Dt.On:i.enabled?t.on.push(i):t.on_but_disabled.push(i);break;case Dt.Loud:i.enabled?t.loud.push(i):t.loud_but_disabled.push(i);break;default:t.other.push(i)}}return t}}var Bt=a(831);const Vt=e=>{let{icon:t,label:a,onDeleteClick:n,disabled:i=!1}=e;return o.a.createElement("div",{className:"mx_Tag"},null==t?void 0:t(),a,n&&o.a.createElement(f.a,{className:"mx_Tag_delete",onClick:n,disabled:i},o.a.createElement(Bt.a,null)))};class Wt extends o.a.PureComponent{constructor(e){super(e),i()(this,"onInputChange",e=>{this.setState({newTag:e.target.value})}),i()(this,"onAdd",e=>{e.preventDefault(),this.state.newTag&&(this.props.onAdd(this.state.newTag),this.setState({newTag:""}))}),this.state={newTag:""}}onRemove(e){this.props.onRemove(e)}render(){return o.a.createElement("div",{className:"mx_TagComposer"},o.a.createElement("form",{className:"mx_TagComposer_input",onSubmit:this.onAdd},o.a.createElement(h.a,{value:this.state.newTag,onChange:this.onInputChange,label:this.props.label||Object(c.a)("Keyword"),placeholder:this.props.placeholder||Object(c.a)("New keyword"),disabled:this.props.disabled,autoComplete:"off"}),o.a.createElement(f.a,{onClick:this.onAdd,kind:"primary",disabled:this.props.disabled},Object(c.a)("Add"))),o.a.createElement("div",{className:"mx_TagComposer_tags"},this.props.tags.map((e,t)=>o.a.createElement(Vt,{label:e,key:e,onDeleteClick:this.onRemove.bind(this,e),disabled:this.props.disabled}))))}}var Ht,zt,Kt=a(121);function qt(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Gt(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?qt(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):qt(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}!function(e){e.Loading="loading",e.Ready="ready",e.Persisting="persisting",e.Error="error"}(Ht||(Ht={})),function(e){e.Master="master",e.VectorGlobal="vector_global",e.VectorMentions="vector_mentions",e.VectorOther="vector_other",e.Other="other"}(zt||(zt={}));const Yt=zt.VectorMentions,Jt=[Tt.f.DM,Tt.f.EncryptedDM,Tt.f.Message,Tt.f.EncryptedMessage,Tt.f.ContainsDisplayName,Tt.f.ContainsUserName,Tt.f.AtRoomNotification,Tt.f.InviteToSelf,Tt.f.IncomingCall,Tt.f.SuppressNotices,Tt.f.Tombstone];class $t extends o.a.PureComponent{constructor(e){var t;super(e),t=this,i()(this,"settingWatchers",void 0),i()(this,"onMasterRuleChanged",async e=>{this.setState({phase:Ht.Persisting});try{const t=this.state.masterPushRule;await m.a.get().setPushRuleEnabled("global",t.kind,t.rule_id,!e),await this.refreshFromServer()}catch(e){this.setState({phase:Ht.Error}),d.a.error("Error updating master push rule:",e),this.showSaveError()}}),i()(this,"onEmailNotificationsChanged",async(e,t)=>{this.setState({phase:Ht.Persisting});try{if(t)await m.a.get().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:{brand:u.b.get().brand},append:!0});else{const t=this.state.pushers.find(t=>"email"===t.kind&&t.pushkey===e);t.kind=null,await m.a.get().setPusher(t)}await this.refreshFromServer()}catch(e){this.setState({phase:Ht.Error}),d.a.error("Error updating email pusher:",e),this.showSaveError()}}),i()(this,"onDesktopNotificationsChanged",async e=>{await C.b.setValue("notificationsEnabled",null,z.a.DEVICE,e)}),i()(this,"onDesktopShowBodyChanged",async e=>{await C.b.setValue("notificationBodyEnabled",null,z.a.DEVICE,e)}),i()(this,"onAudioNotificationsChanged",async e=>{await C.b.setValue("audioNotificationsEnabled",null,z.a.DEVICE,e)}),i()(this,"onRadioChecked",async(e,t)=>{this.setState({phase:Ht.Persisting});try{const a=m.a.get();if("_keywords"===e.ruleId)for(const e of this.state.vectorKeywordRuleInfo.rules){let n,i;t===Dt.On?(1!==e.actions.length&&(i=At.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===Dt.Off&&(n=!0)):t===Dt.Loud?(3!==e.actions.length&&(i=At.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===Dt.Off&&(n=!0)):n=!1,i&&await a.setPushRuleActions("global",e.kind,e.rule_id,i),void 0!==n&&await a.setPushRuleEnabled("global",e.kind,e.rule_id,n)}else{const n=Lt[e.ruleId].vectorStateToActions[t];n?(await a.setPushRuleActions("global",e.rule.kind,e.rule.rule_id,n),await a.setPushRuleEnabled("global",e.rule.kind,e.rule.rule_id,!0)):await a.setPushRuleEnabled("global",e.rule.kind,e.rule.rule_id,!1)}await this.refreshFromServer()}catch(e){this.setState({phase:Ht.Error}),d.a.error("Error updating push rule:",e),this.showSaveError()}}),i()(this,"onClearNotificationsClicked",()=>{m.a.get().getRooms().forEach(e=>{if(e.getUnreadNotificationCount()>0){const t=e.getLiveTimeline().getEvents();t.length&&m.a.get().sendReadReceipt(t[t.length-1])}})}),i()(this,"onKeywordAdd",e=>{const t=Object(ve.a)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:Ht.Persisting,vectorKeywordRuleInfo:Gt(Gt({},this.state.vectorKeywordRuleInfo),{},{rules:[...this.state.vectorKeywordRuleInfo.rules,{pattern:e}]})},async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map(e=>e.pattern),t)})}),i()(this,"onKeywordRemove",e=>{const t=Object(ve.a)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:Ht.Persisting,vectorKeywordRuleInfo:Gt(Gt({},this.state.vectorKeywordRuleInfo),{},{rules:this.state.vectorKeywordRuleInfo.rules.filter(t=>t.pattern!==e)})},async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map(e=>e.pattern),t)})}),this.state={phase:Ht.Loading,desktopNotifications:C.b.getValue("notificationsEnabled"),desktopShowBody:C.b.getValue("notificationBodyEnabled"),audioNotifications:C.b.getValue("audioNotificationsEnabled")},this.settingWatchers=[C.b.watchSetting("notificationsEnabled",null,(function(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];let[,,,,i]=a;return t.setState({desktopNotifications:i})})),C.b.watchSetting("notificationBodyEnabled",null,(function(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];let[,,,,i]=a;return t.setState({desktopShowBody:i})})),C.b.watchSetting("audioNotificationsEnabled",null,(function(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];let[,,,,i]=a;return t.setState({audioNotifications:i})}))]}get isInhibited(){var e;return null===(e=this.state.masterPushRule)||void 0===e?void 0:e.enabled}componentDidMount(){this.refreshFromServer()}componentWillUnmount(){this.settingWatchers.forEach(e=>C.b.unwatchSetting(e))}async refreshFromServer(){try{const e=(await Promise.all([this.refreshRules(),this.refreshPushers(),this.refreshThreepids()])).reduce((e,t)=>Object.assign(t,e),{});this.setState(Gt(Gt({},e),{},{phase:Ht.Ready}))}catch(e){d.a.error("Error setting up notifications for settings: ",e),this.setState({phase:Ht.Error})}}async refreshRules(){const e=await m.a.get().getPushRules(),t={[Tt.f.Master]:zt.Master,[Tt.f.DM]:zt.VectorGlobal,[Tt.f.EncryptedDM]:zt.VectorGlobal,[Tt.f.Message]:zt.VectorGlobal,[Tt.f.EncryptedMessage]:zt.VectorGlobal,[Tt.f.ContainsDisplayName]:zt.VectorMentions,[Tt.f.ContainsUserName]:zt.VectorMentions,[Tt.f.AtRoomNotification]:zt.VectorMentions,[Tt.f.InviteToSelf]:zt.VectorOther,[Tt.f.IncomingCall]:zt.VectorOther,[Tt.f.SuppressNotices]:zt.VectorOther,[Tt.f.Tombstone]:zt.VectorOther},a={[zt.Master]:[],[zt.VectorGlobal]:[],[zt.VectorMentions]:[],[zt.VectorOther]:[],[zt.Other]:[]};for(const i in e.global){const s=i;for(const i of e.global[s]){var n;const e=Object.assign(i,{kind:s}),o=null!==(n=t[e.rule_id])&&void 0!==n?n:zt.Other;"."===e.rule_id[0]&&a[o].push(e)}}const i={};if(!(a.master.length>0))throw new Error("Failed to locate a master push rule");i.masterPushRule=a.master[0],i.vectorKeywordRuleInfo=Ft.parseContentRules(e),i.vectorPushRules={};const s=[zt.VectorGlobal,zt.VectorMentions,zt.VectorOther];for(const e of s){i.vectorPushRules[e]=[];for(const t of a[e]){const a=Lt[t.rule_id],n=a.ruleToVectorState(t);i.vectorPushRules[e].push({ruleId:t.rule_id,rule:t,vectorState:n,description:Object(c.a)(a.description)})}i.vectorPushRules[e].sort((e,t)=>{let a=Jt.indexOf(e.ruleId),n=Jt.indexOf(t.ruleId);return a<0&&(a=Jt.length),n<0&&(n=Jt.length),a-n}),e===Yt&&i.vectorPushRules[e].push({ruleId:"_keywords",description:Object(c.a)("Messages containing keywords"),vectorState:i.vectorKeywordRuleInfo.vectorState})}return i}refreshPushers(){return m.a.get().getPushers()}refreshThreepids(){return m.a.get().getThreePids()}showSaveError(){g.a.createTrackedDialog("Error saving notification preferences","",b.a,{title:Object(c.a)("Error saving notification preferences"),description:Object(c.a)("An error occurred whilst saving your notification preferences.")})}async setKeywords(e,t){try{e=Array.from(new Set(e)).filter(e=>!!e);const a=Array.from(new Set(t.map(e=>e.pattern))).filter(e=>!!e),n=Object(Kt.a)(a,e);for(const e of n.removed)for(const a of t.filter(t=>t.pattern===e))await m.a.get().deletePushRule("global",a.kind,a.rule_id);let i=this.state.vectorKeywordRuleInfo.vectorState;i===Dt.Off&&(i=t.length?At.contentRuleVectorStateKind(t[0]):Dt.On);const s=Tt.e.ContentSpecific;for(const e of n.added)await m.a.get().addPushRule("global",s,e,{actions:At.actionsFor(i),pattern:e}),i===Dt.Off&&await m.a.get().setPushRuleEnabled("global",s,e,!1);await this.refreshFromServer()}catch(e){this.setState({phase:Ht.Error}),d.a.error("Error updating keyword push rules:",e),this.showSaveError()}}renderTopSection(){const e=o.a.createElement(Ne.a,{"data-test-id":"notif-master-switch",value:!this.isInhibited,label:Object(c.a)("Enable for this account"),onChange:this.onMasterRuleChanged,disabled:this.state.phase===Ht.Persisting});if(this.isInhibited)return e;const t=(this.state.threepids||[]).filter(e=>e.medium===q.Email).map(e=>o.a.createElement(Ne.a,{"data-test-id":"notif-email-switch",key:e.address,value:this.state.pushers.some(t=>"email"===t.kind&&t.pushkey===e.address),label:Object(c.a)("Enable email notifications for %(email)s",{email:e.address}),onChange:this.onEmailNotificationsChanged.bind(this,e.address),disabled:this.state.phase===Ht.Persisting}));return o.a.createElement(o.a.Fragment,null,e,o.a.createElement(Ne.a,{"data-test-id":"notif-setting-notificationsEnabled",value:this.state.desktopNotifications,onChange:this.onDesktopNotificationsChanged,label:Object(c.a)("Enable desktop notifications for this session"),disabled:this.state.phase===Ht.Persisting}),o.a.createElement(Ne.a,{"data-test-id":"notif-setting-notificationBodyEnabled",value:this.state.desktopShowBody,onChange:this.onDesktopShowBodyChanged,label:Object(c.a)("Show message in desktop notification"),disabled:this.state.phase===Ht.Persisting}),o.a.createElement(Ne.a,{"data-test-id":"notif-setting-audioNotificationsEnabled",value:this.state.audioNotifications,onChange:this.onAudioNotificationsChanged,label:Object(c.a)("Enable audible notifications for this session"),disabled:this.state.phase===Ht.Persisting}),t)}renderCategory(e){if(e!==zt.VectorOther&&this.isInhibited)return null;let t,a;if(e===zt.VectorOther&&m.a.get().getRooms().some(e=>e.getUnreadNotificationCount()>0)&&(t=o.a.createElement(f.a,{onClick:this.onClearNotificationsClicked,kind:"danger",className:"mx_UserNotifSettings_clearNotifsButton"},Object(c.a)("Clear notifications"))),e===zt.VectorOther&&this.isInhibited)return t?o.a.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.a.createElement("div",null,Object(c.a)("Other")),t):null;var n;e===zt.VectorMentions&&(a=o.a.createElement(Wt,{tags:null===(n=this.state.vectorKeywordRuleInfo)||void 0===n?void 0:n.rules.map(e=>e.pattern),onAdd:this.onKeywordAdd,onRemove:this.onKeywordRemove,disabled:this.state.phase===Ht.Persisting,label:Object(c.a)("Keyword"),placeholder:Object(c.a)("New keyword")}));const i={[Dt.On]:Object(c.a)("On"),[Dt.Off]:Object(c.a)("Off"),[Dt.Loud]:Object(c.a)("Noisy")},s=(e,t)=>o.a.createElement(qe.a,{key:e.ruleId+t,name:e.ruleId,checked:e.vectorState===t,onChange:this.onRadioChecked.bind(this,e,t),disabled:this.state.phase===Ht.Persisting,"aria-label":i[t]}),r=this.state.vectorPushRules[e].map(t=>o.a.createElement("fieldset",{key:e+t.ruleId,"data-test-id":e+t.ruleId,className:"mx_UserNotifSettings_gridRowContainer"},o.a.createElement("legend",{className:"mx_UserNotifSettings_gridRowLabel"},t.description),s(t,Dt.Off),s(t,Dt.On),s(t,Dt.Loud)));let l;switch(e){case zt.VectorGlobal:l=Object(c.a)("Global");break;case zt.VectorMentions:l=Object(c.a)("Mentions & keywords");break;case zt.VectorOther:l=Object(c.a)("Other");break;default:throw new Error("Developer error: Unnamed notifications section: "+e)}return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{"data-test-id":"notif-section-"+e,className:"mx_UserNotifSettings_grid"},o.a.createElement("span",{className:"mx_UserNotifSettings_gridRowLabel mx_UserNotifSettings_gridRowHeading"},l),o.a.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},i[Dt.Off]),o.a.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},i[Dt.On]),o.a.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},i[Dt.Loud]),r),t,a)}renderTargets(){if(this.isInhibited)return null;const e=this.state.pushers.map(e=>o.a.createElement("tr",{key:e.kind+e.pushkey},o.a.createElement("td",null,e.app_display_name),o.a.createElement("td",null,e.device_display_name)));return e.length?o.a.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.a.createElement("div",null,Object(c.a)("Notification targets")),o.a.createElement("table",null,o.a.createElement("tbody",null,e))):null}render(){return this.state.phase===Ht.Loading?o.a.createElement(R.a,null):this.state.phase===Ht.Error?o.a.createElement("p",{"data-test-id":"error-message"},Object(c.a)("There was an error loading your notification settings.")):o.a.createElement("div",{className:"mx_UserNotifSettings"},this.renderTopSection(),this.renderCategory(zt.VectorGlobal),this.renderCategory(zt.VectorMentions),this.renderCategory(zt.VectorOther),this.renderTargets())}}class Qt extends o.a.Component{render(){return o.a.createElement("div",{className:"mx_SettingsTab mx_NotificationUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Notifications")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement($t,null)))}}var Xt=a(155);class Zt extends o.a.Component{constructor(e){super(e),i()(this,"onAutoLaunchChange",e=>{x.a.get().setAutoLaunchEnabled(e).then(()=>this.setState({autoLaunch:e}))}),i()(this,"onWarnBeforeExitChange",e=>{x.a.get().setWarnBeforeExit(e).then(()=>this.setState({warnBeforeExit:e}))}),i()(this,"onAlwaysShowMenuBarChange",e=>{x.a.get().setAutoHideMenuBarEnabled(!e).then(()=>this.setState({alwaysShowMenuBar:e}))}),i()(this,"onMinimizeToTrayChange",e=>{x.a.get().setMinimizeToTrayEnabled(e).then(()=>this.setState({minimizeToTray:e}))}),i()(this,"onHardwareAccelerationChange",e=>{x.a.get().setHardwareAccelerationEnabled(e).then(()=>this.setState({enableHardwareAcceleration:e}))}),i()(this,"onAutocompleteDelayChange",e=>{this.setState({autocompleteDelay:e.target.value}),C.b.setValue("autocompleteDelay",null,z.a.DEVICE,e.target.value)}),i()(this,"onReadMarkerInViewThresholdMs",e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),C.b.setValue("readMarkerInViewThresholdMs",null,z.a.DEVICE,e.target.value)}),i()(this,"onReadMarkerOutOfViewThresholdMs",e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),C.b.setValue("readMarkerOutOfViewThresholdMs",null,z.a.DEVICE,e.target.value)}),i()(this,"onKeyboardShortcutsClicked",()=>{U.a.dispatch({action:L.a.ViewUserSettings,initialTabId:Xt.a.Keyboard})}),this.state={autoLaunch:!1,autoLaunchSupported:!1,warnBeforeExit:!0,warnBeforeExitSupported:!1,alwaysShowMenuBar:!0,alwaysShowMenuBarSupported:!1,minimizeToTray:!0,minimizeToTraySupported:!1,enableHardwareAcceleration:!0,togglingHardwareAccelerationSupported:!1,autocompleteDelay:C.b.getValueAt(z.a.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:C.b.getValueAt(z.a.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:C.b.getValueAt(z.a.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}async componentDidMount(){const e=x.a.get(),t=await e.supportsAutoLaunch();let a=!1;t&&(a=await e.getAutoLaunchEnabled());const n=await e.supportsWarnBeforeExit();let i=!1;n&&(i=await e.shouldWarnBeforeExit());const s=await e.supportsAutoHideMenuBar();let o=!0;s&&(o=!await e.getAutoHideMenuBarEnabled());const r=await e.supportsMinimizeToTray();let c=!0;r&&(c=await e.getMinimizeToTrayEnabled());const l=e.supportsTogglingHardwareAcceleration();let d=!0;l&&(d=await e.getHardwareAccelerationEnabled()),this.setState({autoLaunch:a,autoLaunchSupported:t,warnBeforeExit:i,warnBeforeExitSupported:n,alwaysShowMenuBarSupported:s,alwaysShowMenuBar:o,minimizeToTraySupported:r,minimizeToTray:c,togglingHardwareAccelerationSupported:l,enableHardwareAcceleration:d})}renderGroup(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:z.a.ACCOUNT;return e.map(e=>{const a=!C.b.isEnabled(e);return o.a.createElement(Me.a,{key:e,name:e,level:t,disabled:a})})}render(){let e=null;this.state.autoLaunchSupported&&(e=o.a.createElement(Ne.a,{value:this.state.autoLaunch,onChange:this.onAutoLaunchChange,label:Object(c.a)("Start automatically after system login")}));let t=null;this.state.warnBeforeExitSupported&&(t=o.a.createElement(Ne.a,{value:this.state.warnBeforeExit,onChange:this.onWarnBeforeExitChange,label:Object(c.a)("Warn before quitting")}));let a=null;this.state.alwaysShowMenuBarSupported&&(a=o.a.createElement(Ne.a,{value:this.state.alwaysShowMenuBar,onChange:this.onAlwaysShowMenuBarChange,label:Object(c.a)("Always show the window menu bar")}));let n=null;this.state.minimizeToTraySupported&&(n=o.a.createElement(Ne.a,{value:this.state.minimizeToTray,onChange:this.onMinimizeToTrayChange,label:Object(c.a)("Show tray icon and minimise window to it on close")}));let i=null;if(this.state.togglingHardwareAccelerationSupported){const e=u.b.get().brand;i=o.a.createElement(Ne.a,{value:this.state.enableHardwareAcceleration,onChange:this.onHardwareAccelerationChange,label:Object(c.a)("Enable hardware acceleration (restart %(appName)s to take effect)",{appName:e})})}return o.a.createElement("div",{className:"mx_SettingsTab mx_PreferencesUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Preferences")),!C.b.getValue("feature_breadcrumbs_v2")&&o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Room list")),this.renderGroup(Zt.ROOM_LIST_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Spaces")),this.renderGroup(Zt.SPACES_SETTINGS,z.a.ACCOUNT)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Keyboard shortcuts")),o.a.createElement("div",{className:"mx_SettingsFlag"},Object(c.a)("To view all keyboard shortcuts, <a>click here</a>.",{},{a:e=>o.a.createElement(f.a,{kind:"link",onClick:this.onKeyboardShortcutsClicked},e)})),this.renderGroup(Zt.KEYBINDINGS_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Displaying time")),this.renderGroup(Zt.TIME_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Composer")),this.renderGroup(Zt.COMPOSER_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Code blocks")),this.renderGroup(Zt.CODE_BLOCKS_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Images, GIFs and videos")),this.renderGroup(Zt.IMAGES_AND_VIDEOS_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Timeline")),this.renderGroup(Zt.TIMELINE_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("General")),this.renderGroup(Zt.GENERAL_SETTINGS),n,i,a,e,t,o.a.createElement(h.a,{label:Object(c.a)("Autocomplete delay (ms)"),type:"number",value:this.state.autocompleteDelay,onChange:this.onAutocompleteDelayChange}),o.a.createElement(h.a,{label:Object(c.a)("Read Marker lifetime (ms)"),type:"number",value:this.state.readMarkerInViewThresholdMs,onChange:this.onReadMarkerInViewThresholdMs}),o.a.createElement(h.a,{label:Object(c.a)("Read Marker off-screen lifetime (ms)"),type:"number",value:this.state.readMarkerOutOfViewThresholdMs,onChange:this.onReadMarkerOutOfViewThresholdMs})))}}i()(Zt,"ROOM_LIST_SETTINGS",["breadcrumbs"]),i()(Zt,"SPACES_SETTINGS",["Spaces.allRoomsInHome"]),i()(Zt,"KEYBINDINGS_SETTINGS",["ctrlFForSearch"]),i()(Zt,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.useMarkdown","MessageComposerInput.suggestEmoji","sendTypingNotifications","MessageComposerInput.ctrlEnterToSend","MessageComposerInput.surroundWith","MessageComposerInput.showStickersButton","MessageComposerInput.insertTrailingColon"]),i()(Zt,"TIME_SETTINGS",["showTwelveHourTimestamps","alwaysShowTimestamps"]),i()(Zt,"CODE_BLOCKS_SETTINGS",["enableSyntaxHighlightLanguageDetection","expandCodeByDefault","showCodeLineNumbers"]),i()(Zt,"IMAGES_AND_VIDEOS_SETTINGS",["urlPreviewsEnabled","autoplayGifs","autoplayVideo","showImages"]),i()(Zt,"TIMELINE_SETTINGS",["showTypingNotifications","showRedactions","showReadReceipts","showJoinLeaves","showDisplaynameChanges","showChatEffects","showAvatarChanges","Pill.shouldShowPillAvatar","TextualBody.enableBigEmoji","scrollToBottomOnMessageSent"]),i()(Zt,"GENERAL_SETTINGS",["promptBeforeInviteUnknownUsers"]);var ea=a(267);class ta extends o.a.Component{constructor(e){super(e),i()(this,"refreshMediaDevices",async e=>{this.setState({mediaDevices:await ea.c.getDevices(),[ea.b.AudioOutput]:ea.c.getAudioOutput(),[ea.b.AudioInput]:ea.c.getAudioInput(),[ea.b.VideoInput]:ea.c.getVideoInput()}),e&&e.getTracks().forEach(e=>e.stop())}),i()(this,"requestMediaPermissions",async()=>{let e,t,a;try{e={video:!0,audio:!0},t=await navigator.mediaDevices.getUserMedia(e)}catch(n){if("NotFoundError"===n.name){e={audio:!0};try{t=await navigator.mediaDevices.getUserMedia(e)}catch(e){a=e}}else a=n}if(a){d.a.log("Failed to list userMedia devices",a);const e=u.b.get().brand;g.a.createTrackedDialog("No media permissions","",b.a,{title:Object(c.a)("No media permissions"),description:Object(c.a)("You may need to manually permit %(brand)s to access your microphone/webcam",{brand:e})})}else this.refreshMediaDevices(t)}),i()(this,"setDevice",(e,t)=>{ea.c.instance.setDevice(e,t),this.setState({[t]:e})}),i()(this,"changeWebRtcMethod",e=>{m.a.get().setForceTURN(!e)}),i()(this,"changeFallbackICEServerAllowed",e=>{m.a.get().setFallbackICEServerAllowed(e)}),this.state={mediaDevices:null,[ea.b.AudioOutput]:null,[ea.b.AudioInput]:null,[ea.b.VideoInput]:null}}async componentDidMount(){await ea.c.hasAnyLabeledDevices()&&this.refreshMediaDevices()}renderDeviceOptions(e,t){return e.map(e=>o.a.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label))}renderDropdown(e,t){const a=this.state.mediaDevices[e].slice(0);if(0===a.length)return null;const n=(e=>e.some(e=>"default"===e.deviceId)?"default":(e.unshift({deviceId:"",label:Object(c.a)("Default Device")}),""))(a);return o.a.createElement(h.a,{element:"select",label:t,value:this.state[e]||n,onChange:t=>this.setDevice(t.target.value,e)},this.renderDeviceOptions(a,e))}render(){let e=null,t=null,a=null,n=null;return this.state.mediaDevices?this.state.mediaDevices&&(t=this.renderDropdown(ea.b.AudioOutput,Object(c.a)("Audio Output"))||o.a.createElement("p",null,Object(c.a)("No Audio Outputs detected")),a=this.renderDropdown(ea.b.AudioInput,Object(c.a)("Microphone"))||o.a.createElement("p",null,Object(c.a)("No Microphones detected")),n=this.renderDropdown(ea.b.VideoInput,Object(c.a)("Camera"))||o.a.createElement("p",null,Object(c.a)("No Webcams detected"))):e=o.a.createElement("div",{className:"mx_VoiceUserSettingsTab_missingMediaPermissions"},o.a.createElement("p",null,Object(c.a)("Missing media permissions, click the button below to request.")),o.a.createElement(f.a,{onClick:this.requestMediaPermissions,kind:"primary"},Object(c.a)("Request media permissions"))),o.a.createElement("div",{className:"mx_SettingsTab mx_VoiceUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Voice & Video")),o.a.createElement("div",{className:"mx_SettingsTab_section"},e,t,a,n,o.a.createElement(Me.a,{name:"VideoView.flipVideoHorizontally",level:z.a.ACCOUNT}),o.a.createElement(Me.a,{name:"webRtcAllowPeerToPeer",level:z.a.DEVICE,onChange:this.changeWebRtcMethod}),o.a.createElement(Me.a,{name:"fallbackICEServerAllowed",level:z.a.DEVICE,onChange:this.changeFallbackICEServerAllowed})))}}var aa=a(183),na=a(103),ia=a.n(na),sa=a(307),oa=a(234);const ra=["action"];function ca(){x.a.get().installUpdate()}const la=[sa.d.Ready,sa.d.Error,sa.d.NotAvailable];var da=()=>{const[e,t]=Object(s.useState)(null);Object(oa.a)(U.a,e=>{let{action:a}=e,n=ia()(e,ra);a===L.a.CheckUpdates&&t(n)});const a=e&&!la.includes(e.status);let n;return e&&(n=o.a.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case sa.d.Error:return Object(c.a)("Error encountered (%(errorDetail)s).",{errorDetail:t});case sa.d.Checking:return Object(c.a)("Checking for an update...");case sa.d.NotAvailable:return Object(c.a)("No update available.");case sa.d.Downloading:return Object(c.a)("Downloading update...");case sa.d.Ready:return Object(c.a)("New version available. <a>Update now.</a>",{},{a:e=>o.a.createElement(f.a,{kind:"link",onClick:ca},e)})}}(e.status,e.detail),a&&o.a.createElement(we.a,null))),o.a.createElement(o.a.Fragment,null,o.a.createElement(f.a,{onClick:()=>{t(null),x.a.get().startUpdateCheck()},kind:"primary",disabled:a},Object(c.a)("Check for update")),n)},ma=a(230),ha=a(295);class ua extends o.a.Component{constructor(e){super(e),i()(this,"onClearCacheAndReload",e=>{x.a.get()&&(d.a.log("Clear cache & reload clicked"),m.a.get().stopClient(),m.a.get().store.deleteAllData().then(()=>{x.a.get().reload()}))}),i()(this,"onBugReport",e=>{g.a.createTrackedDialog("Bug Report Dialog","",ma.a,{})}),i()(this,"onStartBotChat",e=>{this.props.closeSettingsFn(),Object(aa.b)({dmUserId:u.b.get("welcome_user_id"),andView:!0})}),i()(this,"getVersionTextToCopy",()=>{const{appVersion:e,olmVersion:t}=this.getVersionInfo();return`${e}\n${t}`}),i()(this,"onKeyboardShortcutsClicked",()=>{U.a.dispatch({action:L.a.ViewUserSettings,initialTabId:Xt.a.Keyboard})}),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){x.a.get().getAppVersion().then(e=>this.setState({appVersion:e})).catch(e=>{d.a.error("Error getting vector version: ",e)}),x.a.get().canSelfUpdate().then(e=>this.setState({canUpdate:e})).catch(e=>{d.a.error("Error getting self updatability: ",e)})}getVersionInfo(){const e=u.b.get().brand,t=this.state.appVersion||"unknown",a=m.a.get().olmVersion,n=a?`${a[0]}.${a[1]}.${a[2]}`:"<not-enabled>";return{appVersion:`${Object(c.a)("%(brand)s version:",{brand:e})} ${t}`,olmVersion:`${Object(c.a)("Olm version:")} ${n}`}}renderLegal(){const e=u.b.get().terms_and_conditions_links;if(!e)return null;const t=[];for(const a of e)t.push(o.a.createElement("div",{key:a.url},o.a.createElement("a",{href:a.url,rel:"noreferrer noopener",target:"_blank"},a.text)));return o.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Legal")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t))}renderCredits(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Credits")),o.a.createElement("ul",null,o.a.createElement("li",null,"The ",o.a.createElement("a",{href:"themes/element/img/backgrounds/lake.jpg",rel:"noreferrer noopener",target:"_blank"},"default cover photo")," is © ",o.a.createElement("a",{href:"https://www.flickr.com/golan",rel:"noreferrer noopener",target:"_blank"},"Jesús Roncero")," used under the terms of ",o.a.createElement("a",{href:"https://creativecommons.org/licenses/by-sa/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY-SA 4.0"),"."),o.a.createElement("li",null,"The ",o.a.createElement("a",{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"},"twemoji-colr")," font is © ",o.a.createElement("a",{href:"https://mozilla.org",rel:"noreferrer noopener",target:"_blank"},"Mozilla Foundation")," used under the terms of ",o.a.createElement("a",{href:"https://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},"Apache 2.0"),"."),o.a.createElement("li",null,"The ",o.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twemoji")," emoji art is © ",o.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twitter, Inc and other contributors")," used under the terms of ",o.a.createElement("a",{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY 4.0"),".")))}render(){const e=u.b.get().brand;let t=Object(c.a)("For help with using %(brand)s, click <a>here</a>.",{brand:e},{a:e=>o.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)});u.b.get("welcome_user_id")&&Object(c.e)().startsWith("en")&&(t=o.a.createElement("div",null,Object(c.a)("For help with using %(brand)s, click <a>here</a> or start a chat with our bot using the button below.",{brand:e},{a:e=>o.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)}),o.a.createElement("div",null,o.a.createElement(f.a,{onClick:this.onStartBotChat,kind:"primary"},Object(c.a)("Chat with %(brand)s Bot",{brand:e})))));let a,n=null;this.state.canUpdate&&(n=o.a.createElement(da,null)),u.b.get().bug_report_endpoint_url&&(a=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Bug reporting")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. "),Object(c.a)("Debug logs contain application usage data including your username, the IDs or aliases of the rooms you have visited, which UI elements you last interacted with, and the usernames of other users. They do not contain messages."),o.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},o.a.createElement(f.a,{onClick:this.onBugReport,kind:"primary"},Object(c.a)("Submit debug logs"))),Object(c.a)("To report a Matrix-related security issue, please read the Matrix.org <a>Security Disclosure Policy</a>.",{},{a:e=>o.a.createElement("a",{href:"https://matrix.org/security-disclosure-policy/",rel:"noreferrer noopener",target:"_blank"},e)}))));const{appVersion:i,olmVersion:s}=this.getVersionInfo();return o.a.createElement("div",{className:"mx_SettingsTab mx_HelpUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Help & About")),a,o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("FAQ")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t),o.a.createElement(f.a,{kind:"primary",onClick:this.onKeyboardShortcutsClicked},Object(c.a)("Keyboard Shortcuts"))),o.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Versions")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement(ha.a,{getTextToCopy:this.getVersionTextToCopy},i,o.a.createElement("br",null),s,o.a.createElement("br",null)),n)),this.renderLegal(),this.renderCredits(),o.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Advanced")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Homeserver is")," ",o.a.createElement("code",null,m.a.get().getHomeserverUrl()),o.a.createElement("br",null),Object(c.a)("Identity server is")," ",o.a.createElement("code",null,m.a.get().getIdentityServerUrl()),o.a.createElement("br",null),o.a.createElement("br",null),o.a.createElement("details",null,o.a.createElement("summary",null,Object(c.a)("Access Token")),o.a.createElement("br",null),o.a.createElement("b",null,Object(c.a)("Your access token gives full access to your account. Do not share it with anyone.")),o.a.createElement(ha.a,{getTextToCopy:()=>m.a.get().getAccessToken()},m.a.get().getAccessToken())),o.a.createElement("br",null),o.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},o.a.createElement(f.a,{onClick:this.onClearCacheAndReload,kind:"danger"},Object(c.a)("Clear cache and reload"))))))}}var pa=a(459),ga=a(426);class ba extends o.a.Component{constructor(e){super(e),i()(this,"onPersonalRuleChanged",e=>{this.setState({newPersonalRule:e.target.value})}),i()(this,"onNewListChanged",e=>{this.setState({newList:e.target.value})}),i()(this,"onAddPersonalRule",async e=>{e.preventDefault(),e.stopPropagation();let t=ga.d;this.state.newPersonalRule.startsWith("@")&&(t=ga.e),this.setState({busy:!0});try{const e=await pa.a.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,Object(c.a)("Ignored/Blocked")),this.setState({newPersonalRule:""})}catch(e){d.a.error(e),g.a.createTrackedDialog("Failed to add Mjolnir rule","",b.a,{title:Object(c.a)("Error adding ignored user/server"),description:Object(c.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}),i()(this,"onSubscribeList",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await m.a.get().joinRoom(this.state.newList);await pa.a.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){d.a.error(e),g.a.createTrackedDialog("Failed to subscribe to Mjolnir list","",b.a,{title:Object(c.a)("Error subscribing to list"),description:Object(c.a)("Please verify the room ID or address and try again.")})}finally{this.setState({busy:!1})}}),this.state={busy:!1,newPersonalRule:"",newList:""}}async removePersonalRule(e){this.setState({busy:!0});try{const t=pa.a.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){d.a.error(e),g.a.createTrackedDialog("Failed to remove Mjolnir rule","",b.a,{title:Object(c.a)("Error removing ignored user/server"),description:Object(c.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}async unsubscribeFromList(e){this.setState({busy:!0});try{await pa.a.sharedInstance().unsubscribeFromList(e.roomId),await m.a.get().leave(e.roomId)}catch(e){d.a.error(e),g.a.createTrackedDialog("Failed to unsubscribe from Mjolnir list","",b.a,{title:Object(c.a)("Error unsubscribing from list"),description:Object(c.a)("Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}viewListRules(e){const t=m.a.get().getRoom(e.roomId),a=t?t.name:e.roomId,n=e=>{if(0===e.length)return o.a.createElement("i",null,Object(c.a)("None"));const t=[];for(const a of e)t.push(o.a.createElement("li",{key:a.kind+a.entity},o.a.createElement("code",null,a.entity)));return o.a.createElement("ul",null,t)};g.a.createTrackedDialog("View Mjolnir list rules","",de.a,{title:Object(c.a)("Ban list rules - %(roomName)s",{roomName:a}),description:o.a.createElement("div",null,o.a.createElement("h3",null,Object(c.a)("Server rules")),n(e.serverRules),o.a.createElement("h3",null,Object(c.a)("User rules")),n(e.userRules)),button:Object(c.a)("Close"),hasCancelButton:!1})}renderPersonalBanListRules(){const e=pa.a.sharedInstance().getPersonalList(),t=e?[...e.userRules,...e.serverRules]:[];if(!e||t.length<=0)return o.a.createElement("i",null,Object(c.a)("You have not ignored anyone."));const a=[];for(const e of t)a.push(o.a.createElement("li",{key:e.entity,className:"mx_MjolnirUserSettingsTab_listItem"},o.a.createElement(f.a,{kind:"danger_sm",onClick:()=>this.removePersonalRule(e),disabled:this.state.busy},Object(c.a)("Remove"))," ",o.a.createElement("code",null,e.entity)));return o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You are currently ignoring:")),o.a.createElement("ul",null,a))}renderSubscribedBanLists(){const e=pa.a.sharedInstance().getPersonalList(),t=pa.a.sharedInstance().lists.filter(t=>!e||e.roomId!==t.roomId);if(!t||t.length<=0)return o.a.createElement("i",null,Object(c.a)("You are not subscribed to any lists"));const a=[];for(const e of t){const t=m.a.get().getRoom(e.roomId),n=t?o.a.createElement("span",null,t.name," (",o.a.createElement("code",null,e.roomId),")"):o.a.createElement("code",null,"list.roomId");a.push(o.a.createElement("li",{key:e.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},o.a.createElement(f.a,{kind:"danger_sm",onClick:()=>this.unsubscribeFromList(e),disabled:this.state.busy},Object(c.a)("Unsubscribe"))," ",o.a.createElement(f.a,{kind:"primary_sm",onClick:()=>this.viewListRules(e),disabled:this.state.busy},Object(c.a)("View rules"))," ",n))}return o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You are currently subscribed to:")),o.a.createElement("ul",null,a))}render(){const e=u.b.get().brand;return o.a.createElement("div",{className:"mx_SettingsTab mx_MjolnirUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Ignored users")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"warning"},Object(c.a)("⚠ These settings are meant for advanced users.")),o.a.createElement("br",null),o.a.createElement("br",null),Object(c.a)("Add users and servers you want to ignore here. Use asterisks to have %(brand)s match any characters. For example, <code>@bot:*</code> would ignore all users that have the name 'bot' on any server.",{brand:e},{code:e=>o.a.createElement("code",null,e)}),o.a.createElement("br",null),o.a.createElement("br",null),Object(c.a)("Ignoring people is done through ban lists which contain rules for who to ban. Subscribing to a ban list means the users/servers blocked by that list will be hidden from you."))),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Personal ban list")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Your personal ban list holds all the users/servers you personally don't want to see messages from. After ignoring your first user/server, a new room will show up in your room list named 'My Ban List' - stay in this room to keep the ban list in effect.")),o.a.createElement("div",null,this.renderPersonalBanListRules()),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onAddPersonalRule,autoComplete:"off"},o.a.createElement(h.a,{type:"text",label:Object(c.a)("Server or user ID to ignore"),placeholder:Object(c.a)("eg: @bot:* or example.org"),value:this.state.newPersonalRule,onChange:this.onPersonalRuleChanged}),o.a.createElement(f.a,{type:"submit",kind:"primary",onClick:this.onAddPersonalRule,disabled:this.state.busy},Object(c.a)("Ignore"))))),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Subscribed lists")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"warning"},Object(c.a)("Subscribing to a ban list will cause you to join it!"))," ",o.a.createElement("span",null,Object(c.a)("If this isn't what you want, please use a different tool to ignore users."))),o.a.createElement("div",null,this.renderSubscribedBanLists()),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onSubscribeList,autoComplete:"off"},o.a.createElement(h.a,{type:"text",label:Object(c.a)("Room ID or address of ban list"),value:this.state.newList,onChange:this.onNewListChanged}),o.a.createElement(f.a,{type:"submit",kind:"primary",onClick:this.onSubscribeList,disabled:this.state.busy},Object(c.a)("Subscribe"))))))}}var va=a(819),fa=a(608),Ea=a(192);const ya=e=>{let{name:t,last:a}=e;const n=me.g[t],i=me.a[t];return o.a.createElement(o.a.Fragment,null,o.a.createElement("kbd",null," ",n||i&&Object(c.a)(i)||t," "),!a&&"+")},_a=e=>{let{value:t}=e;if(!t)return null;const a=[];return t.ctrlOrCmdKey?a.push(o.a.createElement(ya,{key:"ctrlOrCmdKey",name:Ea.a?Ea.b.META:Ea.b.CONTROL})):t.ctrlKey?a.push(o.a.createElement(ya,{key:"ctrlKey",name:Ea.b.CONTROL})):t.metaKey&&a.push(o.a.createElement(ya,{key:"metaKey",name:Ea.b.META})),t.altKey&&a.push(o.a.createElement(ya,{key:"altKey",name:Ea.b.ALT})),t.shiftKey&&a.push(o.a.createElement(ya,{key:"shiftKey",name:Ea.b.SHIFT})),o.a.createElement("div",{className:"mx_KeyboardShortcut"},a,o.a.createElement(ya,{name:t.key,last:!0}))};const Sa=Object.entries(me.b).filter(e=>{let[t]=e;return t!==me.c.LABS||u.b.get("show_labs_settings")}),wa=e=>{let{name:t}=e;const a=Object(fa.a)(t),n=Object(fa.b)(t);return a&&n?o.a.createElement("div",{className:"mx_KeyboardShortcut_shortcutRow"},a,o.a.createElement(_a,{value:n})):null},Ca=e=>{let{categoryName:t,category:a}=e;return a.categoryLabel?o.a.createElement("div",{className:"mx_SettingsTab_section",key:t},o.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)(a.categoryLabel)),o.a.createElement("div",null," ",a.settingNames.map(e=>o.a.createElement(wa,{key:e,name:e}))," ")):null};var Oa=()=>o.a.createElement("div",{className:"mx_SettingsTab mx_KeyboardUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Keyboard")),Sa.map(e=>{let[t,a]=e;return o.a.createElement(Ca,{key:t,categoryName:t,category:a})}));class ka extends o.a.Component{constructor(e){super(e),i()(this,"mjolnirWatcher",void 0),i()(this,"mjolnirChanged",(e,t,a,n)=>{this.setState({mjolnirEnabled:n})}),this.state={mjolnirEnabled:C.b.getValue("feature_mjolnir")}}componentDidMount(){this.mjolnirWatcher=C.b.watchSetting("feature_mjolnir",null,this.mjolnirChanged)}componentWillUnmount(){C.b.unwatchSetting(this.mjolnirWatcher)}getTabs(){const e=[];return e.push(new r.a(Xt.a.General,Object(c.c)("General"),"mx_UserSettingsDialog_settingsIcon",o.a.createElement(Ie,{closeSettingsFn:this.props.onFinished}),"UserSettingsGeneral")),e.push(new r.a(Xt.a.Appearance,Object(c.c)("Appearance"),"mx_UserSettingsDialog_appearanceIcon",o.a.createElement(tt,null),"UserSettingsAppearance")),e.push(new r.a(Xt.a.Notifications,Object(c.c)("Notifications"),"mx_UserSettingsDialog_bellIcon",o.a.createElement(Qt,null),"UserSettingsNotifications")),e.push(new r.a(Xt.a.Preferences,Object(c.c)("Preferences"),"mx_UserSettingsDialog_preferencesIcon",o.a.createElement(Zt,{closeSettingsFn:this.props.onFinished}),"UserSettingsPreferences")),e.push(new r.a(Xt.a.Keyboard,Object(c.c)("Keyboard"),"mx_UserSettingsDialog_keyboardIcon",o.a.createElement(Oa,null),"UserSettingsKeyboard")),e.push(new r.a(Xt.a.Sidebar,Object(c.c)("Sidebar"),"mx_UserSettingsDialog_sidebarIcon",o.a.createElement(va.a,null),"UserSettingsSidebar")),C.b.getValue(K.b.Voip)&&e.push(new r.a(Xt.a.Voice,Object(c.c)("Voice & Video"),"mx_UserSettingsDialog_voiceIcon",o.a.createElement(ta,null),"UserSettingsVoiceVideo")),e.push(new r.a(Xt.a.Security,Object(c.c)("Security & Privacy"),"mx_UserSettingsDialog_securityIcon",o.a.createElement(It,{closeSettingsFn:this.props.onFinished}),"UserSettingsSecurityPrivacy")),(u.b.get("show_labs_settings")||C.b.getFeatureSettingNames().some(e=>C.b.getBetaInfo(e)))&&e.push(new r.a(Xt.a.Labs,Object(c.c)("Labs"),"mx_UserSettingsDialog_labsIcon",o.a.createElement(Le,null),"UserSettingsLabs")),this.state.mjolnirEnabled&&e.push(new r.a(Xt.a.Mjolnir,Object(c.c)("Ignored users"),"mx_UserSettingsDialog_mjolnirIcon",o.a.createElement(ba,null),"UserSettingMjolnir")),e.push(new r.a(Xt.a.Help,Object(c.c)("Help & About"),"mx_UserSettingsDialog_helpIcon",o.a.createElement(ua,{closeSettingsFn:()=>this.props.onFinished(!0)}),"UserSettingsHelpAbout")),e}render(){return o.a.createElement(A.a,{className:"mx_UserSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Settings")},o.a.createElement("div",{className:"mx_SettingsDialog_content"},o.a.createElement(r.c,{tabs:this.getTabs(),initialTabId:this.props.initialTabId,screenName:"UserSettings"})))}}},1484:function(e,t,a){"use strict";a.d(t,"a",(function(){return Fe}));var n=a(88),i=a.n(n),s=a(92),o=a(95),r=a(356),c=a(129),l=a(103),d=a.n(l),m=a(87),h=a.n(m),u=a(94),p=a.n(u),g=a(108),b=a(18),v=a(237),f=a(89),E=a(177),y=a(157),_=a(101),S=a(221),w=a(355),C=a(300),O=a(276),k=a(140),x=a(117),R=a(176),j=a(349),I=a(210),T=a(405),N=a(259),P=a(496),M=a(561),D=a(148),A=a(96),U=a(562),L=a(153),F=a(199);const B=["m.relates_to"];function V(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function W(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?V(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):V(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var H;!function(e){e[e.CanSend=0]="CanSend",e[e.Sending=1]="Sending",e[e.Sent=2]="Sent",e[e.Failed=3]="Failed"}(H||(H={}));const z=e=>{let{room:t,type:a,content:n,matrixClient:i,onFinished:o}=e;const[r,c]=Object(m.useState)(H.CanSend);let l,d,u,p=!1;r===H.CanSend?(l="mx_ForwardList_canSend",t.maySendMessage()||(p=!0,d=Object(f.a)("You don't have permission to do this"))):r===H.Sending?(l="mx_ForwardList_sending",p=!0,d=Object(f.a)("Sending"),u=h.a.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":d})):r===H.Sent?(l="mx_ForwardList_sent",p=!0,d=Object(f.a)("Sent"),u=h.a.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":d})):(l="mx_ForwardList_sendFailed",p=!0,d=Object(f.a)("Failed to send"),u=h.a.createElement(I.a,{notification:j.a.RED_EXCLAMATION}));const g=Object(U.a)(t);return h.a.createElement("div",{className:"mx_ForwardList_entry"},h.a.createElement(x.a,{className:"mx_ForwardList_roomButton",onClick:e=>{s.a.dispatch({action:A.a.ViewRoom,room_id:t.roomId,metricsTrigger:"WebForwardShortcut",metricsViaKeyboard:"click"!==e.type}),o(!0)},title:Object(f.a)("Open room"),alignment:k.a.Top},h.a.createElement(O.a,{room:t,avatarSize:32}),h.a.createElement("span",{className:"mx_ForwardList_entry_name"},t.name),g&&h.a.createElement("span",{className:"mx_ForwardList_entry_detail"},g)),h.a.createElement(x.a,{kind:r===H.Failed?"danger_outline":"primary_outline",className:"mx_ForwardList_sendButton "+l,onClick:async()=>{c(H.Sending);try{await i.sendEvent(t.roomId,a,n),c(H.Sent)}catch(e){c(H.Failed)}},disabled:p,title:d,alignment:k.a.Top},h.a.createElement("div",{className:"mx_ForwardList_sendLabel"},Object(f.a)("Send")),u))};var K=e=>{let{matrixClient:t,event:n,permalinkCreator:i,onFinished:s}=e;const o=t.getUserId(),[r,c]=Object(m.useState)({});Object(m.useEffect)(()=>{t.getProfileInfo(o).then(e=>c(e))},[t,o]);const l=(e=>{const t=e.getContent(),{"m.relates_to":a}=t,n=d()(t,B);if(Object(L.k)(e)&&Object(F.f)(n)){const t=b.d.findIn(n),a=Object(F.g)(e);return W(W({},n),Object(v.makeLocationContent)(void 0,a,t||Date.now(),void 0,b.a.Pin))}return n})(n),u=new g.b({type:"m.room.message",sender:o,content:l,unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:n.getRoomId()});u.sender={name:r.displayname||o,rawDisplayName:r.displayname,userId:o,getAvatarUrl:function(){return Object(S.c)({avatarUrl:r.avatar_url},30,30,"crop")},getMxcAvatarUrl:()=>r.avatar_url};const[O,k]=Object(m.useState)(""),x=O.toLowerCase(),j=Object(E.b)("layout");let I=Object(m.useMemo)(()=>Object(T.b)(t.getVisibleRooms().filter(e=>"join"===e.getMyMembership()&&!e.isSpaceRoom())),[t]);x&&(I=new N.a(I,{keys:["name"],funcs:[e=>[e.getCanonicalAlias(),...e.getAltAliases()].filter(Boolean)],shouldMatchWordsOnly:!1}).match(x));const[A,U]=Object(m.useState)(20);return h.a.createElement(_.a,{title:Object(f.a)("Forward message"),className:"mx_ForwardDialog",contentId:"mx_ForwardList",onFinished:s,fixedWidth:!1},h.a.createElement("h3",null,Object(f.a)("Message preview")),h.a.createElement("div",{className:p()("mx_ForwardDialog_preview",{mx_IRCLayout:j==y.a.IRC,mx_GroupLayout:j==y.a.Group})},h.a.createElement(w.a,{mxEvent:u,layout:j,permalinkCreator:i,as:"div"})),h.a.createElement("hr",null),h.a.createElement("div",{className:"mx_ForwardList",id:"mx_ForwardList"},h.a.createElement(C.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:Object(f.a)("Search for rooms or people"),onSearch:k,autoFocus:!0}),h.a.createElement(R.a,{className:"mx_ForwardList_content"},I.length>0?h.a.createElement("div",{className:"mx_ForwardList_results"},h.a.createElement(P.a,{className:"mx_ForwardList_resultsList",truncateAt:A,createOverflowElement:function(e,t){const n=Object(f.a)("and %(count)s others...",{count:e});return h.a.createElement(M.b,{className:"mx_EntityTile_ellipsis",avatarJsx:h.a.createElement(D.a,{url:a(812).default,name:"...",width:36,height:36}),name:n,presenceState:"online",suppressOnHover:!0,onClick:()=>U(t)})},getChildren:(e,a)=>I.slice(e,a).map(e=>h.a.createElement(z,{key:e.roomId,room:e,type:n.getType(),content:l,matrixClient:t,onFinished:s})),getChildCount:()=>I.length})):h.a.createElement("span",{className:"mx_ForwardList_noResults"},Object(f.a)("No results")))))},q=a(90),G=a(0),Y=a(183),J=a(98),$=a(719),Q=a(93),X=a(220),Z=a(110),ee=a(105),te=a(102),ae=a(141);var ne=e=>{let{value:t,label:a,byline:n,disabled:i,onChange:s}=e;return h.a.createElement("label",{className:"mx_LabelledCheckbox"},h.a.createElement(ae.b,{disabled:i,checked:t,onChange:e=>s(e.target.checked)}),h.a.createElement("div",{className:"mx_LabelledCheckbox_labels"},h.a.createElement("span",{className:"mx_LabelledCheckbox_label"},a),n?h.a.createElement("span",{className:"mx_LabelledCheckbox_byline"},n):null))};const ie=["org.matrix.msc3215.room.moderation.moderated_by"];var se,oe;!function(e){e.Disagreement="org.matrix.msc3215.abuse.nature.disagreement",e.Toxic="org.matrix.msc3215.abuse.nature.toxic",e.Illegal="org.matrix.msc3215.abuse.nature.illegal",e.Spam="org.matrix.msc3215.abuse.nature.spam",e.Other="org.matrix.msc3215.abuse.nature.other"}(se||(se={})),function(e){e.Admin="non-standard.abuse.nature.admin"}(oe||(oe={}));class re extends h.a.Component{constructor(e){super(e),i()(this,"moderation",void 0),i()(this,"onIgnoreUserTooChanged",e=>{this.setState({ignoreUserToo:e})}),i()(this,"onReasonChange",e=>{let{target:{value:t}}=e;this.setState({reason:t})}),i()(this,"onNatureChosen",e=>{this.setState({nature:e.currentTarget.value})}),i()(this,"onCancel",()=>{this.props.onFinished(!1)}),i()(this,"onSubmit",async()=>{let e=this.state.reason||"";if(e=e.trim(),this.moderation){if(!this.state.nature||(this.state.nature==se.Other||this.state.nature==oe.Admin)&&!e)return void this.setState({err:Object(f.a)("Please fill why you're reporting.")})}else if(!e)return void this.setState({err:Object(f.a)("Please fill why you're reporting.")});this.setState({busy:!0,err:null});try{const e=q.a.get(),t=this.props.mxEvent;if(this.moderation&&this.state.nature!==oe.Admin){const a=this.state.nature,n=await Object(Y.c)(e,this.moderation.moderationBotUserId);await e.sendEvent(n,"org.matrix.msc3215.abuse.report",{event_id:t.getId(),room_id:t.getRoomId(),moderated_by_id:this.moderation.moderationRoomId,nature:a,reporter:e.getUserId(),comment:this.state.reason.trim()})}else await e.reportEvent(t.getRoomId(),t.getId(),-100,this.state.reason.trim());this.state.ignoreUserToo&&await e.setIgnoredUsers([...e.getIgnoredUsers(),t.getSender()]),this.props.onFinished(!0)}catch(e){G.a.error(e),this.setState({busy:!1,err:e.message})}});let t=null,a=null;if(Q.b.getValue("feature_report_to_moderators")){const n=q.a.get().getRoom(e.mxEvent.getRoomId());for(const e of ie){const i=n.currentState.getStateEvents(e,e);if(!i)continue;if(Array.isArray(i))throw new TypeError(`getStateEvents(${e}, ${e}) should return at most one state event`);const s=i.event;if(!("content"in s)||"object"!=typeof s.content){console.debug("Moderation error","state event",e,"should have an object field `content`, got",s);continue}const o=s.content;"room_id"in o&&"string"==typeof o.room_id?"user_id"in o&&"string"==typeof o.user_id?(t=o.room_id,a=o.user_id):console.debug("Moderation error","state event",e,"should have a string field `content.user_id`, got",s):console.debug("Moderation error","state event",e,"should have a string field `content.room_id`, got",s)}t&&a&&(this.moderation={moderationRoomId:t,moderationBotUserId:a})}this.state={reason:"",busy:!1,err:null,nature:null,ignoreUserToo:!1}}render(){var e;let t=null;this.state.err&&(t=h.a.createElement("div",{className:"error"},this.state.err));let a=null;this.state.busy&&(a=h.a.createElement("div",{className:"progress"},h.a.createElement(te.a,null)));const n=h.a.createElement(ne,{value:this.state.ignoreUserToo,label:Object(f.a)("Ignore user"),byline:Object(f.a)("Check if you want to hide all current and future messages from this user."),onChange:this.onIgnoreUserTooChanged,disabled:this.state.busy}),i=null===(e=J.b.getObject("report_event"))||void 0===e?void 0:e.get("admin_message_md","adminMessageMD");let s;if(i){const e=new $.a(i).toHTML({externalLinks:!0});s=h.a.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}if(this.moderation){const e=q.a.get(),i=J.b.get("validated_server_config").hsName;let s;switch(this.state.nature){case se.Disagreement:s=Object(f.a)("What this user is writing is wrong.\nThis will be reported to the room moderators.");break;case se.Toxic:s=Object(f.a)("This user is displaying toxic behaviour, for instance by insulting other users or sharing  adult-only content in a family-friendly room  or otherwise violating the rules of this room.\nThis will be reported to the room moderators.");break;case se.Illegal:s=Object(f.a)("This user is displaying illegal behaviour, for instance by doxing people or threatening violence.\nThis will be reported to the room moderators who may escalate this to legal authorities.");break;case se.Spam:s=Object(f.a)("This user is spamming the room with ads, links to ads or to propaganda.\nThis will be reported to the room moderators.");break;case oe.Admin:s=e.isRoomEncrypted(this.props.mxEvent.getRoomId())?Object(f.a)("This room is dedicated to illegal or toxic content or the moderators fail to moderate illegal or toxic content.\nThis will be reported to the administrators of %(homeserver)s. The administrators will NOT be able to read the encrypted content of this room.",{homeserver:i}):Object(f.a)("This room is dedicated to illegal or toxic content or the moderators fail to moderate illegal or toxic content.\n This will be reported to the administrators of %(homeserver)s.",{homeserver:i});break;case se.Other:s=Object(f.a)("Any other reason. Please describe the problem.\nThis will be reported to the room moderators.");break;default:s=Object(f.a)("Please pick a nature and describe what makes this message abusive.")}return h.a.createElement(_.a,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:Object(f.a)("Report Content"),contentId:"mx_ReportEventDialog"},h.a.createElement("div",null,h.a.createElement(X.a,{name:"nature",value:se.Disagreement,checked:this.state.nature==se.Disagreement,onChange:this.onNatureChosen},Object(f.a)("Disagree")),h.a.createElement(X.a,{name:"nature",value:se.Toxic,checked:this.state.nature==se.Toxic,onChange:this.onNatureChosen},Object(f.a)("Toxic Behaviour")),h.a.createElement(X.a,{name:"nature",value:se.Illegal,checked:this.state.nature==se.Illegal,onChange:this.onNatureChosen},Object(f.a)("Illegal Content")),h.a.createElement(X.a,{name:"nature",value:se.Spam,checked:this.state.nature==se.Spam,onChange:this.onNatureChosen},Object(f.a)("Spam or propaganda")),h.a.createElement(X.a,{name:"nature",value:oe.Admin,checked:this.state.nature==oe.Admin,onChange:this.onNatureChosen},Object(f.a)("Report the entire room")),h.a.createElement(X.a,{name:"nature",value:se.Other,checked:this.state.nature==se.Other,onChange:this.onNatureChosen},Object(f.a)("Other")),h.a.createElement("p",null,s),h.a.createElement(ee.a,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(f.a)("Reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),a,t,n),h.a.createElement(Z.a,{primaryButton:Object(f.a)("Send report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}return h.a.createElement(_.a,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:Object(f.a)("Report Content to Your Homeserver Administrator"),contentId:"mx_ReportEventDialog"},h.a.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},h.a.createElement("p",null,Object(f.a)("Reporting this message will send its unique 'event ID' to the administrator of your homeserver. If messages in this room are encrypted, your homeserver administrator will not be able to read the message text or view any files or images.")),s,h.a.createElement(ee.a,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(f.a)("Reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),a,t,n),h.a.createElement(Z.a,{primaryButton:Object(f.a)("Send report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}}var ce=a(306),le=a(104),de=a(233);let me;!function(e){e.Appearance="SPACE_PREFERENCE_APPEARANCE_TAB"}(me||(me={}));const he=e=>{let{space:t}=e;const a=Object(E.b)("Spaces.showPeopleInSpace",t.roomId);return h.a.createElement("div",{className:"mx_SettingsTab"},h.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(f.a)("Sections to show")),h.a.createElement("div",{className:"mx_SettingsTab_section"},h.a.createElement(ae.b,{checked:!!a,onChange:e=>{Q.b.setValue("Spaces.showPeopleInSpace",t.roomId,le.a.ROOM_ACCOUNT,!a)}},Object(f.a)("People")),h.a.createElement("p",null,Object(f.a)("This groups your chats with members of this space. Turning this off will hide those chats from your view of %(spaceName)s.",{spaceName:t.name}))))};var ue=e=>{let{space:t,initialTabId:a,onFinished:n}=e;const i=[new ce.a(me.Appearance,Object(f.c)("Appearance"),"mx_SpacePreferencesDialog_appearanceIcon",h.a.createElement(he,{space:t}))];return h.a.createElement(_.a,{className:"mx_SpacePreferencesDialog",hasCancel:!0,onFinished:n,title:Object(f.a)("Preferences"),fixedWidth:!1},h.a.createElement("h4",null,h.a.createElement(de.a,{room:t})),h.a.createElement("div",{className:"mx_SettingsDialog_content"},h.a.createElement(ce.c,{tabs:i,initialTabId:a})))},pe=a(234),ge=a(97),be=a(91),ve=a(750),fe=a(427),Ee=a(813);var ye=e=>{let{matrixClient:t,space:a,onFinished:n}=e;const[i,s]=Object(m.useState)(!1),[o,r]=Object(m.useState)(""),c=t.getUserId(),[l,d]=Object(m.useState)(null),u=a.currentState.maySendStateEvent(ge.b.RoomAvatar,c),p=null!==l,[g,b]=Object(m.useState)(a.name),v=a.currentState.maySendStateEvent(ge.b.RoomName,c),E=g!==a.name,y=Object(Ee.a)(a),[_,w]=Object(m.useState)(y),C=a.currentState.maySendStateEvent(ge.b.RoomTopic,c),O=_!==y;return h.a.createElement("div",{className:"mx_SettingsTab"},h.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(f.a)("General")),h.a.createElement("div",null,Object(f.a)("Edit settings relating to your space.")),o&&h.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},o),h.a.createElement("div",{className:"mx_SettingsTab_section"},h.a.createElement(ve.b,{avatarUrl:Object(S.b)(a,80,80,"crop"),avatarDisabled:i||!u,setAvatar:d,name:g,nameDisabled:i||!v,setName:b,topic:_,topicDisabled:i||!C,setTopic:w}),h.a.createElement(be.a,{onClick:()=>{d(null),b(a.name),w(y)},disabled:i||!(p||E||O),kind:"link"},Object(f.a)("Cancel")),h.a.createElement(be.a,{onClick:async()=>{s(!0);const e=[];p&&(l?e.push(t.sendStateEvent(a.roomId,ge.b.RoomAvatar,{url:await t.uploadContent(l)},"")):e.push(t.sendStateEvent(a.roomId,ge.b.RoomAvatar,{},""))),E&&e.push(t.setRoomName(a.roomId,g)),O&&e.push(t.setRoomTopic(a.roomId,_));const n=await Promise.allSettled(e);s(!1);const i=n.filter(e=>"rejected"===e.status);i.length>0&&(G.a.error("Failed to save space settings: ",i),r(Object(f.a)("Failed to save space settings.")))},disabled:i,kind:"primary"},i?Object(f.a)("Saving..."):Object(f.a)("Save Changes"))),h.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(f.a)("Leave Space")),h.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},h.a.createElement(be.a,{kind:"danger",onClick:()=>{Object(fe.b)(a)}},Object(f.a)("Leave Space"))))},_e=a(125),Se=a(847),we=a(344),Ce=a(195),Oe=a(800),ke=a(853),xe=a(414),Re=a(350);var je=e=>{let{matrixClient:t,space:a,closeSettingsFn:n}=e;const[i,s]=Object(m.useState)(""),o=t.getUserId(),r=Object(xe.a)(a,e=>e.getJoinRule()),[c,l]=Object(Oe.a)(()=>{var e,t;return(null===(e=a.currentState.getStateEvents(ge.b.RoomGuestAccess,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.guest_access)===_e.a.CanJoin},e=>t.sendStateEvent(a.roomId,ge.b.RoomGuestAccess,{guest_access:e?_e.a.CanJoin:_e.a.Forbidden},""),()=>s(Object(f.a)("Failed to update the guest access of this space"))),[d,u]=Object(Oe.a)(()=>{var e,t;return(null===(e=a.currentState.getStateEvents(ge.b.RoomHistoryVisibility,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.history_visibility)||_e.b.Shared},e=>t.sendStateEvent(a.roomId,ge.b.RoomHistoryVisibility,{history_visibility:e},""),()=>s(Object(f.a)("Failed to update the history visibility of this space"))),[p,g]=Object(we.a)(),b=a.currentState.maySendStateEvent(ge.b.RoomGuestAccess,o),v=a.currentState.maySendStateEvent(ge.b.RoomHistoryVisibility,o),E=a.currentState.mayClientSendStateEvent(ge.b.RoomCanonicalAlias,t),y=a.currentState.getStateEvents(ge.b.RoomCanonicalAlias,"");let _,S;return r===_e.c.Public&&(_=h.a.createElement("div",null,h.a.createElement(be.a,{"data-test-id":"toggle-guest-access-btn",onClick:g,kind:"link",className:"mx_SettingsTab_showAdvanced"},p?Object(f.a)("Hide advanced"):Object(f.a)("Show advanced")),p&&h.a.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},h.a.createElement(Ce.a,{value:c,onChange:l,disabled:!b,label:Object(f.a)("Enable guest access")}),h.a.createElement("p",null,Object(f.a)("Guests can join a space without having an account."),h.a.createElement("br",null),Object(f.a)("This may be useful for public spaces."))))),a.getJoinRule()===_e.c.Public&&(S=h.a.createElement(h.a.Fragment,null,h.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(f.a)("Address")),h.a.createElement(Se.a,{roomId:a.roomId,canSetCanonicalAlias:E,canSetAliases:!0,canonicalAliasEvent:y,hidePublishSetting:!0}))),h.a.createElement("div",{className:"mx_SettingsTab"},h.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(f.a)("Visibility")),i&&h.a.createElement("div",{"data-test-id":"space-settings-error",className:"mx_SpaceRoomView_errorText"},i),h.a.createElement(Re.a,{"data-test-id":"access-fieldset",legend:Object(f.a)("Access"),description:Object(f.a)("Decide who can view and join %(spaceName)s.",{spaceName:a.name})},h.a.createElement(ke.a,{room:a,onError:()=>s(Object(f.a)("Failed to update the visibility of this space")),closeSettingsFn:n}),_,h.a.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},h.a.createElement(Ce.a,{value:d===_e.b.WorldReadable,onChange:e=>{u(e?_e.b.WorldReadable:_e.b.Shared)},disabled:!v,label:Object(f.a)("Preview Space")}),h.a.createElement("p",null,Object(f.a)("Allow people to preview your space before they join."),h.a.createElement("br",null),h.a.createElement("b",null,Object(f.a)("Recommended for public spaces."))))),S)},Ie=a(122),Te=a(795),Ne=a(797);let Pe;!function(e){e.General="SPACE_GENERAL_TAB",e.Visibility="SPACE_VISIBILITY_TAB",e.Roles="SPACE_ROLES_TAB",e.Advanced="SPACE_ADVANCED_TAB"}(Pe||(Pe={}));var Me=e=>{let{matrixClient:t,space:a,onFinished:n}=e;Object(pe.a)(s.a,e=>{e.action===A.a.AfterLeaveRoom&&e.room_id===a.roomId&&n(!1)});const i=Object(m.useMemo)(()=>[new ce.a(Pe.General,Object(f.c)("General"),"mx_SpaceSettingsDialog_generalIcon",h.a.createElement(ye,{matrixClient:t,space:a,onFinished:n})),new ce.a(Pe.Visibility,Object(f.c)("Visibility"),"mx_SpaceSettingsDialog_visibilityIcon",h.a.createElement(je,{matrixClient:t,space:a,closeSettingsFn:n})),new ce.a(Pe.Roles,Object(f.c)("Roles & Permissions"),"mx_RoomSettingsDialog_rolesIcon",h.a.createElement(Ne.a,{roomId:a.roomId})),Q.b.getValue(Ie.b.AdvancedSettings)?new ce.a(Pe.Advanced,Object(f.c)("Advanced"),"mx_RoomSettingsDialog_warningIcon",h.a.createElement(Te.a,{roomId:a.roomId,closeSettingsFn:n})):null].filter(Boolean),[t,a,n]);return h.a.createElement(_.a,{title:Object(f.a)("Space settings"),className:"mx_SpaceSettingsDialog",contentId:"mx_SpaceSettingsDialog",onFinished:n,fixedWidth:!1},h.a.createElement("div",{className:"mx_SpaceSettingsDialog_content",id:"mx_SpaceSettingsDialog",title:Object(f.a)("Settings - %(spaceName)s",{spaceName:a.name})},h.a.createElement(ce.c,{tabs:i})))},De=a(631),Ae=a(343),Ue=a(127),Le=a(213);class Fe{constructor(){i()(this,"isRegistered",!1),i()(this,"onDispatch",e=>{switch(e.action){case"open_room_settings":o.a.createTrackedDialog("Room settings","",r.c,{roomId:e.room_id||c.a.instance.getRoomId(),initialTabId:e.initial_tab_id},null,!1,!0);break;case A.a.OpenForwardDialog:o.a.createTrackedDialog("Forward Message","",K,{matrixClient:q.a.get(),event:e.event,permalinkCreator:e.permalinkCreator});break;case A.a.OpenReportEventDialog:o.a.createTrackedDialog("Report Event","",re,{mxEvent:e.event},"mx_Dialog_reportEvent");break;case A.a.OpenSpacePreferences:o.a.createTrackedDialog("Space preferences","",ue,{initialTabId:e.initalTabId,space:e.space},null,!1,!0);break;case A.a.OpenSpaceSettings:o.a.createTrackedDialog("Space Settings","",Me,{matrixClient:e.space.client,space:e.space},null,!1,!0);break;case A.a.OpenInviteDialog:o.a.createTrackedDialog(e.analyticsName,"",De.a,{kind:e.kind,call:e.call,roomId:e.roomId},e.className,!1,!0).finished.then(t=>{var a;null===(a=e.onFinishedCallback)||void 0===a||a.call(e,t)});break;case A.a.OpenAddToExistingSpaceDialog:{const t=e.space;o.a.createTrackedDialog("Space Landing","Add Existing",Ae.d,{onCreateRoomClick:e=>{Object(Le.g)(t),Ue.b.trackInteraction("WebAddExistingToSpaceDialogCreateRoomButton",e)},onAddSubspaceClick:()=>Object(Le.f)(t),space:t,onFinished:e=>{e&&c.a.instance.getRoomId()===t.roomId&&s.a.fire(A.a.UpdateSpaceHierarchy)}},"mx_AddExistingToSpaceDialog_wrapper");break}}})}prepare(){this.isRegistered||(s.a.register(this.onDispatch),this.isRegistered=!0)}}i()(Fe,"instance",new Fe)},1486:function(e,t,a){"use strict";a.d(t,"a",(function(){return P}));var n=a(88),i=a.n(n),s=a(0),o=a(145),r=a(120),c=a(90),l=a(92),d=a(89),m=a(197),h=a(160),u=a(96),p=a(155);var g=a(95),b=a(555),v=a(214),f=a(249),E=a(102);const y=e=>{switch(e){case C.SET_UP_ENCRYPTION:return Object(d.a)("Set up Secure Backup");case C.UPGRADE_ENCRYPTION:return Object(d.a)("Encryption upgrade available");case C.VERIFY_THIS_SESSION:return Object(d.a)("Verify this session")}},_=e=>{switch(e){case C.SET_UP_ENCRYPTION:case C.UPGRADE_ENCRYPTION:return"secure_backup";case C.VERIFY_THIS_SESSION:return"verification_warning"}},S=e=>{switch(e){case C.SET_UP_ENCRYPTION:return Object(d.a)("Continue");case C.UPGRADE_ENCRYPTION:return Object(d.a)("Upgrade");case C.VERIFY_THIS_SESSION:return Object(d.a)("Verify")}},w=e=>{switch(e){case C.SET_UP_ENCRYPTION:case C.UPGRADE_ENCRYPTION:return Object(d.a)("Safeguard against losing access to encrypted messages & data");case C.VERIFY_THIS_SESSION:return Object(d.a)("Other users may not trust it")}};let C;!function(e){e.SET_UP_ENCRYPTION="set_up_encryption",e.UPGRADE_ENCRYPTION="upgrade_encryption",e.VERIFY_THIS_SESSION="verify_this_session"}(C||(C={}));const O=()=>{P.sharedInstance().dismissEncryptionSetup()},k=e=>{var t;if(null!==(t=f.a.setupEncryptionNeeded)&&void 0!==t&&t.call(f.a,e))return;h.a.sharedInstance().addOrReplaceToast({key:"setupencryption",title:y(e),icon:_(e),props:{description:w(e),acceptLabel:S(e),onAccept:async()=>{if(e===C.VERIFY_THIS_SESSION)g.a.createTrackedDialog("Verify session","Verify session",b.a,{},null,!1,!0);else{const e=g.a.createDialog(E.a,null,"mx_Dialog_spinner",!1,!0);try{await Object(v.b)()}finally{e.close()}}},rejectLabel:Object(d.a)("Later"),onReject:O},component:m.a,priority:e===C.VERIFY_THIS_SESSION?95:40})},x=()=>{h.a.sharedInstance().dismissToast("setupencryption")};function R(e){return"unverified_session_"+e}const j=async e=>{const t=c.a.get(),a=await t.getDevice(e);h.a.sharedInstance().addOrReplaceToast({key:R(e),title:Object(d.a)("New login. Was this you?"),icon:"verification_warning",props:{description:a.display_name,detail:Object(d.a)("%(deviceId)s from %(ip)s",{deviceId:e,ip:a.last_seen_ip}),acceptLabel:Object(d.a)("Check your devices"),onAccept:()=>{P.sharedInstance().dismissUnverifiedSessions([e]),l.a.dispatch({action:u.a.ViewUserSettings,initialTabId:p.a.Security})},rejectLabel:Object(d.a)("Later"),onReject:()=>{P.sharedInstance().dismissUnverifiedSessions([e])}},component:m.a,priority:80})},I=e=>{h.a.sharedInstance().dismissToast(R(e))};var T=a(205),N=a(318);class P{constructor(){i()(this,"dispatcherRef",void 0),i()(this,"dismissed",new Set),i()(this,"dismissedThisDeviceToast",!1),i()(this,"keyBackupInfo",null),i()(this,"keyBackupFetchedAt",null),i()(this,"keyBackupStatusChecked",!1),i()(this,"ourDeviceIdsAtStart",null),i()(this,"displayingToastsForDeviceIds",new Set),i()(this,"running",!1),i()(this,"onWillUpdateDevices",async(e,t)=>{if(t)return;const a=c.a.get().getUserId();e.includes(a)&&this.ensureDeviceIdsAtStartPopulated()}),i()(this,"onDevicesUpdated",e=>{e.includes(c.a.get().getUserId())&&this.recheck()}),i()(this,"onDeviceVerificationChanged",e=>{e===c.a.get().getUserId()&&this.recheck()}),i()(this,"onUserTrustStatusChanged",e=>{e===c.a.get().getUserId()&&this.recheck()}),i()(this,"onCrossSingingKeysChanged",()=>{this.recheck()}),i()(this,"onAccountData",e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing.")||"m.megolm_backup.v1"===e.getType())&&this.recheck()}),i()(this,"onSync",(e,t)=>{"PREPARED"===e&&null===t&&this.recheck()}),i()(this,"onRoomStateEvents",e=>{e.getType()===r.EventType.RoomEncryption&&this.recheck()}),i()(this,"onAction",e=>{let{action:t}=e;t===u.a.OnLoggedIn&&this.recheck()}),i()(this,"checkKeyBackupStatus",async()=>{if(this.keyBackupStatusChecked)return;const e=c.a.get().getKeyBackupEnabled();this.keyBackupStatusChecked=null!==e,!1===e&&l.a.dispatch({action:u.a.ReportKeyBackupNotEnabled})})}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new P),window.mxDeviceListener}start(){this.running=!0,c.a.get().on(o.b.WillUpdateDevices,this.onWillUpdateDevices),c.a.get().on(o.b.DevicesUpdated,this.onDevicesUpdated),c.a.get().on(o.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),c.a.get().on(o.b.UserTrustStatusChanged,this.onUserTrustStatusChanged),c.a.get().on(o.b.KeysChanged,this.onCrossSingingKeysChanged),c.a.get().on(r.ClientEvent.AccountData,this.onAccountData),c.a.get().on(r.ClientEvent.Sync,this.onSync),c.a.get().on(r.RoomStateEvent.Events,this.onRoomStateEvents),this.dispatcherRef=l.a.register(this.onAction),this.recheck()}stop(){this.running=!1,c.a.get()&&(c.a.get().removeListener(o.b.WillUpdateDevices,this.onWillUpdateDevices),c.a.get().removeListener(o.b.DevicesUpdated,this.onDevicesUpdated),c.a.get().removeListener(o.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),c.a.get().removeListener(o.b.UserTrustStatusChanged,this.onUserTrustStatusChanged),c.a.get().removeListener(o.b.KeysChanged,this.onCrossSingingKeysChanged),c.a.get().removeListener(r.ClientEvent.AccountData,this.onAccountData),c.a.get().removeListener(r.ClientEvent.Sync,this.onSync),c.a.get().removeListener(r.RoomStateEvent.Events,this.onRoomStateEvents)),this.dispatcherRef&&(l.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.keyBackupStatusChecked=!1,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set}async dismissUnverifiedSessions(e){s.a.log("Dismissing unverified sessions: "+Array.from(e).join(","));for(const t of e)this.dismissed.add(t);this.recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this.recheck()}ensureDeviceIdsAtStartPopulated(){if(null===this.ourDeviceIdsAtStart){const e=c.a.get();this.ourDeviceIdsAtStart=new Set(e.getStoredDevicesForUser(e.getUserId()).map(e=>e.deviceId))}}async getKeyBackupInfo(){const e=(new Date).getTime();return(!this.keyBackupInfo||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await c.a.get().getKeyBackupVersion(),this.keyBackupFetchedAt=e),this.keyBackupInfo}shouldShowSetupEncryptionToast(){if(Object(v.d)())return!1;const e=c.a.get();return e&&e.getRooms().some(t=>e.isRoomEncrypted(t.roomId))}async recheck(){if(!this.running)return;const e=c.a.get();if(!await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))return;if(!e.isCryptoEnabled())return;if(!e.isInitialSyncComplete())return;const t=await e.isCrossSigningReady(),a=await e.isSecretStorageReady(),n=t&&a;if(this.dismissedThisDeviceToast||n)x(),this.checkKeyBackupStatus();else if(this.shouldShowSetupEncryptionToast())if(await e.downloadKeys([e.getUserId()]),!e.getCrossSigningId()&&e.getStoredCrossSigningForUser(e.getUserId()))k(C.VERIFY_THIS_SESSION),this.checkKeyBackupStatus();else{await this.getKeyBackupInfo()?k(C.UPGRADE_ENCRYPTION):(await e.waitForClientWellKnown(),Object(T.g)()&&function(){const e=window.matrixChat;return e&&e.state.view===N.a.LOGGED_IN}()?(x(),Object(v.b)()):k(C.SET_UP_ENCRYPTION))}this.ensureDeviceIdsAtStartPopulated();const i=new Set,o=new Set;if(t){const t=e.getStoredDevicesForUser(e.getUserId());for(const a of t){if(a.deviceId===e.deviceId)continue;(await e.checkDeviceTrust(e.getUserId(),a.deviceId)).isCrossSigningVerified()||this.dismissed.has(a.deviceId)||(this.ourDeviceIdsAtStart.has(a.deviceId)?i.add(a.deviceId):o.add(a.deviceId))}}var r;s.a.debug("Old unverified sessions: "+Array.from(i).join(",")),s.a.debug("New unverified sessions: "+Array.from(o).join(",")),s.a.debug("Currently showing toasts for: "+Array.from(this.displayingToastsForDeviceIds).join(",")),i.size>0?(r=i,h.a.sharedInstance().addOrReplaceToast({key:"reviewsessions",title:Object(d.a)("You have unverified logins"),icon:"verification_warning",props:{description:Object(d.a)("Review to ensure your account is safe"),acceptLabel:Object(d.a)("Review"),onAccept:()=>{P.sharedInstance().dismissUnverifiedSessions(r),l.a.dispatch({action:u.a.ViewUserSettings,initialTabId:p.a.Security})},rejectLabel:Object(d.a)("Later"),onReject:()=>{P.sharedInstance().dismissUnverifiedSessions(r)}},component:m.a,priority:50})):h.a.sharedInstance().dismissToast("reviewsessions");for(const e of o)j(e);for(const e of this.displayingToastsForDeviceIds)o.has(e)||(s.a.debug("Hiding unverified session toast for "+e),I(e));this.displayingToastsForDeviceIds=o}}},1488:function(e,t,a){"use strict";a.d(t,"a",(function(){return y}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(441),c=a(370),l=a(0),d=a(90),m=a(89),h=a(128),u=a(110);class p extends o.a.Component{render(){return o.a.createElement("div",null,o.a.createElement("h2",null,Object(m.a)("Verified!")),o.a.createElement("p",null,Object(m.a)("You've successfully verified this user.")),o.a.createElement("p",null,Object(m.a)("Secure messages with this user are end-to-end encrypted and not able to be read by third parties.")),o.a.createElement(u.a,{onPrimaryButtonClick:this.props.onDone,primaryButton:Object(m.a)("Got It"),hasCancel:!1}))}}class g extends o.a.Component{render(){return o.a.createElement("div",null,o.a.createElement("p",null,Object(m.a)("The other party cancelled the verification.")),o.a.createElement(u.a,{primaryButton:Object(m.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}}var b=a(148),v=a(102),f=a(805),E=a(101);class y extends o.a.Component{constructor(e){super(e),i()(this,"showSasEvent",void 0),i()(this,"onFinished",()=>{this.props.onFinished(3===this.state.phase)}),i()(this,"onCancelClick",()=>{this.props.onFinished(3===this.state.phase)}),i()(this,"onContinueClick",()=>{this.setState({phase:2}),this.props.verifier.verify().then(()=>{this.setState({phase:3})}).catch(e=>{l.a.log("Verification failed",e)})}),i()(this,"onVerifierShowSas",e=>{this.showSasEvent=e,this.setState({phase:1,sas:e.sas})}),i()(this,"onVerifierCancel",()=>{this.setState({phase:4})}),i()(this,"onSasMatchesClick",()=>{this.showSasEvent.confirm(),this.setState({phase:2})}),i()(this,"onVerifiedDoneClick",()=>{this.props.onFinished(!0)});let t=0;this.props.verifier.hasBeenCancelled&&(l.a.log("Verifier was cancelled in the background."),t=4),this.showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null,sas:null},this.props.verifier.on(r.b.ShowSas,this.onVerifierShowSas),this.props.verifier.on(c.c.Cancel,this.onVerifierCancel),this.fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel(new Error("User cancel")),this.props.verifier.removeListener(r.b.ShowSas,this.onVerifierShowSas)}async fetchOpponentProfile(){try{const e=await d.a.get().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}renderPhaseStart(){const e=this.props.verifier.userId===d.a.get().getUserId();let t;const a=this.state.opponentProfile;if(a){const e=a.avatar_url?Object(h.b)(a.avatar_url).getSquareThumbnailHttp(48):null;t=o.a.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},o.a.createElement(b.a,{name:a.displayname,idName:this.props.verifier.userId,url:e,width:48,height:48,resizeMethod:"crop"}),o.a.createElement("h2",null,a.displayname))}else t=this.state.opponentProfileError?o.a.createElement("div",null,o.a.createElement(b.a,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,width:48,height:48}),o.a.createElement("h2",null,this.props.verifier.userId)):o.a.createElement(v.a,null);const n=[o.a.createElement("p",{key:"p1"},Object(m.a)("Verify this user to mark them as trusted. Trusting users gives you extra peace of mind when using end-to-end encrypted messages.")),o.a.createElement("p",{key:"p2"},Object(m.a)("Verifying this user will mark their session as trusted, and also mark your session as trusted to them."))],i=[o.a.createElement("p",{key:"p1"},Object(m.a)("Verify this device to mark it as trusted. Trusting this device gives you and other users extra peace of mind when using end-to-end encrypted messages.")),o.a.createElement("p",{key:"p2"},Object(m.a)("Verifying this device will mark it as trusted, and users who have verified with you will trust this device."))];return o.a.createElement("div",null,t,e?i:n,o.a.createElement(u.a,{primaryButton:Object(m.a)("Continue"),hasCancel:!0,onPrimaryButtonClick:this.onContinueClick,onCancel:this.onCancelClick}))}renderPhaseShowSas(){return o.a.createElement(f.a,{sas:this.showSasEvent.sas,onCancel:this.onCancelClick,onDone:this.onSasMatchesClick,isSelf:this.props.verifier.userId===d.a.get().getUserId(),inDialog:!0})}renderPhaseWaitForPartnerToConfirm(){return o.a.createElement("div",null,o.a.createElement(v.a,null),o.a.createElement("p",null,Object(m.a)("Waiting for partner to confirm...")))}renderPhaseVerified(){return o.a.createElement(p,{onDone:this.onVerifiedDoneClick})}renderPhaseCancelled(){return o.a.createElement(g,{onDone:this.onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this.renderPhaseStart();break;case 1:e=this.renderPhaseShowSas();break;case 2:e=this.renderPhaseWaitForPartnerToConfirm();break;case 3:e=this.renderPhaseVerified();break;case 4:e=this.renderPhaseCancelled()}return o.a.createElement(E.a,{title:Object(m.a)("Incoming Verification Request"),onFinished:this.onFinished,fixedWidth:!1},e)}}},1490:function(e,t,a){"use strict";a.d(t,"a",(function(){return g}));var n=a(87),i=a.n(n),s=a(94),o=a.n(s),r=a(98),c=a(275),l=a(89),d=a(93),m=a(122),h=a(837),u=a(816);const p=`<a href="https://matrix.org" target="_blank" rel="noreferrer noopener">\n    <img width="79" height="34" alt="Matrix" style="padding-left: 1px;vertical-align: middle" src="${a(1464).default}"/>\n</a>`;Object(l.c)("Sign in with SSO");class g extends i.a.PureComponent{render(){const e=r.b.getObject("embedded_pages");let t=null;return e&&(t=e.get("welcome_url")),t||(t="welcome.html"),i.a.createElement(c.a,null,i.a.createElement("div",{className:o()("mx_Welcome",{mx_WelcomePage_registrationDisabled:!d.b.getValue(m.b.Registration)})},i.a.createElement(u.a,{className:"mx_WelcomePage",url:t,replaceMap:{"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas",$matrixLogo:p,"[matrix]":p}}),i.a.createElement(h.a,null)))}}},1491:function(e,t,a){"use strict";a.d(t,"a",(function(){return T}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(94),c=a.n(r),l=a(0),d=a(120),m=a(89),h=a(95);class u{constructor(e,t){i()(this,"client",void 0),i()(this,"clientSecret",void 0),i()(this,"password",void 0),i()(this,"sessionId",void 0),i()(this,"logoutDevices",void 0),this.client=Object(d.createClient)({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret()}resetPassword(e,t){let a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.password=t,this.logoutDevices=a,this.client.requestPasswordEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=Object(m.a)("This email address was not found"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e,threepidCreds:e},this.password,this.logoutDevices)}catch(e){throw 401===e.httpStatus?e.message=Object(m.a)("Failed to verify email address: make sure you clicked the link in the email"):404===e.httpStatus?e.message=Object(m.a)("Your email address does not appear to be associated with a Matrix ID on this Homeserver."):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}var p,g,b=a(309),v=a(275),f=a(582),E=a(417),y=a(308),_=a(581),S=a(170),w=a(102),C=a(115),O=a(107),k=a(428),x=a(418),R=a(835),j=a(91),I=a(141);!function(e){e[e.Forgot=1]="Forgot",e[e.SendingEmail=2]="SendingEmail",e[e.EmailSent=3]="EmailSent",e[e.Done=4]="Done"}(p||(p={})),function(e){e.Email="field_email",e.Password="field_password",e.PasswordConfirm="field_password_confirm"}(g||(g={}));class T extends o.a.Component{constructor(){super(...arguments),i()(this,"reset",void 0),i()(this,"state",{phase:p.Forgot,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:"",serverSupportsControlOfDevicesLogout:!1,logoutDevices:!1}),i()(this,"onVerify",async e=>{if(e.preventDefault(),this.reset){if(!this.state.currentHttpRequest)try{await this.handleHttpRequest(this.reset.checkEmailLinkClicked()),this.setState({phase:p.Done})}catch(e){this.showErrorDialog(e.message)}}else l.a.error("onVerify called before submitPasswordReset!")}),i()(this,"onSubmitForm",async e=>{if(e.preventDefault(),this.state.currentHttpRequest)return;await this.handleHttpRequest(this.checkServerLiveliness(this.props.serverConfig));if(await this.verifyFieldsBeforeSubmit()){if(this.state.logoutDevices){const{finished:e}=h.a.createTrackedDialog("Forgot Password Warning","",C.a,{title:Object(m.a)("Warning!"),description:o.a.createElement("div",null,o.a.createElement("p",null,this.state.serverSupportsControlOfDevicesLogout?Object(m.a)("Signing out your devices will delete the message encryption keys stored on them, making encrypted chat history unreadable."):Object(m.a)("Resetting your password on this homeserver will cause all of your devices to be signed out. This will delete the message encryption keys stored on them, making encrypted chat history unreadable.")),o.a.createElement("p",null,Object(m.a)("If you want to retain access to your chat history in encrypted rooms, set up Key Backup or export your message keys from one of your other devices before proceeding."))),button:Object(m.a)("Continue")}),[t]=await e;if(!t)return}this.submitPasswordReset(this.state.email,this.state.password,this.state.logoutDevices)}}),i()(this,"onInputChanged",(e,t)=>{let a=t.currentTarget.value;"email"===e&&(a=a.trim()),this.setState({[e]:a})}),i()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()})}componentDidMount(){this.reset=null,this.checkServerLiveliness(this.props.serverConfig),this.checkServerCapabilities(this.props.serverConfig)}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||(this.checkServerLiveliness(e.serverConfig),this.checkServerCapabilities(e.serverConfig))}async checkServerLiveliness(e){try{await b.a.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.setState({serverIsAlive:!0})}catch(e){this.setState(b.a.authComponentStateForError(e,"forgot_password"))}}async checkServerCapabilities(e){const t=Object(d.createClient)({baseUrl:e.hsUrl}),a=await t.doesServerSupportLogoutDevices();this.setState({logoutDevices:!a,serverSupportsControlOfDevicesLogout:a})}submitPasswordReset(e,t){let a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.setState({phase:p.SendingEmail}),this.reset=new u(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.reset.resetPassword(e,t,a).then(()=>{this.setState({phase:p.EmailSent})},e=>{this.showErrorDialog(Object(m.a)("Failed to send email")+": "+e.message),this.setState({phase:p.Forgot})})}async verifyFieldsBeforeSubmit(){const e=[g.Email,g.Password,g.PasswordConfirm],t=[];for(const a of e){await this[a].validate({allowEmpty:!1})||t.push(this[a])}return 0===t.length||(t[0].focus(),t[0].validate({allowEmpty:!1,focused:!0}),!1)}showErrorDialog(e,t){h.a.createTrackedDialog("Forgot Password Error","",O.a,{title:t,description:e})}handleHttpRequest(e){return this.setState({currentHttpRequest:e}),e.finally(()=>{this.setState({currentHttpRequest:void 0})})}renderForgot(){let e=null;const t=this.state.errorText;let a;if(t&&(e=o.a.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=c()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});a=o.a.createElement("div",{className:e},this.state.serverDeadError)}return o.a.createElement("div",null,e,a,o.a.createElement(f.a,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange}),o.a.createElement("form",{onSubmit:this.onSubmitForm},o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(E.a,{name:"reset_email",labelRequired:Object(m.c)("The email address linked to your account must be entered."),labelInvalid:Object(m.c)("The email address doesn't appear to be valid."),value:this.state.email,fieldRef:e=>this[g.Email]=e,autoFocus:!0,onChange:this.onInputChanged.bind(this,"email")})),o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(y.a,{name:"reset_password",type:"password",label:Object(m.c)("New Password"),value:this.state.password,minScore:_.a,fieldRef:e=>this[g.Password]=e,onChange:this.onInputChanged.bind(this,"password"),autoComplete:"new-password"}),o.a.createElement(R.a,{name:"reset_password_confirm",label:Object(m.c)("Confirm"),labelRequired:Object(m.c)("A new password must be entered."),labelInvalid:Object(m.c)("New passwords must match each other."),value:this.state.password2,password:this.state.password,fieldRef:e=>this[g.PasswordConfirm]=e,onChange:this.onInputChanged.bind(this,"password2"),autoComplete:"new-password"})),this.state.serverSupportsControlOfDevicesLogout?o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(I.b,{onChange:()=>this.setState({logoutDevices:!this.state.logoutDevices}),checked:this.state.logoutDevices},Object(m.a)("Sign out all devices"))):null,o.a.createElement("span",null,Object(m.a)("A verification email will be sent to your inbox to confirm setting your new password.")),o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(m.a)("Send Reset Email")})),o.a.createElement(j.a,{kind:"link_inline",className:"mx_AuthBody_changeFlow",onClick:this.onLoginClick},Object(m.a)("Sign in instead")))}renderSendingEmail(){return o.a.createElement(w.a,null)}renderEmailSent(){return o.a.createElement("div",null,Object(m.a)("An email has been sent to %(emailAddress)s. Once you've followed the link it contains, click below.",{emailAddress:this.state.email}),o.a.createElement("br",null),o.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.onVerify,value:Object(m.a)("I have verified my email address")}),this.state.currentHttpRequest&&o.a.createElement("div",{className:"mx_Login_spinner"},o.a.createElement(S.a,{w:64,h:64})))}renderDone(){return o.a.createElement("div",null,o.a.createElement("p",null,Object(m.a)("Your password has been reset.")),this.state.logoutDevices?o.a.createElement("p",null,Object(m.a)("You have been logged out of all devices and will no longer receive push notifications. To re-enable notifications, sign in again on each device.")):null,o.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:Object(m.a)("Return to login screen")}))}render(){let e;switch(this.state.phase){case p.Forgot:e=this.renderForgot();break;case p.SendingEmail:e=this.renderSendingEmail();break;case p.EmailSent:e=this.renderEmailSent();break;case p.Done:e=this.renderDone();break;default:e=o.a.createElement("div",{className:"mx_Login_spinner"},o.a.createElement(S.a,{w:64,h:64}))}return o.a.createElement(v.a,null,o.a.createElement(k.a,null),o.a.createElement(x.a,null,o.a.createElement("h2",null," ",Object(m.a)("Set a new password")," "),e))}}},1492:function(e,t,a){"use strict";a.d(t,"a",(function(){return E}));var n=a(87),i=a.n(n),s=a(275),o=a(836),r=a(88),c=a.n(r),l=a(0),d=a(90),m=a(89),h=a(95),u=a(272),p=a(110),g=a(101),b=a(102),v=a(227);class f extends i.a.PureComponent{constructor(e){super(e),c()(this,"doBootstrapUIAuth",async e=>{if(this.state.canUploadKeysWithPasswordOnly&&this.state.accountPassword)e({type:"m.login.password",identifier:{type:"m.id.user",user:d.a.get().getUserId()},user:d.a.get().getUserId(),password:this.state.accountPassword});else if(this.props.tokenLogin)e({});else{const t={[u.c.PHASE_PREAUTH]:{title:Object(m.a)("Use Single Sign On to continue"),body:Object(m.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(m.a)("Single Sign On"),continueKind:"primary"},[u.c.PHASE_POSTAUTH]:{title:Object(m.a)("Confirm encryption setup"),body:Object(m.a)("Click the button below to confirm setting up encryption."),continueText:Object(m.a)("Confirm"),continueKind:"primary"}},{finished:a}=h.a.createTrackedDialog("Cross-signing keys dialog","",v.a,{title:Object(m.a)("Setting up keys"),matrixClient:d.a.get(),makeRequest:e,aestheticsForStagePhases:{[u.c.LOGIN_TYPE]:t,[u.c.UNSTABLE_LOGIN_TYPE]:t}}),[n]=await a;if(!n)throw new Error("Cross-signing key upload auth canceled")}}),c()(this,"bootstrapCrossSigning",async()=>{this.setState({error:null});const e=d.a.get();try{await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:this.doBootstrapUIAuth}),this.props.onFinished(!0)}catch(e){if(this.props.tokenLogin)return void this.props.onFinished(!1);this.setState({error:e}),l.a.error("Error bootstrapping cross-signing",e)}}),c()(this,"onCancel",()=>{this.props.onFinished(!1)}),this.state={error:null,canUploadKeysWithPasswordOnly:!!e.accountPassword||null,accountPassword:e.accountPassword||""},this.state.accountPassword||this.queryKeyUploadAuth()}componentDidMount(){this.bootstrapCrossSigning()}async queryKeyUploadAuth(){try{await d.a.get().uploadDeviceSigningKeys(null,{}),l.a.log("uploadDeviceSigningKeys unexpectedly succeeded without UI auth!")}catch(e){if(!e.data||!e.data.flows)return void l.a.log("uploadDeviceSigningKeys advertised no flows!");const t=e.data.flows.some(e=>1===e.stages.length&&"m.login.password"===e.stages[0]);this.setState({canUploadKeysWithPasswordOnly:t})}}render(){let e;return e=this.state.error?i.a.createElement("div",null,i.a.createElement("p",null,Object(m.a)("Unable to set up keys")),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement(p.a,{primaryButton:Object(m.a)("Retry"),onPrimaryButtonClick:this.bootstrapCrossSigning,onCancel:this.onCancel}))):i.a.createElement("div",null,i.a.createElement(b.a,null)),i.a.createElement(g.a,{className:"mx_CreateCrossSigningDialog",onFinished:this.props.onFinished,title:Object(m.a)("Setting up keys"),hasCancel:!1,fixedWidth:!1},i.a.createElement("div",null,e))}}class E extends i.a.Component{render(){return i.a.createElement(s.a,null,i.a.createElement(o.a,null,i.a.createElement(f,{onFinished:this.props.onFinished,accountPassword:this.props.accountPassword,tokenLogin:this.props.tokenLogin})))}}},1493:function(e,t,a){"use strict";a.d(t,"a",(function(){return P}));var n=a(88),i=a.n(n),s=a(120),o=a(87),r=a.n(o),c=a(94),l=a.n(c),d=a(0),m=a(89),h=a(348),u=a(309),p=a(413),g=a(90),b=a(275),v=a(352),f=a(92),E=a(568),y=a(582),_=a(581),S=a(91),w=a(418),C=a(428),O=a(450),k=a(102),x=a(451);function R(e){var t,a;let{title:n,icon:i,serverPicker:s,children:c}=e;const l=Object(o.useContext)(x.a);if(!l)return null;const d=l.state.length?l.state[0]:null;return r.a.createElement(o.Fragment,null,null!==(t=null==d?void 0:d.icon)&&void 0!==t?t:i,r.a.createElement("h2",null,null!==(a=null==d?void 0:d.title)&&void 0!==a?a:n),c,!0!==(null==d?void 0:d.hideServerPicker)&&s)}var j=a(621),I=a(93);function T(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}const N=function(){if(I.b.getValue("debug_registration")){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];d.a.log.call(console,"Registration debuglog:",...t)}};class P extends r.a.Component{constructor(e){super(e),i()(this,"loginLogic",void 0),i()(this,"latestServerConfig",void 0),i()(this,"unloadCallback",e=>{if(this.state.doingUIAuth)return e.preventDefault(),e.returnValue="",""}),i()(this,"onFormSubmit",async e=>{this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0})}),i()(this,"requestEmailToken",(e,t,a,n)=>this.state.matrixClient.requestRegisterEmailToken(e,t,a,this.props.makeRegistrationUrl({client_secret:t,hs_url:this.state.matrixClient.getHomeserverUrl(),is_url:this.state.matrixClient.getIdentityServerUrl(),session_id:n}))),i()(this,"onUIAuthFinished",async(e,t)=>{if(N("Registration: ui authentication finished: ",{success:e,response:t}),!e){let e=t.message||t.toString();if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const a=Object(h.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(m.c)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(m.c)("This homeserver has been blocked by its administrator."),"":Object(m.c)("This homeserver has exceeded one of its resource limits.")}),n=Object(h.a)(t.data.limit_type,t.data.admin_contact,{"":Object(m.c)("Please <a>contact your service administrator</a> to continue using this service.")});e=r.a.createElement("div",null,r.a.createElement("p",null,a),r.a.createElement("p",null,n))}else if(t.required_stages&&t.required_stages.includes(s.AuthType.Msisdn)){let a=!1;for(const e of t.available_flows)a=a||e.stages.includes(s.AuthType.Msisdn);a||(e=Object(m.a)("This server does not support authentication with a phone number."))}else"M_USER_IN_USE"===t.errcode?e=Object(m.a)("Someone already has that username, please try another."):"M_THREEPID_IN_USE"===t.errcode&&(e=Object(m.a)("That e-mail address is already in use."));return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}g.a.setJustRegisteredUserId(t.user_id);const a={doingUIAuth:!1,registeredUsername:t.user_id,differentLoggedInUserId:null,completedNoSignin:!1,busy:!0},[n,i]=await p.b();n&&!i&&n!==t.user_id&&(d.a.log(`Found a session for ${n} but ${t.user_id} has just registered.`),a.differentLoggedInUserId=n);const o=Boolean(this.state.formVals.email),c=Boolean(t.access_token);N("Registration: ui auth finished:",{hasEmail:o,hasAccessToken:c}),!o&&c?(await this.props.onLoggedIn({userId:t.user_id,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:t.access_token},this.state.formVals.password),this.setupPushers()):(a.busy=!1,a.completedNoSignin=!0),this.setState(a)}),i()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()}),i()(this,"onGoToFormClicked",e=>{e.preventDefault(),e.stopPropagation(),this.replaceClient(this.props.serverConfig),this.setState({busy:!1,doingUIAuth:!1})}),i()(this,"makeRegisterRequest",e=>{const t={username:this.state.formVals.username,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName,auth:void 0,inhibit_login:void 0};return e&&(t.auth=e),N("Registration: sending registration request:",e),this.state.matrixClient.registerRequest(t)}),i()(this,"onLoginClickWithCheck",async e=>{e.preventDefault();const t=await p.h({ignoreGuest:!0});return t||this.props.onLoginClick(),t}),this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""};const{hsUrl:t,isUrl:a}=this.props.serverConfig;this.loginLogic=new v.b(t,a,null,{defaultDeviceDisplayName:"Element login check"})}componentDidMount(){this.replaceClient(this.props.serverConfig),window.addEventListener("beforeunload",this.unloadCallback)}componentWillUnmount(){window.removeEventListener("beforeunload",this.unloadCallback)}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.replaceClient(e.serverConfig)}async replaceClient(e){this.latestServerConfig=e;const{hsUrl:t,isUrl:a}=e;this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0});try{if(await u.a.validateServerConfigWithStaticUrls(t,a),e!==this.latestServerConfig)return;this.setState({serverIsAlive:!0,serverErrorIsFatal:!1})}catch(t){if(e!==this.latestServerConfig)return;if(this.setState(function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?T(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):T(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({busy:!1},u.a.authComponentStateForError(t,"register"))),this.state.serverErrorIsFatal)return}const n=Object(s.createClient)({baseUrl:t,idBaseUrl:a});let o;this.loginLogic.setHomeserverUrl(t),this.loginLogic.setIdentityServerUrl(a);try{const t=await this.loginLogic.getFlows();if(e!==this.latestServerConfig)return;o=t.find(e=>"m.login.sso"===e.type||"m.login.cas"===e.type)}catch(t){if(e!==this.latestServerConfig)return;d.a.error("Failed to get login flows to check for SSO support",t)}this.setState({matrixClient:n,ssoFlow:o,busy:!1});try{if(!this.state.doingUIAuth){if(await this.makeRegisterRequest(null),e!==this.latestServerConfig)return;d.a.log("Expecting 401 from register request but got success!")}}catch(t){if(e!==this.latestServerConfig)return;401===t.httpStatus?this.setState({flows:t.data.flows}):403===t.httpStatus||"M_FORBIDDEN"===t.errcode?o?f.a.dispatch({action:"start_login"}):this.setState({serverErrorIsFatal:!0,errorText:Object(m.a)("Registration has been disabled on this homeserver."),flows:[]}):(d.a.log("Unable to query for supported registration methods.",t),this.setState({errorText:Object(m.a)("Unable to query for supported registration methods."),flows:[]}))}}setupPushers(){if(!this.props.brand)return Promise.resolve();const e=g.a.get();return e.getPushers().then(t=>{const a=t.pushers;for(let t=0;t<a.length;++t)if("email"===a[t].kind){const n=a[t];n.data={brand:this.props.brand},e.setPusher(n).then(()=>{d.a.log("Set email branding to "+this.props.brand)},e=>{d.a.error("Couldn't set email branding: "+e)})}},e=>{d.a.error("Couldn't get pushers: "+e)})}getUIAuthInputs(){return{emailAddress:this.state.formVals.email,phoneCountry:this.state.formVals.phoneCountry,phoneNumber:this.state.formVals.phoneNumber}}renderRegisterComponent(){if(this.state.matrixClient&&this.state.doingUIAuth)return r.a.createElement(O.b,{matrixClient:this.state.matrixClient,makeRequest:this.makeRegisterRequest,onAuthFinished:this.onUIAuthFinished,inputs:this.getUIAuthInputs(),requestEmailToken:this.requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0});if(!this.state.matrixClient&&!this.state.busy)return null;if(this.state.busy||!this.state.flows)return r.a.createElement("div",{className:"mx_AuthBody_spinner"},r.a.createElement(k.a,null));if(this.state.flows.length){let e;if(this.state.ssoFlow){let t;(this.state.ssoFlow.identity_providers||[]).length>1&&(t=r.a.createElement("h3",{className:"mx_AuthBody_centered"},Object(m.a)("Continue with %(ssoButtons)s",{ssoButtons:""}).trim())),e=r.a.createElement(r.a.Fragment,null,t,r.a.createElement(E.a,{matrixClient:this.loginLogic.createTemporaryClient(),flow:this.state.ssoFlow,loginType:"m.login.sso"===this.state.ssoFlow.type?"sso":"cas",fragmentAfterLogin:this.props.fragmentAfterLogin}),r.a.createElement("h3",{className:"mx_AuthBody_centered"},Object(m.a)("%(ssoButtons)s Or %(usernamePassword)s",{ssoButtons:"",usernamePassword:""}).trim()))}return r.a.createElement(r.a.Fragment,null,e,r.a.createElement(_.b,{defaultUsername:this.state.formVals.username,defaultEmail:this.state.formVals.email,defaultPhoneCountry:this.state.formVals.phoneCountry,defaultPhoneNumber:this.state.formVals.phoneNumber,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,flows:this.state.flows,serverConfig:this.props.serverConfig,canSubmit:!this.state.serverErrorIsFatal,matrixClient:this.state.matrixClient}))}}render(){let e;const t=this.state.errorText;let a;if(t&&(e=r.a.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=l()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});a=r.a.createElement("div",{className:e},this.state.serverDeadError)}const n=r.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(m.a)("Already have an account? <a>Sign in here</a>",{},{a:e=>r.a.createElement(S.a,{kind:"link_inline",onClick:this.onLoginClick},e)}));let i,s;if(this.state.doingUIAuth&&(i=r.a.createElement(S.a,{kind:"link_inline",className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked},Object(m.a)("Go back"))),this.state.completedNoSignin){let e;e=this.state.differentLoggedInUserId?r.a.createElement("div",null,r.a.createElement("p",null,Object(m.a)("Your new account (%(newAccountId)s) is registered, but you're already logged into a different account (%(loggedInUserId)s).",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),r.a.createElement("p",null,r.a.createElement(S.a,{element:"span",className:"mx_linkButton",onClick:async e=>{await this.onLoginClickWithCheck(e)&&f.a.dispatch({action:"view_welcome_page"})}},Object(m.a)("Continue with previous account")))):r.a.createElement("h3",null,Object(m.a)("<a>Log in</a> to your new account.",{},{a:e=>r.a.createElement(S.a,{element:"span",className:"mx_linkButton",onClick:async e=>{await this.onLoginClickWithCheck(e)&&f.a.dispatch({action:"view_home_page"})}},e)})),s=r.a.createElement("div",null,r.a.createElement("h2",null,Object(m.a)("Registration Successful")),e)}else s=r.a.createElement(o.Fragment,null,r.a.createElement("div",{className:"mx_Register_mainContent"},r.a.createElement(R,{title:Object(m.a)("Create account"),serverPicker:r.a.createElement(y.a,{title:Object(m.a)("Host account on"),dialogTitle:Object(m.a)("Decide where your account is hosted"),serverConfig:this.props.serverConfig,onServerConfigChange:this.state.doingUIAuth?void 0:this.props.onServerConfigChange})},e,a),this.renderRegisterComponent()),r.a.createElement("div",{className:"mx_Register_footerActions"},i,n));return r.a.createElement(b.a,null,r.a.createElement(C.a,null),r.a.createElement(j.b,null,r.a.createElement(w.a,{flex:!0},s)))}}},1494:function(e,t,a){"use strict";a.d(t,"a",(function(){return D}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(94),c=a.n(r),l=a(0),d=a(89),m=a(352),h=a(98),u=a(348),p=a(309),g=a(275),b=a(126),v=a(93),f=a(122),E=a(91),y=a(169),_=a(105),S=a(567),w=a(417);const C=/^[0-9()\-\s]*$/;var O;!function(e){e.Email="login_field_email",e.MatrixId="login_field_mxid",e.Phone="login_field_phone",e.Password="login_field_phone"}(O||(O={}));class k extends o.a.PureComponent{constructor(e){super(e),i()(this,"onForgotPasswordClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onForgotPasswordClick()}),i()(this,"onSubmitForm",async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return;let t="",a=null,n=null;switch(this.state.loginType){case O.Email:case O.MatrixId:t=this.props.username;break;case O.Phone:a=this.props.phoneCountry,n=this.props.phoneNumber}this.props.onSubmit(t,a,n,this.state.password)}),i()(this,"onUsernameChanged",e=>{this.props.onUsernameChanged(e.target.value)}),i()(this,"onUsernameBlur",e=>{this.props.onUsernameBlur(e.target.value)}),i()(this,"onLoginTypeChange",e=>{const t=e.target.value;this.setState({loginType:t}),this.props.onUsernameChanged("")}),i()(this,"onPhoneCountryChanged",e=>{this.props.onPhoneCountryChanged(e.iso2)}),i()(this,"onPhoneNumberChanged",e=>{this.props.onPhoneNumberChanged(e.target.value)}),i()(this,"onPasswordChanged",e=>{this.setState({password:e.target.value})}),i()(this,"validateUsernameRules",Object(y.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(d.a)("Enter username")}]})),i()(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(O.MatrixId,t.valid),t}),i()(this,"onEmailValidate",e=>{this.markFieldValid(O.Email,e.valid)}),i()(this,"validatePhoneNumberRules",Object(y.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(d.a)("Enter phone number")},{key:"number",test:e=>{let{value:t}=e;return!t||C.test(t)},invalid:()=>Object(d.a)("That phone number doesn't look quite right, please check and try again")}]})),i()(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(O.Password,t.valid),t}),i()(this,"validatePasswordRules",Object(y.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(d.a)("Enter password")}]})),i()(this,"onPasswordValidate",async e=>{const t=await this.validatePasswordRules(e);return this.markFieldValid(O.Password,t.valid),t}),this.state={fieldValid:{},loginType:O.MatrixId,password:""}}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[this.state.loginType,O.Password];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const a=this.findFirstInvalidField(t);return!a||(a.focus(),a.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:a}=this.state;a[e]=t,this.setState({fieldValid:a})}renderLoginField(e,t){const a={error:!1};switch(e){case O.Email:return a.error=this.props.loginIncorrect&&!this.props.username,o.a.createElement(w.a,{id:"mx_LoginForm_email",className:c()(a),name:"username",autoComplete:"email",type:"email",key:"email_input",placeholder:"joe@example.com",value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onEmailValidate,fieldRef:e=>this[O.Email]=e});case O.MatrixId:return a.error=this.props.loginIncorrect&&!this.props.username,o.a.createElement(_.a,{id:"mx_LoginForm_username",className:c()(a),name:"username",autoComplete:"username",key:"username_input",type:"text",label:Object(d.a)("Username"),placeholder:Object(d.a)("Username").toLocaleLowerCase(),value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onUsernameValidate,ref:e=>this[O.MatrixId]=e});case O.Phone:{a.error=this.props.loginIncorrect&&!this.props.phoneNumber;const e=o.a.createElement(S.a,{value:this.props.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChanged});return o.a.createElement(_.a,{id:"mx_LoginForm_phone",className:c()(a),name:"phoneNumber",autoComplete:"tel-national",key:"phone_input",type:"text",label:Object(d.a)("Phone"),value:this.props.phoneNumber,prefixComponent:e,onChange:this.onPhoneNumberChanged,disabled:this.props.busy,autoFocus:t,onValidate:this.onPhoneNumberValidate,ref:e=>this[O.Password]=e})}}}isLoginEmpty(){switch(this.state.loginType){case O.Email:case O.MatrixId:return!this.props.username;case O.Phone:return!this.props.phoneCountry||!this.props.phoneNumber}}render(){let e;this.props.onForgotPasswordClick&&(e=o.a.createElement(E.a,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},Object(d.a)("Forgot password?")));const t=c()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),a=!this.isLoginEmpty(),n=this.renderLoginField(this.state.loginType,!a);let i;return h.b.get().disable_3pid_login||(i=o.a.createElement("div",{className:"mx_Login_type_container"},o.a.createElement("label",{className:"mx_Login_type_label"},Object(d.a)("Sign in with")),o.a.createElement(_.a,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.busy},o.a.createElement("option",{key:O.MatrixId,value:O.MatrixId},Object(d.a)("Username")),o.a.createElement("option",{key:O.Email,value:O.Email},Object(d.a)("Email address")),o.a.createElement("option",{key:O.Password,value:O.Password},Object(d.a)("Phone"))))),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onSubmitForm},i,n,o.a.createElement(_.a,{id:"mx_LoginForm_password",className:t,autoComplete:"password",type:"password",name:"password",label:Object(d.a)("Password"),value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.busy,autoFocus:a,onValidate:this.onPasswordValidate,ref:e=>this[O.Password]=e}),e,!this.props.busy&&o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(d.a)("Sign in"),disabled:this.props.disableSubmit})))}}i()(k,"defaultProps",{onUsernameChanged:function(){},onUsernameBlur:function(){},onPhoneCountryChanged:function(){},onPhoneNumberChanged:function(){},loginIncorrect:!1,disableSubmit:!1});var x=a(170),R=a(102),j=a(568),I=a(582),T=a(418),N=a(428);function P(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function M(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?P(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):P(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}Object(d.c)("Invalid homeserver discovery response"),Object(d.c)("Failed to get autodiscovery configuration from server"),Object(d.c)("Invalid base_url for m.homeserver"),Object(d.c)("Homeserver URL does not appear to be a valid Matrix homeserver"),Object(d.c)("Invalid identity server discovery response"),Object(d.c)("Invalid base_url for m.identity_server"),Object(d.c)("Identity server URL does not appear to be a valid identity server"),Object(d.c)("General failure");class D extends o.a.PureComponent{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"loginLogic",void 0),i()(this,"stepRendererMap",void 0),i()(this,"isBusy",()=>this.state.busy||this.props.busy),i()(this,"onPasswordLogin",async(e,t,a,n)=>{if(!this.state.serverIsAlive){this.setState({busy:!0});let e=!0;try{await p.a.validateServerConfigWithStaticUrls(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.setState({serverIsAlive:!0,errorText:""})}catch(t){const a=p.a.authComponentStateForError(t);this.setState(M({busy:!1,busyLoggingIn:!1},a)),e=!a.serverErrorIsFatal}if(!e)return}this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1}),this.loginLogic.loginViaPassword(e,t,a,n).then(e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e,n)},t=>{if(this.unmounted)return;let a;const n=e.indexOf("@")>0;if(400===t.httpStatus&&n)a=Object(d.a)("This homeserver does not support login using email address.");else if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const e=Object(u.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(d.c)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(d.c)("This homeserver has been blocked by its administrator."),"":Object(d.c)("This homeserver has exceeded one of its resource limits.")}),n=Object(u.a)(t.data.limit_type,t.data.admin_contact,{"":Object(d.c)("Please <a>contact your service administrator</a> to continue using this service.")});a=o.a.createElement("div",null,o.a.createElement("div",null,e),o.a.createElement("div",{className:"mx_Login_smallError"},n))}else a=401===t.httpStatus||403===t.httpStatus?"M_USER_DEACTIVATED"===t.errcode?Object(d.a)("This account has been deactivated."):h.b.get("disable_custom_urls")?o.a.createElement("div",null,o.a.createElement("div",null,Object(d.a)("Incorrect username and/or password.")),o.a.createElement("div",{className:"mx_Login_smallError"},Object(d.a)("Please note you are logging into the %(hs)s server, not matrix.org.",{hs:this.props.serverConfig.hsName}))):Object(d.a)("Incorrect username and/or password."):this.errorTextFromError(t);this.setState({busy:!1,busyLoggingIn:!1,errorText:a,loginIncorrect:401===t.httpStatus||403===t.httpStatus})})}),i()(this,"onUsernameChanged",e=>{this.setState({username:e})}),i()(this,"onUsernameBlur",async e=>{const t="@"===e[0];if(this.setState({username:e,busy:t,errorText:null,canTryLogin:!0}),t){const t=e.split(":").slice(1).join(":");try{const e=await p.a.validateServerName(t);this.props.onServerConfigChange(e),this.setState({busy:!1})}catch(e){l.a.error("Problem parsing URL or unhandled error doing .well-known discovery:",e);let t=Object(d.a)("Failed to perform homeserver discovery");e.translatedMessage&&(t=e.translatedMessage);let a=t,n={};p.a.isLivelinessError(e)&&(a=this.state.errorText,n=p.a.authComponentStateForError(e)),this.setState(M({busy:!1,errorText:a},n))}}}),i()(this,"onPhoneCountryChanged",e=>{this.setState({phoneCountry:e})}),i()(this,"onPhoneNumberChanged",e=>{this.setState({phoneNumber:e})}),i()(this,"onRegisterClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()}),i()(this,"onTryRegisterClick",e=>{var t,a;const n=null===(t=this.state.flows)||void 0===t?void 0:t.find(e=>"m.login.password"===e.type),i=null===(a=this.state.flows)||void 0===a?void 0:a.find(e=>"m.login.sso"===e.type||"m.login.cas"===e.type);if(i&&!n){e.preventDefault(),e.stopPropagation();const t="m.login.sso"===i.type?"sso":"cas";b.a.get().startSingleSignOn(this.loginLogic.createTemporaryClient(),t,this.props.fragmentAfterLogin)}else this.onRegisterClick(e)}),i()(this,"isSupportedFlow",e=>!!this.stepRendererMap[e.type]||(l.a.log("Skipping flow",e,"due to unsupported login type",e.type),!1)),i()(this,"renderPasswordStep",()=>o.a.createElement(k,{onSubmit:this.onPasswordLogin,username:this.state.username,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onPhoneCountryChanged:this.onPhoneCountryChanged,onPhoneNumberChanged:this.onPhoneNumberChanged,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:this.props.serverConfig,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn})),i()(this,"renderSsoStep",e=>{const t=this.state.flows.find(t=>t.type==="m.login."+e);return o.a.createElement(j.a,{matrixClient:this.loginLogic.createTemporaryClient(),flow:t,loginType:e,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find(e=>"m.login.password"===e.type)})}),this.state={busy:!1,busyLoggingIn:null,errorText:null,loginIncorrect:!1,canTryLogin:!0,flows:null,username:e.defaultUsername?e.defaultUsername:"",phoneCountry:null,phoneNumber:"",serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.stepRendererMap={"m.login.password":this.renderPasswordStep,"m.login.cas":()=>this.renderSsoStep("cas"),"m.login.sso":()=>this.renderSsoStep("sso")}}UNSAFE_componentWillMount(){this.initLoginLogic(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.initLoginLogic(e.serverConfig)}async initLoginLogic(e){let{hsUrl:t,isUrl:a}=e,n=!1;this.props.serverConfig.isDefault&&t===this.props.serverConfig.hsUrl&&a===this.props.serverConfig.isUrl&&(n=!0);const i=n?this.props.fallbackHsUrl:null,s=new m.b(t,a,i,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName});this.loginLogic=s,this.setState({busy:!0,loginIncorrect:!1});try{const{warning:e}=await p.a.validateServerConfigWithStaticUrls(t,a);e?this.setState(M(M({},p.a.authComponentStateForError(e)),{},{errorText:""})):this.setState({serverIsAlive:!0,errorText:""})}catch(e){this.setState(M({busy:!1},p.a.authComponentStateForError(e)))}s.getFlows().then(e=>{const t=e.filter(this.isSupportedFlow);t.length>0?this.setState({flows:t}):this.setState({errorText:Object(d.a)("This homeserver doesn't offer any login flows which are supported by this client.")})},e=>{this.setState({errorText:this.errorTextFromError(e),loginIncorrect:!1,canTryLogin:!1})}).finally(()=>{this.setState({busy:!1})})}errorTextFromError(e){let t=e.errcode;!t&&e.httpStatus&&(t="HTTP "+e.httpStatus);let a=Object(d.a)("There was a problem communicating with the homeserver, please try again later.")+(t?" ("+t+")":"");return"rejected"===e.cors&&(a="https:"!==window.location.protocol||!this.props.serverConfig.hsUrl.startsWith("http:")&&this.props.serverConfig.hsUrl.startsWith("http")?o.a.createElement("span",null,Object(d.a)("Can't connect to homeserver - please check your connectivity, ensure your <a>homeserver's SSL certificate</a> is trusted, and that a browser extension is not blocking requests.",{},{a:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:this.props.serverConfig.hsUrl},e)})):o.a.createElement("span",null,Object(d.a)("Can't connect to homeserver via HTTP when an HTTPS URL is in your browser bar. Either use HTTPS or <a>enable unsafe scripts</a>.",{},{a:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://www.google.com/search?&q=enable%20unsafe%20scripts"},e)}))),a}renderLoginComponentForFlows(){if(!this.state.flows)return null;const e=["m.login.password","m.login.sso"].map(e=>this.state.flows.find(t=>t.type===e)).filter(Boolean);return o.a.createElement(o.a.Fragment,null,e.map(e=>{const t=this.stepRendererMap[e.type];return o.a.createElement(o.a.Fragment,{key:e.type},t())}))}render(){const e=this.isBusy()&&!this.state.busyLoggingIn?o.a.createElement("div",{className:"mx_Login_loader"},o.a.createElement(R.a,null)):null,t=this.state.errorText;let a,n,i;if(t&&(a=o.a.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=c()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});n=o.a.createElement("div",{className:e},this.state.serverDeadError)}return this.props.isSyncing||this.state.busyLoggingIn?i=o.a.createElement("div",{className:"mx_AuthBody_paddedFooter"},o.a.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},o.a.createElement(x.a,{w:20,h:20}),this.props.isSyncing?Object(d.a)("Syncing..."):Object(d.a)("Signing In...")),this.props.isSyncing&&o.a.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},Object(d.a)("If you've joined lots of rooms, this might take a while"))):v.b.getValue(f.b.Registration)&&(i=o.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(d.a)("New? <a>Create account</a>",{},{a:e=>o.a.createElement(E.a,{kind:"link_inline",onClick:this.onTryRegisterClick},e)}))),o.a.createElement(g.a,null,o.a.createElement(N.a,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),o.a.createElement(T.a,null,o.a.createElement("h2",null,Object(d.a)("Sign in"),e),a,n,o.a.createElement(I.a,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange}),this.renderLoginComponentForFlows(),i))}}},1495:function(e,t,a){"use strict";a.d(t,"b",(function(){return r})),a.d(t,"a",(function(){return o}));var n=a(88),i=a.n(n),s=a(0);let o;!function(e){e.APP_STARTUP="mx_AppStartup",e.PAGE_CHANGE="mx_PageChange",e.RESEND_EVENT="mx_ResendEvent",e.SEND_E2EE_EVENT="mx_SendE2EEEvent",e.SEND_ATTACHMENT="mx_SendAttachment",e.SWITCH_ROOM="mx_SwithRoom",e.JUMP_TO_ROOM="mx_JumpToRoom",e.JOIN_ROOM="mx_JoinRoom",e.CREATE_DM="mx_CreateDM",e.PEEK_ROOM="mx_PeekRoom",e.VERIFY_E2EE_USER="mx_VerifyE2EEUser",e.LOGIN="mx_Login",e.REGISTER="mx_Register",e.SETUP_VOIP_CALL="mx_SetupVoIPCall"}(o||(o={}));class r{constructor(){i()(this,"START_PREFIX","start:"),i()(this,"STOP_PREFIX","stop:"),i()(this,"listeners",[]),i()(this,"entries",[])}static get instance(){return r._instance||(r._instance=new r),r._instance}start(e,t){if(!this.supportsPerformanceApi())return;const a=this.buildKey(e,t);performance.getEntriesByName(this.START_PREFIX+a).length>0?s.a.warn("Recording already started for: "+e):performance.mark(this.START_PREFIX+a)}stop(e,t){if(!this.supportsPerformanceApi())return;const a=this.buildKey(e,t);if(0===performance.getEntriesByName(this.START_PREFIX+a).length)return void s.a.warn("No recording started for: "+e);performance.mark(this.STOP_PREFIX+a),performance.measure(a,this.START_PREFIX+a,this.STOP_PREFIX+a),this.clear(e,t);const n=performance.getEntriesByName(a).pop();return this.entries.push(n),this.listeners.forEach(e=>{this.shouldEmit(e,n)&&e.callback([n])}),n}clear(e,t){if(!this.supportsPerformanceApi())return;const a=this.buildKey(e,t);performance.clearMarks(this.START_PREFIX+a),performance.clearMarks(this.STOP_PREFIX+a)}getEntries(){let{name:e,type:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.entries.filter(a=>{const n=!e||a.name===e,i=!t||a.entryType===t;return n&&i})}addPerformanceDataCallback(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.listeners.push(e),t){const t=this.entries.filter(t=>this.shouldEmit(e,t));t.length>0&&e.callback(t)}}removePerformanceDataCallback(e){e?this.listeners.splice(this.listeners.findIndex(t=>t.callback===e),1):this.listeners=[]}supportsPerformanceApi(){return void 0!==performance&&void 0!==performance.mark}shouldEmit(e,t){return!e.entryNames||e.entryNames.includes(t.name)}buildKey(e,t){return`${e}${t?":"+t:""}`}}i()(r,"_instance",void 0),window.mxPerformanceMonitor=r.instance,window.mxPerformanceEntryNames=o},1496:function(e,t,a){"use strict";a.d(t,"a",(function(){return x}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(0),c=a(89),l=a(92),d=a(413),m=a(95),h=a(90),u=a(352),p=a(275),g=a(307),b=a(568),v=a(101),f=a(110);class E extends o.a.Component{constructor(){super(...arguments),i()(this,"onConfirm",()=>{this.props.onFinished(!0)}),i()(this,"onDecline",()=>{this.props.onFinished(!1)})}render(){return o.a.createElement(v.a,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Clear all data in this session?")},o.a.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},o.a.createElement("p",null,Object(c.a)("Clearing all data from this session is permanent. Encrypted messages will be lost unless their keys have been backed up."))),o.a.createElement(f.a,{primaryButton:Object(c.a)("Clear all data"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this.onDecline}))}}var y,_=a(105),S=a(91),w=a(102),C=a(428),O=a(418);!function(e){e[e.Loading=0]="Loading",e[e.Password=1]="Password",e[e.CAS=2]="CAS",e[e.SSO=3]="SSO",e[e.PasswordWithSocialSignOn=4]="PasswordWithSocialSignOn",e[e.Unsupported=5]="Unsupported"}(y||(y={}));const k={"m.login.password":y.Password,"m.login.cas":y.CAS,"m.login.sso":y.SSO};class x extends o.a.Component{constructor(e){super(e),i()(this,"onClearAll",()=>{m.a.createTrackedDialog("Clear Data","Soft Logout",E,{onFinished:e=>{e&&(r.a.log("Clearing data from soft-logged-out session"),d.i())}})}),i()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),i()(this,"onForgotPassword",()=>{l.a.dispatch({action:"start_password_recovery"})}),i()(this,"onPasswordLogin",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const t=h.a.get().getHomeserverUrl(),a=h.a.get().getIdentityServerUrl(),n={identifier:{type:"m.id.user",user:h.a.get().getUserId()},password:this.state.password,device_id:h.a.get().getDeviceId()};let i=null;try{i=await Object(u.c)(t,a,"m.login.password",n)}catch(e){let t=Object(c.a)("Failed to re-authenticate due to a homeserver problem");return"M_FORBIDDEN"!==e.errcode||401!==e.httpStatus&&403!==e.httpStatus||(t=Object(c.a)("Incorrect password")),void this.setState({busy:!1,errorText:t})}d.e(i).catch(e=>{r.a.error(e),this.setState({busy:!1,errorText:Object(c.a)("Failed to re-authenticate")})})}),this.state={loginView:y.Loading,keyBackupNeeded:!0,busy:!1,password:"",errorText:"",flows:[]}}componentDidMount(){if(!d.g())return void l.a.dispatch({action:"start_login"});this.initLogin();const e=h.a.get();e.isCryptoEnabled()&&e.countSessionsNeedingBackup().then(e=>{this.setState({keyBackupNeeded:e>0})})}async initLogin(){const e=this.props.realQueryParams;if(e&&e.loginToken)return this.setState({loginView:y.Loading}),void this.trySsoLogin();const t=h.a.get(),a=(await t.loginFlows()).flows,n=a.map(e=>k[e.type]),i=n.includes(y.Password)&&n.includes(y.SSO),s=n.filter(e=>!!e)[0]||y.Unsupported,o=i?y.PasswordWithSocialSignOn:s;this.setState({flows:a,loginView:o})}async trySsoLogin(){this.setState({busy:!0});const e=localStorage.getItem(g.a),t=localStorage.getItem(g.c)||h.a.get().getIdentityServerUrl(),a={token:this.props.realQueryParams.loginToken,device_id:h.a.get().getDeviceId()};let n=null;try{n=await Object(u.c)(e,t,"m.login.token",a)}catch(e){return r.a.error(e),void this.setState({busy:!1,loginView:y.Unsupported})}d.e(n).then(()=>{this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted()}).catch(e=>{r.a.error(e),this.setState({busy:!1,loginView:y.Unsupported})})}renderPasswordForm(e){let t=null;return this.state.errorText&&(t=o.a.createElement("span",{className:"mx_Login_error"},this.state.errorText)),o.a.createElement("form",{onSubmit:this.onPasswordLogin},e?o.a.createElement("p",null,e):null,t,o.a.createElement(_.a,{type:"password",label:Object(c.a)("Password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),o.a.createElement(S.a,{onClick:this.onPasswordLogin,kind:"primary",type:"submit",disabled:this.state.busy},Object(c.a)("Sign In")),o.a.createElement(S.a,{onClick:this.onForgotPassword,kind:"link"},Object(c.a)("Forgotten your password?")))}renderSsoForm(e){const t=this.state.loginView===y.CAS?"cas":"sso",a=this.state.flows.find(e=>e.type==="m.login."+t);return o.a.createElement("div",null,e?o.a.createElement("p",null,e):null,o.a.createElement(b.a,{matrixClient:h.a.get(),flow:a,loginType:t,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find(e=>"m.login.password"===e.type)}))}renderSignInSection(){if(this.state.loginView===y.Loading)return o.a.createElement(w.a,null);let e=null;return this.state.keyBackupNeeded&&(e=Object(c.a)("Regain access to your account and recover encryption keys stored in this session. Without them, you won't be able to read all of your secure messages in any session.")),this.state.loginView===y.Password?(e||(e=Object(c.a)("Enter your password to sign in and regain access to your account.")),this.renderPasswordForm(e)):this.state.loginView===y.SSO||this.state.loginView===y.CAS?(e||(e=Object(c.a)("Sign in and regain access to your account.")),this.renderSsoForm(e)):this.state.loginView===y.PasswordWithSocialSignOn?(e||(e=Object(c.a)("Sign in and regain access to your account.")),o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,e),this.renderSsoForm(null),o.a.createElement("h3",{className:"mx_AuthBody_centered"},Object(c.a)("%(ssoButtons)s Or %(usernamePassword)s",{ssoButtons:"",usernamePassword:""}).trim()),this.renderPasswordForm(null))):o.a.createElement("p",null,Object(c.a)("You cannot sign in to your account. Please contact your homeserver admin for more information."))}render(){return o.a.createElement(p.a,null,o.a.createElement(C.a,null),o.a.createElement(O.a,null,o.a.createElement("h2",null,Object(c.a)("You're signed out")),o.a.createElement("h3",null,Object(c.a)("Sign in")),o.a.createElement("div",null,this.renderSignInSection()),o.a.createElement("h3",null,Object(c.a)("Clear personal data")),o.a.createElement("p",null,Object(c.a)("Warning: Your personal data (including encryption keys) is still stored in this session. Clear it if you're finished using this session, or want to sign in to another account.")),o.a.createElement("div",null,o.a.createElement(S.a,{onClick:this.onClearAll,kind:"danger"},Object(c.a)("Clear all data")))))}}},1504:function(e,t,a){"use strict";a.r(t),a.d(t,"loadApp",(function(){return S}));a(1383);var n=a(87),i=a.n(n),s=a(126),o=a(89),r=a(309),c=a(283),l=a(413),d=a(98),m=a(0),h=a(120),u=a(9),p=a(1407),g=a(19);let b=null;function v(e){const t=Object(g.b)(e);return{screen:t.location.substring(1),params:t.params}}function f(e){decodeURIComponent(window.location.hash)!==b&&function(e){if(!window.matrixChat)return;m.a.log("Routing URL ",e.href);const t=v(e);window.matrixChat.showScreen(t.screen,t.params)}(window.location)}function E(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];m.a.log("newscreen "+e);const a="#/"+e;b=a,e.startsWith("room/")&&window.location.hash.includes("/$")===a.includes("/$")&&window.location.hash.startsWith(a)&&(t=!0),t?window.location.replace(a):window.location.assign(a)}function y(e){let t;t="vector:"===window.location.protocol?"https://app.element.io/#/register":window.location.protocol+"//"+window.location.host+window.location.pathname+"#/register";const a=Object.keys(e);for(let n=0;n<a.length;++n){t+=0===n?"?":"&";const i=a[n];t+=i+"="+encodeURIComponent(e[i])}return t}function _(){const e=new URL(window.location.href);e.searchParams.delete("loginToken"),m.a.log(`Redirecting to ${e.href} to drop loginToken from queryparams`),window.history.replaceState(null,"",e.href)}async function S(e){var t;window.addEventListener("hashchange",f);const a=s.a.get(),n=Object(g.a)(window.location),b=window.location.protocol+"//"+window.location.host+window.location.pathname;m.a.log("Vector starting at "+b),a.startUpdater();const S=await async function(){let e;try{m.a.log("Verifying homeserver configuration");const t=d.b.get();let a=t.default_server_config;const n=t.default_server_name,i=t.default_hs_url,s=t.default_is_url,l=[a,n,i].filter(e=>!!e);if(l.length>1)throw Object(o.i)(Object(o.c)("Invalid configuration: can only specify one of default_server_config, default_server_name, or default_hs_url."));if(l.length<1)throw Object(o.i)(Object(o.c)("Invalid configuration: no default server specified."));i&&(m.a.log("Config uses a default_hs_url - constructing a default_server_config using this information"),m.a.warn("DEPRECATED CONFIG OPTION: In the future, default_hs_url will not be accepted. Please use default_server_config instead."),a={"m.homeserver":{base_url:i}},s&&(a["m.identity_server"]={base_url:s}));let h=null;a&&(m.a.log("Config uses a default_server_config - validating object"),h=await c.a.fromDiscoveryConfig(a)),n&&(m.a.log("Config uses a default_server_name - doing .well-known lookup"),m.a.warn("DEPRECATED CONFIG OPTION: In the future, default_server_name will not be accepted. Please use default_server_config instead."),h=await c.a.findClientConfig(n)),e=r.a.buildValidatedConfigFromDiscovery(n,h,!0)}catch(t){const{hsUrl:a,isUrl:n,userId:i}=await l.c();if(!a||!i)throw t;m.a.error(t),m.a.warn("A session was found - suppressing config error and using the session's homeserver"),m.a.log("Using pre-existing hsUrl and isUrl: ",{hsUrl:a,isUrl:n}),e=await r.a.validateServerConfigWithStaticUrls(a,n,!0)}return e.isDefault=!0,m.a.log("Using homeserver config:",e),m.a.log("Updating SdkConfig with validated discovery information"),d.b.add({validated_server_config:e}),d.b.get()}(),w=new u.a(S),[C]=await l.b(),O=!!C,k=!!n.loginToken,x=Object(d.c)(S);let R=!0===x.immediate;const j="#/welcome"===window.location.hash||"#"===window.location.hash;if(!R&&x.on_welcome_page&&j&&(R=!0),!O&&!k&&R){m.a.log("Bypassing app load to redirect to SSO");const e=Object(h.createClient)({baseUrl:S.validated_server_config.hsUrl,idBaseUrl:S.validated_server_config.isUrl});return void s.a.get().startSingleSignOn(e,"sso","/"+v(window.location).screen)}const I=null!==(t=w.get("default_device_display_name"))&&void 0!==t?t:a.getDefaultDeviceDisplayName();return i.a.createElement(p.a,{onNewScreen:E,makeRegistrationUrl:y,config:S,realQueryParams:n,startingFragmentQueryParams:e,enableGuest:!S.disable_guests,onTokenLoginCompleted:_,initialScreenAfterLogin:v(window.location),defaultDeviceDisplayName:I})}window.React=i.a,m.a.log("Application is running in production mode"),window.matrixLogger=m.a},233:function(e,t,a){"use strict";var n=a(87),i=a.n(n),s=a(113),o=a(118);t.a=e=>{let{room:t,children:a}=e;const[r,c]=Object(n.useState)(null==t?void 0:t.name);return Object(o.c)(t,s.c.Name,()=>{c(null==t?void 0:t.name)}),Object(n.useEffect)(()=>{c(null==t?void 0:t.name)},[t]),a?a(r):i.a.createElement(i.a.Fragment,null,r||"")}},234:function(e,t,a){"use strict";a.d(t,"a",(function(){return i}));var n=a(87);const i=(e,t)=>{const a=Object(n.useRef)(e=>{});Object(n.useEffect)(()=>{a.current=t},[t]),Object(n.useEffect)(()=>{const t=e.register(e=>a.current(e));return()=>{e.unregister(t)}},[e])}},274:function(e,t,a){"use strict";var n=a(88),i=a.n(n),s=a(0),o=a(126),r=a(8),c=a(151),l=a(144),d=a(113),m=a(116),h=a(7),u=a(97),p=a(119),g=a(90),b=a(93),v=a(104);class f extends r.EventEmitter{constructor(){super(...arguments),i()(this,"crawlerCheckpoints",[]),i()(this,"crawler",null),i()(this,"currentCheckpoint",null),i()(this,"onSync",async(e,t,a)=>{const n=o.a.get().getEventIndexingManager();if("PREPARED"===t&&"SYNCING"===e){return await n.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"===t&&"SYNCING"===e&&await n.commitLiveEvents()}),i()(this,"onRoomTimeline",async(e,t,a,n,i)=>{if(!t)return;const s=g.a.get();return s.isRoomEncrypted(e.getRoomId())?e.isRedaction()?this.redactEvent(e):void(!a&&i&&i.liveEvent&&!e.isRedacted()&&(await s.decryptEventIfNeeded(e),await this.addLiveEventToIndex(e))):void 0}),i()(this,"onRoomStateEvent",async(e,t)=>{g.a.get().isRoomEncrypted(t.roomId)&&(e.getType()!==u.b.RoomEncryption||await this.isRoomIndexed(t.roomId)||(s.a.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))}),i()(this,"redactEvent",async e=>{const t=o.a.get().getEventIndexingManager();try{await t.deleteEvent(e.getAssociatedId())}catch(e){s.a.log("EventIndex: Error deleting event from index",e)}}),i()(this,"onTimelineReset",async(e,t,a)=>{null!==e&&g.a.get().isRoomEncrypted(e.roomId)&&(s.a.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))})}async init(){const e=o.a.get().getEventIndexingManager();this.crawlerCheckpoints=await e.loadCheckpoints(),s.a.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners()}registerListeners(){const e=g.a.get();e.on(p.b.Sync,this.onSync),e.on(d.c.Timeline,this.onRoomTimeline),e.on(d.c.TimelineReset,this.onTimelineReset),e.on(m.b.Events,this.onRoomStateEvent)}removeListeners(){const e=g.a.get();null!==e&&(e.removeListener(p.b.Sync,this.onSync),e.removeListener(d.c.Timeline,this.onRoomTimeline),e.removeListener(d.c.TimelineReset,this.onTimelineReset),e.removeListener(m.b.Events,this.onRoomStateEvent))}async addInitialCheckpoints(){const e=o.a.get().getEventIndexingManager(),t=g.a.get(),a=t.getRooms().filter(e=>t.isRoomEncrypted(e.roomId));s.a.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(a.map(async t=>{const a=t.getLiveTimeline().getPaginationToken(l.a.Backward),n={roomId:t.roomId,token:a,direction:l.a.Backward,fullCrawl:!0},i={roomId:t.roomId,token:a,direction:l.a.Forward};try{n.token&&(await e.addCrawlerCheckpoint(n),this.crawlerCheckpoints.push(n)),i.token&&(await e.addCrawlerCheckpoint(i),this.crawlerCheckpoints.push(i))}catch(e){s.a.log("EventIndex: Error adding initial checkpoints for room",t.roomId,n,i,e)}}))}isValidEvent(e){const t=[u.b.RoomMessage,u.b.RoomName,u.b.RoomTopic].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let a=!0,n=!0;if(e.getType()!==u.b.RoomMessage||e.isRedacted())e.getType()!==u.b.RoomTopic||e.isRedacted()?e.getType()!==u.b.RoomName||e.isRedacted()||e.getContent().name||(n=!1):e.getContent().topic||(n=!1);else{const t=e.getContent().msgtype;a=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(n=!1)}return t&&a&&n}eventToJson(e){const t=e.toJSON(),a=e.isEncrypted()?t.decrypted:t;return e.isEncrypted()?(a.curve25519Key=e.getSenderKey(),a.ed25519Key=e.getClaimedEd25519Key(),a.algorithm=e.getWireContent().algorithm,a.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete a.curve25519Key,delete a.ed25519Key,delete a.algorithm,delete a.forwardingCurve25519KeyChain),a}async addLiveEventToIndex(e){const t=o.a.get().getEventIndexingManager();if(!this.isValidEvent(e))return;const a=this.eventToJson(e),n={displayname:e.sender.rawDisplayName,avatar_url:e.sender.getMxcAvatarUrl()};await t.addEventToIndex(a,n)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const a=t[e];await this.addLiveEventToIndex(a)}}async addRoomCheckpoint(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const a=o.a.get().getEventIndexingManager(),n=g.a.get().getRoom(e);if(!n)return;const i=n.getLiveTimeline(),r=i.getPaginationToken(l.a.Backward);if(!r)return void await this.addEventsFromLiveTimeline(i);const c={roomId:n.roomId,token:r,fullCrawl:t,direction:l.a.Backward};s.a.log("EventIndex: Adding checkpoint",c);try{await a.addCrawlerCheckpoint(c)}catch(e){s.a.log("EventIndex: Error adding new checkpoint for room",n.roomId,c,e)}this.crawlerCheckpoints.push(c)}async crawlerFunc(){let e=!1;const t=g.a.get(),a=o.a.get().getEventIndexingManager();this.crawler={cancel:()=>{e=!0}};let n=!1;for(;!e;){let i=b.b.getValueAt(v.a.DEVICE,"crawlerSleepTime");if(i=Math.max(i,100),n&&(i=5e3),null!==this.currentCheckpoint&&(this.currentCheckpoint=null,this.emitNewCheckpoint()),await Object(h.G)(i),e)break;const o=this.crawlerCheckpoints.shift();if(void 0===o){n=!0;continue}this.currentCheckpoint=o,this.emitNewCheckpoint(),n=!1;const r=t.getEventMapper({preventReEmit:!0});let c;try{c=await t.createMessagesRequest(o.roomId,o.token,100,o.direction)}catch(e){if(403===e.httpStatus){s.a.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",o);try{await a.removeCrawlerCheckpoint(o)}catch(e){s.a.log("EventIndex: Error removing checkpoint",o,e)}continue}s.a.log("EventIndex: Error crawling using checkpoint:",o,",",e),this.crawlerCheckpoints.push(o);continue}if(e){this.crawlerCheckpoints.push(o);break}if(0===c.chunk.length){s.a.log("EventIndex: Done with the checkpoint",o);try{await a.removeCrawlerCheckpoint(o)}catch(e){s.a.log("EventIndex: Error removing checkpoint",o,e)}continue}const l=c.chunk.map(r);let d=[];void 0!==c.state&&(d=c.state.map(r));const m={};d.forEach(e=>{e.event.content&&"join"===e.event.content.membership&&(m[e.event.sender]={displayname:e.event.content.displayname,avatar_url:e.event.content.avatar_url})});const u=l.filter(e=>e.isEncrypted()).map(e=>t.decryptEventIfNeeded(e,{isRetry:!0,emit:!1}));await Promise.all(u);const p=l.filter(this.isValidEvent),g=l.filter(e=>e.isRedaction()),f=p.map(e=>{const t=this.eventToJson(e);let a={};t.sender in m&&(a=m[t.sender]);return{event:t,profile:a}});let E;c.end&&(E={roomId:o.roomId,token:c.end,fullCrawl:o.fullCrawl,direction:o.direction});try{for(let e=0;e<g.length;e++){const t=g[e],n=t.getAssociatedId();n?await a.deleteEvent(n):s.a.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await a.addHistoricEvents(f,E,o);if(!E){s.a.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",o);continue}!0===e&&!0!==E.fullCrawl?(s.a.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",o),await a.removeCrawlerCheckpoint(E)):(!0===e&&s.a.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",o),this.crawlerCheckpoints.push(E))}catch(e){s.a.log("EventIndex: Error during a crawl",e),this.crawlerCheckpoints.push(o)}}this.crawler=null}startCrawler(){null===this.crawler&&this.crawlerFunc()}stopCrawler(){null!==this.crawler&&this.crawler.cancel()}async close(){const e=o.a.get().getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await e.closeEventIndex()}async search(e){return o.a.get().getEventIndexingManager().searchEventIndex(e)}async loadFileEvents(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:l.b.BACKWARDS;const i=g.a.get(),r=o.a.get().getEventIndexingManager(),d={roomId:e.roomId,limit:t};let m;a&&(d.fromEvent=a,d.direction=n);try{m=await r.loadFileEvents(d)}catch(e){return s.a.log("EventIndex: Error getting file events",e),[]}const h=i.getEventMapper();return m.map(t=>{const a=h(t.event),n=new c.a(e.roomId,a.getSender());n.name=t.profile.displayname+" ("+a.getSender()+")";const i=h({content:{membership:"join",avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:u.b.RoomMember,event_id:a.getId()+":eventIndex",room_id:a.getRoomId(),sender:a.getSender(),origin_server_ts:a.getTs(),state_key:a.getSender()});return n.events.member=i,a.sender=n,a})}async populateFileTimeline(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:l.b.BACKWARDS;const r=await this.loadFileEvents(a,n,i,o);null===i&&(r.reverse(),o=o==l.b.BACKWARDS?l.b.FORWARDS:l.b.BACKWARDS),r.forEach(a=>{e.eventIdToTimeline(a.getId())||e.addEventToTimeline(a,t,o==l.b.BACKWARDS)});let c=!1,d="";return r.length>0&&(d=r[r.length-1].getId(),c=!0),s.a.log("EventIndex: Populating file panel with",r.length,"events and setting the pagination token to",d),t.setPaginationToken(d,l.b.BACKWARDS),c}paginateTimelineWindow(e,t,a,n){const i=t.getTimelineIndex(a);if(!i)return Promise.resolve(!1);if(i.pendingPaginate)return i.pendingPaginate;if(t.extend(a,n))return Promise.resolve(!0);const s=(async(e,t,a,n,i)=>{const s=t.timeline,o=s.getTimelineSet(),r=s.getPaginationToken(n),c=await this.populateFileTimeline(o,s,a,i,r,n);return t.pendingPaginate=null,e.extend(n,i),c})(t,i,e,a,n);return i.pendingPaginate=s,s}async getStats(){return o.a.get().getEventIndexingManager().getStats()}async isRoomIndexed(e){return o.a.get().getEventIndexingManager().isRoomIndexed(e)}currentRoom(){if(null===this.currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=g.a.get();return null!==this.currentCheckpoint?e.getRoom(this.currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach((e,a)=>{t.add(e.roomId)}),null!==this.currentCheckpoint&&t.add(this.currentCheckpoint.roomId);const a=g.a.get();return a.getRooms().filter(e=>a.isRoomEncrypted(e.roomId)).forEach((t,a)=>{e.add(t.roomId)}),{crawlingRooms:t,totalRooms:e}}}class E{constructor(){i()(this,"index",null),i()(this,"error",null),i()(this,"_supportIsInstalled",!1)}async init(){const e=o.a.get().getEventIndexingManager();return e?(this._supportIsInstalled=await e.supportsEventIndexing(),this.supportIsInstalled()?b.b.getValueAt(v.a.DEVICE,"enableEventIndexing")?this.initEventIndex():(s.a.log("EventIndex: Event indexing is disabled, not initializing"),!1):(s.a.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(s.a.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){const e=new f,t=o.a.get().getEventIndexingManager(),a=g.a.get(),n=a.getUserId(),i=a.getDeviceId();try{await t.initEventIndex(n,i);const a=await t.getUserVersion(),o=await t.isEventIndexEmpty();o?await t.setUserVersion(1):0!==a||o||(await t.closeEventIndex(),await this.deleteEventIndex(),await t.initEventIndex(n,i),await t.setUserVersion(1)),s.a.log("EventIndex: Successfully initialized the event index"),await e.init()}catch(e){return s.a.log("EventIndex: Error initializing the event index",e),this.error=e,!1}return this.index=e,!0}platformHasSupport(){return null!==o.a.get().getEventIndexingManager()}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){const e=o.a.get().getEventIndexingManager();null!==e&&(await this.unset(),s.a.log("EventIndex: Deleting event index."),await e.deleteEventIndex())}}window.mxEventIndexPeg||(window.mxEventIndexPeg=new E);t.a=window.mxEventIndexPeg},275:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var n=a(351),i=a.n(n),s=a(87),o=a.n(s),r=a(98),c=a(89);var l=()=>{var e;const t=r.b.getObject("branding"),a=null!==(e=null==t?void 0:t.get("auth_footer_links"))&&void 0!==e?e:[{text:"Blog",url:"https://element.io/blog"},{text:"Twitter",url:"https://twitter.com/element_hq"},{text:"GitHub",url:"https://github.com/vector-im/element-web"}],n=[];for(const e of a)n.push(o.a.createElement("a",{href:e.url,key:e.text,target:"_blank",rel:"noreferrer noopener"},e.text));return o.a.createElement("div",{className:"mx_AuthFooter"},n,o.a.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},Object(c.a)("Powered by Matrix")))};class d extends o.a.PureComponent{static getWelcomeBackgroundUrl(){if(d.welcomeBackgroundUrl)return d.welcomeBackgroundUrl;const e=r.b.getObject("branding");d.welcomeBackgroundUrl="themes/element/img/backgrounds/lake.jpg";const t=null==e?void 0:e.get("welcome_background_url");if(t)if(Array.isArray(t)){const e=Math.floor(Math.random()*t.length);d.welcomeBackgroundUrl=t[e]}else d.welcomeBackgroundUrl=t;return d.welcomeBackgroundUrl}render(){const e={background:`center/cover fixed url(${d.getWelcomeBackgroundUrl()})`},t={position:"absolute",top:0,right:0,bottom:0,left:0,filter:"blur(40px)",background:e.background};return o.a.createElement("div",{className:"mx_AuthPage",style:e},o.a.createElement("div",{className:"mx_AuthPage_modal",style:{position:"relative",background:"initial"}},o.a.createElement("div",{className:"mx_AuthPage_modalBlur",style:t}),o.a.createElement("div",{className:"mx_AuthPage_modalContent",style:{display:"flex",zIndex:1,background:"rgba(255, 255, 255, 0.59)",borderRadius:"8px"}},this.props.children)),o.a.createElement(l,null))}}i()(d,"welcomeBackgroundUrl",void 0)},308:function(e,t,a){"use strict";var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(94),c=a.n(r),l=a(98),d=a(169),m=a(89),h=a(105);class u extends s.PureComponent{constructor(){super(...arguments),i()(this,"validate",Object(d.a)({description:function(e){const t=e?e.score:0;return o.a.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},deriveData:async e=>{let{value:t}=e;if(!t)return null;const{scorePassword:n}=await Promise.all([a.e(28),a.e(35)]).then(a.bind(null,841));return n(t)},rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(m.a)(this.props.labelEnterPassword)},{key:"complexity",test:async function(e,t){let{value:a}=e;if(!a)return!1;const n=t.score>=this.props.minScore;return l.b.get("dangerously_allow_unsafe_and_insecure_passwords")||n},valid:function(e){return e.score>=this.props.minScore?Object(m.a)(this.props.labelStrongPassword):Object(m.a)(this.props.labelAllowedButUnsafe)},invalid:function(e){if(!e)return null;const{feedback:t}=e;return t.warning||t.suggestions[0]||Object(m.a)("Keep going...")}}]})),i()(this,"onValidate",async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t})}render(){return o.a.createElement(h.a,{id:this.props.id,autoFocus:this.props.autoFocus,className:c()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:Object(m.a)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}}i()(u,"defaultProps",{label:Object(m.c)("Password"),labelEnterPassword:Object(m.c)("Enter password"),labelStrongPassword:Object(m.c)("Nice, strong password!"),labelAllowedButUnsafe:Object(m.c)("Password is allowed, but unsafe")}),t.a=u},309:function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(283),c=a(0),l=a(89);var d=a(98);const m=[r.a.ERROR_INVALID_HOMESERVER,r.a.ERROR_INVALID_IDENTITY_SERVER];class h{constructor(){i()(this,"hsUrl",void 0),i()(this,"hsName",void 0),i()(this,"hsNameIsDifferent",void 0),i()(this,"isUrl",void 0),i()(this,"isDefault",void 0),i()(this,"isNameResolvable",void 0),i()(this,"warning",void 0)}}class u{static isLivelinessError(e){return!!e&&!!m.find(t=>"string"==typeof e?t===e:t===e.message)}static authComponentStateForError(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"login";if(!e)return{serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:null};let a=Object(l.a)("Cannot reach homeserver"),n=Object(l.a)("Ensure you have a stable internet connection, or get in touch with the server admin");if(!u.isLivelinessError(e)){const e=d.b.get().brand;a=Object(l.a)("Your %(brand)s is misconfigured",{brand:e}),n=Object(l.a)("Ask your %(brand)s admin to check <a>your config</a> for incorrect or duplicate entries.",{brand:e},{a:e=>o.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/master/docs/config.md",target:"_blank",rel:"noreferrer noopener"},e)})}let i=!0;return("string"==typeof e?e:e.message)===r.a.ERROR_INVALID_IDENTITY_SERVER&&(i=!1,a=Object(l.a)("Cannot reach identity server"),n="register"===t?Object(l.a)("You can register, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):"reset_password"===t?Object(l.a)("You can reset your password, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):Object(l.a)("You can log in, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin.")),{serverIsAlive:!1,serverErrorIsFatal:i,serverDeadError:o.a.createElement("div",null,o.a.createElement("strong",null,a),o.a.createElement("div",null,n))}}static async validateServerConfigWithStaticUrls(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e)throw Object(l.i)(Object(l.c)("No homeserver URL provided"));const n={"m.homeserver":{base_url:e}};t&&(n["m.identity_server"]={base_url:t});const i=await r.a.fromDiscoveryConfig(n),s=new URL(e).hostname;return u.buildValidatedConfigFromDiscovery(s,i,a,!0)}static async validateServerName(e){const t=await r.a.findClientConfig(e);return u.buildValidatedConfigFromDiscovery(e,t)}static buildValidatedConfigFromDiscovery(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!t||!t["m.homeserver"])throw c.a.error("Ended up in a state of not knowing which homeserver to connect to."),Object(l.i)(Object(l.c)("Unexpected error resolving homeserver configuration"));const i=t["m.homeserver"],s=t["m.identity_server"],o=d.b.get("validated_server_config");let m=o&&o.isUrl;if(s&&s.state===r.a.SUCCESS)m=s.base_url;else if(s&&s.state!==r.a.PROMPT){if(c.a.error("Error determining preferred identity server URL:",s),s.state===r.a.FAIL_ERROR){if(-1!==r.a.ALL_ERRORS.indexOf(s.error))throw Object(l.i)(s.error);throw Object(l.i)(Object(l.c)("Unexpected error resolving identity server configuration"))}i.error=r.a.ERROR_INVALID_IDENTITY_SERVER,s.base_url&&(m=s.base_url)}if(i.state!==r.a.SUCCESS&&(c.a.error("Error processing homeserver config:",i),!a||!u.isLivelinessError(i.error))){if(-1!==r.a.ALL_ERRORS.indexOf(i.error))throw Object(l.i)(i.error);throw Object(l.i)(Object(l.c)("Unexpected error resolving homeserver configuration"))}const p=i.base_url;let g=e||i.server_name;const b=new URL(p);if(g||(g=b.hostname),!g)throw c.a.error("Failed to parse homeserver name from homeserver URL"),Object(l.i)(Object(l.c)("Unexpected error resolving homeserver configuration"));return function(e,t){const a=new e;return Object.assign(a,t),a}(h,{hsUrl:p,hsName:g,hsNameIsDifferent:b.hostname!==g,isUrl:m,isDefault:!1,warning:i.error,isNameResolvable:!n})}}},352:function(e,t,a){"use strict";a.d(t,"a",(function(){return c})),a.d(t,"b",(function(){return l})),a.d(t,"c",(function(){return d}));var n=a(88),i=a.n(n),s=a(120),o=a(0),r=a(249);let c;!function(e){e.Gitlab="gitlab",e.Github="github",e.Apple="apple",e.Google="google",e.Facebook="facebook",e.Twitter="twitter"}(c||(c={}));class l{constructor(e,t,a,n){i()(this,"hsUrl",void 0),i()(this,"isUrl",void 0),i()(this,"fallbackHsUrl",void 0),i()(this,"flows",void 0),i()(this,"defaultDeviceDisplayName",void 0),i()(this,"tempClient",void 0),this.hsUrl=e,this.isUrl=t,this.fallbackHsUrl=a,this.flows=[],this.defaultDeviceDisplayName=n.defaultDeviceDisplayName,this.tempClient=null}getHomeserverUrl(){return this.hsUrl}getIdentityServerUrl(){return this.isUrl}setHomeserverUrl(e){this.tempClient=null,this.hsUrl=e}setIdentityServerUrl(e){this.tempClient=null,this.isUrl=e}createTemporaryClient(){return this.tempClient?this.tempClient:this.tempClient=Object(s.createClient)({baseUrl:this.hsUrl,idBaseUrl:this.isUrl})}async getFlows(){const e=this.createTemporaryClient(),{flows:t}=await e.loginFlows();return this.flows=t,this.flows}loginViaPassword(e,t,a,n){const i=e.indexOf("@")>0;let s;s=t&&a?{type:"m.id.phone",country:t,phone:a,number:a}:i?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const r={password:n,identifier:s,initial_device_display_name:this.defaultDeviceDisplayName},c=e=>d(this.fallbackHsUrl,this.isUrl,"m.login.password",r).catch(t=>{throw o.a.log("fallback HS login failed",t),e});let l=null;return d(this.hsUrl,this.isUrl,"m.login.password",r).catch(e=>{if(l=e,403===e.httpStatus&&this.fallbackHsUrl)return c(l);throw l}).catch(e=>{throw o.a.log("Login failed",e),e})}}async function d(e,t,a,n){var i;const c=Object(s.createClient)({baseUrl:e,idBaseUrl:t}),l=await c.login(a,n),d=l.well_known;d&&(d["m.homeserver"]&&d["m.homeserver"].base_url&&(e=d["m.homeserver"].base_url,o.a.log(`Overrode homeserver setting with ${e} from login response`)),d["m.identity_server"]&&d["m.identity_server"].base_url&&(t=d["m.identity_server"].base_url,o.a.log(`Overrode IS setting with ${t} from login response`)));const m={homeserverUrl:e,identityServerUrl:t,userId:l.user_id,deviceId:l.device_id,accessToken:l.access_token};return null===(i=r.a.examineLoginResponse)||void 0===i||i.call(r.a,l,m),m}},353:function(e,t,a){"use strict";a.d(t,"a",(function(){return c})),a.d(t,"b",(function(){return l}));var n=a(139),i=a(146),s=a(92),o=a(96),r=a(106);const c=e=>{var t;const a=null!==(t=e.push)&&void 0!==t&&t,c={phase:i.a.ThreadView,state:{threadHeadEvent:e.rootEvent,initialEvent:e.initialEvent,isInitialEventHighlighted:e.highlighted,initialEventScrollIntoView:e.scroll_into_view}};a?n.a.instance.pushCard(c):n.a.instance.setCards([{phase:i.a.ThreadPanel},c]),s.a.dispatch({action:o.a.FocusSendMessageComposer,context:r.a.Thread})},l=()=>{n.a.instance.setCard({phase:i.a.ThreadPanel})}},355:function(e,t,a){"use strict";var n=a(99),i=a.n(n),s=a(88),o=a.n(s),r=a(87),c=a.n(r),l=a(94),d=a.n(l),m=a(97),h=a(108),u=a(137),p=a(0),g=a(113),b=a(152),v=a(145),f=a(89),E=a(92),y=a(132),_=a(93),S=a(175),w=a(96),C=a(102),O=a(858),k=a(489),x=a(91),R=a(219),j=a(106),I=a(90);class T extends c.a.Component{constructor(e,t){super(e,t),o()(this,"context",void 0),o()(this,"unmounted",!1),o()(this,"room",void 0),o()(this,"blockquoteRef",c.a.createRef()),o()(this,"canCollapse",()=>this.state.events.length>1),o()(this,"collapse",()=>{this.initialize()}),o()(this,"onQuoteClick",async e=>{const t=[this.state.loadedEv,...this.state.events];let a=null;t.length>0&&(a=await this.getNextEvent(t[0])),this.setState({loadedEv:a,events:t}),E.a.fire(w.a.FocusSendMessageComposer)}),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.room=this.matrixClient.getRoom(this.props.parentEv.getRoomId())}get matrixClient(){return I.a.get()}componentDidMount(){this.initialize(),this.trySetExpandableQuotes()}componentDidUpdate(){this.props.onHeightChanged(),this.trySetExpandableQuotes()}componentWillUnmount(){this.unmounted=!0}trySetExpandableQuotes(){if(void 0===this.props.isQuoteExpanded&&this.blockquoteRef.current){const e=this.blockquoteRef.current.querySelector(".mx_EventTile_body");if(e){const t=e.querySelector("code"),a=!!t&&t.offsetHeight>=60;(e.offsetHeight>=60||a)&&this.props.setQuoteExpanded(!1)}}}async initialize(){const{parentEv:e}=this.props,t=await this.getEvent(Object(R.b)(e));if(!this.unmounted)if(t){const e=await this.getNextEvent(t);this.setState({events:[t],loadedEv:e,loading:!1})}else this.setState({err:!0})}async getNextEvent(e){try{const t=Object(R.b)(e);return await this.getEvent(t)}catch(e){return null}}async getEvent(e){if(!e)return null;const t=this.room.findEventById(e);if(t)return t;try{await this.matrixClient.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch(e){return null}return this.room.findEventById(e)}getReplyChainColorClass(e){return Object(S.f)(e.getSender()).replace("Username","ReplyChain")}render(){let e=null;if(this.state.err)e=c.a.createElement("blockquote",{className:"mx_ReplyChain mx_ReplyChain_error"},Object(f.a)("Unable to load event that was replied to, it either does not exist or you do not have permission to view it."));else if(this.state.loadedEv&&Object(R.c)(this.state.events[0])){const t=this.state.loadedEv,a=this.matrixClient.getRoom(t.getRoomId());e=c.a.createElement("blockquote",{className:"mx_ReplyChain "+this.getReplyChainColorClass(t)},Object(f.a)("<a>In reply to</a> <pill>",{},{a:e=>c.a.createElement(x.a,{kind:"link_inline",className:"mx_ReplyChain_show",onClick:this.onQuoteClick},e),pill:c.a.createElement(k.b,{type:k.a.UserMention,room:a,url:Object(y.g)(t.getSender()),shouldShowPillAvatar:_.b.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.props.forExport){const t=Object(R.b)(this.props.parentEv);e=c.a.createElement("p",{className:"mx_ReplyChain_Export"},Object(f.a)("In reply to <a>this message</a>",{},{a:e=>c.a.createElement("a",{className:"mx_reply_anchor",href:"#"+t,"scroll-to":t}," ",e," ")}))}else this.state.loading&&(e=c.a.createElement(C.a,{w:16,h:16}));const{isQuoteExpanded:t}=this.props,a=this.state.events.map(e=>{const a=d()({mx_ReplyChain:!0,[this.getReplyChainColorClass(e)]:!0,"mx_ReplyChain--expanded":!0===t,"mx_ReplyChain--collapsed":!1===t});return c.a.createElement("blockquote",{ref:this.blockquoteRef,className:a,key:e.getId()},c.a.createElement(O.a,{mxEvent:e,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator,toggleExpandedQuote:()=>this.props.setQuoteExpanded(!this.props.isQuoteExpanded),getRelationsForEvent:this.props.getRelationsForEvent}))});return c.a.createElement("div",{className:"mx_ReplyChain_wrapper"},c.a.createElement("div",null,e),c.a.createElement("div",null,a))}}o()(T,"contextType",j.b);var N=a(157),P=a(133),M=a(269),D=a(130),A=a(584),U=a(112),L=a(164),F=a(140),B=a(349),V=a(210),W=a(126),H=a(136),z=a(558),K=a(709),q=a(236);class G extends c.a.Component{constructor(e){super(e)}render(){return c.a.createElement(q.a,{className:"mx_TooltipButton_container",tooltipClassName:"mx_TooltipButton_helpText",tooltipTargetClassName:"mx_TooltipButton",label:this.props.helpText},"?")}}var Y=a(153),J=a(560),$=a(134),Q=a(396),X=a(583),Z=a(763);class ee extends c.a.PureComponent{constructor(e){super(e),o()(this,"downloader",new Z.a),o()(this,"onDownloadClick",async()=>{if(this.state.loading)return;if(this.props.mediaEventHelperGet().media.isEncrypted&&this.setState({tooltip:Object(f.c)("Decrypting")}),this.setState({loading:!0}),this.state.blob)return this.doDownload();const e=await this.props.mediaEventHelperGet().sourceBlob.value;this.setState({blob:e}),await this.doDownload()}),this.state={loading:!1,tooltip:Object(f.c)("Downloading")}}async doDownload(){await this.downloader.download({blob:this.state.blob,name:this.props.mediaEventHelperGet().fileName}),this.setState({loading:!1})}render(){let e;this.state.loading&&(e=c.a.createElement(C.a,{w:18,h:18}));const t=d()({mx_MessageActionBar_maskButton:!0,mx_MessageActionBar_downloadButton:!0,mx_MessageActionBar_downloadSpinnerButton:!!e});return c.a.createElement($.b,{className:t,title:e?Object(f.a)(this.state.tooltip):Object(f.a)("Download"),onClick:this.onDownloadClick,disabled:!!e},e)}}var te=a(491),ae=a(395),ne=a(353),ie=a(192),se=a(109),oe=a(155),re=a(98);const ce=e=>{let{mxEvent:t,getTile:a,getReplyChain:n,permalinkCreator:s,onFocusChange:o,getRelationsForEvent:l}=e;const[d,m,h,u]=Object(U.q)(),[p,g,b]=Object($.i)(m);Object(r.useEffect)(()=>{o(d)},[o,d]);let v;if(d){const e=a&&a(),o=n&&n(),r=m.current.getBoundingClientRect();v=c.a.createElement(A.a,i()({},Object(U.j)(r),{mxEvent:t,permalinkCreator:s,eventTileOps:e&&e.getEventTileOps?e.getEventTileOps():void 0,collapseReplyChain:o&&o.canCollapse()?o.collapse:void 0,onFinished:u,getRelationsForEvent:l}))}return c.a.createElement(c.a.Fragment,null,c.a.createElement(U.c,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton",title:Object(f.a)("Options"),onClick:e=>{e.preventDefault(),e.stopPropagation(),h(),p()},isExpanded:d,inputRef:b,onFocus:p,tabIndex:g?0:-1}),v)},le=e=>{let{mxEvent:t,reactions:a,onFocusChange:n}=e;const[s,o,l,d]=Object(U.q)(),[m,h,u]=Object($.i)(o);let p;if(Object(r.useEffect)(()=>{n(s)},[n,s]),s){const e=o.current.getBoundingClientRect();p=c.a.createElement(U.o,i()({},Object(U.j)(e),{onFinished:d,managed:!1}),c.a.createElement(te.a,{mxEvent:t,reactions:a,onFinished:d}))}return c.a.createElement(c.a.Fragment,null,c.a.createElement(U.c,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_reactButton",title:Object(f.a)("React"),onClick:()=>{l(),m()},isExpanded:s,inputRef:u,onFocus:m,tabIndex:h?0:-1}),p)},de=e=>{var t;let{mxEvent:a}=e;const n=Object(r.useContext)(ae.a),i=null==a||null===(t=a.getRelation())||void 0===t?void 0:t.rel_type,s=!!i&&i!==m.d.Thread,o=!localStorage.getItem("mx_seen_feature_thread"),l=_.b.getValue("feature_thread");if(!l&&!u.d.hasServerSideSupport)return null;return c.a.createElement($.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_threadButton",disabled:s,tooltip:c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:"mx_Tooltip_title"},s?Object(f.a)("Can't create a thread from an event with an existing relation"):Object(f.a)("Reply in thread")),!s&&c.a.createElement("div",{className:"mx_Tooltip_sub"},_.b.getValue("feature_thread")?Object(f.a)("Beta feature"):Object(f.a)("Beta feature. Click to learn more."))),title:s?Object(f.a)("Can't create a thread from an event with an existing relation"):Object(f.a)("Reply in thread"),onClick:()=>{o&&localStorage.setItem("mx_seen_feature_thread","true"),_.b.getValue("feature_thread")?a.isThreadRelation?Object(ne.a)({rootEvent:a.getThread().rootEvent,initialEvent:a,scroll_into_view:!0,highlighted:!0,push:n.isCard}):Object(ne.a)({rootEvent:a,push:n.isCard}):E.a.dispatch({action:w.a.ViewUserSettings,initialTabId:oe.a.Labs})}},o&&!l&&c.a.createElement("div",{className:"mx_Indicator"}))};class me extends c.a.PureComponent{constructor(){super(...arguments),o()(this,"onDecrypted",()=>{this.forceUpdate()}),o()(this,"onBeforeRedaction",()=>{this.forceUpdate()}),o()(this,"onSent",()=>{this.forceUpdate()}),o()(this,"onFocusChange",e=>{var t,a;null===(t=(a=this.props).onFocusChange)||void 0===t||t.call(a,e)}),o()(this,"onReplyClick",e=>{E.a.dispatch({action:"reply_to_event",event:this.props.mxEvent,context:this.context.timelineRenderingType})}),o()(this,"onEditClick",()=>{Object(Y.e)(this.props.mxEvent,this.context.timelineRenderingType,this.props.getRelationsForEvent)}),o()(this,"forbiddenThreadHeadMsgType",[m.c.KeyVerificationRequest]),o()(this,"onResendClick",e=>{this.runActionOnFailedEv(e=>Q.a.resend(e))}),o()(this,"onCancelClick",e=>{this.runActionOnFailedEv(e=>Q.a.removeFromQueue(e),e=>Object(Y.b)(e.status))})}componentDidMount(){this.props.mxEvent.status&&this.props.mxEvent.status!==h.a.SENT&&this.props.mxEvent.on(h.c.Status,this.onSent);I.a.get().decryptEventIfNeeded(this.props.mxEvent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once(h.c.Decrypted,this.onDecrypted),this.props.mxEvent.on(h.c.BeforeRedaction,this.onBeforeRedaction)}componentWillUnmount(){this.props.mxEvent.off(h.c.Status,this.onSent),this.props.mxEvent.off(h.c.Decrypted,this.onDecrypted),this.props.mxEvent.off(h.c.BeforeRedaction,this.onBeforeRedaction)}get showReplyInThreadAction(){if(!_.b.getValue("feature_thread")&&!u.d.hasServerSideSupport)return null;if(!_.b.getBetaInfo("feature_thread")&&!_.b.getValue("feature_thread")&&!re.b.get("show_labs_settings"))return!1;const e=this.context.timelineRenderingType!==j.a.Thread,t=!this.forbiddenThreadHeadMsgType.includes(this.props.mxEvent.getContent().msgtype);return e&&t}runActionOnFailedEv(e,t){t||(t=()=>!0);const a=this.props.mxEvent,n=a.replacingEvent(),i=[a.localRedactionEvent(),n,a];for(const a of i)if(a&&t(a)){e(a);break}}render(){const e=[];Object(Y.c)(this.props.mxEvent)&&e.push(c.a.createElement($.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_editButton",title:Object(f.a)("Edit"),onClick:this.onEditClick,key:"edit"}));const t=c.a.createElement($.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_cancelButton",title:Object(f.a)("Delete"),onClick:this.onCancelClick,key:"cancel"}),a=c.a.createElement(de,{mxEvent:this.props.mxEvent,key:"reply_thread"}),n=this.props.mxEvent,i=n.replacingEvent()&&n.replacingEvent().status,s=n.localRedactionEvent()&&n.localRedactionEvent().status,o=Object(Y.b)(n.status)||Object(Y.b)(i)||Object(Y.b)(s),r=[n.status,i,s].includes(h.a.NOT_SENT);if(o&&r)e.splice(0,0,c.a.createElement($.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_resendButton",title:Object(f.a)("Retry"),onClick:this.onResendClick,key:"resend"})),e.push(t);else{if(Object(Y.j)(this.props.mxEvent)?(this.context.canSendMessages&&(this.showReplyInThreadAction&&e.splice(0,0,a),e.splice(0,0,c.a.createElement($.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_replyButton",title:Object(f.a)("Reply"),onClick:this.onReplyClick,key:"reply"}))),this.context.canReact&&e.splice(0,0,c.a.createElement(le,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange,key:"react"})),X.a.isEligible(this.props.mxEvent)&&e.splice(0,0,c.a.createElement(ee,{mxEvent:this.props.mxEvent,mediaEventHelperGet:()=>{var e,t,a,n;return null===(e=(t=this.props).getTile)||void 0===e||null===(a=(n=e.call(t)).getMediaHelper)||void 0===a?void 0:a.call(n)},key:"download"}))):_.b.getValue("feature_thread")&&this.context.timelineRenderingType===j.a.Room&&this.props.mxEvent.getThread()&&e.unshift(a),o&&e.push(t),void 0!==this.props.isQuoteExpanded&&Object(R.c)(this.props.mxEvent)){const t=d()({mx_MessageActionBar_maskButton:!0,mx_MessageActionBar_expandMessageButton:!this.props.isQuoteExpanded,mx_MessageActionBar_collapseMessageButton:this.props.isQuoteExpanded}),a=c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:"mx_Tooltip_title"},this.props.isQuoteExpanded?Object(f.a)("Collapse quotes"):Object(f.a)("Expand quotes")),c.a.createElement("div",{className:"mx_Tooltip_sub"},Object(f.a)(se.a[ie.b.SHIFT])+" + "+Object(f.a)("Click")));e.push(c.a.createElement($.b,{className:t,title:this.props.isQuoteExpanded?Object(f.a)("Collapse quotes"):Object(f.a)("Expand quotes"),tooltip:a,onClick:this.props.toggleThreadExpanded,key:"expand"}))}e.push(c.a.createElement(ce,{mxEvent:this.props.mxEvent,getReplyChain:this.props.getReplyChain,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange,key:"menu",getRelationsForEvent:this.props.getRelationsForEvent}))}return c.a.createElement(J.a,{className:"mx_MessageActionBar","aria-label":Object(f.a)("Message Actions"),"aria-live":"off"},e)}}o()(me,"contextType",j.b);var he=a(315),ue=a(334),pe=a(158),ge=a(100);class be extends c.a.PureComponent{render(){const{content:e,reactionEvents:t,mxEvent:a,visible:n}=this.props,i=this.context.getRoom(a.getRoomId());let s,o;if(i){const a=[];for(const e of t){const t=i.getMember(e.getSender()),n=t?t.name:e.getSender();a.push(n)}const n=Object(pe.i)(e);s=c.a.createElement("div",null,Object(f.a)("<reactors/><reactedWith>reacted with %(shortName)s</reactedWith>",{shortName:n},{reactors:()=>c.a.createElement("div",{className:"mx_Tooltip_title"},Object(S.b)(a,6)),reactedWith:e=>n?c.a.createElement("div",{className:"mx_Tooltip_sub"},e):null}))}return s&&(o=c.a.createElement(F.b,{visible:n,label:s})),o}}o()(be,"contextType",ge.a);class ve extends c.a.PureComponent{constructor(){super(...arguments),o()(this,"state",{tooltipRendered:!1,tooltipVisible:!1}),o()(this,"onClick",()=>{const{mxEvent:e,myReactionEvent:t,content:a}=this.props;t?this.context.redactEvent(e.getRoomId(),t.getId()):(this.context.sendEvent(e.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:e.getId(),key:a}}),E.a.dispatch({action:"message_sent"}))}),o()(this,"onMouseOver",()=>{this.setState({tooltipRendered:!0,tooltipVisible:!0})}),o()(this,"onMouseLeave",()=>{this.setState({tooltipVisible:!1})})}render(){const{mxEvent:e,content:t,count:a,reactionEvents:n,myReactionEvent:i}=this.props,s=d()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!i});let o;this.state.tooltipRendered&&(o=c.a.createElement(be,{mxEvent:this.props.mxEvent,content:t,reactionEvents:n,visible:this.state.tooltipVisible}));const r=this.context.getRoom(e.getRoomId());let l;if(r){const e=[];for(const t of n){const a=r.getMember(t.getSender());e.push((null==a?void 0:a.name)||t.getSender())}const a=Object(S.b)(e,6);l=t?Object(f.a)("%(reactors)s reacted with %(content)s",{reactors:a,content:t}):a}return c.a.createElement(x.a,{className:s,"aria-label":l,onClick:this.onClick,disabled:this.props.disabled,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},c.a.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},t),c.a.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},a),o)}}o()(ve,"contextType",ge.a);const fe=e=>{let{mxEvent:t,reactions:a}=e;const[n,s,o,r]=Object(U.q)();let l;if(n){const e=s.current.getBoundingClientRect();l=c.a.createElement(U.o,i()({},Object(U.j)(e),{onFinished:r,managed:!1}),c.a.createElement(te.a,{mxEvent:t,reactions:a,onFinished:r}))}return c.a.createElement(c.a.Fragment,null,c.a.createElement(ue.a,{className:d()("mx_ReactionsRow_addReactionButton",{mx_ReactionsRow_addReactionButton_active:n}),title:Object(f.a)("Add reaction"),onClick:o,onContextMenu:e=>{e.preventDefault(),o()},isExpanded:n,inputRef:s}),l)};class Ee extends c.a.PureComponent{constructor(e,t){super(e,t),o()(this,"context",void 0),o()(this,"onDecrypted",()=>{this.forceUpdate()}),o()(this,"onReactionsChange",()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()}),o()(this,"onShowAllClick",()=>{this.setState({showAll:!0})}),this.context=t,this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidMount(){const{mxEvent:e,reactions:t}=this.props;(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&e.once(h.c.Decrypted,this.onDecrypted),t&&(t.on(he.b.Add,this.onReactionsChange),t.on(he.b.Remove,this.onReactionsChange),t.on(he.b.Redaction,this.onReactionsChange))}componentWillUnmount(){const{mxEvent:e,reactions:t}=this.props;e.off(h.c.Decrypted,this.onDecrypted),t&&(t.off(he.b.Add,this.onReactionsChange),t.off(he.b.Remove,this.onReactionsChange),t.off(he.b.Redaction,this.onReactionsChange))}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.props.reactions.on(he.b.Add,this.onReactionsChange),this.props.reactions.on(he.b.Remove,this.onReactionsChange),this.props.reactions.on(he.b.Redaction,this.onReactionsChange),this.onReactionsChange())}getMyReactions(){const e=this.props.reactions;if(!e)return null;const t=this.context.room.client.getUserId(),a=e.getAnnotationsBySender()[t];return a?[...a.values()]:null}render(){const{mxEvent:e,reactions:t}=this.props,{myReactions:a,showAll:n}=this.state;if(!t||!Object(Y.j)(e))return null;let i,s,o=t.getSortedAnnotationsByKey().map(t=>{let[n,i]=t;const s=i.size;if(!s)return null;const o=a&&a.find(e=>!e.isRedacted()&&e.getRelation().key===n);return c.a.createElement(ve,{key:n,content:n,count:s,mxEvent:e,reactionEvents:i,myReactionEvent:o,disabled:!this.context.canReact})}).filter(e=>!!e);return o.length?(o.length>9&&!n&&(o=o.slice(0,8),i=c.a.createElement(x.a,{kind:"link_inline",className:"mx_ReactionsRow_showAll",onClick:this.onShowAllClick},Object(f.a)("Show all"))),this.context.canReact&&(s=c.a.createElement(fe,{mxEvent:e,reactions:t})),c.a.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":Object(f.a)("Reactions")},o,i,s)):null}}o()(Ee,"contextType",j.b);var ye=a(559),_e=a(573),Se=a(487),we=a(172),Ce=a(190),Oe=a(168),ke=a(149),xe=a(810),Re=a(460),je=a(127),Ie=a(95),Te=a(230),Ne=a(492);class Pe extends c.a.Component{constructor(e){super(e),o()(this,"onBugReport",()=>{Ie.a.createTrackedDialog("Bug Report Dialog","",Te.a,{label:"react-soft-crash-tile",error:this.state.error})}),o()(this,"onViewSource",()=>{Ie.a.createTrackedDialog("View Event Source","from crash",Ne.a,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};let a,n;return re.b.get().bug_report_endpoint_url&&(a=c.a.createElement(x.a,{kind:"link_inline",onClick:this.onBugReport},Object(f.a)("Submit logs"))),e&&_.b.getValue("developerMode")&&(n=c.a.createElement(x.a,{onClick:this.onViewSource,kind:"link_inline"},Object(f.a)("View Source"))),c.a.createElement("li",{className:d()(t),"data-layout":this.props.layout},c.a.createElement("div",{className:"mx_EventTile_line"},c.a.createElement("span",null,Object(f.a)("Can't load this message"),e&&` (${e.getType()})`,a,n)))}return this.props.children}}var Me=a(198),De=a(118),Ae=a(266);const Ue=e=>{var t,a;let{thread:n,showDisplayname:i=!1}=e;const s=Object(r.useContext)(ge.a),o=Object(De.d)(n,u.e.Update,()=>n.replyToEvent),[l,d]=Object(r.useState)(null==o?void 0:o.getContent());Object(De.c)(o,h.c.Replaced,()=>{d(o.getContent())});const m=(null==o?void 0:o.shouldAttemptDecryption())||(null==o?void 0:o.isBeingDecrypted());Object(De.c)(m?o:null,h.c.Decrypted,()=>{d(o.getContent())});const p=Object(Ae.a)(async()=>{if(o)return await s.decryptEventIfNeeded(o),_e.a.instance.generatePreviewForEvent(o)},[o,l]);return p?c.a.createElement(c.a.Fragment,null,c.a.createElement(H.a,{member:o.sender,fallbackUserId:o.getSender(),width:24,height:24,className:"mx_ThreadSummary_avatar"}),i&&c.a.createElement("div",{className:"mx_ThreadSummary_sender"},null!==(t=null===(a=o.sender)||void 0===a?void 0:a.name)&&void 0!==t?t:o.getSender()),c.a.createElement("div",{className:"mx_ThreadSummary_content",title:p},c.a.createElement("span",{className:"mx_ThreadSummary_message-preview"},p))):null};var Le=e=>{let{mxEvent:t,thread:a}=e;const n=Object(r.useContext)(j.b),i=Object(r.useContext)(ae.a),s=Object(De.d)(a,u.e.Update,()=>a.length);if(!s)return null;let o=s;return n.narrow||(o=Object(f.a)("%(count)s reply",{count:s})),c.a.createElement(x.a,{className:"mx_ThreadSummary",onClick:e=>{Object(ne.a)({rootEvent:t,push:i.isCard}),je.b.trackInteraction("WebRoomTimelineThreadSummaryButton",e)},"aria-label":Object(f.a)("Open thread")},c.a.createElement("span",{className:"mx_ThreadSummary_ThreadsAmount"},o),c.a.createElement(Ue,{thread:a,showDisplayname:!n.narrow}),c.a.createElement("div",{className:"mx_ThreadSummary_chevron"}))},Fe=a(150),Be=a.n(Fe);class Ve extends c.a.Component{constructor(e){super(e),o()(this,"nodes",{}),o()(this,"children",void 0),this.updateChildren(this.props.children)}componentDidUpdate(){this.updateChildren(this.props.children)}applyStyles(e,t){Object.entries(t).forEach(t=>{let[a,n]=t;e.style[a]=n})}updateChildren(e){const t=this.children||{};this.children={},c.a.Children.toArray(e).forEach(e=>{if(t[e.key]){const a=t[e.key],n=Be.a.findDOMNode(this.nodes[a.key]);n&&n.style.left!==e.props.style.left&&this.applyStyles(n,{left:e.props.style.left}),this.children[e.key]=c.a.cloneElement(a,e.props,e.props.children)}else{const t={},a=e.props.style,n=this.props.startStyles;if(n.length>0){const e=n[0];t.style=e}t.ref=t=>this.collectNode(e.key,t,a),this.children[e.key]=c.a.cloneElement(e,t)}})}collectNode(e,t,a){if(t&&void 0===this.nodes[e]&&this.props.startStyles.length>0){const e=this.props.startStyles,n=Be.a.findDOMNode(t);for(let t=1;t<e.length;++t)this.applyStyles(n,e[t]);setTimeout(()=>{this.applyStyles(n,a)},0)}this.nodes[e]=t}render(){return c.a.createElement(c.a.Fragment,null,Object.values(this.children))}}o()(Ve,"defaultProps",{startStyles:[]});var We=a(490);class He extends c.a.PureComponent{constructor(e){super(e),o()(this,"avatar",Object(r.createRef)()),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptInfo;e&&(this.props.checkUnmounting&&this.props.checkUnmounting()||this.buildReadReceiptInfo(e))}componentDidMount(){this.state.suppressDisplay&&this.animateMarker()}componentDidUpdate(e){const t=e.offset!==this.props.offset,a=e.hidden!==this.props.hidden;(t||a)&&this.animateMarker()}buildReadReceiptInfo(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this.avatar.current,a=t.offsetParent;if(!(a&&a instanceof HTMLElement))return p.a.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no valid horizontalContainer`),e.top=0,e.right=0,e.parent=null,e;const n=a.offsetParent;return n&&n instanceof HTMLElement?(e.top=t.offsetTop,e.right=t.getBoundingClientRect().right-a.getBoundingClientRect().right,e.parent=n,e):(p.a.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no valid verticalContainer`),e.top=0,e.right=0,e.parent=null,e)}readReceiptPosition(e){return e.parent?e.top+e.parent.getBoundingClientRect().top:(p.a.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no offsetParent`),0)}animateMarker(){const e=this.props.readReceiptInfo,t=this.buildReadReceiptInfo(),a=this.readReceiptPosition(t),n=e?this.readReceiptPosition(e):-qe,i=[];null!=e&&e.right&&i.push({top:n-a,right:e.right}),i.push({top:n-a,right:0}),this.setState({suppressDisplay:!1,startStyles:i})}render(){if(this.state.suppressDisplay)return c.a.createElement("div",{ref:this.avatar});const e={right:Object(We.a)(this.props.offset),top:"0px"};return c.a.createElement(Ve,{startStyles:this.state.startStyles},c.a.createElement(H.a,{member:this.props.member,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true","aria-live":"off",width:14,height:14,resizeMethod:"crop",style:e,inputRef:this.avatar,hideTitle:!0,tabIndex:-1}))}}var ze=a(176);function Ke(e){const[t,a]=Object(r.useState)(!1);return[{showTooltip:()=>a(!0),hideTooltip:()=>a(!1)},c.a.createElement(F.b,i()({},e,{visible:t}))]}const qe=16;function Ge(e){let{readReceipts:t,readReceiptMap:a,checkUnmounting:n,suppressAnimation:s,isTwelveHour:o}=e;const[r,l,d,m]=Object(U.q)(),h=t.length>4,u=h?3:4,p=function(e,t){return t?Object(f.a)("%(members)s and more",{members:e.join(", ")}):e.length>1?Object(f.a)("%(members)s and %(last)s",{last:e.pop(),members:e.join(", ")}):e.length?e[0]:null}(t.slice(0,u).map(e=>{var t,a;return null!==(t=null===(a=e.roomMember)||void 0===a?void 0:a.name)&&void 0!==t?t:e.userId}),h),[{showTooltip:g,hideTooltip:b},v]=Ke({label:c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:"mx_Tooltip_title"},Object(f.a)("Seen by %(count)s people",{count:t.length})),c.a.createElement("div",{className:"mx_Tooltip_sub"},p)),alignment:F.a.TopRight});if(0===t.length)return c.a.createElement("div",{className:"mx_EventTile_msgOption"},c.a.createElement("div",{className:"mx_ReadReceiptGroup"},c.a.createElement("div",{className:"mx_ReadReceiptGroup_button"},c.a.createElement("span",{className:"mx_ReadReceiptGroup_container"}))));const E=t.map((e,t)=>{const{hidden:i,position:r}=function(e,t){return e<t?{hidden:!1,position:e}:{hidden:!0,position:0}}(t,u),l=e.userId;let d;return a&&(d=a[l],d||(d={},a[l]=d)),c.a.createElement(He,{key:l,member:e.roomMember,fallbackUserId:l,offset:10*r,hidden:i,readReceiptInfo:d,checkUnmounting:n,suppressAnimation:s,timestamp:e.ts,showTwelveHour:o})}).reverse();let y;const _=t.length-u;let S;if(_>0&&(y=c.a.createElement("span",{className:"mx_ReadReceiptGroup_remainder","aria-live":"off"},"+",_)),r){const e=l.current.getBoundingClientRect();S=c.a.createElement(U.o,i()({menuClassName:"mx_ReadReceiptGroup_popup",onFinished:m},Object(U.j)(e)),c.a.createElement(ze.a,null,c.a.createElement(Je,{className:"mx_ReadReceiptGroup_title"},Object(f.a)("Seen by %(count)s people",{count:t.length})),t.map(e=>c.a.createElement(Ye,i()({key:e.userId},e,{isTwelveHour:o,onAfterClick:m})))))}return c.a.createElement("div",{className:"mx_EventTile_msgOption"},c.a.createElement("div",{className:"mx_ReadReceiptGroup",role:"group","aria-label":Object(f.a)("Read receipts")},c.a.createElement(x.a,{className:"mx_ReadReceiptGroup_button",inputRef:l,"aria-label":p,"aria-haspopup":"true",onClick:d,onMouseOver:g,onMouseLeave:b,onFocus:g,onBlur:b},y,c.a.createElement("span",{className:"mx_ReadReceiptGroup_container",style:{width:10*Math.min(u,t.length)+qe-10}},E)),v,S))}function Ye(e){var t,a;let{userId:n,roomMember:i,ts:s,isTwelveHour:o,onAfterClick:r}=e;const[{showTooltip:l,hideTooltip:d},m]=Ke({alignment:F.a.Top,tooltipClassName:"mx_ReadReceiptGroup_person--tooltip",label:c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:"mx_Tooltip_title"},null!==(t=null==i?void 0:i.rawDisplayName)&&void 0!==t?t:n),c.a.createElement("div",{className:"mx_Tooltip_sub"},n))});return c.a.createElement(U.e,{className:"mx_ReadReceiptGroup_person",onClick:()=>{E.a.dispatch({action:w.a.ViewUser,member:null!=i?i:{userId:n},push:!1}),null==r||r()},onMouseOver:l,onMouseLeave:d,onFocus:l,onBlur:d,onWheel:d},c.a.createElement(H.a,{member:i,fallbackUserId:n,width:24,height:24,"aria-hidden":"true","aria-live":"off",resizeMethod:"crop",hideTitle:!0}),c.a.createElement("div",{className:"mx_ReadReceiptGroup_name"},c.a.createElement("p",null,null!==(a=null==i?void 0:i.name)&&void 0!==a?a:n),c.a.createElement("p",{className:"mx_ReadReceiptGroup_secondary"},Object(P.b)(new Date(s),o))),m)}function Je(e){let{className:t,children:a}=e;const n=Object(r.useRef)(),[i]=Object($.i)(n);return c.a.createElement("h3",{className:t,role:"menuitem",onFocus:i,tabIndex:-1,ref:n},a)}function $e(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Qe(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?$e(Object(a),!0).forEach((function(t){o()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):$e(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Xe extends c.a.Component{constructor(e,t){super(e,t),o()(this,"suppressReadReceiptAnimation",void 0),o()(this,"isListeningForReceipts",void 0),o()(this,"tile",c.a.createRef()),o()(this,"replyChain",c.a.createRef()),o()(this,"threadState",void 0),o()(this,"ref",Object(r.createRef)()),o()(this,"context",void 0),o()(this,"onThreadStateUpdate",()=>{var e;let t=null;switch(null===(e=this.threadState)||void 0===e?void 0:e.color){case Oe.a.Grey:t=g.a.Total;break;case Oe.a.Red:t=g.a.Highlight}this.setState({threadNotification:t})}),o()(this,"updateThread",e=>{e!==this.state.thread&&(this.threadState&&this.threadState.off(Ce.b.Update,this.onThreadStateUpdate),this.setupNotificationListener(e)),this.setState({thread:e})}),o()(this,"onNewThread",e=>{if(e.id===this.props.mxEvent.getId()){this.updateThread(e);I.a.get().getRoom(this.props.mxEvent.getRoomId()).off(u.e.New,this.onNewThread)}}),o()(this,"viewInRoom",e=>{e.preventDefault(),e.stopPropagation(),E.a.dispatch({action:w.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0})}),o()(this,"copyLinkToThread",async e=>{e.preventDefault(),e.stopPropagation();const{permalinkCreator:t,mxEvent:a}=this.props,n=t.forEvent(a.getId());await Object(ke.c)(n)}),o()(this,"onRoomReceipt",(e,t)=>{t===I.a.get().getRoom(this.props.mxEvent.getRoomId())&&(this.shouldShowSentReceipt||this.shouldShowSendingReceipt||this.isListeningForReceipts)&&this.forceUpdate(()=>{this.shouldShowSentReceipt||this.shouldShowSendingReceipt||(I.a.get().removeListener(g.c.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!1)})}),o()(this,"onDecrypted",()=>{this.verifyEvent(this.props.mxEvent),this.forceUpdate()}),o()(this,"onDeviceVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent(this.props.mxEvent)}),o()(this,"onUserVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent(this.props.mxEvent)}),o()(this,"onSenderProfileClick",()=>{E.a.dispatch({action:w.a.ComposerInsert,userId:this.props.mxEvent.getSender(),timelineRenderingType:this.context.timelineRenderingType})}),o()(this,"onRequestKeysClick",()=>{this.setState({previouslyRequestedKeys:!0}),I.a.get().cancelAndResendEventRoomKeyRequest(this.props.mxEvent)}),o()(this,"onPermalinkClicked",e=>{e.preventDefault(),E.a.dispatch({action:w.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:this.context.timelineRenderingType===j.a.Search?"MessageSearch":void 0})}),o()(this,"onActionBarFocusChange",e=>{this.setState({actionBarFocused:e})}),o()(this,"getTile",()=>this.tile.current),o()(this,"getReplyChain",()=>this.replyChain.current),o()(this,"getReactions",()=>{if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const e=this.props.mxEvent.getId();return this.props.getRelationsForEvent(e,"m.annotation","m.reaction")}),o()(this,"onReactionsCreated",(e,t)=>{"m.annotation"===e&&"m.reaction"===t&&this.setState({reactions:this.getReactions()})}),o()(this,"onContextMenu",e=>{this.showContextMenu(e)}),o()(this,"onTimestampContextMenu",e=>{var t;this.showContextMenu(e,null===(t=this.props.permalinkCreator)||void 0===t?void 0:t.forEvent(this.props.mxEvent.getId()))}),o()(this,"onCloseMenu",()=>{this.setState({contextMenu:null,actionBarFocused:!1})}),o()(this,"setQuoteExpanded",e=>{this.setState({isQuoteExpanded:e})});const a=this.thread;this.state={actionBarFocused:!1,verified:null,previouslyRequestedKeys:!1,reactions:this.getReactions(),contextMenu:null,hover:!1,thread:a},this.suppressReadReceiptAnimation=!0,this.isListeningForReceipts=!1}get isEligibleForSpecialReceipt(){if(this.props.readReceipts&&this.props.readReceipts.length>0)return!1;if(!this.props.mxEvent)return!1;if(!I.a.get().getRoom(this.props.mxEvent.getRoomId()))return!1;const e=I.a.get().getUserId();if(this.props.mxEvent.getSender()!==e)return!1;return!![m.b.Sticker,m.b.RoomMessage,m.b.RoomMessageEncrypted].includes(this.props.mxEvent.getType())}get shouldShowSentReceipt(){if(!this.isEligibleForSpecialReceipt)return!1;if(!this.props.lastSuccessful)return!1;if(this.props.eventSendStatus&&this.props.eventSendStatus!==h.a.SENT)return!1;const e=this.props.readReceipts||[],t=I.a.get().getUserId();return!e.some(e=>e.userId!==t)}get shouldShowSendingReceipt(){return!!this.isEligibleForSpecialReceipt&&!(!this.props.eventSendStatus||this.props.eventSendStatus===h.a.SENT)}UNSAFE_componentWillMount(){this.verifyEvent(this.props.mxEvent)}componentDidMount(){this.suppressReadReceiptAnimation=!1;const e=I.a.get();this.props.forExport||(e.on(v.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),e.on(v.b.UserTrustStatusChanged,this.onUserVerificationChanged),this.props.mxEvent.on(h.c.Decrypted,this.onDecrypted),xe.a.instance.addVisibleEvent(this.props.mxEvent),this.props.showReactions&&this.props.mxEvent.on(h.c.RelationsCreated,this.onReactionsCreated),(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)&&(e.on(g.c.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0)),_.b.getValue("feature_thread")&&(this.props.mxEvent.on(u.e.Update,this.updateThread),this.thread&&this.setupNotificationListener(this.thread)),e.decryptEventIfNeeded(this.props.mxEvent);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.on(u.e.New,this.onNewThread)}setupNotificationListener(e){const t=we.a.instance.getThreadsRoomState(e.room);this.threadState=t.getThreadRoomState(e),this.threadState.on(Ce.b.Update,this.onThreadStateUpdate),this.onThreadStateUpdate()}UNSAFE_componentWillReceiveProps(e){e.eventSendStatus!==this.props.eventSendStatus&&this.verifyEvent(e.mxEvent)}shouldComponentUpdate(e,t){return!!Object(L.c)(this.state,t)||!this.propsEqual(this.props,e)}componentWillUnmount(){const e=I.a.get();e.removeListener(v.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),e.removeListener(v.b.UserTrustStatusChanged,this.onUserVerificationChanged),e.removeListener(g.c.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!1,this.props.mxEvent.removeListener(h.c.Decrypted,this.onDecrypted),this.props.showReactions&&this.props.mxEvent.removeListener(h.c.RelationsCreated,this.onReactionsCreated),_.b.getValue("feature_thread")&&this.props.mxEvent.off(u.e.Update,this.updateThread);const t=I.a.get().getRoom(this.props.mxEvent.getRoomId());null==t||t.off(u.e.New,this.onNewThread),this.threadState&&this.threadState.off(Ce.b.Update,this.onThreadStateUpdate)}componentDidUpdate(e,t,a){this.isListeningForReceipts||!this.shouldShowSentReceipt&&!this.shouldShowSendingReceipt||(I.a.get().on(g.c.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0)}get thread(){var e;if(!_.b.getValue("feature_thread"))return null;let t=this.props.mxEvent.getThread();if(!t){const e=I.a.get().getRoom(this.props.mxEvent.getRoomId());t=null==e?void 0:e.findThreadForEvent(this.props.mxEvent)}return null!==(e=t)&&void 0!==e?e:null}renderThreadPanelSummary(){return this.state.thread?c.a.createElement("div",{className:"mx_ThreadPanel_replies"},c.a.createElement("span",{className:"mx_ThreadPanel_ThreadsAmount"},this.state.thread.length),c.a.createElement(Ue,{thread:this.state.thread})):null}renderThreadInfo(){var e;return(null===(e=this.state.thread)||void 0===e?void 0:e.id)===this.props.mxEvent.getId()?c.a.createElement(Le,{mxEvent:this.props.mxEvent,thread:this.state.thread}):this.context.timelineRenderingType===j.a.Search&&this.props.mxEvent.threadRootId?this.props.highlightLink?c.a.createElement("a",{className:"mx_ThreadSummaryIcon",href:this.props.highlightLink},Object(f.a)("From a thread")):c.a.createElement("p",{className:"mx_ThreadSummaryIcon"},Object(f.a)("From a thread")):void 0}async verifyEvent(e){if(!e.isEncrypted()||e.isRedacted())return;const t=I.a.get().getEventEncryptionInfo(e),a=e.getSender(),n=I.a.get().checkUserTrust(a);if(t.mismatchedSender)return void this.setState({verified:M.a.Warning},this.props.onHeightChanged);if(!n.isCrossSigningVerified())return void this.setState({verified:M.a.Normal},this.props.onHeightChanged);const i=t.sender&&I.a.get().checkDeviceTrust(a,t.sender.deviceId);i?i.isVerified()?t.authenticated?this.setState({verified:M.a.Verified},this.props.onHeightChanged):this.setState({verified:M.a.Unauthenticated},this.props.onHeightChanged):this.setState({verified:M.a.Warning},this.props.onHeightChanged):this.setState({verified:M.a.Unknown},this.props.onHeightChanged)}propsEqual(e,t){const a=Object.keys(e),n=Object.keys(t);if(a.length!==n.length)return!1;for(let n=0;n<a.length;n++){const i=a[n];if(!t.hasOwnProperty(i))return!1;if("readReceipts"===i){const a=e[i],n=t[i];if(a===n)continue;if(!a||!n)return!1;if(a.length!==n.length)return!1;for(let e=0;e<a.length;e++){if(a[e].userId!==n[e].userId)return!1;if(a[e].roomMember!==n[e].roomMember)return!1}}else if(e[i]!==t[i])return!1}return!0}shouldHighlight(){if(this.props.forExport)return!1;if(this.context.timelineRenderingType===j.a.Notification)return!1;if(this.context.timelineRenderingType===j.a.ThreadsList)return!1;const e=I.a.get().getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent);return!(!e||!e.tweaks)&&(this.props.mxEvent.getSender()!==I.a.get().credentials.userId&&e.tweaks.highlight)}renderE2EPadlock(){const e=this.props.mxEvent;if("m.bad.encrypted"===e.getContent().msgtype)return c.a.createElement(tt,null);if(e.isEncrypted()&&!e.isRedacted())return this.state.verified===M.a.Normal||this.state.verified===M.a.Verified?void 0:this.state.verified===M.a.Unauthenticated?c.a.createElement(st,null):this.state.verified===M.a.Unknown?c.a.createElement(it,null):c.a.createElement(at,null);if(I.a.get().isRoomEncrypted(e.getRoomId())){if(e.status===h.a.ENCRYPTING)return;if(e.status===h.a.NOT_SENT)return;if(e.isState())return;if(e.isRedacted())return;return c.a.createElement(nt,null)}return null}showContextMenu(e,t){const a=e.target;if(!_.b.getValue("feature_message_right_click_context_menu"))return;const n=a instanceof HTMLAnchorElement?a:a.closest("a");a instanceof HTMLImageElement||(W.a.get().allowOverridingNativeContextMenus()||!Object(ke.d)()&&!n)&&(this.props.editState||(e.preventDefault(),e.stopPropagation(),this.setState({contextMenu:{position:{left:e.clientX,top:e.clientY,bottom:e.clientY},link:(null==n?void 0:n.href)||t},actionBarFocused:!0})))}shouldHideEvent(){var e;return(null===(e=this.props.callEventGrouper)||void 0===e?void 0:e.hangupReason)===b.b.Replaced}renderContextMenu(){if(!this.state.contextMenu)return null;const e=this.getTile(),t=this.getReplyChain(),a=null!=e&&e.getEventTileOps?e.getEventTileOps():void 0,n=null!=t&&t.canCollapse()?t.collapse:void 0;return c.a.createElement(A.a,i()({},Object(U.k)(this.state.contextMenu.position),{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,eventTileOps:a,collapseReplyChain:n,onFinished:this.onCloseMenu,rightClick:!0,reactions:this.state.reactions,link:this.state.contextMenu.link}))}render(){var e,t;const a=this.props.mxEvent.getContent().msgtype,n=this.props.mxEvent.getType(),{hasRenderer:i,isBubbleMessage:s,isInfoMessage:o,isLeftAlignedBubbleMessage:r,noBubbleEvent:l,isSeeingThroughMessageHiddenForModeration:h}=Object(ye.a)(this.props.mxEvent,this.context.showHiddenEvents,this.shouldHideEvent()),{isQuoteExpanded:u}=this.state;if(!i){const{mxEvent:e}=this.props;return p.a.warn(`Event type not supported: type:${n} isState:${e.isState()}`),c.a.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},c.a.createElement("div",{className:"mx_EventTile_line"},Object(f.a)("This event could not be displayed")))}const g=X.a.isEligible(this.props.mxEvent),b=d()("mx_EventTile_line",{mx_EventTile_mediaLine:g,mx_EventTile_image:this.props.mxEvent.getType()===m.b.RoomMessage&&this.props.mxEvent.getContent().msgtype===m.c.Image,mx_EventTile_sticker:this.props.mxEvent.getType()===m.b.Sticker,mx_EventTile_emote:this.props.mxEvent.getType()===m.b.RoomMessage&&this.props.mxEvent.getContent().msgtype===m.c.Emote}),v=-1!==["sending","queued","encrypting"].indexOf(this.props.eventSendStatus),E=Object(Me.d)(this.props.mxEvent)&&this.props.isRedacted,y=this.props.mxEvent.isDecryptionFailure();let _=this.props.continuation;this.context.timelineRenderingType!==j.a.Room&&this.context.timelineRenderingType!==j.a.Search&&this.context.timelineRenderingType!==j.a.Thread&&this.props.layout!==N.a.Bubble&&(_=!1);const S=!!this.props.editState,w=d()({mx_EventTile_bubbleContainer:s,mx_EventTile_leftAlignedBubble:r,mx_EventTile:!0,mx_EventTile_isEditing:S,mx_EventTile_info:o,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_sending:!S&&v,mx_EventTile_highlight:this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent||this.state.contextMenu,mx_EventTile_continuation:_||n===m.b.CallInvite,mx_EventTile_last:this.props.last,mx_EventTile_lastInSection:this.props.lastInSection,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_verified:!s&&this.state.verified===M.a.Verified,mx_EventTile_unverified:!s&&this.state.verified===M.a.Warning,mx_EventTile_unknown:!s&&this.state.verified===M.a.Unknown,mx_EventTile_bad:y,mx_EventTile_emote:a===m.c.Emote,mx_EventTile_noSender:this.props.hideSender,mx_EventTile_clamp:this.context.timelineRenderingType===j.a.ThreadsList,mx_EventTile_noBubble:l}),C=null!==this.props.eventSendStatus?"off":void 0;let O="#";this.props.permalinkCreator&&(O=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const k=this.props.mxEvent.status?void 0:this.props.mxEvent.getId();let A,U,L,F;if(this.context.timelineRenderingType===j.a.Notification?(L=24,F=!0):o?(L=14,F=!1):this.context.timelineRenderingType===j.a.ThreadsList||this.context.timelineRenderingType===j.a.Thread&&!this.props.continuation?(L=32,F=!0):n===m.b.RoomCreate||s?(L=0,F=!1):this.props.layout==N.a.IRC?(L=14,F=!0):this.props.continuation&&this.context.timelineRenderingType!==j.a.File||n===m.b.CallInvite?(L=0,F=!1):(L=30,F=!0),this.props.mxEvent.sender&&L){let e;e=this.props.mxEvent.getContent().third_party_invite?this.props.mxEvent.target:this.props.mxEvent.sender,A=c.a.createElement("div",{className:"mx_EventTile_avatar"},c.a.createElement(H.a,{member:e,width:L,height:L,viewUserOnClick:!0,forceHistorical:this.props.mxEvent.getType()===m.b.RoomMember}))}F&&!0!==this.props.hideSender&&(U=this.context.timelineRenderingType===j.a.Room||this.context.timelineRenderingType===j.a.Search||this.context.timelineRenderingType===j.a.Pinned||this.context.timelineRenderingType===j.a.Thread?c.a.createElement(z.a,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent}):c.a.createElement(z.a,{mxEvent:this.props.mxEvent}));const B=!S&&!this.props.forExport?c.a.createElement(me,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyChain:this.getReplyChain,onFocusChange:this.onActionBarFocusChange,isQuoteExpanded:u,toggleThreadExpanded:()=>this.setQuoteExpanded(!u),getRelationsForEvent:this.props.getRelationsForEvent}):void 0,V=this.props.mxEvent.getTs()&&(this.props.alwaysShowTimestamps||this.props.last||this.state.hover||this.state.actionBarFocused||Boolean(this.state.contextMenu)),W=this.context.timelineRenderingType!==j.a.ThreadsList?this.props.mxEvent.getTs():null===(e=this.state.thread)||void 0===e?void 0:e.replyToEvent.getTs(),q=c.a.createElement(K.a,{showRelative:this.context.timelineRenderingType===j.a.ThreadsList,showTwelveHour:this.props.isTwelveHour,ts:W}),Y=V&&W?q:null,$=c.a.createElement("div",{className:"mx_EventTile_keyRequestInfo_tooltip_contents"},c.a.createElement("p",null,this.state.previouslyRequestedKeys?Object(f.a)("Your key share request has been sent - please check your other sessions for key share requests."):Object(f.a)("Key share requests are sent to your other sessions automatically. If you rejected or dismissed the key share request on your other sessions, click here to request the keys for this session again.")),c.a.createElement("p",null,Object(f.a)("If your other sessions do not have the key for this message you will not be able to decrypt them."))),Q=this.state.previouslyRequestedKeys?Object(f.a)("Key request sent."):Object(f.a)("<requestLink>Re-request encryption keys</requestLink> from your other sessions.",{},{requestLink:e=>c.a.createElement(x.a,{className:"mx_EventTile_rerequestKeysCta",kind:"link_inline",tabIndex:0,onClick:this.onRequestKeysClick},e)}),Z=y&&!E?c.a.createElement("div",{className:"mx_EventTile_keyRequestInfo"},c.a.createElement("span",{className:"mx_EventTile_keyRequestInfo_text"},Q),c.a.createElement(G,{helpText:$})):null;let ee;E||(ee=c.a.createElement(Ee,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,key:"mx_EventTile_reactionsRow"}));const te=c.a.createElement("a",{href:O,onClick:this.onPermalinkClicked,"aria-label":Object(P.k)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour),onContextMenu:this.onTimestampContextMenu},Y),ae=this.props.layout===N.a.IRC,ie=ae?null:te,se=ae?te:null,oe=this.props.layout===N.a.Bubble?q:null,re=!ae&&!s&&this.renderE2EPadlock(),ce=ae&&!s&&this.renderE2EPadlock();let le;var de,he;this.props.showReadReceipts&&(le=this.shouldShowSentReceipt||this.shouldShowSendingReceipt?c.a.createElement(rt,{messageState:this.props.mxEvent.getAssociatedStatus()}):c.a.createElement(Ge,{readReceipts:null!==(de=this.props.readReceipts)&&void 0!==de?de:[],readReceiptMap:null!==(he=this.props.readReceiptMap)&&void 0!==he?he:{},checkUnmounting:this.props.checkUnmounting,suppressAnimation:this.suppressReadReceiptAnimation,isTwelveHour:this.props.isTwelveHour}));let ue;Object(Me.c)(this.props.mxEvent,this.context.showHiddenEvents)&&Object(R.c)(this.props.mxEvent)&&(ue=c.a.createElement(T,{parentEv:this.props.mxEvent,onHeightChanged:this.props.onHeightChanged,ref:this.replyChain,forExport:this.props.forExport,permalinkCreator:this.props.permalinkCreator,layout:this.props.layout,alwaysShowTimestamps:this.props.alwaysShowTimestamps||this.state.hover,isQuoteExpanded:u,setQuoteExpanded:this.setQuoteExpanded,getRelationsForEvent:this.props.getRelationsForEvent}));const pe=(null===(t=this.props.mxEvent)||void 0===t?void 0:t.getSender())===I.a.get().getUserId();switch(this.context.timelineRenderingType){case j.a.Notification:{const e=I.a.get().getRoom(this.props.mxEvent.getRoomId());return c.a.createElement(this.props.as||"li",{className:w,"aria-live":C,"aria-atomic":!0,"data-scroll-tokens":k},[c.a.createElement("div",{className:"mx_EventTile_roomName",key:"mx_EventTile_roomName"},c.a.createElement(D.a,{room:e,width:28,height:28}),c.a.createElement("a",{href:O,onClick:this.onPermalinkClicked},e?e.name:"")),c.a.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},A,c.a.createElement("a",{href:O,onClick:this.onPermalinkClicked,onContextMenu:this.onTimestampContextMenu},U,Y)),c.a.createElement("div",{className:b,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),Object(Me.g)(j.a.Notification,Qe(Qe({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:h,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents))])}case j.a.Thread:{const e=I.a.get().getRoom(this.props.mxEvent.getRoomId());return c.a.createElement(this.props.as||"li",{ref:this.ref,className:w,"aria-live":C,"aria-atomic":!0,"data-scroll-tokens":k,"data-has-reply":!!ue,"data-layout":this.props.layout,"data-self":pe,"data-event-id":this.props.mxEvent.getId(),onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},[c.a.createElement("div",{className:"mx_EventTile_roomName",key:"mx_EventTile_roomName"},c.a.createElement(D.a,{room:e,width:28,height:28}),c.a.createElement("a",{href:O,onClick:this.onPermalinkClicked},e?e.name:"")),c.a.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},A,U),c.a.createElement("div",{className:b,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),ue,Object(Me.g)(j.a.Thread,Qe(Qe({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:h,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),B,c.a.createElement("a",{href:O,onClick:this.onPermalinkClicked},Y)),ee])}case j.a.ThreadsList:return c.a.createElement(this.props.as||"li",{ref:this.ref,className:w,tabIndex:-1,"aria-live":C,"aria-atomic":"true","data-scroll-tokens":k,"data-layout":this.props.layout,"data-shape":this.context.timelineRenderingType,"data-self":pe,"data-has-reply":!!ue,"data-notification":this.state.threadNotification,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1}),onClick:e=>{Object(ne.a)({rootEvent:this.props.mxEvent,push:!0});const t=e.currentTarget,a=Array.from(t.parentElement.children).indexOf(t);je.b.trackInteraction("WebThreadsPanelThreadItem",e,a)}},c.a.createElement(c.a.Fragment,null,U,A,Y,c.a.createElement("div",{className:b,key:"mx_EventTile_line"},c.a.createElement("div",{className:"mx_EventTile_body"},this.props.mxEvent.isRedacted()?c.a.createElement(Re.a,{mxEvent:this.props.mxEvent}):_e.a.instance.generatePreviewForEvent(this.props.mxEvent)),this.renderThreadPanelSummary()),c.a.createElement(J.a,{className:"mx_MessageActionBar","aria-label":Object(f.a)("Message Actions"),"aria-live":"off"},c.a.createElement(Se.a,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_viewInRoom",onClick:this.viewInRoom,title:Object(f.a)("View in room"),key:"view_in_room"}),c.a.createElement(Se.a,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_copyLinkToThread",onClick:this.copyLinkToThread,title:Object(f.a)("Copy link to thread"),key:"copy_link_to_thread"})),le));case j.a.File:return c.a.createElement(this.props.as||"li",{className:w,"aria-live":C,"aria-atomic":!0,"data-scroll-tokens":k},[c.a.createElement("div",{className:b,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),Object(Me.g)(j.a.File,Qe(Qe({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:h,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents)),c.a.createElement("a",{className:"mx_EventTile_senderDetailsLink",key:"mx_EventTile_senderDetailsLink",href:O,onClick:this.onPermalinkClicked},c.a.createElement("div",{className:"mx_EventTile_senderDetails",onContextMenu:this.onTimestampContextMenu},U,Y))]);default:return c.a.createElement(this.props.as||"li",{ref:this.ref,className:w,tabIndex:-1,"aria-live":C,"aria-atomic":"true","data-scroll-tokens":k,"data-layout":this.props.layout,"data-self":pe,"data-event-id":this.props.mxEvent.getId(),"data-has-reply":!!ue,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},c.a.createElement(c.a.Fragment,null,se,U,ce,A,c.a.createElement("div",{className:b,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),ie,re,ue,Object(Me.g)(this.context.timelineRenderingType,Qe(Qe({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:h,timestamp:oe,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),Z,B,this.props.layout===N.a.IRC&&c.a.createElement(c.a.Fragment,null,ee,this.renderThreadInfo())),this.props.layout!==N.a.IRC&&c.a.createElement(c.a.Fragment,null,ee,this.renderThreadInfo()),le))}}}o()(Xe,"defaultProps",{onHeightChanged:function(){},forExport:!1,layout:N.a.Group}),o()(Xe,"contextType",j.b);const Ze=Object(r.forwardRef)((e,t)=>c.a.createElement(Pe,{mxEvent:e.mxEvent,layout:e.layout},c.a.createElement(Xe,i()({ref:t},e))));var et;t.a=Ze;function tt(e){return c.a.createElement(ot,i()({title:Object(f.a)("This message cannot be decrypted"),icon:et.Warning},e))}function at(e){return c.a.createElement(ot,i()({title:Object(f.a)("Encrypted by an unverified session"),icon:et.Warning},e))}function nt(e){return c.a.createElement(ot,i()({title:Object(f.a)("Unencrypted"),icon:et.Warning},e))}function it(e){return c.a.createElement(ot,i()({title:Object(f.a)("Encrypted by a deleted session"),icon:et.Normal},e))}function st(e){return c.a.createElement(ot,i()({title:Object(f.a)("The authenticity of this encrypted message can't be guaranteed on this device."),icon:et.Normal},e))}!function(e){e.Normal="normal",e.Warning="warning"}(et||(et={}));class ot extends c.a.Component{constructor(e){super(e),o()(this,"onHoverStart",()=>{this.setState({hover:!0})}),o()(this,"onHoverEnd",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){let e=null;this.state.hover&&(e=c.a.createElement(F.b,{className:"mx_EventTile_e2eIcon_tooltip",label:this.props.title}));const t="mx_EventTile_e2eIcon mx_EventTile_e2eIcon_"+this.props.icon;return c.a.createElement("div",{className:t,onMouseEnter:this.onHoverStart,onMouseLeave:this.onHoverEnd},e)}}function rt(e){let{messageState:t}=e;const a=!t||"sent"===t,n="not_sent"===t,i=d()({mx_EventTile_receiptSent:a,mx_EventTile_receiptSending:!a&&!n});let s=null;n&&(s=c.a.createElement(V.a,{notification:B.a.RED_EXCLAMATION}));let o=Object(f.a)("Sending your message...");"encrypting"===t?o=Object(f.a)("Encrypting your message..."):a?o=Object(f.a)("Your message was sent"):n&&(o=Object(f.a)("Failed to send"));const[{showTooltip:r,hideTooltip:l},m]=Ke({label:o,alignment:F.a.TopRight});return c.a.createElement("div",{className:"mx_EventTile_msgOption"},c.a.createElement("div",{className:"mx_ReadReceiptGroup"},c.a.createElement("div",{className:"mx_ReadReceiptGroup_button",onMouseOver:r,onMouseLeave:l,onFocus:r,onBlur:l},c.a.createElement("span",{className:"mx_ReadReceiptGroup_container"},c.a.createElement("span",{className:i},s))),m))}},413:function(e,t,a){"use strict";(function(e){a.d(t,"h",(function(){return G})),a.d(t,"b",(function(){return Y})),a.d(t,"a",(function(){return J})),a.d(t,"d",(function(){return $})),a.d(t,"c",(function(){return X})),a.d(t,"j",(function(){return te})),a.d(t,"k",(function(){return ne})),a.d(t,"e",(function(){return ie})),a.d(t,"i",(function(){return le})),a.d(t,"l",(function(){return de})),a.d(t,"g",(function(){return me})),a.d(t,"f",(function(){return he})),a.d(t,"m",(function(){return be}));var n=a(120),i=a(243),s=a(284),o=a(0),r=a(90),c=a(249),l=a(274),d=a(605),m=a(162),h=a(286),u=a(549),p=a(1397),g=a(92),b=a(135),v=a(95),f=a(337),E=a(126),y=a(352),_=a(381),S=a(93),w=a(755),C=a(160),O=a(235),k=a(459),x=a(1486),R=a(505),j=a(307),I=a(808),T=a(173),N=a(156),P=a(1401),M=a(107),D=a(89),A=a(1402),U=a(1403),L=a(1404),F=a(1405),B=a(513),V=a(98),W=a(1484),H=a(298),z=a(257),K=a(96),q=a(452);async function G(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{let t=e.enableGuest||!1;const a=e.guestHsUrl,n=e.guestIsUrl,i=e.fragmentQueryParams||{},s=e.defaultDeviceDisplayName;if(t&&!a&&(o.a.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&i.guest_user_id&&i.guest_access_token)return o.a.log("Using guest access credentials"),se({userId:i.guest_user_id,accessToken:i.guest_access_token,homeserverUrl:a,identityServerUrl:n,guest:!0},!0).then(()=>!0);return!!await te({ignoreGuest:Boolean(e.ignoreGuest)})||!!t&&Q(a,n,s)}catch(e){return!(e instanceof oe)&&ae(e)}}async function Y(){const{hsUrl:e,userId:t,hasAccessToken:a,isGuest:n}=await X();return e&&t&&a?[t,n]:[null,null]}function J(e,t,a){if(!e.loginToken)return Promise.resolve(!1);const i=localStorage.getItem(j.a),s=localStorage.getItem(j.c);return i?Object(y.c)(i,s,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then((function(e){return o.a.log("Logged in with token"),ge().then(async()=>(await re(e),sessionStorage.setItem("mx_fresh_login",String(!0)),!0))})).catch(e=>(v.a.createTrackedDialog("SSO","Token Rejected",M.a,{title:Object(D.a)("We couldn't log you in"),description:"ConnectionError"===e.name?Object(D.a)("Your homeserver was unreachable and was not able to log you in. Please try again. If this continues, please contact your homeserver administrator."):Object(D.a)("Your homeserver rejected your log in attempt. This could be due to things just taking too long. Please try again. If this continues, please contact your homeserver administrator."),button:Object(D.a)("Try again"),onFinished:e=>{if(e){const e=Object(n.createClient)({baseUrl:i,idBaseUrl:s}),t=localStorage.getItem(j.b)||void 0;E.a.get().startSingleSignOn(e,"sso",a,t)}}}),o.a.error("Failed to log in with login token:"),o.a.error(e),!1)):(o.a.warn("Cannot log in with token: can't determine HS URL to use"),v.a.createTrackedDialog("SSO","Unknown HS",M.a,{title:Object(D.a)("We couldn't log you in"),description:Object(D.a)("We asked the browser to remember which homeserver you use to let you sign in, but unfortunately your browser has forgotten it. Go to the sign in page and try again."),button:Object(D.a)("Try again")}),Promise.resolve(!1))}function $(e){if(e.reason===i.b.TOGGLED_LAZY_LOADING)return Promise.resolve().then(()=>{const t=e.value;return new Promise(t?e=>{v.a.createDialog(A.a,{onFinished:e})}:e=>{v.a.createDialog(U.a,{onFinished:e,host:window.location.host})})}).then(()=>r.a.get().store.deleteAllData()).then(()=>{E.a.get().reload()})}function Q(e,t,a){o.a.log("Doing guest login on "+e);return Object(n.createClient)({baseUrl:e}).registerGuest({body:{initial_device_display_name:a}}).then(a=>(o.a.log("Registered as guest: "+a.user_id),se({userId:a.user_id,deviceId:a.device_id,accessToken:a.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0).then(()=>!0)),e=>(o.a.error("Failed to register as guest",e),!1))}async function X(){const e=localStorage.getItem("mx_hs_url"),t=localStorage.getItem("mx_is_url");let a;try{a=await _.c("account","mx_access_token")}catch(e){o.a.error("StorageManager.idbLoad failed for account:mx_access_token",e)}if(!a&&(a=localStorage.getItem("mx_access_token"),a))try{await _.d("account","mx_access_token",a),localStorage.removeItem("mx_access_token")}catch(e){o.a.error("migration of access token to IndexedDB failed",e)}const n="true"===localStorage.getItem("mx_has_access_token")||!!a,i=localStorage.getItem("mx_user_id"),s=localStorage.getItem("mx_device_id");let r;return r=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:e,isUrl:t,hasAccessToken:n,accessToken:a,userId:i,deviceId:s,isGuest:r}}async function Z(e){const t=new Uint8Array(e.length);for(let a=0;a<e.length;a++)t[a]=e.charCodeAt(a);const a=await window.crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await window.crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},a,256))}async function ee(){if(await new Promise(e=>{v.a.createTrackedDialog("Storage evicted","",F.a,{onFinished:e})}))throw await ge(),new oe("Aborting login in progress because of storage inconsistency")}async function te(e){const t=null==e?void 0:e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:a,isUrl:n,hasAccessToken:i,accessToken:r,userId:c,deviceId:l,isGuest:d}=await X();if(i&&!r&&ee(),r&&c&&a){if(t&&d)return o.a.log("Ignoring stored guest account: "+c),!1;let e=r;const i=await E.a.get().getPickleKey(c,l);if(i){if(o.a.log("Got pickle key"),"string"!=typeof r){const t=await Z(i);e=await Object(s.b)(r,t,"access_token"),t.fill(0)}}else o.a.log("No pickle key available");const m="true"===sessionStorage.getItem("mx_fresh_login");return sessionStorage.removeItem("mx_fresh_login"),o.a.log("Restoring session for "+c),await se({userId:c,deviceId:l,accessToken:e,homeserverUrl:a,identityServerUrl:n,guest:d,pickleKey:i,freshLogin:m},!1),!0}return o.a.log("No previous session found."),!1}async function ae(e){o.a.error("Unable to load session",e);const t=v.a.createTrackedDialog("Session Restore Error","",L.a,{error:e}),[a]=await t.finished;return a?(await ge(),!1):G()}async function ne(e){e.freshLogin=!0,be();const t=e.userId&&e.deviceId?await E.a.get().createPickleKey(e.userId,e.deviceId):null;return t?o.a.log("Created pickle key"):o.a.log("Pickle key not created"),se(Object.assign({},e,{pickleKey:t}),!0)}async function ie(e){const t=r.a.get().getUserId(),a=r.a.get().getDeviceId();be(),localStorage.removeItem("mx_soft_logout"),ce=!1;const n=e.userId!==t||e.deviceId!==a;return n&&o.a.warn("Clearing all data: Old session belongs to a different user/session"),e.pickleKey||(o.a.info("Lifecycle#hydrateSession: Pickle key not provided - trying to get one"),e.pickleKey=await E.a.get().getPickleKey(e.userId,e.deviceId)),se(e,n)}async function se(e,t){e.guest=Boolean(e.guest);const a=me();o.a.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+a," freshLogin: "+e.freshLogin),g.a.dispatch({action:"on_logging_in"},!0),t&&await ge();const n=await _.a();n.dataInLocalStorage&&n.cryptoInited&&!n.dataInCryptoStore&&await ee(),m.a.setLoggedIn(e.guest,e.homeserverUrl),r.a.replaceUsingCreds(e),Object(B.c)(e.userId),T.a.instance.isEnabled()&&T.a.instance.startListeningToSettingsChanges();const i=r.a.get();if(e.freshLogin&&S.b.getValue("feature_dehydration")){const t=await i.rehydrateDevice();t&&(e.deviceId=t),delete e.freshLogin}if(localStorage)try{await re(e),sessionStorage.removeItem("mx_fresh_login")}catch(e){o.a.warn("Error using local storage: can't persist session!",e)}else o.a.warn("No local storage available: can't persist session!");return g.a.fire(K.a.OnLoggedIn),await ue(!a),i}g.a.register(e=>{e.action===K.a.TriggerLogout&&pe()});class oe extends Error{}async function re(e){var t;if(localStorage.setItem("mx_hs_url",e.homeserverUrl),e.identityServerUrl&&localStorage.setItem("mx_is_url",e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),e.accessToken?localStorage.setItem("mx_has_access_token","true"):localStorage.deleteItem("mx_has_access_token"),e.pickleKey){let t;try{const a=await Z(e.pickleKey);t=await Object(s.c)(e.accessToken,a,"access_token"),a.fill(0)}catch(e){o.a.warn("Could not encrypt access token",e)}try{await _.d("account","mx_access_token",t||e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}localStorage.setItem("mx_has_pickle_key",String(!0))}else{try{await _.d("account","mx_access_token",e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}localStorage.getItem("mx_has_pickle_key")&&o.a.error("Expected a pickle key, but none provided.  Encryption may not work.")}e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),null===(t=c.a.persistCredentials)||void 0===t||t.call(c.a,e),o.a.log("Session persisted for "+e.userId)}let ce=!1;function le(){if(!r.a.get())return;if(T.a.instance.logout(),r.a.get().isGuest())return void e(()=>pe());ce=!0;const t=r.a.get();E.a.get().destroyPickleKey(t.getUserId(),t.getDeviceId()),t.logout(void 0,!0).then(pe,e=>{o.a.warn("Failed to call logout API: token will not be invalidated",e),pe()})}function de(){r.a.get()&&(localStorage.setItem("mx_soft_logout","true"),o.a.log("Soft logout initiated"),ce=!0,g.a.dispatch({action:"on_client_not_viable"}),be(!1))}function me(){return"true"===localStorage.getItem("mx_soft_logout")}function he(){return ce}async function ue(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];o.a.log("Lifecycle: Starting MatrixClient"),g.a.dispatch({action:"will_start_client"},!0),w.a.sharedInstance().reset(),C.a.sharedInstance().reset(),W.a.instance.prepare(),h.default.start(),u.a.sharedInstance().start(),b.a.makeShared().start(),O.a.sharedInstance().startWatching(),f.b.instance.start(),N.b.instance.start(),k.a.sharedInstance().start(),e?(await l.a.init(),await r.a.start()):(o.a.warn("Caller requested only auxiliary services be started"),await r.a.assign()),x.a.sharedInstance().start(),S.b.getValue("lowBandwidth")||p.a.start(),R.a.getInstance().start(),H.b.instance.roomId&&Object(z.e)(r.a.get().getRoom(H.b.instance.roomId),!1),g.a.dispatch({action:"client_started"}),me()&&de()}async function pe(){var e;g.a.fire(K.a.OnLoggedOut,!0),be(),await ge({deleteEverything:!0}),null===(e=P.a.onLoggedOutAndStorageCleared)||void 0===e||e.call(P.a),V.b.get().logout_redirect_url&&(o.a.log("Redirecting to external provider to finish logout"),setTimeout(()=>{window.location.href=V.b.get().logout_redirect_url},100)),ce=!1}async function ge(e){var t;if(m.a.disable(),window.localStorage){const t=I.a.instance.getWireInvites(),a=window.localStorage.getItem("mx_registration_time");window.localStorage.clear(),q.a.clear();try{await _.b("account","mx_access_token")}catch(e){o.a.error("idbDelete failed for account:mx_access_token",e)}null!=e&&e.deleteEverything||(t.forEach(e=>{const t=e.roomId;delete e.roomId,I.a.instance.storeInvite(t,e)}),a&&window.localStorage.setItem("mx_registration_time",a))}null===(t=window.sessionStorage)||void 0===t||t.clear();const a=Object(d.a)({baseUrl:""});await l.a.deleteEventIndex(),await a.clearStores()}function be(){var e;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];h.default.stop(),N.b.instance.stop(),u.a.sharedInstance().stop(),w.a.sharedInstance().reset(),p.a.stop(),f.b.instance.stop(),O.a.sharedInstance().stopWatching(),k.a.sharedInstance().stop(),x.a.sharedInstance().stop(),null===(e=b.a.shared())||void 0===e||e.stop(),l.a.stop();const a=r.a.get();a&&(a.stopClient(),a.removeAllListeners(),t&&(r.a.unset(),l.a.unset()))}window.mxLoginWithAccessToken=async(e,t)=>{const a=Object(n.createClient)({baseUrl:e,accessToken:t}),{user_id:i}=await a.whoami();await se({homeserverUrl:e,accessToken:t,userId:i},!0)}}).call(this,a(179).setImmediate)},414:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n=a(87),i=a(116),s=a(118);const o=e=>e,r=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o;const[a,r]=Object(n.useState)(e?t(e.currentState):void 0),c=Object(n.useCallback)(()=>{e&&r(t(e.currentState))},[e,t]);return Object(s.c)(null==e?void 0:e.currentState,i.b.Update,c),Object(n.useEffect)(()=>(c(),()=>{r(void 0)}),[c]),a}},415:function(e,t,a){"use strict";a.d(t,"a",(function(){return p}));var n=a(88),i=a.n(n),s=a(113),o=a(7),r=a(119),c=a(93),l=a(167),d=a(92),m=a(121),h=a(104),u=a(96);class p extends l.a{constructor(){super(d.a),i()(this,"waitingRooms",[]),i()(this,"onMyMembership",async e=>{const t=c.b.getValue("breadcrumbs",null,!0);this.meetsRoomRequirement&&Object(o.t)(t)&&await c.b.setValue("breadcrumbs",null,h.a.ACCOUNT,!0)}),i()(this,"onRoom",async e=>{const t=this.waitingRooms.find(t=>t.roomId===e.roomId);t&&(this.waitingRooms.splice(this.waitingRooms.indexOf(t),1),Date.now()-t.addedTs>9e4||await this.appendRoom(e))}),c.b.monitorSetting("breadcrumb_rooms",null),c.b.monitorSetting("breadcrumbs",null),c.b.monitorSetting("feature_breadcrumbs_v2",null)}static get instance(){return p.internalInstance}get rooms(){return this.state.rooms||[]}get visible(){return this.state.enabled&&this.meetsRoomRequirement}get meetsRoomRequirement(){var e;return!!c.b.getValue("feature_breadcrumbs_v2")||(null===(e=this.matrixClient)||void 0===e?void 0:e.getVisibleRooms().length)>=20}async onAction(e){if(this.matrixClient)if(e.action===u.a.SettingUpdated)"breadcrumb_rooms"===e.settingName?await this.updateRooms():"breadcrumbs"!==e.settingName&&"feature_breadcrumbs_v2"!==e.settingName||await this.updateState({enabled:c.b.getValue("breadcrumbs",null)});else if(e.action===u.a.ViewRoom)if(e.auto_join&&!this.matrixClient.getRoom(e.room_id))this.waitingRooms.push({roomId:e.room_id,addedTs:Date.now()});else{const t=this.matrixClient.getRoom(e.room_id),a=null==t?void 0:t.getMyMembership();t&&"join"===a&&await this.appendRoom(t)}else if(e.action===u.a.JoinRoom){const t=this.matrixClient.getRoom(e.roomId);t&&await this.appendRoom(t)}}async onReady(){await this.updateRooms(),await this.updateState({enabled:c.b.getValue("breadcrumbs",null)}),this.matrixClient.on(s.c.MyMembership,this.onMyMembership),this.matrixClient.on(r.b.Room,this.onRoom)}async onNotReady(){this.matrixClient.removeListener(s.c.MyMembership,this.onMyMembership),this.matrixClient.removeListener(r.b.Room,this.onRoom)}async updateRooms(){let e=c.b.getValue("breadcrumb_rooms");e&&0!==e.length||(e=[]);const t=e.map(e=>this.matrixClient.getRoom(e)).filter(e=>!!e),a=this.state.rooms||[];Object(m.d)(t,a)&&await this.updateState({rooms:t})}async appendRoom(e){let t=!1;const a=(this.state.rooms||[]).slice(),n=this.matrixClient.getRoomUpgradeHistory(e.roomId);if(n.length>1){e=n[n.length-1];for(let e=0;e<n.length-1;e++){const i=a.findIndex(t=>t.roomId===n[e].roomId);-1!==i&&(a.splice(i,1),t=!0)}}const i=a.findIndex(t=>t.roomId===e.roomId);if(0!==i&&(-1!==i&&a.splice(i,1),a.splice(0,0,e),t=!0),a.length>20&&(a.splice(20,a.length-20),t=!0),t){await this.updateState({rooms:a});const e=a.map(e=>e.roomId);e.length>0&&await c.b.setValue("breadcrumb_rooms",null,h.a.ACCOUNT,e)}}}i()(p,"internalInstance",new p)},416:function(e,t,a){"use strict";a.d(t,"a",(function(){return g}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(0),c=a(89),l=a(90),d=a(126),m=a(95),h=a(98),u=a(230),p=a(91);class g extends o.a.PureComponent{constructor(e){super(e),i()(this,"onClearCacheAndReload",()=>{d.a.get()&&(l.a.get().stopClient(),l.a.get().store.deleteAllData().then(()=>{d.a.get().reload()}))}),i()(this,"onBugReport",()=>{m.a.createTrackedDialog("Bug Report Dialog","",u.a,{label:"react-soft-crash",error:this.state.error})}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,t){let{componentStack:a}=t;r.a.error(e),r.a.error("The above error occurred while React was rendering the following components:",a)}render(){if(this.state.error){const e="https://github.com/vector-im/element-web/issues/new/choose";let t,a;return h.b.get().bug_report_endpoint_url&&(t=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(c.a)("Please <newIssueLink>create a new issue</newIssueLink> on GitHub so that we can investigate this bug.",{},{newIssueLink:t=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:e},t)})),o.a.createElement("p",null,Object(c.a)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. "),Object(c.a)("Debug logs contain application usage data including your username, the IDs or aliases of the rooms you have visited, which UI elements you last interacted with, and the usernames of other users. They do not contain messages.")),o.a.createElement(p.a,{onClick:this.onBugReport,kind:"primary"},Object(c.a)("Submit debug logs")))),l.a.get()&&(a=o.a.createElement(p.a,{onClick:this.onClearCacheAndReload,kind:"danger"},Object(c.a)("Clear cache and reload"))),o.a.createElement("div",{className:"mx_ErrorBoundary"},o.a.createElement("div",{className:"mx_ErrorBoundary_body"},o.a.createElement("h1",null,Object(c.a)("Something went wrong!")),t,a))}return this.props.children}}},417:function(e,t,a){"use strict";var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(105),c=a(89),l=a(169),d=a(291);class m extends s.PureComponent{constructor(){super(...arguments),i()(this,"validate",Object(l.a)({rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(c.a)(this.props.labelRequired)},{key:"email",test:e=>{let{value:t}=e;return!t||d.a(t)},invalid:()=>Object(c.a)(this.props.labelInvalid)}]})),i()(this,"onValidate",async e=>{let t=this.validate;this.props.validationRules&&(t=this.props.validationRules);const a=await t(e);return this.props.onValidate&&this.props.onValidate(a),a})}render(){return o.a.createElement(r.a,{id:this.props.id,ref:this.props.fieldRef,type:"text",label:Object(c.a)(this.props.label),value:this.props.value,autoFocus:this.props.autoFocus,onChange:this.props.onChange,onValidate:this.onValidate})}}i()(m,"defaultProps",{label:Object(c.c)("Email"),labelRequired:Object(c.c)("Enter email address"),labelInvalid:Object(c.c)("Doesn't look like a valid email address")}),t.a=m},418:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n=a(94),i=a.n(n),s=a(87),o=a.n(s);function r(e){let{flex:t,children:a}=e;return o.a.createElement("div",{className:i()("mx_AuthBody",{mx_AuthBody_flex:t})},a)}},428:function(e,t,a){"use strict";a.d(t,"a",(function(){return c}));var n=a(87),i=a.n(n),s=a(98);class o extends i.a.PureComponent{render(){var e;const t=s.b.getObject("branding"),a=null!==(e=null==t?void 0:t.get("auth_header_logo_url"))&&void 0!==e?e:"themes/element/img/logos/element-logo.svg";return i.a.createElement("div",{className:"mx_AuthHeaderLogo"},i.a.createElement("img",{src:a,alt:"Element"}))}}var r=a(837);class c extends i.a.Component{render(){return i.a.createElement("div",{className:"mx_AuthHeader"},i.a.createElement(o,null),i.a.createElement(r.a,{disabled:this.props.disableLanguageSelector}))}}},555:function(e,t,a){"use strict";a.d(t,"a",(function(){return h}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(803),c=a(101),l=a(89),d=a(557);function m(e){return e===d.a.Done?a(1400).default:a(807).default}class h extends o.a.Component{constructor(e){super(e),i()(this,"store",void 0),i()(this,"onStoreUpdate",()=>{this.setState({icon:m(this.store.phase)})}),this.store=d.b.sharedInstance(),this.state={icon:m(this.store.phase)}}componentDidMount(){this.store.on("update",this.onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this.onStoreUpdate)}render(){return o.a.createElement(c.a,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:Object(l.a)("Verify this session")},o.a.createElement(r.a,{onFinished:this.props.onFinished}))}}},556:function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var n=a(87),i=a.n(n),s=a(90),o=a(89),r=a(101),c=a(577);class l extends i.a.Component{constructor(e){super(e),this.state={verificationRequest:this.props.verificationRequest},this.props.verificationRequestPromise&&this.props.verificationRequestPromise.then(e=>{this.setState({verificationRequest:e})})}render(){const e=this.state.verificationRequest,t=e&&e.otherUserId,a=this.props.member||t&&s.a.get().getUser(t),n=e&&e.isSelfVerification?Object(o.a)("Verify other device"):Object(o.a)("Verification Request");return i.a.createElement(r.a,{className:"mx_InfoDialog",onFinished:this.props.onFinished,contentId:"mx_Dialog_content",title:n,hasCancel:!0},i.a.createElement(c.a,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:a,isRoomEncrypted:!1}))}}},557:function(e,t,a){"use strict";a.d(t,"a",(function(){return g})),a.d(t,"b",(function(){return b}));var n=a(88),i=a.n(n),s=a(8),o=a.n(s),r=a(203),c=a(0),l=a(145),d=a(90),m=a(214),h=a(95),u=a(227),p=a(89);let g;!function(e){e[e.Loading=0]="Loading",e[e.Intro=1]="Intro",e[e.Busy=2]="Busy",e[e.Done=3]="Done",e[e.ConfirmSkip=4]="ConfirmSkip",e[e.Finished=5]="Finished",e[e.ConfirmReset=6]="ConfirmReset"}(g||(g={}));class b extends o.a{constructor(){super(...arguments),i()(this,"started",void 0),i()(this,"phase",void 0),i()(this,"verificationRequest",void 0),i()(this,"backupInfo",void 0),i()(this,"keyId",void 0),i()(this,"keyInfo",void 0),i()(this,"hasDevicesToVerifyAgainst",void 0),i()(this,"onUserTrustStatusChanged",e=>{if(e!==d.a.get().getUserId())return;d.a.get().getCrossSigningId()&&(this.phase=g.Done,this.emit("update"))}),i()(this,"onVerificationRequest",e=>{this.setActiveVerificationRequest(e)}),i()(this,"onVerificationRequestChange",()=>{if(this.verificationRequest.cancelled)this.verificationRequest.off(r.m.Change,this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if(this.verificationRequest.phase===r.c){this.verificationRequest.off(r.m.Change,this.onVerificationRequestChange),this.verificationRequest=null;const e=d.a.get().getCrossSigningId();this.phase=e?g.Done:g.Busy,this.emit("update")}})}static sharedInstance(){return window.mxSetupEncryptionStore||(window.mxSetupEncryptionStore=new b),window.mxSetupEncryptionStore}start(){if(this.started)return;this.started=!0,this.phase=g.Loading,this.verificationRequest=null,this.backupInfo=null,this.keyId=null,this.keyInfo=null;const e=d.a.get();e.on(l.b.VerificationRequest,this.onVerificationRequest),e.on(l.b.UserTrustStatusChanged,this.onUserTrustStatusChanged);const t=e.getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this.setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){var e;this.started&&(this.started=!1,null===(e=this.verificationRequest)||void 0===e||e.off(r.m.Change,this.onVerificationRequestChange),d.a.get()&&(d.a.get().removeListener(l.b.VerificationRequest,this.onVerificationRequest),d.a.get().removeListener(l.b.UserTrustStatusChanged,this.onUserTrustStatusChanged)))}async fetchKeyInfo(){if(!this.started)return;const e=d.a.get(),t=await e.isSecretStored("m.cross_signing.master");null===t||0===Object.keys(t).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(t)[0],this.keyInfo=t[this.keyId]);const a=await e.getDehydratedDevice(),n=e.getUserId(),i=e.getStoredCrossSigningForUser(n);this.hasDevicesToVerifyAgainst=e.getStoredDevicesForUser(n).some(e=>e.getIdentityKey()&&(!a||e.deviceId!=a.device_id)&&i.checkDeviceTrust(i,e,!1,!0).isCrossSigningVerified()),this.phase=g.Intro,this.emit("update")}async usePassPhrase(){this.phase=g.Busy,this.emit("update");const e=d.a.get();try{const t=await e.getKeyBackupVersion();this.backupInfo=t,this.emit("update"),await new Promise((a,n)=>{Object(m.b)(async()=>{await e.checkOwnCrossSigningTrust(),a(),t&&await e.restoreKeyBackupWithSecretStorage(t)}).catch(n)}),e.getCrossSigningId()&&(this.phase=g.Done,this.emit("update"))}catch(e){e instanceof m.a||c.a.log(e),this.phase=g.Intro,this.emit("update")}}skip(){this.phase=g.ConfirmSkip,this.emit("update")}skipConfirm(){this.phase=g.Finished,this.emit("update")}returnAfterSkip(){this.phase=g.Intro,this.emit("update")}reset(){this.phase=g.ConfirmReset,this.emit("update")}async resetConfirm(){try{await Object(m.b)(async()=>{const e=d.a.get();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:a}=h.a.createTrackedDialog("Cross-signing keys dialog","",u.a,{title:Object(p.a)("Setting up keys"),matrixClient:e,makeRequest:t}),[n]=await a;if(!n)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0}),this.phase=g.Finished},!0)}catch(e){c.a.error("Error resetting cross-signing",e),this.phase=g.Intro}this.emit("update")}returnAfterReset(){this.phase=g.Intro,this.emit("update")}done(){this.phase=g.Finished,this.emit("update"),d.a.get().crypto.cancelAndResendAllOutgoingKeyRequests()}async setActiveVerificationRequest(e){this.started&&e.otherUserId===d.a.get().getUserId()&&(this.verificationRequest&&this.verificationRequest.off(r.m.Change,this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on(r.m.Change,this.onVerificationRequestChange),this.emit("update"))}lostKeys(){return!this.hasDevicesToVerifyAgainst&&!this.keyInfo}}},558:function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(97),c=a(100),l=a(809),d=a(106),m=a(93),h=a(90);class u extends o.a.PureComponent{constructor(){super(...arguments),i()(this,"context",void 0)}render(){const{mxEvent:e,onClick:t}=this.props,a=e.getContent().msgtype;let n=e.sender;if(m.b.getValue("feature_use_only_current_profiles")){const t=h.a.get().getRoom(e.getRoomId());t&&(n=t.getMember(e.getSender()))}return o.a.createElement(d.b.Consumer,null,i=>a===r.c.Emote&&i.timelineRenderingType!==d.a.ThreadsList?null:o.a.createElement(l.a,{fallbackName:e.getSender()||"",onClick:t,member:n,colored:!0,emphasizeDisplayName:!0}))}}i()(u,"contextType",c.a)},559:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var n=a(97),i=a(165),s=a(244),o=a(93),r=a(198),c=a(90),l=a(153);function d(e,t,a){const d=e.getContent().msgtype,m=e.getType();let h=!1;if(o.b.getValue("feature_msc3531_hide_messages_pending_moderation"))switch(Object(l.h)(e)){case l.a.VISIBLE_FOR_ALL:case l.a.HIDDEN_TO_CURRENT_USER:break;case l.a.SEE_THROUGH_FOR_CURRENT_USER:h=!0}let u=Object(r.e)(e,c.a.get(),t),p=m.startsWith("m.key.verification")||m===n.b.RoomMessage&&(null==d?void 0:d.startsWith("m.key.verification"))||m===n.b.RoomCreate||m===n.b.RoomEncryption||u===r.b;const g=!p&&m===n.b.CallInvite;let b=!(p||g||m===n.b.RoomMessage||m===n.b.RoomMessageEncrypted||m===n.b.Sticker||m===n.b.RoomCreate||i.M_POLL_START.matches(m)||s.b.matches(m));const v=m===n.b.RoomMessage&&d===n.c.Emote||i.M_POLL_START.matches(m)||s.b.matches(m)||Object(l.k)(e);return!a&&Object(r.c)(e,t)||(u=Object(r.e)(e,c.a.get(),t,!0),u===r.a&&(p=!1,b=!0)),{hasRenderer:!!u,isInfoMessage:b,isBubbleMessage:p,isLeftAlignedBubbleMessage:g,noBubbleEvent:v,isSeeingThroughMessageHiddenForModeration:h}}},560:function(e,t,a){"use strict";var n=a(99),i=a.n(n),s=a(103),o=a.n(s),r=a(87),c=a.n(r),l=a(134),d=a(114),m=a(109);const h=["children"];t.a=e=>{let{children:t}=e,a=o()(e,h);return c.a.createElement(l.d,{handleHomeEnd:!0,handleLeftRight:!0,onKeyDown:e=>{const t=e.target;if("INPUT"===t.tagName)return;let a=!0;switch(Object(d.a)().getAccessibilityAction(e)){case m.h.ArrowUp:case m.h.ArrowDown:t.hasAttribute("aria-haspopup")&&t.click();break;default:a=!1}a&&(e.preventDefault(),e.stopPropagation())}},e=>{let{onKeyDownHandler:n}=e;return c.a.createElement("div",i()({},a,{onKeyDown:n,role:"toolbar"}),t)})}},561:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return v}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(94),c=a.n(r),l=a(91),d=a(89),m=a(269),h=a(148),u=a(811);let p;!function(e){e.Admin="admin",e.Moderator="moderator"}(p||(p={}));const g={[p.Admin]:Object(d.c)("Admin"),[p.Moderator]:Object(d.c)("Mod")},b={offline:"mx_EntityTile_offline",online:"mx_EntityTile_online",unavailable:"mx_EntityTile_unavailable"};class v extends o.a.PureComponent{constructor(e){super(e),this.state={hover:!1}}render(){const e={mx_EntityTile:!0,mx_EntityTile_noHover:this.props.suppressOnHover};this.props.className&&(e[this.props.className]=!0);var t,n;let i;e[(t=this.props.presenceState,n=this.props.presenceLastActiveAgo,!1===this.props.showPresence?"mx_EntityTile_online_beenactive":"offline"===t?n?b.offline+"_beenactive":b.offline+"_neveractive":t?b[t]:b.offline+"_neveractive")]=!0;const s=this.props.nameJSX||this.props.name;if(this.props.suppressOnHover)i=this.props.subtextLabel?o.a.createElement("div",{className:"mx_EntityTile_details"},o.a.createElement("div",{className:"mx_EntityTile_name"},s),o.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)):o.a.createElement("div",{className:"mx_EntityTile_name"},s);else{const e=this.props.presenceLastActiveAgo?Date.now()-(this.props.presenceLastTs-this.props.presenceLastActiveAgo):-1;let t=null;this.props.showPresence&&(t=o.a.createElement(u.a,{activeAgo:e,currentlyActive:this.props.presenceCurrentlyActive,presenceState:this.props.presenceState})),this.props.subtextLabel&&(t=o.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)),i=o.a.createElement("div",{className:"mx_EntityTile_details"},o.a.createElement("div",{className:"mx_EntityTile_name"},s),t)}let r,p;this.props.showInviteButton&&(r=o.a.createElement("div",{className:"mx_EntityTile_invite"},o.a.createElement("img",{src:a(1406).default,width:"16",height:"16"})));const v=this.props.powerStatus;if(v){const e=Object(d.a)(g[v]);p=o.a.createElement("div",{className:"mx_EntityTile_power"},e)}let f;const{e2eStatus:E}=this.props;E&&(f=o.a.createElement(m.b,{status:E,isUser:!0,bordered:!0}));const y=this.props.avatarJsx||o.a.createElement(h.a,{name:this.props.name,width:36,height:36,"aria-hidden":"true"});return o.a.createElement("div",null,o.a.createElement(l.a,{className:c()(e),title:this.props.title,onClick:this.props.onClick},o.a.createElement("div",{className:"mx_EntityTile_avatar"},y,f),i,p,r))}}i()(v,"defaultProps",{onClick:()=>{},presenceState:"offline",presenceLastActiveAgo:0,presenceLastTs:0,showInviteButton:!1,suppressOnHover:!1,showPresence:!0})},562:function(e,t,a){"use strict";a.d(t,"b",(function(){return o})),a.d(t,"a",(function(){return r}));var n=a(131),i=a(89),s=a(135);function o(e){if(!e.isSpaceRoom())return;const[t,a,...s]=n.a.instance.getKnownParents(e.roomId);var o,r,c;return!a||null!=s&&s.length?t?Object(i.a)("%(spaceName)s and %(count)s others",{spaceName:null===(c=e.client.getRoom(t))||void 0===c?void 0:c.name,count:s.length}):e.getCanonicalAlias():Object(i.a)("%(space1Name)s and %(space2Name)s",{space1Name:null===(o=e.client.getRoom(t))||void 0===o?void 0:o.name,space2Name:null===(r=e.client.getRoom(a))||void 0===r?void 0:r.name})}function r(e){if(e.isSpaceRoom())return;const t=s.a.shared().getUserIdForRoomId(e.roomId);if(t)return t;const[a,o,...r]=n.a.instance.getKnownParents(e.roomId);var c,l,d;return!o||null!=r&&r.length?a?Object(i.a)("%(spaceName)s and %(count)s others",{spaceName:null===(d=e.client.getRoom(a))||void 0===d?void 0:d.name,count:r.length}):e.getCanonicalAlias():Object(i.a)("%(space1Name)s and %(space2Name)s",{space1Name:null===(c=e.client.getRoom(a))||void 0===c?void 0:c.name,space2Name:null===(l=e.client.getRoom(o))||void 0===l?void 0:l.name})}},563:function(e,t,a){"use strict";a.d(t,"a",(function(){return o})),a.d(t,"b",(function(){return r}));var n=a(0),i=a(205),s=a(9);function o(e){const t=new s.a(e).get("embedded_pages");let a=t?new s.a(t).get("home_url"):null;var o;(a||(a=e.welcomePageUrl,a&&n.a.warn("You are using a deprecated config option: `welcomePageUrl`. Please use `embedded_pages.home_url` instead, per https://github.com/vector-im/element-web/issues/21428")),a)||(a=null===(o=Object(i.d)())||void 0===o?void 0:o.home_url);return a}function r(e){const t=new s.a(e).get("embedded_pages");return!!t&&!0===new s.a(t).get("login_for_welcome")}},566:function(e,t,a){"use strict";a.d(t,"a",(function(){return b}));var n=a(88),i=a.n(n),s=a(144),o=a(354),r=a(0),c=a(90),l=a(830),d=a(642),m=a(128),h=a(133),u=a(153),p=a(89),g=a(98);class b{constructor(e,t,a,n){if(this.room=e,this.exportType=t,this.exportOptions=a,this.setProgressText=n,i()(this,"files",[]),i()(this,"client",void 0),i()(this,"cancelled",!1),a.maxSize<1048576||a.maxSize>8388608e3||a.numberOfMessages>10**8)throw new Error("Invalid export options");this.client=c.a.get(),window.addEventListener("beforeunload",this.onBeforeUnload)}onBeforeUnload(e){return e.preventDefault(),e.returnValue=Object(p.a)("Are you sure you want to exit during this export?")}updateProgress(e){let t=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&r.a.log(e),t&&this.setProgressText(e)}addFile(e,t){const a={name:e,blob:t};this.files.push(a)}async downloadZIP(){const e=`${g.b.get().brand} - Chat Export - ${Object(h.e)(new Date)}`,t=e+".zip",{default:n}=await a.e(36).then(a.t.bind(null,1475,7)),i=new n;if(this.cancelled)return this.cleanUp();this.updateProgress(Object(p.a)("Generating a ZIP"));for(const t of this.files)i.file(e+"/"+t.name,t.blob);const s=await i.generateAsync({type:"blob"});Object(o.saveAs)(s,t)}cleanUp(){return r.a.log("Cleaning up..."),window.removeEventListener("beforeunload",this.onBeforeUnload),""}async cancelExport(){r.a.log("Cancelling export..."),this.cancelled=!0}downloadPlainText(e,t){const a=new Blob([t],{type:"text"});Object(o.saveAs)(a,e)}setEventMetadata(e){const t=this.client.getRoom(this.room.roomId).currentState;return e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e}getLimit(){let e;switch(this.exportType){case l.b.LastNMessages:e=this.exportOptions.numberOfMessages;break;case l.b.Timeline:e=40;break;default:e=10**8}return e}async getRequiredEvents(){const e=this.client.getEventMapper();let t=null,a=this.getLimit();const n=[];for(;a;){const i=Math.min(a,1e3),o=await this.client.createMessagesRequest(this.room.roomId,t,i,s.a.Backward);if(this.cancelled)return this.cleanUp(),[];if(0===o.chunk.length)break;a-=o.chunk.length;const r=o.chunk.map(e);for(const e of r)n.push(e);this.exportType===l.b.LastNMessages?this.updateProgress(Object(p.a)("Fetched %(count)s events out of %(total)s",{count:n.length,total:this.exportOptions.numberOfMessages})):this.updateProgress(Object(p.a)("Fetched %(count)s events so far",{count:n.length})),t=o.end}for(let e=0;e<Math.floor(n.length/2);e++)[n[e],n[n.length-e-1]]=[n[n.length-e-1],n[e]];const i=n.filter(e=>e.isEncrypted()).map(e=>this.client.decryptEventIfNeeded(e,{isRetry:!0,emit:!1}));await Promise.all(i);for(let e=0;e<n.length;e++)this.setEventMetadata(n[e]);return n}async getMediaBlob(e){let t;try{const a=e.isEncrypted(),n=e.getContent();if(a&&n.hasOwnProperty("file")&&"m.sticker"!==e.getType())t=await Object(d.a)(n.file);else{const e=Object(m.a)(n),a=await fetch(e.srcHttp);t=await a.blob()}}catch(e){r.a.log("Error decrypting media")}return t}splitFileName(e){const t=e.lastIndexOf(".");if(-1===t)return[e,""];return[e.slice(0,t),"."+e.slice(t+1)]}getFilePath(e){let t;switch(e.getContent().msgtype){case"m.image":t="images";break;case"m.video":t="videos";break;case"m.audio":t="audio";break;default:t="m.sticker"===e.getType()?"stickers":"files"}const a=Object(h.e)(new Date(e.getTs()));let[n,i]=this.splitFileName(e.getContent().body);return"m.sticker"===e.getType()&&(i=".png"),Object(u.l)(e)&&(i=".ogg"),t+"/"+n+"-"+a+i}isReply(e){const t=(e.isEncrypted()?e.event.content:e.getContent())["m.relates_to"];return!(!t||!t["m.in_reply_to"])}isAttachment(e){const t=["m.sticker","m.image","m.file","m.video","m.audio"];return e.getType()===t[0]||t.includes(e.getContent().msgtype)}}},567:function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(834),c=a(98),l=a(89),d=a(263);const m={};for(const e of r.a)m[e.iso2]=e;function h(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||(t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e))}class u extends o.a.Component{constructor(e){super(e),i()(this,"onSearchChange",e=>{this.setState({searchQuery:e})}),i()(this,"onOptionChange",e=>{this.props.onOptionChange(m[e])}),i()(this,"getShortOption",e=>{if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+m[e].prefix),o.a.createElement("span",{className:"mx_CountryDropdown_shortOption"},this.flagImgForIso2(e),t)});let t=r.a[0];const a=c.b.get("default_country_code");if(a){const e=r.a.find(e=>e.iso2===a.toUpperCase());e&&(t=e)}this.state={searchQuery:"",defaultCountry:t}}componentDidMount(){this.props.value||this.props.onOptionChange(this.state.defaultCountry)}flagImgForIso2(e){return o.a.createElement("div",{className:"mx_Dropdown_option_emoji"},Object(r.b)(e))}render(){let e;if(this.state.searchQuery){if(e=r.a.filter(h.bind(this,this.state.searchQuery)),2==this.state.searchQuery.length&&m[this.state.searchQuery.toUpperCase()]){const t=m[this.state.searchQuery.toUpperCase()];e=e.filter(e=>e.iso2!=t.iso2),e.unshift(t)}}else e=r.a;const t=e.map(e=>o.a.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this.flagImgForIso2(e.iso2),Object(l.a)(e.name)," (+",e.prefix,")")),a=this.props.value||this.state.defaultCountry.iso2;return o.a.createElement(d.a,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this.onOptionChange,onSearchChange:this.onSearchChange,menuWidth:298,getShortOption:this.getShortOption,value:a,searchEnabled:!0,disabled:this.props.disabled,label:Object(l.a)("Country Dropdown")},t)}}},568:function(e,t,a){"use strict";var n=a(99),i=a.n(n),s=a(103),o=a.n(s),r=a(87),c=a.n(r),l=a(111),d=a(94),m=a.n(d),h=a(126),u=a(91),p=a(89),g=a(352),b=a(117),v=a(128),f=a(173);const E=["matrixClient","loginType","fragmentAfterLogin","idp","primary","mini"],y=e=>{let{matrixClient:t,loginType:n,fragmentAfterLogin:s,idp:r,primary:l,mini:d}=e,y=o()(e,E);const _=r?Object(p.a)("Continue with %(provider)s",{provider:r.name}):Object(p.a)("Sign in with single sign-on"),S=()=>{var e;const a=(e=>{switch(e){case g.a.Apple:return"Apple";case g.a.Facebook:return"Facebook";case g.a.Github:return"GitHub";case g.a.Gitlab:return"GitLab";case g.a.Google:return"Google";default:return"SSO"}})(null!==(e=null==r?void 0:r.brand)&&void 0!==e?e:"");f.a.instance.setAuthenticationType(a),h.a.get().startSingleSignOn(t,n,s,null==r?void 0:r.id)};let w,C;const O=r?(e=>{switch(e){case g.a.Apple:return a(1465).default;case g.a.Facebook:return a(1466).default;case g.a.Github:return a(1467).default;case g.a.Gitlab:return a(1468).default;case g.a.Google:return a(1469).default;case g.a.Twitter:return a(1470).default;default:return null}})(r.brand):null;if(O){const e=r.brand.split(".").pop();C="mx_SSOButton_brand_"+e,w=c.a.createElement("img",{src:O,height:"24",width:"24",alt:e})}else if("string"==typeof(null==r?void 0:r.icon)&&r.icon.startsWith("mxc://")){const e=Object(v.b)(r.icon,t).getSquareThumbnailHttp(24);w=c.a.createElement("img",{src:e,height:"24",width:"24",alt:r.name})}const k=m()("mx_SSOButton",{[C]:C,mx_SSOButton_mini:d,mx_SSOButton_default:!r,mx_SSOButton_primary:l});return d?c.a.createElement(b.a,i()({},y,{title:_,className:k,onClick:S}),w):c.a.createElement(u.a,i()({},y,{className:k,onClick:S}),w,_)};t.a=e=>{let{matrixClient:t,flow:a,loginType:n,fragmentAfterLogin:i,primary:s}=e;const o=a.identity_providers||[];if(o.length<2)return c.a.createElement("div",{className:"mx_SSOButtons"},c.a.createElement(y,{matrixClient:t,loginType:n,fragmentAfterLogin:i,idp:o[0],primary:s}));const r=Math.ceil(o.length/6),d=Math.ceil(o.length/r);return c.a.createElement("div",{className:"mx_SSOButtons"},Object(l.chunk)(o,d).map(e=>c.a.createElement("div",{key:e[0].id,className:"mx_SSOButtons_row"},e.map(e=>c.a.createElement(y,{key:e.id,matrixClient:t,loginType:n,fragmentAfterLogin:i,idp:e,mini:!0,primary:s})))))}},574:function(e,t,a){"use strict";a.d(t,"b",(function(){return me})),a.d(t,"a",(function(){return he}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(150),c=a.n(r),l=a(94),d=a.n(l),m=a(97),h=a(0),u=a(116),p=a(285),g=a(244),b=a(327),v=a(133),f=a(90),E=a(93),y=a(106),_=a(157),S=a(89),w=a(355),C=a(287);class O extends o.a.Component{constructor(e){super(e),i()(this,"onMouseDown",e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)}),i()(this,"onMouseUp",e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)}),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return o.a.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown.bind(this)})}}var k=a(104);class x extends o.a.Component{constructor(e){super(e),i()(this,"dragFunc",(e,t)=>{const a=t.clientX-e.currentX,n=this.state.width+a;return n<this.props.minWidth||n>this.props.maxWidth?e:(this.setState({width:n}),this.updateCSSWidth.bind(this)(n),{currentX:t.clientX,currentY:e.currentY})}),this.state={width:E.b.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},()=>this.updateCSSWidth(this.state.width))}updateCSSWidth(e){this.state.IRCLayoutRoot.style.setProperty("--name-width",e+"px")}onMoueUp(e){this.props.roomId&&E.b.setValue("ircDisplayNameWidth",this.props.roomId,k.a.ROOM_DEVICE,this.state.width)}render(){return o.a.createElement(O,{className:"mx_ProfileResizer",dragFunc:this.dragFunc.bind(this),onMouseUp:this.onMoueUp.bind(this)})}}var R=a(135),j=a(1450),I=a(144),T=a(268);var N=()=>{var e;const{room:t}=Object(s.useContext)(y.b),a=t.getLiveTimeline().getState(I.b.BACKWARDS),n=a.getStateEvents("m.room.encryption")[0],i=null===(e=a.getStateEvents("m.room.history_visibility")[0])||void 0===e?void 0:e.getContent().history_visibility;let r;return"invited"==i?r=Object(S.a)("You don't have permission to view messages from before you were invited."):"joined"==i?r=Object(S.a)("You don't have permission to view messages from before you joined."):n&&(r=Object(S.a)("Encrypted messages before this point are unavailable.")),o.a.createElement(T.a,{className:"mx_HistoryTile",title:Object(S.a)("You can't see earlier messages"),subtitle:r})},P=a(92),M=a(113),D=a(151);function A(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const a=[],n=Object.keys(e.currentState.members);for(let i=0;i<n.length;++i){const s=n[i];e.currentState.members[s].typing&&-1===t.indexOf(s)&&a.push(e.currentState.members[s])}return a}var U=a(297),L=a(136),F=a(149);class B extends o.a.Component{constructor(){var e;super(...arguments),i()(this,"state",{usersTyping:(e=this.props.room,A(e,[f.a.get().getUserId()])),delayedStopTypingTimers:{}}),i()(this,"isVisible",()=>B.isVisible(this.state)),i()(this,"onRoomTimeline",(e,t)=>{if((null==t?void 0:t.roomId)===this.props.room.roomId){const t=e.getSender(),a=this.state.usersTyping.filter(e=>e.userId!==t);a.length!==this.state.usersTyping.length&&this.setState({usersTyping:a}),this.abortUserTimer(t)}}),i()(this,"onRoomMemberTyping",()=>{const e=function(e){return A(e,[f.a.get().getUserId()].concat(f.a.get().getIgnoredUsers()))}(this.props.room);this.setState({delayedStopTypingTimers:this.updateDelayedStopTypingTimers(e),usersTyping:e})})}componentDidMount(){f.a.get().on(D.b.Typing,this.onRoomMemberTyping),f.a.get().on(M.c.Timeline,this.onRoomTimeline)}componentDidUpdate(e,t){const a=B.isVisible(t),n=B.isVisible(this.state);this.props.onShown&&!a&&n?this.props.onShown():this.props.onHidden&&a&&!n&&this.props.onHidden()}componentWillUnmount(){const e=f.a.get();e&&(e.removeListener(D.b.Typing,this.onRoomMemberTyping),e.removeListener(M.c.Timeline,this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach(e=>e.abort())}static isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter(t=>!e.some(e=>t.userId===e.userId)),a=e.filter(e=>!this.state.usersTyping.some(t=>e.userId===t.userId));a.forEach(e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()});let n=Object.assign({},this.state.delayedStopTypingTimers);return n=a.reduce((e,t)=>(delete e[t.userId],e),n),n=t.reduce((e,t)=>{if(!e[t.userId]){const a=new U.a(5e3);e[t.userId]=a,a.start(),a.finished().then(()=>this.removeUserTimer(t.userId),()=>{})}return e},n),n}abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this.removeUserTimer(e))}removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}renderTypingIndicatorAvatars(e,t){let a=0;e.length>t&&(a=e.length-t+1,e=e.slice(0,t-1));const n=e.map(e=>o.a.createElement(L.a,{key:e.userId,member:e,width:24,height:24,resizeMethod:"crop",viewUserOnClick:!0,"aria-live":"off"}));return a>0&&n.push(o.a.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",a)),n}render(){let e=this.state.usersTyping;const t=Object.keys(this.state.delayedStopTypingTimers).map(e=>this.props.room.getMember(e));e=e.concat(t),e.sort((e,t)=>Object(F.a)(e.name,t.name));const a=function(e,t){let a=0;if(e.length>t&&(a=e.length-t+1),0===e.length)return"";if(1===e.length)return Object(S.a)("%(displayName)s is typing …",{displayName:e[0].name});const n=e.map(e=>e.name);if(a>=1)return Object(S.a)("%(names)s and %(count)s others are typing …",{names:n.slice(0,t-1).join(", "),count:a});{const e=n.pop();return Object(S.a)("%(names)s and %(lastPerson)s are typing …",{names:n.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return a?o.a.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},o.a.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this.renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),o.a.createElement("div",{className:"mx_WhoIsTypingTile_label"},a)):null}}i()(B,"defaultProps",{whoIsTypingLimit:3});var V=a(401),W=a(111),H=a(344),z=a(91);var K=e=>{let{events:t,children:a,threshold:n=3,onToggle:i,startExpanded:r=!1,summaryMembers:c=[],summaryText:l,layout:d=_.a.Group}=e;const[m,u]=Object(H.a)(r);Object(s.useEffect)(()=>{i&&i()},[m]);const p=t.map(e=>e.getId()).join(",");if(t.length<n)return o.a.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":p,"data-expanded":!0,"data-layout":d},o.a.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},a));let g;if(m)g=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_GenericEventListSummary_line"}," "),o.a.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},a));else{const e=Object(W.uniqBy)(c.filter(e=>!(null==e||!e.getMxcAvatarUrl)||(h.a.error("EventListSummary given null summaryMember, termites may be afoot eating event senders",c),!1)),e=>e.getMxcAvatarUrl()).map(e=>o.a.createElement(L.a,{key:e.userId,member:e,width:14,height:14}));g=o.a.createElement("div",{className:"mx_EventTile_line"},o.a.createElement("div",{className:"mx_EventTile_info"},o.a.createElement("span",{className:"mx_GenericEventListSummary_avatars",onClick:u},e),o.a.createElement("span",{className:"mx_TextualEvent mx_GenericEventListSummary_summary"},l)))}return o.a.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":p,"data-expanded":m+"","data-layout":d},o.a.createElement(z.a,{className:"mx_GenericEventListSummary_toggle",onClick:u,"aria-expanded":m},m?Object(S.a)("collapse"):Object(S.a)("expand")),g)},q=a(175),G=a(193),Y=a(146),J=a(699),$=a(139);const Q=()=>{$.a.instance.setCard({phase:Y.a.PinnedMessages},!1)},X=[m.b.RoomMember];var Z;!function(e){e.Joined="joined",e.Left="left",e.JoinedAndLeft="joined_and_left",e.LeftAndJoined="left_and_joined",e.InviteReject="invite_reject",e.InviteWithdrawal="invite_withdrawal",e.Invited="invited",e.Banned="banned",e.Unbanned="unbanned",e.Kicked="kicked",e.ChangedName="changed_name",e.ChangedAvatar="changed_avatar",e.NoChange="no_change",e.ServerAcl="server_acl",e.ChangedPins="pinned_messages",e.MessageRemoved="message_removed",e.HiddenEvent="hidden_event"}(Z||(Z={}));class ee extends o.a.Component{constructor(){super(...arguments),i()(this,"context",void 0)}shouldComponentUpdate(e){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold||e.layout!==this.props.layout}generateSummary(e,t){const a=t.map(t=>{const a=e[t],n=this.renderNameList(a),i=t.split(","),s=ee.getCanonicalTransitions(i),o=ee.coalesceRepeatedTransitions(s).map(e=>ee.getDescriptionForTransition(e.transitionType,a.length,e.repeats)),r=Object(q.b)(o);return Object(S.a)("%(nameList)s %(transitionList)s",{nameList:n,transitionList:r})});return a?Object(J.a)(a,", "):null}renderNameList(e){return Object(q.b)(e,this.props.summaryLength)}static getCanonicalTransitions(e){const t={[Z.Joined]:{after:Z.Left,newTransition:Z.JoinedAndLeft},[Z.Left]:{after:Z.Joined,newTransition:Z.LeftAndJoined}},a=[];for(let n=0;n<e.length;n++){const i=e[n],s=e[n+1];let o=i;n<e.length-1&&t[i]&&t[i].after===s&&(o=t[i].newTransition,n++),a.push(o)}return a}static coalesceRepeatedTransitions(e){const t=[];for(let a=0;a<e.length;a++)t.length>0&&t[t.length-1].transitionType===e[a]?t[t.length-1].repeats+=1:t.push({transitionType:e[a],repeats:1});return t}static getDescriptionForTransition(e,t,a){let n=null;switch(e){case Z.Joined:n=t>1?Object(S.a)("%(severalUsers)sjoined %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)sjoined %(count)s times",{oneUser:"",count:a});break;case Z.Left:n=t>1?Object(S.a)("%(severalUsers)sleft %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)sleft %(count)s times",{oneUser:"",count:a});break;case Z.JoinedAndLeft:n=t>1?Object(S.a)("%(severalUsers)sjoined and left %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)sjoined and left %(count)s times",{oneUser:"",count:a});break;case Z.LeftAndJoined:n=t>1?Object(S.a)("%(severalUsers)sleft and rejoined %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)sleft and rejoined %(count)s times",{oneUser:"",count:a});break;case Z.InviteReject:n=t>1?Object(S.a)("%(severalUsers)srejected their invitations %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)srejected their invitation %(count)s times",{oneUser:"",count:a});break;case Z.InviteWithdrawal:n=t>1?Object(S.a)("%(severalUsers)shad their invitations withdrawn %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)shad their invitation withdrawn %(count)s times",{oneUser:"",count:a});break;case Z.Invited:n=t>1?Object(S.a)("were invited %(count)s times",{count:a}):Object(S.a)("was invited %(count)s times",{count:a});break;case Z.Banned:n=t>1?Object(S.a)("were banned %(count)s times",{count:a}):Object(S.a)("was banned %(count)s times",{count:a});break;case Z.Unbanned:n=t>1?Object(S.a)("were unbanned %(count)s times",{count:a}):Object(S.a)("was unbanned %(count)s times",{count:a});break;case Z.Kicked:n=t>1?Object(S.a)("were removed %(count)s times",{count:a}):Object(S.a)("was removed %(count)s times",{count:a});break;case Z.ChangedName:n=t>1?Object(S.a)("%(severalUsers)schanged their name %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)schanged their name %(count)s times",{oneUser:"",count:a});break;case Z.ChangedAvatar:n=t>1?Object(S.a)("%(severalUsers)schanged their avatar %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)schanged their avatar %(count)s times",{oneUser:"",count:a});break;case Z.NoChange:n=t>1?Object(S.a)("%(severalUsers)smade no changes %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)smade no changes %(count)s times",{oneUser:"",count:a});break;case Z.ServerAcl:n=t>1?Object(S.a)("%(severalUsers)schanged the server ACLs %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)schanged the server ACLs %(count)s times",{oneUser:"",count:a});break;case Z.ChangedPins:n=t>1?Object(S.a)("%(severalUsers)schanged the <a>pinned messages</a> for the room %(count)s times",{severalUsers:"",count:a},{a:e=>o.a.createElement(z.a,{kind:"link_inline",onClick:Q},e)}):Object(S.a)("%(oneUser)schanged the <a>pinned messages</a> for the room %(count)s times",{oneUser:"",count:a},{a:e=>o.a.createElement(z.a,{kind:"link_inline",onClick:Q},e)});break;case Z.MessageRemoved:n=t>1?Object(S.a)("%(severalUsers)sremoved a message %(count)s times",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)sremoved a message %(count)s times",{oneUser:"",count:a});break;case Z.HiddenEvent:n=t>1?Object(S.a)("%(severalUsers)ssent %(count)s hidden messages",{severalUsers:"",count:a}):Object(S.a)("%(oneUser)ssent %(count)s hidden messages",{oneUser:"",count:a})}return n}static getTransitionSequence(e){return e.map(ee.getTransition)}static getTransition(e){if(e.mxEvent.isRedacted())return Z.MessageRemoved;switch(e.mxEvent.getType()){case m.b.RoomThirdPartyInvite:return Object(G.c)(e.mxEvent)?Z.Invited:Z.InviteWithdrawal;case m.b.RoomServerAcl:return Z.ServerAcl;case m.b.RoomPinnedEvents:return Z.ChangedPins;case m.b.RoomMember:switch(e.mxEvent.getContent().membership){case"invite":return Z.Invited;case"ban":return Z.Banned;case"join":return"join"===e.mxEvent.getPrevContent().membership?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?Z.ChangedName:e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?Z.ChangedAvatar:Z.NoChange:Z.Joined;case"leave":if(e.mxEvent.getSender()===e.mxEvent.getStateKey())return"invite"===e.mxEvent.getPrevContent().membership?Z.InviteReject:Z.Left;switch(e.mxEvent.getPrevContent().membership){case"invite":return Z.InviteWithdrawal;case"ban":return Z.Unbanned;default:return Z.Kicked}default:return null}default:return Z.HiddenEvent}}getAggregate(e){const t={},a={};return Object.keys(e).forEach(n=>{const i=e[n][0],s=i.displayName,o=ee.getTransitionSequence(e[n]).join(",");t[o]||(t[o]=[],a[o]=-1),t[o].push(s),(-1===a[o]||i.index<a[o])&&(a[o]=i.index)}),{names:t,indices:a}}render(){const e=this.props.events,t=new Map,a={};e.forEach((e,n)=>{const i=e.getType();let s=e.getSender();if(i===m.b.RoomMember)s=e.getStateKey();else if(e.isRedacted()){var o,r;s=null===(o=e.getUnsigned())||void 0===o||null===(r=o.redacted_because)||void 0===r?void 0:r.sender}a[s]||(a[s]=[]);let c=s;if(i===m.b.RoomThirdPartyInvite)c=e.getContent().display_name,e.sender&&t.set(s,e.sender);else if(e.isRedacted()){var l;const e=null===(l=this.context)||void 0===l?void 0:l.room.getMember(s);e&&(c=e.name,t.set(s,e))}else e.target&&X.includes(i)?(c=e.target.name,t.set(s,e.target)):e.sender&&(c=e.sender.name,t.set(s,e.sender));a[s].push({mxEvent:e,displayName:c,index:n})});const n=this.getAggregate(a),i=Object.keys(n.names).sort((e,t)=>n.indices[e]-n.indices[t]);return o.a.createElement(K,{events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:[...t.values()],layout:this.props.layout,summaryText:this.generateSummary(n.names,i)})}}i()(ee,"contextType",y.b),i()(ee,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5,layout:_.a.Group});var te=a(431),ae=a(416),ne=a(102),ie=a(96),se=a(559),oe=a(198),re=a(758),ce=a(153);const le=[m.b.Sticker,m.b.RoomMessage],de=[m.b.RoomMember,m.b.RoomThirdPartyInvite,m.b.RoomServerAcl,m.b.RoomPinnedEvents];function me(e,t,a,n,i){return i!==y.a.ThreadsList&&(!(null==e||!e.sender||!t.sender)&&(!(t.getTs()-e.getTs()>3e5)&&(t.isRedacted()===e.isRedacted()&&(!!(t.getType()===e.getType()||le.includes(t.getType())&&le.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&((!n||!Object(ce.i)(t)&&!Object(ce.i)(e)||i===y.a.Thread)&&!!Object(oe.c)(e,a)))))))}class he extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"readReceiptMap",{}),i()(this,"readReceiptsByEvent",{}),i()(this,"readReceiptsByUserId",{}),i()(this,"_showHiddenEvents",void 0),i()(this,"threadsEnabled",void 0),i()(this,"isMounted",!1),i()(this,"readMarkerNode",Object(s.createRef)()),i()(this,"whoIsTyping",Object(s.createRef)()),i()(this,"scrollPanel",Object(s.createRef)()),i()(this,"showTypingNotificationsWatcherRef",void 0),i()(this,"eventTiles",{}),i()(this,"grouperKeyMap",new WeakMap),i()(this,"calculateRoomMembersCount",()=>{this.setState({hideSender:this.shouldHideSender()})}),i()(this,"onShowTypingNotificationsChange",()=>{this.setState({showTypingNotifications:E.b.getValue("showTypingNotifications")})}),i()(this,"isUnmounting",()=>!this.isMounted),i()(this,"collectGhostReadMarker",e=>{e&&requestAnimationFrame(()=>{e.style.width="10%",e.style.opacity="0"})}),i()(this,"onGhostTransitionEnd",e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter(e=>e!==t)})}),i()(this,"collectEventTile",(e,t)=>{this.eventTiles[e]=t}),i()(this,"onHeightChanged",()=>{const e=this.scrollPanel.current;e&&e.checkScroll()}),i()(this,"onTypingShown",()=>{const e=this.scrollPanel.current;e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()}),i()(this,"onTypingHidden",()=>{const e=this.scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())}),this.state={ghostReadMarkers:[],showTypingNotifications:E.b.getValue("showTypingNotifications"),hideSender:this.shouldHideSender()},this._showHiddenEvents=E.b.getValue("showHiddenEventsInTimeline"),this.threadsEnabled=E.b.getValue("feature_thread"),this.showTypingNotificationsWatcherRef=E.b.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange)}componentDidMount(){var e;this.calculateRoomMembersCount(),null===(e=this.props.room)||void 0===e||e.currentState.on(u.b.Update,this.calculateRoomMembersCount),this.isMounted=!0}componentWillUnmount(){var e;this.isMounted=!1,null===(e=this.props.room)||void 0===e||e.currentState.off(u.b.Update,this.calculateRoomMembersCount),E.b.unwatchSetting(this.showTypingNotificationsWatcherRef)}componentDidUpdate(e,t){if(e.layout!==this.props.layout&&this.calculateRoomMembersCount(),e.readMarkerVisible&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}const a=this.pendingEditItem;if(!this.props.editState&&this.props.room&&a){const e=this.props.room.findEventById(a);P.a.dispatch({action:ie.a.EditEvent,event:null!=e&&e.isRedacted()?null:e,timelineRenderingType:this.context.timelineRenderingType})}}shouldHideSender(){var e;return(null===(e=this.props.room)||void 0===e?void 0:e.getInvitedAndJoinedMemberCount())<=2&&this.props.layout===_.a.Bubble}getNodeForEventId(e){var t,a;if(this.eventTiles)return null===(t=this.eventTiles[e])||void 0===t||null===(a=t.ref)||void 0===a?void 0:a.current}getTileForEventId(e){if(this.eventTiles)return this.eventTiles[e]}isAtBottom(){var e;return null===(e=this.scrollPanel.current)||void 0===e?void 0:e.isAtBottom()}getScrollState(){var e,t;return null!==(e=null===(t=this.scrollPanel.current)||void 0===t?void 0:t.getScrollState())&&void 0!==e?e:null}getReadMarkerPosition(){const e=this.readMarkerNode.current,t=this.scrollPanel.current;if(!e||!t)return null;const a=c.a.findDOMNode(t).getBoundingClientRect(),n=e.getBoundingClientRect();return n.bottom+2<a.top?-1:n.top<a.bottom?0:1}scrollToTop(){this.scrollPanel.current&&this.scrollPanel.current.scrollToTop()}scrollToBottom(){this.scrollPanel.current&&this.scrollPanel.current.scrollToBottom()}scrollRelative(e){this.scrollPanel.current&&this.scrollPanel.current.scrollRelative(e)}handleScrollKey(e){this.scrollPanel.current&&this.scrollPanel.current.handleScrollKey(e)}scrollToEvent(e,t,a){this.scrollPanel.current&&this.scrollPanel.current.scrollToToken(e,t,a)}scrollToEventIfNeeded(e){const t=this.getNodeForEventId(e);t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}get showHiddenEvents(){var e,t;return null!==(e=null===(t=this.context)||void 0===t?void 0:t.showHiddenEvents)&&void 0!==e?e:this._showHiddenEvents}shouldShowEvent(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.props.hideThreadedMessages&&this.threadsEnabled){if(e.isThreadRelation)return!1;if(this.shouldLiveInThreadOnly(e))return!1}return!f.a.get().isUserIgnored(e.getSender())&&(!(!this.showHiddenEvents||t)||!!Object(oe.c)(e,this.showHiddenEvents)&&(this.props.highlightedEventId===e.getId()||!Object(b.a)(e,this.context)))}shouldLiveInThreadOnly(e){const t=e.getAssociatedId(),a=e.threadRootId===t;if(e.isThreadRoot||a||!e.isThreadRelation)return!1;const n=this.props.room.findEventById(t);return!n||this.shouldLiveInThreadOnly(n)}readMarkerForEvent(e,t){const a=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return a&&(t=o.a.createElement("hr",{className:"mx_RoomView_myReadMarker",style:{opacity:1,width:"99%"}})),o.a.createElement("li",{key:"readMarker_"+e,ref:this.readMarkerNode,className:"mx_RoomView_myReadMarker_container","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=o.a.createElement("hr",{className:"mx_RoomView_myReadMarker",ref:this.collectGhostReadMarker,onTransitionEnd:this.onGhostTransitionEnd,"data-eventid":e});return o.a.createElement("li",{key:"_readuptoghost_"+e,className:"mx_RoomView_myReadMarker_container"},t)}return null}getNextEventInfo(e,t){return{nextEvent:t<e.length-1?e[t+1]:null,nextTile:e.slice(t+1).find(e=>this.shouldShowEvent(e))}}get pendingEditItem(){if(this.props.room)try{return localStorage.getItem(Object(re.a)(this.props.room.roomId,this.context.timelineRenderingType))}catch(e){return void h.a.error(e)}}getEventTiles(){let e,t,a=-1;for(e=this.props.events.length-1;e>=0;e--){const n=this.props.events[e];if(this.shouldShowEvent(n)&&(void 0===t&&(t=n),!n.status)){a=e;break}}const n=[];let i=null;this.readReceiptsByEvent={},this.props.showReadReceipts&&(this.readReceiptsByEvent=this.getReadReceiptsByShownEvent());let s=null;for(e=0;e<this.props.events.length;e++){const o=this.props.events[e],r=o.getId(),c=o===t,{nextEvent:l,nextTile:d}=this.getNextEventInfo(this.props.events,e);if(s){if(s.shouldGroup(o)){s.add(o);continue}n.push(...s.getTiles()),i=s.getNewPrevEvent(),s=null}for(const e of be)if(e.canStartGroup(this,o)&&!this.props.disableGrouping){s=new e(this,o,i,t,l,d);break}if(!s){this.shouldShowEvent(o)&&(n.push(...this.getTilesForEvent(i,o,c,!1,l,d)),i=o);const t=this.readMarkerForEvent(r,e>=a);t&&n.push(t)}}return s&&n.push(...s.getTiles()),n}getTilesForEvent(e,t){var a;let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4?arguments[4]:void 0,r=arguments.length>5?arguments[5]:void 0;const c=[],l=(null===(a=this.props.editState)||void 0===a?void 0:a.getEvent().getId())===t.getId();let d=t.getTs(),m=t.getDate();t.status&&(m=new Date,d=m.getTime());const h=this.wantsDateSeparator(e,m);if(h&&!i&&this.props.room){const e=o.a.createElement("li",{key:d},o.a.createElement(te.a,{key:d,roomId:this.props.room.roomId,ts:d}));c.push(e)}let u=!0;if(r){const e=r;u=this.wantsDateSeparator(t,e.getDate()||new Date)||t.getSender()!==e.getSender()||Object(se.a)(e,this.showHiddenEvents).isInfoMessage||!me(t,e,this.showHiddenEvents,this.threadsEnabled,this.context.timelineRenderingType)}const p=!h&&me(e,t,this.showHiddenEvents,this.threadsEnabled,this.context.timelineRenderingType),g=t.getId(),b=g===this.props.highlightedEventId,v=this.readReceiptsByEvent[g];let E=!1;const y=e=>!e||"sent"===e,_=y(t.getAssociatedStatus()),S=s&&this.shouldShowEvent(s);(!S&&_||S&&_&&!y(s.getAssociatedStatus()))&&(E=!0),r&&r!==s&&y(r.getAssociatedStatus())&&(E=!1),E=E&&t.getSender()===f.a.get().getUserId();const C=this.props.callEventGroupers.get(t.getContent().call_id);return c.push(o.a.createElement(w.a,{key:t.getTxnId()||g,as:"li",ref:this.collectEventTile.bind(this,g),alwaysShowTimestamps:this.props.alwaysShowTimestamps,mxEvent:t,continuation:p,isRedacted:t.isRedacted(),replacingEventId:t.replacingEventId(),editState:l&&this.props.editState,onHeightChanged:this.onHeightChanged,readReceipts:v,readReceiptMap:this.readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this.isUnmounting,eventSendStatus:t.getAssociatedStatus(),isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:n,lastInSection:u,lastSuccessful:E,isSelectedEvent:b,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,layout:this.props.layout,showReadReceipts:this.props.showReadReceipts,callEventGrouper:C,hideSender:this.state.hideSender})),c}wantsDateSeparator(e,t){return this.context.timelineRenderingType!==y.a.ThreadsList&&(null==e?!this.props.canBackPaginate:Object(v.l)(e.getDate(),t))}getReadReceiptsForEvent(e){const t=f.a.get().credentials.userId,{room:a}=this.props;if(!a)return null;const n=[];return a.getReceiptsForEvent(e).forEach(e=>{if(!e.userId||![p.a.Read,p.a.ReadPrivate].includes(e.type)||e.userId===t)return;if(f.a.get().isUserIgnored(e.userId))return;const i=a.getMember(e.userId);n.push({userId:e.userId,roomMember:i,ts:e.data?e.data.ts:0})}),n}getReadReceiptsByShownEvent(){const e={},t={};let a;for(const n of this.props.events){if(this.shouldShowEvent(n)&&(a=n.getId()),!a)continue;const i=e[a]||[],s=this.getReadReceiptsForEvent(n);e[a]=i.concat(s);for(const e of s)t[e.userId]={lastShownEventId:a,receipt:e}}for(const a in this.readReceiptsByUserId){if(t[a])continue;const{lastShownEventId:n,receipt:i}=this.readReceiptsByUserId[a],s=e[n]||[];e[n]=s.concat(i),t[a]={lastShownEventId:n,receipt:i}}this.readReceiptsByUserId=t;for(const t in e)e[t].sort((e,t)=>t.ts-e.ts);return e}updateTimelineMinHeight(){const e=this.scrollPanel.current;if(e){const t=e.isAtBottom(),a=this.whoIsTyping.current,n=a&&a.isVisible();t&&n&&e.preventShrinking()}}onTimelineReset(){const e=this.scrollPanel.current;e&&e.clearPreventShrinking()}render(){let e,t;this.props.backPaginating&&(e=o.a.createElement("li",{key:"_topSpinner"},o.a.createElement(ne.a,null))),this.props.forwardPaginating&&(t=o.a.createElement("li",{key:"_bottomSpinner"},o.a.createElement(ne.a,null)));const a=this.props.hidden?{display:"none"}:{};let n;this.props.room&&this.state.showTypingNotifications&&this.context.timelineRenderingType===y.a.Room&&(n=o.a.createElement(B,{room:this.props.room,onShown:this.onTypingShown,onHidden:this.onTypingHidden,ref:this.whoIsTyping}));let i=null;this.props.layout==_.a.IRC&&(i=o.a.createElement(x,{minWidth:20,maxWidth:600,roomId:this.props.room?this.props.room.roomId:null}));const s=d()(this.props.className,{mx_MessagePanel_narrow:this.context.narrow});return o.a.createElement(ae.a,null,o.a.createElement(V.a,{ref:this.scrollPanel,className:s,onScroll:this.props.onScroll,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:a,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:i},e,this.getEventTiles(),n,t))}}i()(he,"contextType",y.b),i()(he,"defaultProps",{disableGrouping:!1});class ue{constructor(e,t,a,n,s,o){this.panel=e,this.event=t,this.prevEvent=a,this.lastShownEvent=n,this.nextEvent=s,this.nextEventTile=o,i()(this,"events",[]),i()(this,"ejectedEvents",[]),i()(this,"readMarker",void 0),this.readMarker=e.readMarkerForEvent(t.getId(),t===n)}}i()(ue,"canStartGroup",(e,t)=>!0);class pe extends ue{shouldGroup(e){const t=this.panel,a=this.event;return!t.shouldShowEvent(e)||!t.wantsDateSeparator(this.event,e.getDate())&&((e.getType()!==m.b.RoomMember||e.getStateKey()===a.getSender()&&"join"===e.getContent().membership)&&(!g.b.matches(e.getType())&&!(!e.isState()||e.getSender()!==a.getSender())))}add(e){const t=this.panel;this.readMarker=this.readMarker||t.readMarkerForEvent(e.getId(),e===this.lastShownEvent),t.shouldShowEvent(e)&&(e.getType()===m.b.RoomEncryption?this.ejectedEvents.push(e):this.events.push(e))}getTiles(){if(!this.events||!this.events.length)return[];const e=this.panel,t=[],a=this.event,n=this.lastShownEvent;if(e.wantsDateSeparator(this.prevEvent,a.getDate())){const e=a.getTs();t.push(o.a.createElement("li",{key:e+"~"},o.a.createElement(te.a,{roomId:a.getRoomId(),ts:e})))}e.shouldShowEvent(a)&&t.push(...e.getTilesForEvent(a,a));for(const i of this.ejectedEvents)t.push(...e.getTilesForEvent(a,i,a===n,!0));const i=this.events.map(t=>e.getTilesForEvent(t,t,t===n,!0)).reduce((e,t)=>e.concat(t),[]),s=this.events[this.events.length-1];let r;const c=s.getRoomId(),l=s.sender?s.sender.name:s.getSender();return r=R.a.shared().getUserIdForRoomId(c)?Object(S.a)("%(creator)s created this DM.",{creator:l}):Object(S.a)("%(creator)s created and configured the room.",{creator:l}),t.push(o.a.createElement(j.a,{key:"newroomintro"})),t.push(o.a.createElement(K,{key:"roomcreationsummary",events:this.events,onToggle:e.onHeightChanged,summaryMembers:[s.sender],summaryText:r,layout:this.panel.props.layout},i)),this.readMarker&&t.push(this.readMarker),t}getNewPrevEvent(){return this.event}}i()(pe,"canStartGroup",(function(e,t){return t.getType()===m.b.RoomCreate}));class ge extends ue{constructor(e,t,a,n,i,s){super(e,t,a,n,i,s),this.panel=e,this.event=t,this.prevEvent=a,this.lastShownEvent=n,this.events=[t]}shouldGroup(e){return!this.panel.shouldShowEvent(e)||!this.panel.wantsDateSeparator(this.events[0],e.getDate())&&(!!de.includes(e.getType())||(!!e.isRedacted()||!(!this.panel.showHiddenEvents||this.panel.shouldShowEvent(e,!0))))}add(e){(e.getType()!==m.b.RoomMember||Object(C.a)(e,this.panel.showHiddenEvents))&&(this.readMarker=this.readMarker||this.panel.readMarkerForEvent(e.getId(),e===this.lastShownEvent),(this.panel.showHiddenEvents||this.panel.shouldShowEvent(e))&&this.events.push(e))}generateKey(){return"eventlistsummary-"+this.events[0].getId()}getTiles(){var e;if(null===(e=this.events)||void 0===e||!e.length)return[];const t=this.panel,a=this.lastShownEvent,n=[];if(t.wantsDateSeparator(this.prevEvent,this.events[0].getDate())){const e=this.events[0].getTs();n.push(o.a.createElement("li",{key:e+"~"},o.a.createElement(te.a,{roomId:this.events[0].getRoomId(),ts:e})))}const i=this.events.find(e=>this.panel.grouperKeyMap.get(e)),s=i?this.panel.grouperKeyMap.get(i):this.generateKey();i||this.panel.grouperKeyMap.set(this.events[0],s);let r=!1,c=this.events.map((e,n)=>(e.getId()===t.props.highlightedEventId&&(r=!0),t.getTilesForEvent(0===n?this.prevEvent:this.events[n-1],e,e===a,!0,this.nextEvent,this.nextEventTile))).reduce((e,t)=>e.concat(t),[]);return 0===c.length&&(c=null),this.panel.props.canBackPaginate||this.prevEvent||n.push(o.a.createElement(N,{key:"historytile"})),n.push(o.a.createElement(ee,{key:s,events:this.events,onToggle:t.onHeightChanged,startExpanded:r,layout:this.panel.props.layout},c)),this.readMarker&&n.push(this.readMarker),n}getNewPrevEvent(){return this.events[this.events.length-1]}}i()(ge,"canStartGroup",(function(e,t){return!!e.shouldShowEvent(t)&&(!!de.includes(t.getType())||(!!t.isRedacted()||!(!e.showHiddenEvents||e.shouldShowEvent(t,!0))))}));const be=[pe,ge]},577:function(e,t,a){"use strict";var n=a(87),i=a.n(n),s=a(203),o=a(804),r=a(88),c=a.n(r),l=a(145),d=a(369),m=a(441),h=a(0),u=a(90),p=a(704);class g extends i.a.PureComponent{render(){return i.a.createElement(p.a,{data:[{data:this.props.qrCodeData.getBuffer(),mode:"byte"}],className:"mx_VerificationQRCode",width:196})}}var b=a(89),v=a(98),f=a(269),E=a(102),y=a(91),_=a(805);class S extends i.a.PureComponent{constructor(e){super(e),c()(this,"hasVerifier",void 0),c()(this,"onReciprocateYesClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.confirm()}),c()(this,"onReciprocateNoClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.cancel()}),c()(this,"startSAS",async()=>{this.setState({emojiButtonClicked:!0});const e=this.props.request.beginKeyVerification(l.e.SAS);try{await e.verify()}catch(e){h.a.error(e)}}),c()(this,"onSasMatchesClick",()=>{this.state.sasEvent.confirm()}),c()(this,"onSasMismatchesClick",()=>{this.state.sasEvent.mismatch()}),c()(this,"updateVerifierState",()=>{const{request:e}=this.props,t=e.verifier.sasEvent,a=e.verifier.reciprocateQREvent;e.verifier.off(m.b.ShowSas,this.updateVerifierState),e.verifier.off(d.b.ShowReciprocateQr,this.updateVerifierState),this.setState({sasEvent:t,reciprocateQREvent:a})}),c()(this,"onRequestChange",async()=>{const{request:e}=this.props,t=this.hasVerifier;if(this.hasVerifier=!!e.verifier,!t&&this.hasVerifier){e.verifier.on(m.b.ShowSas,this.updateVerifierState),e.verifier.on(d.b.ShowReciprocateQr,this.updateVerifierState);try{await e.verifier.verify()}catch(e){h.a.error("error verify",e)}}}),this.state={},this.hasVerifier=!1}renderQRPhase(){const{member:e,request:t}=this.props,a=t.otherPartySupportsMethod(l.e.SAS),n=t.otherPartySupportsMethod(d.d),s=v.b.get().brand,o=a||n?null:i.a.createElement("p",null,Object(b.a)("The device you are trying to verify doesn't support scanning a QR code or emoji verification, which is what %(brand)s supports. Try with a different client.",{brand:s}));if("dialog"===this.props.layout){let e,s;n&&(e=i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},i.a.createElement("p",null,Object(b.a)("Scan this unique code")),i.a.createElement(g,{qrCodeData:t.qrCodeData}))),a&&(s=i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},i.a.createElement("p",null,Object(b.a)("Compare unique emoji")),i.a.createElement("span",{className:"mx_VerificationPanel_QRPhase_helpText"},Object(b.a)("Compare a unique set of emoji if you don't have a camera on either device")),i.a.createElement(y.a,{disabled:this.state.emojiButtonClicked,onClick:this.startSAS,kind:"primary"},Object(b.a)("Start"))));const r=e&&s?i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_betweenText"},Object(b.a)("or")):null;return i.a.createElement("div",null,Object(b.a)("Verify this device by completing one of the following:"),i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOptions"},e,r,s,o))}let r,c;if(n&&(r=i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(b.a)("Verify by scanning")),i.a.createElement("p",null,Object(b.a)("Ask %(displayName)s to scan your code:",{displayName:e.displayName||e.name||e.userId})),i.a.createElement("div",{className:"mx_VerificationPanel_qrCode"},i.a.createElement(g,{qrCodeData:t.qrCodeData})))),a){const e=this.state.emojiButtonClicked,t=n?Object(b.a)("If you can't scan the code above, verify by comparing unique emoji."):Object(b.a)("Verify by comparing unique emoji.");c=i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(b.a)("Verify by emoji")),i.a.createElement("p",null,t),i.a.createElement(y.a,{disabled:e,kind:"primary",className:"mx_UserInfo_wideButton mx_VerificationPanel_verifyByEmojiButton",onClick:this.startSAS},Object(b.a)("Verify by emoji")))}const m=o?i.a.createElement("div",{className:"mx_UserInfo_container"},o):null;return i.a.createElement(i.a.Fragment,null,r,c,m)}getDevice(){const e=this.props.request&&this.props.request.channel.deviceId;return u.a.get().getStoredDevice(u.a.get().getUserId(),e)}renderQRReciprocatePhase(){const{member:e,request:t}=this.props,a=t.isSelfVerification?Object(b.a)("Almost there! Is your other device showing the same shield?"):Object(b.a)("Almost there! Is %(displayName)s showing the same shield?",{displayName:e.displayName||e.name||e.userId});let n;return n=this.state.reciprocateQREvent?i.a.createElement(i.a.Fragment,null,i.a.createElement("p",null,a),i.a.createElement(f.b,{isUser:!0,status:f.a.Verified,size:128,hideTooltip:!0}),i.a.createElement("div",{className:"mx_VerificationPanel_reciprocateButtons"},i.a.createElement(y.a,{kind:"danger",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateNoClick},Object(b.a)("No")),i.a.createElement(y.a,{kind:"primary",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateYesClick},Object(b.a)("Yes")))):i.a.createElement("p",null,i.a.createElement(E.a,null)),i.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_reciprocate_section"},i.a.createElement("h3",null,Object(b.a)("Verify by scanning")),n)}renderVerifiedPhase(){const{member:e,request:t}=this.props;let a,n;if(t.isSelfVerification||(a=this.props.isRoomEncrypted?Object(b.a)("Verify all users in a room to ensure it's secure."):Object(b.a)("In encrypted rooms, verify all users to ensure it's secure.")),t.isSelfVerification){const e=this.getDevice();e?n=Object(b.a)("You've successfully verified %(deviceName)s (%(deviceId)s)!",{deviceName:e?e.getDisplayName():"",deviceId:this.props.request.channel.deviceId}):(h.a.warn("Verified device we don't know about: "+this.props.request.channel.deviceId),n=Object(b.a)("You've successfully verified your device!"))}else n=Object(b.a)("You've successfully verified %(displayName)s!",{displayName:e.displayName||e.name||e.userId});return i.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_verified_section"},i.a.createElement("p",null,n),i.a.createElement(f.b,{isUser:!0,status:f.a.Verified,size:128,hideTooltip:!0}),a?i.a.createElement("p",null,a):null,i.a.createElement(y.a,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(b.a)("Got it")))}renderCancelledPhase(){const{member:e,request:t}=this.props;let a,n;return a=t.isSelfVerification?Object(b.a)("Start verification again from the notification."):Object(b.a)("Start verification again from their profile."),"m.timeout"===t.cancellationCode?n=Object(b.a)("Verification timed out.")+" "+a:t.cancellingUserId===t.otherUserId?(n=t.isSelfVerification?Object(b.a)("You cancelled verification on your other device."):Object(b.a)("%(displayName)s cancelled verification.",{displayName:e.displayName||e.name||e.userId}),n=`${n} ${a}`):n=Object(b.a)("You cancelled verification.")+" "+a,i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(b.a)("Verification cancelled")),i.a.createElement("p",null,n),i.a.createElement(y.a,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(b.a)("Got it")))}render(){const{member:e,phase:t,request:a}=this.props,n=e.displayName||e.name||e.userId;switch(t){case s.h.Ready:return this.renderQRPhase();case s.h.Started:switch(a.chosenMethod){case l.e.RECIPROCATE_QR_CODE:return this.renderQRReciprocatePhase();case l.e.SAS:{const e=this.state.sasEvent?i.a.createElement(_.a,{displayName:n,device:this.getDevice(),sas:this.state.sasEvent.sas,onCancel:this.onSasMismatchesClick,onDone:this.onSasMatchesClick,inDialog:this.props.inDialog,isSelf:a.isSelfVerification}):i.a.createElement(E.a,null);return i.a.createElement("div",{className:"mx_UserInfo_container"},e)}default:return null}case s.h.Done:return this.renderVerifiedPhase();case s.h.Cancelled:return this.renderCancelledPhase()}return h.a.error("VerificationPanel unhandled phase:",t),null}componentDidMount(){const{request:e}=this.props;if(e.on(s.m.Change,this.onRequestChange),e.verifier){const t=e.verifier.sasEvent,a=e.verifier.reciprocateQREvent;this.setState({sasEvent:t,reciprocateQREvent:a})}this.onRequestChange()}componentWillUnmount(){const{request:e}=this.props;e.verifier&&(e.verifier.off(m.b.ShowSas,this.updateVerifierState),e.verifier.off(d.b.ShowReciprocateQr,this.updateVerifierState)),e.off(s.m.Change,this.onRequestChange)}}var w=a(183),C=a(118),O=a(95),k=a(146),x=a(139),R=a(107);const j=["m.key_mismatch","m.user_error","m.mismatched_sas"];t.a=e=>{const{verificationRequest:t,verificationRequestPromise:r,member:c,onClose:l,layout:d,isRoomEncrypted:m}=e,[h,p]=Object(n.useState)(t),[g,v]=Object(n.useState)(!1),[f,E]=Object(n.useState)(null==h?void 0:h.phase);Object(n.useEffect)(()=>{p(t),t&&(v(!1),E(t.phase))},[t]),Object(n.useEffect)(()=>{r&&async function(){v(!0);const e=await r;v(!1),p(e),E(e.phase)}()},[r]);const y=Object(n.useCallback)(()=>{h&&h.cancelled&&j.includes(h.cancellationCode)?O.a.createTrackedDialog("Verification failed","insecure",R.a,{headerImage:a(807).default,title:Object(b.a)("Your messages are not secure"),description:i.a.createElement("div",null,Object(b.a)("One of the following may be compromised:"),i.a.createElement("ul",null,i.a.createElement("li",null,Object(b.a)("Your homeserver")),i.a.createElement("li",null,Object(b.a)("The homeserver the user you're verifying is connected to")),i.a.createElement("li",null,Object(b.a)("Yours, or the other users' internet connection")),i.a.createElement("li",null,Object(b.a)("Yours, or the other users' session")))),onFinished:l}):h&&E(h.phase)},[l,h]);Object(C.c)(h,s.m.Change,y);const _=Object(n.useCallback)(async()=>{v(!0);const e=u.a.get(),t=await Object(w.c)(e,c.userId),a=await e.requestVerificationDM(c.userId,t);p(a),E(a.phase),x.a.instance.currentCard.phase!=k.a.EncryptionPanel&&x.a.instance.pushCard({phase:k.a.EncryptionPanel,state:{member:c,verificationRequest:a}}),x.a.instance.isOpen||x.a.instance.togglePanel()},[c]),I=!h&&g||h&&(f===s.e||f===s.g||void 0===f),T=h?h.isSelfVerification:c.userId===u.a.get().getUserId();if(!h||I){const e=!h&&g||h&&h.initiatedByMe;return i.a.createElement(o.b,{isRoomEncrypted:m,onStartVerification:_,member:c,isSelfVerification:T,waitingForOtherParty:I&&e,waitingForNetwork:I&&!e,inDialog:"dialog"===d})}return i.a.createElement(S,{isRoomEncrypted:m,layout:d,onClose:l,member:c,request:h,key:h.channel.transactionId,inDialog:"dialog"===d,phase:f})}},581:function(e,t,a){"use strict";a.d(t,"a",(function(){return k})),a.d(t,"b",(function(){return x}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(0),c=a(291),l=a(834),d=a(95),m=a(89),h=a(98),u=a(814),p=a(169),g=a(417),b=a(308),v=a(105),f=a(101),E=a(110);var y,_,S=e=>{let{onFinished:t}=e;const[a,n]=Object(s.useState)(""),i=Object(s.useRef)(),o=async e=>{if(e.preventDefault(),a){if(!await i.current.validate({}))return i.current.focus(),void i.current.validate({focused:!0})}t(!0,a)};return s.createElement(f.a,{title:Object(m.a)("Continuing without email"),className:"mx_RegistrationEmailPromptDialog",contentId:"mx_RegistrationEmailPromptDialog",onFinished:()=>t(!1),fixedWidth:!1},s.createElement("div",{className:"mx_Dialog_content",id:"mx_RegistrationEmailPromptDialog"},s.createElement("p",null,Object(m.a)("Just a heads up, if you don't add an email and forget your password, you could <b>permanently lose access to your account</b>.",{},{b:e=>s.createElement("b",null,e)})),s.createElement("form",{onSubmit:o},s.createElement(g.a,{fieldRef:i,autoFocus:!0,label:Object(m.c)("Email (optional)"),value:a,onChange:e=>{const t=e.target;n(t.value)}}))),s.createElement(E.a,{primaryButton:Object(m.a)("Continue"),onPrimaryButtonClick:o,hasCancel:!1}))},w=a(567),C=a(835),O=a(173);!function(e){e.Email="field_email",e.PhoneNumber="field_phone_number",e.Username="field_username",e.Password="field_password",e.PasswordConfirm="field_password_confirm"}(y||(y={})),function(e){e[e.Unknown=0]="Unknown",e[e.Available=1]="Available",e[e.Unavailable=2]="Unavailable",e[e.Error=3]="Error"}(_||(_={}));const k=3;class x extends o.a.PureComponent{constructor(e){super(e),i()(this,"onSubmit",async e=>{if(e.preventDefault(),e.persist(),!this.props.canSubmit)return;if(await this.verifyFieldsBeforeSubmit())if(""===this.state.email){if(!this.showEmail())return void this.doSubmit(e);d.a.createTrackedDialog("Email prompt dialog","",S,{onFinished:async(t,a)=>{t&&this.setState({email:a},()=>{this.doSubmit(e)})}})}else this.doSubmit(e)}),i()(this,"onEmailChange",e=>{this.setState({email:e.target.value})}),i()(this,"onEmailValidate",e=>{this.markFieldValid(y.Email,e.valid)}),i()(this,"validateEmailRules",Object(p.a)({description:()=>Object(m.a)("Use an email address to recover your account"),hideDescriptionIfValid:!0,rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!this.authStepIsRequired("m.login.email.identity")||!!t},invalid:()=>Object(m.a)("Enter email address (required on this homeserver)")},{key:"email",test:e=>{let{value:t}=e;return!t||c.a(t)},invalid:()=>Object(m.a)("Doesn't look like a valid email address")}]})),i()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),i()(this,"onPasswordValidate",e=>{this.markFieldValid(y.Password,e.valid)}),i()(this,"onPasswordConfirmChange",e=>{this.setState({passwordConfirm:e.target.value})}),i()(this,"onPasswordConfirmValidate",e=>{this.markFieldValid(y.PasswordConfirm,e.valid)}),i()(this,"onPhoneCountryChange",e=>{this.setState({phoneCountry:e.iso2})}),i()(this,"onPhoneNumberChange",e=>{this.setState({phoneNumber:e.target.value})}),i()(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(y.PhoneNumber,t.valid),t}),i()(this,"validatePhoneNumberRules",Object(p.a)({description:()=>Object(m.a)("Other users can invite you to rooms using your contact details"),hideDescriptionIfValid:!0,rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!this.authStepIsRequired("m.login.msisdn")||!!t},invalid:()=>Object(m.a)("Enter phone number (required on this homeserver)")},{key:"email",test:e=>{let{value:t}=e;return!t||Object(l.c)(t)},invalid:()=>Object(m.a)("That phone number doesn't look quite right, please check and try again")}]})),i()(this,"onUsernameChange",e=>{this.setState({username:e.target.value})}),i()(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(y.Username,t.valid),t}),i()(this,"validateUsernameRules",Object(p.a)({description:(e,t)=>{if(!t.every(e=>{let{key:t,valid:a}=e;return"available"===t||a}))return Object(m.a)("Use lowercase letters, numbers, dashes and underscores only")},hideDescriptionIfValid:!0,async deriveData(e){let{value:t}=e;if(!t)return _.Unknown;try{return await this.props.matrixClient.isUsernameAvailable(t)?_.Available:_.Unavailable}catch(e){return _.Error}},rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(m.a)("Enter username")},{key:"safeLocalpart",test:e=>{let{value:t}=e;return!t||u.a.test(t)},invalid:()=>Object(m.a)("Some characters not allowed")},{key:"available",final:!0,test:async(e,t)=>{let{value:a}=e;return!a||t===_.Available},invalid:e=>e===_.Error?Object(m.a)("Unable to check if username has been taken. Try again later."):Object(m.a)("Someone already has that username. Try another or if it is you, sign in below.")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",phoneNumber:this.props.defaultPhoneNumber||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||"",passwordComplexity:null}}doSubmit(e){O.a.instance.setAuthenticationType("Password");const t=this.state.email.trim(),a=this.props.onRegisterClick({username:this.state.username.trim(),password:this.state.password.trim(),email:t,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber});a&&(e.target.disabled=!0,a.finally((function(){e.target.disabled=!1})))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[y.Username,y.Password,y.PasswordConfirm,y.Email,y.PhoneNumber];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const a=this.findFirstInvalidField(t);return!a||(a.focus(),a.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:a}=this.state;a[e]=t,this.setState({fieldValid:a})}authStepIsRequired(e){return this.props.flows.every(t=>t.stages.includes(e))}authStepIsUsed(e){return this.props.flows.some(t=>t.stages.includes(e))}showEmail(){return!!this.authStepIsUsed("m.login.email.identity")}showPhoneNumber(){return!(h.b.get().disable_3pid_login||!this.authStepIsUsed("m.login.msisdn"))}renderEmail(){if(!this.showEmail())return null;const e=this.authStepIsRequired("m.login.email.identity")?Object(m.c)("Email"):Object(m.c)("Email (optional)");return o.a.createElement(g.a,{fieldRef:e=>this[y.Email]=e,label:e,value:this.state.email,validationRules:this.validateEmailRules.bind(this),onChange:this.onEmailChange,onValidate:this.onEmailValidate})}renderPassword(){return o.a.createElement(b.a,{id:"mx_RegistrationForm_password",fieldRef:e=>this[y.Password]=e,minScore:k,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate})}renderPasswordConfirm(){return o.a.createElement(C.a,{id:"mx_RegistrationForm_passwordConfirm",fieldRef:e=>this[y.PasswordConfirm]=e,autoComplete:"new-password",value:this.state.passwordConfirm,password:this.state.password,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate})}renderPhoneNumber(){if(!this.showPhoneNumber())return null;const e=this.authStepIsRequired("m.login.msisdn")?Object(m.a)("Phone"):Object(m.a)("Phone (optional)"),t=o.a.createElement(w.a,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChange});return o.a.createElement(v.a,{ref:e=>this[y.PhoneNumber]=e,type:"text",label:e,value:this.state.phoneNumber,prefixComponent:t,onChange:this.onPhoneNumberChange,onValidate:this.onPhoneNumberValidate})}renderUsername(){return o.a.createElement(v.a,{id:"mx_RegistrationForm_username",ref:e=>this[y.Username]=e,type:"text",autoFocus:!0,label:Object(m.a)("Username"),placeholder:Object(m.a)("Username").toLocaleLowerCase(),value:this.state.username,onChange:this.onUsernameChange,onValidate:this.onUsernameValidate})}render(){const e=o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(m.a)("Register"),disabled:!this.props.canSubmit});let t=null;return this.showEmail()&&(t=this.showPhoneNumber()?o.a.createElement("div",null,Object(m.a)("Add an email to be able to reset your password.")," ",Object(m.a)("Use email or phone to optionally be discoverable by existing contacts.")):o.a.createElement("div",null,Object(m.a)("Add an email to be able to reset your password.")," ",Object(m.a)("Use email to optionally be discoverable by existing contacts."))),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderUsername()),o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail(),this.renderPhoneNumber()),t,e))}}i()(x,"defaultProps",{onValidationChange:r.a.error,canSubmit:!0})},582:function(e,t,a){"use strict";var n=a(87),i=a.n(n),s=a(91),o=a(89),r=a(211),c=a(98),l=a(95),d=a(88),m=a.n(d),h=a(283),u=a(0),p=a(309),g=a(101),b=a(105),v=a(220),f=a(169);class E extends i.a.PureComponent{constructor(e){super(e),m()(this,"defaultServer",void 0),m()(this,"fieldRef",Object(n.createRef)()),m()(this,"validatedConf",void 0),m()(this,"onDefaultChosen",()=>{this.setState({defaultChosen:!0})}),m()(this,"onOtherChosen",()=>{this.setState({defaultChosen:!1})}),m()(this,"onHomeserverChange",e=>{this.setState({otherHomeserver:e.target.value})}),m()(this,"validate",Object(f.a)({deriveData:async e=>{let{value:t}=e,a=t.trim();if(!a.includes("://"))try{const e=await h.a.findClientConfig(a);return this.validatedConf=p.a.buildValidatedConfigFromDiscovery(a,e),{}}catch(e){u.a.error(`Attempted ${a} as a server_name but it failed`,e)}a.includes("://")||(a="https://"+a);try{return this.validatedConf=await p.a.validateServerConfigWithStaticUrls(a),{}}catch(e){u.a.error(e);if(p.a.authComponentStateForError(e).serverErrorIsFatal){let t=Object(o.a)("Unable to validate homeserver");return e.translatedMessage&&(t=e.translatedMessage),{error:t}}try{return this.validatedConf=await p.a.validateServerConfigWithStaticUrls(a,null,!0),{}}catch(e){return u.a.error(e),{error:Object(o.a)("Invalid URL")}}}},rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(o.a)("Specify a homeserver")},{key:"valid",test:async function(e,t){let{value:a}=e,{error:n}=t;return!a||!n},invalid:function(e){let{error:t}=e;return t}}]})),m()(this,"onHomeserverValidate",e=>this.validate(e)),m()(this,"onSubmit",async e=>{e.preventDefault();if(!await this.fieldRef.current.validate({allowEmpty:!1})&&!this.state.defaultChosen)return this.fieldRef.current.focus(),void this.fieldRef.current.validate({allowEmpty:!1,focused:!0});this.props.onFinished(this.state.defaultChosen?this.defaultServer:this.validatedConf)});const t=c.b.get();this.defaultServer=t.validated_server_config;const{serverConfig:a}=this.props;let i="";a.isDefault||(i=a.isNameResolvable&&a.hsName?a.hsName:a.hsUrl),this.state={defaultChosen:a.isDefault,otherHomeserver:i}}render(){let e;"matrix.org"===this.defaultServer.hsName&&(e=Object(o.a)("Matrix.org is the biggest public homeserver in the world, so it's a good place for many."));let t=this.defaultServer.hsName;return this.defaultServer.hsNameIsDifferent&&(t=i.a.createElement(r.a,{class:"mx_Login_underlinedServerName",tooltip:this.defaultServer.hsUrl},this.defaultServer.hsName)),i.a.createElement(g.a,{title:this.props.title||Object(o.a)("Sign into your homeserver"),className:"mx_ServerPickerDialog",contentId:"mx_ServerPickerDialog",onFinished:this.props.onFinished,fixedWidth:!1,hasCancel:!0},i.a.createElement("form",{className:"mx_Dialog_content",id:"mx_ServerPickerDialog",onSubmit:this.onSubmit},i.a.createElement("p",null,Object(o.a)("We call the places where you can host your account 'homeservers'.")," ",e),i.a.createElement(v.a,{name:"defaultChosen",value:"true",checked:this.state.defaultChosen,onChange:this.onDefaultChosen},t),i.a.createElement(v.a,{name:"defaultChosen",value:"false",className:"mx_ServerPickerDialog_otherHomeserverRadio",checked:!this.state.defaultChosen,onChange:this.onOtherChosen,childrenInLabel:!1},i.a.createElement(b.a,{type:"text",className:"mx_ServerPickerDialog_otherHomeserver",label:Object(o.a)("Other homeserver"),onChange:this.onHomeserverChange,onFocus:this.onOtherChosen,ref:this.fieldRef,onValidate:this.onHomeserverValidate,value:this.state.otherHomeserver,validateOnChange:!1,validateOnFocus:!1,autoFocus:!0,id:"mx_homeserverInput"})),i.a.createElement("p",null,Object(o.a)("Use your preferred Matrix homeserver if you have one, or host your own.")),i.a.createElement(s.a,{className:"mx_ServerPickerDialog_continue",kind:"primary",onClick:this.onSubmit},Object(o.a)("Continue")),i.a.createElement("h4",null,Object(o.a)("Learn more")),i.a.createElement("a",{href:"https://matrix.org/faq/#what-is-a-homeserver%3F",target:"_blank",rel:"noreferrer noopener"},Object(o.a)("About homeservers"))))}}var y=a(212);const _=()=>{const e=c.b.get().brand;l.a.createTrackedDialog("Custom Server Dialog","",y.a,{title:Object(o.a)("Server Options"),description:Object(o.a)("You can use the custom server options to sign into other Matrix servers by specifying a different homeserver URL. This allows you to use %(brand)s with an existing Matrix account on a different homeserver.",{brand:e}),button:Object(o.a)("Dismiss"),hasCloseButton:!1,fixedWidth:!1},"mx_ServerPicker_helpDialog")};t.a=e=>{let{title:t,dialogTitle:a,serverConfig:n,onServerConfigChange:d}=e;const m=c.b.get("disable_custom_urls");let h;if(!m&&d){const e=()=>{((e,t,a)=>{l.a.createTrackedDialog("Server Picker","",E,{title:e,serverConfig:t,onFinished:a})})(a,n,e=>{e&&d(e)})};h=i.a.createElement(s.a,{className:"mx_ServerPicker_change",kind:"link",onClick:e},Object(o.a)("Edit"))}let u,p=n.isNameResolvable?n.hsName:n.hsUrl;return n.hsNameIsDifferent&&(p=i.a.createElement(r.a,{class:"mx_Login_underlinedServerName",tooltip:n.hsUrl},n.hsName)),"matrix.org"===n.hsName&&(u=i.a.createElement("span",{className:"mx_ServerPicker_desc"},Object(o.a)("Join millions for free on the largest public server"))),i.a.createElement("div",{className:"mx_ServerPicker"},i.a.createElement("h3",null,t||Object(o.a)("Homeserver")),m?null:i.a.createElement(s.a,{className:"mx_ServerPicker_help",onClick:_}),i.a.createElement("span",{className:"mx_ServerPicker_server",title:"string"==typeof p?p:void 0},p),h,u)}},803:function(e,t,a){"use strict";a.d(t,"a",(function(){return b}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(0),c=a(89),l=a(90),d=a(95),m=a(556),h=a(557),u=a(577),p=a(91),g=a(102);class b extends o.a.Component{constructor(e){super(e),i()(this,"onStoreUpdate",()=>{const e=h.b.sharedInstance();e.phase!==h.a.Finished?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo,lostKeys:e.lostKeys()}):this.props.onFinished()}),i()(this,"onUsePassphraseClick",async()=>{h.b.sharedInstance().usePassPhrase()}),i()(this,"onVerifyClick",()=>{const e=l.a.get(),t=e.getUserId(),a=e.requestVerification(t);this.props.onFinished(),d.a.createTrackedDialog("New Session Verification","Starting dialog",m.a,{verificationRequestPromise:a,member:e.getUser(t),onFinished:async()=>{(await a).cancel(),this.props.onFinished()}})}),i()(this,"onSkipConfirmClick",()=>{h.b.sharedInstance().skipConfirm()}),i()(this,"onSkipBackClick",()=>{h.b.sharedInstance().returnAfterSkip()}),i()(this,"onResetClick",e=>{e.preventDefault();h.b.sharedInstance().reset()}),i()(this,"onResetConfirmClick",()=>{this.props.onFinished();h.b.sharedInstance().resetConfirm()}),i()(this,"onResetBackClick",()=>{h.b.sharedInstance().returnAfterReset()}),i()(this,"onDoneClick",()=>{h.b.sharedInstance().done()}),i()(this,"onEncryptionPanelClose",()=>{this.props.onFinished()});const t=h.b.sharedInstance();t.on("update",this.onStoreUpdate),t.start(),this.state={phase:t.phase,verificationRequest:t.verificationRequest,backupInfo:t.backupInfo,lostKeys:t.lostKeys()}}componentWillUnmount(){const e=h.b.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const{phase:e,lostKeys:t}=this.state;if(this.state.verificationRequest)return o.a.createElement(u.a,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.onEncryptionPanelClose,member:l.a.get().getUser(this.state.verificationRequest.otherUserId),isRoomEncrypted:!1});if(e===h.a.Intro){if(t)return o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("It looks like you don't have a Security Key or any other devices you can verify against.  This device will not be able to access old encrypted messages. In order to verify your identity on this device, you'll need to reset your verification keys.")),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(p.a,{kind:"primary",onClick:this.onResetConfirmClick},Object(c.a)("Proceed with reset"))));{const e=h.b.sharedInstance();let t,n,i;return e.keyInfo&&(a=e.keyInfo,Boolean(a.passphrase&&a.passphrase.salt&&a.passphrase.iterations))?t=Object(c.a)("Verify with Security Key or Phrase"):e.keyInfo&&(t=Object(c.a)("Verify with Security Key")),t&&(n=o.a.createElement(p.a,{kind:"primary",onClick:this.onUsePassphraseClick},t)),e.hasDevicesToVerifyAgainst&&(i=o.a.createElement(p.a,{kind:"primary",onClick:this.onVerifyClick},Object(c.a)("Verify with another device"))),o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Verify your identity to access encrypted messages and prove your identity to others.")),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},i,n),o.a.createElement("div",{className:"mx_SetupEncryptionBody_reset"},Object(c.a)("Forgotten or lost all recovery methods? <a>Reset all</a>",null,{a:e=>o.a.createElement("button",{onClick:this.onResetClick,className:"mx_SetupEncryptionBody_reset_link mx_Dialog_nonDialogButton"},e)})))}}if(e===h.a.Done){let e;return e=this.state.backupInfo?o.a.createElement("p",null,Object(c.a)("Your new device is now verified. It has access to your encrypted messages, and other users will see it as trusted.")):o.a.createElement("p",null,Object(c.a)("Your new device is now verified. Other users will see it as trusted.")),o.a.createElement("div",null,o.a.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),e,o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(p.a,{kind:"primary",onClick:this.onDoneClick},Object(c.a)("Done"))))}return e===h.a.ConfirmSkip?o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Without verifying, you won't have access to all your messages and may appear as untrusted to others.")),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(p.a,{kind:"danger_outline",onClick:this.onSkipConfirmClick},Object(c.a)("I'll verify later")),o.a.createElement(p.a,{kind:"primary",onClick:this.onSkipBackClick},Object(c.a)("Go Back")))):e===h.a.ConfirmReset?o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Resetting your verification keys cannot be undone. After resetting, you won't have access to old encrypted messages, and any friends who have previously verified you will see security warnings until you re-verify with them.")),o.a.createElement("p",null,Object(c.a)("Please only proceed if you're sure you've lost all of your other devices and your security key.")),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(p.a,{kind:"danger_outline",onClick:this.onResetConfirmClick},Object(c.a)("Proceed with reset")),o.a.createElement(p.a,{kind:"primary",onClick:this.onResetBackClick},Object(c.a)("Go Back")))):e===h.a.Busy||e===h.a.Loading?o.a.createElement(g.a,null):void r.a.log("SetupEncryptionBody: Unknown phase "+e);var a}}},804:function(e,t,a){"use strict";a.d(t,"a",(function(){return c}));var n=a(87),i=a.n(n),s=a(89),o=a(91),r=a(102);const c=e=>{let{text:t}=e;return i.a.createElement("div",{className:"mx_EncryptionInfo_spinner"},i.a.createElement(r.a,null),t)};t.b=e=>{let t,a,{waitingForOtherParty:n,waitingForNetwork:r,member:l,onStartVerification:d,isRoomEncrypted:m,inDialog:h,isSelfVerification:u}=e;if(n&&u)t=i.a.createElement("div",null,Object(s.a)("To proceed, please accept the verification request on your other device."));else if(n||r){let e;e=n?Object(s.a)("Waiting for %(displayName)s to accept…",{displayName:l.displayName||l.name||l.userId}):Object(s.a)("Accepting…"),t=i.a.createElement(c,{text:e})}else t=i.a.createElement(o.a,{kind:"primary",className:"mx_UserInfo_wideButton mx_UserInfo_startVerification",onClick:d},Object(s.a)("Start Verification"));return a=m?i.a.createElement("div",null,i.a.createElement("p",null,Object(s.a)("Messages in this room are end-to-end encrypted.")),i.a.createElement("p",null,Object(s.a)("Your messages are secured and only you and the recipient have the unique keys to unlock them."))):i.a.createElement("div",null,i.a.createElement("p",null,Object(s.a)("Messages in this room are not end-to-end encrypted.")),i.a.createElement("p",null,Object(s.a)("In encrypted rooms, your messages are secured and only you and the recipient have the unique keys to unlock them."))),h?t:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{"data-test-id":"encryption-info-description",className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(s.a)("Encryption")),a),i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(s.a)("Verify User")),i.a.createElement("div",null,i.a.createElement("p",null,Object(s.a)("For extra security, verify this user by checking a one-time code on both of your devices.")),i.a.createElement("p",null,Object(s.a)("To be secure, do this in person or use a trusted way to communicate.")),t)))}},805:function(e,t,a){"use strict";a.d(t,"a",(function(){return m}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(89),c=a(804),l=a(91),d=a(806);class m extends o.a.Component{constructor(e){super(e),i()(this,"onMatchClick",()=>{this.setState({pending:!0}),this.props.onDone()}),i()(this,"onDontMatchClick",()=>{this.setState({cancelling:!0}),this.props.onCancel()}),this.state={pending:!1}}componentWillMount(){Object(d.a)()}render(){let e,t,a;if(this.props.sas.emoji){const a=this.props.sas.emoji.map((e,t)=>{return o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_block",key:t},o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_emoji"},e[0]),o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_label"},Object(r.a)((a=e[1]).charAt(0).toUpperCase()+a.slice(1))));var a});e=o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas"},a.slice(0,4),o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_break"}),a.slice(4)),t=this.props.isSelf?Object(r.a)("Confirm the emoji below are displayed on both devices, in the same order:"):Object(r.a)("Verify this user by confirming the following emoji appear on their screen.")}else{if(!this.props.sas.decimal)return o.a.createElement("div",null,Object(r.a)("Unable to find a supported verification method."),o.a.createElement(l.a,{kind:"primary",onClick:this.props.onCancel},Object(r.a)("Cancel")));{const a=this.props.sas.decimal.map((e,t)=>o.a.createElement("span",{key:t},e));e=o.a.createElement("div",{className:"mx_VerificationShowSas_decimalSas"},a),t=this.props.isSelf?Object(r.a)("Verify this device by confirming the following number appears on its screen."):Object(r.a)("Verify this user by confirming the following number appears on their screen.")}}if(this.state.pending&&this.props.isSelf){let e;e=this.props.device?Object(r.a)("Waiting for you to verify on your other device, %(deviceName)s (%(deviceId)s)…",{deviceName:this.props.device?this.props.device.getDisplayName():"",deviceId:this.props.device?this.props.device.deviceId:""}):Object(r.a)("Waiting for you to verify on your other device…"),a=o.a.createElement("p",null,e)}else if(this.state.pending||this.state.cancelling){let e;if(this.state.pending){const{displayName:t}=this.props;e=Object(r.a)("Waiting for %(displayName)s to verify…",{displayName:t})}else e=Object(r.a)("Cancelling…");a=o.a.createElement(c.a,{text:e})}else a=o.a.createElement("div",{className:"mx_VerificationShowSas_buttonRow"},o.a.createElement(l.a,{onClick:this.onDontMatchClick,kind:"danger"},Object(r.a)("They don't match")),o.a.createElement(l.a,{onClick:this.onMatchClick,kind:"primary"},Object(r.a)("They match")));return o.a.createElement("div",{className:"mx_VerificationShowSas"},o.a.createElement("p",null,t),e,o.a.createElement("p",null,this.props.isSelf?"":Object(r.a)("To be secure, do this in person or use a trusted way to communicate.")),a)}}Object(r.c)("Dog"),Object(r.c)("Cat"),Object(r.c)("Lion"),Object(r.c)("Horse"),Object(r.c)("Unicorn"),Object(r.c)("Pig"),Object(r.c)("Elephant"),Object(r.c)("Rabbit"),Object(r.c)("Panda"),Object(r.c)("Rooster"),Object(r.c)("Penguin"),Object(r.c)("Turtle"),Object(r.c)("Fish"),Object(r.c)("Octopus"),Object(r.c)("Butterfly"),Object(r.c)("Flower"),Object(r.c)("Tree"),Object(r.c)("Cactus"),Object(r.c)("Mushroom"),Object(r.c)("Globe"),Object(r.c)("Moon"),Object(r.c)("Cloud"),Object(r.c)("Fire"),Object(r.c)("Banana"),Object(r.c)("Apple"),Object(r.c)("Strawberry"),Object(r.c)("Corn"),Object(r.c)("Pizza"),Object(r.c)("Cake"),Object(r.c)("Heart"),Object(r.c)("Smiley"),Object(r.c)("Robot"),Object(r.c)("Hat"),Object(r.c)("Glasses"),Object(r.c)("Spanner"),Object(r.c)("Santa"),Object(r.c)("Thumbs up"),Object(r.c)("Umbrella"),Object(r.c)("Hourglass"),Object(r.c)("Clock"),Object(r.c)("Gift"),Object(r.c)("Light bulb"),Object(r.c)("Book"),Object(r.c)("Pencil"),Object(r.c)("Paperclip"),Object(r.c)("Scissors"),Object(r.c)("Lock"),Object(r.c)("Key"),Object(r.c)("Hammer"),Object(r.c)("Telephone"),Object(r.c)("Flag"),Object(r.c)("Train"),Object(r.c)("Bicycle"),Object(r.c)("Aeroplane"),Object(r.c)("Rocket"),Object(r.c)("Trophy"),Object(r.c)("Ball"),Object(r.c)("Guitar"),Object(r.c)("Trumpet"),Object(r.c)("Bell"),Object(r.c)("Anchor"),Object(r.c)("Headphones"),Object(r.c)("Folder"),Object(r.c)("Pin")},806:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n=a(0);async function i(){n.a.log("Checking for COLR support");const{userAgent:e}=navigator;if(e.includes("Firefox"))return n.a.log("Browser is Firefox - assuming COLR is supported"),!0;if(!e.includes("Chrome")&&e.includes("Safari"))return function(e){n.a.log("Browser is Safari - checking version for COLR support");try{const t=e.match(/Mac OS X ([\d|_]+).*Version\/([\d|.]+).*Safari/);if(t){const e=t[1],a=t[2],i=e.split("_").map(e=>parseInt(e,10)),s=a.split(".").map(e=>parseInt(e,10)),o=i[0]>=10&&i[1]>=14&&s[0]>=12;return n.a.log(`COLR support on Safari requires macOS 10.14 and Safari 12, detected Safari ${a} on macOS ${e}, COLR supported: `+o),o}}catch(e){n.a.error("Error in Safari COLR version check",e)}return n.a.warn("Couldn't determine Safari version to check COLR font support, assuming no."),!1}(e);try{const e=document.createElement("canvas"),t=e.getContext("2d"),a=new Image,i=`\n        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="100" style="background:#fff;fill:#000;">\n            <style type="text/css">\n                @font-face {\n                    font-family: "chromacheck-colr";\n                    src: url(data:application/x-font-woff;base64,${"d09GRgABAAAAAAKAAAwAAAAAAowAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABDT0xSAAACVAAAABYAAAAYAAIAJUNQQUwAAAJsAAAAEgAAABLJAAAQT1MvMgAAAYAAAAA6AAAAYBfxJ0pjbWFwAAABxAAAACcAAAAsAAzpM2dseWYAAAH0AAAAGgAAABoNIh0kaGVhZAAAARwAAAAvAAAANgxLumdoaGVhAAABTAAAABUAAAAkCAEEAmhtdHgAAAG8AAAABgAAAAYEAAAAbG9jYQAAAewAAAAGAAAABgANAABtYXhwAAABZAAAABsAAAAgAg4AHW5hbWUAAAIQAAAAOAAAAD4C5wsecG9zdAAAAkgAAAAMAAAAIAADAAB4AWNgZGAAYQ5+qdB4fpuvDNIsDCBwaQGTAIi+VlscBaJZGMDiHAxMIAoAtjIF/QB4AWNgZGBgYQACOAkUQQWMAAGRABAAAAB4AWNgZGBgYGJgAdMMUJILJMQgAWICAAH3AC4AeAFjYGFhYJzAwMrAwDST6QwDA0M/hGZ8zWDMyMmAChgFkDgKQMBw4CXDSwYWEBdIYgAFBgYA/8sIdAAABAAAAAAAAAB4AWNgYGBkYAZiBgYeBhYGBSDNAoRA/kuG//8hpDgjWJ4BAFVMBiYAAAAAAAANAAAAAQAAAAAEAAQAAAMAABEhESEEAPwABAD8AAAAeAEtxgUNgAAAAMHHIQTShTlOAty9/4bf7AARCwlBNhBw4L/43qXjYGUmf19TMuLcj/BJL3XfBg54AWNgZsALAAB9AAR4AWNgYGAEYj4gFgGygGwICQACOwAoAAAAAAABAAEAAQAAAA4AAAAAyP8AAA=="}) format("woff");\n                }\n            </style>\n            <text x="0" y="0" font-size="20">\n                <tspan font-family="chromacheck-colr" x="0" dy="20">&#xe900;</tspan>\n            </text>\n        </svg>`;e.width=20,e.height=100,a.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(i),n.a.log("Waiting for COLR SVG to load"),await new Promise(e=>a.onload=e),n.a.log("Drawing canvas to detect COLR support"),t.drawImage(a,0,0);const s=200===t.getImageData(10,10,1,1).data[0];return n.a.log("Canvas check revealed COLR is supported? "+s),s}catch(e){return n.a.error("Couldn't load COLR font",e),!1}}let s=!1;async function o(){if(!s)if(s=!0,await i()){const e=`url('${a(1398)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:"600"})),document.fonts.add(new FontFace("Twemoji",e,{weight:"700"}))}else{const e=`url('${a(1399)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:"600"})),document.fonts.add(new FontFace("Twemoji",e,{weight:"700"}))}}},807:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M2 9.27V3.05L9 1l7 2.05v6.22C16 15.63 9 17 9 17s-7-1.37-7-7.73zM8.92 4.4c-.57.04-.99.54-.94 1.11l.32 4c.03.35.3.62.65.65h.06c.37 0 .68-.28.71-.65l.32-4v-.16a1.06 1.06 0 00-1.12-.95zm.96 7.72a.88.88 0 11-1.76 0 .88.88 0 011.76 0z",fill:"#020202"})))}t.default="img/e2e/warning.78bb264.svg"},808:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return l}));var n=a(88),i=a.n(n),s=a(8),o=a.n(s),r=a(710);function c(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}class l extends o.a{static get instance(){return l._instance||(l._instance=new l),l._instance}storeInvite(e,t){const a=function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?c(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):c(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({roomId:e},t),n=this.generateIdOf(a);return localStorage.setItem("mx_threepid_invite_"+n,JSON.stringify(a)),this.translateInvite(a)}getWireInvites(){const e=[];for(let t=0;t<localStorage.length;t++){const a=localStorage.key(t);a.startsWith("mx_threepid_invite_")&&e.push(JSON.parse(localStorage.getItem(a)))}return e}getInvites(){return this.getWireInvites().map(e=>this.translateInvite(e))}pickBestInvite(){return this.getInvites()[0]}resolveInvite(e){localStorage.removeItem("mx_threepid_invite_"+e.id)}generateIdOf(t){return r.base32.stringify(e.from(JSON.stringify(t)))}translateInvite(e){return{id:this.generateIdOf(e),roomId:e.roomId,toEmail:e.email,signUrl:e.signurl,roomName:e.room_name,roomAvatarUrl:e.room_avatar_url,inviterName:e.inviter_name}}translateToWireFormat(e){return{email:e.toEmail,signurl:e.signUrl,room_name:e.roomName,room_avatar_url:e.roomAvatarUrl,inviter_name:e.inviterName}}}i()(l,"_instance",void 0)}).call(this,a(31).Buffer)},809:function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var n=a(87),i=a.n(n),s=a(94),o=a.n(s),r=a(175),c=a(207);class l extends i.a.Component{render(){const{fallbackName:e,member:t,colored:a,emphasizeDisplayName:n,onClick:s}=this.props,l=(null==t?void 0:t.rawDisplayName)||e,d=null==t?void 0:t.userId;let m,h;a&&(m=Object(r.f)(e)),null!=t&&t.disambiguate&&d&&(h=i.a.createElement("span",{className:"mx_DisambiguatedProfile_mxid"},c.a.getDisplayUserIdentifier(d,{withDisplayName:!0,roomId:t.roomId})));const u=o()({mx_DisambiguatedProfile_displayName:n,[m]:!0});return i.a.createElement("div",{className:"mx_DisambiguatedProfile",onClick:s},i.a.createElement("span",{className:u,dir:"auto"},l),h)}}},810:function(e,t,a){"use strict";a.d(t,"a",(function(){return c}));var n=a(88),i=a.n(n),s=a(162),o=a(173);class r{constructor(e,t){this.failedEventId=e,this.errorCode=t,i()(this,"ts",void 0),this.ts=Date.now()}}class c{constructor(e,t){if(this.fn=e,this.errorCodeMapFn=t,i()(this,"failures",new Map),i()(this,"visibleEvents",new Set),i()(this,"visibleFailures",new Map),i()(this,"failureCounts",{}),i()(this,"trackedEvents",new Set),i()(this,"checkInterval",null),i()(this,"trackInterval",null),!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if("function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function")}static get instance(){return c.internalInstance}eventDecrypted(e,t){t?this.addDecryptionFailure(new r(e.getId(),t.errcode)):this.removeDecryptionFailuresForEvent(e)}addVisibleEvent(e){const t=e.getId();this.trackedEvents.has(t)||(this.visibleEvents.add(t),this.failures.has(t)&&!this.visibleFailures.has(t)&&this.visibleFailures.set(t,this.failures.get(t)))}addDecryptionFailure(e){const t=e.failedEventId;this.trackedEvents.has(t)||(this.failures.set(t,e),this.visibleEvents.has(t)&&!this.visibleFailures.has(t)&&this.visibleFailures.set(t,e))}removeDecryptionFailuresForEvent(e){const t=e.getId();this.failures.delete(t),this.visibleFailures.delete(t)}start(){this.checkInterval=setInterval(()=>this.checkFailures(Date.now()),c.CHECK_INTERVAL_MS),this.trackInterval=setInterval(()=>this.trackFailures(),c.TRACK_INTERVAL_MS)}stop(){clearInterval(this.checkInterval),clearInterval(this.trackInterval),this.failures=new Map,this.visibleEvents=new Set,this.visibleFailures=new Map,this.failureCounts={}}checkFailures(e){const t=new Set,a=new Map;for(const[n,i]of this.visibleFailures)e>i.ts+c.GRACE_PERIOD_MS?(t.add(i),this.trackedEvents.add(n)):a.set(n,i);this.visibleFailures=a,this.aggregateFailures(t)}aggregateFailures(e){for(const t of e){const e=t.errorCode;this.failureCounts[e]=(this.failureCounts[e]||0)+1}}trackFailures(){for(const e of Object.keys(this.failureCounts))if(this.failureCounts[e]>0){const t=this.errorCodeMapFn(e);this.fn(this.failureCounts[e],t,e),this.failureCounts[e]=0}}}i()(c,"internalInstance",new c((e,t,a)=>{s.a.trackEvent("E2E","Decryption failure",t,String(e));for(let n=0;n<e;n++)o.a.instance.trackEvent({eventName:"Error",domain:"E2EE",name:t,context:"mxc_crypto_error_type_"+a})},e=>{switch(e){case"MEGOLM_UNKNOWN_INBOUND_SESSION_ID":return"OlmKeysNotSentError";case"OLM_UNKNOWN_MESSAGE_INDEX":return"OlmIndexError";case void 0:return"OlmUnspecifiedError";default:return"UnknownError"}})),i()(c,"TRACK_INTERVAL_MS",6e4),i()(c,"CHECK_INTERVAL_MS",5e3),i()(c,"GRACE_PERIOD_MS",4e3)},811:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(3),c=a(89);const l=new r.b("busy","org.matrix.msc3026.busy");class d extends o.a.Component{getDuration(e){if(!e)return;const t=Math.round(e/1e3),a=t%60,n=Math.round(t/60)%60,i=Math.round(t/3600)%24,s=Math.round(t/86400);return t<60?t<0?Object(c.a)("%(duration)ss",{duration:0}):Object(c.a)("%(duration)ss",{duration:a}):t<3600?Object(c.a)("%(duration)sm",{duration:n}):t<86400?Object(c.a)("%(duration)sh",{duration:i}):Object(c.a)("%(duration)sd",{duration:s})}getPrettyPresence(e,t,a){if(l.matches(e))return Object(c.a)("Busy");if(!a&&void 0!==t&&t>0){const a=this.getDuration(t);return"online"===e?Object(c.a)("Online for %(duration)s",{duration:a}):"unavailable"===e?Object(c.a)("Idle for %(duration)s",{duration:a}):"offline"===e?Object(c.a)("Offline for %(duration)s",{duration:a}):Object(c.a)("Unknown for %(duration)s",{duration:a})}return"online"===e?Object(c.a)("Online"):"unavailable"===e?Object(c.a)("Idle"):"offline"===e?Object(c.a)("Offline"):Object(c.a)("Unknown")}render(){return o.a.createElement("div",{className:"mx_PresenceLabel"},this.getPrettyPresence(this.props.presenceState,this.props.activeAgo,this.props.currentlyActive))}}i()(d,"defaultProps",{activeAgo:-1,presenceState:null})},812:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("g",{fill:"none",fillRule:"evenodd"},i.createElement("path",{fill:"#ECECEC",d:"M0 0h24v24H0z"}),i.createElement("path",{d:"M7.338 13.154c.504 0 .826-.378.826-.882 0-.518-.322-.882-.826-.882-.49 0-.826.364-.826.882-.014.504.336.882.826.882zm4.662 0c.504 0 .84-.378.84-.882-.014-.518-.336-.882-.826-.882-.49 0-.84.364-.84.882-.014.504.336.882.826.882zm4.662 0c.518 0 .84-.378.84-.882 0-.518-.336-.882-.826-.882-.49 0-.84.364-.84.882 0 .504.336.882.826.882z",fill:"#454545"}))))}t.default="img/ellipsis.c2118e5.svg"},813:function(e,t,a){"use strict";a.d(t,"a",(function(){return r})),a.d(t,"b",(function(){return c}));var n=a(87),i=a(97),s=a(116),o=a(118);const r=e=>{var t,a,n;return null==e||null===(t=e.currentState)||void 0===t||null===(a=t.getStateEvents(i.b.RoomTopic,""))||void 0===a||null===(n=a.getContent())||void 0===n?void 0:n.topic};function c(e){const[t,a]=Object(n.useState)(r(e));return Object(o.c)(e.currentState,s.b.Events,t=>{t.getType()===i.b.RoomTopic&&a(r(e))}),Object(n.useEffect)(()=>{a(r(e))},[e]),t}},814:function(e,t,a){"use strict";a.d(t,"a",(function(){return d})),a.d(t,"b",(function(){return m}));var n=a(87),i=a.n(n),s=a(92),o=a(95),r=a(89),c=a(115),l=a(96);const d=/^[a-z0-9=_\-./]+$/;async function m(e){void 0===e&&(e={});const t=o.a.createTrackedDialog("Registration required","",c.a,{hasCancelButton:!0,quitOnly:!0,title:Object(r.a)("Sign In or Create Account"),description:Object(r.a)("Use your account or create a new one to continue."),button:Object(r.a)("Create Account"),extraButtons:[i.a.createElement("button",{key:"start_login",onClick:()=>{t.close(),s.a.dispatch({action:"start_login",screenAfterLogin:e.screen_after})}},Object(r.a)("Sign In"))],onFinished:t=>{t?s.a.dispatch({action:"start_registration",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?s.a.dispatch({action:l.a.ViewHomePage}):e.go_welcome_on_cancel&&s.a.dispatch({action:"view_welcome_page"})}})}},815:function(e,t,a){"use strict";a.d(t,"a",(function(){return g}));var n=a(94),i=a.n(n),s=a(97),o=a(87),r=a.n(o),c=a(162),l=a(100),d=a(106),m=a(544),h=a(248),u=a(91),p=a(102);const g=52;t.b=e=>{var t;let{hasAvatar:a,hasAvatarLabel:n,noAvatarLabel:g,setAvatarUrl:b,isUserAvatar:v,children:f,onClick:E}=e;const y=Object(o.useContext)(l.a),[_,S]=Object(o.useState)(!1),[w,C]=Object(o.useState)(!1),[O,k]=Object(o.useState)(!1);Object(m.c)(()=>{k(!0)},3e3),Object(m.c)(()=>{k(!1)},13e3);const x=Object(o.useRef)(),R=a||_?n:g,{room:j}=Object(o.useContext)(d.b);if(!(v||(null==j||null===(t=j.currentState)||void 0===t?void 0:t.maySendStateEvent(s.b.RoomAvatar,y.getUserId()))))return r.a.createElement(r.a.Fragment,null,f);const I=!!R&&(w||O);return r.a.createElement(r.a.Fragment,null,r.a.createElement("input",{type:"file",ref:x,className:"mx_MiniAvatarUploader_input",onClick:e=>{Object(h.a)(e),null==E||E(e)},onChange:async e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;S(!0),c.a.trackEvent("mini_avatar","upload");const a=e.target.files[0],n=await y.uploadContent(a);await b(n),S(!1)},accept:"image/*"}),r.a.createElement(u.a,{className:i()("mx_MiniAvatarUploader",{mx_MiniAvatarUploader_busy:_,mx_MiniAvatarUploader_hasAvatar:a}),disabled:_,onClick:()=>{x.current.click()},onMouseOver:()=>C(!0),onMouseLeave:()=>C(!1)},f,r.a.createElement("div",{className:"mx_MiniAvatarUploader_indicator"},_?r.a.createElement(p.a,{w:20,h:20}):r.a.createElement("div",{className:"mx_MiniAvatarUploader_cameraIcon"})),r.a.createElement("div",{className:i()("mx_Tooltip",{mx_Tooltip_visible:I,mx_Tooltip_invisible:!I})},r.a.createElement("div",{className:"mx_Tooltip_chevron"}),R)))}},816:function(e,t,a){"use strict";a.d(t,"a",(function(){return E}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(361),c=a.n(r),l=a(474),d=a.n(l),m=a(94),h=a.n(m),u=a(0),p=a(89),g=a(92),b=a(90),v=a(100),f=a(176);class E extends o.a.PureComponent{constructor(e,t){super(e,t),i()(this,"unmounted",!1),i()(this,"dispatcherRef",null),i()(this,"onAction",e=>{"client_started"===e.action&&this.forceUpdate()}),this.state={page:""}}translate(e){return d()(Object(p.a)(e))}componentDidMount(){this.unmounted=!1,this.props.url&&(c()({method:"GET",url:this.props.url},(e,t,a)=>{if(!this.unmounted){if(e||t.status<200||t.status>=300)return u.a.warn("Error loading page: "+e),void this.setState({page:Object(p.a)("Couldn't load page")});a=a.replace(/_t\(['"]([\s\S]*?)['"]\)/gm,(e,t)=>this.translate(t)),this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach(e=>{a=a.split(e).join(this.props.replaceMap[e])}),this.setState({page:a})}}),this.dispatcherRef=g.a.register(this.onAction))}componentWillUnmount(){this.unmounted=!0,null!==this.dispatcherRef&&g.a.unregister(this.dispatcherRef)}render(){const e=this.context||b.a.get(),t=!e||e.isGuest(),a=this.props.className,n=h()({[a]:!0,[a+"_guest"]:t,[a+"_loggedIn"]:!!e}),i=o.a.createElement("div",{className:a+"_body",dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?o.a.createElement(f.a,{className:n},i):o.a.createElement("div",{className:n},i)}}i()(E,"contextType",v.a)},817:function(e,t,a){"use strict";(function(e){a.d(t,"b",(function(){return ee}));var n=a(99),i=a.n(n),s=a(103),o=a.n(s),r=a(87),c=a.n(r),l=a(7),d=a(818),m=a(97),h=a(89),u=a(101),p=a(415),g=a(92),b=a(134),v=a(91),f=a(90),E=a(131),y=a(135),_=a(128),S=a(148),w=a(102),C=a(276),O=a(96),k=a(95),x=a(117),R=a(129),j=a(193),I=a(93),T=a(104),N=a(210),P=a(172),M=a(265),D=a(155),A=a(527),U=a(98),L=a(171),F=a(114),B=a(109),V=a(173),W=a(387),H=a(562),z=a(405);const K=["inputRef","children"],q=["inputRef"],G=e=>{let{inputRef:t,children:a}=e,n=o()(e,K);const[s,r,l]=Object(b.i)(t);return c.a.createElement(v.a,i()({},n,{onFocus:s,inputRef:l,tabIndex:-1,"aria-selected":r,role:"option"}),a,c.a.createElement("div",{className:"mx_SpotlightDialog_enterPrompt","aria-hidden":!0},"↵"))},Y=e=>{let{inputRef:t}=e,a=o()(e,q);const[n,s,r]=Object(b.i)(t);return c.a.createElement(x.a,i()({},a,{onFocus:n,inputRef:r,tabIndex:-1,"aria-selected":s,role:"option"}))},J=e=>{let{room:t}=e;const a=t.isSpaceRoom()?Object(H.b)(t):Object(H.a)(t);return a?c.a.createElement("div",{className:"mx_SpotlightDialog_result_details"},a):null};function $(e){var t;return null===(t=e.current)||void 0===t?void 0:t.id.startsWith("mx_SpotlightDialog_button_recentlyViewed_")}var Q;!function(e){e[e.People=0]="People",e[e.Rooms=1]="Rooms",e[e.Spaces=2]="Spaces"}(Q||(Q={}));const X=e=>!(null==e||!e.room),Z=new z.a,ee=(e,t,a)=>{Object(r.useEffect)(()=>{if(!t)return;const n=setTimeout(()=>{V.a.instance.trackEvent({eventName:"WebSearch",viaSpotlight:a,numResults:e,queryLength:t})},1e3);return()=>{clearTimeout(n)}},[e,t,a])},te=t=>{var a,n;let{initialText:i="",onFinished:s}=t;const o=f.a.get(),x=Object(r.useContext)(b.c),[V,H]=Object(r.useState)(i),[z,K]=(()=>{const[e,t]=Object(r.useState)(()=>{const e=f.a.get();return I.b.getValue("SpotlightSearch.recentSearches",null).map(t=>e.getRoom(t)).filter(Boolean)});return[e,()=>{I.b.setValue("SpotlightSearch.recentSearches",null,T.a.ACCOUNT,[]),t([])}]})(),q=Object(r.useMemo)(()=>[...E.a.instance.enabledMetaSpaces.map(e=>({section:Q.Spaces,avatar:c.a.createElement("div",{className:"mx_SpotlightDialog_metaspaceResult mx_SpotlightDialog_metaspaceResult_"+e}),name:Object(L.g)(e,E.a.instance.allRoomsInHome),onClick(){E.a.instance.setActiveSpace(e)}})),...o.getVisibleRooms().filter(e=>"join"===e.getMyMembership()||"invite"==e.getMyMembership()).map(e=>{let t,a;const n=y.a.shared().getUserIdForRoomId(e.roomId);var i;n?(t=Q.People,a=[n.toLowerCase(),null===(i=e.getMember(n))||void 0===i?void 0:i.name.toLowerCase()].filter(Boolean)):t=e.isSpaceRoom()?Q.Spaces:Q.Rooms;return{room:e,section:t,query:a}})],[o]),te=V.trim(),[ae,ne,ie]=Object(r.useMemo)(()=>{if(!te)return[];const e=te.toLowerCase(),t=Object(l.x)(te),a=[[],[],[]];q.forEach(n=>{var i,s,o;if(X(n)){if(!(n.room.normalizedName.includes(t)||null!==(i=n.room.getCanonicalAlias())&&void 0!==i&&i.toLowerCase().includes(e)||null!==(s=n.query)&&void 0!==s&&s.some(t=>t.includes(e))))return}else if(!(n.name.toLowerCase().includes(e)||null!==(o=n.query)&&void 0!==o&&o.some(t=>t.includes(e))))return;a[n.section].push(n)});const n=o.getUserId();for(const e of a)e.sort((e,t)=>{if(!e.room)return 1;if(!t.room)return-1;const a=e.room,i=t.room;return Z.getLastTs(i,n)-Z.getLastTs(a,n)});return a},[q,te,o]),se=te?ae.length+ne.length+ie.length:0;ee(se,V.length,!0);const oe=E.a.instance.activeSpaceRoom,[re,ce]=((e,t)=>{var a;const[n,i]=Object(r.useState)([]),[s,o]=Object(r.useState)(),c=Object(r.useCallback)(()=>{o(e?new d.a(e,50):null)},[e]);Object(r.useEffect)(c,[c]),Object(r.useEffect)(()=>{if(!e||!s)return;let t=!1;return(async()=>{for(;null!=s&&s.canLoadMore&&!t&&e===s.root;)await s.load(),s.canLoadMore&&s.load(),i(s.rooms)})(),()=>{t=!0}},[e,s]);return[Object(r.useMemo)(()=>{const e=t.trim(),a=e.toLowerCase(),i=Object(l.x)(e),s=f.a.get();return null==n?void 0:n.filter(e=>{var t;return e.room_type!==m.f.Space&&"join"!==(null===(t=s.getRoom(e.room_id))||void 0===t?void 0:t.getMyMembership())&&(Object(l.x)(e.name||"").includes(i)||(e.canonical_alias||"").includes(a))})},[n,t]),null!==(a=null==s?void 0:s.loading)&&void 0!==a&&a]})(oe,V),le=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t){const t=new Set(I.b.getValue("SpotlightSearch.recentSearches",null).reverse());t.delete(e),t.add(e),I.b.setValue("SpotlightSearch.recentSearches",null,T.a.ACCOUNT,Array.from(t).reverse().slice(0,10))}g.a.dispatch({action:O.a.ViewRoom,room_id:e,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:a}),s()};let de;if(te){const e=e=>X(e)?c.a.createElement(G,{id:"mx_SpotlightDialog_button_result_"+e.room.roomId,key:e.room.roomId,onClick:t=>{le(e.room.roomId,!0,"click"!==t.type)}},c.a.createElement(C.a,{room:e.room,avatarSize:24,tooltipProps:{tabIndex:-1}}),e.room.name,c.a.createElement(N.a,{notification:P.a.instance.getRoomState(e.room)}),c.a.createElement(J,{room:e.room})):c.a.createElement(G,{id:"mx_SpotlightDialog_button_result_"+e.name,key:e.name,onClick:e.onClick},e.avatar,e.name,e.description);let t,a,n,i,r;ae.length&&(t=c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group"},c.a.createElement("h4",null,Object(h.a)("People")),c.a.createElement("div",null,ae.slice(0,50).map(e)))),ne.length&&(a=c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group"},c.a.createElement("h4",null,Object(h.a)("Rooms")),c.a.createElement("div",null,ne.slice(0,50).map(e)))),ie.length&&(n=c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group"},c.a.createElement("h4",null,Object(h.a)("Spaces you're in")),c.a.createElement("div",null,ie.slice(0,50).map(e)))),re.length&&(i=c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group"},c.a.createElement("h4",null,Object(h.a)("Other rooms in %(spaceName)s",{spaceName:oe.name})),c.a.createElement("div",null,re.slice(0,50).map(e=>c.a.createElement(G,{id:"mx_SpotlightDialog_button_result_"+e.room_id,key:e.room_id,onClick:t=>{le(e.room_id,!0,"click"!==t.type)}},c.a.createElement(S.a,{name:e.name,idName:e.room_id,url:e.avatar_url?Object(_.b)(e.avatar_url).getSquareThumbnailHttp(24):null,width:24,height:24}),e.name||e.canonical_alias,e.name&&e.canonical_alias&&c.a.createElement("div",{className:"mx_SpotlightDialog_result_details"},e.canonical_alias))),ce&&c.a.createElement(w.a,null)))),!te.startsWith("#")||!te.includes(":")||Object(W.a)(te)&&o.getRoom(Object(W.a)(te))||(r=c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group"},c.a.createElement("div",null,c.a.createElement(G,{id:"mx_SpotlightDialog_button_joinRoomAlias",className:"mx_SpotlightDialog_joinRoomAlias",onClick:e=>{g.a.dispatch({action:O.a.ViewRoom,room_alias:te,auto_join:!0,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:"click"!==e.type}),s()}},Object(h.a)("Join %(roomAddress)s",{roomAddress:te}))))),de=c.a.createElement(c.a.Fragment,null,t,a,n,i,r,c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group"},c.a.createElement("h4",null,Object(h.a)('Use "%(query)s" to search',{query:V})),c.a.createElement("div",null,c.a.createElement(G,{id:"mx_SpotlightDialog_button_explorePublicRooms",className:"mx_SpotlightDialog_explorePublicRooms",onClick:()=>{g.a.dispatch({action:O.a.ViewRoomDirectory,initialText:V}),s()}},Object(h.a)("Public rooms")),c.a.createElement(G,{id:"mx_SpotlightDialog_button_startChat",className:"mx_SpotlightDialog_startChat",onClick:()=>{Object(j.f)(V),s()}},Object(h.a)("People")))),c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group"},c.a.createElement("h4",null,Object(h.a)("Other searches")),c.a.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},Object(h.a)("To search messages, look for this icon at the top of a room <icon/>",{},{icon:()=>c.a.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchIcon"})}))))}else{let e;z.length&&(e=c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentSearches",role:"group",tabIndex:-1},c.a.createElement("h4",null,Object(h.a)("Recent searches"),c.a.createElement(v.a,{kind:"link",onClick:K},Object(h.a)("Clear"))),c.a.createElement("div",null,z.map(e=>c.a.createElement(G,{id:"mx_SpotlightDialog_button_recentSearch_"+e.roomId,key:e.roomId,onClick:t=>{le(e.roomId,!0,"click"!==t.type)}},c.a.createElement(C.a,{room:e,avatarSize:24,tooltipProps:{tabIndex:-1}}),e.name,c.a.createElement(N.a,{notification:P.a.instance.getRoomState(e)}),c.a.createElement(J,{room:e})))))),de=c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentlyViewed",role:"group"},c.a.createElement("h4",null,Object(h.a)("Recently viewed")),c.a.createElement("div",null,p.a.instance.rooms.filter(e=>e.roomId!==R.a.instance.getRoomId()).map(e=>c.a.createElement(Y,{id:"mx_SpotlightDialog_button_recentlyViewed_"+e.roomId,title:e.name,key:e.roomId,onClick:t=>{le(e.roomId,!1,"click"!==t.type)}},c.a.createElement(C.a,{room:e,avatarSize:32,tooltipProps:{tabIndex:-1}}),e.name)))),e,c.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group"},c.a.createElement("h4",null,Object(h.a)("Other searches")),c.a.createElement("div",null,c.a.createElement(G,{id:"mx_SpotlightDialog_button_explorePublicRooms",className:"mx_SpotlightDialog_explorePublicRooms",onClick:()=>{g.a.fire(O.a.ViewRoomDirectory),s()}},Object(h.a)("Explore public rooms")))))}const me=U.b.get().bug_report_endpoint_url?()=>{k.a.createTrackedDialog("Spotlight Feedback","feature_spotlight",A.a,{featureId:"feature_spotlight"})}:null,he=null===(a=x.state.activeRef)||void 0===a||null===(n=a.current)||void 0===n?void 0:n.id;return c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{id:"mx_SpotlightDialog_keyboardPrompt"},Object(h.a)("Use <arrows/> to scroll",{},{arrows:()=>c.a.createElement(c.a.Fragment,null,c.a.createElement("div",null,"↓"),c.a.createElement("div",null,"↑"),!V&&c.a.createElement("div",null,"←"),!V&&c.a.createElement("div",null,"→"))})),c.a.createElement(u.a,{className:"mx_SpotlightDialog",onFinished:s,hasCancel:!1,onKeyDown:e=>{switch(Object(F.a)().getNavigationAction(e)){case B.h.FilterRooms:e.stopPropagation(),e.preventDefault(),s()}switch(Object(F.a)().getAccessibilityAction(e)){case B.h.Escape:e.stopPropagation(),e.preventDefault(),s()}},screenName:"UnifiedSearch","aria-label":Object(h.a)("Search Dialog")},c.a.createElement("div",{className:"mx_SpotlightDialog_searchBox mx_textinput"},c.a.createElement("input",{autoFocus:!0,type:"text",autoComplete:"off",placeholder:Object(h.a)("Search"),value:V,onChange:t=>{const a=t.currentTarget.value;H(a),e(()=>{const e=x.state.refs[0];var t;e&&(x.dispatch({type:b.f.SetFocus,payload:{ref:e}}),null===(t=e.current)||void 0===t||t.scrollIntoView({block:"nearest"}))})},onKeyDown:e=>{var t,a;let n;const i=Object(F.a)().getAccessibilityAction(e);switch(i){case B.h.ArrowUp:case B.h.ArrowDown:if(e.stopPropagation(),e.preventDefault(),x.state.refs.length>0){let e=x.state.refs;if(!V){const t=$(x.state.activeRef)?x.state.activeRef:e.find($);e=e.filter(e=>e===t||!$(e))}const t=e.indexOf(x.state.activeRef);n=Object(b.h)(e,t+(i===B.h.ArrowUp?-1:1))}break;case B.h.ArrowLeft:case B.h.ArrowRight:if(!V&&x.state.refs.length>0&&$(x.state.activeRef)){e.stopPropagation(),e.preventDefault();const t=x.state.refs.filter($),a=t.indexOf(x.state.activeRef);n=Object(b.h)(t,a+(i===B.h.ArrowLeft?-1:1))}break;case B.h.Enter:e.stopPropagation(),e.preventDefault(),null===(t=x.state.activeRef)||void 0===t||null===(a=t.current)||void 0===a||a.click()}var s;n&&(x.dispatch({type:b.f.SetFocus,payload:{ref:n}}),null===(s=n.current)||void 0===s||s.scrollIntoView({block:"nearest"}))},"aria-owns":"mx_SpotlightDialog_content","aria-activedescendant":he,"aria-label":Object(h.a)("Search"),"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"})),c.a.createElement("div",{id:"mx_SpotlightDialog_content",role:"listbox","aria-activedescendant":he,"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"},de),c.a.createElement("div",{className:"mx_SpotlightDialog_footer"},c.a.createElement(M.a,{onClick:()=>{g.a.dispatch({action:O.a.ViewUserSettings,initialTabId:D.a.Labs}),s()}}),me&&Object(h.a)("Results not as expected? Please <a>give feedback</a>.",{},{a:e=>c.a.createElement(v.a,{kind:"link_inline",onClick:me},e)}),me&&c.a.createElement(v.a,{kind:"primary_outline",onClick:me},Object(h.a)("Feedback")))))};t.a=e=>c.a.createElement(b.d,null,()=>c.a.createElement(te,e))}).call(this,a(179).setImmediate)},818:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n=a(17),i=a.n(n),s=a(97);class o{constructor(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.root=e,this.pageSize=t,this.maxDepth=a,this.suggestedOnly=n,i()(this,"viaMap",new Map),i()(this,"backRefs",new Map),i()(this,"roomMap",new Map),i()(this,"loadRequest",void 0),i()(this,"nextBatch",void 0),i()(this,"_rooms",void 0),i()(this,"serverSupportError",void 0)}get noSupport(){return!!this.serverSupportError}get canLoadMore(){return!!this.serverSupportError||!!this.nextBatch||!this._rooms}get loading(){return!!this.loadRequest}get rooms(){return this._rooms}async load(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.pageSize;if(this.loadRequest)return this.loadRequest.then(e=>e.rooms);this.loadRequest=this.root.client.getRoomHierarchy(this.root.roomId,t,this.maxDepth,this.suggestedOnly,this.nextBatch);try{({rooms:e,next_batch:this.nextBatch}=await this.loadRequest)}catch(e){if("M_UNRECOGNIZED"!==e.errcode)throw e;return this.serverSupportError=e,[]}finally{this.loadRequest=null}return this._rooms?this._rooms=this._rooms.concat(e):this._rooms=e,e.forEach(e=>{this.roomMap.set(e.room_id,e),e.children_state.forEach(t=>{if(t.type!==s.b.SpaceChild)return;const a=t.state_key;if(this.backRefs.has(a)||this.backRefs.set(a,[]),this.backRefs.get(a).push(e.room_id),Array.isArray(t.content.via)){this.viaMap.has(a)||this.viaMap.set(a,new Set);const e=this.viaMap.get(a);t.content.via.forEach(t=>e.add(t))}})}),e}getRelation(e,t){var a;return null===(a=this.roomMap.get(e))||void 0===a?void 0:a.children_state.find(e=>e.state_key===t)}isSuggested(e,t){var a;return null===(a=this.getRelation(e,t))||void 0===a?void 0:a.content.suggested}removeRelation(e,t){const a=this.backRefs.get(t);1===(null==a?void 0:a.length)?this.backRefs.delete(t):null!=a&&a.length&&this.backRefs.set(t,a.filter(t=>t!==e));const n=this.roomMap.get(e);n&&(n.children_state=n.children_state.filter(e=>e.state_key!==t))}}},819:function(e,t,a){"use strict";a.d(t,"b",(function(){return b}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(89),c=a(93),l=a(104),d=a(141),m=a(177),h=a(171),u=a(127);function p(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function g(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?p(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):p(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const b=(e,t)=>a=>{const n=c.b.getValue("Spaces.enabledMetaSpaces");c.b.setValue("Spaces.enabledMetaSpaces",null,l.a.ACCOUNT,g(g({},n),{},{[e]:a.target.checked})),u.b.trackInteraction(t,a,[h.a.Home,null,h.a.Favourites,h.a.People,h.a.Orphans].indexOf(e))};t.a=()=>{const{[h.a.Home]:e,[h.a.Favourites]:t,[h.a.People]:a,[h.a.Orphans]:n}=Object(m.b)("Spaces.enabledMetaSpaces"),i=Object(m.b)("Spaces.allRoomsInHome");return o.a.createElement("div",{className:"mx_SettingsTab mx_SidebarUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(r.a)("Sidebar")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_subheading"},Object(r.a)("Spaces to show")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(r.a)("Spaces are ways to group rooms and people. Alongside the spaces you're in, you can use some pre-built ones too.")),o.a.createElement(d.b,{checked:!!e,onChange:b(h.a.Home,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_homeCheckbox",disabled:e},Object(r.a)("Home")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Home is useful for getting an overview of everything.")),o.a.createElement(d.b,{checked:i,disabled:!e,onChange:e=>{c.b.setValue("Spaces.allRoomsInHome",null,l.a.ACCOUNT,e.target.checked),u.b.trackInteraction("WebSettingsSidebarTabSpacesCheckbox",e,1)},className:"mx_SidebarUserSettingsTab_homeAllRoomsCheckbox"},Object(r.a)("Show all rooms")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Show all your rooms in Home, even if they're in a space.")),o.a.createElement(d.b,{checked:!!t,onChange:b(h.a.Favourites,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_favouritesCheckbox"},Object(r.a)("Favourites")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Group all your favourite rooms and people in one place.")),o.a.createElement(d.b,{checked:!!a,onChange:b(h.a.People,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_peopleCheckbox"},Object(r.a)("People")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Group all your people in one place.")),o.a.createElement(d.b,{checked:!!n,onChange:b(h.a.Orphans,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_orphansCheckbox"},Object(r.a)("Rooms outside of a space")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Group all your rooms that aren't part of a space in one place."))))}},820:function(e,t,a){"use strict";a.d(t,"a",(function(){return S}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(0),c=a(89),l=a(93),d=a(270),m=a(412),h=a(91),u=a(92),p=a(96),g=a(141),b=a(105),v=a(302),f=a(104),E=a(127);function y(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function _(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?y(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):y(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class S extends o.a.Component{constructor(e){super(e),i()(this,"themeTimer",void 0),i()(this,"onThemeChange",e=>{if(this.state.theme===e)return;E.b.trackInteraction("WebSettingsAppearanceTabThemeSelector");const t=l.b.getValue("theme");l.b.setValue("theme",null,f.a.DEVICE,e).catch(()=>{u.a.dispatch({action:p.a.RecheckTheme}),this.setState({theme:t})}),this.setState({theme:e}),u.a.dispatch({action:p.a.RecheckTheme,forceTheme:e})}),i()(this,"onUseSystemThemeChanged",e=>{this.setState({useSystemTheme:e}),l.b.setValue("use_system_theme",null,f.a.DEVICE,e),u.a.dispatch({action:p.a.RecheckTheme})}),i()(this,"onAddCustomTheme",async()=>{let e=l.b.getValue("custom_themes");e||(e=[]),e=e.map(e=>e),this.themeTimer&&clearTimeout(this.themeTimer);try{const t=await fetch(this.state.customThemeUrl),a=await t.json();if(!a||"string"!=typeof a.name||"object"!=typeof a.colors)return void this.setState({customThemeMessage:{text:Object(c.a)("Invalid theme schema."),isError:!0}});e.push(a)}catch(e){return r.a.error(e),void this.setState({customThemeMessage:{text:Object(c.a)("Error downloading theme information."),isError:!0}})}await l.b.setValue("custom_themes",null,f.a.ACCOUNT,e),this.setState({customThemeUrl:"",customThemeMessage:{text:Object(c.a)("Theme added!"),isError:!1}}),this.themeTimer=setTimeout(()=>{this.setState({customThemeMessage:{text:"",isError:!1}})},3e3)}),i()(this,"onCustomThemeChange",e=>{this.setState({customThemeUrl:e.target.value})}),this.state=_(_({},S.calculateThemeState()),{},{customThemeUrl:"",customThemeMessage:{isError:!1,text:""}})}static calculateThemeState(){const e=l.b.getValue("theme"),t=l.b.getValueAt(f.a.DEVICE,"use_system_theme",null,!1,!0),a=l.b.getValueAt(f.a.DEVICE,"theme",null,!1,!0);return t?{theme:e,useSystemTheme:!0}:a?{theme:e,useSystemTheme:!1}:{theme:e,useSystemTheme:l.b.getValueAt(f.a.DEVICE,"use_system_theme")}}renderHighContrastCheckbox(){if(!this.state.useSystemTheme&&(Object(d.c)(this.state.theme)||Object(d.g)(this.state.theme)))return o.a.createElement("div",null,o.a.createElement(g.b,{checked:Object(d.g)(this.state.theme),onChange:e=>this.highContrastThemeChanged(e.target.checked)},Object(c.a)("Use high contrast")))}highContrastThemeChanged(e){let t;t=e?Object(d.c)(this.state.theme):Object(d.d)(this.state.theme),t&&this.onThemeChange(t)}render(){let e,t;if((new m.a).isSystemThemeSupported()&&(e=o.a.createElement("div",null,o.a.createElement(g.b,{checked:this.state.useSystemTheme,onChange:e=>this.onUseSystemThemeChanged(e.target.checked)},l.b.getDisplayName("use_system_theme")))),l.b.getValue("feature_custom_themes")){let e=null;this.state.customThemeMessage.text&&(e=this.state.customThemeMessage.isError?o.a.createElement("div",{className:"text-error"},this.state.customThemeMessage.text):o.a.createElement("div",{className:"text-success"},this.state.customThemeMessage.text)),t=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("form",{onSubmit:this.onAddCustomTheme},o.a.createElement(b.a,{label:Object(c.a)("Custom theme URL"),type:"text",id:"mx_GeneralUserSettingsTab_customThemeInput",autoComplete:"off",onChange:this.onCustomThemeChange,value:this.state.customThemeUrl}),o.a.createElement(h.a,{onClick:this.onAddCustomTheme,type:"submit",kind:"primary_sm",disabled:!this.state.customThemeUrl.trim()},Object(c.a)("Add theme")),e))}const a=Object(d.f)();return o.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Theme")),e,o.a.createElement("div",{className:"mx_ThemeSelectors"},o.a.createElement(v.a,{name:"theme",definitions:a.map(e=>({value:e.id,label:e.name,disabled:this.state.useSystemTheme,className:"mx_ThemeSelector_"+e.id})),onChange:this.onThemeChange,value:this.apparentSelectedThemeId(),outlined:!0})),this.renderHighContrastCheckbox(),t)}apparentSelectedThemeId(){if(this.state.useSystemTheme)return;const e=Object(d.d)(this.state.theme);return e||this.state.theme}}},821:function(e,t,a){"use strict";a.d(t,"a",(function(){return v}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(0),c=a(95),l=a(92),d=a(89),m=a(90),h=a(323),u=a(115),p=a(101),g=a(102),b=a(110);class v extends o.a.Component{constructor(e){super(e),i()(this,"onExportE2eKeysClicked",()=>{c.a.createTrackedDialogAsync("Export E2E Keys","",a.e(6).then(a.bind(null,1474)),{matrixClient:m.a.get()})}),i()(this,"onFinished",e=>{e&&l.a.dispatch({action:"logout"}),this.props.onFinished(e)}),i()(this,"onSetRecoveryMethodClick",()=>{this.state.backupInfo?c.a.createTrackedDialog("Restore Backup","",h.a,null,null,!1,!0):c.a.createTrackedDialogAsync("Key Backup","Key Backup",a.e(7).then(a.bind(null,838)),null,null,!1,!0),this.props.onFinished(!0)}),i()(this,"onLogoutConfirm",()=>{l.a.dispatch({action:"logout"}),this.props.onFinished(!0)});const t=m.a.get(),n=t.isCryptoEnabled()&&!t.getKeyBackupEnabled();this.state={shouldLoadBackupStatus:n,loading:n,backupInfo:null,error:null},n&&this.loadBackupStatus()}async loadBackupStatus(){try{const e=await m.a.get().getKeyBackupVersion();this.setState({loading:!1,backupInfo:e})}catch(e){r.a.log("Unable to fetch key backup status",e),this.setState({loading:!1,error:e})}}render(){if(this.state.shouldLoadBackupStatus){const e=o.a.createElement("div",null,o.a.createElement("p",null,Object(d.a)("Encrypted messages are secured with end-to-end encryption. Only you and the recipient(s) have the keys to read these messages.")),o.a.createElement("p",null,Object(d.a)("Back up your keys before signing out to avoid losing them.")));let t;if(this.state.loading)t=o.a.createElement(g.a,null);else{let a;a=this.state.backupInfo?Object(d.a)("Connect this session to Key Backup"):Object(d.a)("Start using Key Backup"),t=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},e),o.a.createElement(b.a,{primaryButton:a,hasCancel:!1,onPrimaryButtonClick:this.onSetRecoveryMethodClick,focus:!0},o.a.createElement("button",{onClick:this.onLogoutConfirm},Object(d.a)("I don't want my encrypted messages"))),o.a.createElement("details",null,o.a.createElement("summary",null,Object(d.a)("Advanced")),o.a.createElement("p",null,o.a.createElement("button",{onClick:this.onExportE2eKeysClicked},Object(d.a)("Manually export keys")))))}return o.a.createElement(p.a,{title:Object(d.a)("You'll lose access to your encrypted messages"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},t)}return o.a.createElement(u.a,{hasCancelButton:!0,title:Object(d.a)("Sign out"),description:Object(d.a)("Are you sure you want to sign out?"),button:Object(d.a)("Sign out"),onFinished:this.onFinished})}}i()(v,"defaultProps",{onFinished:function(){}})},830:function(e,t,a){"use strict";a.d(t,"a",(function(){return i})),a.d(t,"b",(function(){return s})),a.d(t,"c",(function(){return o})),a.d(t,"d",(function(){return r}));var n=a(89);let i,s;!function(e){e.Html="Html",e.PlainText="PlainText",e.Json="Json"}(i||(i={})),function(e){e.Timeline="Timeline",e.Beginning="Beginning",e.LastNMessages="LastNMessages"}(s||(s={}));const o=e=>{switch(e){case i.Html:return Object(n.a)("HTML");case i.Json:return Object(n.a)("JSON");case i.PlainText:return Object(n.a)("Plain Text");default:throw new Error("Unknown format")}},r=e=>{switch(e){case s.Beginning:return Object(n.a)("From the beginning");case s.LastNMessages:return Object(n.a)("Specify a number of messages");case s.Timeline:return Object(n.a)("Current Timeline");default:throw new Error("Unknown type: "+e)}}},831:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n,i=a(87);function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 10 10",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{d:"M1 1l8 8M9.001 1l-8 8",stroke:"currentColor",strokeWidth:1.6,strokeLinecap:"round"})))}},832:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return b}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(101),c=a(89),l=a(110),d=a(95),m=a(98),h=a(9);function u(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}let p;!function(e){e[e.Primary=0]="Primary",e[e.Cancel=1]="Cancel"}(p||(p={}));const g=e=>{let{onFinished:t,analyticsOwner:a,privacyPolicyUrl:n,primaryButton:i,cancelButton:s,hasCancel:d}=e;const m=n?o.a.createElement("span",null,Object(c.a)("You can read all our terms <PrivacyPolicyUrl>here</PrivacyPolicyUrl>",{},{PrivacyPolicyUrl:e=>o.a.createElement("a",{href:n,rel:"norefferer noopener",target:"_blank"},e,o.a.createElement("span",{className:"mx_AnalyticsPolicyLink"}))})):"";return o.a.createElement(r.a,{className:"mx_AnalyticsLearnMoreDialog",contentId:"mx_AnalyticsLearnMore",title:Object(c.a)("Help improve %(analyticsOwner)s",{analyticsOwner:a}),onFinished:t},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_AnalyticsLearnMore_image_holder"}),o.a.createElement("div",{className:"mx_AnalyticsLearnMore_copy"},Object(c.a)("Help us identify issues and improve %(analyticsOwner)s by sharing anonymous usage data. To understand how people use multiple devices, we'll generate a random identifier, shared by your devices.",{analyticsOwner:a})),o.a.createElement("ul",{className:"mx_AnalyticsLearnMore_bullets"},o.a.createElement("li",null,Object(c.a)("We <Bold>don't</Bold> record or profile any account data",{},{Bold:e=>o.a.createElement("b",null,e)})),o.a.createElement("li",null,Object(c.a)("We <Bold>don't</Bold> share information with third parties",{},{Bold:e=>o.a.createElement("b",null,e)})),o.a.createElement("li",null,Object(c.a)("You can turn this off anytime in settings"))),m),o.a.createElement(l.a,{primaryButton:i,cancelButton:s,onPrimaryButtonClick:()=>t&&t(p.Primary),onCancel:()=>t&&t(p.Cancel),hasCancel:d}))},b=e=>{var t;const a=m.b.get("piwik");let n;a&&"object"==typeof a&&(n=new h.a(a).get("policy_url"));const s=null!==(t=m.b.get("analytics_owner"))&&void 0!==t?t:m.b.get("brand");d.a.createTrackedDialog("Analytics Learn More","",g,function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?u(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):u(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({privacyPolicyUrl:n,analyticsOwner:s},e),"mx_AnalyticsLearnMoreDialog_wrapper")}},833:function(e,t,a){"use strict";a.d(t,"a",(function(){return m}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(89),c=a(93),l=a(102),d=a(263);class m extends o.a.Component{constructor(e){super(e),i()(this,"onSearchChange",e=>{this.setState({searchQuery:e})}),this.state={searchQuery:"",langs:null}}componentDidMount(){if(r.d().then(e=>{e.sort((function(e,t){return e.label<t.label?-1:e.label>t.label?1:0})),this.setState({langs:e})}).catch(()=>{this.setState({langs:["en"]})}),!this.props.value){const e=r.h();this.props.onOptionChange(e)}}render(){if(null===this.state.langs)return o.a.createElement(l.a,null);let e;e=this.state.searchQuery?this.state.langs.filter(e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e)):this.state.langs;const t=e.map(e=>o.a.createElement("div",{key:e.value},e.label));let a=c.b.getValue("language",null,!0),n=null;return a||(a=navigator.language||navigator.userLanguage),n=this.props.value||a,o.a.createElement(d.a,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:n,label:Object(r.a)("Language Dropdown"),disabled:this.props.disabled},t)}}},834:function(e,t,a){"use strict";a.d(t,"c",(function(){return s})),a.d(t,"b",(function(){return c})),a.d(t,"a",(function(){return l}));var n=a(89);const i=/^[0-9 -.]+$/;function s(e){return i.test(e)}const o=127462-"A".charCodeAt(0),r=/^[A-Z]{2}$/,c=e=>r.test(e)?String.fromCodePoint(...e.split("").map(e=>o+e.charCodeAt(0))):"",l=[{iso2:"GB",name:Object(n.c)("United Kingdom"),prefix:"44"},{iso2:"US",name:Object(n.c)("United States"),prefix:"1"},{iso2:"AF",name:Object(n.c)("Afghanistan"),prefix:"93"},{iso2:"AX",name:Object(n.c)("Åland Islands"),prefix:"358"},{iso2:"AL",name:Object(n.c)("Albania"),prefix:"355"},{iso2:"DZ",name:Object(n.c)("Algeria"),prefix:"213"},{iso2:"AS",name:Object(n.c)("American Samoa"),prefix:"1"},{iso2:"AD",name:Object(n.c)("Andorra"),prefix:"376"},{iso2:"AO",name:Object(n.c)("Angola"),prefix:"244"},{iso2:"AI",name:Object(n.c)("Anguilla"),prefix:"1"},{iso2:"AQ",name:Object(n.c)("Antarctica"),prefix:"672"},{iso2:"AG",name:Object(n.c)("Antigua & Barbuda"),prefix:"1"},{iso2:"AR",name:Object(n.c)("Argentina"),prefix:"54"},{iso2:"AM",name:Object(n.c)("Armenia"),prefix:"374"},{iso2:"AW",name:Object(n.c)("Aruba"),prefix:"297"},{iso2:"AU",name:Object(n.c)("Australia"),prefix:"61"},{iso2:"AT",name:Object(n.c)("Austria"),prefix:"43"},{iso2:"AZ",name:Object(n.c)("Azerbaijan"),prefix:"994"},{iso2:"BS",name:Object(n.c)("Bahamas"),prefix:"1"},{iso2:"BH",name:Object(n.c)("Bahrain"),prefix:"973"},{iso2:"BD",name:Object(n.c)("Bangladesh"),prefix:"880"},{iso2:"BB",name:Object(n.c)("Barbados"),prefix:"1"},{iso2:"BY",name:Object(n.c)("Belarus"),prefix:"375"},{iso2:"BE",name:Object(n.c)("Belgium"),prefix:"32"},{iso2:"BZ",name:Object(n.c)("Belize"),prefix:"501"},{iso2:"BJ",name:Object(n.c)("Benin"),prefix:"229"},{iso2:"BM",name:Object(n.c)("Bermuda"),prefix:"1"},{iso2:"BT",name:Object(n.c)("Bhutan"),prefix:"975"},{iso2:"BO",name:Object(n.c)("Bolivia"),prefix:"591"},{iso2:"BA",name:Object(n.c)("Bosnia"),prefix:"387"},{iso2:"BW",name:Object(n.c)("Botswana"),prefix:"267"},{iso2:"BV",name:Object(n.c)("Bouvet Island"),prefix:"47"},{iso2:"BR",name:Object(n.c)("Brazil"),prefix:"55"},{iso2:"IO",name:Object(n.c)("British Indian Ocean Territory"),prefix:"246"},{iso2:"VG",name:Object(n.c)("British Virgin Islands"),prefix:"1"},{iso2:"BN",name:Object(n.c)("Brunei"),prefix:"673"},{iso2:"BG",name:Object(n.c)("Bulgaria"),prefix:"359"},{iso2:"BF",name:Object(n.c)("Burkina Faso"),prefix:"226"},{iso2:"BI",name:Object(n.c)("Burundi"),prefix:"257"},{iso2:"KH",name:Object(n.c)("Cambodia"),prefix:"855"},{iso2:"CM",name:Object(n.c)("Cameroon"),prefix:"237"},{iso2:"CA",name:Object(n.c)("Canada"),prefix:"1"},{iso2:"CV",name:Object(n.c)("Cape Verde"),prefix:"238"},{iso2:"BQ",name:Object(n.c)("Caribbean Netherlands"),prefix:"599"},{iso2:"KY",name:Object(n.c)("Cayman Islands"),prefix:"1"},{iso2:"CF",name:Object(n.c)("Central African Republic"),prefix:"236"},{iso2:"TD",name:Object(n.c)("Chad"),prefix:"235"},{iso2:"CL",name:Object(n.c)("Chile"),prefix:"56"},{iso2:"CN",name:Object(n.c)("China"),prefix:"86"},{iso2:"CX",name:Object(n.c)("Christmas Island"),prefix:"61"},{iso2:"CC",name:Object(n.c)("Cocos (Keeling) Islands"),prefix:"61"},{iso2:"CO",name:Object(n.c)("Colombia"),prefix:"57"},{iso2:"KM",name:Object(n.c)("Comoros"),prefix:"269"},{iso2:"CG",name:Object(n.c)("Congo - Brazzaville"),prefix:"242"},{iso2:"CD",name:Object(n.c)("Congo - Kinshasa"),prefix:"243"},{iso2:"CK",name:Object(n.c)("Cook Islands"),prefix:"682"},{iso2:"CR",name:Object(n.c)("Costa Rica"),prefix:"506"},{iso2:"HR",name:Object(n.c)("Croatia"),prefix:"385"},{iso2:"CU",name:Object(n.c)("Cuba"),prefix:"53"},{iso2:"CW",name:Object(n.c)("Curaçao"),prefix:"599"},{iso2:"CY",name:Object(n.c)("Cyprus"),prefix:"357"},{iso2:"CZ",name:Object(n.c)("Czech Republic"),prefix:"420"},{iso2:"CI",name:Object(n.c)("Côte d’Ivoire"),prefix:"225"},{iso2:"DK",name:Object(n.c)("Denmark"),prefix:"45"},{iso2:"DJ",name:Object(n.c)("Djibouti"),prefix:"253"},{iso2:"DM",name:Object(n.c)("Dominica"),prefix:"1"},{iso2:"DO",name:Object(n.c)("Dominican Republic"),prefix:"1"},{iso2:"EC",name:Object(n.c)("Ecuador"),prefix:"593"},{iso2:"EG",name:Object(n.c)("Egypt"),prefix:"20"},{iso2:"SV",name:Object(n.c)("El Salvador"),prefix:"503"},{iso2:"GQ",name:Object(n.c)("Equatorial Guinea"),prefix:"240"},{iso2:"ER",name:Object(n.c)("Eritrea"),prefix:"291"},{iso2:"EE",name:Object(n.c)("Estonia"),prefix:"372"},{iso2:"ET",name:Object(n.c)("Ethiopia"),prefix:"251"},{iso2:"FK",name:Object(n.c)("Falkland Islands"),prefix:"500"},{iso2:"FO",name:Object(n.c)("Faroe Islands"),prefix:"298"},{iso2:"FJ",name:Object(n.c)("Fiji"),prefix:"679"},{iso2:"FI",name:Object(n.c)("Finland"),prefix:"358"},{iso2:"FR",name:Object(n.c)("France"),prefix:"33"},{iso2:"GF",name:Object(n.c)("French Guiana"),prefix:"594"},{iso2:"PF",name:Object(n.c)("French Polynesia"),prefix:"689"},{iso2:"TF",name:Object(n.c)("French Southern Territories"),prefix:"262"},{iso2:"GA",name:Object(n.c)("Gabon"),prefix:"241"},{iso2:"GM",name:Object(n.c)("Gambia"),prefix:"220"},{iso2:"GE",name:Object(n.c)("Georgia"),prefix:"995"},{iso2:"DE",name:Object(n.c)("Germany"),prefix:"49"},{iso2:"GH",name:Object(n.c)("Ghana"),prefix:"233"},{iso2:"GI",name:Object(n.c)("Gibraltar"),prefix:"350"},{iso2:"GR",name:Object(n.c)("Greece"),prefix:"30"},{iso2:"GL",name:Object(n.c)("Greenland"),prefix:"299"},{iso2:"GD",name:Object(n.c)("Grenada"),prefix:"1"},{iso2:"GP",name:Object(n.c)("Guadeloupe"),prefix:"590"},{iso2:"GU",name:Object(n.c)("Guam"),prefix:"1"},{iso2:"GT",name:Object(n.c)("Guatemala"),prefix:"502"},{iso2:"GG",name:Object(n.c)("Guernsey"),prefix:"44"},{iso2:"GN",name:Object(n.c)("Guinea"),prefix:"224"},{iso2:"GW",name:Object(n.c)("Guinea-Bissau"),prefix:"245"},{iso2:"GY",name:Object(n.c)("Guyana"),prefix:"592"},{iso2:"HT",name:Object(n.c)("Haiti"),prefix:"509"},{iso2:"HM",name:Object(n.c)("Heard & McDonald Islands"),prefix:"672"},{iso2:"HN",name:Object(n.c)("Honduras"),prefix:"504"},{iso2:"HK",name:Object(n.c)("Hong Kong"),prefix:"852"},{iso2:"HU",name:Object(n.c)("Hungary"),prefix:"36"},{iso2:"IS",name:Object(n.c)("Iceland"),prefix:"354"},{iso2:"IN",name:Object(n.c)("India"),prefix:"91"},{iso2:"ID",name:Object(n.c)("Indonesia"),prefix:"62"},{iso2:"IR",name:Object(n.c)("Iran"),prefix:"98"},{iso2:"IQ",name:Object(n.c)("Iraq"),prefix:"964"},{iso2:"IE",name:Object(n.c)("Ireland"),prefix:"353"},{iso2:"IM",name:Object(n.c)("Isle of Man"),prefix:"44"},{iso2:"IL",name:Object(n.c)("Israel"),prefix:"972"},{iso2:"IT",name:Object(n.c)("Italy"),prefix:"39"},{iso2:"JM",name:Object(n.c)("Jamaica"),prefix:"1"},{iso2:"JP",name:Object(n.c)("Japan"),prefix:"81"},{iso2:"JE",name:Object(n.c)("Jersey"),prefix:"44"},{iso2:"JO",name:Object(n.c)("Jordan"),prefix:"962"},{iso2:"KZ",name:Object(n.c)("Kazakhstan"),prefix:"7"},{iso2:"KE",name:Object(n.c)("Kenya"),prefix:"254"},{iso2:"KI",name:Object(n.c)("Kiribati"),prefix:"686"},{iso2:"XK",name:Object(n.c)("Kosovo"),prefix:"383"},{iso2:"KW",name:Object(n.c)("Kuwait"),prefix:"965"},{iso2:"KG",name:Object(n.c)("Kyrgyzstan"),prefix:"996"},{iso2:"LA",name:Object(n.c)("Laos"),prefix:"856"},{iso2:"LV",name:Object(n.c)("Latvia"),prefix:"371"},{iso2:"LB",name:Object(n.c)("Lebanon"),prefix:"961"},{iso2:"LS",name:Object(n.c)("Lesotho"),prefix:"266"},{iso2:"LR",name:Object(n.c)("Liberia"),prefix:"231"},{iso2:"LY",name:Object(n.c)("Libya"),prefix:"218"},{iso2:"LI",name:Object(n.c)("Liechtenstein"),prefix:"423"},{iso2:"LT",name:Object(n.c)("Lithuania"),prefix:"370"},{iso2:"LU",name:Object(n.c)("Luxembourg"),prefix:"352"},{iso2:"MO",name:Object(n.c)("Macau"),prefix:"853"},{iso2:"MK",name:Object(n.c)("Macedonia"),prefix:"389"},{iso2:"MG",name:Object(n.c)("Madagascar"),prefix:"261"},{iso2:"MW",name:Object(n.c)("Malawi"),prefix:"265"},{iso2:"MY",name:Object(n.c)("Malaysia"),prefix:"60"},{iso2:"MV",name:Object(n.c)("Maldives"),prefix:"960"},{iso2:"ML",name:Object(n.c)("Mali"),prefix:"223"},{iso2:"MT",name:Object(n.c)("Malta"),prefix:"356"},{iso2:"MH",name:Object(n.c)("Marshall Islands"),prefix:"692"},{iso2:"MQ",name:Object(n.c)("Martinique"),prefix:"596"},{iso2:"MR",name:Object(n.c)("Mauritania"),prefix:"222"},{iso2:"MU",name:Object(n.c)("Mauritius"),prefix:"230"},{iso2:"YT",name:Object(n.c)("Mayotte"),prefix:"262"},{iso2:"MX",name:Object(n.c)("Mexico"),prefix:"52"},{iso2:"FM",name:Object(n.c)("Micronesia"),prefix:"691"},{iso2:"MD",name:Object(n.c)("Moldova"),prefix:"373"},{iso2:"MC",name:Object(n.c)("Monaco"),prefix:"377"},{iso2:"MN",name:Object(n.c)("Mongolia"),prefix:"976"},{iso2:"ME",name:Object(n.c)("Montenegro"),prefix:"382"},{iso2:"MS",name:Object(n.c)("Montserrat"),prefix:"1"},{iso2:"MA",name:Object(n.c)("Morocco"),prefix:"212"},{iso2:"MZ",name:Object(n.c)("Mozambique"),prefix:"258"},{iso2:"MM",name:Object(n.c)("Myanmar"),prefix:"95"},{iso2:"NA",name:Object(n.c)("Namibia"),prefix:"264"},{iso2:"NR",name:Object(n.c)("Nauru"),prefix:"674"},{iso2:"NP",name:Object(n.c)("Nepal"),prefix:"977"},{iso2:"NL",name:Object(n.c)("Netherlands"),prefix:"31"},{iso2:"NC",name:Object(n.c)("New Caledonia"),prefix:"687"},{iso2:"NZ",name:Object(n.c)("New Zealand"),prefix:"64"},{iso2:"NI",name:Object(n.c)("Nicaragua"),prefix:"505"},{iso2:"NE",name:Object(n.c)("Niger"),prefix:"227"},{iso2:"NG",name:Object(n.c)("Nigeria"),prefix:"234"},{iso2:"NU",name:Object(n.c)("Niue"),prefix:"683"},{iso2:"NF",name:Object(n.c)("Norfolk Island"),prefix:"672"},{iso2:"KP",name:Object(n.c)("North Korea"),prefix:"850"},{iso2:"MP",name:Object(n.c)("Northern Mariana Islands"),prefix:"1"},{iso2:"NO",name:Object(n.c)("Norway"),prefix:"47"},{iso2:"OM",name:Object(n.c)("Oman"),prefix:"968"},{iso2:"PK",name:Object(n.c)("Pakistan"),prefix:"92"},{iso2:"PW",name:Object(n.c)("Palau"),prefix:"680"},{iso2:"PS",name:Object(n.c)("Palestine"),prefix:"970"},{iso2:"PA",name:Object(n.c)("Panama"),prefix:"507"},{iso2:"PG",name:Object(n.c)("Papua New Guinea"),prefix:"675"},{iso2:"PY",name:Object(n.c)("Paraguay"),prefix:"595"},{iso2:"PE",name:Object(n.c)("Peru"),prefix:"51"},{iso2:"PH",name:Object(n.c)("Philippines"),prefix:"63"},{iso2:"PN",name:Object(n.c)("Pitcairn Islands"),prefix:"870"},{iso2:"PL",name:Object(n.c)("Poland"),prefix:"48"},{iso2:"PT",name:Object(n.c)("Portugal"),prefix:"351"},{iso2:"PR",name:Object(n.c)("Puerto Rico"),prefix:"1"},{iso2:"QA",name:Object(n.c)("Qatar"),prefix:"974"},{iso2:"RO",name:Object(n.c)("Romania"),prefix:"40"},{iso2:"RU",name:Object(n.c)("Russia"),prefix:"7"},{iso2:"RW",name:Object(n.c)("Rwanda"),prefix:"250"},{iso2:"RE",name:Object(n.c)("Réunion"),prefix:"262"},{iso2:"WS",name:Object(n.c)("Samoa"),prefix:"685"},{iso2:"SM",name:Object(n.c)("San Marino"),prefix:"378"},{iso2:"SA",name:Object(n.c)("Saudi Arabia"),prefix:"966"},{iso2:"SN",name:Object(n.c)("Senegal"),prefix:"221"},{iso2:"RS",name:Object(n.c)("Serbia"),prefix:"381 p"},{iso2:"SC",name:Object(n.c)("Seychelles"),prefix:"248"},{iso2:"SL",name:Object(n.c)("Sierra Leone"),prefix:"232"},{iso2:"SG",name:Object(n.c)("Singapore"),prefix:"65"},{iso2:"SX",name:Object(n.c)("Sint Maarten"),prefix:"1"},{iso2:"SK",name:Object(n.c)("Slovakia"),prefix:"421"},{iso2:"SI",name:Object(n.c)("Slovenia"),prefix:"386"},{iso2:"SB",name:Object(n.c)("Solomon Islands"),prefix:"677"},{iso2:"SO",name:Object(n.c)("Somalia"),prefix:"252"},{iso2:"ZA",name:Object(n.c)("South Africa"),prefix:"27"},{iso2:"GS",name:Object(n.c)("South Georgia & South Sandwich Islands"),prefix:"500"},{iso2:"KR",name:Object(n.c)("South Korea"),prefix:"82"},{iso2:"SS",name:Object(n.c)("South Sudan"),prefix:"211"},{iso2:"ES",name:Object(n.c)("Spain"),prefix:"34"},{iso2:"LK",name:Object(n.c)("Sri Lanka"),prefix:"94"},{iso2:"BL",name:Object(n.c)("St. Barthélemy"),prefix:"590"},{iso2:"SH",name:Object(n.c)("St. Helena"),prefix:"290 n"},{iso2:"KN",name:Object(n.c)("St. Kitts & Nevis"),prefix:"1"},{iso2:"LC",name:Object(n.c)("St. Lucia"),prefix:"1"},{iso2:"MF",name:Object(n.c)("St. Martin"),prefix:"590"},{iso2:"PM",name:Object(n.c)("St. Pierre & Miquelon"),prefix:"508"},{iso2:"VC",name:Object(n.c)("St. Vincent & Grenadines"),prefix:"1"},{iso2:"SD",name:Object(n.c)("Sudan"),prefix:"249"},{iso2:"SR",name:Object(n.c)("Suriname"),prefix:"597"},{iso2:"SJ",name:Object(n.c)("Svalbard & Jan Mayen"),prefix:"47"},{iso2:"SZ",name:Object(n.c)("Swaziland"),prefix:"268"},{iso2:"SE",name:Object(n.c)("Sweden"),prefix:"46"},{iso2:"CH",name:Object(n.c)("Switzerland"),prefix:"41"},{iso2:"SY",name:Object(n.c)("Syria"),prefix:"963"},{iso2:"ST",name:Object(n.c)("São Tomé & Príncipe"),prefix:"239"},{iso2:"TW",name:Object(n.c)("Taiwan"),prefix:"886"},{iso2:"TJ",name:Object(n.c)("Tajikistan"),prefix:"992"},{iso2:"TZ",name:Object(n.c)("Tanzania"),prefix:"255"},{iso2:"TH",name:Object(n.c)("Thailand"),prefix:"66"},{iso2:"TL",name:Object(n.c)("Timor-Leste"),prefix:"670"},{iso2:"TG",name:Object(n.c)("Togo"),prefix:"228"},{iso2:"TK",name:Object(n.c)("Tokelau"),prefix:"690"},{iso2:"TO",name:Object(n.c)("Tonga"),prefix:"676"},{iso2:"TT",name:Object(n.c)("Trinidad & Tobago"),prefix:"1"},{iso2:"TN",name:Object(n.c)("Tunisia"),prefix:"216"},{iso2:"TR",name:Object(n.c)("Turkey"),prefix:"90"},{iso2:"TM",name:Object(n.c)("Turkmenistan"),prefix:"993"},{iso2:"TC",name:Object(n.c)("Turks & Caicos Islands"),prefix:"1"},{iso2:"TV",name:Object(n.c)("Tuvalu"),prefix:"688"},{iso2:"VI",name:Object(n.c)("U.S. Virgin Islands"),prefix:"1"},{iso2:"UG",name:Object(n.c)("Uganda"),prefix:"256"},{iso2:"UA",name:Object(n.c)("Ukraine"),prefix:"380"},{iso2:"AE",name:Object(n.c)("United Arab Emirates"),prefix:"971"},{iso2:"UY",name:Object(n.c)("Uruguay"),prefix:"598"},{iso2:"UZ",name:Object(n.c)("Uzbekistan"),prefix:"998"},{iso2:"VU",name:Object(n.c)("Vanuatu"),prefix:"678"},{iso2:"VA",name:Object(n.c)("Vatican City"),prefix:"39"},{iso2:"VE",name:Object(n.c)("Venezuela"),prefix:"58"},{iso2:"VN",name:Object(n.c)("Vietnam"),prefix:"84"},{iso2:"WF",name:Object(n.c)("Wallis & Futuna"),prefix:"681"},{iso2:"EH",name:Object(n.c)("Western Sahara"),prefix:"212"},{iso2:"YE",name:Object(n.c)("Yemen"),prefix:"967"},{iso2:"ZM",name:Object(n.c)("Zambia"),prefix:"260"},{iso2:"ZW",name:Object(n.c)("Zimbabwe"),prefix:"263"}]},835:function(e,t,a){"use strict";var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(105),c=a(169),l=a(89);class d extends s.PureComponent{constructor(){super(...arguments),i()(this,"validate",Object(c.a)({rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(l.a)(this.props.labelRequired)},{key:"match",test:e=>{let{value:t}=e;return!t||t===this.props.password},invalid:()=>Object(l.a)(this.props.labelInvalid)}]})),i()(this,"onValidate",async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t})}render(){return o.a.createElement(r.a,{id:this.props.id,ref:this.props.fieldRef,type:"password",label:Object(l.a)(this.props.label),autoComplete:this.props.autoComplete,value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}}i()(d,"defaultProps",{label:Object(l.c)("Confirm password"),labelRequired:Object(l.c)("Confirm password"),labelInvalid:Object(l.c)("Passwords don't match")}),t.a=d},836:function(e,t,a){"use strict";a.d(t,"a",(function(){return s}));var n=a(87),i=a.n(n);class s extends i.a.PureComponent{render(){return i.a.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}}},837:function(e,t,a){"use strict";a.d(t,"a",(function(){return h}));var n=a(87),i=a.n(n),s=a(98),o=a(89),r=a(93),c=a(126),l=a(104),d=a(833);function m(e){Object(o.e)()!==e&&(r.b.setValue("language",null,l.a.DEVICE,e),c.a.get().reload())}function h(e){let{disabled:t}=e;return s.b.get("disable_login_language_selector")?i.a.createElement("div",null):i.a.createElement(d.a,{className:"mx_AuthBody_language",onOptionChange:m,value:Object(o.e)(),disabled:t})}},846:function(e,t,a){"use strict";a.d(t,"a",(function(){return J})),a.d(t,"b",(function(){return $}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(125),c=a(0),l=a(90),d=a(92),m=a(95),h=a(89),u=a(98),p=a(526),g=a(162),b=a(99),v=a.n(b),f=a(112),E=a(177),y=a(93),_=a(169),S=a(104),w=a(703),C=a(115),O=a(147),k=a(149),x=a(9);const R=Object(_.a)({deriveData:async e=>{let{value:t}=e;try{return await l.a.get().publicRooms({limit:1,server:t}),{}}catch(e){return{error:e}}},rules:[{key:"required",test:async e=>{let{value:t}=e;return!!t},invalid:()=>Object(h.a)("Enter a server name")},{key:"available",final:!0,test:async(e,t)=>{let{error:a}=t;return!a},valid:()=>Object(h.a)("Looks good"),invalid:e=>{let{error:t}=e;return"M_FORBIDDEN"===t.errcode?Object(h.a)("You are not allowed to view this server's rooms list"):Object(h.a)("Can't find this server or its room list")}}]});var j=e=>{let{onOptionChange:t,protocols:a={},selectedServerName:n,selectedInstanceId:i}=e;const[r,c,d,g]=Object(f.q)(),b=Object(E.b)("room_directory_servers"),[_,j]=Object(s.useState)(b),I=(e,a)=>()=>{t(e,a),g()},T=e=>{j(e),y.b.setValue("room_directory_servers",null,S.a.ACCOUNT,e)};let N;if(Object(s.useEffect)(()=>{j(b)},[b]),r){var P;const e=null!==(P=u.b.getObject("room_directory"))&&void 0!==P?P:new x.a({servers:[]}),s=l.a.getHomeserverName(),r=new Set(e.get("servers")),d=new Set(_.filter(e=>!r.has(e)&&e!==s)),b=[s,...Array.from(r).filter(e=>e!==s).sort(),...Array.from(d).sort()],E=b.map(e=>{const r=e===n,c=[],l=e===s?Object.values(a):[];let u,v;if(l.length>0&&l.push({instances:[{fields:[],network_id:"",instance_id:p.a,desc:Object(h.a)("All rooms")}],location_fields:[],user_fields:[],field_types:{},icon:""}),l.forEach(t=>{let{instances:a=[]}=t;[...a].sort((e,t)=>Object(k.a)(t.desc,e.desc)).forEach(t=>{let{desc:a,instance_id:n}=t;c.push(o.a.createElement(f.g,{key:String(n),active:r&&n===i,onClick:I(e,n),label:a,className:"mx_NetworkDropdown_server_network"},a))})}),e===s&&(u=o.a.createElement("div",{className:"mx_NetworkDropdown_server_subtitle"},Object(h.a)("Your server"))),d.has(e)){const a=async()=>{g();const{finished:a}=m.a.createTrackedDialog("Network Dropdown","Remove server",C.a,{title:Object(h.a)("Are you sure?"),description:Object(h.a)("Are you sure you want to remove <b>%(serverName)s</b>",{serverName:e},{b:e=>o.a.createElement("b",null,e)}),button:Object(h.a)("Remove"),fixedWidth:!1},"mx_NetworkDropdown_dialog"),[n]=await a;n&&(T(b.filter(t=>t!==e)),r&&t(s,void 0))};v=o.a.createElement(f.e,{onClick:a,label:Object(h.a)("Remove server")})}return o.a.createElement(f.d,{label:e,className:"mx_NetworkDropdown_server",key:e},o.a.createElement("div",{className:"mx_NetworkDropdown_server_title"},e,v),u,o.a.createElement(f.g,{active:r&&!i,onClick:I(e,void 0),label:Object(h.a)("Matrix"),className:"mx_NetworkDropdown_server_network"},Object(h.a)("Matrix")),c)}),y=async()=>{g();const{finished:e}=m.a.createTrackedDialog("Network Dropdown","Add a new server",w.a,{title:Object(h.a)("Add a new server"),description:Object(h.a)("Enter the name of a new server you want to explore."),button:Object(h.a)("Add"),hasCancel:!1,placeholder:Object(h.a)("Server name"),validator:R,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[a,n]=await e;a&&(_.includes(n)||T([..._,n]),t(n))},S=c.current.getBoundingClientRect();N=o.a.createElement(f.o,v()({},(M=S,{right:O.b.instance.windowWidth-M.right,top:M.top,chevronOffset:0,chevronFace:f.a.None}),{onFinished:g,focusLock:!0}),o.a.createElement("div",{className:"mx_NetworkDropdown_menu"},E,o.a.createElement(f.e,{className:"mx_NetworkDropdown_server_add",label:void 0,onClick:y},Object(h.a)("Add a new server..."))))}else{let e;if(i===p.a)e=Object(h.a)("All rooms");else if(i){const t=Object(p.b)(a,i);e=Object(h.a)("%(networkName)s rooms",{networkName:t.desc})}else e=Object(h.a)("Matrix rooms");N=o.a.createElement(f.b,{className:"mx_NetworkDropdown_handle",onClick:d,isExpanded:r},o.a.createElement("span",null,e)," ",o.a.createElement("span",{className:"mx_NetworkDropdown_handle_server"},"(",n,")"))}var M;return o.a.createElement("div",{className:"mx_NetworkDropdown",ref:c},N)},I=a(91),T=a(107),N=a(101);class P extends o.a.Component{constructor(e){super(e),i()(this,"input",Object(s.createRef)()),i()(this,"onClearClick",()=>{this.setState({value:""}),this.input.current&&(this.input.current.focus(),this.props.onClear&&this.props.onClear())}),i()(this,"onChange",e=>{this.input.current&&(this.setState({value:e.target.value}),this.props.onChange&&this.props.onChange(e.target.value))}),i()(this,"onKeyUp",e=>{"Enter"==e.key&&this.props.showJoinButton&&this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}),i()(this,"onJoinButtonClick",()=>{this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}),this.state={value:this.props.initialText||""}}render(){let e;return{mx_DirectorySearchBox:!0}[this.props.className]=!0,this.props.showJoinButton&&(e=o.a.createElement(I.a,{className:"mx_DirectorySearchBox_joinButton",onClick:this.onJoinButtonClick},Object(h.a)("Join"))),o.a.createElement("div",{className:`mx_DirectorySearchBox ${this.props.className} mx_textinput`},o.a.createElement("input",{type:"text",name:"dirsearch",value:this.state.value,className:"mx_textinput_icon mx_textinput_search",ref:this.input,onChange:this.onChange,onKeyUp:this.onKeyUp,placeholder:this.props.placeholder,autoFocus:!0}),e,o.a.createElement(I.a,{className:"mx_DirectorySearchBox_clear",onClick:this.onClearClick}))}}var M=a(401),D=a(102),A=a(238),U=a(127),L=a(148),F=a(128),B=a(158),V=a(100);const W=e=>{let{room:t,showRoom:a,removeFromDirectory:n}=e;const i=Object(s.useContext)(V.a),[r,c]=Object(s.useState)(null),[l,d]=Object(s.useState)(""),[m,u]=Object(s.useState)(""),[p,g]=Object(s.useState)(!1),b=i.isGuest();Object(s.useEffect)(()=>{const e=i.getRoom(t.room_id);g("join"===(null==e?void 0:e.getMyMembership()));let a=t.name||$(t)||Object(h.a)("Unnamed room");a.length>80&&(a=a.substring(0,80)+"..."),d(a);let n=t.topic||"";n.length>800&&(n=n.substring(0,800)+"..."),n=Object(B.f)(n),u(n),t.avatar_url&&c(Object(F.b)(t.avatar_url).getSquareThumbnailHttp(32))},[t,i]);const v=Object(s.useCallback)(e=>{e.shiftKey&&(e.preventDefault(),null==n||n(t))},[t,n]),f=Object(s.useCallback)(e=>{a(t,null,!1,!0),e.stopPropagation()},[t,a]),E=Object(s.useCallback)(e=>{a(t),e.stopPropagation()},[t,a]),y=Object(s.useCallback)(e=>{a(t,null,!0),e.stopPropagation()},[t,a]);let _,S;return p||!t.world_readable&&!b||(_=o.a.createElement(I.a,{kind:"secondary",onClick:f},Object(h.a)("Preview"))),p?S=o.a.createElement(I.a,{kind:"secondary",onClick:E},Object(h.a)("View")):b||(S=o.a.createElement(I.a,{kind:"primary",onClick:y},Object(h.a)("Join"))),o.a.createElement("div",{role:"listitem",className:"mx_RoomDirectory_listItem"},o.a.createElement("div",{onMouseDown:v,className:"mx_RoomDirectory_roomAvatar"},o.a.createElement(L.a,{width:32,height:32,resizeMethod:"crop",name:l,idName:l,url:r})),o.a.createElement("div",{onMouseDown:v,className:"mx_RoomDirectory_roomDescription"},o.a.createElement("div",{className:"mx_RoomDirectory_name"},l)," ",o.a.createElement("div",{className:"mx_RoomDirectory_topic",dangerouslySetInnerHTML:{__html:m}}),o.a.createElement("div",{className:"mx_RoomDirectory_alias"},$(t))),o.a.createElement("div",{onMouseDown:v,className:"mx_RoomDirectory_roomMemberCount"},t.num_joined_members),o.a.createElement("div",{onMouseDown:v,className:"mx_RoomDirectory_preview"},_),o.a.createElement("div",{onMouseDown:v,className:"mx_RoomDirectory_join"},S))};var H=a(264),z=a(747);function K(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function q(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?K(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):K(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const G="mx_last_room_directory_instance";function Y(e){g.a.trackEvent("RoomDirectory",e)}class J extends o.a.Component{constructor(e){var t;super(e),t=this,i()(this,"unmounted",!1),i()(this,"nextBatch",null),i()(this,"filterTimeout",void 0),i()(this,"protocols",void 0),i()(this,"refreshRoomList",()=>{this.nextBatch=null,this.setState({publicRooms:[],loading:!0}),this.getMoreRooms()}),i()(this,"removeFromDirectory",e=>{const t=$(e),a=e.name||t||Object(h.a)("Unnamed room");let n;n=t?Object(h.a)("Delete the room address %(alias)s and remove %(name)s from the directory?",{alias:t,name:a}):Object(h.a)("Remove %(name)s from the directory?",{name:a}),m.a.createTrackedDialog("Remove from Directory","",C.a,{title:Object(h.a)("Remove from Directory"),description:n,onFinished:n=>{if(!n)return;const i=m.a.createDialog(D.a);let s=Object(h.a)("remove %(name)s from the directory.",{name:a});l.a.get().setRoomDirectoryVisibility(e.room_id,r.f.Private).then(()=>{if(t)return s=Object(h.a)("delete the address."),l.a.get().deleteAlias(t)}).then(()=>{i.close(),this.refreshRoomList()},e=>{i.close(),this.refreshRoomList(),c.a.error("Failed to "+s+": "+e),m.a.createTrackedDialog("Remove from Directory Error","",T.a,{title:Object(h.a)("Error"),description:e&&e.message?e.message:Object(h.a)("The server may be unavailable or overloaded")})})}})}),i()(this,"onOptionChange",(e,t)=>{this.nextBatch=null,this.setState({publicRooms:[],roomServer:e,instanceId:t,error:null},this.refreshRoomList),localStorage.setItem("mx_last_room_directory_server",e),t?localStorage.setItem(G,t):localStorage.removeItem(G)}),i()(this,"onFillRequest",e=>e||!this.nextBatch?Promise.resolve(!1):this.getMoreRooms()),i()(this,"onFilterChange",e=>{this.setState({filterString:(null==e?void 0:e.trim())||""}),this.filterTimeout&&clearTimeout(this.filterTimeout),this.filterTimeout=setTimeout(()=>{this.filterTimeout=null,this.refreshRoomList()},700)}),i()(this,"onFilterClear",()=>{this.setState({filterString:""},this.refreshRoomList),this.filterTimeout&&clearTimeout(this.filterTimeout)}),i()(this,"onJoinFromSearchClick",e=>{const t=l.a.get();try{Object(H.b)(t,e,{instanceId:this.state.instanceId,roomServer:this.state.roomServer,protocols:this.protocols,metricsTrigger:"RoomDirectory"})}catch(e){if(!(e instanceof z.a))throw e;m.a.createTrackedDialog(e.message,"",T.a,{title:e.message,description:e.description})}}),i()(this,"onCreateRoomClick",e=>{this.onFinished(),d.a.dispatch({action:"view_create_room",public:!0,defaultName:this.state.filterString.trim()}),U.b.trackInteraction("WebRoomDirectoryCreateRoomButton",e)}),i()(this,"onRoomClick",(function(e,a){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t.onFinished();const s=l.a.get();Object(H.d)(s,e,{roomAlias:a,autoJoin:n,shouldPeek:i,roomServer:t.state.roomServer,metricsTrigger:"RoomDirectory"})})),i()(this,"onFinished",()=>{this.props.onFinished(!1)});let a=!0;l.a.get()?l.a.get().getThirdpartyProtocols().then(e=>{var t,a,n;this.protocols=e;const i=l.a.getHomeserverName(),s=localStorage.getItem("mx_last_room_directory_server"),o=localStorage.getItem(G);let r=i;(null!==(t=u.b.getObject("room_directory"))&&void 0!==t&&null!==(a=t.get("servers"))&&void 0!==a&&a.includes(s)||null!==(n=y.b.getValue("room_directory_servers"))&&void 0!==n&&n.includes(s))&&(r=s);let c=null;if(r!==i||o!==p.a&&!Object.values(this.protocols).some(e=>e.instances.some(e=>e.instance_id===o))||(c=o),this.state.instanceId!==c||this.state.roomServer!==r)return this.setState({protocolsLoading:!1,instanceId:c,roomServer:r}),void this.refreshRoomList();this.setState({protocolsLoading:!1})},e=>{if(c.a.warn("error loading third party protocols: "+e),this.setState({protocolsLoading:!1}),l.a.get().isGuest())return;Y("Failed to get protocol list from homeserver");const t=u.b.get().brand;this.setState({error:Object(h.a)("%(brand)s failed to get the protocol list from the homeserver. The homeserver may be too old to support third party networks.",{brand:t})})}):a=!1,this.state={publicRooms:[],loading:!0,error:null,instanceId:localStorage.getItem(G),roomServer:localStorage.getItem("mx_last_room_directory_server"),filterString:this.props.initialText||"",protocolsLoading:a}}componentDidMount(){this.refreshRoomList()}componentWillUnmount(){this.filterTimeout&&clearTimeout(this.filterTimeout),this.unmounted=!0}getMoreRooms(){if(!l.a.get())return Promise.resolve(!1);this.setState({loading:!0});const e=this.state.filterString,t=this.state.roomServer,a=this.nextBatch,n={limit:20};return t!=l.a.getHomeserverName()&&(n.server=t),this.state.instanceId===p.a?n.include_all_networks=!0:this.state.instanceId&&(n.third_party_instance_id=this.state.instanceId),this.nextBatch&&(n.since=this.nextBatch),e&&(n.filter={generic_search_term:e}),l.a.get().publicRooms(n).then(n=>e==this.state.filterString&&t==this.state.roomServer&&a==this.nextBatch&&(!this.unmounted&&(this.nextBatch=n.next_batch,this.setState(e=>q(q({},e),{},{publicRooms:[...e.publicRooms,...n.chunk||[]],loading:!1})),Boolean(n.next_batch))),n=>{if(e!=this.state.filterString||t!=this.state.roomServer||a!=this.nextBatch)return!1;if(this.unmounted)return!1;c.a.error("Failed to get publicRooms: %s",JSON.stringify(n)),Y("Failed to get public room list");const i=u.b.get().brand;this.setState({loading:!1,error:Object(h.a)("%(brand)s failed to get the public room list.",{brand:i})+(n&&n.message)?n.message:Object(h.a)("The homeserver may be unavailable or overloaded.")})})}stringLooksLikeId(e,t){let a=/^#[^\s]+:[^\s]/;return t&&t.regexp&&(a=new RegExp(t.regexp)),a.test(e)}render(){let e,t;if(this.state.error)e=this.state.error;else if(this.state.protocolsLoading)e=o.a.createElement(D.a,null);else{const t=(this.state.publicRooms||[]).map(e=>o.a.createElement(W,{key:e.room_id,room:e,showRoom:this.onRoomClick,removeFromDirectory:this.removeFromDirectory}));let a;this.state.loading&&(a=o.a.createElement(D.a,null));const n=o.a.createElement(o.a.Fragment,null,o.a.createElement("hr",null),o.a.createElement(I.a,{kind:"primary",onClick:this.onCreateRoomClick,className:"mx_RoomDirectory_newRoom"},Object(h.a)("Create new room")));let i,s;0!==t.length||this.state.loading?(i=o.a.createElement("div",{className:"mx_RoomDirectory_table"},t),this.state.loading||this.nextBatch||(s=n)):s=o.a.createElement(o.a.Fragment,null,o.a.createElement("h5",null,Object(h.a)('No results for "%(query)s"',{query:this.state.filterString.trim()})),o.a.createElement("p",null,Object(h.a)("Try different words or check for typos. Some results may not be visible as they're private and you need an invite to join them.")),n),e=o.a.createElement(M.a,{className:"mx_RoomDirectory_tableWrapper",onFillRequest:this.onFillRequest,stickyBottom:!1,startAtBottom:!1},i,a,s&&o.a.createElement("div",{className:"mx_RoomDirectory_footer"},s))}if(!this.state.protocolsLoading){const e=Object(p.c)(this.protocols,this.state.instanceId);let a;if(e&&this.protocols&&this.protocols[e]&&this.protocols[e].location_fields.length>0&&this.protocols[e].field_types){const t=this.protocols[e].location_fields.slice(-1)[0];a=this.protocols[e].field_types[t]}let n=Object(h.a)("Find a room…");this.state.instanceId&&this.state.instanceId!==p.a?a&&(n=a.placeholder):n=Object(h.a)("Find a room… (e.g. %(exampleRoom)s)",{exampleRoom:"#example:"+this.state.roomServer});let i=this.stringLooksLikeId(this.state.filterString,a);if(e){const t=Object(p.b)(this.protocols,this.state.instanceId);null===Object(H.a)(this.state.filterString,this.protocols[e],t)&&(i=!1)}t=o.a.createElement("div",{className:"mx_RoomDirectory_listheader"},o.a.createElement(P,{className:"mx_RoomDirectory_searchbox",onChange:this.onFilterChange,onClear:this.onFilterClear,onJoinClick:this.onJoinFromSearchClick,placeholder:n,showJoinButton:i,initialText:this.props.initialText}),o.a.createElement(j,{protocols:this.protocols,onOptionChange:this.onOptionChange,selectedServerName:this.state.roomServer,selectedInstanceId:this.state.instanceId}))}const a=Object(h.a)("If you can't find the room you're looking for, ask for an invite or <a>create a new room</a>.",null,{a:e=>o.a.createElement(I.a,{kind:"link_inline",onClick:this.onCreateRoomClick},e)}),n=Object(h.a)("Explore rooms");return o.a.createElement(N.a,{className:"mx_RoomDirectory_dialog",hasCancel:!0,onFinished:this.onFinished,title:n,screenName:"RoomDirectory"},o.a.createElement("div",{className:"mx_RoomDirectory"},a,o.a.createElement("div",{className:"mx_RoomDirectory_list"},t,e)))}}function $(e){return Object(A.a)(e.canonical_alias,e.aliases)}},858:function(e,t,a){"use strict";a.d(t,"a",(function(){return k}));var n=a(88),i=a.n(n),s=a(87),o=a.n(s),r=a(94),c=a.n(r),l=a(108),d=a(97),m=a(0),h=a(89),u=a(92),p=a(96),g=a(558),b=a(585),v=a(399);class f extends b.a{constructor(){super(...arguments),i()(this,"onClick",e=>{e.preventDefault()})}wrapImage(e,t){return t}getFileBody(){const e=this.props.mxEvent.getType()===d.b.Sticker;return Object(v.a)(this.props.mxEvent.getContent(),e?Object(h.a)("Sticker"):Object(h.a)("Image"),!e)}getBanner(e){return null}render(){if(this.state.error)return super.render();const e=this.props.mxEvent.getContent(),t=this.messageContent(this.state.contentUrl,this.state.thumbUrl,e,44),a=this.getFileBody(),n=o.a.createElement(g.a,{mxEvent:this.props.mxEvent});return o.a.createElement("div",{className:"mx_MImageReplyBody"},t,o.a.createElement("div",{className:"mx_MImageReplyBody_info"},o.a.createElement("div",{className:"mx_MImageReplyBody_sender"},n),o.a.createElement("div",{className:"mx_MImageReplyBody_filename"},a)))}}var E=a(153),y=a(559),_=a(303),S=a(782),w=a(198);function C(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function O(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?C(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):C(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class k extends o.a.PureComponent{constructor(){super(...arguments),i()(this,"anchorElement",Object(s.createRef)()),i()(this,"onDecrypted",()=>{this.forceUpdate(),this.props.onHeightChanged&&this.props.onHeightChanged()}),i()(this,"onEventRequiresUpdate",()=>{this.forceUpdate()}),i()(this,"onClick",e=>{const t=e.target;"a"===t.tagName.toLowerCase()&&null!==t.closest("a")&&t!==this.anchorElement.current||(e.preventDefault(),this.props.toggleExpandedQuote&&e.shiftKey?this.props.toggleExpandedQuote():u.a.dispatch({action:p.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}))})}componentDidMount(){this.props.mxEvent.on(l.c.Decrypted,this.onDecrypted),this.props.mxEvent.on(l.c.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.on(l.c.Replaced,this.onEventRequiresUpdate)}componentWillUnmount(){this.props.mxEvent.removeListener(l.c.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(l.c.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.removeListener(l.c.Replaced,this.onEventRequiresUpdate)}render(){const e=this.props.mxEvent,t=e.getContent().msgtype,a=e.getType(),{hasRenderer:n,isInfoMessage:i,isSeeingThroughMessageHiddenForModeration:s}=Object(y.a)(e,!1);if(!n){const{mxEvent:e}=this.props;return m.a.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),o.a.createElement("div",{className:"mx_ReplyTile mx_ReplyTile_info mx_MNoticeBody"},Object(h.a)("This event could not be displayed"))}const r=c()("mx_ReplyTile",{mx_ReplyTile_info:i&&!e.isRedacted(),mx_ReplyTile_audio:t===d.c.Audio,mx_ReplyTile_video:t===d.c.Video});let l,u="#";this.props.permalinkCreator&&(u=this.props.permalinkCreator.forEvent(e.getId()));!i&&t!==d.c.Image&&a!==d.b.Sticker&&a!==d.b.RoomCreate&&(l=o.a.createElement(g.a,{mxEvent:e}));const p={[d.c.Image]:f,[d.c.Audio]:Object(E.l)(e)?S.a:_.a,[d.c.Video]:_.a},b={[d.b.Sticker]:f};return o.a.createElement("div",{className:r},o.a.createElement("a",{href:u,onClick:this.onClick,ref:this.anchorElement},l,Object(w.f)(O(O({},this.props),{},{ref:null,showUrlPreview:!1,overrideBodyTypes:p,overrideEventTypes:b,maxImageHeight:96,isSeeingThroughMessageHiddenForModeration:s,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),!1)))}}i()(k,"defaultProps",{onHeightChanged:()=>{}})}}]);
//# sourceMappingURL=element-web-app.js.map